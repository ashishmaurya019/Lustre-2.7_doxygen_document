<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/target/tgt_lastrcvd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/target/tgt_lastrcvd.c</h1><a href="tgt__lastrcvd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.sun.com/software/products/lustre/docs/GPLv2.pdf</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2011, 2015, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * Lustre Unified Target</span>
<a name="l00037"></a>00037 <span class="comment"> * These are common function to work with last_received file</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * Author: Mikhail Pershin &lt;mike.pershin@intel.com&gt;</span>
<a name="l00040"></a>00040 <span class="comment"> */</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="obd_8h.html">obd.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="obd__class_8h.html">obd_class.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="lustre__fid_8h.html">lustre_fid.h</a>&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="tgt__internal_8h.html">tgt_internal.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">/* Allocate a bitmap for a chunk of reply data slots */</span>
<a name="l00049"></a><a class="code" href="tgt__lastrcvd_8c.html#a62ec823c220e9143d18d70a9e10cbd6a">00049</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a62ec823c220e9143d18d70a9e10cbd6a">tgt_bitmap_chunk_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut, <span class="keywordtype">int</span> chunk)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *bm;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(bm, BITS_TO_LONGS(<a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>) * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00054"></a>00054         <span class="keywordflow">if</span> (bm == NULL)
<a name="l00055"></a>00055                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         spin_lock(&amp;lut-&gt;<a class="code" href="structlu__target.html#ac86566355f24733e50bf86b60c4cef9f" title="Lock protecting client bitmap.">lut_client_bitmap_lock</a>);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059         <span class="keywordflow">if</span> (lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk] != NULL) {
<a name="l00060"></a>00060                 <span class="comment">/* someone else already allocated the bitmap for this chunk */</span>
<a name="l00061"></a>00061                 spin_unlock(&amp;lut-&gt;<a class="code" href="structlu__target.html#ac86566355f24733e50bf86b60c4cef9f" title="Lock protecting client bitmap.">lut_client_bitmap_lock</a>);
<a name="l00062"></a>00062                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(bm, BITS_TO_LONGS(<a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>) *
<a name="l00063"></a>00063                          <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00064"></a>00064                 <span class="keywordflow">return</span> 0;
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk] = bm;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         spin_unlock(&amp;lut-&gt;<a class="code" href="structlu__target.html#ac86566355f24733e50bf86b60c4cef9f" title="Lock protecting client bitmap.">lut_client_bitmap_lock</a>);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         <span class="keywordflow">return</span> 0;
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">/* Look for an available reply data slot in the bitmap</span>
<a name="l00075"></a>00075 <span class="comment"> * of the target @lut</span>
<a name="l00076"></a>00076 <span class="comment"> * Allocate bitmap chunk when first used</span>
<a name="l00077"></a>00077 <span class="comment"> * XXX algo could be improved if this routine limits performance</span>
<a name="l00078"></a>00078 <span class="comment"> */</span>
<a name="l00079"></a><a class="code" href="tgt__lastrcvd_8c.html#a5ef235e17c1260f4121ace578e166cff">00079</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a5ef235e17c1260f4121ace578e166cff">tgt_find_free_reply_slot</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *bmp;
<a name="l00082"></a>00082         <span class="keywordtype">int</span> chunk = 0;
<a name="l00083"></a>00083         <span class="keywordtype">int</span> rc;
<a name="l00084"></a>00084         <span class="keywordtype">int</span> b;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="keywordflow">for</span> (chunk = 0; chunk &lt; <a class="code" href="lu__target_8h.html#ac1b6b330e7a14a5e1926799a3fde8e44">LUT_REPLY_SLOTS_MAX_CHUNKS</a>; chunk++) {
<a name="l00087"></a>00087                 <span class="comment">/* allocate the bitmap chunk if necessary */</span>
<a name="l00088"></a>00088                 <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk] == NULL)) {
<a name="l00089"></a>00089                         rc = <a class="code" href="tgt__lastrcvd_8c.html#a62ec823c220e9143d18d70a9e10cbd6a">tgt_bitmap_chunk_alloc</a>(lut, chunk);
<a name="l00090"></a>00090                         <span class="keywordflow">if</span> (rc != 0)
<a name="l00091"></a>00091                                 <span class="keywordflow">return</span> rc;
<a name="l00092"></a>00092                 }
<a name="l00093"></a>00093                 bmp = lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk];
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                 <span class="comment">/* look for an available slot in this chunk */</span>
<a name="l00096"></a>00096                 <span class="keywordflow">do</span> {
<a name="l00097"></a>00097                         b = find_first_zero_bit(bmp, <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>);
<a name="l00098"></a>00098                         <span class="keywordflow">if</span> (b &gt;= <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>)
<a name="l00099"></a>00099                                 <span class="keywordflow">break</span>;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101                         <span class="comment">/* found one */</span>
<a name="l00102"></a>00102                         <span class="keywordflow">if</span> (test_and_set_bit(b, bmp) == 0)
<a name="l00103"></a>00103                                 <span class="keywordflow">return</span> chunk * <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a> + b;
<a name="l00104"></a>00104                 } <span class="keywordflow">while</span> (<span class="keyword">true</span>);
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         <span class="keywordflow">return</span> -ENOSPC;
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="comment">/* Mark the reply data slot @idx &apos;used&apos; in the corresponding bitmap chunk</span>
<a name="l00111"></a>00111 <span class="comment"> * of the target @lut</span>
<a name="l00112"></a>00112 <span class="comment"> * Allocate the bitmap chunk if necessary</span>
<a name="l00113"></a>00113 <span class="comment"> */</span>
<a name="l00114"></a><a class="code" href="tgt__lastrcvd_8c.html#a683f013f8374218d81dc7e20404b4bea">00114</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a683f013f8374218d81dc7e20404b4bea">tgt_set_reply_slot</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut, <span class="keywordtype">int</span> idx)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116         <span class="keywordtype">int</span> chunk;
<a name="l00117"></a>00117         <span class="keywordtype">int</span> b;
<a name="l00118"></a>00118         <span class="keywordtype">int</span> rc;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         chunk = idx / <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>;
<a name="l00121"></a>00121         b = idx % <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(chunk &lt; <a class="code" href="lu__target_8h.html#ac1b6b330e7a14a5e1926799a3fde8e44">LUT_REPLY_SLOTS_MAX_CHUNKS</a>);
<a name="l00124"></a>00124         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(b &lt; <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <span class="comment">/* allocate the bitmap chunk if necessary */</span>
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk] == NULL)) {
<a name="l00128"></a>00128                 rc = <a class="code" href="tgt__lastrcvd_8c.html#a62ec823c220e9143d18d70a9e10cbd6a">tgt_bitmap_chunk_alloc</a>(lut, chunk);
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00130"></a>00130                         <span class="keywordflow">return</span> rc;
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="comment">/* mark the slot &apos;used&apos; in this chunk */</span>
<a name="l00134"></a>00134         <span class="keywordflow">if</span> (test_and_set_bit(b, lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk]) != 0) {
<a name="l00135"></a>00135                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: slot %d already set in bitmap\n&quot;</span>,
<a name="l00136"></a>00136                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(lut), idx);
<a name="l00137"></a>00137                 <span class="keywordflow">return</span> -EALREADY;
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <span class="keywordflow">return</span> 0;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment">/* Mark the reply data slot @idx &apos;unused&apos; in the corresponding bitmap chunk</span>
<a name="l00145"></a>00145 <span class="comment"> * of the target @lut</span>
<a name="l00146"></a>00146 <span class="comment"> */</span>
<a name="l00147"></a><a class="code" href="tgt__lastrcvd_8c.html#ae2d4b377b1550251cdd521be469fc95a">00147</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#ae2d4b377b1550251cdd521be469fc95a">tgt_clear_reply_slot</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut, <span class="keywordtype">int</span> idx)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149         <span class="keywordtype">int</span> chunk;
<a name="l00150"></a>00150         <span class="keywordtype">int</span> b;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         chunk = idx / <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>;
<a name="l00153"></a>00153         b = idx % <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(chunk &lt; <a class="code" href="lu__target_8h.html#ac1b6b330e7a14a5e1926799a3fde8e44">LUT_REPLY_SLOTS_MAX_CHUNKS</a>);
<a name="l00156"></a>00156         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(b &lt; <a class="code" href="lu__target_8h.html#a5e60c294346cfb9e4d97ac2c381aad25">LUT_REPLY_SLOTS_PER_CHUNK</a>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         <span class="keywordflow">if</span> (test_and_clear_bit(b, lut-&gt;<a class="code" href="structlu__target.html#a54617df5bd5d71377a09c31599f9cebb" title="Bitmap of used slots in the reply data file.">lut_reply_bitmap</a>[chunk]) == 0) {
<a name="l00159"></a>00159                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: slot %d already clear in bitmap\n&quot;</span>,
<a name="l00160"></a>00160                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(lut), idx);
<a name="l00161"></a>00161                 <span class="keywordflow">return</span> -EALREADY;
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="keywordflow">return</span> 0;
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">/* Read header of reply_data file of target @tgt into structure @lrh */</span>
<a name="l00169"></a><a class="code" href="tgt__lastrcvd_8c.html#aa3685a5c15bc3a4e8a3599f56cbf5a7c">00169</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#aa3685a5c15bc3a4e8a3599f56cbf5a7c">tgt_reply_header_read</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00170"></a>00170                                  <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00171"></a>00171                                  <span class="keyword">struct</span> <a class="code" href="structlsd__reply__header.html">lsd_reply_header</a> *<a class="code" href="llog__test_8c.html#ac46c031ff3a4268a1d002bfd2f4e0773">lrh</a>)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173         <span class="keywordtype">int</span>                      rc;
<a name="l00174"></a>00174         <span class="keyword">struct </span><a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>  buf;
<a name="l00175"></a>00175         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = 0;
<a name="l00178"></a>00178         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = &amp;buf;
<a name="l00179"></a>00179         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(buf);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         rc = <a class="code" href="group__dt.html#ga82d909c9a0d09d6c21420825acb9e40e" title="Read structures of fixed size from storage.">dt_record_read</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l00182"></a>00182                             &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>);
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (rc != 0)
<a name="l00184"></a>00184                 <span class="keywordflow">return</span> rc;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(buf.<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a>);
<a name="l00187"></a>00187         lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(buf.<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a>);
<a name="l00188"></a>00188         lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(buf.<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a>);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;%s: read %s header. magic=0x%08x &quot;</span>
<a name="l00191"></a>00191                <span class="stringliteral">&quot;header_size=%d reply_size=%d\n&quot;</span>,
<a name="l00192"></a>00192                 tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>,
<a name="l00193"></a>00193                 lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a>, lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a>, lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a>);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="keywordflow">return</span> 0;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="comment">/* Write header into replay_data file of target @tgt from structure @lrh */</span>
<a name="l00199"></a><a class="code" href="tgt__lastrcvd_8c.html#a17b9e4c283d28e92fab771443bf8feb4">00199</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a17b9e4c283d28e92fab771443bf8feb4">tgt_reply_header_write</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00200"></a>00200                                   <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00201"></a>00201                                   <span class="keyword">struct</span> <a class="code" href="structlsd__reply__header.html">lsd_reply_header</a> *<a class="code" href="llog__test_8c.html#ac46c031ff3a4268a1d002bfd2f4e0773">lrh</a>)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203         <span class="keywordtype">int</span>                      rc;
<a name="l00204"></a>00204         <span class="keyword">struct </span><a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>  buf;
<a name="l00205"></a>00205         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00206"></a>00206         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a>          *th;
<a name="l00207"></a>00207         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *dto;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;%s: write %s header. magic=0x%08x &quot;</span>
<a name="l00210"></a>00210                <span class="stringliteral">&quot;header_size=%d reply_size=%d\n&quot;</span>,
<a name="l00211"></a>00211                 tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>,
<a name="l00212"></a>00212                 lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a>, lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a>, lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a>);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         buf.<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a> = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a>);
<a name="l00215"></a>00215         buf.<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a> = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a>);
<a name="l00216"></a>00216         buf.<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a> = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a>);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         th = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>);
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (IS_ERR(th))
<a name="l00220"></a>00220                 <span class="keywordflow">return</span> PTR_ERR(th);
<a name="l00221"></a>00221         th-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> = 1;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = 0;
<a name="l00224"></a>00224         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = &amp;buf;
<a name="l00225"></a>00225         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(buf);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>,
<a name="l00228"></a>00228                                      &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (rc)
<a name="l00230"></a>00230                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         rc = <a class="code" href="group__dt.html#ga93ebb43b2740f8628a781a8dcfd23f6b">dt_trans_start</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (rc)
<a name="l00234"></a>00234                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l00237"></a>00237         rc = <a class="code" href="group__dt.html#ga1360ed5c302396b9d5bac50fbfd8ae89">dt_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00238"></a>00238 out:
<a name="l00239"></a>00239         <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00240"></a>00240         <span class="keywordflow">return</span> rc;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* Write the reply data @lrd into reply_data file of target @tgt</span>
<a name="l00244"></a>00244 <span class="comment"> * at offset @off</span>
<a name="l00245"></a>00245 <span class="comment"> */</span>
<a name="l00246"></a><a class="code" href="tgt__lastrcvd_8c.html#a62e1f1275c502cbf71f491e3161eab5c">00246</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a62e1f1275c502cbf71f491e3161eab5c">tgt_reply_data_write</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00247"></a>00247                                 <span class="keyword">struct</span> <a class="code" href="structlsd__reply__data.html">lsd_reply_data</a> *lrd, loff_t off,
<a name="l00248"></a>00248                                 <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00251"></a>00251         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *dto;
<a name="l00252"></a>00252         <span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>   *<a class="code" href="parallel__grouplock_8c.html#a30581aaaef7980b9fc6df8f98406097c">buf</a> = &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a8340c5af95028a2c49ee5aecfe71f0ab">tti_lrd</a>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a> = <a class="code" href="group__net.html#gaf0a9d5804f5a6e154f8b10fe3136feea">ptlrpc_status_hton</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         buf-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>         = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>);
<a name="l00257"></a>00257         buf-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>             = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>);
<a name="l00258"></a>00258         buf-&gt;<a class="code" href="structlsd__reply__data.html#a9fbb20f0c61fa4dcf1762ab665ec9517">lrd_data</a>            = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#a9fbb20f0c61fa4dcf1762ab665ec9517">lrd_data</a>);
<a name="l00259"></a>00259         buf-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>          = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>);
<a name="l00260"></a>00260         buf-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>      = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a> = <a class="code" href="group__net.html#ga82d561dae83ac80f5c8b1d2ba27c40b3">ptlrpc_status_ntoh</a>(lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = off;
<a name="l00265"></a>00265         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = buf;
<a name="l00266"></a>00266         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(*buf);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l00269"></a>00269         <span class="keywordflow">return</span> <a class="code" href="group__dt.html#ga1360ed5c302396b9d5bac50fbfd8ae89">dt_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="comment">/* Read the reply data from reply_data file of target @tgt at offset @off</span>
<a name="l00273"></a>00273 <span class="comment"> * into structure @lrd</span>
<a name="l00274"></a>00274 <span class="comment"> */</span>
<a name="l00275"></a><a class="code" href="tgt__lastrcvd_8c.html#a0c472c67a4742b3f6272b59adc9f77f6">00275</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a0c472c67a4742b3f6272b59adc9f77f6">tgt_reply_data_read</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00276"></a>00276                                <span class="keyword">struct</span> <a class="code" href="structlsd__reply__data.html">lsd_reply_data</a> *lrd, loff_t off)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278         <span class="keywordtype">int</span>                      rc;
<a name="l00279"></a>00279         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00280"></a>00280         <span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>   *<a class="code" href="parallel__grouplock_8c.html#a30581aaaef7980b9fc6df8f98406097c">buf</a> = &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a8340c5af95028a2c49ee5aecfe71f0ab">tti_lrd</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = off;
<a name="l00283"></a>00283         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = buf;
<a name="l00284"></a>00284         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(*buf);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         rc = <a class="code" href="group__dt.html#ga82d909c9a0d09d6c21420825acb9e40e" title="Read structures of fixed size from storage.">dt_record_read</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l00287"></a>00287                             &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>);
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (rc != 0)
<a name="l00289"></a>00289                 <span class="keywordflow">return</span> rc;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>         = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(buf-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>);
<a name="l00292"></a>00292         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>             = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(buf-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>);
<a name="l00293"></a>00293         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a9fbb20f0c61fa4dcf1762ab665ec9517">lrd_data</a>            = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(buf-&gt;<a class="code" href="structlsd__reply__data.html#a9fbb20f0c61fa4dcf1762ab665ec9517">lrd_data</a>);
<a name="l00294"></a>00294         lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>          = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(buf-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a>);
<a name="l00295"></a>00295         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>      = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(buf-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="keywordflow">return</span> 0;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="comment">/* Free the in-memory reply data structure @trd and release</span>
<a name="l00302"></a>00302 <span class="comment"> * the corresponding slot in the reply_data file of target @lut</span>
<a name="l00303"></a>00303 <span class="comment"> * Called with ted_lcd_lock held</span>
<a name="l00304"></a>00304 <span class="comment"> */</span>
<a name="l00305"></a><a class="code" href="tgt__lastrcvd_8c.html#ae82dadd67212e698c7d0a59946caacf1">00305</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tgt__lastrcvd_8c.html#ae82dadd67212e698c7d0a59946caacf1">tgt_free_reply_data</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut,
<a name="l00306"></a>00306                                 <span class="keyword">struct</span> <a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a> *ted,
<a name="l00307"></a>00307                                 <span class="keyword">struct</span> <a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a> *trd)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a0d8304d29c79bce29fd8bc194e9b1df0">D_TRACE</a>, <span class="stringliteral">&quot;%s: free reply data %p: xid %llu, transno %llu, &quot;</span>
<a name="l00310"></a>00310                <span class="stringliteral">&quot;client gen %u, slot idx %d\n&quot;</span>,
<a name="l00311"></a>00311                lut == NULL ? <span class="stringliteral">&quot;&quot;</span> : <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(lut), trd, trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>,
<a name="l00312"></a>00312                trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>, trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>,
<a name="l00313"></a>00313                trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a>);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mutex_is_locked(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>));
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <a class="code" href="list_8h.html#ab1708206f0f7e0a56550b35372203ba5" title="Remove an entry from the list it is currently in.">list_del</a>(&amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>);
<a name="l00318"></a>00318         ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a>--;
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (lut != NULL)
<a name="l00320"></a>00320                 <a class="code" href="tgt__lastrcvd_8c.html#ae2d4b377b1550251cdd521be469fc95a">tgt_clear_reply_slot</a>(lut, trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a>);
<a name="l00321"></a>00321         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(trd);
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">/* Release the reply data @trd from target @lut</span>
<a name="l00325"></a>00325 <span class="comment"> * The reply data with the highest transno for this export</span>
<a name="l00326"></a>00326 <span class="comment"> * is retained to ensure correctness of target recovery</span>
<a name="l00327"></a>00327 <span class="comment"> * Called with ted_lcd_lock held</span>
<a name="l00328"></a>00328 <span class="comment"> */</span>
<a name="l00329"></a><a class="code" href="tgt__lastrcvd_8c.html#ac57b0abfc4247ed97a19a328c54d7bfa">00329</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tgt__lastrcvd_8c.html#ac57b0abfc4247ed97a19a328c54d7bfa">tgt_release_reply_data</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *lut,
<a name="l00330"></a>00330                                    <span class="keyword">struct</span> <a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a> *ted,
<a name="l00331"></a>00331                                    <span class="keyword">struct</span> <a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a> *trd)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a0d8304d29c79bce29fd8bc194e9b1df0">D_TRACE</a>, <span class="stringliteral">&quot;%s: release reply data %p: xid %llu, transno %llu, &quot;</span>
<a name="l00334"></a>00334                <span class="stringliteral">&quot;client gen %u, slot idx %d\n&quot;</span>,
<a name="l00335"></a>00335                lut == NULL ? <span class="stringliteral">&quot;&quot;</span> : <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(lut), trd, trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>,
<a name="l00336"></a>00336                trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>, trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>,
<a name="l00337"></a>00337                trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mutex_is_locked(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>));
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">/* Do not free the reply data corresponding to the</span>
<a name="l00342"></a>00342 <span class="comment">         * highest transno of this export.</span>
<a name="l00343"></a>00343 <span class="comment">         * This ensures on-disk reply data is kept and</span>
<a name="l00344"></a>00344 <span class="comment">         * last committed transno can be restored from disk in case</span>
<a name="l00345"></a>00345 <span class="comment">         * of target recovery</span>
<a name="l00346"></a>00346 <span class="comment">         */</span>
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a> == ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a>) {
<a name="l00348"></a>00348                 <span class="comment">/* free previous retained reply */</span>
<a name="l00349"></a>00349                 <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a> != NULL)
<a name="l00350"></a>00350                         <a class="code" href="tgt__lastrcvd_8c.html#ae82dadd67212e698c7d0a59946caacf1">tgt_free_reply_data</a>(lut, ted, ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a>);
<a name="l00351"></a>00351                 <span class="comment">/* retain the reply */</span>
<a name="l00352"></a>00352                 <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>);
<a name="l00353"></a>00353                 ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a> = trd;
<a name="l00354"></a>00354         } <span class="keywordflow">else</span> {
<a name="l00355"></a>00355                 <a class="code" href="tgt__lastrcvd_8c.html#ae82dadd67212e698c7d0a59946caacf1">tgt_free_reply_data</a>(lut, ted, trd);
<a name="l00356"></a>00356         }
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a><a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">00359</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *<a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">tti_buf_lsd</a>(<span class="keyword">struct</span> <a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a> *tti)
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a04c8f17b9bd5540a8e9e214b4bd60de1">tti_lsd</a>;
<a name="l00362"></a>00362         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a04c8f17b9bd5540a8e9e214b4bd60de1">tti_lsd</a>);
<a name="l00363"></a>00363         <span class="keywordflow">return</span> &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a><a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">00366</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *<a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">tti_buf_lcd</a>(<span class="keyword">struct</span> <a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a> *tti)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a1dda505bdad258373dc33df50b5ffb7b">tti_lcd</a>;
<a name="l00369"></a>00369         tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a1dda505bdad258373dc33df50b5ffb7b">tti_lcd</a>);
<a name="l00370"></a>00370         <span class="keywordflow">return</span> &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>;
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00376"></a><a class="code" href="tgt__lastrcvd_8c.html#a966e85cbe21fdedaf9f1cf0057dfa341">00376</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a966e85cbe21fdedaf9f1cf0057dfa341" title="Allocate in-memory data for client slot related to export.">tgt_client_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00379"></a>00379         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(exp != exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a11215b62af46c84584d2b3a7aa4e326e">obd_self_export</a>);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(exp-&gt;exp_target_data.ted_lcd);
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (exp-&gt;exp_target_data.ted_lcd == NULL)
<a name="l00383"></a>00383                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00384"></a>00384         <span class="comment">/* Mark that slot is not yet valid, 0 doesn&apos;t work here */</span>
<a name="l00385"></a>00385         exp-&gt;exp_target_data.ted_lr_idx = -1;
<a name="l00386"></a>00386         <a class="code" href="list_8h.html#a0ffe9d28c36d7b018a9cfae33bae45c0">INIT_LIST_HEAD</a>(&amp;exp-&gt;exp_target_data.ted_reply_list);
<a name="l00387"></a>00387         mutex_init(&amp;exp-&gt;exp_target_data.ted_lcd_lock);
<a name="l00388"></a>00388         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#a966e85cbe21fdedaf9f1cf0057dfa341" title="Allocate in-memory data for client slot related to export.">tgt_client_alloc</a>);
<a name="l00391"></a>00391 
<a name="l00395"></a><a class="code" href="tgt__lastrcvd_8c.html#af04621983d0b7bdad298df78aba0d805">00395</a> <span class="keywordtype">void</span> <a class="code" href="lu__target_8h.html#af04621983d0b7bdad298df78aba0d805" title="Free in-memory data for client slot related to export.">tgt_client_free</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l00398"></a>00398         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *lut = class_exp2tgt(exp);
<a name="l00399"></a>00399         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *trd, *tmp;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(exp != exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a11215b62af46c84584d2b3a7aa4e326e">obd_self_export</a>);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403         <span class="comment">/* free reply data */</span>
<a name="l00404"></a>00404         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l00405"></a>00405         <a class="code" href="list_8h.html#ac3f72d6bd5144c7970824813810d2da1" title="Iterate over a list of given type safe against removal of list entry.">list_for_each_entry_safe</a>(trd, tmp, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>, <a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>) {
<a name="l00406"></a>00406                 <a class="code" href="tgt__lastrcvd_8c.html#ac57b0abfc4247ed97a19a328c54d7bfa">tgt_release_reply_data</a>(lut, ted, trd);
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a> != NULL) {
<a name="l00409"></a>00409                 <a class="code" href="tgt__lastrcvd_8c.html#ae82dadd67212e698c7d0a59946caacf1">tgt_free_reply_data</a>(lut, ted, ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a>);
<a name="l00410"></a>00410                 ted-&gt;<a class="code" href="structtg__export__data.html#a592f3a96cb105bd08970cfe2584da2b4" title="Reply data with highest transno is retained.">ted_reply_last</a> = NULL;
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (!<a class="code" href="group__hlist.html#ga7f946d296ab41ce808e96d529a4106d6">hlist_unhashed</a>(&amp;exp-&gt;<a class="code" href="structobd__export.html#a8a0591eb0ed18d672eff8323c2cfb6c9" title="nid-export hash">exp_gen_hash</a>))
<a name="l00415"></a>00415                 <a class="code" href="libcfs__hash_8h.html#aae06334dd2f9136524fe92c7ddfdcdd0" title="Delete item  from the libcfs hash  using .">cfs_hash_del</a>(exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#ad9aae12786529dd60db7e88e5262cb03">obd_gen_hash</a>,
<a name="l00416"></a>00416                              &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>,
<a name="l00417"></a>00417                              &amp;exp-&gt;<a class="code" href="structobd__export.html#a8a0591eb0ed18d672eff8323c2cfb6c9" title="nid-export hash">exp_gen_hash</a>);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>);
<a name="l00420"></a>00420         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a> = NULL;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         <span class="comment">/* Target may have been freed (see LU-7430)</span>
<a name="l00423"></a>00423 <span class="comment">         * Slot may be not yet assigned */</span>
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.obt.obt_magic != <a class="code" href="obd__target_8h.html#a29e6f169daa02173e9cab04d9c4e985e">OBT_MAGIC</a> ||
<a name="l00425"></a>00425             ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a> &lt; 0)
<a name="l00426"></a>00426                 <span class="keywordflow">return</span>;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="comment">/* Clear bit when lcd is freed */</span>
<a name="l00429"></a>00429         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(lut &amp;&amp; lut-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>);
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (!test_and_clear_bit(ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, lut-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>)) {
<a name="l00431"></a>00431                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: client %u bit already clear in bitmap\n&quot;</span>,
<a name="l00432"></a>00432                        exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>);
<a name="l00433"></a>00433                 <a class="code" href="libcfs__private_8h.html#a08eceadb65d1adcf8c198cff27081d5f">LBUG</a>();
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (<a class="code" href="lu__target_8h.html#a48f2e00fa02a5def96e9d48a49b42dc8">tgt_is_multimodrpcs_client</a>(exp) &amp;&amp; !exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a81d32b65f32c569ca2de39effaec62e0">obd_stopping</a>)
<a name="l00437"></a>00437                 atomic_dec(&amp;lut-&gt;<a class="code" href="structlu__target.html#a3e442d9ea4a668bbf510222774623cda">lut_num_clients</a>);
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#af04621983d0b7bdad298df78aba0d805" title="Free in-memory data for client slot related to export.">tgt_client_free</a>);
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="tgt__lastrcvd_8c.html#a018326bf85d57dd5427e77b967470f2f">00441</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a80e781a056f2762e5c2bffb383805447">tgt_client_data_read</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00442"></a>00442                          <span class="keyword">struct</span> <a class="code" href="structlsd__client__data.html">lsd_client_data</a> *lcd, loff_t *off, <span class="keywordtype">int</span> index)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00445"></a>00445         <span class="keywordtype">int</span>                      rc;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">tti_buf_lcd</a>(tti);
<a name="l00448"></a>00448         rc = <a class="code" href="group__dt.html#ga82d909c9a0d09d6c21420825acb9e40e" title="Read structures of fixed size from storage.">dt_record_read</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, off);
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (rc == 0) {
<a name="l00450"></a>00450                 <a class="code" href="group__disk.html#ga75099337d85532a517d4096984d717ca">check_lcd</a>(tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, index, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a1dda505bdad258373dc33df50b5ffb7b">tti_lcd</a>);
<a name="l00451"></a>00451                 <a class="code" href="group__disk.html#gaaa6fc4755b58525f76635ca137591cd2">lcd_le_to_cpu</a>(&amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a1dda505bdad258373dc33df50b5ffb7b">tti_lcd</a>, lcd);
<a name="l00452"></a>00452                 lcd-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a> = <a class="code" href="group__net.html#ga82d561dae83ac80f5c8b1d2ba27c40b3">ptlrpc_status_ntoh</a>(lcd-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a>);
<a name="l00453"></a>00453                 lcd-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a> =
<a name="l00454"></a>00454                         <a class="code" href="group__net.html#ga82d561dae83ac80f5c8b1d2ba27c40b3">ptlrpc_status_ntoh</a>(lcd-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a>);
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: read lcd @%lld uuid = %s, last_transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a>
<a name="l00458"></a>00458                <span class="stringliteral">&quot;, last_xid = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;, last_result = %u, last_data = %u, &quot;</span>
<a name="l00459"></a>00459                <span class="stringliteral">&quot;last_close_transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;, last_close_xid = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;, &quot;</span>
<a name="l00460"></a>00460                <span class="stringliteral">&quot;last_close_result = %u, rc = %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00461"></a>00461                *off, lcd-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, lcd-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a>, lcd-&gt;<a class="code" href="structlsd__client__data.html#a2cdd77f8c31381efa931d9ae1cd0cd74">lcd_last_xid</a>,
<a name="l00462"></a>00462                lcd-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a>, lcd-&gt;<a class="code" href="structlsd__client__data.html#af6304f11d5aa307764a59033d60b99c2">lcd_last_data</a>,
<a name="l00463"></a>00463                lcd-&gt;<a class="code" href="structlsd__client__data.html#a6ad7b67f5758de9763eaffa30ff3bc74">lcd_last_close_transno</a>, lcd-&gt;<a class="code" href="structlsd__client__data.html#a08d18bb9d36536a68fd6c82e372ff54c">lcd_last_close_xid</a>,
<a name="l00464"></a>00464                lcd-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a>, rc);
<a name="l00465"></a>00465         <span class="keywordflow">return</span> rc;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a><a class="code" href="tgt__lastrcvd_8c.html#a93658409aa3a5626955822a2f79c83e6">00468</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#acc0b9a43bedcd9884727d24c123d2606">tgt_client_data_write</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00469"></a>00469                           <span class="keyword">struct</span> <a class="code" href="structlsd__client__data.html">lsd_client_data</a> *lcd, loff_t *off,
<a name="l00470"></a>00470                           <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a> *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00473"></a>00473         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *dto;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         lcd-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a> = <a class="code" href="group__net.html#gaf0a9d5804f5a6e154f8b10fe3136feea">ptlrpc_status_hton</a>(lcd-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a>);
<a name="l00476"></a>00476         lcd-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a> =
<a name="l00477"></a>00477                 <a class="code" href="group__net.html#gaf0a9d5804f5a6e154f8b10fe3136feea">ptlrpc_status_hton</a>(lcd-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a>);
<a name="l00478"></a>00478         <a class="code" href="group__disk.html#ga9f3ad4d87929801ade5351dd0d2d1b5e">lcd_cpu_to_le</a>(lcd, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a1dda505bdad258373dc33df50b5ffb7b">tti_lcd</a>);
<a name="l00479"></a>00479         <a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">tti_buf_lcd</a>(tti);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l00482"></a>00482         <span class="keywordflow">return</span> <a class="code" href="group__dt.html#ga1360ed5c302396b9d5bac50fbfd8ae89">dt_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, off, th);
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00488"></a><a class="code" href="tgt__lastrcvd_8c.html#a138757be1336910d9bb4d9733fa64a10">00488</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a138757be1336910d9bb4d9733fa64a10" title="Update client data in last_rcvd.">tgt_client_data_update</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00489"></a>00489                                   <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l00492"></a>00492         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = class_exp2tgt(exp);
<a name="l00493"></a>00493         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00494"></a>00494         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a>          *th;
<a name="l00495"></a>00495         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(tgt == NULL)) {
<a name="l00500"></a>00500                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#af25fefaf5c55ce92d41da370dc9399c2">D_ERROR</a>, <span class="stringliteral">&quot;%s: No target for connected export\n&quot;</span>,
<a name="l00501"></a>00501                           <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp)-&gt;obd_name);
<a name="l00502"></a>00502                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         th = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>);
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (IS_ERR(th))
<a name="l00507"></a>00507                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(th));
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         <a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">tti_buf_lcd</a>(tti);
<a name="l00510"></a>00510         rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>,
<a name="l00511"></a>00511                                      &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l00512"></a>00512                                      ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>, th);
<a name="l00513"></a>00513         <span class="keywordflow">if</span> (rc)
<a name="l00514"></a>00514                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516         rc = <a class="code" href="group__dt.html#gaec633f618ffdd701fa5f233dd4c1d161">dt_trans_start_local</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (rc)
<a name="l00518"></a>00518                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00519"></a>00519         <span class="comment">/*</span>
<a name="l00520"></a>00520 <span class="comment">         * Until this operations will be committed the sync is needed</span>
<a name="l00521"></a>00521 <span class="comment">         * for this export. This should be done _after_ starting the</span>
<a name="l00522"></a>00522 <span class="comment">         * transaction so that many connecting clients will not bring</span>
<a name="l00523"></a>00523 <span class="comment">         * server down with lots of sync writes.</span>
<a name="l00524"></a>00524 <span class="comment">         */</span>
<a name="l00525"></a>00525         rc = <a class="code" href="lu__target_8h.html#a5f180728c17078b181dad874c5d65d55">tgt_new_client_cb_add</a>(th, exp);
<a name="l00526"></a>00526         <span class="keywordflow">if</span> (rc) {
<a name="l00527"></a>00527                 <span class="comment">/* can&apos;t add callback, do sync now */</span>
<a name="l00528"></a>00528                 th-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> = 1;
<a name="l00529"></a>00529         } <span class="keywordflow">else</span> {
<a name="l00530"></a>00530                 spin_lock(&amp;exp-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l00531"></a>00531                 exp-&gt;<a class="code" href="structobd__export.html#a85441b01b2f142919d86391297f0f3c8">exp_need_sync</a> = 1;
<a name="l00532"></a>00532                 spin_unlock(&amp;exp-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>;
<a name="l00536"></a>00536         rc = <a class="code" href="lu__target_8h.html#acc0b9a43bedcd9884727d24c123d2606">tgt_client_data_write</a>(env, tgt, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00537"></a>00537         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00538"></a>00538 out:
<a name="l00539"></a>00539         <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00540"></a>00540         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: update last_rcvd client data for UUID = %s, &quot;</span>
<a name="l00541"></a>00541                <span class="stringliteral">&quot;last_transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00542"></a>00542                tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>, rc);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         <span class="keywordflow">return</span> rc;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a><a class="code" href="tgt__lastrcvd_8c.html#abda6a1ac5f7f1d359774076e98b23d44">00547</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#aa7ba1a91750722d9f42530227f371411">tgt_server_data_read</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt)
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00550"></a>00550         <span class="keywordtype">int</span>                      rc;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = 0;
<a name="l00553"></a>00553         <a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">tti_buf_lsd</a>(tti);
<a name="l00554"></a>00554         rc = <a class="code" href="group__dt.html#ga82d909c9a0d09d6c21420825acb9e40e" title="Read structures of fixed size from storage.">dt_record_read</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l00555"></a>00555                             &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>);
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (rc == 0)
<a name="l00557"></a>00557                 <a class="code" href="group__disk.html#gacda8af2f910759548dad15dd7f9a0bb5">lsd_le_to_cpu</a>(&amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a04c8f17b9bd5540a8e9e214b4bd60de1">tti_lsd</a>, &amp;tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: read last_rcvd server data for UUID = %s, &quot;</span>
<a name="l00560"></a>00560                <span class="stringliteral">&quot;last_transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00561"></a>00561                tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>, rc);
<a name="l00562"></a>00562         <span class="keywordflow">return</span> rc;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a><a class="code" href="tgt__lastrcvd_8c.html#aa8596bf888a102f6d49b408fd7616890">00565</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a1dccabb4f4156b6e5123ce32ab036880">tgt_server_data_write</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00566"></a>00566                           <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00569"></a>00569         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *dto;
<a name="l00570"></a>00570         <span class="keywordtype">int</span>                      rc;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = 0;
<a name="l00575"></a>00575         <a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">tti_buf_lsd</a>(tti);
<a name="l00576"></a>00576         <a class="code" href="group__disk.html#ga351f572a2493563061ccb5b66d6f8136">lsd_cpu_to_le</a>(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a04c8f17b9bd5540a8e9e214b4bd60de1">tti_lsd</a>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l00579"></a>00579         rc = <a class="code" href="group__dt.html#ga1360ed5c302396b9d5bac50fbfd8ae89">dt_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: write last_rcvd server data for UUID = %s, &quot;</span>
<a name="l00582"></a>00582                <span class="stringliteral">&quot;last_transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00583"></a>00583                tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>, rc);
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00591"></a><a class="code" href="tgt__lastrcvd_8c.html#a35157538db2dea1fd246703f2a4be4d1">00591</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00592"></a>00592                            <span class="keywordtype">int</span> sync)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l00595"></a>00595         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a>          *th;
<a name="l00596"></a>00596         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a9d59532fbd092ff370d52d78ee6d6b57">D_SUPER</a>,
<a name="l00601"></a>00601                <span class="stringliteral">&quot;%s: mount_count is &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;, last_transno is &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00602"></a>00602                tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.obt.obt_mount_count,
<a name="l00603"></a>00603                tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         <span class="comment">/* Always save latest transno to keep it fresh */</span>
<a name="l00606"></a>00606         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00607"></a>00607         tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a> = tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>;
<a name="l00608"></a>00608         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         th = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>);
<a name="l00611"></a>00611         <span class="keywordflow">if</span> (IS_ERR(th))
<a name="l00612"></a>00612                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(th));
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         th-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> = sync;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         <a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">tti_buf_lsd</a>(tti);
<a name="l00617"></a>00617         rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>,
<a name="l00618"></a>00618                                      &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (rc)
<a name="l00620"></a>00620                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         rc = <a class="code" href="group__dt.html#ga93ebb43b2740f8628a781a8dcfd23f6b">dt_trans_start</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00623"></a>00623         <span class="keywordflow">if</span> (rc)
<a name="l00624"></a>00624                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         rc = <a class="code" href="lu__target_8h.html#a1dccabb4f4156b6e5123ce32ab036880">tgt_server_data_write</a>(env, tgt, th);
<a name="l00627"></a>00627 out:
<a name="l00628"></a>00628         <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: update last_rcvd server data for UUID = %s, &quot;</span>
<a name="l00631"></a>00631                <span class="stringliteral">&quot;last_transno = &quot;</span>LPU64<span class="stringliteral">&quot;: rc = %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00632"></a>00632                tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>, rc);
<a name="l00633"></a>00633         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00634"></a>00634 }
<a name="l00635"></a>00635 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>);
<a name="l00636"></a>00636 
<a name="l00637"></a><a class="code" href="tgt__lastrcvd_8c.html#ad95589020f702c5b127df32656671099">00637</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a2e5f8a2dd90c0ad92d23869264fb8113">tgt_truncate_last_rcvd</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00638"></a>00638                            loff_t <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a> *dt = tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>;
<a name="l00641"></a>00641         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a>   *th;
<a name="l00642"></a>00642         <span class="keyword">struct </span><a class="code" href="structlu__attr.html" title="Common object attributes.">lu_attr</a>    attr;
<a name="l00643"></a>00643         <span class="keywordtype">int</span>               rc;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         attr.<a class="code" href="structlu__attr.html#a1a701b4d0d6a0c44590a0cda86be525f" title="size in bytes">la_size</a> = size;
<a name="l00648"></a>00648         attr.<a class="code" href="structlu__attr.html#a6ebc7938388954da75a9b75f0689d469" title="valid bits">la_valid</a> = <a class="code" href="group__lu.html#gga88a0b6df60974746bbc3b1a79da159a8ae810659c3210c116f0912a58ea9dbbc2">LA_SIZE</a>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         th = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>);
<a name="l00651"></a>00651         <span class="keywordflow">if</span> (IS_ERR(th))
<a name="l00652"></a>00652                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(th));
<a name="l00653"></a>00653         rc = <a class="code" href="dt__object_8h.html#a4ec4a12adf1a3664c0e62954700ee705">dt_declare_punch</a>(env, dt, size, <a class="code" href="group__lustreidl.html#gaf12bcea9d603cdae847ff2fad712fc77">OBD_OBJECT_EOF</a>, th);
<a name="l00654"></a>00654         <span class="keywordflow">if</span> (rc)
<a name="l00655"></a>00655                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>, rc);
<a name="l00656"></a>00656         rc = <a class="code" href="dt__object_8h.html#aefd6ac2847b72d189da00d32b740d91f">dt_declare_attr_set</a>(env, dt, &amp;attr, th);
<a name="l00657"></a>00657         <span class="keywordflow">if</span> (rc)
<a name="l00658"></a>00658                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>, rc);
<a name="l00659"></a>00659         rc = <a class="code" href="group__dt.html#gaec633f618ffdd701fa5f233dd4c1d161">dt_trans_start_local</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00660"></a>00660         <span class="keywordflow">if</span> (rc)
<a name="l00661"></a>00661                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>, rc);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         rc = <a class="code" href="dt__object_8h.html#ab27f1d67a6786dc6cdcb782b2987ef6e">dt_punch</a>(env, dt, size, <a class="code" href="group__lustreidl.html#gaf12bcea9d603cdae847ff2fad712fc77">OBD_OBJECT_EOF</a>, th);
<a name="l00664"></a>00664         <span class="keywordflow">if</span> (rc == 0)
<a name="l00665"></a>00665                 rc = <a class="code" href="dt__object_8h.html#a73c5f29d48fb9563afacf3b3c016356b">dt_attr_set</a>(env, dt, &amp;attr, th);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>:
<a name="l00668"></a>00668         <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>, th);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a><a class="code" href="tgt__lastrcvd_8c.html#a1640848cd0e498666155752196f88269">00673</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tgt__lastrcvd_8c.html#a1640848cd0e498666155752196f88269">tgt_client_epoch_update</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00674"></a>00674                                     <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676         <span class="keyword">struct </span><a class="code" href="structlsd__client__data.html">lsd_client_data</a>  *lcd = exp-&gt;exp_target_data.ted_lcd;
<a name="l00677"></a>00677         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = class_exp2tgt(exp);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt &amp;&amp; tgt-&gt;<a class="code" href="structlu__target.html#a8447b4ae896cbbb06db46e8bc0c8a7cc">lut_bottom</a>);
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (lcd-&gt;<a class="code" href="structlsd__client__data.html#a2bf612160ab62dd8feb247b92593a372">lcd_last_epoch</a> &gt;= tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a504a8c053ea591a3c95837ed66b0dbaf">lsd_start_epoch</a>)
<a name="l00682"></a>00682                 <span class="keywordflow">return</span>;
<a name="l00683"></a>00683         lcd-&gt;<a class="code" href="structlsd__client__data.html#a2bf612160ab62dd8feb247b92593a372">lcd_last_epoch</a> = tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a504a8c053ea591a3c95837ed66b0dbaf">lsd_start_epoch</a>;
<a name="l00684"></a>00684         <a class="code" href="tgt__lastrcvd_8c.html#a138757be1336910d9bb4d9733fa64a10" title="Update client data in last_rcvd.">tgt_client_data_update</a>(env, exp);
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00690"></a><a class="code" href="tgt__lastrcvd_8c.html#ae5fbfb4f9751c515720b4ea86cd4793e">00690</a> <span class="keywordtype">void</span> <a class="code" href="lu__target_8h.html#a6aed786fe51fec39a5d61e5c2f45887c" title="Update boot epoch when recovery ends.">tgt_boot_epoch_update</a>(<span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692         <span class="keyword">struct </span><a class="code" href="structlu__env.html" title="Environment.">lu_env</a>            env;
<a name="l00693"></a>00693         <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a>   *req;
<a name="l00694"></a>00694         __u32                    start_epoch;
<a name="l00695"></a>00695         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>         client_list;
<a name="l00696"></a>00696         <span class="keywordtype">int</span>                      rc;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a81d32b65f32c569ca2de39effaec62e0">obd_stopping</a>)
<a name="l00699"></a>00699                 <span class="keywordflow">return</span>;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         rc = <a class="code" href="group__lu.html#ga72f58647251d2a508798b09afba9c70f">lu_env_init</a>(&amp;env, <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aa130ed4529679eed5a88d5dc63db1921f" title="Thread on dt server.">LCT_DT_THREAD</a>);
<a name="l00702"></a>00702         <span class="keywordflow">if</span> (rc) {
<a name="l00703"></a>00703                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: can&apos;t initialize environment: rc = %d\n&quot;</span>,
<a name="l00704"></a>00704                         tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l00705"></a>00705                 <span class="keywordflow">return</span>;
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00709"></a>00709         start_epoch = <a class="code" href="group__disk.html#ga5449a635b49615b1d8c0f01e6085ec9f">lr_epoch</a>(tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>) + 1;
<a name="l00710"></a>00710         tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a> = (<a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>)start_epoch &lt;&lt; <a class="code" href="group__disk.html#ga0004641e2921af2ce7f59e8d0c18dd0e" title="version recovery epoch">LR_EPOCH_BITS</a>;
<a name="l00711"></a>00711         tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a504a8c053ea591a3c95837ed66b0dbaf">lsd_start_epoch</a> = start_epoch;
<a name="l00712"></a>00712         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         <a class="code" href="list_8h.html#a0ffe9d28c36d7b018a9cfae33bae45c0">INIT_LIST_HEAD</a>(&amp;client_list);
<a name="l00719"></a>00719         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#abb7fdd74e262a550597f5bb6eab0d043">obd_recovery_task_lock</a>);
<a name="l00720"></a>00720         <a class="code" href="list_8h.html#a948b15519bb72e3d42f3e56975580d30" title="Join two lists and reinitialise the emptied list.">list_splice_init</a>(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a1557528b348de6c00b46a64e9f41ba2c">obd_final_req_queue</a>, &amp;client_list);
<a name="l00721"></a>00721         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#abb7fdd74e262a550597f5bb6eab0d043">obd_recovery_task_lock</a>);
<a name="l00722"></a>00722 
<a name="l00727"></a>00727         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(req, &amp;client_list, rq_list) {
<a name="l00728"></a>00728                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(!req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;<a class="code" href="structobd__export.html#adeea1b3a805f89367d09e2d7309eee36" title="VBR: export missed recovery.">exp_delayed</a>);
<a name="l00729"></a>00729                 <span class="keywordflow">if</span> (!req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;<a class="code" href="structobd__export.html#a4ac08cf92bae3f705e49f9087ef2af98" title="VBR: failed version checking.">exp_vbr_failed</a>)
<a name="l00730"></a>00730                         <a class="code" href="tgt__lastrcvd_8c.html#a1640848cd0e498666155752196f88269">tgt_client_epoch_update</a>(&amp;env, req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>);
<a name="l00731"></a>00731         }
<a name="l00733"></a>00733         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#abb7fdd74e262a550597f5bb6eab0d043">obd_recovery_task_lock</a>);
<a name="l00734"></a>00734         <a class="code" href="list_8h.html#a948b15519bb72e3d42f3e56975580d30" title="Join two lists and reinitialise the emptied list.">list_splice_init</a>(&amp;client_list, &amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a1557528b348de6c00b46a64e9f41ba2c">obd_final_req_queue</a>);
<a name="l00735"></a>00735         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#abb7fdd74e262a550597f5bb6eab0d043">obd_recovery_task_lock</a>);
<a name="l00736"></a>00736 
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (!strncmp(tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, <a class="code" href="obd_8h.html#a745628d9f20d135052a7589f7d9ba9ee">LUSTRE_MDT_NAME</a>, 3) &amp;&amp;
<a name="l00742"></a>00742             (tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a0f2d4254017aec550cfe1c78f13d8b53">obd_max_recoverable_clients</a> == 0 ||
<a name="l00743"></a>00743             tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#addf187de9d802275531b95fda5b53fcc">obd_abort_recovery</a>))
<a name="l00744"></a>00744                 tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> &amp;= ~<a class="code" href="group__disk.html#ga6ea31649ec3838f33d51d39cfe05957a" title="multiple RPCs in flight">OBD_INCOMPAT_MULTI_RPCS</a>;
<a name="l00745"></a>00745 
<a name="l00747"></a>00747         <a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>(&amp;env, tgt, 1);
<a name="l00748"></a>00748         <a class="code" href="group__lu.html#ga9ead00ad92e122b8ad944ffeab3120b5">lu_env_fini</a>(&amp;env);
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00754"></a><a class="code" href="structtgt__last__committed__callback.html">00754</a> <span class="keyword">struct </span><a class="code" href="structtgt__last__committed__callback.html" title="commit callback, need to update last_committed value">tgt_last_committed_callback</a> {
<a name="l00755"></a><a class="code" href="structtgt__last__committed__callback.html#a6cf37a051e7ae171708c9e759c6ef1e6">00755</a>         <span class="keyword">struct </span><a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a>  <a class="code" href="structtgt__last__committed__callback.html#a6cf37a051e7ae171708c9e759c6ef1e6">llcc_cb</a>;
<a name="l00756"></a><a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">00756</a>         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>;
<a name="l00757"></a><a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">00757</a>         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>;
<a name="l00758"></a><a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">00758</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                    <a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>;
<a name="l00759"></a>00759 };
<a name="l00760"></a>00760 
<a name="l00761"></a><a class="code" href="tgt__lastrcvd_8c.html#a85860e4d8aa92e0aba08ce4de2398fc5">00761</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tgt__lastrcvd_8c.html#a85860e4d8aa92e0aba08ce4de2398fc5">tgt_cb_last_committed</a>(<span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th,
<a name="l00762"></a>00762                                   <span class="keyword">struct</span> <a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a> *<a class="code" href="it__test_8c.html#a3edc96db5310d665bb056d7adc554a8f">cb</a>, <span class="keywordtype">int</span> err)
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764         <span class="keyword">struct </span><a class="code" href="structtgt__last__committed__callback.html" title="commit callback, need to update last_committed value">tgt_last_committed_callback</a> *ccb;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         ccb = container_of0(cb, <span class="keyword">struct</span> <a class="code" href="structtgt__last__committed__callback.html" title="commit callback, need to update last_committed value">tgt_last_committed_callback</a>, <a class="code" href="structtgt__last__committed__callback.html#a6cf37a051e7ae171708c9e759c6ef1e6">llcc_cb</a>);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>);
<a name="l00769"></a>00769         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a> != NULL);
<a name="l00770"></a>00770         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a> == ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772         <span class="comment">/* Fast path w/o spinlock, if exp_last_committed was updated</span>
<a name="l00773"></a>00773 <span class="comment">         * with higher transno, no need to take spinlock and check,</span>
<a name="l00774"></a>00774 <span class="comment">         * also no need to update obd_last_committed. */</span>
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a> &lt;= ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a>)
<a name="l00776"></a>00776                 <span class="keywordflow">goto</span> out;
<a name="l00777"></a>00777         spin_lock(&amp;ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00778"></a>00778         <span class="keywordflow">if</span> (ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a> &gt; ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a48d2bcfb7ce73ac3ecf2d30b2caa7900">obd_last_committed</a>)
<a name="l00779"></a>00779                 ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a48d2bcfb7ce73ac3ecf2d30b2caa7900">obd_last_committed</a> = ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="keywordflow">if</span> (ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a> &gt; ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a>) {
<a name="l00782"></a>00782                 ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a> = ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>;
<a name="l00783"></a>00783                 spin_unlock(&amp;ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785                 <a class="code" href="group__net.html#ga1c4d3548ace7c49c820adf3d6610f7a8">ptlrpc_commit_replies</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>);
<a name="l00786"></a>00786                 <a class="code" href="tgt__internal_8h.html#a6f4f8fa4a61a1414d1c06d82923daa08">tgt_cancel_slc_locks</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>);
<a name="l00787"></a>00787         } <span class="keywordflow">else</span> {
<a name="l00788"></a>00788                 spin_unlock(&amp;ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790 out:
<a name="l00791"></a>00791         <a class="code" href="obd__class_8h.html#ac3fac818107335d3e7c5206f45df4c50">class_export_cb_put</a>(ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a>);
<a name="l00792"></a>00792         <span class="keywordflow">if</span> (ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>)
<a name="l00793"></a>00793                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;%s: transno &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a414a71ca04d1db8d7875631cf51d45bf">LPD64</a><span class="stringliteral">&quot; is committed\n&quot;</span>,
<a name="l00794"></a>00794                        ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a>-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a>);
<a name="l00795"></a>00795         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ccb);
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a><a class="code" href="tgt__lastrcvd_8c.html#addf43010b42052a0ae427b1afce55755">00798</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a8ea97cdff05dd442f03030fac788b304">tgt_last_commit_cb_add</a>(<span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l00799"></a>00799                            <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> transno)
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801         <span class="keyword">struct </span><a class="code" href="structtgt__last__committed__callback.html" title="commit callback, need to update last_committed value">tgt_last_committed_callback</a>      *ccb;
<a name="l00802"></a>00802         <span class="keyword">struct </span><a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a>                 *dcb;
<a name="l00803"></a>00803         <span class="keywordtype">int</span>                                      rc;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(ccb);
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (ccb == NULL)
<a name="l00807"></a>00807                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a22491a77915bcfa31fb1a3e91b06721b">llcc_tgt</a> = tgt;
<a name="l00810"></a>00810         ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a1d33cb8ae67c0c353af994275d0d3172">llcc_exp</a> = <a class="code" href="obd__class_8h.html#ac9d334778c3190c8dff90df1f6a2fc64">class_export_cb_get</a>(exp);
<a name="l00811"></a>00811         ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a104755ce2fec3bf8acc930cd7a15b6d9">llcc_transno</a> = transno;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813         dcb = &amp;ccb-&gt;<a class="code" href="structtgt__last__committed__callback.html#a6cf37a051e7ae171708c9e759c6ef1e6">llcc_cb</a>;
<a name="l00814"></a>00814         dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a083632339beee3613b7bb5a3c2efcdbc">dcb_func</a> = <a class="code" href="tgt__lastrcvd_8c.html#a85860e4d8aa92e0aba08ce4de2398fc5">tgt_cb_last_committed</a>;
<a name="l00815"></a>00815         <a class="code" href="list_8h.html#a0ffe9d28c36d7b018a9cfae33bae45c0">INIT_LIST_HEAD</a>(&amp;dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a9c4a7e3b0d51f0c1b41cb7caee08caa8">dcb_linkage</a>);
<a name="l00816"></a>00816         <a class="code" href="string_8h.html#a5b488cc7021bbdd3ed565cb03b1ee6d2">strlcpy</a>(dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a6de857ce08a80358ea07759ef70dd2d6">dcb_name</a>, <span class="stringliteral">&quot;tgt_cb_last_committed&quot;</span>, <span class="keyword">sizeof</span>(dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a6de857ce08a80358ea07759ef70dd2d6">dcb_name</a>));
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         rc = <a class="code" href="group__dt.html#ga183db692d6c759a6b8cc88c4e5ee069f">dt_trans_cb_add</a>(th, dcb);
<a name="l00819"></a>00819         <span class="keywordflow">if</span> (rc) {
<a name="l00820"></a>00820                 <a class="code" href="obd__class_8h.html#ac3fac818107335d3e7c5206f45df4c50">class_export_cb_put</a>(exp);
<a name="l00821"></a>00821                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ccb);
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (<a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga2cc29f654f7faafdf9fa7a3da778d976">OBD_CONNECT_LIGHTWEIGHT</a>)
<a name="l00825"></a>00825                 <span class="comment">/* report failure to force synchronous operation */</span>
<a name="l00826"></a>00826                 <span class="keywordflow">return</span> -EPERM;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="keywordflow">return</span> rc;
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a><a class="code" href="structtgt__new__client__callback.html">00831</a> <span class="keyword">struct </span><a class="code" href="structtgt__new__client__callback.html">tgt_new_client_callback</a> {
<a name="l00832"></a><a class="code" href="structtgt__new__client__callback.html#adb275f177172df15096e247d6698b830">00832</a>         <span class="keyword">struct </span><a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a>  <a class="code" href="structtgt__new__client__callback.html#adb275f177172df15096e247d6698b830">lncc_cb</a>;
<a name="l00833"></a><a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">00833</a>         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>;
<a name="l00834"></a>00834 };
<a name="l00835"></a>00835 
<a name="l00836"></a><a class="code" href="tgt__lastrcvd_8c.html#a86bd807ab99325118f027327bc4d4690">00836</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="tgt__lastrcvd_8c.html#a86bd807ab99325118f027327bc4d4690">tgt_cb_new_client</a>(<span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th,
<a name="l00837"></a>00837                               <span class="keyword">struct</span> <a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a> *<a class="code" href="it__test_8c.html#a3edc96db5310d665bb056d7adc554a8f">cb</a>, <span class="keywordtype">int</span> err)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839         <span class="keyword">struct </span><a class="code" href="structtgt__new__client__callback.html">tgt_new_client_callback</a> *ccb;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         ccb = container_of0(cb, <span class="keyword">struct</span> <a class="code" href="structtgt__new__client__callback.html">tgt_new_client_callback</a>, <a class="code" href="structtgt__new__client__callback.html#adb275f177172df15096e247d6698b830">lncc_cb</a>);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#aed4daa7096c3237824e93375e1473af7">D_RPCTRACE</a>, <span class="stringliteral">&quot;%s: committing for initial connect of %s\n&quot;</span>,
<a name="l00846"></a>00846                ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00847"></a>00847                ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#add66633855471a2f937a811ce353b5ca" title="Lock references.">exp_client_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         spin_lock(&amp;ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851         ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#a85441b01b2f142919d86391297f0f3c8">exp_need_sync</a> = 0;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         spin_unlock(&amp;ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l00854"></a>00854         <a class="code" href="obd__class_8h.html#ac3fac818107335d3e7c5206f45df4c50">class_export_cb_put</a>(ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a>);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ccb);
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 
<a name="l00859"></a><a class="code" href="tgt__lastrcvd_8c.html#a5f180728c17078b181dad874c5d65d55">00859</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a5f180728c17078b181dad874c5d65d55">tgt_new_client_cb_add</a>(<span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00860"></a>00860 {
<a name="l00861"></a>00861         <span class="keyword">struct </span><a class="code" href="structtgt__new__client__callback.html">tgt_new_client_callback</a>  *ccb;
<a name="l00862"></a>00862         <span class="keyword">struct </span><a class="code" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a>         *dcb;
<a name="l00863"></a>00863         <span class="keywordtype">int</span>                              rc;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(ccb);
<a name="l00866"></a>00866         <span class="keywordflow">if</span> (ccb == NULL)
<a name="l00867"></a>00867                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#a06517f999a793cc87cc8947b2edc35a3">lncc_exp</a> = <a class="code" href="obd__class_8h.html#ac9d334778c3190c8dff90df1f6a2fc64">class_export_cb_get</a>(exp);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         dcb = &amp;ccb-&gt;<a class="code" href="structtgt__new__client__callback.html#adb275f177172df15096e247d6698b830">lncc_cb</a>;
<a name="l00872"></a>00872         dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a083632339beee3613b7bb5a3c2efcdbc">dcb_func</a> = <a class="code" href="tgt__lastrcvd_8c.html#a86bd807ab99325118f027327bc4d4690">tgt_cb_new_client</a>;
<a name="l00873"></a>00873         <a class="code" href="list_8h.html#a0ffe9d28c36d7b018a9cfae33bae45c0">INIT_LIST_HEAD</a>(&amp;dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a9c4a7e3b0d51f0c1b41cb7caee08caa8">dcb_linkage</a>);
<a name="l00874"></a>00874         <a class="code" href="string_8h.html#a5b488cc7021bbdd3ed565cb03b1ee6d2">strlcpy</a>(dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a6de857ce08a80358ea07759ef70dd2d6">dcb_name</a>, <span class="stringliteral">&quot;tgt_cb_new_client&quot;</span>, <span class="keyword">sizeof</span>(dcb-&gt;<a class="code" href="structdt__txn__commit__cb.html#a6de857ce08a80358ea07759ef70dd2d6">dcb_name</a>));
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         rc = <a class="code" href="group__dt.html#ga183db692d6c759a6b8cc88c4e5ee069f">dt_trans_cb_add</a>(th, dcb);
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (rc) {
<a name="l00878"></a>00878                 <a class="code" href="obd__class_8h.html#ac3fac818107335d3e7c5206f45df4c50">class_export_cb_put</a>(exp);
<a name="l00879"></a>00879                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ccb);
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881         <span class="keywordflow">return</span> rc;
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00890"></a><a class="code" href="tgt__lastrcvd_8c.html#a23c88323485616363f9a90c9e25bb97f">00890</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#a23c88323485616363f9a90c9e25bb97f" title="Add new client to the last_rcvd upon new connection.">tgt_client_new</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l00893"></a>00893         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = class_exp2tgt(exp);
<a name="l00894"></a>00894         <span class="keywordtype">int</span>                      rc = 0, idx;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt &amp;&amp; tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a> != NULL);
<a name="l00899"></a>00899         <span class="keywordflow">if</span> (!strcmp(ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>))
<a name="l00900"></a>00900                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (<a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga2cc29f654f7faafdf9fa7a3da778d976">OBD_CONNECT_LIGHTWEIGHT</a>)
<a name="l00903"></a>00903                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905         <span class="comment">/* the bitmap operations can handle cl_idx &gt; sizeof(long) * 8, so</span>
<a name="l00906"></a>00906 <span class="comment">         * there&apos;s no need for extra complication here</span>
<a name="l00907"></a>00907 <span class="comment">         */</span>
<a name="l00908"></a>00908         idx = find_first_zero_bit(tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>, <a class="code" href="group__disk.html#ga5ceea95fd29d88f44cfce53ba6524132">LR_MAX_CLIENTS</a>);
<a name="l00909"></a>00909 repeat:
<a name="l00910"></a>00910         <span class="keywordflow">if</span> (idx &gt;= <a class="code" href="group__disk.html#ga5ceea95fd29d88f44cfce53ba6524132">LR_MAX_CLIENTS</a> ||
<a name="l00911"></a>00911             <a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#ada185b7cfe1930707115751cef42e68c">OBD_FAIL_MDS_CLIENT_ADD</a>)) {
<a name="l00912"></a>00912                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: no room for %u clients - fix LR_MAX_CLIENTS\n&quot;</span>,
<a name="l00913"></a>00913                        tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,  idx);
<a name="l00914"></a>00914                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EOVERFLOW);
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916         <span class="keywordflow">if</span> (test_and_set_bit(idx, tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>)) {
<a name="l00917"></a>00917                 idx = find_next_zero_bit(tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>,
<a name="l00918"></a>00918                                              <a class="code" href="group__disk.html#ga5ceea95fd29d88f44cfce53ba6524132">LR_MAX_CLIENTS</a>, idx);
<a name="l00919"></a>00919                 <span class="keywordflow">goto</span> repeat;
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922         ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a> = idx;
<a name="l00923"></a>00923         ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> = tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> +
<a name="l00924"></a>00924                           idx * tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> &gt; 0, <span class="stringliteral">&quot;ted_lr_off = %llu\n&quot;</span>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928         <span class="keywordflow">if</span> (<a class="code" href="lu__target_8h.html#a48f2e00fa02a5def96e9d48a49b42dc8">tgt_is_multimodrpcs_client</a>(exp)) {
<a name="l00929"></a>00929                 <span class="comment">/* Set MULTI RPCS incompatibility flag to prevent previous</span>
<a name="l00930"></a>00930 <span class="comment">                 * Lustre versions to mount a target with reply_data file */</span>
<a name="l00931"></a>00931                 atomic_inc(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3e442d9ea4a668bbf510222774623cda">lut_num_clients</a>);
<a name="l00932"></a>00932                 <span class="keywordflow">if</span> (!(tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> &amp;
<a name="l00933"></a>00933                       <a class="code" href="group__disk.html#ga6ea31649ec3838f33d51d39cfe05957a" title="multiple RPCs in flight">OBD_INCOMPAT_MULTI_RPCS</a>)) {
<a name="l00934"></a>00934                         tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> |=
<a name="l00935"></a>00935                                                         <a class="code" href="group__disk.html#ga6ea31649ec3838f33d51d39cfe05957a" title="multiple RPCs in flight">OBD_INCOMPAT_MULTI_RPCS</a>;
<a name="l00936"></a>00936                         rc = <a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>(env, tgt, 1);
<a name="l00937"></a>00937                         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00938"></a>00938                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: unable to set MULTI RPCS &quot;</span>
<a name="l00939"></a>00939                                        <span class="stringliteral">&quot;incompatibility flag\n&quot;</span>,
<a name="l00940"></a>00940                                        exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00941"></a>00941                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00942"></a>00942                         }
<a name="l00943"></a>00943                 }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                 <span class="comment">/* assign client slot generation */</span>
<a name="l00946"></a>00946                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a> =
<a name="l00947"></a>00947                                 atomic_inc_return(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a2dd90e9a3e4eb2a47567d6f62a9c3aa7">lut_client_generation</a>);
<a name="l00948"></a>00948         } <span class="keywordflow">else</span> {
<a name="l00949"></a>00949                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a> = 0;
<a name="l00950"></a>00950         }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: new client at index %d (%llu) with UUID &apos;%s&apos; &quot;</span>
<a name="l00953"></a>00953                <span class="stringliteral">&quot;generation %d\n&quot;</span>,
<a name="l00954"></a>00954                tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>,
<a name="l00955"></a>00955                ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#ad95156a263ab0ee71035ba20b9acf201">OBD_FAIL_TGT_CLIENT_ADD</a>))
<a name="l00958"></a>00958                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOSPC);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960         rc = <a class="code" href="tgt__lastrcvd_8c.html#a138757be1336910d9bb4d9733fa64a10" title="Update client data in last_rcvd.">tgt_client_data_update</a>(env, exp);
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (rc)
<a name="l00962"></a>00962                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: Failed to write client lcd at idx %d, rc %d\n&quot;</span>,
<a name="l00963"></a>00963                        tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, idx, rc);
<a name="l00964"></a>00964 
<a name="l00965"></a>00965         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#a23c88323485616363f9a90c9e25bb97f" title="Add new client to the last_rcvd upon new connection.">tgt_client_new</a>);
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 <span class="comment">/* Add an existing client to the MDS in-memory state based on</span>
<a name="l00970"></a>00970 <span class="comment"> * a client that was previously found in the last_rcvd file and</span>
<a name="l00971"></a>00971 <span class="comment"> * already has an assigned slot (idx &gt;= 0).</span>
<a name="l00972"></a>00972 <span class="comment"> *</span>
<a name="l00973"></a>00973 <span class="comment"> * It should not be possible to fail adding an existing client - otherwise</span>
<a name="l00974"></a>00974 <span class="comment"> * mdt_init_server_data() callsite needs to be fixed.</span>
<a name="l00975"></a>00975 <span class="comment"> */</span>
<a name="l00976"></a><a class="code" href="tgt__lastrcvd_8c.html#a2a211b79ba092875f1d3ad08eeea9f3c">00976</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#ae0570485d445a89719425bfcd663f9fc">tgt_client_add</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,  <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keywordtype">int</span> idx)
<a name="l00977"></a>00977 {
<a name="l00978"></a>00978         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l00979"></a>00979         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = class_exp2tgt(exp);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt &amp;&amp; tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a> != NULL);
<a name="l00984"></a>00984         <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(idx &gt;= 0, <span class="stringliteral">&quot;%d\n&quot;</span>, idx);
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (!strcmp(ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>) ||
<a name="l00987"></a>00987             <a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga2cc29f654f7faafdf9fa7a3da778d976">OBD_CONNECT_LIGHTWEIGHT</a>)
<a name="l00988"></a>00988                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990         <span class="keywordflow">if</span> (test_and_set_bit(idx, tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>)) {
<a name="l00991"></a>00991                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: client %d: bit already set in bitmap!!\n&quot;</span>,
<a name="l00992"></a>00992                        tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,  idx);
<a name="l00993"></a>00993                 <a class="code" href="libcfs__private_8h.html#a08eceadb65d1adcf8c198cff27081d5f">LBUG</a>();
<a name="l00994"></a>00994         }
<a name="l00995"></a>00995         atomic_inc(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3e442d9ea4a668bbf510222774623cda">lut_num_clients</a>);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: client at idx %d with UUID &apos;%s&apos; added, &quot;</span>
<a name="l00998"></a>00998                <span class="stringliteral">&quot;generation %d\n&quot;</span>,
<a name="l00999"></a>00999                tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, idx, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>,
<a name="l01000"></a>01000                ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a> = idx;
<a name="l01003"></a>01003         ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> = tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> +
<a name="l01004"></a>01004                           idx * tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a>;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         mutex_init(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> &gt; 0, <span class="stringliteral">&quot;ted_lr_off = %llu\n&quot;</span>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a><a class="code" href="tgt__lastrcvd_8c.html#ae06355ce6f7b058a8680d0fc5c986d87">01013</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#ae06355ce6f7b058a8680d0fc5c986d87">tgt_client_del</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l01014"></a>01014 {
<a name="l01015"></a>01015         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l01016"></a>01016         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = class_exp2tgt(exp);
<a name="l01017"></a>01017         <span class="keywordtype">int</span>                      rc;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>);
<a name="l01022"></a>01022 
<a name="l01023"></a>01023         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(tgt == NULL)) {
<a name="l01024"></a>01024                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#af25fefaf5c55ce92d41da370dc9399c2">D_ERROR</a>, <span class="stringliteral">&quot;%s: No target for connected export\n&quot;</span>,
<a name="l01025"></a>01025                        <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp)-&gt;obd_name);
<a name="l01026"></a>01026                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01027"></a>01027         }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="comment">/* XXX if lcd_uuid were a real obd_uuid, I could use obd_uuid_equals */</span>
<a name="l01030"></a>01030         <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *)ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>,
<a name="l01031"></a>01031                     (<span class="keywordtype">char</span> *)tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>) ||
<a name="l01032"></a>01032             <a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga2cc29f654f7faafdf9fa7a3da778d976">OBD_CONNECT_LIGHTWEIGHT</a>)
<a name="l01033"></a>01033                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01034"></a>01034 
<a name="l01035"></a>01035         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: del client at idx %u, off %lld, UUID &apos;%s&apos;\n&quot;</span>,
<a name="l01036"></a>01036                tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>,
<a name="l01037"></a>01037                ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039         <span class="comment">/* Clear the bit _after_ zeroing out the client so we don&apos;t</span>
<a name="l01040"></a>01040 <span class="comment">           race with filter_client_add and zero out new clients.*/</span>
<a name="l01041"></a>01041         <span class="keywordflow">if</span> (!test_bit(ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, tgt-&gt;<a class="code" href="structlu__target.html#a2d18a4211ca9aa571f8512b92698b06c" title="Bitmap of known clients.">lut_client_bitmap</a>)) {
<a name="l01042"></a>01042                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: client %u: bit already clear in bitmap!!\n&quot;</span>,
<a name="l01043"></a>01043                        tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>);
<a name="l01044"></a>01044                 <a class="code" href="libcfs__private_8h.html#a08eceadb65d1adcf8c198cff27081d5f">LBUG</a>();
<a name="l01045"></a>01045         }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         <span class="comment">/* Do not erase record for recoverable client. */</span>
<a name="l01048"></a>01048         <span class="keywordflow">if</span> (exp-&gt;<a class="code" href="structobd__export.html#a9af8470f0984fbdc08b23cb9c1f7d0eb">exp_flags</a> &amp; <a class="code" href="group__export.html#ggaa7d539acf7e0154bbd0ac7a193d6ea24ac5aec0e2a0642dda36417efa47263e6b">OBD_OPT_FAILOVER</a>)
<a name="l01049"></a>01049                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01050"></a>01050 
<a name="l01051"></a>01051         <span class="comment">/* Make sure the server&apos;s last_transno is up to date.</span>
<a name="l01052"></a>01052 <span class="comment">         * This should be done before zeroing client slot so last_transno will</span>
<a name="l01053"></a>01053 <span class="comment">         * be in server data or in client data in case of failure */</span>
<a name="l01054"></a>01054         rc = <a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>(env, tgt, 0);
<a name="l01055"></a>01055         <span class="keywordflow">if</span> (rc != 0) {
<a name="l01056"></a>01056                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: failed to update server data, skip client %s &quot;</span>
<a name="l01057"></a>01057                        <span class="stringliteral">&quot;zeroing, rc %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l01058"></a>01058                        ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, rc);
<a name="l01059"></a>01059                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01063"></a>01063         memset(ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>, 0, <span class="keyword">sizeof</span> ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>);
<a name="l01064"></a>01064         rc = <a class="code" href="tgt__lastrcvd_8c.html#a138757be1336910d9bb4d9733fa64a10" title="Update client data in last_rcvd.">tgt_client_data_update</a>(env, exp);
<a name="l01065"></a>01065         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(rc == 0 ? <a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a> : <a class="code" href="libcfs__debug_8h.html#af25fefaf5c55ce92d41da370dc9399c2">D_ERROR</a>,
<a name="l01068"></a>01068                <span class="stringliteral">&quot;%s: zeroing out client %s at idx %u (%llu), rc %d\n&quot;</span>,
<a name="l01069"></a>01069                tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>,
<a name="l01070"></a>01070                ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>, rc);
<a name="l01071"></a>01071         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01072"></a>01072 }
<a name="l01073"></a>01073 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#ae06355ce6f7b058a8680d0fc5c986d87">tgt_client_del</a>);
<a name="l01074"></a>01074 
<a name="l01075"></a><a class="code" href="tgt__lastrcvd_8c.html#ac72d931360580dc615579dd7062882d6">01075</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#ac72d931360580dc615579dd7062882d6">tgt_add_reply_data</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l01076"></a>01076                        <span class="keyword">struct</span> <a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a> *ted, <span class="keyword">struct</span> <a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a> *trd,
<a name="l01077"></a>01077                        <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th, <span class="keywordtype">bool</span> update_lrd_file)
<a name="l01078"></a>01078 {
<a name="l01079"></a>01079         <span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>   *lrd;
<a name="l01080"></a>01080         <span class="keywordtype">int</span>     i;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         lrd = &amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>;
<a name="l01083"></a>01083         <span class="comment">/* update export last transno */</span>
<a name="l01084"></a>01084         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01085"></a>01085         <span class="keywordflow">if</span> (lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a> &gt; ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a>)
<a name="l01086"></a>01086                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a> = lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>;
<a name="l01087"></a>01087         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089         <span class="comment">/* find a empty slot */</span>
<a name="l01090"></a>01090         i = <a class="code" href="tgt__lastrcvd_8c.html#a5ef235e17c1260f4121ace578e166cff">tgt_find_free_reply_slot</a>(tgt);
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(i &lt; 0)) {
<a name="l01092"></a>01092                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: couldn&apos;t find a slot for reply data: &quot;</span>
<a name="l01093"></a>01093                        <span class="stringliteral">&quot;rc = %d\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), i);
<a name="l01094"></a>01094                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(i);
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096         trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a> = i;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (update_lrd_file) {
<a name="l01099"></a>01099                 loff_t  off;
<a name="l01100"></a>01100                 <span class="keywordtype">int</span>     rc;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102                 <span class="comment">/* write reply data to disk */</span>
<a name="l01103"></a>01103                 off = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>) + sizeof(*lrd) * i;
<a name="l01104"></a>01104                 rc = <a class="code" href="tgt__lastrcvd_8c.html#a62e1f1275c502cbf71f491e3161eab5c">tgt_reply_data_write</a>(env, tgt, lrd, off, th);
<a name="l01105"></a>01105                 <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rc != 0)) {
<a name="l01106"></a>01106                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: can&apos;t update %s file: rc = %d\n&quot;</span>,
<a name="l01107"></a>01107                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>, rc);
<a name="l01108"></a>01108                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01109"></a>01109                 }
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111         <span class="comment">/* add reply data to target export&apos;s reply list */</span>
<a name="l01112"></a>01112         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01113"></a>01113         <a class="code" href="list_8h.html#a0373c4b3c8ce51a451a569ad978b32e1" title="Insert an entry at the start of a list.">list_add</a>(&amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>);
<a name="l01114"></a>01114         ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a>++;
<a name="l01115"></a>01115         <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a> &gt; ted-&gt;<a class="code" href="structtg__export__data.html#a14fbef0bc8c840cd343ade4cc37a181e">ted_reply_max</a>)
<a name="l01116"></a>01116                 ted-&gt;<a class="code" href="structtg__export__data.html#a14fbef0bc8c840cd343ade4cc37a181e">ted_reply_max</a> = ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a>;
<a name="l01117"></a>01117         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01118"></a>01118 
<a name="l01119"></a>01119         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a0d8304d29c79bce29fd8bc194e9b1df0">D_TRACE</a>, <span class="stringliteral">&quot;add reply %p: xid %llu, transno %llu, &quot;</span>
<a name="l01120"></a>01120                <span class="stringliteral">&quot;tag %hu, client gen %u, slot idx %d\n&quot;</span>,
<a name="l01121"></a>01121                trd, lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>, lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>,
<a name="l01122"></a>01122                trd-&gt;<a class="code" href="structtg__reply__data.html#ad3c38ce686a1ad50479394bd08703792" title="tag the client used">trd_tag</a>, lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>, i);
<a name="l01123"></a>01123         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01124"></a>01124 }
<a name="l01125"></a>01125 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#ac72d931360580dc615579dd7062882d6">tgt_add_reply_data</a>);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 <span class="comment">/*</span>
<a name="l01128"></a>01128 <span class="comment"> * last_rcvd &amp; last_committed update callbacks</span>
<a name="l01129"></a>01129 <span class="comment"> */</span>
<a name="l01130"></a><a class="code" href="tgt__lastrcvd_8c.html#a3feb6626f6155c126221bc395a59f6d1">01130</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a3feb6626f6155c126221bc395a59f6d1">tgt_last_rcvd_update</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l01131"></a>01131                                 <span class="keyword">struct</span> <a class="code" href="structdt__object.html">dt_object</a> *obj, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> opdata,
<a name="l01132"></a>01132                                 <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l01133"></a>01133 {
<a name="l01134"></a>01134         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01135"></a>01135         <span class="keyword">struct </span><a class="code" href="structtgt__session__info.html">tgt_session_info</a> *tsi = <a class="code" href="lu__target_8h.html#a826f2730d18464ad12be1a3fcb411b19">tgt_ses_info</a>(env);
<a name="l01136"></a>01136         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *exp = tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a>;
<a name="l01137"></a>01137         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted;
<a name="l01138"></a>01138         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   *transno_p;
<a name="l01139"></a>01139         <span class="keywordtype">int</span>                      rc = 0;
<a name="l01140"></a>01140         <span class="keywordtype">bool</span>                     lw_client;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 
<a name="l01145"></a>01145         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(exp != NULL);
<a name="l01146"></a>01146         ted = &amp;exp-&gt;exp_target_data;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         lw_client = <a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga2cc29f654f7faafdf9fa7a3da778d976">OBD_CONNECT_LIGHTWEIGHT</a>;
<a name="l01149"></a>01149         <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a> &lt; 0 &amp;&amp; !lw_client)
<a name="l01150"></a>01150                 <span class="comment">/* ofd connect may cause transaction before export has</span>
<a name="l01151"></a>01151 <span class="comment">                 * last_rcvd slot */</span>
<a name="l01152"></a>01152                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         <span class="keywordflow">if</span> (req != NULL)
<a name="l01155"></a>01155                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> = <a class="code" href="group__net.html#ga9bedef213e170e969899bfab36bb8fb0">lustre_msg_get_transno</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a98c2879f06b955c80000e8c1776373f7" title="Request message - what client sent.">rq_reqmsg</a>);
<a name="l01156"></a>01156         <span class="keywordflow">else</span>
<a name="l01157"></a>01157                 <span class="comment">/* From update replay, tti_transno should be set already */</span>
<a name="l01158"></a>01158                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> != 0);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> != 0) {
<a name="l01162"></a>01162                 <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> != 0) {
<a name="l01163"></a>01163                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: replay transno &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; failed: rc = %d\n&quot;</span>,
<a name="l01164"></a>01164                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>, th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a>);
<a name="l01165"></a>01165                 }
<a name="l01166"></a>01166         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> == 0) {
<a name="l01167"></a>01167                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> = ++tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>;
<a name="l01168"></a>01168         } <span class="keywordflow">else</span> {
<a name="l01169"></a>01169                 <span class="comment">/* should be replay */</span>
<a name="l01170"></a>01170                 <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> &gt; tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>)
<a name="l01171"></a>01171                         tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a> = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01172"></a>01172         }
<a name="l01173"></a>01173         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01174"></a>01174 
<a name="l01176"></a>01176         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> == 0 &amp;&amp; obj != NULL) {
<a name="l01177"></a>01177                 <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a> *dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(obj, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l01178"></a>01178                 <a class="code" href="group__dt.html#gaa5b07b45f6605ea88bfe89d439234504">dt_version_set</a>(env, dto, tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>, th);
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181         <span class="comment">/* filling reply data */</span>
<a name="l01182"></a>01182         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;, last_committed = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01183"></a>01183                tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a48d2bcfb7ce73ac3ecf2d30b2caa7900">obd_last_committed</a>);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185         <span class="keywordflow">if</span> (req != NULL) {
<a name="l01186"></a>01186                 req-&gt;<a class="code" href="structptlrpc__request.html#ab4228f142360486f518cebde2614dafd" title="Transaction number.">rq_transno</a> = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01187"></a>01187                 <a class="code" href="group__net.html#ga3866ca9b0ab811a58b005c6459519b3a">lustre_msg_set_transno</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a0c10a934ec07154a75ee696126876f3e" title="Reply message - server response.">rq_repmsg</a>, tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>);
<a name="l01188"></a>01188         }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="comment">/* if can&apos;t add callback, do sync write */</span>
<a name="l01191"></a>01191         th-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> |= !!<a class="code" href="lu__target_8h.html#a8ea97cdff05dd442f03030fac788b304">tgt_last_commit_cb_add</a>(th, tgt, exp, tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>);
<a name="l01192"></a>01192 
<a name="l01193"></a>01193         <span class="keywordflow">if</span> (lw_client) {
<a name="l01194"></a>01194                 <span class="comment">/* All operations performed by LW clients are synchronous and</span>
<a name="l01195"></a>01195 <span class="comment">                 * we store the committed transno in the last_rcvd header */</span>
<a name="l01196"></a>01196                 spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01197"></a>01197                 <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> &gt; tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>) {
<a name="l01198"></a>01198                         tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a> = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01199"></a>01199                         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01200"></a>01200                         <span class="comment">/* Although lightweight (LW) connections have no slot</span>
<a name="l01201"></a>01201 <span class="comment">                         * in the last_rcvd, we still want to maintain</span>
<a name="l01202"></a>01202 <span class="comment">                         * the in-memory lsd_client_data structure in order to</span>
<a name="l01203"></a>01203 <span class="comment">                         * properly handle reply reconstruction. */</span>
<a name="l01204"></a>01204                         rc = <a class="code" href="lu__target_8h.html#a1dccabb4f4156b6e5123ce32ab036880">tgt_server_data_write</a>(env, tgt, th);
<a name="l01205"></a>01205                 } <span class="keywordflow">else</span> {
<a name="l01206"></a>01206                         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01207"></a>01207                 }
<a name="l01208"></a>01208         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> == 0) {
<a name="l01209"></a>01209                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: client idx %d has offset %lld\n&quot;</span>,
<a name="l01210"></a>01210                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), ted-&gt;<a class="code" href="structtg__export__data.html#ab0da93ccc23eb8c582d5a03a7f30f465" title="Client index in last_rcvd file.">ted_lr_idx</a>, ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>);
<a name="l01211"></a>01211                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01212"></a>01212         }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214         <span class="comment">/* Target that supports multiple reply data */</span>
<a name="l01215"></a>01215         <span class="keywordflow">if</span> (<a class="code" href="lu__target_8h.html#a48f2e00fa02a5def96e9d48a49b42dc8">tgt_is_multimodrpcs_client</a>(exp)) {
<a name="l01216"></a>01216                 <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *trd;
<a name="l01217"></a>01217                 <span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>   *lrd;
<a name="l01218"></a>01218                 <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   *pre_versions;
<a name="l01219"></a>01219                 <span class="keywordtype">bool</span>                    write_update;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221                 <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(trd);
<a name="l01222"></a>01222                 <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(trd == NULL))
<a name="l01223"></a>01223                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225                 <span class="comment">/* fill reply data information */</span>
<a name="l01226"></a>01226                 lrd = &amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>;
<a name="l01227"></a>01227                 lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a> = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01228"></a>01228                 <span class="keywordflow">if</span> (req != NULL) {
<a name="l01229"></a>01229                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a> = req-&gt;<a class="code" href="structptlrpc__request.html#ab88b3c4dc962d237d5642e0808d323b2" title="xid">rq_xid</a>;
<a name="l01230"></a>01230                         trd-&gt;<a class="code" href="structtg__reply__data.html#ad3c38ce686a1ad50479394bd08703792" title="tag the client used">trd_tag</a> = <a class="code" href="group__net.html#gad697a66b5792cd2cd75bcf95f87d012b">lustre_msg_get_tag</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a98c2879f06b955c80000e8c1776373f7" title="Request message - what client sent.">rq_reqmsg</a>);
<a name="l01231"></a>01231                         pre_versions = <a class="code" href="group__net.html#gaf4f241bad6b8f2477c2d1176835fa44f">lustre_msg_get_versions</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a0c10a934ec07154a75ee696126876f3e" title="Reply message - server response.">rq_repmsg</a>);
<a name="l01232"></a>01232                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a> = th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a>;
<a name="l01233"></a>01233                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a> = ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>;
<a name="l01234"></a>01234                         write_update = <span class="keyword">true</span>;
<a name="l01235"></a>01235                 } <span class="keywordflow">else</span> {
<a name="l01236"></a>01236                         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tsi-&gt;<a class="code" href="structtgt__session__info.html#a9224915b1e251ff7b02374acb6af6142">tsi_xid</a> != 0);
<a name="l01237"></a>01237                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a> = tsi-&gt;<a class="code" href="structtgt__session__info.html#a9224915b1e251ff7b02374acb6af6142">tsi_xid</a>;
<a name="l01238"></a>01238                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#ab523de99fd7073f62d66e7dd21354f84">lrd_result</a> = tsi-&gt;<a class="code" href="structtgt__session__info.html#a16b48d2727e1711285c62a83f80e5796">tsi_result</a>;
<a name="l01239"></a>01239                         lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a> = tsi-&gt;<a class="code" href="structtgt__session__info.html#a701f429f8241e09eef61eb7e70995867">tsi_client_gen</a>;
<a name="l01240"></a>01240                         trd-&gt;<a class="code" href="structtg__reply__data.html#ad3c38ce686a1ad50479394bd08703792" title="tag the client used">trd_tag</a> = 0;
<a name="l01241"></a>01241                         pre_versions = NULL;
<a name="l01242"></a>01242                         write_update = <span class="keyword">false</span>;
<a name="l01243"></a>01243                 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245                 lrd-&gt;<a class="code" href="structlsd__reply__data.html#a9fbb20f0c61fa4dcf1762ab665ec9517">lrd_data</a> = opdata;
<a name="l01246"></a>01246                 <span class="keywordflow">if</span> (pre_versions) {
<a name="l01247"></a>01247                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[0] = pre_versions[0];
<a name="l01248"></a>01248                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[1] = pre_versions[1];
<a name="l01249"></a>01249                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[2] = pre_versions[2];
<a name="l01250"></a>01250                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[3] = pre_versions[3];
<a name="l01251"></a>01251                 }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253                 rc = <a class="code" href="lu__target_8h.html#ac72d931360580dc615579dd7062882d6">tgt_add_reply_data</a>(env, tgt, ted, trd, th, write_update);
<a name="l01254"></a>01254                 <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01255"></a>01255                         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(trd);
<a name="l01256"></a>01256                 <span class="keywordflow">return</span> rc;
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259         <span class="comment">/* Enough for update replay, let&apos;s return */</span>
<a name="l01260"></a>01260         <span class="keywordflow">if</span> (req == NULL)
<a name="l01261"></a>01261                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01262"></a>01262 
<a name="l01263"></a>01263         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01264"></a>01264         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> == 0, th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> != 0));
<a name="l01265"></a>01265         <span class="keywordflow">if</span> (<a class="code" href="group__net.html#ga5889b19f527897c102df244998c9de02">lustre_msg_get_opc</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a98c2879f06b955c80000e8c1776373f7" title="Request message - what client sent.">rq_reqmsg</a>) == <a class="code" href="group__lustreidl.html#ggafb46b2fd1532fecf64a120ca96d31c25a0946e267478099abd305528bc445ab1a">MDS_CLOSE</a>) {
<a name="l01266"></a>01266                 transno_p = &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a6ad7b67f5758de9763eaffa30ff3bc74">lcd_last_close_transno</a>;
<a name="l01267"></a>01267                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a08d18bb9d36536a68fd6c82e372ff54c">lcd_last_close_xid</a> = req-&gt;<a class="code" href="structptlrpc__request.html#ab88b3c4dc962d237d5642e0808d323b2" title="xid">rq_xid</a>;
<a name="l01268"></a>01268                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a951aed27a989180f4623c9eb8ccf5b85">lcd_last_close_result</a> = th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a>;
<a name="l01269"></a>01269         } <span class="keywordflow">else</span> {
<a name="l01270"></a>01270                 <span class="comment">/* VBR: save versions in last_rcvd for reconstruct. */</span>
<a name="l01271"></a>01271                 <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *pre_versions = <a class="code" href="group__net.html#gaf4f241bad6b8f2477c2d1176835fa44f">lustre_msg_get_versions</a>(req-&gt;<a class="code" href="structptlrpc__request.html#a0c10a934ec07154a75ee696126876f3e" title="Reply message - server response.">rq_repmsg</a>);
<a name="l01272"></a>01272 
<a name="l01273"></a>01273                 <span class="keywordflow">if</span> (pre_versions) {
<a name="l01274"></a>01274                         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a28fbd53e32c18fa4d03eff937ca76201">lcd_pre_versions</a>[0] = pre_versions[0];
<a name="l01275"></a>01275                         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a28fbd53e32c18fa4d03eff937ca76201">lcd_pre_versions</a>[1] = pre_versions[1];
<a name="l01276"></a>01276                         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a28fbd53e32c18fa4d03eff937ca76201">lcd_pre_versions</a>[2] = pre_versions[2];
<a name="l01277"></a>01277                         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a28fbd53e32c18fa4d03eff937ca76201">lcd_pre_versions</a>[3] = pre_versions[3];
<a name="l01278"></a>01278                 }
<a name="l01279"></a>01279                 transno_p = &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a>;
<a name="l01280"></a>01280                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a2cdd77f8c31381efa931d9ae1cd0cd74">lcd_last_xid</a> = req-&gt;<a class="code" href="structptlrpc__request.html#ab88b3c4dc962d237d5642e0808d323b2" title="xid">rq_xid</a>;
<a name="l01281"></a>01281                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a> = th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a>;
<a name="l01282"></a>01282                 <span class="comment">/* XXX: lcd_last_data is __u32 but intent_dispostion is __u64,</span>
<a name="l01283"></a>01283 <span class="comment">                 * see struct ldlm_reply-&gt;lock_policy_res1; */</span>
<a name="l01284"></a>01284                 ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#af6304f11d5aa307764a59033d60b99c2">lcd_last_data</a> = opdata;
<a name="l01285"></a>01285         }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         <span class="comment">/* Update transno in slot only if non-zero number, i.e. no errors */</span>
<a name="l01288"></a>01288         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> != 0)) {
<a name="l01289"></a>01289                 <span class="comment">/* Don&apos;t overwrite bigger transaction number with lower one.</span>
<a name="l01290"></a>01290 <span class="comment">                 * That is not sign of problem in all cases, but in any case</span>
<a name="l01291"></a>01291 <span class="comment">                 * this value should be monotonically increased only. */</span>
<a name="l01292"></a>01292                 <span class="keywordflow">if</span> (*transno_p &gt; tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>) {
<a name="l01293"></a>01293                         <span class="keywordflow">if</span> (!tgt-&gt;<a class="code" href="structlu__target.html#a363a4520c1284af3c714d20637eb44f1">lut_no_reconstruct</a>) {
<a name="l01294"></a>01294                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: trying to overwrite bigger transno:&quot;</span>
<a name="l01295"></a>01295                                        <span class="stringliteral">&quot;on-disk: &quot;</span>LPU64<span class="stringliteral">&quot;, new: &quot;</span>LPU64<span class="stringliteral">&quot; replay: &quot;</span>
<a name="l01296"></a>01296                                        <span class="stringliteral">&quot;%d. See LU-617.\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt),
<a name="l01297"></a>01297                                        *transno_p, tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>,
<a name="l01298"></a>01298                                        <a class="code" href="lu__target_8h.html#ac35fd4114bbe9e9e4ee79c5c83d3f2f0">req_is_replay</a>(req));
<a name="l01299"></a>01299                                 <span class="keywordflow">if</span> (<a class="code" href="lu__target_8h.html#ac35fd4114bbe9e9e4ee79c5c83d3f2f0">req_is_replay</a>(req)) {
<a name="l01300"></a>01300                                         spin_lock(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l01301"></a>01301                                         req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;<a class="code" href="structobd__export.html#a4ac08cf92bae3f705e49f9087ef2af98" title="VBR: failed version checking.">exp_vbr_failed</a> = 1;
<a name="l01302"></a>01302                                         spin_unlock(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l01303"></a>01303                                 }
<a name="l01304"></a>01304                                 mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01305"></a>01305                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(<a class="code" href="lu__target_8h.html#ac35fd4114bbe9e9e4ee79c5c83d3f2f0">req_is_replay</a>(req) ? -EOVERFLOW : 0);
<a name="l01306"></a>01306                         }
<a name="l01307"></a>01307                 } <span class="keywordflow">else</span> {
<a name="l01308"></a>01308                         *transno_p = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01309"></a>01309                 }
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312         <span class="keywordflow">if</span> (!lw_client) {
<a name="l01313"></a>01313                 tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>;
<a name="l01314"></a>01314                 rc = <a class="code" href="lu__target_8h.html#acc0b9a43bedcd9884727d24c123d2606">tgt_client_data_write</a>(env, tgt, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l01315"></a>01315                 <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01316"></a>01316                         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01317"></a>01317                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01318"></a>01318                 }
<a name="l01319"></a>01319         }
<a name="l01320"></a>01320         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01321"></a>01321         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01322"></a>01322 }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="comment">/*</span>
<a name="l01325"></a>01325 <span class="comment"> * last_rcvd update for echo client simulation.</span>
<a name="l01326"></a>01326 <span class="comment"> * It updates last_rcvd client slot and version of object in</span>
<a name="l01327"></a>01327 <span class="comment"> * simple way but with all locks to simulate all drawbacks</span>
<a name="l01328"></a>01328 <span class="comment"> */</span>
<a name="l01329"></a><a class="code" href="tgt__lastrcvd_8c.html#a7513a9d5af2dd47ea6ae1ad1ab28d6bf">01329</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#a7513a9d5af2dd47ea6ae1ad1ab28d6bf">tgt_last_rcvd_update_echo</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l01330"></a>01330                                      <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l01331"></a>01331                                      <span class="keyword">struct</span> <a class="code" href="structdt__object.html">dt_object</a> *obj,
<a name="l01332"></a>01332                                      <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th,
<a name="l01333"></a>01333                                      <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l01334"></a>01334 {
<a name="l01335"></a>01335         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01336"></a>01336         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l01337"></a>01337         <span class="keywordtype">int</span>                      rc = 0;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01340"></a>01340 
<a name="l01341"></a>01341         tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> = 0;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01344"></a>01344         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> == 0)
<a name="l01345"></a>01345                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> = ++tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>;
<a name="l01346"></a>01346         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01347"></a>01347 
<a name="l01349"></a>01349         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> == 0 &amp;&amp; obj != NULL)
<a name="l01350"></a>01350                 <a class="code" href="group__dt.html#gaa5b07b45f6605ea88bfe89d439234504">dt_version_set</a>(env, obj, tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>, th);
<a name="l01351"></a>01351 
<a name="l01352"></a>01352         <span class="comment">/* if can&apos;t add callback, do sync write */</span>
<a name="l01353"></a>01353         th-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> |= !!<a class="code" href="lu__target_8h.html#a8ea97cdff05dd442f03030fac788b304">tgt_last_commit_cb_add</a>(th, tgt, exp,
<a name="l01354"></a>01354                                                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a> &gt; 0);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01359"></a>01359         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> == 0, th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> != 0));
<a name="l01360"></a>01360         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#aa34e8dde5382ddb91a9910bf3048c91e">lcd_last_transno</a> = tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>;
<a name="l01361"></a>01361         ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>-&gt;<a class="code" href="structlsd__client__data.html#a6291fa228d0641b67c84b3a7e1cd7c7f">lcd_last_result</a> = th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a>;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363         tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = ted-&gt;<a class="code" href="structtg__export__data.html#aa240a66f6ca3086d5d7d7d8535e9a836" title="Offset of record in last_rcvd file.">ted_lr_off</a>;
<a name="l01364"></a>01364         rc = <a class="code" href="lu__target_8h.html#acc0b9a43bedcd9884727d24c123d2606">tgt_client_data_write</a>(env, tgt, ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l01365"></a>01365         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01366"></a>01366         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01367"></a>01367 }
<a name="l01368"></a>01368 
<a name="l01369"></a><a class="code" href="tgt__lastrcvd_8c.html#abd76fcdb3e3fcf51730bd6474db88235">01369</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="tgt__lastrcvd_8c.html#abd76fcdb3e3fcf51730bd6474db88235">tgt_clients_data_init</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l01370"></a>01370                                  <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt,
<a name="l01371"></a>01371                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> last_size)
<a name="l01372"></a>01372 {
<a name="l01373"></a>01373         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>;
<a name="l01374"></a>01374         <span class="keyword">struct </span><a class="code" href="structlr__server__data.html">lr_server_data</a>   *lsd = &amp;tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>;
<a name="l01375"></a>01375         <span class="keyword">struct </span><a class="code" href="structlsd__client__data.html">lsd_client_data</a>  *lcd = NULL;
<a name="l01376"></a>01376         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted;
<a name="l01377"></a>01377         <span class="keywordtype">int</span>                      cl_idx;
<a name="l01378"></a>01378         <span class="keywordtype">int</span>                      rc = 0;
<a name="l01379"></a>01379         loff_t                   off = lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>;
<a name="l01380"></a>01380         __u32                    generation = 0;
<a name="l01381"></a>01381         <span class="keyword">struct </span><a class="code" href="structcfs__hash.html" title="cfs_hash is a hash-table implementation for general purpose, it can support: .">cfs_hash</a>         *hash = NULL;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         <a class="code" href="osd__iam_8h.html#accba6d34cf012c360c3ad61f87373778">CLASSERT</a>(<a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(<span class="keyword">struct</span> <a class="code" href="structlsd__client__data.html">lsd_client_data</a>, lcd_padding) +
<a name="l01386"></a>01386                  <span class="keyword">sizeof</span>(lcd-&gt;<a class="code" href="structlsd__client__data.html#adac0cecfefe1d55879556e76a0d20ef7">lcd_padding</a>) == <a class="code" href="group__disk.html#ga4fc2948d961e40d589fa02851c40217f">LR_CLIENT_SIZE</a>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(lcd);
<a name="l01389"></a>01389         <span class="keywordflow">if</span> (lcd == NULL)
<a name="l01390"></a>01390                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392         hash = <a class="code" href="libcfs__hash_8h.html#a911b0cdf3c5eb118a068657ea3f5361d">cfs_hash_getref</a>(tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#ad9aae12786529dd60db7e88e5262cb03">obd_gen_hash</a>);
<a name="l01393"></a>01393         <span class="keywordflow">if</span> (hash == NULL)
<a name="l01394"></a>01394                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_out, rc = -ENODEV);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396         <span class="keywordflow">for</span> (cl_idx = 0; off &lt; last_size; cl_idx++) {
<a name="l01397"></a>01397                 <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *exp;
<a name="l01398"></a>01398                 <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                    last_transno;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400                 <span class="comment">/* Don&apos;t assume off is incremented properly by</span>
<a name="l01401"></a>01401 <span class="comment">                 * read_record(), in case sizeof(*lcd)</span>
<a name="l01402"></a>01402 <span class="comment">                 * isn&apos;t the same as fsd-&gt;lsd_client_size.  */</span>
<a name="l01403"></a>01403                 off = lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> + cl_idx * lsd-&gt;<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a>;
<a name="l01404"></a>01404                 rc = <a class="code" href="lu__target_8h.html#a80e781a056f2762e5c2bffb383805447">tgt_client_data_read</a>(env, tgt, lcd, &amp;off, cl_idx);
<a name="l01405"></a>01405                 <span class="keywordflow">if</span> (rc) {
<a name="l01406"></a>01406                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error reading last_rcvd %s idx %d off &quot;</span>
<a name="l01407"></a>01407                                <span class="stringliteral">&quot;%llu: rc = %d\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gac8e3ba79706d505528860ea4e3654f24">LAST_RCVD</a>,
<a name="l01408"></a>01408                                cl_idx, off, rc);
<a name="l01409"></a>01409                         rc = 0;
<a name="l01410"></a>01410                         <span class="keywordflow">break</span>; <span class="comment">/* read error shouldn&apos;t cause startup to fail */</span>
<a name="l01411"></a>01411                 }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413                 <span class="keywordflow">if</span> (lcd-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01414"></a>01414                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;skipping zeroed client at offset %d\n&quot;</span>,
<a name="l01415"></a>01415                                cl_idx);
<a name="l01416"></a>01416                         <span class="keywordflow">continue</span>;
<a name="l01417"></a>01417                 }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419                 last_transno = <a class="code" href="group__disk.html#ga52220fe3f791dff03458133dfda6f275">lcd_last_transno</a>(lcd);
<a name="l01420"></a>01420 
<a name="l01421"></a>01421                 <span class="comment">/* These exports are cleaned up by disconnect, so they</span>
<a name="l01422"></a>01422 <span class="comment">                 * need to be set up like real exports as connect does.</span>
<a name="l01423"></a>01423 <span class="comment">                 */</span>
<a name="l01424"></a>01424                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;RCVRNG CLIENT uuid: %s idx: %d lr: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a>
<a name="l01425"></a>01425                        <span class="stringliteral">&quot; srv lr: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; lx: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; gen %u\n&quot;</span>, lcd-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>,
<a name="l01426"></a>01426                        cl_idx, last_transno, lsd-&gt;<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>,
<a name="l01427"></a>01427                        <a class="code" href="group__disk.html#ga73a5fe9c71dc8e32c4797031fbf4468b">lcd_last_xid</a>(lcd), lcd-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429                 exp = <a class="code" href="obd__class_8h.html#a1f8afeb544faf735e1c2318bd4dce388">class_new_export</a>(obd, (<span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *)lcd-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>);
<a name="l01430"></a>01430                 <span class="keywordflow">if</span> (IS_ERR(exp)) {
<a name="l01431"></a>01431                         <span class="keywordflow">if</span> (PTR_ERR(exp) == -EALREADY) {
<a name="l01432"></a>01432                                 <span class="comment">/* export already exists, zero out this one */</span>
<a name="l01433"></a>01433                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: Duplicate export %s!\n&quot;</span>,
<a name="l01434"></a>01434                                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lcd-&gt;<a class="code" href="structlsd__client__data.html#a5b1e07d36b51acb38a91b6bfcc14bbe6">lcd_uuid</a>);
<a name="l01435"></a>01435                                 <span class="keywordflow">continue</span>;
<a name="l01436"></a>01436                         }
<a name="l01437"></a>01437                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_out, rc = PTR_ERR(exp));
<a name="l01438"></a>01438                 }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440                 ted = &amp;exp-&gt;exp_target_data;
<a name="l01441"></a>01441                 *ted-&gt;<a class="code" href="structtg__export__data.html#a40e41e91cd7906c5ab6896d0fb753855" title="Per-client data for each export.">ted_lcd</a> = *lcd;
<a name="l01442"></a>01442 
<a name="l01443"></a>01443                 rc = <a class="code" href="lu__target_8h.html#ae0570485d445a89719425bfcd663f9fc">tgt_client_add</a>(env, exp, cl_idx);
<a name="l01444"></a>01444                 <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(rc == 0, <span class="stringliteral">&quot;rc = %d\n&quot;</span>, rc); <span class="comment">/* can&apos;t fail existing */</span>
<a name="l01445"></a>01445                 <span class="comment">/* VBR: set export last committed version */</span>
<a name="l01446"></a>01446                 exp-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a> = last_transno;
<a name="l01447"></a>01447                 spin_lock(&amp;exp-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l01448"></a>01448                 exp-&gt;<a class="code" href="structobd__export.html#a0f92d30f2245b3333e5a8ad9140c4938">exp_connecting</a> = 0;
<a name="l01449"></a>01449                 exp-&gt;<a class="code" href="structobd__export.html#aae8ef5145842053b64c5ca2fb9ea8766">exp_in_recovery</a> = 0;
<a name="l01450"></a>01450                 spin_unlock(&amp;exp-&gt;<a class="code" href="structobd__export.html#a3d3174a4ec7f564a2aea27b749b472e5" title="protects exp_flags, exp_outstanding_replies and the change of exp_imp_reverse">exp_lock</a>);
<a name="l01451"></a>01451                 obd-&gt;<a class="code" href="structobd__device.html#a0f2d4254017aec550cfe1c78f13d8b53">obd_max_recoverable_clients</a>++;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>.<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> &amp;
<a name="l01454"></a>01454                     <a class="code" href="group__disk.html#ga6ea31649ec3838f33d51d39cfe05957a" title="multiple RPCs in flight">OBD_INCOMPAT_MULTI_RPCS</a> &amp;&amp;
<a name="l01455"></a>01455                     lcd-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a> != 0) {
<a name="l01456"></a>01456                         <span class="comment">/* compute the highest valid client generation */</span>
<a name="l01457"></a>01457                         generation = <a class="code" href="lnet_2utils_2debug_8c.html#ae1e1dde676c120fa6d10f3bb2c14059e">max</a>(generation, lcd-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>);
<a name="l01458"></a>01458                         <span class="comment">/* fill client_generation &lt;-&gt; export hash table */</span>
<a name="l01459"></a>01459                         rc = <a class="code" href="libcfs__hash_8h.html#a4be9049de769cd2632a3941b4517c26f" title="Add item  to libcfs hash  using .">cfs_hash_add_unique</a>(hash, &amp;lcd-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>,
<a name="l01460"></a>01460                                                  &amp;exp-&gt;<a class="code" href="structobd__export.html#a8a0591eb0ed18d672eff8323c2cfb6c9" title="nid-export hash">exp_gen_hash</a>);
<a name="l01461"></a>01461                         <span class="keywordflow">if</span> (rc != 0) {
<a name="l01462"></a>01462                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: duplicate export for client &quot;</span>
<a name="l01463"></a>01463                                        <span class="stringliteral">&quot;generation %u\n&quot;</span>,
<a name="l01464"></a>01464                                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lcd-&gt;<a class="code" href="structlsd__client__data.html#af12ae10fd56eebda758d5cbb48926364">lcd_generation</a>);
<a name="l01465"></a>01465                                 <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(exp);
<a name="l01466"></a>01466                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_out, rc);
<a name="l01467"></a>01467                         }
<a name="l01468"></a>01468                 }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470                 <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(exp);
<a name="l01471"></a>01471 
<a name="l01472"></a>01472                 rc = rev_import_init(exp);
<a name="l01473"></a>01473                 <span class="keywordflow">if</span> (rc != 0) {
<a name="l01474"></a>01474                         <a class="code" href="obd__class_8h.html#a2d822613c29af14a61e1df4c707b44de">class_unlink_export</a>(exp);
<a name="l01475"></a>01475                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_out, rc);
<a name="l01476"></a>01476                 }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478                 <span class="comment">/* Need to check last_rcvd even for duplicated exports. */</span>
<a name="l01479"></a>01479                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#ab317254094d62cdd1f3b99bf74c98edc">D_OTHER</a>, <span class="stringliteral">&quot;client at idx %d has last_transno = &quot;</span>LPU64<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01480"></a>01480                        cl_idx, last_transno);
<a name="l01481"></a>01481 
<a name="l01482"></a>01482                 spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01483"></a>01483                 tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a> = <a class="code" href="lnet_2utils_2debug_8c.html#ae1e1dde676c120fa6d10f3bb2c14059e">max</a>(last_transno,
<a name="l01484"></a>01484                                             tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>);
<a name="l01485"></a>01485                 spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01486"></a>01486         }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488         <span class="comment">/* record highest valid client generation */</span>
<a name="l01489"></a>01489         atomic_set(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a2dd90e9a3e4eb2a47567d6f62a9c3aa7">lut_client_generation</a>, generation);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 err_out:
<a name="l01492"></a>01492         <span class="keywordflow">if</span> (hash != NULL)
<a name="l01493"></a>01493                 <a class="code" href="libcfs__hash_8h.html#a2e4028cb849fd08c386ca9e72da3d720">cfs_hash_putref</a>(hash);
<a name="l01494"></a>01494         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(lcd);
<a name="l01495"></a>01495         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 
<a name="l01498"></a><a class="code" href="structserver__compat__data.html">01498</a> <span class="keyword">struct </span><a class="code" href="structserver__compat__data.html">server_compat_data</a> {
<a name="l01499"></a><a class="code" href="structserver__compat__data.html#adfacdf07772e330c85bc98c7923ae0bb">01499</a>         __u32 <a class="code" href="structserver__compat__data.html#adfacdf07772e330c85bc98c7923ae0bb">rocompat</a>;
<a name="l01500"></a><a class="code" href="structserver__compat__data.html#a28def5914ff20b8c890b0cce55697332">01500</a>         __u32 <a class="code" href="structserver__compat__data.html#a28def5914ff20b8c890b0cce55697332">incompat</a>;
<a name="l01501"></a><a class="code" href="structserver__compat__data.html#a80b8d031ce1d1f665a66b2ddfcebf6ab">01501</a>         __u32 <a class="code" href="structserver__compat__data.html#a80b8d031ce1d1f665a66b2ddfcebf6ab">rocinit</a>;
<a name="l01502"></a><a class="code" href="structserver__compat__data.html#ae76876733d3f62bddc5ae7994514148c">01502</a>         __u32 <a class="code" href="structserver__compat__data.html#ae76876733d3f62bddc5ae7994514148c">incinit</a>;
<a name="l01503"></a>01503 };
<a name="l01504"></a>01504 
<a name="l01505"></a><a class="code" href="tgt__lastrcvd_8c.html#a9e16ef3c25324719bf3a461a0862cc74">01505</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structserver__compat__data.html">server_compat_data</a> <a class="code" href="tgt__lastrcvd_8c.html#a9e16ef3c25324719bf3a461a0862cc74">tgt_scd</a>[] = {
<a name="l01506"></a>01506         [<a class="code" href="group__disk.html#ga239bf7011bd0132b9ac1386f3d1e8e9e">LDD_F_SV_TYPE_MDT</a>] = {
<a name="l01507"></a>01507                 .<a class="code" href="structserver__compat__data.html#adfacdf07772e330c85bc98c7923ae0bb">rocompat</a> = <a class="code" href="group__disk.html#ga50f7db745027032457edfdea54f259b8" title="MDS handles LOV_OBJID file.">OBD_ROCOMPAT_LOVOBJID</a>,
<a name="l01508"></a>01508                 .incompat = <a class="code" href="group__disk.html#ga034a4c77db624500222781cca1ba116f" title="this is an MDT">OBD_INCOMPAT_MDT</a> | <a class="code" href="group__disk.html#ga4dbf4ca01fe0197e36c0e9f7e09e93d5" title="common last_rvcd format">OBD_INCOMPAT_COMMON_LR</a> |
<a name="l01509"></a>01509                             <a class="code" href="group__disk.html#ga5e65ff906fce9ed737a354c319a2c795" title="FID is enabled.">OBD_INCOMPAT_FID</a> | <a class="code" href="group__disk.html#ga53e722bfc92b2173e39d5c5e82cf7812" title="filesystem using iam format to store directory entries">OBD_INCOMPAT_IAM_DIR</a> |
<a name="l01510"></a>01510                             <a class="code" href="group__disk.html#gad7cd6139d1525cced619e50b51822b5a" title="lmm_stripe_count has been shrunk from __u32 to __u16 and the remaining 16 bits are...">OBD_INCOMPAT_LMM_VER</a> | <a class="code" href="group__disk.html#gab23b85351c8a48b294b6488019a53ce2" title="multiple OI files for MDT">OBD_INCOMPAT_MULTI_OI</a> |
<a name="l01511"></a>01511                             <a class="code" href="group__disk.html#ga6ea31649ec3838f33d51d39cfe05957a" title="multiple RPCs in flight">OBD_INCOMPAT_MULTI_RPCS</a>,
<a name="l01512"></a>01512                 .rocinit = <a class="code" href="group__disk.html#ga50f7db745027032457edfdea54f259b8" title="MDS handles LOV_OBJID file.">OBD_ROCOMPAT_LOVOBJID</a>,
<a name="l01513"></a>01513                 .incinit = <a class="code" href="group__disk.html#ga034a4c77db624500222781cca1ba116f" title="this is an MDT">OBD_INCOMPAT_MDT</a> | <a class="code" href="group__disk.html#ga4dbf4ca01fe0197e36c0e9f7e09e93d5" title="common last_rvcd format">OBD_INCOMPAT_COMMON_LR</a> |
<a name="l01514"></a>01514                            <a class="code" href="group__disk.html#gab23b85351c8a48b294b6488019a53ce2" title="multiple OI files for MDT">OBD_INCOMPAT_MULTI_OI</a>,
<a name="l01515"></a>01515         },
<a name="l01516"></a>01516         [<a class="code" href="group__disk.html#gab5fc357552674218a1b8744bfd272fdc">LDD_F_SV_TYPE_OST</a>] = {
<a name="l01517"></a>01517                 .rocompat = <a class="code" href="group__disk.html#ga0eacb0ba57cfeae054b8cc322b67d9bc" title="store OST index in the IDIF">OBD_ROCOMPAT_IDX_IN_IDIF</a>,
<a name="l01518"></a>01518                 .incompat = <a class="code" href="group__disk.html#ga72b98149a4f2f6731d57c79ab60790db" title="this is an OST">OBD_INCOMPAT_OST</a> | <a class="code" href="group__disk.html#ga4dbf4ca01fe0197e36c0e9f7e09e93d5" title="common last_rvcd format">OBD_INCOMPAT_COMMON_LR</a> |
<a name="l01519"></a>01519                             <a class="code" href="group__disk.html#ga5e65ff906fce9ed737a354c319a2c795" title="FID is enabled.">OBD_INCOMPAT_FID</a>,
<a name="l01520"></a>01520                 .rocinit = <a class="code" href="group__disk.html#ga0eacb0ba57cfeae054b8cc322b67d9bc" title="store OST index in the IDIF">OBD_ROCOMPAT_IDX_IN_IDIF</a>,
<a name="l01521"></a>01521                 .incinit = <a class="code" href="group__disk.html#ga72b98149a4f2f6731d57c79ab60790db" title="this is an OST">OBD_INCOMPAT_OST</a> | <a class="code" href="group__disk.html#ga4dbf4ca01fe0197e36c0e9f7e09e93d5" title="common last_rvcd format">OBD_INCOMPAT_COMMON_LR</a>,
<a name="l01522"></a>01522         }
<a name="l01523"></a>01523 };
<a name="l01524"></a>01524 
<a name="l01525"></a><a class="code" href="tgt__lastrcvd_8c.html#ae37e9b2446f0e1978dddcf101571b39b">01525</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#ae37e9b2446f0e1978dddcf101571b39b">tgt_server_data_init</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt)
<a name="l01526"></a>01526 {
<a name="l01527"></a>01527         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>          *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01528"></a>01528         <span class="keyword">struct </span><a class="code" href="structlr__server__data.html">lr_server_data</a>           *lsd = &amp;tgt-&gt;<a class="code" href="structlu__target.html#a9c6812d813742406478c47fd3f8ca102" title="server data in last_rcvd file">lut_lsd</a>;
<a name="l01529"></a>01529         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>                    last_rcvd_size;
<a name="l01530"></a>01530         __u32                            index;
<a name="l01531"></a>01531         <span class="keywordtype">int</span>                              rc, type;
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         rc = <a class="code" href="dt__object_8h.html#a54e17b0020bc4d4c6be00e0fc689622a">dt_attr_get</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#af188f1b0d19d278961910da8096e52c6">tti_attr</a>);
<a name="l01534"></a>01534         <span class="keywordflow">if</span> (rc)
<a name="l01535"></a>01535                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01536"></a>01536 
<a name="l01537"></a>01537         last_rcvd_size = (<span class="keywordtype">unsigned</span> long)tti-&gt;<a class="code" href="structtgt__thread__info.html#af188f1b0d19d278961910da8096e52c6">tti_attr</a>.<a class="code" href="structlu__attr.html#a1a701b4d0d6a0c44590a0cda86be525f" title="size in bytes">la_size</a>;
<a name="l01538"></a>01538 
<a name="l01539"></a>01539         <span class="comment">/* ensure padding in the struct is the correct size */</span>
<a name="l01540"></a>01540         <a class="code" href="osd__iam_8h.html#accba6d34cf012c360c3ad61f87373778">CLASSERT</a>(<a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(<span class="keyword">struct</span> <a class="code" href="structlr__server__data.html">lr_server_data</a>, <a class="code" href="structlr__server__data.html#a448620f758ecd8c59334c75cd0227040">lsd_padding</a>) +
<a name="l01541"></a>01541                  <span class="keyword">sizeof</span>(lsd-&gt;<a class="code" href="structlr__server__data.html#a448620f758ecd8c59334c75cd0227040">lsd_padding</a>) == <a class="code" href="group__disk.html#ga10917aad8af57b7cc9aa9fcd6363a41b">LR_SERVER_SIZE</a>);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543         rc = <a class="code" href="obd__class_8h.html#a2de68e08b86703a60d591bc665dada3b">server_name2index</a>(<a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), &amp;index, NULL);
<a name="l01544"></a>01544         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01545"></a>01545                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: Can not get index from name: rc = %d\n&quot;</span>,
<a name="l01546"></a>01546                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), rc);
<a name="l01547"></a>01547                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01548"></a>01548         }
<a name="l01549"></a>01549         <span class="comment">/* server_name2index() returns type */</span>
<a name="l01550"></a>01550         type = rc;
<a name="l01551"></a>01551         <span class="keywordflow">if</span> (type != <a class="code" href="group__disk.html#ga239bf7011bd0132b9ac1386f3d1e8e9e">LDD_F_SV_TYPE_MDT</a> &amp;&amp; type != <a class="code" href="group__disk.html#gab5fc357552674218a1b8744bfd272fdc">LDD_F_SV_TYPE_OST</a>) {
<a name="l01552"></a>01552                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: unknown target type %x\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), type);
<a name="l01553"></a>01553                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01554"></a>01554         }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556         <span class="comment">/* last_rcvd on OST doesn&apos;t provide reconstruct support because there</span>
<a name="l01557"></a>01557 <span class="comment">         * may be up to 8 in-flight write requests per single slot in</span>
<a name="l01558"></a>01558 <span class="comment">         * last_rcvd client data</span>
<a name="l01559"></a>01559 <span class="comment">         */</span>
<a name="l01560"></a>01560         tgt-&gt;<a class="code" href="structlu__target.html#a363a4520c1284af3c714d20637eb44f1">lut_no_reconstruct</a> = (type == <a class="code" href="group__disk.html#gab5fc357552674218a1b8744bfd272fdc">LDD_F_SV_TYPE_OST</a>);
<a name="l01561"></a>01561 
<a name="l01562"></a>01562         <span class="keywordflow">if</span> (last_rcvd_size == 0) {
<a name="l01563"></a>01563                 <a class="code" href="libcfs__debug_8h.html#ac961fee8081e28c070b075fd57cd5a81">LCONSOLE_WARN</a>(<span class="stringliteral">&quot;%s: new disk, initializing\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt));
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                 memcpy(lsd-&gt;<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>,
<a name="l01566"></a>01566                        <span class="keyword">sizeof</span>(lsd-&gt;<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>));
<a name="l01567"></a>01567                 lsd-&gt;<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a> = 0;
<a name="l01568"></a>01568                 lsd-&gt;<a class="code" href="structlr__server__data.html#ab0497bc558eb40c2ca474998ddf0a6a4">lsd_mount_count</a> = 0;
<a name="l01569"></a>01569                 lsd-&gt;<a class="code" href="structlr__server__data.html#a97ab396a07ad918fb31e808c109791e5">lsd_server_size</a> = <a class="code" href="group__disk.html#ga10917aad8af57b7cc9aa9fcd6363a41b">LR_SERVER_SIZE</a>;
<a name="l01570"></a>01570                 lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> = <a class="code" href="group__disk.html#gacfcf37b705f37ed1d44395a4508b9ee5">LR_CLIENT_START</a>;
<a name="l01571"></a>01571                 lsd-&gt;<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a> = <a class="code" href="group__disk.html#ga4fc2948d961e40d589fa02851c40217f">LR_CLIENT_SIZE</a>;
<a name="l01572"></a>01572                 lsd-&gt;<a class="code" href="structlr__server__data.html#a3a75ad37f5e3c361e1d98c1cb87e7351">lsd_subdir_count</a> = <a class="code" href="obd__target_8h.html#acb0739b589ce145cfeda1ac18b59cd44">OBJ_SUBDIR_COUNT</a>;
<a name="l01573"></a>01573                 lsd-&gt;<a class="code" href="structlr__server__data.html#ac8aecba7a85d199d45e44bc50cf05add">lsd_osd_index</a> = index;
<a name="l01574"></a>01574                 lsd-&gt;<a class="code" href="structlr__server__data.html#af9e8f365b4407ddc7381675e7a59cc11">lsd_feature_rocompat</a> = tgt_scd[type].<a class="code" href="structserver__compat__data.html#a80b8d031ce1d1f665a66b2ddfcebf6ab">rocinit</a>;
<a name="l01575"></a>01575                 lsd-&gt;<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> = tgt_scd[type].<a class="code" href="structserver__compat__data.html#ae76876733d3f62bddc5ae7994514148c">incinit</a>;
<a name="l01576"></a>01576         } <span class="keywordflow">else</span> {
<a name="l01577"></a>01577                 rc = <a class="code" href="lu__target_8h.html#aa7ba1a91750722d9f42530227f371411">tgt_server_data_read</a>(env, tgt);
<a name="l01578"></a>01578                 <span class="keywordflow">if</span> (rc) {
<a name="l01579"></a>01579                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error reading LAST_RCVD: rc= %d\n&quot;</span>,
<a name="l01580"></a>01580                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), rc);
<a name="l01581"></a>01581                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01582"></a>01582                 }
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (strcmp(lsd-&gt;<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>, tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>)) {
<a name="l01584"></a>01584                         <a class="code" href="libcfs__debug_8h.html#a4d47af587afc53106bf8ebdf9da466e9">LCONSOLE_ERROR_MSG</a>(0x157, <span class="stringliteral">&quot;Trying to start OBD %s &quot;</span>
<a name="l01585"></a>01585                                            <span class="stringliteral">&quot;using the wrong disk %s. Were the&quot;</span>
<a name="l01586"></a>01586                                            <span class="stringliteral">&quot; /dev/ assignments rearranged?\n&quot;</span>,
<a name="l01587"></a>01587                                            tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>,
<a name="l01588"></a>01588                                            lsd-&gt;<a class="code" href="structlr__server__data.html#ae2d2e14047e83c0fb21f95419858c986">lsd_uuid</a>);
<a name="l01589"></a>01589                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01590"></a>01590                 }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592                 <span class="keywordflow">if</span> (lsd-&gt;<a class="code" href="structlr__server__data.html#ac8aecba7a85d199d45e44bc50cf05add">lsd_osd_index</a> != index) {
<a name="l01593"></a>01593                         <a class="code" href="libcfs__debug_8h.html#a4d47af587afc53106bf8ebdf9da466e9">LCONSOLE_ERROR_MSG</a>(0x157, <span class="stringliteral">&quot;%s: index %d in last rcvd &quot;</span>
<a name="l01594"></a>01594                                            <span class="stringliteral">&quot;is different with the index %d in&quot;</span>
<a name="l01595"></a>01595                                            <span class="stringliteral">&quot;config log, It might be disk&quot;</span>
<a name="l01596"></a>01596                                            <span class="stringliteral">&quot;corruption!\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt),
<a name="l01597"></a>01597                                            lsd-&gt;<a class="code" href="structlr__server__data.html#ac8aecba7a85d199d45e44bc50cf05add">lsd_osd_index</a>, index);
<a name="l01598"></a>01598                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01599"></a>01599                 }
<a name="l01600"></a>01600         }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602         <span class="keywordflow">if</span> (lsd-&gt;<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> &amp; ~tgt_scd[type].<a class="code" href="structserver__compat__data.html#a28def5914ff20b8c890b0cce55697332">incompat</a>) {
<a name="l01603"></a>01603                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: unsupported incompat filesystem feature(s) %x\n&quot;</span>,
<a name="l01604"></a>01604                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt),
<a name="l01605"></a>01605                        lsd-&gt;<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> &amp; ~tgt_scd[type].<a class="code" href="structserver__compat__data.html#a28def5914ff20b8c890b0cce55697332">incompat</a>);
<a name="l01606"></a>01606                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01607"></a>01607         }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609         <span class="keywordflow">if</span> (type == <a class="code" href="group__disk.html#ga239bf7011bd0132b9ac1386f3d1e8e9e">LDD_F_SV_TYPE_MDT</a>)
<a name="l01610"></a>01610                 lsd-&gt;<a class="code" href="structlr__server__data.html#a7a84fce7884aa7d7d9b2c0470775fd73">lsd_feature_incompat</a> |= <a class="code" href="group__disk.html#ga5e65ff906fce9ed737a354c319a2c795" title="FID is enabled.">OBD_INCOMPAT_FID</a>;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612         <span class="keywordflow">if</span> (lsd-&gt;<a class="code" href="structlr__server__data.html#af9e8f365b4407ddc7381675e7a59cc11">lsd_feature_rocompat</a> &amp; ~tgt_scd[type].<a class="code" href="structserver__compat__data.html#adfacdf07772e330c85bc98c7923ae0bb">rocompat</a>) {
<a name="l01613"></a>01613                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: unsupported read-only filesystem feature(s) %x\n&quot;</span>,
<a name="l01614"></a>01614                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt),
<a name="l01615"></a>01615                        lsd-&gt;<a class="code" href="structlr__server__data.html#af9e8f365b4407ddc7381675e7a59cc11">lsd_feature_rocompat</a> &amp; ~tgt_scd[type].<a class="code" href="structserver__compat__data.html#adfacdf07772e330c85bc98c7923ae0bb">rocompat</a>);
<a name="l01616"></a>01616                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01617"></a>01617         }
<a name="l01619"></a>01619         <span class="keywordflow">if</span> (type == <a class="code" href="group__disk.html#ga239bf7011bd0132b9ac1386f3d1e8e9e">LDD_F_SV_TYPE_MDT</a> &amp;&amp;
<a name="l01620"></a>01620             !(lsd-&gt;<a class="code" href="structlr__server__data.html#a31133d0e1d556b7fc30dba530b2a4b3b">lsd_feature_compat</a> &amp; <a class="code" href="group__disk.html#gaf63aa96555befc5295fbd7add2b1d9f4" title="2.0 server, interop flag to show server version is changed">OBD_COMPAT_20</a>)) {
<a name="l01621"></a>01621                 <span class="keywordflow">if</span> (last_rcvd_size &gt; lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>) {
<a name="l01622"></a>01622                         <a class="code" href="libcfs__debug_8h.html#ac961fee8081e28c070b075fd57cd5a81">LCONSOLE_WARN</a>(<span class="stringliteral">&quot;%s: mounting at first time on 1.8 FS, &quot;</span>
<a name="l01623"></a>01623                                       <span class="stringliteral">&quot;remove all clients for interop needs\n&quot;</span>,
<a name="l01624"></a>01624                                       <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt));
<a name="l01625"></a>01625                         rc = <a class="code" href="lu__target_8h.html#a2e5f8a2dd90c0ad92d23869264fb8113">tgt_truncate_last_rcvd</a>(env, tgt,
<a name="l01626"></a>01626                                                     lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>);
<a name="l01627"></a>01627                         <span class="keywordflow">if</span> (rc)
<a name="l01628"></a>01628                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01629"></a>01629                         last_rcvd_size = lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>;
<a name="l01630"></a>01630                 }
<a name="l01632"></a>01632                 lsd-&gt;<a class="code" href="structlr__server__data.html#a31133d0e1d556b7fc30dba530b2a4b3b">lsd_feature_compat</a> |= <a class="code" href="group__disk.html#gaf63aa96555befc5295fbd7add2b1d9f4" title="2.0 server, interop flag to show server version is changed">OBD_COMPAT_20</a>;
<a name="l01633"></a>01633         }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01636"></a>01636         tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a> = lsd-&gt;<a class="code" href="structlr__server__data.html#a5d7acdd326b4b0af1b54cd15c3da5f44">lsd_last_transno</a>;
<a name="l01637"></a>01637         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01638"></a>01638 
<a name="l01639"></a>01639         lsd-&gt;<a class="code" href="structlr__server__data.html#ab0497bc558eb40c2ca474998ddf0a6a4">lsd_mount_count</a>++;
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;=======,=BEGIN DUMPING LAST_RCVD========\n&quot;</span>);
<a name="l01642"></a>01642         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: server last_transno: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01643"></a>01643                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>);
<a name="l01644"></a>01644         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: server mount_count: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01645"></a>01645                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lsd-&gt;<a class="code" href="structlr__server__data.html#ab0497bc558eb40c2ca474998ddf0a6a4">lsd_mount_count</a>);
<a name="l01646"></a>01646         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: server data size: %u\n&quot;</span>,
<a name="l01647"></a>01647                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lsd-&gt;<a class="code" href="structlr__server__data.html#a97ab396a07ad918fb31e808c109791e5">lsd_server_size</a>);
<a name="l01648"></a>01648         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: per-client data start: %u\n&quot;</span>,
<a name="l01649"></a>01649                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>);
<a name="l01650"></a>01650         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: per-client data size: %u\n&quot;</span>,
<a name="l01651"></a>01651                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lsd-&gt;<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a>);
<a name="l01652"></a>01652         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: last_rcvd size: %lu\n&quot;</span>,
<a name="l01653"></a>01653                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), last_rcvd_size);
<a name="l01654"></a>01654         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: server subdir_count: %u\n&quot;</span>,
<a name="l01655"></a>01655                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), lsd-&gt;<a class="code" href="structlr__server__data.html#a3a75ad37f5e3c361e1d98c1cb87e7351">lsd_subdir_count</a>);
<a name="l01656"></a>01656         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: last_rcvd clients: %lu\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt),
<a name="l01657"></a>01657                last_rcvd_size &lt;= lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> ? 0 :
<a name="l01658"></a>01658                (last_rcvd_size - lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a>) /
<a name="l01659"></a>01659                 lsd-&gt;<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a>);
<a name="l01660"></a>01660         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;========END DUMPING LAST_RCVD========\n&quot;</span>);
<a name="l01661"></a>01661 
<a name="l01662"></a>01662         <span class="keywordflow">if</span> (lsd-&gt;<a class="code" href="structlr__server__data.html#a97ab396a07ad918fb31e808c109791e5">lsd_server_size</a> == 0 || lsd-&gt;<a class="code" href="structlr__server__data.html#a3acd013d834368f67dd54a2b0d233509">lsd_client_start</a> == 0 ||
<a name="l01663"></a>01663             lsd-&gt;<a class="code" href="structlr__server__data.html#a9e97e9fc6e7debfb330a7341009dc3ac">lsd_client_size</a> == 0) {
<a name="l01664"></a>01664                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: bad last_rcvd contents!\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt));
<a name="l01665"></a>01665                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01666"></a>01666         }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         <span class="keywordflow">if</span> (!tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a983b5a45d664cf697a57b620e0b712a4">obd_replayable</a>)
<a name="l01669"></a>01669                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%s: recovery support OFF\n&quot;</span>, <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt));
<a name="l01670"></a>01670 
<a name="l01671"></a>01671         rc = <a class="code" href="tgt__lastrcvd_8c.html#abd76fcdb3e3fcf51730bd6474db88235">tgt_clients_data_init</a>(env, tgt, last_rcvd_size);
<a name="l01672"></a>01672         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01673"></a>01673                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_client, rc);
<a name="l01674"></a>01674 
<a name="l01675"></a>01675         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01676"></a>01676         <span class="comment">/* obd_last_committed is used for compatibility</span>
<a name="l01677"></a>01677 <span class="comment">         * with other lustre recovery code */</span>
<a name="l01678"></a>01678         tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a48d2bcfb7ce73ac3ecf2d30b2caa7900">obd_last_committed</a> = tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>;
<a name="l01679"></a>01679         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01680"></a>01680 
<a name="l01681"></a>01681         tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.obt.obt_mount_count = lsd-&gt;<a class="code" href="structlr__server__data.html#ab0497bc558eb40c2ca474998ddf0a6a4">lsd_mount_count</a>;
<a name="l01682"></a>01682         tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.obt.obt_instance = (__u32)lsd-&gt;<a class="code" href="structlr__server__data.html#ab0497bc558eb40c2ca474998ddf0a6a4">lsd_mount_count</a>;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684         <span class="comment">/* save it, so mount count and last_transno is current */</span>
<a name="l01685"></a>01685         rc = <a class="code" href="lu__target_8h.html#a75ea00a45210c18097c626b56b111ae7" title="Update server data in last_rcvd.">tgt_server_data_update</a>(env, tgt, 0);
<a name="l01686"></a>01686         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01687"></a>01687                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(err_client, rc);
<a name="l01688"></a>01688 
<a name="l01689"></a>01689         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01690"></a>01690 
<a name="l01691"></a>01691 err_client:
<a name="l01692"></a>01692         <a class="code" href="obd__class_8h.html#a9e83b4d4e4233faa4dc973ac9f1da366">class_disconnect_exports</a>(tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>);
<a name="l01693"></a>01693         <span class="keywordflow">return</span> rc;
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 <span class="comment">/* add credits for last_rcvd update */</span>
<a name="l01697"></a><a class="code" href="tgt__lastrcvd_8c.html#a38d59da36521433cfc15f37967c2746e">01697</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#a38d59da36521433cfc15f37967c2746e">tgt_txn_start_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th,
<a name="l01698"></a>01698                      <span class="keywordtype">void</span> *cookie)
<a name="l01699"></a>01699 {
<a name="l01700"></a>01700         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = cookie;
<a name="l01701"></a>01701         <span class="keyword">struct </span><a class="code" href="structtgt__session__info.html">tgt_session_info</a> *tsi;
<a name="l01702"></a>01702         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01703"></a>01703         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *dto;
<a name="l01704"></a>01704         <span class="keywordtype">int</span>                      rc;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <span class="comment">/* if there is no session, then this transaction is not result of</span>
<a name="l01707"></a>01707 <span class="comment">         * request processing but some local operation */</span>
<a name="l01708"></a>01708         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="structlu__env.html#a1428adbfa83ae8a08464e22392aa272c" title="&amp;quot;Session&amp;quot; context for per-request data.">le_ses</a> == NULL)
<a name="l01709"></a>01709                 <span class="keywordflow">return</span> 0;
<a name="l01710"></a>01710 
<a name="l01711"></a>01711         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>);
<a name="l01712"></a>01712         tsi = <a class="code" href="lu__target_8h.html#a826f2730d18464ad12be1a3fcb411b19">tgt_ses_info</a>(env);
<a name="l01713"></a>01713         <span class="comment">/* OFD may start transaction without export assigned */</span>
<a name="l01714"></a>01714         <span class="keywordflow">if</span> (tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a> == NULL)
<a name="l01715"></a>01715                 <span class="keywordflow">return</span> 0;
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#a489d75882c35d0e3ec060d67031e2c26" title="last_rcvd file">lut_last_rcvd</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l01718"></a>01718         <a class="code" href="tgt__lastrcvd_8c.html#aaf15a0b780510b81f33fa75d9628694f">tti_buf_lcd</a>(tti);
<a name="l01719"></a>01719 
<a name="l01720"></a>01720         rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l01721"></a>01721                                      tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a>-&gt;exp_target_data.ted_lr_off,
<a name="l01722"></a>01722                                      th);
<a name="l01723"></a>01723         <span class="keywordflow">if</span> (rc)
<a name="l01724"></a>01724                 <span class="keywordflow">return</span> rc;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726         <a class="code" href="tgt__lastrcvd_8c.html#abc190c959cccb615c91afa7ae40ddd53">tti_buf_lsd</a>(tti);
<a name="l01727"></a>01727         rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>, 0, th);
<a name="l01728"></a>01728         <span class="keywordflow">if</span> (rc)
<a name="l01729"></a>01729                 <span class="keywordflow">return</span> rc;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731         <span class="keywordflow">if</span> (<a class="code" href="lu__target_8h.html#a48f2e00fa02a5def96e9d48a49b42dc8">tgt_is_multimodrpcs_client</a>(tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a>)) {
<a name="l01732"></a>01732                 <span class="comment">/*</span>
<a name="l01733"></a>01733 <span class="comment">                 * Use maximum possible file offset for declaration to ensure</span>
<a name="l01734"></a>01734 <span class="comment">                 * ZFS will reserve enough credits for a write anywhere in this</span>
<a name="l01735"></a>01735 <span class="comment">                 * file, since we don&apos;t know where in the file the write will be</span>
<a name="l01736"></a>01736 <span class="comment">                 * because a replay slot has not been assigned.  This should be</span>
<a name="l01737"></a>01737 <span class="comment">                 * replaced by dmu_tx_hold_append() when available.</span>
<a name="l01738"></a>01738 <span class="comment">                 */</span>
<a name="l01739"></a>01739                 tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a> = atomic_read(&amp;tgt-&gt;<a class="code" href="structlu__target.html#a3e442d9ea4a668bbf510222774623cda">lut_num_clients</a>) * 8 *
<a name="l01740"></a>01740                                 <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>);
<a name="l01741"></a>01741                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a> = NULL;
<a name="l01742"></a>01742                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>.<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>);
<a name="l01743"></a>01743                 dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l01744"></a>01744                 rc = <a class="code" href="dt__object_8h.html#abce616285763a761d1331299f8e4dafc">dt_declare_record_write</a>(env, dto, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a178466a3580a34c1042aa22d0b0f2e94">tti_buf</a>,
<a name="l01745"></a>01745                                              tti-&gt;<a class="code" href="structtgt__thread__info.html#aea17b4717ada506068304c40d92dff48">tti_off</a>, th);
<a name="l01746"></a>01746                 <span class="keywordflow">if</span> (rc)
<a name="l01747"></a>01747                         <span class="keywordflow">return</span> rc;
<a name="l01748"></a>01748         }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750         <span class="keywordflow">if</span> (tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a> != NULL &amp;&amp;
<a name="l01751"></a>01751             !<a class="code" href="group__lu.html#ga3f1244491405504cc9adcc3b6ce78a91" title="Check whether object on the remote storage.">lu_object_remote</a>(&amp;tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a>-&gt;<a class="code" href="structdt__object.html#af646d1f1afe6acdc83ad0778a29163d7">do_lu</a>)) {
<a name="l01752"></a>01752                 dto = <a class="code" href="group__dt.html#gacaec0c850493b1e3a584d73ac6364142">dt_object_locate</a>(tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a>, th-&gt;<a class="code" href="structthandle.html#ade585afae0d30b274a8259d402e918b6" title="the dt device on which the transactions are executed">th_dev</a>);
<a name="l01753"></a>01753                 rc = <a class="code" href="group__dt.html#ga37e50073474b1f546edc3ca29f3f8255">dt_declare_version_set</a>(env, dto, th);
<a name="l01754"></a>01754         }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756         <span class="keywordflow">return</span> rc;
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759 <span class="comment">/* Update last_rcvd records with latests transaction data */</span>
<a name="l01760"></a><a class="code" href="tgt__lastrcvd_8c.html#a4422f06a2a87e28b67af5cf4d7443bac">01760</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#a4422f06a2a87e28b67af5cf4d7443bac">tgt_txn_stop_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th,
<a name="l01761"></a>01761                     <span class="keywordtype">void</span> *cookie)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *tgt = cookie;
<a name="l01764"></a>01764         <span class="keyword">struct </span><a class="code" href="structtgt__session__info.html">tgt_session_info</a> *tsi;
<a name="l01765"></a>01765         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01766"></a>01766         <span class="keyword">struct </span><a class="code" href="structdt__object.html">dt_object</a>        *obj = NULL;
<a name="l01767"></a>01767         <span class="keywordtype">int</span>                      rc;
<a name="l01768"></a>01768         <span class="keywordtype">bool</span>                     echo_client;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="structlu__env.html#a1428adbfa83ae8a08464e22392aa272c" title="&amp;quot;Session&amp;quot; context for per-request data.">le_ses</a> == NULL)
<a name="l01771"></a>01771                 <span class="keywordflow">return</span> 0;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773         tsi = <a class="code" href="lu__target_8h.html#a826f2730d18464ad12be1a3fcb411b19">tgt_ses_info</a>(env);
<a name="l01774"></a>01774         <span class="comment">/* OFD may start transaction without export assigned */</span>
<a name="l01775"></a>01775         <span class="keywordflow">if</span> (tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a> == NULL)
<a name="l01776"></a>01776                 <span class="keywordflow">return</span> 0;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778         echo_client = (<a class="code" href="lu__target_8h.html#a3aa5cd628d4c16646dd262a507e90436">tgt_ses_req</a>(tsi) == NULL &amp;&amp; tsi-&gt;<a class="code" href="structtgt__session__info.html#a9224915b1e251ff7b02374acb6af6142">tsi_xid</a> == 0);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#a3e3dbdb20ab6e26198a893a4cebe2e09">tti_has_trans</a> &amp;&amp; !echo_client) {
<a name="l01781"></a>01781                 <span class="keywordflow">if</span> (tti-&gt;<a class="code" href="structtgt__thread__info.html#adccc8692f8112d3e85e9c05e893a60e2">tti_mult_trans</a> == 0) {
<a name="l01782"></a>01782                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;More than one transaction &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01783"></a>01783                                tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a>);
<a name="l01784"></a>01784                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01785"></a>01785                 }
<a name="l01786"></a>01786                 <span class="comment">/* we need another transno to be assigned */</span>
<a name="l01787"></a>01787                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a5bcfcafba7eda1d3556c52986eb31efb">tti_transno</a> = 0;
<a name="l01788"></a>01788         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (th-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> == 0) {
<a name="l01789"></a>01789                 tti-&gt;<a class="code" href="structtgt__thread__info.html#a3e3dbdb20ab6e26198a893a4cebe2e09">tti_has_trans</a> = 1;
<a name="l01790"></a>01790         }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792         <span class="keywordflow">if</span> (tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a> != NULL &amp;&amp;
<a name="l01793"></a>01793             !<a class="code" href="group__lu.html#ga3f1244491405504cc9adcc3b6ce78a91" title="Check whether object on the remote storage.">lu_object_remote</a>(&amp;tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a>-&gt;<a class="code" href="structdt__object.html#af646d1f1afe6acdc83ad0778a29163d7">do_lu</a>)) {
<a name="l01794"></a>01794                 obj = tsi-&gt;<a class="code" href="structtgt__session__info.html#a776b86404b5d0dec720b343fc978e3de">tsi_vbr_obj</a>;
<a name="l01795"></a>01795         }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(echo_client)) <span class="comment">/* echo client special case */</span>
<a name="l01798"></a>01798                 rc = <a class="code" href="tgt__lastrcvd_8c.html#a7513a9d5af2dd47ea6ae1ad1ab28d6bf">tgt_last_rcvd_update_echo</a>(env, tgt, obj, th,
<a name="l01799"></a>01799                                                tsi-&gt;<a class="code" href="structtgt__session__info.html#a419034e2d44ab0fb074bb92756805e9b">tsi_exp</a>);
<a name="l01800"></a>01800         <span class="keywordflow">else</span>
<a name="l01801"></a>01801                 rc = <a class="code" href="tgt__lastrcvd_8c.html#a3feb6626f6155c126221bc395a59f6d1">tgt_last_rcvd_update</a>(env, tgt, obj, tsi-&gt;<a class="code" href="structtgt__session__info.html#a397e90401d996f01e4d5c1df9acaac65">tsi_opdata</a>, th,
<a name="l01802"></a>01802                                           <a class="code" href="lu__target_8h.html#a3aa5cd628d4c16646dd262a507e90436">tgt_ses_req</a>(tsi));
<a name="l01803"></a>01803         <span class="keywordflow">return</span> rc;
<a name="l01804"></a>01804 }
<a name="l01805"></a>01805 
<a name="l01806"></a><a class="code" href="tgt__lastrcvd_8c.html#ab99cd07cafbe621f74fd8da8d827085a">01806</a> <span class="keywordtype">int</span> <a class="code" href="lu__target_8h.html#ab99cd07cafbe621f74fd8da8d827085a">tgt_reply_data_init</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structlu__target.html">lu_target</a> *tgt)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808         <span class="keyword">struct </span><a class="code" href="structtgt__thread__info.html" title="Common data shared by tg-level handlers.">tgt_thread_info</a>  *tti = <a class="code" href="tgt__internal_8h.html#afee3174ebf16e838162396614b05a6fd">tgt_th_info</a>(env);
<a name="l01809"></a>01809         <span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>   *lrd = &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#a8340c5af95028a2c49ee5aecfe71f0ab">tti_lrd</a>;
<a name="l01810"></a>01810         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>            reply_data_size;
<a name="l01811"></a>01811         <span class="keywordtype">int</span>                      rc;
<a name="l01812"></a>01812         <span class="keyword">struct </span><a class="code" href="structlsd__reply__header.html">lsd_reply_header</a> *<a class="code" href="llog__test_8c.html#ac46c031ff3a4268a1d002bfd2f4e0773">lrh</a> = NULL;
<a name="l01813"></a>01813         <span class="keyword">struct </span><a class="code" href="structlsd__client__data.html">lsd_client_data</a>  *lcd = NULL;
<a name="l01814"></a>01814         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *trd = NULL;
<a name="l01815"></a>01815         <span class="keywordtype">int</span>                      idx;
<a name="l01816"></a>01816         loff_t                   off;
<a name="l01817"></a>01817         <span class="keyword">struct </span><a class="code" href="structcfs__hash.html" title="cfs_hash is a hash-table implementation for general purpose, it can support: .">cfs_hash</a>         *hash = NULL;
<a name="l01818"></a>01818         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *exp;
<a name="l01819"></a>01819         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted;
<a name="l01820"></a>01820         <span class="keywordtype">int</span>                      reply_data_recovered = 0;
<a name="l01821"></a>01821 
<a name="l01822"></a>01822         rc = <a class="code" href="dt__object_8h.html#a54e17b0020bc4d4c6be00e0fc689622a">dt_attr_get</a>(env, tgt-&gt;<a class="code" href="structlu__target.html#aa415b8ae7c96a510e7bb6ff2dd3a6251" title="reply_data file">lut_reply_data</a>, &amp;tti-&gt;<a class="code" href="structtgt__thread__info.html#af188f1b0d19d278961910da8096e52c6">tti_attr</a>);
<a name="l01823"></a>01823         <span class="keywordflow">if</span> (rc)
<a name="l01824"></a>01824                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01825"></a>01825         reply_data_size = (<span class="keywordtype">unsigned</span> long)tti-&gt;<a class="code" href="structtgt__thread__info.html#af188f1b0d19d278961910da8096e52c6">tti_attr</a>.<a class="code" href="structlu__attr.html#a1a701b4d0d6a0c44590a0cda86be525f" title="size in bytes">la_size</a>;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(lrh);
<a name="l01828"></a>01828         <span class="keywordflow">if</span> (lrh == NULL)
<a name="l01829"></a>01829                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOMEM);
<a name="l01830"></a>01830 
<a name="l01831"></a>01831         <span class="keywordflow">if</span> (reply_data_size == 0) {
<a name="l01832"></a>01832                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: new reply_data file, initializing\n&quot;</span>,
<a name="l01833"></a>01833                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt));
<a name="l01834"></a>01834                 lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a> = <a class="code" href="group__disk.html#gad1320e138d9c724aee87e9313588c96c">LRH_MAGIC</a>;
<a name="l01835"></a>01835                 lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>);
<a name="l01836"></a>01836                 lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>);
<a name="l01837"></a>01837                 rc = <a class="code" href="tgt__lastrcvd_8c.html#a17b9e4c283d28e92fab771443bf8feb4">tgt_reply_header_write</a>(env, tgt, lrh);
<a name="l01838"></a>01838                 <span class="keywordflow">if</span> (rc) {
<a name="l01839"></a>01839                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error writing %s: rc = %d\n&quot;</span>,
<a name="l01840"></a>01840                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>, rc);
<a name="l01841"></a>01841                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01842"></a>01842                 }
<a name="l01843"></a>01843         } <span class="keywordflow">else</span> {
<a name="l01844"></a>01844                 rc = <a class="code" href="tgt__lastrcvd_8c.html#aa3685a5c15bc3a4e8a3599f56cbf5a7c">tgt_reply_header_read</a>(env, tgt, lrh);
<a name="l01845"></a>01845                 <span class="keywordflow">if</span> (rc) {
<a name="l01846"></a>01846                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error reading %s: rc = %d\n&quot;</span>,
<a name="l01847"></a>01847                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>, rc);
<a name="l01848"></a>01848                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01849"></a>01849                 }
<a name="l01850"></a>01850                 <span class="keywordflow">if</span> (lrh-&gt;<a class="code" href="structlsd__reply__header.html#abd292919f52cd0cb18a1813b85b1f7f0">lrh_magic</a> != <a class="code" href="group__disk.html#gad1320e138d9c724aee87e9313588c96c">LRH_MAGIC</a> ||
<a name="l01851"></a>01851                     lrh-&gt;<a class="code" href="structlsd__reply__header.html#a0d25edbb92a4b5d4dfe2c2fc2ffa3ba0">lrh_header_size</a> != <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>) ||
<a name="l01852"></a>01852                     lrh-&gt;<a class="code" href="structlsd__reply__header.html#aeb3849ce7db1bef918f6e1cc8e0226fc">lrh_reply_size</a> != <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>)) {
<a name="l01853"></a>01853                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: invalid header in %s\n&quot;</span>,
<a name="l01854"></a>01854                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>);
<a name="l01855"></a>01855                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l01856"></a>01856                 }
<a name="l01857"></a>01857 
<a name="l01858"></a>01858                 hash = <a class="code" href="libcfs__hash_8h.html#a911b0cdf3c5eb118a068657ea3f5361d">cfs_hash_getref</a>(tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#ad9aae12786529dd60db7e88e5262cb03">obd_gen_hash</a>);
<a name="l01859"></a>01859                 <span class="keywordflow">if</span> (hash == NULL)
<a name="l01860"></a>01860                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENODEV);
<a name="l01861"></a>01861 
<a name="l01862"></a>01862                 <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(lcd);
<a name="l01863"></a>01863                 <span class="keywordflow">if</span> (lcd == NULL)
<a name="l01864"></a>01864                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOMEM);
<a name="l01865"></a>01865 
<a name="l01866"></a>01866                 <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(trd);
<a name="l01867"></a>01867                 <span class="keywordflow">if</span> (trd == NULL)
<a name="l01868"></a>01868                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOMEM);
<a name="l01869"></a>01869 
<a name="l01870"></a>01870                 <span class="comment">/* Load reply_data from disk */</span>
<a name="l01871"></a>01871                 <span class="keywordflow">for</span> (idx = 0, off = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structlsd__reply__header.html">lsd_reply_header</a>);
<a name="l01872"></a>01872                      off &lt; reply_data_size;
<a name="l01873"></a>01873                      idx++, off += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlsd__reply__data.html">lsd_reply_data</a>)) {
<a name="l01874"></a>01874                         rc = <a class="code" href="tgt__lastrcvd_8c.html#a0c472c67a4742b3f6272b59adc9f77f6">tgt_reply_data_read</a>(env, tgt, lrd, off);
<a name="l01875"></a>01875                         <span class="keywordflow">if</span> (rc) {
<a name="l01876"></a>01876                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error reading %s: rc = %d\n&quot;</span>,
<a name="l01877"></a>01877                                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), <a class="code" href="group__disk.html#gaa1bcad24553b76813dc5992cf3c4491f">REPLY_DATA</a>, rc);
<a name="l01878"></a>01878                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01879"></a>01879                         }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881                         exp = <a class="code" href="libcfs__hash_8h.html#a8e2a5b89d520bf4a2d61a615d2b4db59" title="Lookup an item using  in the libcfs hash  and return it.">cfs_hash_lookup</a>(hash, &amp;lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>);
<a name="l01882"></a>01882                         <span class="keywordflow">if</span> (exp == NULL) {
<a name="l01883"></a>01883                                 <span class="comment">/* old reply data from a disconnected client */</span>
<a name="l01884"></a>01884                                 <span class="keywordflow">continue</span>;
<a name="l01885"></a>01885                         }
<a name="l01886"></a>01886                         ted = &amp;exp-&gt;exp_target_data;
<a name="l01887"></a>01887                         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01888"></a>01888 
<a name="l01889"></a>01889                         <span class="comment">/* create in-memory reply_data and link it to</span>
<a name="l01890"></a>01890 <span class="comment">                         * target export&apos;s reply list */</span>
<a name="l01891"></a>01891                         <a class="code" href="tgt__lastrcvd_8c.html#a683f013f8374218d81dc7e20404b4bea">tgt_set_reply_slot</a>(tgt, idx);
<a name="l01892"></a>01892                         trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a> = *lrd;
<a name="l01893"></a>01893                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[0] = 0;
<a name="l01894"></a>01894                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[1] = 0;
<a name="l01895"></a>01895                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[2] = 0;
<a name="l01896"></a>01896                         trd-&gt;<a class="code" href="structtg__reply__data.html#aca216b5276bdfb5823bdb404bd7fac33" title="versions for Version Based Recovery">trd_pre_versions</a>[3] = 0;
<a name="l01897"></a>01897                         trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a> = idx;
<a name="l01898"></a>01898                         trd-&gt;<a class="code" href="structtg__reply__data.html#ad3c38ce686a1ad50479394bd08703792" title="tag the client used">trd_tag</a> = 0;
<a name="l01899"></a>01899                         <a class="code" href="list_8h.html#a0373c4b3c8ce51a451a569ad978b32e1" title="Insert an entry at the start of a list.">list_add</a>(&amp;trd-&gt;<a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>);
<a name="l01900"></a>01900                         ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a>++;
<a name="l01901"></a>01901                         <span class="keywordflow">if</span> (ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a> &gt; ted-&gt;<a class="code" href="structtg__export__data.html#a14fbef0bc8c840cd343ade4cc37a181e">ted_reply_max</a>)
<a name="l01902"></a>01902                                 ted-&gt;<a class="code" href="structtg__export__data.html#a14fbef0bc8c840cd343ade4cc37a181e">ted_reply_max</a> = ted-&gt;<a class="code" href="structtg__export__data.html#a723acdc0a60ed47dc7e0d1279a64212c">ted_reply_cnt</a>;
<a name="l01903"></a>01903 
<a name="l01904"></a>01904                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;%s: restore reply %p: xid %llu, &quot;</span>
<a name="l01905"></a>01905                                <span class="stringliteral">&quot;transno %llu, client gen %u, slot idx %d\n&quot;</span>,
<a name="l01906"></a>01906                                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), trd, lrd-&gt;<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a>,
<a name="l01907"></a>01907                                lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>, lrd-&gt;<a class="code" href="structlsd__reply__data.html#a05a5c7c00338356860a661dc10c60f0f">lrd_client_gen</a>,
<a name="l01908"></a>01908                                trd-&gt;<a class="code" href="structtg__reply__data.html#ad52193ce42bdc177059e85b8786613f7" title="slot index in reply_data file">trd_index</a>);
<a name="l01909"></a>01909 
<a name="l01910"></a>01910                         <span class="comment">/* update export last committed transation */</span>
<a name="l01911"></a>01911                         exp-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a> = <a class="code" href="lnet_2utils_2debug_8c.html#ae1e1dde676c120fa6d10f3bb2c14059e">max</a>(exp-&gt;<a class="code" href="structobd__export.html#a99fd078f0cb65f312e4d80dd685cd2f5" title="Last committed transno for this export.">exp_last_committed</a>,
<a name="l01912"></a>01912                                                       lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>);
<a name="l01913"></a>01913 
<a name="l01914"></a>01914                         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01915"></a>01915                         <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(exp);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917                         <span class="comment">/* update target last committed transaction */</span>
<a name="l01918"></a>01918                         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01919"></a>01919                         tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a> = <a class="code" href="lnet_2utils_2debug_8c.html#ae1e1dde676c120fa6d10f3bb2c14059e">max</a>(tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>,
<a name="l01920"></a>01920                                                     lrd-&gt;<a class="code" href="structlsd__reply__data.html#a36cc1ed34e5216828b7ef35ca0846a44">lrd_transno</a>);
<a name="l01921"></a>01921                         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01922"></a>01922 
<a name="l01923"></a>01923                         reply_data_recovered++;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925                         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(trd);
<a name="l01926"></a>01926                         <span class="keywordflow">if</span> (trd == NULL)
<a name="l01927"></a>01927                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOMEM);
<a name="l01928"></a>01928                 }
<a name="l01929"></a>01929                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: %d reply data have been recovered\n&quot;</span>,
<a name="l01930"></a>01930                        <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(tgt), reply_data_recovered);
<a name="l01931"></a>01931         }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933         spin_lock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01934"></a>01934         <span class="comment">/* obd_last_committed is used for compatibility</span>
<a name="l01935"></a>01935 <span class="comment">         * with other lustre recovery code */</span>
<a name="l01936"></a>01936         tgt-&gt;<a class="code" href="structlu__target.html#a3f83a9ffe4f129edc35723619777fb04">lut_obd</a>-&gt;<a class="code" href="structobd__device.html#a48d2bcfb7ce73ac3ecf2d30b2caa7900">obd_last_committed</a> = tgt-&gt;<a class="code" href="structlu__target.html#a09b4c96358e825e8714789343890cde5" title="Server last transaction number.">lut_last_transno</a>;
<a name="l01937"></a>01937         spin_unlock(&amp;tgt-&gt;<a class="code" href="structlu__target.html#ae9334e90254a5a543756c64d0bca91c4" title="Lock protecting last transaction number.">lut_translock</a>);
<a name="l01938"></a>01938 
<a name="l01939"></a>01939         rc = 0;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941 out:
<a name="l01942"></a>01942         <span class="keywordflow">if</span> (hash != NULL)
<a name="l01943"></a>01943                 <a class="code" href="libcfs__hash_8h.html#a2e4028cb849fd08c386ca9e72da3d720">cfs_hash_putref</a>(hash);
<a name="l01944"></a>01944         <span class="keywordflow">if</span> (lcd != NULL)
<a name="l01945"></a>01945                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(lcd);
<a name="l01946"></a>01946         <span class="keywordflow">if</span> (trd != NULL)
<a name="l01947"></a>01947                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(trd);
<a name="l01948"></a>01948         <span class="keywordflow">if</span> (lrh != NULL)
<a name="l01949"></a>01949                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(lrh);
<a name="l01950"></a>01950         <span class="keywordflow">return</span> rc;
<a name="l01951"></a>01951 }
<a name="l01952"></a>01952 
<a name="l01953"></a><a class="code" href="tgt__lastrcvd_8c.html#a1fa6c0879bfd16d9a66bb88abcccbe08">01953</a> <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a> *<a class="code" href="lu__target_8h.html#a1fa6c0879bfd16d9a66bb88abcccbe08">tgt_lookup_reply_by_xid</a>(<span class="keyword">struct</span> <a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a> *ted,
<a name="l01954"></a>01954                                               <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> xid)
<a name="l01955"></a>01955 {
<a name="l01956"></a>01956         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *found = NULL;
<a name="l01957"></a>01957         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *reply;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01960"></a>01960         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(reply, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>, <a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>) {
<a name="l01961"></a>01961                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a> == xid) {
<a name="l01962"></a>01962                         found = reply;
<a name="l01963"></a>01963                         <span class="keywordflow">break</span>;
<a name="l01964"></a>01964                 }
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l01967"></a>01967         <span class="keywordflow">return</span> found;
<a name="l01968"></a>01968 }
<a name="l01969"></a>01969 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#a1fa6c0879bfd16d9a66bb88abcccbe08">tgt_lookup_reply_by_xid</a>);
<a name="l01970"></a>01970 
<a name="l01971"></a>01971 <span class="comment">/* Look for a reply data matching specified request @req</span>
<a name="l01972"></a>01972 <span class="comment"> * A copy is returned in @trd if the pointer is not NULL</span>
<a name="l01973"></a>01973 <span class="comment"> */</span>
<a name="l01974"></a><a class="code" href="tgt__lastrcvd_8c.html#ae293b0a02050bb040214fb913e9899ba">01974</a> <span class="keywordtype">bool</span> <a class="code" href="lu__target_8h.html#ae293b0a02050bb040214fb913e9899ba">tgt_lookup_reply</a>(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req, <span class="keyword">struct</span> <a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a> *trd)
<a name="l01975"></a>01975 {
<a name="l01976"></a>01976         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>-&gt;exp_target_data;
<a name="l01977"></a>01977         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *reply;
<a name="l01978"></a>01978         <span class="keywordtype">bool</span>                     found = <span class="keyword">false</span>;
<a name="l01979"></a>01979 
<a name="l01980"></a>01980         reply = <a class="code" href="lu__target_8h.html#a1fa6c0879bfd16d9a66bb88abcccbe08">tgt_lookup_reply_by_xid</a>(ted, req-&gt;<a class="code" href="structptlrpc__request.html#ab88b3c4dc962d237d5642e0808d323b2" title="xid">rq_xid</a>);
<a name="l01981"></a>01981         <span class="keywordflow">if</span> (reply != NULL) {
<a name="l01982"></a>01982                 found = <span class="keyword">true</span>;
<a name="l01983"></a>01983                 <span class="keywordflow">if</span> (trd != NULL)
<a name="l01984"></a>01984                         *trd = *reply;
<a name="l01985"></a>01985         }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a0d8304d29c79bce29fd8bc194e9b1df0">D_TRACE</a>, <span class="stringliteral">&quot;%s: lookup reply xid %llu, found %d\n&quot;</span>,
<a name="l01988"></a>01988                <a class="code" href="lu__target_8h.html#a2c4945fca8c447efc337068649e38186">tgt_name</a>(class_exp2tgt(req-&gt;<a class="code" href="structptlrpc__request.html#ac7af87194ec26c0e6646bdfaa943b17d" title="Server-side, export on which request was received.">rq_export</a>)), req-&gt;<a class="code" href="structptlrpc__request.html#ab88b3c4dc962d237d5642e0808d323b2" title="xid">rq_xid</a>,
<a name="l01989"></a>01989                found ? 1 : 0);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991         <span class="keywordflow">return</span> found;
<a name="l01992"></a>01992 }
<a name="l01993"></a>01993 EXPORT_SYMBOL(<a class="code" href="lu__target_8h.html#ae293b0a02050bb040214fb913e9899ba">tgt_lookup_reply</a>);
<a name="l01994"></a>01994 
<a name="l01995"></a><a class="code" href="tgt__lastrcvd_8c.html#aef5902c344803dae3f192bf81060cc8a">01995</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#aef5902c344803dae3f192bf81060cc8a">tgt_handle_received_xid</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> rcvd_xid)
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l01998"></a>01998         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *lut = class_exp2tgt(exp);
<a name="l01999"></a>01999         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *trd, *tmp;
<a name="l02000"></a>02000 
<a name="l02001"></a>02001         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l02002"></a>02002         <a class="code" href="list_8h.html#ac3f72d6bd5144c7970824813810d2da1" title="Iterate over a list of given type safe against removal of list entry.">list_for_each_entry_safe</a>(trd, tmp, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>, <a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>) {
<a name="l02003"></a>02003                 <span class="keywordflow">if</span> (trd-&gt;<a class="code" href="structtg__reply__data.html#a22e6b49a6ce9b0e35f0db739d5a91a9e" title="copy of on-disk reply data">trd_reply</a>.<a class="code" href="structlsd__reply__data.html#a1e0d68b233c159dd9d9576e176a0988a">lrd_xid</a> &gt; rcvd_xid)
<a name="l02004"></a>02004                         <span class="keywordflow">continue</span>;
<a name="l02005"></a>02005                 ted-&gt;<a class="code" href="structtg__export__data.html#a41277c9deb205695987abd61a10f2b3c">ted_release_xid</a>++;
<a name="l02006"></a>02006                 <a class="code" href="tgt__lastrcvd_8c.html#ac57b0abfc4247ed97a19a328c54d7bfa">tgt_release_reply_data</a>(lut, ted, trd);
<a name="l02007"></a>02007         }
<a name="l02008"></a>02008         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010         <span class="keywordflow">return</span> 0;
<a name="l02011"></a>02011 }
<a name="l02012"></a>02012 
<a name="l02013"></a><a class="code" href="tgt__lastrcvd_8c.html#a12b3a46bfd86349b6ffb61cd0d8c8847">02013</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#a12b3a46bfd86349b6ffb61cd0d8c8847">tgt_handle_tag</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, __u16 tag)
<a name="l02014"></a>02014 {
<a name="l02015"></a>02015         <span class="keyword">struct </span><a class="code" href="structtg__export__data.html" title="Target-specific export data.">tg_export_data</a>   *ted = &amp;exp-&gt;exp_target_data;
<a name="l02016"></a>02016         <span class="keyword">struct </span><a class="code" href="structlu__target.html">lu_target</a>        *lut = class_exp2tgt(exp);
<a name="l02017"></a>02017         <span class="keyword">struct </span><a class="code" href="structtg__reply__data.html" title="Target reply data.">tg_reply_data</a>    *trd, *tmp;
<a name="l02018"></a>02018 
<a name="l02019"></a>02019         <span class="keywordflow">if</span> (tag == 0)
<a name="l02020"></a>02020                 <span class="keywordflow">return</span> 0;
<a name="l02021"></a>02021 
<a name="l02022"></a>02022         mutex_lock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l02023"></a>02023         <a class="code" href="list_8h.html#ac3f72d6bd5144c7970824813810d2da1" title="Iterate over a list of given type safe against removal of list entry.">list_for_each_entry_safe</a>(trd, tmp, &amp;ted-&gt;<a class="code" href="structtg__export__data.html#a8f6448520a38c26bccfb83848a194c3c" title="List of reply data.">ted_reply_list</a>, <a class="code" href="structtg__reply__data.html#a1350185893c81d5cc2cd8db5c099fbdc" title="chain of reply data anchored in tg_export_data">trd_list</a>) {
<a name="l02024"></a>02024                 <span class="keywordflow">if</span> (trd-&gt;<a class="code" href="structtg__reply__data.html#ad3c38ce686a1ad50479394bd08703792" title="tag the client used">trd_tag</a> != tag)
<a name="l02025"></a>02025                         <span class="keywordflow">continue</span>;
<a name="l02026"></a>02026                 ted-&gt;<a class="code" href="structtg__export__data.html#a61c7ed675588b0ccfcf578ea6aaab0ab">ted_release_tag</a>++;
<a name="l02027"></a>02027                 <a class="code" href="tgt__lastrcvd_8c.html#ac57b0abfc4247ed97a19a328c54d7bfa">tgt_release_reply_data</a>(lut, ted, trd);
<a name="l02028"></a>02028                 <span class="keywordflow">break</span>;
<a name="l02029"></a>02029         }
<a name="l02030"></a>02030         mutex_unlock(&amp;ted-&gt;<a class="code" href="structtg__export__data.html#a31058efc56257a2ac61743ab38996ace" title="Protects ted_lcd, ted_reply_* and ted_release_* fields below.">ted_lcd_lock</a>);
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         <span class="keywordflow">return</span> 0;
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:44 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
