<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/ofd/ofd_grant.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/ofd/ofd_grant.c File Reference</h1><code>#include &quot;<a class="el" href="ofd__internal_8h_source.html">ofd_internal.h</a>&quot;</code><br/>

<p><a href="ofd__grant_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structofd__grant__cb.html">ofd_grant_cb</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_FILTER</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#adc34706955c7527927edf7aef4ab4e06">OFD_GRANT_SHRINK_LIMIT</a>(exp)&nbsp;&nbsp;&nbsp;(2ULL * 8 * exp_max_brw_size(exp))</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static u64&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a3807a3ecf1df047049a976a630227d87">ofd_grant_inflate</a> (struct <a class="el" href="structofd__device.html">ofd_device</a> *ofd, u64 val)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static u64&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a29ce04a8ee0668a051a9a48b1cd63b95">ofd_grant_deflate</a> (struct <a class="el" href="structofd__device.html">ofd_device</a> *ofd, u64 val)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static u64&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a7faa8aa15e5a34def92bf0d6b3c49d08">ofd_grant_chunk</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structofd__device.html">ofd_device</a> *ofd, struct <a class="el" href="structobd__connect__data.html">obd_connect_data</a> *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a01e9a616f37fbe4dd804bd6d864cd6e8">ofd_grant_sanity_check</a> (struct <a class="el" href="structobd__device.html">obd_device</a> *obd, const char *func)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Perform extra sanity checks for grant accounting.  <a href="#a01e9a616f37fbe4dd804bd6d864cd6e8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#aaeca1e9621bee8fc65b2609f8e0c4031">ofd_grant_statfs</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, int force, int *from_cache)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update cached statfs information from the OSD layer.  <a href="#aaeca1e9621bee8fc65b2609f8e0c4031"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static u64&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a1dd010bb25b487d84834c61581b78f67">ofd_grant_space_left</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Figure out how much space is available on the backend filesystem after removing grant space already booked by clients.  <a href="#a1dd010bb25b487d84834c61581b78f67"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a96f9a44541ccf53cfe0c5ec103f55cd8">ofd_grant_incoming</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobdo.html">obdo</a> *oa, long chunk)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process grant information from <a class="el" href="structobdo.html">obdo</a> structure packed in incoming BRW and inflate grant counters if required.  <a href="#a96f9a44541ccf53cfe0c5ec103f55cd8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#aaca185d66890a2c81982ed371f6d74f4">ofd_grant_shrink</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobdo.html">obdo</a> *oa, u64 left_space)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Grant shrink request handler.  <a href="#aaca185d66890a2c81982ed371f6d74f4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static u64&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a876310a8c66c9b2686d9014163fd3a4c">ofd_grant_rnb_size</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structofd__device.html">ofd_device</a> *ofd, struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *rnb)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate how much space is required to write a given <a class="el" href="structnetwork.html">network</a> buffer.  <a href="#a876310a8c66c9b2686d9014163fd3a4c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a22f325b870847a38fd4cd63ef75a8485">ofd_grant_check</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobdo.html">obdo</a> *oa, struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *rnb, int niocount, u64 *left)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Validate grant accounting for each incoming remote <a class="el" href="structnetwork.html">network</a> buffer.  <a href="#a22f325b870847a38fd4cd63ef75a8485"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a5ed5778d8ebda44b10e2ad9ad8cb7f92">ofd_grant_alloc</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, u64 curgrant, u64 want, u64 left, long chunk, bool conservative)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate additional grant space to a client.  <a href="#a5ed5778d8ebda44b10e2ad9ad8cb7f92"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a6d08da2f1b2f2d6e860d2f5c3c557802">ofd_grant_connect</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobd__connect__data.html">obd_connect_data</a> *data, bool new_conn)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handle grant space allocation on client connection &amp; reconnection.  <a href="#a6d08da2f1b2f2d6e860d2f5c3c557802"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a9dc214b6b807ee6b502fe0592f4e1f08">ofd_grant_discard</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release all grant space attached to a given export.  <a href="#a9dc214b6b807ee6b502fe0592f4e1f08"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a51b11ecae7477d806a7d3d7c75e1a816">ofd_grant_prepare_read</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobdo.html">obdo</a> *oa)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process grant information from incoming bulk read request.  <a href="#a51b11ecae7477d806a7d3d7c75e1a816"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#ad4cabc16c355460895a463ca3d1709f8">ofd_grant_prepare_write</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structobdo.html">obdo</a> *oa, struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *rnb, int niocount)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process grant information from incoming bulk write request.  <a href="#ad4cabc16c355460895a463ca3d1709f8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#aa2cd0e80217345bb6e78ac73a8c914d8">ofd_grant_create</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, int *nr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Consume grant space reserved for object creation.  <a href="#aa2cd0e80217345bb6e78ac73a8c914d8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a7ea6cee2b1147f98d0ac30b1ef6068c1">ofd_grant_commit</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, unsigned long pending, int rc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release grant space added to the pending counter by <a class="el" href="ofd__grant_8c.html#ad4cabc16c355460895a463ca3d1709f8" title="Process grant information from incoming bulk write request.">ofd_grant_prepare_write()</a>.  <a href="#a7ea6cee2b1147f98d0ac30b1ef6068c1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#abda3efd6f47e271a282421db1a30c9e7">ofd_grant_commit_cb</a> (struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structthandle.html">thandle</a> *th, struct <a class="el" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a> *cb, int err)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Callback function for grant releasing.  <a href="#abda3efd6f47e271a282421db1a30c9e7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__grant_8c.html#a5371b52fb45b560b50a4ea055f29f1de">ofd_grant_commit_cb_add</a> (struct <a class="el" href="structthandle.html">thandle</a> *th, struct <a class="el" href="structobd__export.html">obd_export</a> *exp, unsigned long granted)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add callback for grant releasing.  <a href="#a5371b52fb45b560b50a4ea055f29f1de"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="ofd_grant.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_FILTER</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00073">73</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

</div>
</div>
<a class="anchor" id="adc34706955c7527927edf7aef4ab4e06"></a><!-- doxytag: member="ofd_grant.c::OFD_GRANT_SHRINK_LIMIT" ref="adc34706955c7527927edf7aef4ab4e06" args="(exp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OFD_GRANT_SHRINK_LIMIT</td>
          <td>(</td>
          <td class="paramtype">exp&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;(2ULL * 8 * exp_max_brw_size(exp))</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00078">78</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00483">ofd_grant_shrink()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a5ed5778d8ebda44b10e2ad9ad8cb7f92"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_alloc" ref="a5ed5778d8ebda44b10e2ad9ad8cb7f92" args="(struct obd_export *exp, u64 curgrant, u64 want, u64 left, long chunk, bool conservative)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static long ofd_grant_alloc </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>curgrant</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>want</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>left</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>chunk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>conservative</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate additional grant space to a client. </p>
<p>Calculate how much grant space to return to client, based on how much space is currently free and how much of that is already granted. Caller must hold ofd_grant_lock spinlock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export of the client which sent the request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>curgrant</em>&nbsp;</td><td>current grant claimed by the client </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>want</em>&nbsp;</td><td>how much grant space the client would like to have </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>left</em>&nbsp;</td><td>remaining free space with granted space taken out </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>conservative</em>&nbsp;</td><td>if set to true, the server should be cautious and limit how much space is granted back to the client. Otherwise, the server should try hard to satisfy the client request.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>amount</em>&nbsp;</td><td>of grant space allocated </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00778">778</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00245">obd_export::exp_failed</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00639">obd_device::obd_num_exports</a>, <a class="el" href="obd_8h_source.html#l00603">obd_device::obd_recovering</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00445">ofd_grant_prohibit()</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l01172">ofd_grant_create()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a22f325b870847a38fd4cd63ef75a8485"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_check" ref="a22f325b870847a38fd4cd63ef75a8485" args="(const struct lu_env *env, struct obd_export *exp, struct obdo *oa, struct niobuf_remote *rnb, int niocount, u64 *left)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ofd_grant_check </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobdo.html">obdo</a> *&nbsp;</td>
          <td class="paramname"> <em>oa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *&nbsp;</td>
          <td class="paramname"> <em>rnb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>niocount</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64 *&nbsp;</td>
          <td class="paramname"> <em>left</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Validate grant accounting for each incoming remote <a class="el" href="structnetwork.html">network</a> buffer. </p>
<p>When clients have dirtied as much space as they've been granted they fall through to sync writes. These sync writes haven't been expressed in grants and need to error with ENOSPC when there isn't room in the filesystem for them after grants are taken into account. However, writeback of the dirty data that was already granted space can write right on through. The OBD_BRW_GRANTED flag will be set in the rnb_flags of each <a class="el" href="structnetwork.html">network</a> buffer which has been granted enough space to proceed. Buffers without this flag will fail to be written with -ENOSPC (see <a class="el" href="ofd__io_8c.html#a3e2417f451915f575c2003ec5cad7800" title="Prepare buffers for write request processing.">ofd_preprw_write()</a>. Caller must hold ofd_grant_lock spinlock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment passed by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export identifying the client which sent the RPC </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>oa</em>&nbsp;</td><td>incoming <a class="el" href="structobdo.html">obdo</a> in which we should return the pack the additional grant </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>rnb</em>&nbsp;</td><td>the list of <a class="el" href="structnetwork.html">network</a> buffers </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>niocount</em>&nbsp;</td><td>the number of <a class="el" href="structnetwork.html">network</a> buffers in the list </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>left</em>&nbsp;</td><td>the remaining free space with space already granted taken out </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00591">591</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00277">CWARN</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00111">filter_export_data::fed_dirty</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="lustre__export_8h_source.html#l00114">filter_export_data::fed_pending</a>, <a class="el" href="ofd__internal_8h_source.html#l00320">ofd_thread_info::fti_used</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l03398">obdo::o_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l01753">OBD_BRW_FROM_GRANT</a>, <a class="el" href="lustre__idl_8h_source.html#l01754">OBD_BRW_GRANTED</a>, <a class="el" href="lustre__idl_8h_source.html#l01445">OBD_FL_RECOV_RESEND</a>, <a class="el" href="lustre__idl_8h_source.html#l01667">OBD_MD_FLFLAGS</a>, <a class="el" href="lustre__idl_8h_source.html#l01683">OBD_MD_FLGRANT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00603">obd_device::obd_recovering</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00529">ofd_grant_rnb_size()</a>, <a class="el" href="ofd__internal_8h_source.html#l00501">ofd_info()</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, <a class="el" href="lustre__idl_8h_source.html#l01792">niobuf_remote::rnb_flags</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a7faa8aa15e5a34def92bf0d6b3c49d08"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_chunk" ref="a7faa8aa15e5a34def92bf0d6b3c49d08" args="(struct obd_export *exp, struct ofd_device *ofd, struct obd_connect_data *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static u64 ofd_grant_chunk </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structofd__device.html">ofd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>ofd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__connect__data.html">obd_connect_data</a> *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00106">106</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="dt__object_8h_source.html#l00091">dt_device_param::ddp_extent_tax</a>, <a class="el" href="dt__object_8h_source.html#l00086">dt_device_param::ddp_inodespace</a>, <a class="el" href="dt__object_8h_source.html#l00088">dt_device_param::ddp_max_extent_blks</a>, <a class="el" href="lustre__export_8h_source.html#l00309">exp_max_brw_size()</a>, <a class="el" href="lustre__idl_8h_source.html#l01268">OCD_HAS_FLAG</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00120">ofd_device::ofd_dt_conf</a>, <a class="el" href="ofd__grant_8c_source.html#l00082">ofd_grant_inflate()</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00202">ofd_obd()</a>, and <a class="el" href="lustre__idl_8h_source.html#l01770">OST_MAX_PRECREATE</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l01172">ofd_grant_create()</a>, <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a7ea6cee2b1147f98d0ac30b1ef6068c1"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_commit" ref="a7ea6cee2b1147f98d0ac30b1ef6068c1" args="(struct obd_export *exp, unsigned long pending, int rc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_commit </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&nbsp;</td>
          <td class="paramname"> <em>pending</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Release grant space added to the pending counter by <a class="el" href="ofd__grant_8c.html#ad4cabc16c355460895a463ca3d1709f8" title="Process grant information from incoming bulk write request.">ofd_grant_prepare_write()</a>. </p>
<p>Update pending grant counter once buffers have been written to the disk.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export of the client which sent the request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>pending</em>&nbsp;</td><td>amount of reserved space to be released </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rc</em>&nbsp;</td><td>return code of pre-commit operations </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l01264">1264</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="osc__internal_8h_source.html#l00177">min_t</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00141">ofd_device::ofd_osfs</a>, <a class="el" href="ofd__internal_8h_source.html#l00153">ofd_device::ofd_osfs_inflight</a>, <a class="el" href="ofd__internal_8h_source.html#l00139">ofd_device::ofd_osfs_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00150">ofd_device::ofd_statfs_inflight</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__io_8c_source.html#l01009">ofd_commitrw_write()</a>, <a class="el" href="ofd__dev_8c_source.html#l01553">ofd_create_hdl()</a>, <a class="el" href="ofd__obd_8c_source.html#l01084">ofd_echo_create()</a>, <a class="el" href="ofd__grant_8c_source.html#l01345">ofd_grant_commit_cb()</a>, and <a class="el" href="ofd__io_8c_source.html#l00524">ofd_preprw_write()</a>.</p>

</div>
</div>
<a class="anchor" id="abda3efd6f47e271a282421db1a30c9e7"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_commit_cb" ref="abda3efd6f47e271a282421db1a30c9e7" args="(struct lu_env *env, struct thandle *th, struct dt_txn_commit_cb *cb, int err)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ofd_grant_commit_cb </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__txn__commit__cb.html">dt_txn_commit_cb</a> *&nbsp;</td>
          <td class="paramname"> <em>cb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>err</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback function for grant releasing. </p>
<p>Release grant space reserved by the client node.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cb</em>&nbsp;</td><td>callback data </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>err</em>&nbsp;</td><td>error code </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l01345">1345</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="obd__class_8h_source.html#l00281">class_export_cb_put</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="ofd__grant_8c_source.html#l01264">ofd_grant_commit()</a>, <a class="el" href="ofd__grant_8c_source.html#l01328">ofd_grant_cb::ogc_cb</a>, <a class="el" href="ofd__grant_8c_source.html#l01330">ofd_grant_cb::ogc_exp</a>, and <a class="el" href="ofd__grant_8c_source.html#l01332">ofd_grant_cb::ogc_granted</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l01369">ofd_grant_commit_cb_add()</a>.</p>

</div>
</div>
<a class="anchor" id="a5371b52fb45b560b50a4ea055f29f1de"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_commit_cb_add" ref="a5371b52fb45b560b50a4ea055f29f1de" args="(struct thandle *th, struct obd_export *exp, unsigned long granted)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ofd_grant_commit_cb_add </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&nbsp;</td>
          <td class="paramname"> <em>granted</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add callback for grant releasing. </p>
<p>Register a commit callback to release grant space.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>OBD export of client </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>granted</em>&nbsp;</td><td>amount of grant space to be released upon commit</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on successful callback adding </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>value on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l01369">1369</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="obd__class_8h_source.html#l00273">class_export_cb_get</a>, <a class="el" href="obd__class_8h_source.html#l00281">class_export_cb_put</a>, <a class="el" href="dt__object_8h_source.html#l00110">dt_txn_commit_cb::dcb_func</a>, <a class="el" href="dt__object_8h_source.html#l00109">dt_txn_commit_cb::dcb_linkage</a>, <a class="el" href="dt__object_8h_source.html#l00114">dt_txn_commit_cb::dcb_name</a>, <a class="el" href="dt__object_8h_source.html#l02077">dt_trans_cb_add()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="ofd__grant_8c_source.html#l01345">ofd_grant_commit_cb()</a>, <a class="el" href="ofd__grant_8c_source.html#l01328">ofd_grant_cb::ogc_cb</a>, <a class="el" href="ofd__grant_8c_source.html#l01330">ofd_grant_cb::ogc_exp</a>, <a class="el" href="ofd__grant_8c_source.html#l01332">ofd_grant_cb::ogc_granted</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="string_8c_source.html#l00058">strlcpy()</a>.</p>

<p>Referenced by <a class="el" href="ofd__io_8c_source.html#l01009">ofd_commitrw_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a6d08da2f1b2f2d6e860d2f5c3c557802"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_connect" ref="a6d08da2f1b2f2d6e860d2f5c3c557802" args="(const struct lu_env *env, struct obd_export *exp, struct obd_connect_data *data, bool new_conn)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_connect </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__connect__data.html">obd_connect_data</a> *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>new_conn</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Handle grant space allocation on client connection &amp; reconnection. </p>
<p>A new non-readonly connection gets an initial grant allocation equals to <a class="el" href="ofd__grant_8c.html#a7faa8aa15e5a34def92bf0d6b3c49d08">ofd_grant_chunk()</a> (i.e. twice the max BRW size in most of the cases). On reconnection, grant counters between client &amp; OST are resynchronized and additional space might be granted back if possible.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>client's export which is (re)connecting </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>data</em>&nbsp;</td><td><a class="el" href="structobd__connect__data.html">obd_connect_data</a> structure sent by the client in the connect request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>new_conn</em>&nbsp;</td><td>must set to true if this is a new connection and false for a reconnection </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00868">868</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00111">filter_export_data::fed_dirty</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lustre__idl_8h_source.html#l01182">OBD_CONNECT_GRANT</a>, <a class="el" href="lustre__idl_8h_source.html#l01229">OBD_CONNECT_GRANT_PARAM</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="lustre__idl_8h_source.html#l01336">obd_connect_data::ocd_connect_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l01338">obd_connect_data::ocd_grant</a>, <a class="el" href="lustre__idl_8h_source.html#l01268">OCD_HAS_FLAG</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00778">ofd_grant_alloc()</a>, <a class="el" href="ofd__grant_8c_source.html#l00106">ofd_grant_chunk()</a>, <a class="el" href="ofd__internal_8h_source.html#l00175">ofd_device::ofd_grant_compat_disable</a>, <a class="el" href="ofd__grant_8c_source.html#l00095">ofd_grant_deflate()</a>, <a class="el" href="ofd__grant_8c_source.html#l00082">ofd_grant_inflate()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__grant_8c_source.html#l00330">ofd_grant_space_left()</a>, <a class="el" href="ofd__grant_8c_source.html#l00290">ofd_grant_statfs()</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00165">ofd_device::ofd_tot_granted_clients</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__obd_8c_source.html#l00137">ofd_parse_connect_data()</a>, and <a class="el" href="ofd__dev_8c_source.html#l00634">ofd_recovery_complete()</a>.</p>

</div>
</div>
<a class="anchor" id="aa2cd0e80217345bb6e78ac73a8c914d8"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_create" ref="aa2cd0e80217345bb6e78ac73a8c914d8" args="(const struct lu_env *env, struct obd_export *exp, int *nr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long ofd_grant_create </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>nr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Consume grant space reserved for object creation. </p>
<p>Grant space is allocated to the local self export for object precreation. This is required to prevent object precreation from consuming grant space allocated to client nodes for the data writeback cache. This function consumes enough space to create <em>nr</em> objects and allocates more grant space to the self export for future precreation requests, if possible.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export holding the grant space for precreation (= self export currently) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>nr</em>&nbsp;</td><td>number of objects to be created</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>&gt;=</em>&nbsp;</td><td>0 amount of grant space allocated to the precreate request </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOSPC</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l01172">1172</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00149">D_RPCTRACE</a>, <a class="el" href="dt__object_8h_source.html#l00086">dt_device_param::ddp_inodespace</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="lustre__export_8h_source.html#l00114">filter_export_data::fed_pending</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00603">obd_device::obd_recovering</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00120">ofd_device::ofd_dt_conf</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00778">ofd_grant_alloc()</a>, <a class="el" href="ofd__grant_8c_source.html#l00106">ofd_grant_chunk()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__grant_8c_source.html#l00330">ofd_grant_space_left()</a>, <a class="el" href="ofd__grant_8c_source.html#l00290">ofd_grant_statfs()</a>, <a class="el" href="ofd__internal_8h_source.html#l00212">ofd_name()</a>, <a class="el" href="ofd__internal_8h_source.html#l00141">ofd_device::ofd_osfs</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="lustre__user_8h_source.html#l00109">obd_statfs::os_blocks</a>, <a class="el" href="lustre__idl_8h_source.html#l01770">OST_MAX_PRECREATE</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="ofd__dev_8c_source.html#l01553">ofd_create_hdl()</a>, and <a class="el" href="ofd__obd_8c_source.html#l01084">ofd_echo_create()</a>.</p>

</div>
</div>
<a class="anchor" id="a29ce04a8ee0668a051a9a48b1cd63b95"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_deflate" ref="a29ce04a8ee0668a051a9a48b1cd63b95" args="(struct ofd_device *ofd, u64 val)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static u64 ofd_grant_deflate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structofd__device.html">ofd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>ofd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>val</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00095">95</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="ofd__internal_8h_source.html#l00443">COMPAT_BSIZE_SHIFT</a>, and <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a9dc214b6b807ee6b502fe0592f4e1f08"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_discard" ref="a9dc214b6b807ee6b502fe0592f4e1f08" args="(struct obd_export *exp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_discard </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Release all grant space attached to a given export. </p>
<p>Remove a client from the grant accounting totals. We also remove the export from the obd device under the osfs and dev locks to ensure that the <a class="el" href="ofd__grant_8c.html#a01e9a616f37fbe4dd804bd6d864cd6e8" title="Perform extra sanity checks for grant accounting.">ofd_grant_sanity_check()</a> calculations are always valid. The client should do something similar when it invalidates its import.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>client's export to remove from grant accounting </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00947">947</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00111">filter_export_data::fed_dirty</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="lustre__export_8h_source.html#l00114">filter_export_data::fed_pending</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__obd_8c_source.html#l00492">ofd_destroy_export()</a>, and <a class="el" href="ofd__obd_8c_source.html#l00411">ofd_obd_disconnect()</a>.</p>

</div>
</div>
<a class="anchor" id="a96f9a44541ccf53cfe0c5ec103f55cd8"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_incoming" ref="a96f9a44541ccf53cfe0c5ec103f55cd8" args="(const struct lu_env *env, struct obd_export *exp, struct obdo *oa, long chunk)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ofd_grant_incoming </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobdo.html">obdo</a> *&nbsp;</td>
          <td class="paramname"> <em>oa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>chunk</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Process grant information from <a class="el" href="structobdo.html">obdo</a> structure packed in incoming BRW and inflate grant counters if required. </p>
<p>Grab the dirty and seen grant announcements from the incoming <a class="el" href="structobdo.html">obdo</a> and inflate all grant counters passed in the request if the client does not support the grant parameters. We will later calculate the client's new grant and return it. Caller must hold ofd_grant_lock spinlock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment supplying osfs storage </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export for which we received the request </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>oa</em>&nbsp;</td><td>incoming <a class="el" href="structobdo.html">obdo</a> sent by the client </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00393">393</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00111">filter_export_data::fed_dirty</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="lustre__export_8h_source.html#l00114">filter_export_data::fed_pending</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lustre__idl_8h_source.html#l03391">obdo::o_grant</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l01661">OBD_MD_FLBLOCKS</a>, <a class="el" href="lustre__idl_8h_source.html#l01683">OBD_MD_FLGRANT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00082">ofd_grant_inflate()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a3807a3ecf1df047049a976a630227d87"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_inflate" ref="a3807a3ecf1df047049a976a630227d87" args="(struct ofd_device *ofd, u64 val)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static u64 ofd_grant_inflate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structofd__device.html">ofd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>ofd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>val</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00082">82</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="ofd__internal_8h_source.html#l00443">COMPAT_BSIZE_SHIFT</a>, and <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00106">ofd_grant_chunk()</a>, <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l00393">ofd_grant_incoming()</a>, and <a class="el" href="ofd__grant_8c_source.html#l00529">ofd_grant_rnb_size()</a>.</p>

</div>
</div>
<a class="anchor" id="a51b11ecae7477d806a7d3d7c75e1a816"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_prepare_read" ref="a51b11ecae7477d806a7d3d7c75e1a816" args="(const struct lu_env *env, struct obd_export *exp, struct obdo *oa)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_prepare_read </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobdo.html">obdo</a> *&nbsp;</td>
          <td class="paramname"> <em>oa</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Process grant information from incoming bulk read request. </p>
<p>Extract grant information packed in <a class="el" href="structobdo.html">obdo</a> structure (OBD_MD_FLGRANT set in o_valid). Bulk reads usually comes with grant announcements (number of dirty blocks, remaining amount of grant space, ...) and could also include a grant shrink request. Unlike bulk write, no additional grant space is returned on bulk read request.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>is the lu environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>is the export of the client which sent the request </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>oa</em>&nbsp;</td><td>is the incoming <a class="el" href="structobdo.html">obdo</a> sent by the client </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00988">988</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__idl_8h_source.html#l03398">obdo::o_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l03391">obdo::o_grant</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l01441">OBD_FL_SHRINK_GRANT</a>, <a class="el" href="lustre__idl_8h_source.html#l01667">OBD_MD_FLFLAGS</a>, <a class="el" href="lustre__idl_8h_source.html#l01683">OBD_MD_FLGRANT</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00106">ofd_grant_chunk()</a>, <a class="el" href="ofd__grant_8c_source.html#l00095">ofd_grant_deflate()</a>, <a class="el" href="ofd__grant_8c_source.html#l00393">ofd_grant_incoming()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00483">ofd_grant_shrink()</a>, <a class="el" href="ofd__grant_8c_source.html#l00330">ofd_grant_space_left()</a>, <a class="el" href="ofd__grant_8c_source.html#l00290">ofd_grant_statfs()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>.</p>

<p>Referenced by <a class="el" href="ofd__io_8c_source.html#l00685">ofd_preprw()</a>, <a class="el" href="ofd__io_8c_source.html#l00524">ofd_preprw_write()</a>, and <a class="el" href="ofd__dev_8c_source.html#l00897">ofd_set_info_hdl()</a>.</p>

</div>
</div>
<a class="anchor" id="ad4cabc16c355460895a463ca3d1709f8"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_prepare_write" ref="ad4cabc16c355460895a463ca3d1709f8" args="(const struct lu_env *env, struct obd_export *exp, struct obdo *oa, struct niobuf_remote *rnb, int niocount)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_prepare_write </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobdo.html">obdo</a> *&nbsp;</td>
          <td class="paramname"> <em>oa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *&nbsp;</td>
          <td class="paramname"> <em>rnb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>niocount</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Process grant information from incoming bulk write request. </p>
<p>This function extracts client's grant announcements from incoming bulk write request and attempts to allocate grant space for <a class="el" href="structnetwork.html">network</a> buffers that need it (i.e. OBD_BRW_FROM_GRANT not set in rnb_fags). Network buffers which aren't granted the OBD_BRW_GRANTED flag should not proceed further and should fail with -ENOSPC. Whenever possible, additional grant space will be returned to the client in the bulk write reply. <a class="el" href="ofd__grant_8c.html#ad4cabc16c355460895a463ca3d1709f8" title="Process grant information from incoming bulk write request.">ofd_grant_prepare_write()</a> must be called before writting any buffers to the backend storage. This function works in pair with <a class="el" href="ofd__grant_8c.html#a7ea6cee2b1147f98d0ac30b1ef6068c1" title="Release grant space added to the pending counter by ofd_grant_prepare_write().">ofd_grant_commit()</a> which must be invoked once all buffers have been written to disk in order to release space from the pending grant counter.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export of the client which sent the request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>oa</em>&nbsp;</td><td>incoming <a class="el" href="structobdo.html">obdo</a> sent by the client </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rnb</em>&nbsp;</td><td>list of <a class="el" href="structnetwork.html">network</a> buffers </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>niocount</em>&nbsp;</td><td>number of <a class="el" href="structnetwork.html">network</a> buffers in the list </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l01068">1068</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="dt__object_8h_source.html#l02465">dt_sync()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__idl_8h_source.html#l03398">obdo::o_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l03391">obdo::o_grant</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l01753">OBD_BRW_FROM_GRANT</a>, <a class="el" href="lustre__idl_8h_source.html#l01441">OBD_FL_SHRINK_GRANT</a>, <a class="el" href="lustre__idl_8h_source.html#l01667">OBD_MD_FLFLAGS</a>, <a class="el" href="lustre__idl_8h_source.html#l01683">OBD_MD_FLGRANT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00603">obd_device::obd_recovering</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00778">ofd_grant_alloc()</a>, <a class="el" href="ofd__grant_8c_source.html#l00591">ofd_grant_check()</a>, <a class="el" href="ofd__grant_8c_source.html#l00106">ofd_grant_chunk()</a>, <a class="el" href="ofd__grant_8c_source.html#l00095">ofd_grant_deflate()</a>, <a class="el" href="ofd__grant_8c_source.html#l00393">ofd_grant_incoming()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="ofd__grant_8c_source.html#l00483">ofd_grant_shrink()</a>, <a class="el" href="ofd__grant_8c_source.html#l00330">ofd_grant_space_left()</a>, <a class="el" href="ofd__grant_8c_source.html#l00290">ofd_grant_statfs()</a>, <a class="el" href="ofd__internal_8h_source.html#l00118">ofd_device::ofd_osd</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>.</p>

<p>Referenced by <a class="el" href="ofd__io_8c_source.html#l00524">ofd_preprw_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a876310a8c66c9b2686d9014163fd3a4c"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_rnb_size" ref="a876310a8c66c9b2686d9014163fd3a4c" args="(struct obd_export *exp, struct ofd_device *ofd, struct niobuf_remote *rnb)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static u64 ofd_grant_rnb_size </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structofd__device.html">ofd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>ofd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structniobuf__remote.html">niobuf_remote</a> *&nbsp;</td>
          <td class="paramname"> <em>rnb</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Calculate how much space is required to write a given <a class="el" href="structnetwork.html">network</a> buffer. </p>
<p>This function takes block alignment into account to estimate how much on-disk space will be required to successfully write the whole niobuf. Estimated space is inflated if the export does not support OBD_CONNECT_GRANT_PARAM and if the backend filesystem has a block size larger than the minimal supported page size (i.e. 4KB).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export associated which the write request if NULL, then size estimate is done for server-side grant allocation. </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ofd</em>&nbsp;</td><td>ofd device handling the request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rnb</em>&nbsp;</td><td><a class="el" href="structnetwork.html">network</a> buffer to estimate size of</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>space</em>&nbsp;</td><td>(in bytes) that will be consumed to write the <a class="el" href="structnetwork.html">network</a> buffer </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00529">529</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="ofd__internal_8h_source.html#l00443">COMPAT_BSIZE_SHIFT</a>, <a class="el" href="dt__object_8h_source.html#l00091">dt_device_param::ddp_extent_tax</a>, <a class="el" href="dt__object_8h_source.html#l00088">dt_device_param::ddp_max_extent_blks</a>, <a class="el" href="mdsrate_8c_source.html#l00132">end</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00120">ofd_device::ofd_dt_conf</a>, <a class="el" href="ofd__grant_8c_source.html#l00082">ofd_grant_inflate()</a>, <a class="el" href="ofd__internal_8h_source.html#l00435">ofd_grant_param_supp()</a>, <a class="el" href="lustre__idl_8h_source.html#l01791">niobuf_remote::rnb_len</a>, and <a class="el" href="lustre__idl_8h_source.html#l01790">niobuf_remote::rnb_offset</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00591">ofd_grant_check()</a>.</p>

</div>
</div>
<a class="anchor" id="a01e9a616f37fbe4dd804bd6d864cd6e8"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_sanity_check" ref="a01e9a616f37fbe4dd804bd6d864cd6e8" args="(struct obd_device *obd, const char *func)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ofd_grant_sanity_check </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__device.html">obd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>obd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>func</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Perform extra sanity checks for grant accounting. </p>
<p>This function scans the export list, sanity checks per-export grant counters and verifies accuracy of global grant accounting. If an inconsistency is found, a CERROR is printed with the function name  that was passed as argument. LBUG is only called in case of serious counter corruption (i.e. value larger than the device size). Those sanity checks can be pretty expensive and are disabled if the OBD device has more than 100 connected exports.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obd</em>&nbsp;</td><td>OBD device for which grant accounting should be verified </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>func</em>&nbsp;</td><td>caller's function name </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00147">147</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00266">CDEBUG_LIMIT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="libcfs__debug_8h_source.html#l00146">D_ERROR</a>, <a class="el" href="it__test_8c_source.html#l00055">error</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00195">obd_export::exp_obd_chain</a>, <a class="el" href="lustre__export_8h_source.html#l00111">filter_export_data::fed_dirty</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="lustre__export_8h_source.html#l00114">filter_export_data::fed_pending</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00644">obd_device::obd_dev_lock</a>, <a class="el" href="obd_8h_source.html#l00634">obd_device::obd_exports</a>, <a class="el" href="obd_8h_source.html#l00595">obd_device::obd_lu_dev</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00639">obd_device::obd_num_exports</a>, <a class="el" href="obd_8h_source.html#l00655">obd_device::obd_self_export</a>, <a class="el" href="obd_8h_source.html#l00635">obd_device::obd_unlinked_exports</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00197">ofd_dev()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00141">ofd_device::ofd_osfs</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, <a class="el" href="lustre__user_8h_source.html#l00109">obd_statfs::os_blocks</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__obd_8c_source.html#l00492">ofd_destroy_export()</a>, <a class="el" href="ofd__obd_8c_source.html#l00411">ofd_obd_disconnect()</a>, and <a class="el" href="ofd__obd_8c_source.html#l00806">ofd_statfs()</a>.</p>

</div>
</div>
<a class="anchor" id="aaca185d66890a2c81982ed371f6d74f4"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_shrink" ref="aaca185d66890a2c81982ed371f6d74f4" args="(struct obd_export *exp, struct obdo *oa, u64 left_space)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ofd_grant_shrink </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobdo.html">obdo</a> *&nbsp;</td>
          <td class="paramname"> <em>oa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">u64&nbsp;</td>
          <td class="paramname"> <em>left_space</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Grant shrink request handler. </p>
<p>Client nodes can explicitly release grant space (i.e. process called grant shrinking). This function proceeds with the shrink request when there is less ungranted space remaining than the amount all of the connected clients would consume if they used their full grant. Caller must hold ofd_grant_lock spinlock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export releasing grant space </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>oa</em>&nbsp;</td><td>incoming <a class="el" href="structobdo.html">obdo</a> sent by the client </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>left_space</em>&nbsp;</td><td>remaining free space with space already granted taken out </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00483">483</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__export_8h_source.html#l00112">filter_export_data::fed_grant</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lustre__idl_8h_source.html#l03391">obdo::o_grant</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__grant_8c_source.html#l00078">OFD_GRANT_SHRINK_LIMIT</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00165">ofd_device::ofd_tot_granted_clients</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="a1dd010bb25b487d84834c61581b78f67"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_space_left" ref="a1dd010bb25b487d84834c61581b78f67" args="(struct obd_export *exp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static u64 ofd_grant_space_left </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Figure out how much space is available on the backend filesystem after removing grant space already booked by clients. </p>
<p>This is done by accessing cached statfs data previously populated by <a class="el" href="ofd__grant_8c.html#aaeca1e9621bee8fc65b2609f8e0c4031" title="Update cached statfs information from the OSD layer.">ofd_grant_statfs()</a>, from which we withdraw the space already granted to clients and the reserved space. Caller must hold ofd_grant_lock spinlock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export associated with the device for which the amount of available space is requested </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>amount</em>&nbsp;</td><td>of non-allocated space, in bytes </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00330">330</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00266">CDEBUG_LIMIT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="libcfs__debug_8h_source.html#l00146">D_ERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00157">ofd_device::ofd_grant_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00141">ofd_device::ofd_osfs</a>, <a class="el" href="ofd__internal_8h_source.html#l00139">ofd_device::ofd_osfs_lock</a>, <a class="el" href="ofd__internal_8h_source.html#l00146">ofd_device::ofd_osfs_unstable</a>, <a class="el" href="ofd__internal_8h_source.html#l00159">ofd_device::ofd_tot_dirty</a>, <a class="el" href="ofd__internal_8h_source.html#l00161">ofd_device::ofd_tot_granted</a>, <a class="el" href="ofd__internal_8h_source.html#l00163">ofd_device::ofd_tot_pending</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l01172">ofd_grant_create()</a>, <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
<a class="anchor" id="aaeca1e9621bee8fc65b2609f8e0c4031"></a><!-- doxytag: member="ofd_grant.c::ofd_grant_statfs" ref="aaeca1e9621bee8fc65b2609f8e0c4031" args="(const struct lu_env *env, struct obd_export *exp, int force, int *from_cache)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ofd_grant_statfs </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>force</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>from_cache</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update cached statfs information from the OSD layer. </p>
<p>Refresh statfs information cached in ofd::ofd_osfs if the cache is older than 1s or if force is set. The OSD layer is in charge of estimating data &amp; metadata overhead. This function can sleep so it should not be called with any spinlock held.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment passed by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>exp</em>&nbsp;</td><td>export used to print client info in debug messages </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>force</em>&nbsp;</td><td>force a refresh of statfs information </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>from_cache</em>&nbsp;</td><td>returns whether the statfs information are taken from cache </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__grant_8c_source.html#l00290">290</a> of file <a class="el" href="ofd__grant_8c_source.html">ofd_grant.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="linux-time_8h_source.html#l00242">cfs_time_shift_64()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="lustre__export_8h_source.html#l00193">obd_export::exp_client_uuid</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="structofd__thread__info.html#a143cbb933e501df87c3b43b854852113">ofd_thread_info::fti_u</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00357">OBD_STATFS_CACHE_SECONDS</a>, <a class="el" href="ofd__internal_8h_source.html#l00143">ofd_device::ofd_blockbits</a>, <a class="el" href="ofd__internal_8h_source.html#l00207">ofd_exp()</a>, <a class="el" href="ofd__internal_8h_source.html#l00501">ofd_info()</a>, <a class="el" href="ofd__obd_8c_source.html#l00701">ofd_statfs_internal()</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="lustre__user_8h_source.html#l00110">obd_statfs::os_bfree</a>, <a class="el" href="ofd__internal_8h_source.html#l00310">ofd_thread_info::osfs</a>, <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>, and <a class="el" href="lustre__user_8h_source.html#l00492">obd_uuid::uuid</a>.</p>

<p>Referenced by <a class="el" href="ofd__grant_8c_source.html#l00868">ofd_grant_connect()</a>, <a class="el" href="ofd__grant_8c_source.html#l01172">ofd_grant_create()</a>, <a class="el" href="ofd__grant_8c_source.html#l00988">ofd_grant_prepare_read()</a>, and <a class="el" href="ofd__grant_8c_source.html#l01068">ofd_grant_prepare_write()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:49 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
