<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/osp/osp_precreate.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/osp/osp_precreate.c File Reference</h1><code>#include &lt;linux/kthread.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__obdo_8h_source.html">lustre_obdo.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="osp__internal_8h_source.html">osp_internal.h</a>&quot;</code><br/>

<p><a href="osp__precreate_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_MDS</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ae6e5ec6262ffc41387a3cde8215ad870">osp_statfs_need_update</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ad166cf2120d2d7ac6d60d45468feaf28">osp_precreate_running</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a980bc4ae5956396de89ad99313e5c65d">osp_precreate_stopped</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ace672efaf0086d9f5bb00bfdb693585b">osp_statfs_timer_cb</a> (unsigned long _d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a5f1abade71475e571be5364b93ef0321">osp_statfs_interpret</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, union <a class="el" href="unionptlrpc__async__args.html">ptlrpc_async_args</a> *aa, int rc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">RPC interpret callback for OST_STATFS RPC.  <a href="#a5f1abade71475e571be5364b93ef0321"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ad3654e532b5fa26c203761087ed06470">osp_statfs_update</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Send OST_STATFS RPC.  <a href="#ad3654e532b5fa26c203761087ed06470"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ae60d06a7a5c2c36f3248f4394e7fd7d1">osp_statfs_need_now</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Schedule an immediate update for statfs data.  <a href="#ae60d06a7a5c2c36f3248f4394e7fd7d1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a54fc87ece7b0fb4fba5075b1f3ecc362">osp_objs_precreated</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *osp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Return number of precreated objects.  <a href="#a54fc87ece7b0fb4fba5075b1f3ecc362"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#acfb7ba67d938b4fba54b72198532ae2d">osp_precreate_near_empty_nolock</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check pool of precreated objects is nearly empty.  <a href="#acfb7ba67d938b4fba54b72198532ae2d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ad1dc3f8eac30e68d71dc5efad49f61f7">osp_precreate_near_empty</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check pool of precreated objects.  <a href="#ad1dc3f8eac30e68d71dc5efad49f61f7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#afca04fb7738eb7d0653b6c4fc154df50">osp_create_end_seq</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *osp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check given sequence is empty.  <a href="#afca04fb7738eb7d0653b6c4fc154df50"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a90b9288ca2540bfbf52700423ed6193a">osp_write_last_oid_seq_files</a> (struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *osp, struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid, int sync)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Write FID into into last_oid/last_seq file.  <a href="#a90b9288ca2540bfbf52700423ed6193a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ad1b7996234907b754dece35a431f5c58">osp_precreate_rollover_new_seq</a> (struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *osp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Switch to another sequence.  <a href="#ad1b7996234907b754dece35a431f5c58"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ab4a563fd2211ea086091c9c282167503">osp_precreate_fids</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *osp, struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid, int *grow)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find IDs available in current sequence.  <a href="#ab4a563fd2211ea086091c9c282167503"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ade2e8e1767b6cf0527c4731cf5eb3637">osp_precreate_send</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepare and send precreate RPC.  <a href="#ade2e8e1767b6cf0527c4731cf5eb3637"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a6e67e609d1095cdd8f8c92730088a63c">osp_get_lastfid_from_ost</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get last precreated object from target (OST).  <a href="#a6e67e609d1095cdd8f8c92730088a63c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a9d1382691ea4e06f98faf5412c8a30ec">osp_precreate_cleanup_orphans</a> (struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cleanup orphans on OST.  <a href="#a9d1382691ea4e06f98faf5412c8a30ec"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ad08581208c0888d2bfb28babb414be1c">osp_pre_update_status</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, int rc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update precreate status using statfs data.  <a href="#ad08581208c0888d2bfb28babb414be1c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a14bf441f342654b878660cf2573f08f9">osp_init_pre_fid</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *osp)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize FID for precreation.  <a href="#a14bf441f342654b878660cf2573f08f9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a0e149e685b3df2c0d273b10a37f4562c">osp_precreate_thread</a> (void *_arg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The core of precreate functionality.  <a href="#a0e149e685b3df2c0d273b10a37f4562c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a2acd8664bc531725ee0e83d7aed5eefa">osp_precreate_ready_condition</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check when to stop to wait for precreate objects.  <a href="#a2acd8664bc531725ee0e83d7aed5eefa"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#ab6452b9fbe2dd31044ce652348b7c7cc">osp_precreate_timeout_condition</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a39a28e9de51d9e97ee937560ddbf0283">osp_precreate_reserve</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reserve object in precreate pool.  <a href="#a39a28e9de51d9e97ee937560ddbf0283"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#afcddb5166989024d615815d6394ee83b">osp_precreate_get_fid</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get a FID from precreation pool.  <a href="#afcddb5166989024d615815d6394ee83b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a4de7196d26558e3a8a6d195d801bbabf">osp_object_truncate</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structdt__object.html">dt_object</a> *dt, <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="el" href="parallel__grouplock_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a09b997ecfc36135a541eb336e22230a5">osp_init_precreate</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize precreation functionality of OSP.  <a href="#a09b997ecfc36135a541eb336e22230a5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__precreate_8c.html#a6b0bb6ab17743e9127d9a917ba9eac08">osp_precreate_fini</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Finish precreate functionality of OSP.  <a href="#a6b0bb6ab17743e9127d9a917ba9eac08"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="osp_precreate.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_MDS</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00045">45</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="afca04fb7738eb7d0653b6c4fc154df50"></a><!-- doxytag: member="osp_precreate.c::osp_create_end_seq" ref="afca04fb7738eb7d0653b6c4fc154df50" args="(const struct lu_env *env, struct osp_device *osp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_create_end_seq </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check given sequence is empty. </p>
<p>Returns a binary result whether the given sequence has some IDs left or not. Find the details in <a class="el" href="osp__internal_8h.html#a5a2f5d28a0fea14cb31c4bbb9fa0a9bb">osp_fid_end_seq()</a>. This is a lock protected version of that function.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- current sequence has no IDs, 1 - otherwise </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00322">322</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00553">osp_fid_end_seq()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a6e67e609d1095cdd8f8c92730088a63c"></a><!-- doxytag: member="osp_precreate.c::osp_get_lastfid_from_ost" ref="a6e67e609d1095cdd8f8c92730088a63c" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_get_lastfid_from_ost </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get last precreated object from target (OST). </p>
<p>Sends synchronous RPC to the target (OST) to learn the last precreated object. This later is used to remove all unused objects (cleanup orphan procedure). Also, the next object after one we got will be used as a starting point for the new precreates.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00680">680</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00765">fid_cpu_to_le()</a>, <a class="el" href="lustre__idl_8h_source.html#l00793">fid_is_sane()</a>, <a class="el" href="lustre__idl_8h_source.html#l00249">fid_oid()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="obd_8h_source.html#l00750">KEY_LAST_FID</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00155">osp_device::opd_last_used_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="packet-lustre_8c_source.html#l00170">OST_GET_INFO</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="recover_8c_source.html#l00290">ptlrpc_set_import_active()</a>, <a class="el" href="lustre__req__layout_8h_source.html#l00058">RCL_CLIENT</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l02158">req_capsule_server_get()</a>, <a class="el" href="layout_8c_source.html#l02226">req_capsule_set_size()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01136">RMF_FID</a>, <a class="el" href="layout_8c_source.html#l00903">RMF_GETINFO_KEY</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_delay</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_resend</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, <a class="el" href="layout_8c_source.html#l01665">RQF_OST_GET_INFO_LAST_FID</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l00768">osp_precreate_cleanup_orphans()</a>.</p>

</div>
</div>
<a class="anchor" id="a14bf441f342654b878660cf2573f08f9"></a><!-- doxytag: member="osp_precreate.c::osp_init_pre_fid" ref="a14bf441f342654b878660cf2573f08f9" args="(struct osp_device *osp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_init_pre_fid </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize FID for precreation. </p>
<p>For a just created new target, a new sequence should be taken. The function checks there is no IDIF in use (if the target was added with the older version of Lustre), then requests a new sequence from FLDB using the regular protocol. Then this new sequence is stored on a persisten storage synchronously to prevent possible object leakage (for the detail see the description for <a class="el" href="osp__precreate_8c.html#ad1b7996234907b754dece35a431f5c58" title="Switch to another sequence.">osp_precreate_rollover_new_seq()</a>).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01008">1008</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00322">client_obd::cl_seq</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="dt__object_8h_source.html#l01723">dt_device::dd_lu_dev</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00147">lu_fid::f_oid</a>, <a class="el" href="lustre__user_8h_source.html#l00145">lu_fid::f_seq</a>, <a class="el" href="lustre__user_8h_source.html#l00153">lu_fid::f_ver</a>, <a class="el" href="lustre__idl_8h_source.html#l00508">fid_idif_seq()</a>, <a class="el" href="lustre__user_8h_source.html#l00156">fid_is_zero()</a>, <a class="el" href="lustre__idl_8h_source.html#l00260">fid_zero()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l00275">lu_device::ld_type</a>, <a class="el" href="lu__object_8h_source.html#l00336">lu_device_type::ldt_ctx_tags</a>, <a class="el" href="lu__object_8c_source.html#l01881">lu_env_fini()</a>, <a class="el" href="lu__object_8c_source.html#l01869">lu_env_init()</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00139">osp_device::opd_dt_dev</a>, <a class="el" href="osp__internal_8h_source.html#l00145">osp_device::opd_group</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00155">osp_device::opd_last_used_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00312">osp_thread_info::osi_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__internal_8h_source.html#l00585">osp_is_fid_client()</a>, <a class="el" href="osp__precreate_8c_source.html#l00349">osp_write_last_oid_seq_files()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="fid__request_8c_source.html#l00271">seq_client_get_seq()</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a09b997ecfc36135a541eb336e22230a5"></a><!-- doxytag: member="osp_precreate.c::osp_init_precreate" ref="a09b997ecfc36135a541eb336e22230a5" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_init_precreate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize precreation functionality of OSP. </p>
<p>Prepares all the internal structures and starts the precreate thread</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01531">1531</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="linux-time_8h_source.html#l00152">cfs_time_current()</a>, <a class="el" href="libcfs__time_8h_source.html#l00067">cfs_time_shift()</a>, <a class="el" href="linux-prim_8c_source.html#l00055">cfs_timer_init()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00260">fid_zero()</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_got_disconnected</a>, <a class="el" href="osp__internal_8h_source.html#l00145">osp_device::opd_group</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00181">osp_device::opd_pre_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00234">osp_device::opd_statfs_fresh_till</a>, <a class="el" href="osp__internal_8h_source.html#l00238">osp_device::opd_statfs_maxage</a>, <a class="el" href="osp__internal_8h_source.html#l00235">osp_device::opd_statfs_timer</a>, <a class="el" href="osp__precreate_8c_source.html#l00086">osp_precreate_running()</a>, <a class="el" href="osp__precreate_8c_source.html#l00091">osp_precreate_stopped()</a>, <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>, <a class="el" href="osp__precreate_8c_source.html#l00096">osp_statfs_timer_cb()</a>, <a class="el" href="lustre__idl_8h_source.html#l01770">OST_MAX_PRECREATE</a>, <a class="el" href="lustre__idl_8h_source.html#l01769">OST_MIN_PRECREATE</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l00996">osp_init0()</a>.</p>

</div>
</div>
<a class="anchor" id="a4de7196d26558e3a8a6d195d801bbabf"></a><!-- doxytag: member="osp_precreate.c::osp_object_truncate" ref="a4de7196d26558e3a8a6d195d801bbabf" args="(const struct lu_env *env, struct dt_object *dt, __u64 size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_object_truncate </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01454">1454</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__import_8h_source.html#l00316">obd_import::imp_connect_data</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="osp__internal_8h_source.html#l00443">lu2osp_dev()</a>, <a class="el" href="lu__object_8h_source.html#l00770">lu_object_fid()</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="lustre__obdo_8h_source.html#l00048">lustre_set_wire_obdo()</a>, <a class="el" href="lustre__idl_8h_source.html#l03390">obdo::o_blocks</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03386">obdo::o_size</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="lustre__idl_8h_source.html#l01661">OBD_MD_FLBLOCKS</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="lustre__idl_8h_source.html#l01656">OBD_MD_FLID</a>, <a class="el" href="lustre__idl_8h_source.html#l01660">OBD_MD_FLSIZE</a>, <a class="el" href="lustre__idl_8h_source.html#l01767">OBD_OBJECT_EOF</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="lustre__idl_8h_source.html#l00096">OST_IO_PORTAL</a>, <a class="el" href="packet-lustre_8c_source.html#l00173">OST_PUNCH</a>, <a class="el" href="client_8c_source.html#l00293">ptlrpc_at_set_req_timeout()</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l01104">ptlrpc_request::rq_import</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_delay</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_resend</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, <a class="el" href="layout_8c_source.html#l01626">RQF_OST_PUNCH</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__object_8c_source.html#l00638">osp_declare_attr_set()</a>.</p>

</div>
</div>
<a class="anchor" id="a54fc87ece7b0fb4fba5075b1f3ecc362"></a><!-- doxytag: member="osp_precreate.c::osp_objs_precreated" ref="a54fc87ece7b0fb4fba5075b1f3ecc362" args="(const struct lu_env *env, struct osp_device *osp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_objs_precreated </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return number of precreated objects. </p>
<p>A simple helper to calculate the number of precreated objects on the device.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>the</em>&nbsp;</td><td>number of the precreated objects </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00255">255</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00509">osp_fid_diff()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l00276">osp_precreate_near_empty_nolock()</a>, <a class="el" href="osp__precreate_8c_source.html#l01222">osp_precreate_ready_condition()</a>, and <a class="el" href="osp__precreate_8c_source.html#l01292">osp_precreate_reserve()</a>.</p>

</div>
</div>
<a class="anchor" id="ad08581208c0888d2bfb28babb414be1c"></a><!-- doxytag: member="osp_precreate.c::osp_pre_update_status" ref="ad08581208c0888d2bfb28babb414be1c" args="(struct osp_device *d, int rc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void osp_pre_update_status </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update precreate status using statfs data. </p>
<p>The function decides whether this OSP should be used for new objects. IOW, whether this OST is used up or has some free space. Cached statfs data is used to make this decision. If the latest result of statfs request (rc argument) is not success, then just mark OSP unavailable right away.</p>
<p>Add a bit of hysteresis so this flag isn't continually flapping, and ensure that new files don't get extremely fragmented due to only a small amount of available space in the filesystem. We want to set the NOSPC flag when there is less than ~0.1% free and clear it when there is at least ~0.2% free space, so: avail &lt; ~0.1% max max = avail + used 1025 * avail &lt; avail + used used = blocks - free 1024 * avail &lt; used 1024 * avail &lt; blocks - free avail &lt; ((blocks - free) &gt;&gt; 10)</p>
<p>On very large disk, say 16TB 0.1% will be 16 GB. We don't want to lose that amount of space so in those cases we report no space left if their is less than 1 GB left. the function updates current precreation status used: functional or not</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rc</em>&nbsp;</td><td>new precreate status for device <em>d</em> </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00948">948</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00135">D_INFO</a>, <a class="el" href="libcfs__private_8h_source.html#l00309">likely</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="osc__internal_8h_source.html#l00177">min_t</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00233">osp_device::opd_statfs</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="lustre__user_8h_source.html#l00110">obd_statfs::os_bfree</a>, <a class="el" href="lustre__user_8h_source.html#l00109">obd_statfs::os_blocks</a>, <a class="el" href="lustre__user_8h_source.html#l00113">obd_statfs::os_ffree</a>, <a class="el" href="lustre__user_8h_source.html#l00108">obd_statfs::os_type</a>, and <a class="el" href="lustre__idl_8h_source.html#l01769">OST_MIN_PRECREATE</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l01574">osp_import_event()</a>, <a class="el" href="osp__precreate_8c_source.html#l00768">osp_precreate_cleanup_orphans()</a>, <a class="el" href="osp__precreate_8c_source.html#l00543">osp_precreate_send()</a>, and <a class="el" href="osp__precreate_8c_source.html#l00121">osp_statfs_interpret()</a>.</p>

</div>
</div>
<a class="anchor" id="a9d1382691ea4e06f98faf5412c8a30ec"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_cleanup_orphans" ref="a9d1382691ea4e06f98faf5412c8a30ec" args="(struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_cleanup_orphans </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cleanup orphans on OST. </p>
<p>This function is called in a contex of a dedicated thread handling all the precreation suff. The function waits till local recovery is complete, then identify all the unreferenced objects (orphans) using the highest ID referenced by a local and the highest object precreated by the target. The found range is a subject to removal using specially flagged RPC. During this process OSP is marked unavailable for new objects.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00768">768</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00156">fid_is_zero()</a>, <a class="el" href="lustre__idl_8h_source.html#l00249">fid_oid()</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__fid_8h_source.html#l00182">LUSTRE_DATA_SEQ_MAX_WIDTH</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="lustre__idl_8h_source.html#l03398">obdo::o_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="lustre__idl_8h_source.html#l01427">OBD_FL_DELORPHAN</a>, <a class="el" href="lustre__idl_8h_source.html#l01667">OBD_MD_FLFLAGS</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_got_disconnected</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00155">osp_device::opd_last_used_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00176">osp_device::opd_recovery_completed</a>, <a class="el" href="osp__internal_8h_source.html#l00312">osp_thread_info::osi_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__internal_8h_source.html#l00509">osp_fid_diff()</a>, <a class="el" href="osp__precreate_8c_source.html#l00680">osp_get_lastfid_from_ost()</a>, <a class="el" href="osp__precreate_8c_source.html#l00948">osp_pre_update_status()</a>, <a class="el" href="osp__precreate_8c_source.html#l00086">osp_precreate_running()</a>, <a class="el" href="packet-lustre_8c_source.html#l00168">OST_CREATE</a>, <a class="el" href="lustre__idl_8h_source.html#l01769">OST_MIN_PRECREATE</a>, <a class="el" href="lustre__idl_8h_source.html#l00659">ostid_to_fid()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l02158">req_capsule_server_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_delay</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_resend</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, <a class="el" href="layout_8c_source.html#l01622">RQF_OST_CREATE</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="ab4a563fd2211ea086091c9c282167503"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_fids" ref="ab4a563fd2211ea086091c9c282167503" args="(const struct lu_env *env, struct osp_device *osp, struct lu_fid *fid, int *grow)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_fids </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>grow</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find IDs available in current sequence. </p>
<p>The function calculates the highest possible ID and the number of IDs available in the current sequence OSP is using. The number is limited artifically by the caller (grow param) and the number of IDs available in the sequence by nature. The function doesn't require an external locking.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>FID the caller wants to start with </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>grow</em>&nbsp;</td><td>how many the caller wants </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>the highest calculated FID </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>grow</em>&nbsp;</td><td>the number of available IDs calculated</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success, 1 - the sequence is empty </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00488">488</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00135">D_INFO</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="mdsrate_8c_source.html#l00132">end</a>, <a class="el" href="lustre__user_8h_source.html#l00147">lu_fid::f_oid</a>, <a class="el" href="lustre__idl_8h_source.html#l00462">fid_is_idif()</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="lustre__idl_8h_source.html#l00320">IDIF_MAX_OID</a>, <a class="el" href="lustre__fid_8h_source.html#l00182">LUSTRE_DATA_SEQ_MAX_WIDTH</a>, <a class="el" href="structost__id.html#a01d44bff8859d8cd3aabe8a4b0c2ee46">ost_id::oi</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00314">osp_thread_info::osi_oi</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="lustre__idl_8h_source.html#l00546">ostid_id()</a>, <a class="el" href="lustre__idl_8h_source.html#l00594">ostid_set_id()</a>, <a class="el" href="lustre__idl_8h_source.html#l00659">ostid_to_fid()</a>, and <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l00543">osp_precreate_send()</a>.</p>

</div>
</div>
<a class="anchor" id="a6b0bb6ab17743e9127d9a917ba9eac08"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_fini" ref="a6b0bb6ab17743e9127d9a917ba9eac08" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void osp_precreate_fini </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Finish precreate functionality of OSP. </p>
<p>Asks all the activity (the thread, update timer) to stop, then wait till that is done.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01596">1596</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="linux-prim_8c_source.html#l00069">cfs_timer_disarm()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00181">osp_device::opd_pre_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00235">osp_device::opd_statfs_timer</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, <a class="el" href="lustre__net_8h_source.html#l01495">SVC_STOPPING</a>, <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>, <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>, and <a class="el" href="obd_8c_source.html#l00114">thread</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l00996">osp_init0()</a>, and <a class="el" href="osp__dev_8c_source.html#l00587">osp_shutdown()</a>.</p>

</div>
</div>
<a class="anchor" id="afcddb5166989024d615815d6394ee83b"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_get_fid" ref="afcddb5166989024d615815d6394ee83b" args="(const struct lu_env *env, struct osp_device *d, struct lu_fid *fid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_precreate_get_fid </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get a FID from precreation pool. </p>
<p>The function is a companion for <a class="el" href="osp__internal_8h.html#a39a28e9de51d9e97ee937560ddbf0283" title="Reserve object in precreate pool.">osp_precreate_reserve()</a> - it assigns a specific FID from the precreate. The function should be called only if the call to <a class="el" href="osp__internal_8h.html#a39a28e9de51d9e97ee937560ddbf0283" title="Reserve object in precreate pool.">osp_precreate_reserve()</a> was successful. The function updates a local storage to remember the highest object ID referenced by the node in the given sequence.</p>
<p>A very importan details: this is supposed to be called once the transaction is started, so on-disk update will be atomic with the data (like LOVEA) refering this object. Then the object won't be leaked: either it's referenced by the committed transaction or it's a subject to the orphan cleanup procedure.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>generated FID</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01405">1405</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00509">osp_fid_diff()</a>, <a class="el" href="osp__internal_8h_source.html#l00534">osp_update_last_fid()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__object_8c_source.html#l00152">osp_object_assign_fid()</a>.</p>

</div>
</div>
<a class="anchor" id="ad1dc3f8eac30e68d71dc5efad49f61f7"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_near_empty" ref="ad1dc3f8eac30e68d71dc5efad49f61f7" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_near_empty </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check pool of precreated objects. </p>
<p>This is protected version of <a class="el" href="osp__precreate_8c.html#acfb7ba67d938b4fba54b72198532ae2d" title="Check pool of precreated objects is nearly empty.">osp_precreate_near_empty_nolock()</a>, check that for the details.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- current pool is good enough, 1 - time to precreate </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00298">298</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__precreate_8c_source.html#l00276">osp_precreate_near_empty_nolock()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="acfb7ba67d938b4fba54b72198532ae2d"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_near_empty_nolock" ref="acfb7ba67d938b4fba54b72198532ae2d" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_near_empty_nolock </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check pool of precreated objects is nearly empty. </p>
<p>We should not wait till the pool of the precreated objects is exhausted, because then there will be a long period of OSP being unavailable for the new creations due to lenghty precreate RPC. Instead we ask for another precreation ahead and hopefully have it ready before the current pool is empty. Notice this function relies on an external locking.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- current pool is good enough, 1 - time to precreate </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00276">276</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__precreate_8c_source.html#l00255">osp_objs_precreated()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l00298">osp_precreate_near_empty()</a>, and <a class="el" href="osp__precreate_8c_source.html#l01292">osp_precreate_reserve()</a>.</p>

</div>
</div>
<a class="anchor" id="a2acd8664bc531725ee0e83d7aed5eefa"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_ready_condition" ref="a2acd8664bc531725ee0e83d7aed5eefa" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_ready_condition </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check when to stop to wait for precreate objects. </p>
<p>The caller wanting a new OST object can't wait undefinitely. The function checks for few conditions including available new OST objects, disconnected OST, lack of space with no pending destroys, etc. IOW, it checks whether the current OSP state is good to keep waiting or it's better to give up.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- keep waiting, 1 - no luck </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01222">1222</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, and <a class="el" href="osp__precreate_8c_source.html#l00255">osp_objs_precreated()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01292">osp_precreate_reserve()</a>.</p>

</div>
</div>
<a class="anchor" id="a39a28e9de51d9e97ee937560ddbf0283"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_reserve" ref="a39a28e9de51d9e97ee937560ddbf0283" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_precreate_reserve </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reserve object in precreate pool. </p>
<p>When the caller wants to create a new object on this target (target represented by the given OSP), it should declare this intention using a regular -&gt;<a class="el" href="dt__object_8h.html#a42848e00d321307e71d0243b2bbd3a1c">dt_declare_create()</a> OSD API method. Then OSP will be trying to reserve an object in the existing precreated pool or wait up to obd_timeout for the available object to appear in the pool (a dedicated thread will be doing real precreation in background). The object can be consumed later with <a class="el" href="osp__internal_8h.html#afcddb5166989024d615815d6394ee83b" title="Get a FID from precreation pool.">osp_precreate_get_fid()</a> or be released with call to <a class="el" href="group__lu.html#ga0d53e3777af7b81492a1178c75b872ea" title="Decrease reference counter on object.">lu_object_put()</a>. Notice the function doesn't reserve a specific ID, just some ID. The actual ID assignment happen in <a class="el" href="osp__internal_8h.html#afcddb5166989024d615815d6394ee83b" title="Get a FID from precreation pool.">osp_precreate_get_fid()</a>. If the space on the target is short and there is a pending object destroy, then the function forces local commit to speedup space release (see <a class="el" href="osp__sync_8c.html">osp_sync.c</a> for the details).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOSPC</em>&nbsp;</td><td>when no space on OST </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EAGAIN</em>&nbsp;</td><td>try later, slow precreation in progress </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EIO</em>&nbsp;</td><td>when no access to OST </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01292">1292</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__time_8h_source.html#l00061">cfs_time_aftereq()</a>, <a class="el" href="linux-time_8h_source.html#l00152">cfs_time_current()</a>, <a class="el" href="libcfs__time_8h_source.html#l00067">cfs_time_shift()</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l02645">dt_commit_async()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="lustre__lib_8h_source.html#l00171">LWI_TIMEOUT</a>, <a class="el" href="class__obd_8c_source.html#l00083">obd_timeout</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__precreate_8c_source.html#l00255">osp_objs_precreated()</a>, <a class="el" href="osp__internal_8h_source.html#l00566">osp_precreate_end_seq_nolock()</a>, <a class="el" href="osp__precreate_8c_source.html#l00276">osp_precreate_near_empty_nolock()</a>, <a class="el" href="osp__precreate_8c_source.html#l01222">osp_precreate_ready_condition()</a>, <a class="el" href="osp__precreate_8c_source.html#l01253">osp_precreate_timeout_condition()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__object_8c_source.html#l01309">osp_declare_object_create()</a>.</p>

</div>
</div>
<a class="anchor" id="ad1b7996234907b754dece35a431f5c58"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_rollover_new_seq" ref="ad1b7996234907b754dece35a431f5c58" args="(struct lu_env *env, struct osp_device *osp)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_rollover_new_seq </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Switch to another sequence. </p>
<p>When a current sequence has no available IDs left, OSP has to switch to another new sequence. OSP requests it using the regular FLDB protocol and stores synchronously before that is used in precreated. This is needed to basically have the sequences referenced (not orphaned), otherwise it's possible that OST has some objects precreated and the clients have data written to it, but after MDT failover nobody refers those objects and OSP has no idea that the sequence need cleanup to be done. While this is very expensive operation, it's supposed to happen very very infrequently because sequence has 2^32 or 2^48 objects (depending on type)</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00428">428</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00322">client_obd::cl_seq</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00147">lu_fid::f_oid</a>, <a class="el" href="lustre__user_8h_source.html#l00145">lu_fid::f_seq</a>, <a class="el" href="lustre__user_8h_source.html#l00153">lu_fid::f_ver</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="libcfs__debug_8h_source.html#l00283">LCONSOLE_INFO</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00047">LPX64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00156">osp_device::opd_gap_start_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00155">osp_device::opd_last_used_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00312">osp_thread_info::osi_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__precreate_8c_source.html#l00349">osp_write_last_oid_seq_files()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="fid__request_8c_source.html#l00271">seq_client_get_seq()</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="ad166cf2120d2d7ac6d60d45468feaf28"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_running" ref="ad166cf2120d2d7ac6d60d45468feaf28" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool osp_precreate_running </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00086">86</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00181">osp_device::opd_pre_thread</a>, <a class="el" href="lustre__net_8h_source.html#l01497">SVC_RUNNING</a>, and <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01531">osp_init_precreate()</a>, <a class="el" href="osp__precreate_8c_source.html#l00768">osp_precreate_cleanup_orphans()</a>, <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>, <a class="el" href="osp__precreate_8c_source.html#l00121">osp_statfs_interpret()</a>, and <a class="el" href="osp__precreate_8c_source.html#l00096">osp_statfs_timer_cb()</a>.</p>

</div>
</div>
<a class="anchor" id="ade2e8e1767b6cf0527c4731cf5eb3637"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_send" ref="ade2e8e1767b6cf0527c4731cf5eb3637" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_send </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prepare and send precreate RPC. </p>
<p>The function finds how many objects should be precreated. Then allocates, prepares and schedules precreate RPC synchronously. Upon reply the function wake ups the threads waiting for the new objects on this target. If the target wasn't able to create all the objects requested, then the next precreate will be asking less objects (i.e. slow precreate down).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00543">543</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="libcfs__debug_8h_source.html#l00135">D_INFO</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00145">lu_fid::f_seq</a>, <a class="el" href="lustre__idl_8h_source.html#l00462">fid_is_idif()</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="lnet_2utils_2debug_8c_source.html#l00068">max</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00312">osp_thread_info::osi_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__internal_8h_source.html#l00509">osp_fid_diff()</a>, <a class="el" href="osp__internal_8h_source.html#l00585">osp_is_fid_client()</a>, <a class="el" href="osp__precreate_8c_source.html#l00948">osp_pre_update_status()</a>, <a class="el" href="osp__precreate_8c_source.html#l00488">osp_precreate_fids()</a>, <a class="el" href="packet-lustre_8c_source.html#l00168">OST_CREATE</a>, <a class="el" href="lustre__idl_8h_source.html#l00097">OST_CREATE_PORTAL</a>, <a class="el" href="lustre__idl_8h_source.html#l01769">OST_MIN_PRECREATE</a>, <a class="el" href="lustre__idl_8h_source.html#l00659">ostid_to_fid()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l02158">req_capsule_server_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_delay</a>, <a class="el" href="lustre__net_8h_source.html#l00968">ptlrpc_request::rq_no_resend</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, <a class="el" href="lustre__net_8h_source.html#l01034">ptlrpc_request::rq_transno</a>, <a class="el" href="layout_8c_source.html#l01622">RQF_OST_CREATE</a>, <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a980bc4ae5956396de89ad99313e5c65d"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_stopped" ref="a980bc4ae5956396de89ad99313e5c65d" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool osp_precreate_stopped </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00091">91</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00181">osp_device::opd_pre_thread</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, and <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01531">osp_init_precreate()</a>.</p>

</div>
</div>
<a class="anchor" id="a0e149e685b3df2c0d273b10a37f4562c"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_thread" ref="a0e149e685b3df2c0d273b10a37f4562c" args="(void *_arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>_arg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The core of precreate functionality. </p>
<p>The function implements the main precreation loop. Basically it involves connecting to the target, precerate FID initialization, identifying and removing orphans, then serving precreation. As part of the latter, the thread is responsible for statfs data updates. The precreation is mostly driven by another threads asking for new OST objects - those askers wake the thread when the number of precreated objects reach low watermark. After a disconnect, the sequence above repeats. This is keep going until the thread is requested to stop.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>_arg</em>&nbsp;</td><td>private data the thread (OSP device to handle)</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01082">1082</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00322">client_obd::cl_seq</a>, <a class="el" href="genops_8c_source.html#l00812">class_export_put()</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="dt__object_8h_source.html#l01723">dt_device::dd_lu_dev</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00283">LCONSOLE_INFO</a>, <a class="el" href="lustre__fid_8h_source.html#l00353">lu_client_seq::lcs_exp</a>, <a class="el" href="lu__object_8h_source.html#l00275">lu_device::ld_type</a>, <a class="el" href="lu__object_8h_source.html#l00336">lu_device_type::ldt_ctx_tags</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00047">LPX64</a>, <a class="el" href="lu__object_8c_source.html#l01881">lu_env_fini()</a>, <a class="el" href="lu__object_8c_source.html#l01869">lu_env_init()</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00139">osp_device::opd_dt_dev</a>, <a class="el" href="osp__internal_8h_source.html#l00160">osp_device::opd_exp</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_got_disconnected</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_new_connection</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00181">osp_device::opd_pre_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__precreate_8c_source.html#l00322">osp_create_end_seq()</a>, <a class="el" href="osp__precreate_8c_source.html#l01008">osp_init_pre_fid()</a>, <a class="el" href="osp__precreate_8c_source.html#l00768">osp_precreate_cleanup_orphans()</a>, <a class="el" href="osp__internal_8h_source.html#l00574">osp_precreate_end_seq()</a>, <a class="el" href="osp__precreate_8c_source.html#l00298">osp_precreate_near_empty()</a>, <a class="el" href="osp__precreate_8c_source.html#l00428">osp_precreate_rollover_new_seq()</a>, <a class="el" href="osp__precreate_8c_source.html#l00086">osp_precreate_running()</a>, <a class="el" href="osp__precreate_8c_source.html#l00543">osp_precreate_send()</a>, <a class="el" href="osp__precreate_8c_source.html#l00074">osp_statfs_need_update()</a>, <a class="el" href="osp__precreate_8c_source.html#l00175">osp_statfs_update()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="lustre__net_8h_source.html#l01497">SVC_RUNNING</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>, <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>, <a class="el" href="obd_8c_source.html#l00114">thread</a>, <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01531">osp_init_precreate()</a>.</p>

</div>
</div>
<a class="anchor" id="ab6452b9fbe2dd31044ce652348b7c7cc"></a><!-- doxytag: member="osp_precreate.c::osp_precreate_timeout_condition" ref="ab6452b9fbe2dd31044ce652348b7c7cc" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_precreate_timeout_condition </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l01253">1253</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, and <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01292">osp_precreate_reserve()</a>.</p>

</div>
</div>
<a class="anchor" id="a5f1abade71475e571be5364b93ef0321"></a><!-- doxytag: member="osp_precreate.c::osp_statfs_interpret" ref="a5f1abade71475e571be5364b93ef0321" args="(const struct lu_env *env, struct ptlrpc_request *req, union ptlrpc_async_args *aa, int rc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_statfs_interpret </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">union <a class="el" href="unionptlrpc__async__args.html">ptlrpc_async_args</a> *&nbsp;</td>
          <td class="paramname"> <em>aa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>RPC interpret callback for OST_STATFS RPC. </p>
<p>An interpretation callback called by ptlrpc for OST_STATFS RPC when it is replied by the target. It's used to maintain statfs cache for the target. The function fills data from the reply if successful and schedules another update.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>req</em>&nbsp;</td><td>RPC replied </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>aa</em>&nbsp;</td><td>callback data </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rc</em>&nbsp;</td><td>RPC result</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00121">121</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__time_8h_source.html#l00067">cfs_time_shift()</a>, <a class="el" href="linux-prim_8c_source.html#l00063">cfs_timer_arm()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__import_8h_source.html#l00237">obd_import::imp_generation</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00233">osp_device::opd_statfs</a>, <a class="el" href="osp__internal_8h_source.html#l00234">osp_device::opd_statfs_fresh_till</a>, <a class="el" href="osp__internal_8h_source.html#l00238">osp_device::opd_statfs_maxage</a>, <a class="el" href="osp__internal_8h_source.html#l00235">osp_device::opd_statfs_timer</a>, <a class="el" href="osp__internal_8h_source.html#l00236">osp_device::opd_statfs_update_in_progress</a>, <a class="el" href="osp__precreate_8c_source.html#l00948">osp_pre_update_status()</a>, <a class="el" href="osp__precreate_8c_source.html#l00086">osp_precreate_running()</a>, <a class="el" href="lustre__net_8h_source.html#l00553">ptlrpc_async_args::pointer_arg</a>, <a class="el" href="lustre__net_8h_source.html#l00505">ptlrpc_req_async_args</a>, <a class="el" href="layout_8c_source.html#l02158">req_capsule_server_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l00969">RMF_OBD_STATFS</a>, <a class="el" href="lustre__net_8h_source.html#l01104">ptlrpc_request::rq_import</a>, and <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l00175">osp_statfs_update()</a>.</p>

</div>
</div>
<a class="anchor" id="ae60d06a7a5c2c36f3248f4394e7fd7d1"></a><!-- doxytag: member="osp_precreate.c::osp_statfs_need_now" ref="ae60d06a7a5c2c36f3248f4394e7fd7d1" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void osp_statfs_need_now </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Schedule an immediate update for statfs data. </p>
<p>If cached statfs data claim no free space, but OSP has got a request to destroy an object (so release some space probably), then we may need to refresh cached statfs data sooner than planned. The function checks there is no statfs update going and schedules immediate update if so. XXX: there might be a case where removed object(s) do not add free space (empty object). If the number of such deletions is high, then we can start to update statfs too often causing a RPC storm. some throttling is needed...</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device where statfs data needs to be refreshed </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00231">231</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__time_8h_source.html#l00067">cfs_time_shift()</a>, <a class="el" href="linux-prim_8c_source.html#l00069">cfs_timer_disarm()</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00234">osp_device::opd_statfs_fresh_till</a>, <a class="el" href="osp__internal_8h_source.html#l00235">osp_device::opd_statfs_timer</a>, and <a class="el" href="osp__internal_8h_source.html#l00236">osp_device::opd_statfs_update_in_progress</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00515">osp_sync_interpret()</a>, and <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>.</p>

</div>
</div>
<a class="anchor" id="ae6e5ec6262ffc41387a3cde8215ad870"></a><!-- doxytag: member="osp_precreate.c::osp_statfs_need_update" ref="ae6e5ec6262ffc41387a3cde8215ad870" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_statfs_need_update </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00074">74</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="linux-time_8h_source.html#l00142">cfs_time_before()</a>, <a class="el" href="linux-time_8h_source.html#l00152">cfs_time_current()</a>, and <a class="el" href="osp__internal_8h_source.html#l00234">osp_device::opd_statfs_fresh_till</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="ace672efaf0086d9f5bb00bfdb693585b"></a><!-- doxytag: member="osp_precreate.c::osp_statfs_timer_cb" ref="ace672efaf0086d9f5bb00bfdb693585b" args="(unsigned long _d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_statfs_timer_cb </td>
          <td>(</td>
          <td class="paramtype">unsigned long&nbsp;</td>
          <td class="paramname"> <em>_d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00096">96</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00183">osp_device::opd_pre_waitq</a>, and <a class="el" href="osp__precreate_8c_source.html#l00086">osp_precreate_running()</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01531">osp_init_precreate()</a>.</p>

</div>
</div>
<a class="anchor" id="ad3654e532b5fa26c203761087ed06470"></a><!-- doxytag: member="osp_precreate.c::osp_statfs_update" ref="ad3654e532b5fa26c203761087ed06470" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_statfs_update </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Send OST_STATFS RPC. </p>
<p>Sends OST_STATFS RPC to refresh cached statfs data for the target. Also disables scheduled updates as times OSP may need to refresh statfs data before expiration. The function doesn't block, instead an interpretation callback <a class="el" href="osp__precreate_8c.html#a5f1abade71475e571be5364b93ef0321" title="RPC interpret callback for OST_STATFS RPC.">osp_statfs_interpret()</a> is used.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00175">175</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__time_8h_source.html#l00067">cfs_time_shift()</a>, <a class="el" href="linux-prim_8c_source.html#l00069">cfs_timer_disarm()</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="libcfs__debug_8h_source.html#l00134">D_CACHE</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="class__obd_8c_source.html#l00083">obd_timeout</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00234">osp_device::opd_statfs_fresh_till</a>, <a class="el" href="osp__internal_8h_source.html#l00235">osp_device::opd_statfs_timer</a>, <a class="el" href="osp__internal_8h_source.html#l00236">osp_device::opd_statfs_update_in_progress</a>, <a class="el" href="osp__precreate_8c_source.html#l00121">osp_statfs_interpret()</a>, <a class="el" href="lustre__idl_8h_source.html#l00097">OST_CREATE_PORTAL</a>, <a class="el" href="packet-lustre_8c_source.html#l00176">OST_STATFS</a>, <a class="el" href="lustre__net_8h_source.html#l00553">ptlrpc_async_args::pointer_arg</a>, <a class="el" href="client_8c_source.html#l00293">ptlrpc_at_set_req_timeout()</a>, <a class="el" href="lustre__net_8h_source.html#l00505">ptlrpc_req_async_args</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="ptlrpcd_8c_source.html#l00268">ptlrpcd_add_req()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01646">RQF_OST_STATFS</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01082">osp_precreate_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a90b9288ca2540bfbf52700423ed6193a"></a><!-- doxytag: member="osp_precreate.c::osp_write_last_oid_seq_files" ref="a90b9288ca2540bfbf52700423ed6193a" args="(struct lu_env *env, struct osp_device *osp, struct lu_fid *fid, int sync)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_write_last_oid_seq_files </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>osp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sync</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Write FID into into last_oid/last_seq file. </p>
<p>The function stores the sequence and the in-sequence id into two dedicated files. The sync argument can be used to request synchronous commit, so the function won't return until the updates are committed.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osp</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>fid where sequence/id is taken </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>sync</em>&nbsp;</td><td>update mode: 0 - asynchronously, 1 - synchronously</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__precreate_8c_source.html#l00349">349</a> of file <a class="el" href="osp__precreate_8c_source.html">osp_precreate.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="dt__object_8h_source.html#l02087">dt_declare_record_write()</a>, <a class="el" href="dt__object_8c_source.html#l00504">dt_record_write()</a>, <a class="el" href="dt__object_8h_source.html#l02047">dt_trans_create()</a>, <a class="el" href="dt__object_8h_source.html#l02062">dt_trans_start_local()</a>, <a class="el" href="dt__object_8h_source.html#l02070">dt_trans_stop()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00147">lu_fid::f_oid</a>, <a class="el" href="lustre__user_8h_source.html#l00145">lu_fid::f_seq</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lu__object_8h_source.html#l01335">lu_buf::lb_buf</a>, <a class="el" href="lu__object_8h_source.html#l01336">lu_buf::lb_len</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00149">osp_device::opd_last_used_oid_file</a>, <a class="el" href="osp__internal_8h_source.html#l00150">osp_device::opd_last_used_seq_file</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00310">osp_thread_info::osi_lb</a>, <a class="el" href="osp__internal_8h_source.html#l00311">osp_thread_info::osi_lb2</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="dt__object_8h_source.html#l01848">thandle::th_sync</a>.</p>

<p>Referenced by <a class="el" href="osp__precreate_8c_source.html#l01008">osp_init_pre_fid()</a>, and <a class="el" href="osp__precreate_8c_source.html#l00428">osp_precreate_rollover_new_seq()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:50 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
