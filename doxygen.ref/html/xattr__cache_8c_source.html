<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/llite/xattr_cache.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/llite/xattr_cache.c</h1><a href="xattr__cache_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* GPL HEADER START</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00006"></a>00006 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00007"></a>00007 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00010"></a>00010 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00012"></a>00012 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00013"></a>00013 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00016"></a>00016 <span class="comment"> * version 2 along with this program; If not, see http://www.gnu.org/licenses</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * Please  visit http://www.xyratex.com/contact if you need additional</span>
<a name="l00019"></a>00019 <span class="comment"> * information or have any questions.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * GPL HEADER END</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">/*</span>
<a name="l00025"></a>00025 <span class="comment"> * Copyright 2012 Xyratex Technology Limited</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2013, 2015, Intel Corporation.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * Author: Andrew Perepechko &lt;Andrew_Perepechko@xyratex.com&gt;</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="xattr__cache_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00033</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_LLITE</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;linux/fs.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;linux/sched.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="obd__support_8h.html">obd_support.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="lustre__dlm_8h.html">lustre_dlm.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="lustre__ver_8h.html">lustre_ver.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="llite__internal_8h.html">llite_internal.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">/* If we ever have hundreds of extended attributes, we might want to consider</span>
<a name="l00044"></a>00044 <span class="comment"> * using a hash or a tree structure instead of list for faster lookups.</span>
<a name="l00045"></a>00045 <span class="comment"> */</span>
<a name="l00046"></a><a class="code" href="structll__xattr__entry.html">00046</a> <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> {
<a name="l00047"></a><a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">00047</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">xe_list</a>;    <span class="comment">/* protected with</span>
<a name="l00048"></a>00048 <span class="comment">                                             * lli_xattrs_list_rwsem */</span>
<a name="l00049"></a><a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">00049</a>         <span class="keywordtype">char</span>                    *<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>;   <span class="comment">/* xattr name, \0-terminated */</span>
<a name="l00050"></a><a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">00050</a>         <span class="keywordtype">char</span>                    *<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>;  <span class="comment">/* xattr value */</span>
<a name="l00051"></a><a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">00051</a>         <span class="keywordtype">unsigned</span>                <a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>; <span class="comment">/* strlen(xe_name) + 1 */</span>
<a name="l00052"></a><a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">00052</a>         <span class="keywordtype">unsigned</span>                <a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>;  <span class="comment">/* xattr value length */</span>
<a name="l00053"></a>00053 };
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">00055</a> <span class="keyword">static</span> <span class="keyword">struct </span>kmem_cache *<a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">xattr_kmem</a>;
<a name="l00056"></a><a class="code" href="xattr__cache_8c.html#af1e247dc2202e2bdff447bedf2df0c82">00056</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlu__kmem__descr.html">lu_kmem_descr</a> <a class="code" href="xattr__cache_8c.html#af1e247dc2202e2bdff447bedf2df0c82">xattr_caches</a>[] = {
<a name="l00057"></a>00057         {
<a name="l00058"></a>00058                 .<a class="code" href="structlu__kmem__descr.html#a001c10705375f8a479631aab32cebc90">ckd_cache</a> = &amp;<a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">xattr_kmem</a>,
<a name="l00059"></a>00059                 .ckd_name  = <span class="stringliteral">&quot;xattr_kmem&quot;</span>,
<a name="l00060"></a>00060                 .ckd_size  = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a>)
<a name="l00061"></a>00061         },
<a name="l00062"></a>00062         {
<a name="l00063"></a>00063                 .ckd_cache = NULL
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065 };
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="xattr__cache_8c.html#ae15783ba66f3eb4b365054de918d3f3b">00067</a> <span class="keywordtype">int</span> <a class="code" href="llite__internal_8h.html#ae15783ba66f3eb4b365054de918d3f3b">ll_xattr_init</a>(<span class="keywordtype">void</span>)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069         <span class="keywordflow">return</span> <a class="code" href="group__lu.html#ga42de365ae8cbdaa97c604434937a4822" title="Helper function to initialize a number of kmem slab caches at once.">lu_kmem_init</a>(xattr_caches);
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="xattr__cache_8c.html#a92164220fab4a79ac9d40af0aef4781e">00072</a> <span class="keywordtype">void</span> <a class="code" href="llite__internal_8h.html#a92164220fab4a79ac9d40af0aef4781e">ll_xattr_fini</a>(<span class="keywordtype">void</span>)
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074         <a class="code" href="group__lu.html#gac3834e0d4bd35c8a02d1003bf0f4331e" title="Helper function to finalize a number of kmem slab cached at once.">lu_kmem_fini</a>(xattr_caches);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00082"></a><a class="code" href="xattr__cache_8c.html#a05f700a5dd7233b036b93f44949a0a90">00082</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="xattr__cache_8c.html#a05f700a5dd7233b036b93f44949a0a90" title="Initializes xattr cache for an inode.">ll_xattr_cache_init</a>(<span class="keyword">struct</span> <a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(lli != NULL);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         <a class="code" href="list_8h.html#a0ffe9d28c36d7b018a9cfae33bae45c0">INIT_LIST_HEAD</a>(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a6d477965836d8bad52a916997c5119c3">lli_xattrs</a>);
<a name="l00089"></a>00089         <a class="code" href="llite__internal_8h.html#afb097a3705c4096995777fc51149518b">ll_file_set_flag</a>(lli, <a class="code" href="llite__internal_8h.html#aaf0d8ccf4e5b88ade37ea6ccaa027598acbc6b66810d64cbb886bccf9e3982591">LLIF_XATTR_CACHE</a>);
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00101"></a><a class="code" href="xattr__cache_8c.html#ae87d80d4dd9f13d395d6c1f797423892">00101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#ae87d80d4dd9f13d395d6c1f797423892" title="This looks for a specific extended attribute.">ll_xattr_cache_find</a>(<span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *cache,
<a name="l00102"></a>00102                                <span class="keyword">const</span> <span class="keywordtype">char</span> *xattr_name,
<a name="l00103"></a>00103                                <span class="keyword">struct</span> <a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> **xattr)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105         <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> *entry;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(entry, cache, <a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">xe_list</a>) {
<a name="l00110"></a>00110                 <span class="comment">/* xattr_name == NULL means look for any entry */</span>
<a name="l00111"></a>00111                 <span class="keywordflow">if</span> (xattr_name == NULL ||
<a name="l00112"></a>00112                     strcmp(xattr_name, entry-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>) == 0) {
<a name="l00113"></a>00113                         *xattr = entry;
<a name="l00114"></a>00114                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;find: [%s]=%.*s\n&quot;</span>,
<a name="l00115"></a>00115                                entry-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, entry-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>,
<a name="l00116"></a>00116                                entry-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>);
<a name="l00117"></a>00117                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00118"></a>00118                 }
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODATA);
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00133"></a><a class="code" href="xattr__cache_8c.html#a53111d4286bba52bb3d97e742a091a6f">00133</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a53111d4286bba52bb3d97e742a091a6f" title="This adds an xattr.">ll_xattr_cache_add</a>(<span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *cache,
<a name="l00134"></a>00134                               <span class="keyword">const</span> <span class="keywordtype">char</span> *xattr_name,
<a name="l00135"></a>00135                               <span class="keyword">const</span> <span class="keywordtype">char</span> *xattr_val,
<a name="l00136"></a>00136                               <span class="keywordtype">unsigned</span> xattr_val_len)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138         <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> *xattr;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (<a class="code" href="xattr__cache_8c.html#ae87d80d4dd9f13d395d6c1f797423892" title="This looks for a specific extended attribute.">ll_xattr_cache_find</a>(cache, xattr_name, &amp;xattr) == 0) {
<a name="l00143"></a>00143                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;duplicate xattr: [%s]\n&quot;</span>, xattr_name);
<a name="l00144"></a>00144                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EPROTO);
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <a class="code" href="obd__support_8h.html#a17051758ec7639b4156d85894b7df140">OBD_SLAB_ALLOC_PTR_GFP</a>(xattr, <a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">xattr_kmem</a>, GFP_NOFS);
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (xattr == NULL) {
<a name="l00149"></a>00149                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;failed to allocate xattr\n&quot;</span>);
<a name="l00150"></a>00150                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a> = strlen(xattr_name) + 1;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (!xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>) {
<a name="l00157"></a>00157                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;failed to alloc xattr name %u\n&quot;</span>,
<a name="l00158"></a>00158                        xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00159"></a>00159                 <span class="keywordflow">goto</span> err_name;
<a name="l00160"></a>00160         }
<a name="l00161"></a>00161         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(xattr-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>, xattr_val_len);
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (!xattr-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>) {
<a name="l00163"></a>00163                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;failed to alloc xattr value %d\n&quot;</span>,
<a name="l00164"></a>00164                        xattr_val_len);
<a name="l00165"></a>00165                 <span class="keywordflow">goto</span> err_value;
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         memcpy(xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, xattr_name, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00169"></a>00169         memcpy(xattr-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>, xattr_val, xattr_val_len);
<a name="l00170"></a>00170         xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a> = xattr_val_len;
<a name="l00171"></a>00171         <a class="code" href="list_8h.html#a0373c4b3c8ce51a451a569ad978b32e1" title="Insert an entry at the start of a list.">list_add</a>(&amp;xattr-&gt;<a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">xe_list</a>, cache);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;set: [%s]=%.*s\n&quot;</span>, xattr_name,
<a name="l00174"></a>00174                 xattr_val_len, xattr_val);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00177"></a>00177 err_value:
<a name="l00178"></a>00178         <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00179"></a>00179 err_name:
<a name="l00180"></a>00180         <a class="code" href="obd__support_8h.html#a8790e4c5dc3134282343de016fff8e2a">OBD_SLAB_FREE_PTR</a>(xattr, <a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">xattr_kmem</a>);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00193"></a><a class="code" href="xattr__cache_8c.html#afc1d1435451ca0ca3b0f7942a395d7c0">00193</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#afc1d1435451ca0ca3b0f7942a395d7c0" title="This removes an extended attribute from cache.">ll_xattr_cache_del</a>(<span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *cache,
<a name="l00194"></a>00194                               <span class="keyword">const</span> <span class="keywordtype">char</span> *xattr_name)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> *xattr;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;del xattr: %s\n&quot;</span>, xattr_name);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (<a class="code" href="xattr__cache_8c.html#ae87d80d4dd9f13d395d6c1f797423892" title="This looks for a specific extended attribute.">ll_xattr_cache_find</a>(cache, xattr_name, &amp;xattr) == 0) {
<a name="l00203"></a>00203                 <a class="code" href="list_8h.html#ab1708206f0f7e0a56550b35372203ba5" title="Remove an entry from the list it is currently in.">list_del</a>(&amp;xattr-&gt;<a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">xe_list</a>);
<a name="l00204"></a>00204                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00205"></a>00205                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(xattr-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>);
<a name="l00206"></a>00206                 <a class="code" href="obd__support_8h.html#a8790e4c5dc3134282343de016fff8e2a">OBD_SLAB_FREE_PTR</a>(xattr, <a class="code" href="xattr__cache_8c.html#a79e8ee9f6ca2f1575196250cf0e932ac">xattr_kmem</a>);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODATA);
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00224"></a><a class="code" href="xattr__cache_8c.html#a0d9b32e334b3cefc930ac37ba76e7bb1">00224</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a0d9b32e334b3cefc930ac37ba76e7bb1" title="This iterates cached extended attributes.">ll_xattr_cache_list</a>(<span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *cache,
<a name="l00225"></a>00225                                <span class="keywordtype">char</span> *xld_buffer,
<a name="l00226"></a>00226                                <span class="keywordtype">int</span> xld_size)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228         <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> *xattr, *tmp;
<a name="l00229"></a>00229         <span class="keywordtype">int</span> xld_tail = 0;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <a class="code" href="list_8h.html#ac3f72d6bd5144c7970824813810d2da1" title="Iterate over a list of given type safe against removal of list entry.">list_for_each_entry_safe</a>(xattr, tmp, cache, <a class="code" href="structll__xattr__entry.html#aad105433487e411c80d3867cf498bfd7">xe_list</a>) {
<a name="l00234"></a>00234                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;list: buffer=%p[%d] name=%s\n&quot;</span>,
<a name="l00235"></a>00235                         xld_buffer, xld_tail, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237                 <span class="keywordflow">if</span> (xld_buffer) {
<a name="l00238"></a>00238                         xld_size -= xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>;
<a name="l00239"></a>00239                         <span class="keywordflow">if</span> (xld_size &lt; 0)
<a name="l00240"></a>00240                                 <span class="keywordflow">break</span>;
<a name="l00241"></a>00241                         memcpy(&amp;xld_buffer[xld_tail],
<a name="l00242"></a>00242                                xattr-&gt;<a class="code" href="structll__xattr__entry.html#a0b2cb7c1ed2a7c6e333efa48d6086459">xe_name</a>, xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>);
<a name="l00243"></a>00243                 }
<a name="l00244"></a>00244                 xld_tail += xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8881b9bed3bf33ca162285d0d076366e">xe_namelen</a>;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (xld_size &lt; 0)
<a name="l00248"></a>00248                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ERANGE);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(xld_tail);
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00259"></a><a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101">00259</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101" title="Check if the xattr cache is initialized (filled).">ll_xattr_cache_valid</a>(<span class="keyword">struct</span> <a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261         <span class="keywordflow">return</span> <a class="code" href="llite__internal_8h.html#a35f7748e3e39f66365a83a93cfd2b1dd">ll_file_test_flag</a>(lli, <a class="code" href="llite__internal_8h.html#aaf0d8ccf4e5b88ade37ea6ccaa027598acbc6b66810d64cbb886bccf9e3982591">LLIF_XATTR_CACHE</a>);
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00271"></a><a class="code" href="xattr__cache_8c.html#a4fb084715f4fd0e32a48a8309bb7c180">00271</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a4fb084715f4fd0e32a48a8309bb7c180" title="This finalizes the xattr cache.">ll_xattr_cache_destroy_locked</a>(<span class="keyword">struct</span> <a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keywordflow">if</span> (!<a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101" title="Check if the xattr cache is initialized (filled).">ll_xattr_cache_valid</a>(lli))
<a name="l00276"></a>00276                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">while</span> (<a class="code" href="xattr__cache_8c.html#afc1d1435451ca0ca3b0f7942a395d7c0" title="This removes an extended attribute from cache.">ll_xattr_cache_del</a>(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a6d477965836d8bad52a916997c5119c3">lli_xattrs</a>, NULL) == 0)
<a name="l00279"></a>00279                 <span class="comment">/* empty loop */</span> ;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <a class="code" href="llite__internal_8h.html#af5f86c202cbdebf5e1912eb036a0353a">ll_file_clear_flag</a>(lli, <a class="code" href="llite__internal_8h.html#aaf0d8ccf4e5b88ade37ea6ccaa027598acbc6b66810d64cbb886bccf9e3982591">LLIF_XATTR_CACHE</a>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="xattr__cache_8c.html#a6218ad7ef04b817916859fcaa933a521">00286</a> <span class="keywordtype">int</span> <a class="code" href="llite__internal_8h.html#a6218ad7ef04b817916859fcaa933a521">ll_xattr_cache_destroy</a>(<span class="keyword">struct</span> inode *inode)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288         <span class="keyword">struct </span><a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli = <a class="code" href="llite__internal_8h.html#ab207ad07a4a0e720f9326add66c1ead7">ll_i2info</a>(inode);
<a name="l00289"></a>00289         <span class="keywordtype">int</span> rc;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         down_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00294"></a>00294         rc = <a class="code" href="xattr__cache_8c.html#a4fb084715f4fd0e32a48a8309bb7c180" title="This finalizes the xattr cache.">ll_xattr_cache_destroy_locked</a>(lli);
<a name="l00295"></a>00295         up_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00311"></a><a class="code" href="xattr__cache_8c.html#a4b2b898489a3095b0501fcad5c467e08">00311</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a4b2b898489a3095b0501fcad5c467e08" title="Match or enqueue a PR lock.">ll_xattr_find_get_lock</a>(<span class="keyword">struct</span> inode *inode,
<a name="l00312"></a>00312                                   <span class="keyword">struct</span> <a class="code" href="structlookup__intent.html">lookup_intent</a> *oit,
<a name="l00313"></a>00313                                   <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **req)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315         <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="code" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>;
<a name="l00316"></a>00316         <span class="keyword">struct </span><a class="code" href="structlustre__handle.html">lustre_handle</a> lockh = { 0 };
<a name="l00317"></a>00317         <span class="keyword">struct </span><a class="code" href="structmd__op__data.html">md_op_data</a> *<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a>;
<a name="l00318"></a>00318         <span class="keyword">struct </span><a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli = <a class="code" href="llite__internal_8h.html#ab207ad07a4a0e720f9326add66c1ead7">ll_i2info</a>(inode);
<a name="l00319"></a>00319         <span class="keyword">struct </span><a class="code" href="structldlm__enqueue__info.html" title="Common ldlm_enqueue parameters.">ldlm_enqueue_info</a> einfo = {
<a name="l00320"></a>00320                 .<a class="code" href="structldlm__enqueue__info.html#a6b87487abead59973262624bf9f90eb0">ei_type</a> = <a class="code" href="packet-lustre_8c.html#afca8e3fd80560e42cd0c6013d34af412">LDLM_IBITS</a>,
<a name="l00321"></a>00321                 .ei_mode = <a class="code" href="obd_8h.html#a1e8b75b0a871f1981247c6d4bd54e149">it_to_lock_mode</a>(oit),
<a name="l00322"></a>00322                 .ei_cb_bl = &amp;<a class="code" href="llite__internal_8h.html#af71dd40c0f56909e141376df051b83b4">ll_md_blocking_ast</a>,
<a name="l00323"></a>00323                 .ei_cb_cp = &amp;<a class="code" href="group__ldlm__local__ast.html#gaae5738d417a8624f65b5418d57fef359" title="Generic LDLM &amp;quot;completion&amp;quot; AST.">ldlm_completion_ast</a>,
<a name="l00324"></a>00324         };
<a name="l00325"></a>00325         <span class="keyword">struct </span><a class="code" href="structll__sb__info.html">ll_sb_info</a> *sbi = <a class="code" href="llite__internal_8h.html#aded7f20309c0a2768de0c6351247527a">ll_i2sbi</a>(inode);
<a name="l00326"></a>00326         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp = sbi-&gt;<a class="code" href="structll__sb__info.html#a585b00d59707c91ff10eb0e6a571cbba">ll_md_exp</a>;
<a name="l00327"></a>00327         <span class="keywordtype">int</span> rc;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         mutex_lock(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a2fcee6176a48a18a0068939d688eb5f8">lli_xattrs_enq_lock</a>);
<a name="l00332"></a>00332         <span class="comment">/* inode may have been shrunk and recreated, so data is gone, match lock</span>
<a name="l00333"></a>00333 <span class="comment">         * only when data exists. */</span>
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (<a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101" title="Check if the xattr cache is initialized (filled).">ll_xattr_cache_valid</a>(lli)) {
<a name="l00335"></a>00335                 <span class="comment">/* Try matching first. */</span>
<a name="l00336"></a>00336                 mode = <a class="code" href="file_8c.html#afae34889a41cb38904550a02c82e5f99">ll_take_md_lock</a>(inode, <a class="code" href="group__lustreidl.html#ga6a4f87e6de3228a73f0a78a2715bbb6c">MDS_INODELOCK_XATTR</a>, &amp;lockh, 0,
<a name="l00337"></a>00337                                         <a class="code" href="packet-lustre_8c.html#a4b1936ce7054752c0a9d74ebc836c5d6">LCK_PR</a>);
<a name="l00338"></a>00338                 <span class="keywordflow">if</span> (mode != 0) {
<a name="l00339"></a>00339                         <span class="comment">/* fake oit in mdc_revalidate_lock() manner */</span>
<a name="l00340"></a>00340                         oit-&gt;<a class="code" href="structlookup__intent.html#a2ab792bc338599522f249bb6751dbe7d">it_lock_handle</a> = lockh.<a class="code" href="structlustre__handle.html#a735d65d1a27d9cafdc17245e4574000a">cookie</a>;
<a name="l00341"></a>00341                         oit-&gt;<a class="code" href="structlookup__intent.html#ab115a585fd2572f4c9b3ecc0959aabaa">it_lock_mode</a> = mode;
<a name="l00342"></a>00342                         <span class="keywordflow">goto</span> out;
<a name="l00343"></a>00343                 }
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346         <span class="comment">/* Enqueue if the lock isn&apos;t cached locally. */</span>
<a name="l00347"></a>00347         op_data = <a class="code" href="llite__internal_8h.html#ac34edcba0eb7e2d7a41584440be3499e">ll_prep_md_op_data</a>(NULL, inode, NULL, NULL, 0, 0,
<a name="l00348"></a>00348                                      <a class="code" href="llite__internal_8h.html#a2d5492e116eebd5075f247d21fb9db26ab00f57fd8f623a54019762e13517d55a">LUSTRE_OPC_ANY</a>, NULL);
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (IS_ERR(op_data)) {
<a name="l00350"></a>00350                 mutex_unlock(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a2fcee6176a48a18a0068939d688eb5f8">lli_xattrs_enq_lock</a>);
<a name="l00351"></a>00351                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(op_data));
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         op_data-&gt;<a class="code" href="structmd__op__data.html#ac8d9d3433b6a82bc7b3bd0195407067d">op_valid</a> = <a class="code" href="group__lustreidl.html#ga6b3a0ed5b403f8d16300fb9a5e688bee">OBD_MD_FLXATTR</a> | <a class="code" href="group__lustreidl.html#gadc688242c0b04b699474b3867b7ed952">OBD_MD_FLXATTRLS</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         rc = <a class="code" href="obd__class_8h.html#af11d633f1a2b86b59a6089cc3d0125fd">md_enqueue</a>(exp, &amp;einfo, NULL, oit, op_data, &amp;lockh, 0);
<a name="l00357"></a>00357         <a class="code" href="llite__internal_8h.html#a0c828a482695c0557ded62b65a6be7b2">ll_finish_md_op_data</a>(op_data);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00360"></a>00360                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;md_intent_lock failed with %d for fid &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00361"></a>00361                        rc, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(<a class="code" href="llite__internal_8h.html#a3f20d3ffc26568e83b4acbf9e106f44d">ll_inode2fid</a>(inode)));
<a name="l00362"></a>00362                 mutex_unlock(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a2fcee6176a48a18a0068939d688eb5f8">lli_xattrs_enq_lock</a>);
<a name="l00363"></a>00363                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00364"></a>00364         }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         *req = oit-&gt;<a class="code" href="structlookup__intent.html#a5021347884e9dd65e119b6eaa9d618c0">it_request</a>;
<a name="l00367"></a>00367 out:
<a name="l00368"></a>00368         down_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00369"></a>00369         mutex_unlock(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a2fcee6176a48a18a0068939d688eb5f8">lli_xattrs_enq_lock</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00385"></a><a class="code" href="xattr__cache_8c.html#a90e2828f21b1debd9dab2f9a8d2a3f03">00385</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="xattr__cache_8c.html#a90e2828f21b1debd9dab2f9a8d2a3f03" title="Refill the xattr cache.">ll_xattr_cache_refill</a>(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> <a class="code" href="structlookup__intent.html">lookup_intent</a> *oit)
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387         <span class="keyword">struct </span><a class="code" href="structll__sb__info.html">ll_sb_info</a> *sbi = <a class="code" href="llite__internal_8h.html#aded7f20309c0a2768de0c6351247527a">ll_i2sbi</a>(inode);
<a name="l00388"></a>00388         <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req = NULL;
<a name="l00389"></a>00389         <span class="keyword">const</span> <span class="keywordtype">char</span> *xdata, *xval, *xtail, *xvtail;
<a name="l00390"></a>00390         <span class="keyword">struct </span><a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli = <a class="code" href="llite__internal_8h.html#ab207ad07a4a0e720f9326add66c1ead7">ll_i2info</a>(inode);
<a name="l00391"></a>00391         <span class="keyword">struct </span><a class="code" href="structmdt__body.html">mdt_body</a> *body;
<a name="l00392"></a>00392         __u32 *xsizes;
<a name="l00393"></a>00393         <span class="keywordtype">int</span> rc = 0, i;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         rc = <a class="code" href="xattr__cache_8c.html#a4b2b898489a3095b0501fcad5c467e08" title="Match or enqueue a PR lock.">ll_xattr_find_get_lock</a>(inode, oit, &amp;req);
<a name="l00398"></a>00398         <span class="keywordflow">if</span> (rc)
<a name="l00399"></a>00399                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_no_unlock, rc);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="comment">/* Do we have the data at this point? */</span>
<a name="l00402"></a>00402         <span class="keywordflow">if</span> (<a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101" title="Check if the xattr cache is initialized (filled).">ll_xattr_cache_valid</a>(lli)) {
<a name="l00403"></a>00403                 <a class="code" href="llite__internal_8h.html#ad13e8595f0029594dbc5d3d95842ee84">ll_stats_ops_tally</a>(sbi, <a class="code" href="llite__internal_8h.html#a78372742882dccd1c13323dbd66c25c5a198e03803acce858e5dfb54b954b79a8">LPROC_LL_GETXATTR_HITS</a>, 1);
<a name="l00404"></a>00404                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_maybe_drop, rc = 0);
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         <span class="comment">/* Matched but no cache? Cancelled on error by a parallel refill. */</span>
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(req == NULL)) {
<a name="l00409"></a>00409                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;cancelled by a parallel getxattr\n&quot;</span>);
<a name="l00410"></a>00410                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_maybe_drop, rc = -EIO);
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <span class="keywordflow">if</span> (oit-&gt;<a class="code" href="structlookup__intent.html#a73619df4112e184fbd0e0011e1882829">it_status</a> &lt; 0) {
<a name="l00414"></a>00414                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;getxattr intent returned %d for fid &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00415"></a>00415                        oit-&gt;<a class="code" href="structlookup__intent.html#a73619df4112e184fbd0e0011e1882829">it_status</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(<a class="code" href="llite__internal_8h.html#a3f20d3ffc26568e83b4acbf9e106f44d">ll_inode2fid</a>(inode)));
<a name="l00416"></a>00416                 rc = oit-&gt;<a class="code" href="structlookup__intent.html#a73619df4112e184fbd0e0011e1882829">it_status</a>;
<a name="l00417"></a>00417                 <span class="comment">/* xattr data is so large that we don&apos;t want to cache it */</span>
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (rc == -ERANGE)
<a name="l00419"></a>00419                         rc = -EAGAIN;
<a name="l00420"></a>00420                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>, rc);
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         body = <a class="code" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer...">req_capsule_server_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;<a class="code" href="group__req__layout.html#ga1c9ae136d2e4b00329d63bcb718c9d93">RMF_MDT_BODY</a>);
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (body == NULL) {
<a name="l00425"></a>00425                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;no MDT BODY in the refill xattr reply\n&quot;</span>);
<a name="l00426"></a>00426                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>, rc = -EPROTO);
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428         <span class="comment">/* do not need swab xattr data */</span>
<a name="l00429"></a>00429         xdata = <a class="code" href="group__req__layout.html#gaebc460299194b773def6ad6960826860" title="Utility that combines req_capsule_set_size() and req_capsule_server_get().">req_capsule_server_sized_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;<a class="code" href="group__req__layout.html#gac100183fd493f696da33eac97ab5818a">RMF_EADATA</a>,
<a name="l00430"></a>00430                                                 body-&gt;<a class="code" href="structmdt__body.html#a359eea15d049e4e64c13734f1869cfd5">mbo_eadatasize</a>);
<a name="l00431"></a>00431         xval = <a class="code" href="group__req__layout.html#gaebc460299194b773def6ad6960826860" title="Utility that combines req_capsule_set_size() and req_capsule_server_get().">req_capsule_server_sized_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;<a class="code" href="group__req__layout.html#ga6427d95dd8a76ee5da487fba372478eb">RMF_EAVALS</a>,
<a name="l00432"></a>00432                                                 body-&gt;<a class="code" href="structmdt__body.html#aad4dfd22cdf6492eec9b758fcfd801fd">mbo_aclsize</a>);
<a name="l00433"></a>00433         xsizes = <a class="code" href="group__req__layout.html#gaebc460299194b773def6ad6960826860" title="Utility that combines req_capsule_set_size() and req_capsule_server_get().">req_capsule_server_sized_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;<a class="code" href="group__req__layout.html#ga2131594f890a9c1e688c5661fb92f032">RMF_EAVALS_LENS</a>,
<a name="l00434"></a>00434                                               body-&gt;<a class="code" href="structmdt__body.html#a47fc4e6a0c0ed3628e96eb3c319e9d9d">mbo_max_mdsize</a> *
<a name="l00435"></a>00435                                               <span class="keyword">sizeof</span>(__u32));
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (xdata == NULL || xval == NULL || xsizes == NULL) {
<a name="l00437"></a>00437                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;wrong setxattr reply\n&quot;</span>);
<a name="l00438"></a>00438                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>, rc = -EPROTO);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         xtail = xdata + body-&gt;<a class="code" href="structmdt__body.html#a359eea15d049e4e64c13734f1869cfd5">mbo_eadatasize</a>;
<a name="l00442"></a>00442         xvtail = xval + body-&gt;<a class="code" href="structmdt__body.html#aad4dfd22cdf6492eec9b758fcfd801fd">mbo_aclsize</a>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;caching: xdata=%p xtail=%p\n&quot;</span>, xdata, xtail);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446         <a class="code" href="xattr__cache_8c.html#a05f700a5dd7233b036b93f44949a0a90" title="Initializes xattr cache for an inode.">ll_xattr_cache_init</a>(lli);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="keywordflow">for</span> (i = 0; i &lt; body-&gt;<a class="code" href="structmdt__body.html#a47fc4e6a0c0ed3628e96eb3c319e9d9d">mbo_max_mdsize</a>; i++) {
<a name="l00449"></a>00449                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;caching [%s]=%.*s\n&quot;</span>, xdata, *xsizes, xval);
<a name="l00450"></a>00450                 <span class="comment">/* Perform consistency checks: attr names and vals in pill */</span>
<a name="l00451"></a>00451                 <span class="keywordflow">if</span> (memchr(xdata, 0, xtail - xdata) == NULL) {
<a name="l00452"></a>00452                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;xattr protocol violation (names are broken)\n&quot;</span>);
<a name="l00453"></a>00453                         rc = -EPROTO;
<a name="l00454"></a>00454                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xval + *xsizes &gt; xvtail) {
<a name="l00455"></a>00455                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;xattr protocol violation (vals are broken)\n&quot;</span>);
<a name="l00456"></a>00456                         rc = -EPROTO;
<a name="l00457"></a>00457                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#ae34a8882b9bda8c0edfcec5a627da0c3">OBD_FAIL_LLITE_XATTR_ENOMEM</a>)) {
<a name="l00458"></a>00458                         rc = -ENOMEM;
<a name="l00459"></a>00459                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(xdata, <a class="code" href="group__lustreidl.html#ga9c0470d187d4bcaa10ffd1019f147d2d">XATTR_NAME_ACL_ACCESS</a>)) {
<a name="l00460"></a>00460                         <span class="comment">/* Filter out ACL ACCESS since it&apos;s cached separately */</span>
<a name="l00461"></a>00461                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;not caching %s\n&quot;</span>,
<a name="l00462"></a>00462                                <a class="code" href="group__lustreidl.html#ga9c0470d187d4bcaa10ffd1019f147d2d">XATTR_NAME_ACL_ACCESS</a>);
<a name="l00463"></a>00463                         rc = 0;
<a name="l00464"></a>00464                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(xdata, <span class="stringliteral">&quot;security.selinux&quot;</span>)) {
<a name="l00465"></a>00465                         <span class="comment">/* Filter out security.selinux, it is cached in slab */</span>
<a name="l00466"></a>00466                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a82cd19c0939c99444c5bf1bc830df4ee">D_CACHE</a>, <span class="stringliteral">&quot;not caching security.selinux\n&quot;</span>);
<a name="l00467"></a>00467                         rc = 0;
<a name="l00468"></a>00468                 } <span class="keywordflow">else</span> {
<a name="l00469"></a>00469                         rc = <a class="code" href="xattr__cache_8c.html#a53111d4286bba52bb3d97e742a091a6f" title="This adds an xattr.">ll_xattr_cache_add</a>(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a6d477965836d8bad52a916997c5119c3">lli_xattrs</a>, xdata, xval,
<a name="l00470"></a>00470                                                 *xsizes);
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472                 <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00473"></a>00473                         <a class="code" href="xattr__cache_8c.html#a4fb084715f4fd0e32a48a8309bb7c180" title="This finalizes the xattr cache.">ll_xattr_cache_destroy_locked</a>(lli);
<a name="l00474"></a>00474                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>, rc);
<a name="l00475"></a>00475                 }
<a name="l00476"></a>00476                 xdata += strlen(xdata) + 1;
<a name="l00477"></a>00477                 xval  += *xsizes;
<a name="l00478"></a>00478                 xsizes++;
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (xdata != xtail || xval != xvtail)
<a name="l00482"></a>00482                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;a hole in xattr data\n&quot;</span>);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <a class="code" href="llite__internal_8h.html#af575f5a19230246b843970b24306c51c">ll_set_lock_data</a>(sbi-&gt;<a class="code" href="structll__sb__info.html#a585b00d59707c91ff10eb0e6a571cbba">ll_md_exp</a>, inode, oit, NULL);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_maybe_drop, rc);
<a name="l00487"></a>00487 out_maybe_drop:
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <a class="code" href="dcache_8c.html#a69e35e19f520e51dc46bd97a7721ebf1">ll_intent_drop_lock</a>(oit);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (rc != 0)
<a name="l00492"></a>00492                 up_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00493"></a>00493 out_no_unlock:
<a name="l00494"></a>00494         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(req);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         <span class="keywordflow">return</span> rc;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>:
<a name="l00499"></a>00499         up_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         <a class="code" href="group__LDLM.html#gad236a9af5f0845e1046060a55419914b" title="Decrease reader/writer refcount for LDLM lock with handle lockh and mark it for subsequent...">ldlm_lock_decref_and_cancel</a>((<span class="keyword">struct</span> <a class="code" href="structlustre__handle.html">lustre_handle</a> *)
<a name="l00502"></a>00502                                         &amp;oit-&gt;<a class="code" href="structlookup__intent.html#a2ab792bc338599522f249bb6751dbe7d">it_lock_handle</a>,
<a name="l00503"></a>00503                                         oit-&gt;<a class="code" href="structlookup__intent.html#ab115a585fd2572f4c9b3ecc0959aabaa">it_lock_mode</a>);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="keywordflow">goto</span> out_no_unlock;
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00522"></a><a class="code" href="xattr__cache_8c.html#ace26221d59e2ce4bc476c563a704efcb">00522</a> <span class="keywordtype">int</span> <a class="code" href="llite__internal_8h.html#ace26221d59e2ce4bc476c563a704efcb">ll_xattr_cache_get</a>(<span class="keyword">struct</span> inode *inode,
<a name="l00523"></a>00523                         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>,
<a name="l00524"></a>00524                         <span class="keywordtype">char</span> *buffer,
<a name="l00525"></a>00525                         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>,
<a name="l00526"></a>00526                         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> valid)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528         <span class="keyword">struct </span><a class="code" href="structlookup__intent.html">lookup_intent</a> oit = { .<a class="code" href="structlookup__intent.html#a31b6fb3b16053c4e7a04f8284601d3aa">it_op</a> = <a class="code" href="packet-lustre_8c.html#a6d499e10f709bbfadcffbf814b7f8420">IT_GETXATTR</a> };
<a name="l00529"></a>00529         <span class="keyword">struct </span><a class="code" href="structll__inode__info.html">ll_inode_info</a> *lli = <a class="code" href="llite__internal_8h.html#ab207ad07a4a0e720f9326add66c1ead7">ll_i2info</a>(inode);
<a name="l00530"></a>00530         <span class="keywordtype">int</span> rc = 0;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(!!(valid &amp; <a class="code" href="group__lustreidl.html#ga6b3a0ed5b403f8d16300fb9a5e688bee">OBD_MD_FLXATTR</a>) ^ !!(valid &amp; <a class="code" href="group__lustreidl.html#gadc688242c0b04b699474b3867b7ed952">OBD_MD_FLXATTRLS</a>));
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         down_read(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (!<a class="code" href="xattr__cache_8c.html#a3c2e568bed700420f0b113ec1355e101" title="Check if the xattr cache is initialized (filled).">ll_xattr_cache_valid</a>(lli)) {
<a name="l00538"></a>00538                 up_read(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00539"></a>00539                 rc = <a class="code" href="xattr__cache_8c.html#a90e2828f21b1debd9dab2f9a8d2a3f03" title="Refill the xattr cache.">ll_xattr_cache_refill</a>(inode, &amp;oit);
<a name="l00540"></a>00540                 <span class="keywordflow">if</span> (rc)
<a name="l00541"></a>00541                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00542"></a>00542                 downgrade_write(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00543"></a>00543         } <span class="keywordflow">else</span> {
<a name="l00544"></a>00544                 <a class="code" href="llite__internal_8h.html#ad13e8595f0029594dbc5d3d95842ee84">ll_stats_ops_tally</a>(<a class="code" href="llite__internal_8h.html#aded7f20309c0a2768de0c6351247527a">ll_i2sbi</a>(inode), <a class="code" href="llite__internal_8h.html#a78372742882dccd1c13323dbd66c25c5a198e03803acce858e5dfb54b954b79a8">LPROC_LL_GETXATTR_HITS</a>, 1);
<a name="l00545"></a>00545         }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (valid &amp; OBD_MD_FLXATTR) {
<a name="l00548"></a>00548                 <span class="keyword">struct </span><a class="code" href="structll__xattr__entry.html">ll_xattr_entry</a> *xattr;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                 rc = <a class="code" href="xattr__cache_8c.html#ae87d80d4dd9f13d395d6c1f797423892" title="This looks for a specific extended attribute.">ll_xattr_cache_find</a>(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a6d477965836d8bad52a916997c5119c3">lli_xattrs</a>, name, &amp;xattr);
<a name="l00551"></a>00551                 <span class="keywordflow">if</span> (rc == 0) {
<a name="l00552"></a>00552                         rc = xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>;
<a name="l00553"></a>00553                         <span class="comment">/* zero size means we are only requested size in rc */</span>
<a name="l00554"></a>00554                         <span class="keywordflow">if</span> (size != 0) {
<a name="l00555"></a>00555                                 <span class="keywordflow">if</span> (size &gt;= xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>)
<a name="l00556"></a>00556                                         memcpy(buffer, xattr-&gt;<a class="code" href="structll__xattr__entry.html#ab2321f9780d3f83296596c770c59cd02">xe_value</a>,
<a name="l00557"></a>00557                                                 xattr-&gt;<a class="code" href="structll__xattr__entry.html#a8b03c87a6b9b7fa2e287a96bd174c5ef">xe_vallen</a>);
<a name="l00558"></a>00558                                 <span class="keywordflow">else</span>
<a name="l00559"></a>00559                                         rc = -ERANGE;
<a name="l00560"></a>00560                         }
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (valid &amp; OBD_MD_FLXATTRLS) {
<a name="l00563"></a>00563                 rc = <a class="code" href="xattr__cache_8c.html#a0d9b32e334b3cefc930ac37ba76e7bb1" title="This iterates cached extended attributes.">ll_xattr_cache_list</a>(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a6d477965836d8bad52a916997c5119c3">lli_xattrs</a>,
<a name="l00564"></a>00564                                          size ? buffer : NULL, size);
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00568"></a>00568 out:
<a name="l00569"></a>00569         up_read(&amp;lli-&gt;<a class="code" href="structll__inode__info.html#a618e1ec842b926f50d4e32bb5511a3aa">lli_xattrs_list_rwsem</a>);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <span class="keywordflow">return</span> rc;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:37 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
