<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/lmv/lmv_obd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/lmv/lmv_obd.c</h1><a href="lmv__obd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.sun.com/software/products/lustre/docs/GPLv2.pdf</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2004, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2011, 2015, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="lmv__obd_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00037</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_LMV</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/slab.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;linux/init.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;linux/user_namespace.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#ifdef HAVE_UIDGID_HEADER</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor"># include &lt;linux/uidgid.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/slab.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;linux/pagemap.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;linux/math64.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;linux/seq_file.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;linux/namei.h&gt;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="lustre__idl_8h.html">lustre/lustre_idl.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="obd__support_8h.html">obd_support.h</a>&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="lustre__lib_8h.html">lustre_lib.h</a>&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="lustre__net_8h.html">lustre_net.h</a>&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="obd__class_8h.html">obd_class.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="lustre__lmv_8h.html">lustre_lmv.h</a>&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;<a class="code" href="lprocfs__status_8h.html">lprocfs_status.h</a>&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="cl__object_8h.html">cl_object.h</a>&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;<a class="code" href="lustre__fid_8h.html">lustre_fid.h</a>&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;<a class="code" href="lustre__ioctl_8h.html">lustre_ioctl.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;<a class="code" href="lustre__kernelcomm_8h.html">lustre_kernelcomm.h</a>&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="lmv__internal_8h.html">lmv_internal.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="lmv__obd_8c.html#ac2c84bd171886ba98a55a62ae88e4491">00065</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lmv__obd_8c.html#ac2c84bd171886ba98a55a62ae88e4491">lmv_activate_target</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv,
<a name="l00066"></a>00066                                 <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt,
<a name="l00067"></a>00067                                 <span class="keywordtype">int</span> activate)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> == activate)
<a name="l00070"></a>00070                 <span class="keywordflow">return</span>;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> = activate;
<a name="l00073"></a>00073         lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a1ba21704d398ca3271311f34748d440e">ld_active_tgt_count</a> += (activate ? 1 : -1);
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#ab5d84ac9265231299ff053a9fd17857f">obd_inactive</a> = !activate;
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00085"></a><a class="code" href="lmv__obd_8c.html#ad17784cf12bb923322ae1b6ba12e6942">00085</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad17784cf12bb923322ae1b6ba12e6942" title="Error codes:.">lmv_set_mdc_active</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv,
<a name="l00086"></a>00086                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>,
<a name="l00087"></a>00087                               <span class="keywordtype">int</span> activate)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = NULL;
<a name="l00090"></a>00090         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd;
<a name="l00091"></a>00091         __u32                    i;
<a name="l00092"></a>00092         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00093"></a>00093         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Searching in lmv %p for uuid %s (activate=%d)\n&quot;</span>,
<a name="l00096"></a>00096                         lmv, uuid-&gt;<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, activate);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         spin_lock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#abb7417932d14e6a68a6b7d8b81c18243">lmv_lock</a>);
<a name="l00099"></a>00099         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00100"></a>00100                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00101"></a>00101                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00102"></a>00102                         <span class="keywordflow">continue</span>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Target idx %d is %s conn &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#abd4b7b7675c19f574aa3c3cd3a7f770f">LPX64</a><span class="stringliteral">&quot;\n&quot;</span>, i,
<a name="l00105"></a>00105                        tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#acf1dc5c8a8a7a1f6830bc680e5784a61" title="Export handle, it&amp;#39;s id is provided to client on connect Subsequent client RPCs...">exp_handle</a>.<a class="code" href="structportals__handle.html#a69a5ee95c5da23f07b14dc3fb6d1440c">h_cookie</a>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(uuid, &amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>))
<a name="l00108"></a>00108                         <span class="keywordflow">break</span>;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (i == lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>)
<a name="l00112"></a>00112                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_lmv_lock, rc = -EINVAL);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114         obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (obd == NULL)
<a name="l00116"></a>00116                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_lmv_lock, rc = -ENOTCONN);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Found OBD %s=%s device %d (%p) type %s at LMV idx %d\n&quot;</span>,
<a name="l00119"></a>00119                obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, obd-&gt;<a class="code" href="structobd__device.html#a69645841c4be6aee8aa88bc0ffcbf057">obd_minor</a>, obd,
<a name="l00120"></a>00120                obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, i);
<a name="l00121"></a>00121         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(strcmp(obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, <a class="code" href="obd_8h.html#a398c916a3d6d401d2e581d42deaffb45">LUSTRE_MDC_NAME</a>) == 0);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> == activate) {
<a name="l00124"></a>00124                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;OBD %p already %sactive!\n&quot;</span>, obd,
<a name="l00125"></a>00125                        activate ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;in&quot;</span>);
<a name="l00126"></a>00126                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_lmv_lock, rc);
<a name="l00127"></a>00127         }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Marking OBD %p %sactive\n&quot;</span>, obd,
<a name="l00130"></a>00130                activate ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;in&quot;</span>);
<a name="l00131"></a>00131         <a class="code" href="lmv__obd_8c.html#ac2c84bd171886ba98a55a62ae88e4491">lmv_activate_target</a>(lmv, tgt, activate);
<a name="l00132"></a>00132         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134  out_lmv_lock:
<a name="l00135"></a>00135         spin_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#abb7417932d14e6a68a6b7d8b81c18243">lmv_lock</a>);
<a name="l00136"></a>00136         <span class="keywordflow">return</span> rc;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="lmv__obd_8c.html#a4f4cbe72defaebbbd48d57c3e562dacf">00139</a> <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="lmv__obd_8c.html#a4f4cbe72defaebbbd48d57c3e562dacf">lmv_get_uuid</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00142"></a>00142         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         <span class="keywordflow">return</span> (tgt == NULL) ? NULL : <a class="code" href="obd__class_8h.html#acf88598b6c27dc41a5b48a8149355d2b">obd_get_uuid</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="lmv__obd_8c.html#aa869ce80b25cd9b74ed5f744408b6b9d">00147</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#aa869ce80b25cd9b74ed5f744408b6b9d">lmv_notify</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *watched,
<a name="l00148"></a>00148                       <span class="keyword">enum</span> <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5cc">obd_notify_event</a> ev, <span class="keywordtype">void</span> *data)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150         <span class="keyword">struct </span><a class="code" href="structobd__connect__data.html">obd_connect_data</a> *conn_data;
<a name="l00151"></a>00151         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00152"></a>00152         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>         *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>;
<a name="l00153"></a>00153         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00154"></a>00154         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (strcmp(watched-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, <a class="code" href="obd_8h.html#a398c916a3d6d401d2e581d42deaffb45">LUSTRE_MDC_NAME</a>)) {
<a name="l00157"></a>00157                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;unexpected notification of %s %s!\n&quot;</span>,
<a name="l00158"></a>00158                        watched-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>,
<a name="l00159"></a>00159                        watched-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00160"></a>00160                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         uuid = &amp;watched-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#aab14b15f2359afc1da23bbc47decdd0c">cli</a>.<a class="code" href="structclient__obd.html#ad3183ba07af6456a5af86b99dfbbec50">cl_target_uuid</a>;
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5ccafd10e8733cbcae6daabb8c53a416ac31">OBD_NOTIFY_ACTIVE</a> || ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5cca96dcec94855150f6c6492fb55ada45c1">OBD_NOTIFY_INACTIVE</a>) {
<a name="l00165"></a>00165                 <span class="comment">/*</span>
<a name="l00166"></a>00166 <span class="comment">                 * Set MDC as active before notifying the observer, so the</span>
<a name="l00167"></a>00167 <span class="comment">                 * observer can use the MDC normally.</span>
<a name="l00168"></a>00168 <span class="comment">                 */</span>
<a name="l00169"></a>00169                 rc = <a class="code" href="lmv__obd_8c.html#ad17784cf12bb923322ae1b6ba12e6942" title="Error codes:.">lmv_set_mdc_active</a>(lmv, uuid,
<a name="l00170"></a>00170                                         ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5ccafd10e8733cbcae6daabb8c53a416ac31">OBD_NOTIFY_ACTIVE</a>);
<a name="l00171"></a>00171                 <span class="keywordflow">if</span> (rc) {
<a name="l00172"></a>00172                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%sactivation of %s failed: %d\n&quot;</span>,
<a name="l00173"></a>00173                                ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5ccafd10e8733cbcae6daabb8c53a416ac31">OBD_NOTIFY_ACTIVE</a> ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;de&quot;</span>,
<a name="l00174"></a>00174                                uuid-&gt;<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, rc);
<a name="l00175"></a>00175                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00176"></a>00176                 }
<a name="l00177"></a>00177         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5cca02cfe4495895e6faea7c64b3f9877634">OBD_NOTIFY_OCD</a>) {
<a name="l00178"></a>00178                 conn_data = &amp;watched-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#aab14b15f2359afc1da23bbc47decdd0c">cli</a>.<a class="code" href="structclient__obd.html#ad5a950b3c1fd9c233f13bb9c505493e9">cl_import</a>-&gt;<a class="code" href="structobd__import.html#aa811a6418422d3a974c15908153f29ca">imp_connect_data</a>;
<a name="l00179"></a>00179                 <span class="comment">/*</span>
<a name="l00180"></a>00180 <span class="comment">                 * XXX: Make sure that ocd_connect_flags from all targets are</span>
<a name="l00181"></a>00181 <span class="comment">                 * the same. Otherwise one of MDTs runs wrong version or</span>
<a name="l00182"></a>00182 <span class="comment">                 * something like this.  --umka</span>
<a name="l00183"></a>00183 <span class="comment">                 */</span>
<a name="l00184"></a>00184                 obd-&gt;<a class="code" href="structobd__device.html#a11215b62af46c84584d2b3a7aa4e326e">obd_self_export</a>-&gt;<a class="code" href="structobd__export.html#a8955ea706fda03cf621ac71fc84d4b2f" title="Compatibility flags for this export are embedded into exp_connect_data.">exp_connect_data</a> = *conn_data;
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186 <span class="preprocessor">#if 0</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ev == <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5ccad413d8adce175920c7664844984ec447">OBD_NOTIFY_DISCON</a>) {
<a name="l00188"></a>00188                 <span class="comment">/*</span>
<a name="l00189"></a>00189 <span class="comment">                 * For disconnect event, flush fld cache for failout MDS case.</span>
<a name="l00190"></a>00190 <span class="comment">                 */</span>
<a name="l00191"></a>00191                 <a class="code" href="group__fld.html#ga8ef4db802ffc06e9f3e44185d6d75e0c">fld_client_flush</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a6a04fc1150ffd264c7540a08870eccc7">lmv_fld</a>);
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193 <span class="preprocessor">#endif</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>        <span class="comment">/*</span>
<a name="l00195"></a>00195 <span class="comment">         * Pass the notification up the chain.</span>
<a name="l00196"></a>00196 <span class="comment">         */</span>
<a name="l00197"></a>00197         <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="structobd__device.html#a87292fdbdd43290591328032624137e1">obd_observer</a>)
<a name="l00198"></a>00198                 rc = <a class="code" href="obd__class_8h.html#a78435b38bbe27a808d506a0ce2222e2d">obd_notify</a>(obd-&gt;<a class="code" href="structobd__device.html#a87292fdbdd43290591328032624137e1">obd_observer</a>, watched, ev, data);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00207"></a><a class="code" href="lmv__obd_8c.html#a3215b4f2832988ae74e314ebf87a9d06">00207</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a3215b4f2832988ae74e314ebf87a9d06" title="This is fake connect function.">lmv_connect</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00208"></a>00208                        <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> **exp, <span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd,
<a name="l00209"></a>00209                        <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *cluuid, <span class="keyword">struct</span> <a class="code" href="structobd__connect__data.html">obd_connect_data</a> *data,
<a name="l00210"></a>00210                        <span class="keywordtype">void</span> *localdata)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>        *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00213"></a>00213         <span class="keyword">struct </span><a class="code" href="structlustre__handle.html">lustre_handle</a>  conn = { 0 };
<a name="l00214"></a>00214         <span class="keywordtype">int</span>                    rc = 0;
<a name="l00215"></a>00215         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="comment">/*</span>
<a name="l00218"></a>00218 <span class="comment">         * We don&apos;t want to actually do the underlying connections more than</span>
<a name="l00219"></a>00219 <span class="comment">         * once, so keep track.</span>
<a name="l00220"></a>00220 <span class="comment">         */</span>
<a name="l00221"></a>00221         lmv-&gt;<a class="code" href="structlmv__obd.html#a0d4f1d2397e4ea3f75c39626943be65e">refcount</a>++;
<a name="l00222"></a>00222         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a0d4f1d2397e4ea3f75c39626943be65e">refcount</a> &gt; 1) {
<a name="l00223"></a>00223                 *exp = NULL;
<a name="l00224"></a>00224                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         rc = <a class="code" href="obd__class_8h.html#a56b23397280e75e63904a94a3bdf04ca">class_connect</a>(&amp;conn, obd, cluuid);
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (rc) {
<a name="l00229"></a>00229                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;class_connection() returned %d\n&quot;</span>, rc);
<a name="l00230"></a>00230                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         *exp = <a class="code" href="group__export.html#ga81cdb4586b1839c76ecdd5abb1eabe49">class_conn2export</a>(&amp;conn);
<a name="l00234"></a>00234         <a class="code" href="obd__class_8h.html#a6e46dd899223d141967fabba76d36bd8">class_export_get</a>(*exp);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         lmv-&gt;<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a> = *exp;
<a name="l00237"></a>00237         lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a> = 0;
<a name="l00238"></a>00238         lmv-&gt;<a class="code" href="structlmv__obd.html#a59c1f85316b740d7f323dc3c1cbf130a">cluuid</a> = *cluuid;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (data)
<a name="l00241"></a>00241                 lmv-&gt;<a class="code" href="structlmv__obd.html#acc3729452a57501e34c95a251e093e09">conn_data</a> = *data;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> == NULL) {
<a name="l00244"></a>00244                 lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> = <a class="code" href="lprocfs__status_8h.html#a706c7ec709abc61f28de92cbf08e78cf">lprocfs_register</a>(<span class="stringliteral">&quot;target_obds&quot;</span>,
<a name="l00245"></a>00245                                                            obd-&gt;<a class="code" href="structobd__device.html#a1be8ec6b61422e4cd9c2050efca4c82d">obd_proc_entry</a>,
<a name="l00246"></a>00246                                                            NULL, NULL);
<a name="l00247"></a>00247                 <span class="keywordflow">if</span> (IS_ERR(lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a>)) {
<a name="l00248"></a>00248                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: cannot register &quot;</span>
<a name="l00249"></a>00249                                <span class="stringliteral">&quot;/proc/fs/lustre/%s/%s/target_obds\n&quot;</span>,
<a name="l00250"></a>00250                                obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>,
<a name="l00251"></a>00251                                obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00252"></a>00252                         lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> = NULL;
<a name="l00253"></a>00253                 }
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">/*</span>
<a name="l00257"></a>00257 <span class="comment">         * All real clients should perform actual connection right away, because</span>
<a name="l00258"></a>00258 <span class="comment">         * it is possible, that LMV will not have opportunity to connect targets</span>
<a name="l00259"></a>00259 <span class="comment">         * and MDC stuff will be called directly, for instance while reading</span>
<a name="l00260"></a>00260 <span class="comment">         * ../mdc/../kbytesfree procfs file, etc.</span>
<a name="l00261"></a>00261 <span class="comment">         */</span>
<a name="l00262"></a>00262         <span class="keywordflow">if</span> (data != NULL &amp;&amp; (data-&gt;<a class="code" href="structobd__connect__data.html#a056d6aaded7f397e902843b52a36a6a5">ocd_connect_flags</a> &amp; <a class="code" href="group__lustreidl.html#gac4ab629b037b8ab7780299de8c8f4f22">OBD_CONNECT_REAL</a>))
<a name="l00263"></a>00263                 rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (rc &amp;&amp; lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> != NULL)
<a name="l00266"></a>00266                 <a class="code" href="lprocfs__status_8h.html#a64457b3c159bcc83be25b73908b966ee">lprocfs_remove</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a>);
<a name="l00267"></a>00267         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="lmv__obd_8c.html#affc5ccbd65650a05ba6a3ecf93f57695">00270</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#affc5ccbd65650a05ba6a3ecf93f57695">lmv_init_ea_size</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, __u32 easize,
<a name="l00271"></a>00271                             __u32 def_easize)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l00274"></a>00274         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00275"></a>00275         __u32                    i;
<a name="l00276"></a>00276         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00277"></a>00277         <span class="keywordtype">int</span>                      change = 0;
<a name="l00278"></a>00278         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#aaac72fbc304f3642bc23f233304e2fca">max_easize</a> &lt; easize) {
<a name="l00281"></a>00281                 lmv-&gt;<a class="code" href="structlmv__obd.html#aaac72fbc304f3642bc23f233304e2fca">max_easize</a> = easize;
<a name="l00282"></a>00282                 change = 1;
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a5519d50c84c91c59a6849a40ab55e8c5">max_def_easize</a> &lt; def_easize) {
<a name="l00285"></a>00285                 lmv-&gt;<a class="code" href="structlmv__obd.html#a5519d50c84c91c59a6849a40ab55e8c5">max_def_easize</a> = def_easize;
<a name="l00286"></a>00286                 change = 1;
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (change == 0)
<a name="l00290"></a>00290                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a> == 0)
<a name="l00293"></a>00293                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00296"></a>00296                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL || !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>) {
<a name="l00299"></a>00299                         <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%s: NULL export for %d\n&quot;</span>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, i);
<a name="l00300"></a>00300                         <span class="keywordflow">continue</span>;
<a name="l00301"></a>00301                 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                 rc = <a class="code" href="obd__class_8h.html#adc39280cdae2f3856a7817d35396d7fd">md_init_ea_size</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, easize, def_easize);
<a name="l00304"></a>00304                 <span class="keywordflow">if</span> (rc) {
<a name="l00305"></a>00305                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: obd_init_ea_size() failed on MDT target %d:&quot;</span>
<a name="l00306"></a>00306                                <span class="stringliteral">&quot; rc = %d\n&quot;</span>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, i, rc);
<a name="l00307"></a>00307                         <span class="keywordflow">break</span>;
<a name="l00308"></a>00308                 }
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="lmv__obd_8c.html#a220f38b26fa99d4d91b574f42d991516">00313</a> <span class="preprocessor">#define MAX_STRING_SIZE 128</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>
<a name="l00315"></a><a class="code" href="lmv__obd_8c.html#ad43125a1293c73669c2dd0766b896d77">00315</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad43125a1293c73669c2dd0766b896d77">lmv_connect_mdc</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00318"></a>00318         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>         *cluuid = &amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a59c1f85316b740d7f323dc3c1cbf130a">cluuid</a>;
<a name="l00319"></a>00319         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>          lmv_mdc_uuid = { <span class="stringliteral">&quot;LMV_MDC_UUID&quot;</span> };
<a name="l00320"></a>00320         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *mdc_obd;
<a name="l00321"></a>00321         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *mdc_exp;
<a name="l00322"></a>00322         <span class="keyword">struct </span><a class="code" href="structlu__fld__target.html">lu_fld_target</a>     target;
<a name="l00323"></a>00323         <span class="keywordtype">int</span>                      rc;
<a name="l00324"></a>00324         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         mdc_obd = <a class="code" href="obd__class_8h.html#a4940b8f1c4bbf3f104525f63b3ef73de">class_find_client_obd</a>(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>, <a class="code" href="obd_8h.html#a398c916a3d6d401d2e581d42deaffb45">LUSTRE_MDC_NAME</a>,
<a name="l00327"></a>00327                                         &amp;obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>);
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (!mdc_obd) {
<a name="l00329"></a>00329                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;target %s not attached\n&quot;</span>, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00330"></a>00330                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;connect to %s(%s) - %s, %s FOR %s\n&quot;</span>,
<a name="l00334"></a>00334                 mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, mdc_obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>,
<a name="l00335"></a>00335                 tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>,
<a name="l00336"></a>00336                 cluuid-&gt;<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (!mdc_obd-&gt;<a class="code" href="structobd__device.html#a9cd66ba26c20a39ed452ca59930b202d">obd_set_up</a>) {
<a name="l00339"></a>00339                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;target %s is not set up\n&quot;</span>, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00340"></a>00340                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         rc = <a class="code" href="obd__class_8h.html#a84a51083a59bfff6555ea8d48a86a0f4" title="Create a new /a exp on device /a obd for the uuid /a cluuid.">obd_connect</a>(NULL, &amp;mdc_exp, mdc_obd, &amp;lmv_mdc_uuid,
<a name="l00344"></a>00344                          &amp;lmv-&gt;<a class="code" href="structlmv__obd.html#acc3729452a57501e34c95a251e093e09">conn_data</a>, NULL);
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (rc) {
<a name="l00346"></a>00346                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;target %s connect error %d\n&quot;</span>, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, rc);
<a name="l00347"></a>00347                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         <span class="comment">/*</span>
<a name="l00351"></a>00351 <span class="comment">         * Init fid sequence client for this mdc and add new fld target.</span>
<a name="l00352"></a>00352 <span class="comment">         */</span>
<a name="l00353"></a>00353         rc = <a class="code" href="obd__class_8h.html#a55d14bf1574aa4372f20624a5f96b428">obd_fid_init</a>(mdc_obd, mdc_exp, <a class="code" href="group__fid.html#ggaa9fa6acab517d0fd39a7b1fadb344c97abf60b5e1d91ffa9dbfc482aae9486b68">LUSTRE_SEQ_METADATA</a>);
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (rc)
<a name="l00355"></a>00355                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         target.<a class="code" href="structlu__fld__target.html#aa0e0dfc11c811740a3cb6615a914dfcc">ft_srv</a> = NULL;
<a name="l00358"></a>00358         target.<a class="code" href="structlu__fld__target.html#aa97e69d1116962842077d869f6cee935">ft_exp</a> = mdc_exp;
<a name="l00359"></a>00359         target.<a class="code" href="structlu__fld__target.html#a8cb48512926935411cd8bdf86b9d5311">ft_idx</a> = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <a class="code" href="group__fld.html#ga658da85e5dc251dd63518c88d902dfcc">fld_client_add_target</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a6a04fc1150ffd264c7540a08870eccc7">lmv_fld</a>, &amp;target);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         rc = <a class="code" href="obd__class_8h.html#a1ea4749508957897f6b5531c48e86512">obd_register_observer</a>(mdc_obd, obd);
<a name="l00364"></a>00364         <span class="keywordflow">if</span> (rc) {
<a name="l00365"></a>00365                 <a class="code" href="obd__class_8h.html#ad85654fa90b63bedfe72444557aacd35">obd_disconnect</a>(mdc_exp);
<a name="l00366"></a>00366                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;target %s register_observer error %d\n&quot;</span>,
<a name="l00367"></a>00367                        tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, rc);
<a name="l00368"></a>00368                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="structobd__device.html#a87292fdbdd43290591328032624137e1">obd_observer</a>) {
<a name="l00372"></a>00372                 <span class="comment">/*</span>
<a name="l00373"></a>00373 <span class="comment">                 * Tell the observer about the new target.</span>
<a name="l00374"></a>00374 <span class="comment">                 */</span>
<a name="l00375"></a>00375                 rc = <a class="code" href="obd__class_8h.html#a78435b38bbe27a808d506a0ce2222e2d">obd_notify</a>(obd-&gt;<a class="code" href="structobd__device.html#a87292fdbdd43290591328032624137e1">obd_observer</a>, mdc_exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>,
<a name="l00376"></a>00376                                 <a class="code" href="obd_8h.html#a2edf5111b5e48090a5f07f11a420c5ccafd10e8733cbcae6daabb8c53a416ac31">OBD_NOTIFY_ACTIVE</a>,
<a name="l00377"></a>00377                                 (<span class="keywordtype">void</span> *)(tgt - lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0]));
<a name="l00378"></a>00378                 <span class="keywordflow">if</span> (rc) {
<a name="l00379"></a>00379                         <a class="code" href="obd__class_8h.html#ad85654fa90b63bedfe72444557aacd35">obd_disconnect</a>(mdc_exp);
<a name="l00380"></a>00380                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00381"></a>00381                 }
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> = 1;
<a name="l00385"></a>00385         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> = mdc_exp;
<a name="l00386"></a>00386         lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a1ba21704d398ca3271311f34748d440e">ld_active_tgt_count</a>++;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <a class="code" href="obd__class_8h.html#adc39280cdae2f3856a7817d35396d7fd">md_init_ea_size</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, lmv-&gt;<a class="code" href="structlmv__obd.html#aaac72fbc304f3642bc23f233304e2fca">max_easize</a>, lmv-&gt;<a class="code" href="structlmv__obd.html#a5519d50c84c91c59a6849a40ab55e8c5">max_def_easize</a>);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;Connected to %s(%s) successfully (%d)\n&quot;</span>,
<a name="l00391"></a>00391                 mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, mdc_obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>,
<a name="l00392"></a>00392                 atomic_read(&amp;obd-&gt;<a class="code" href="structobd__device.html#acc6174de79f0a969946a09f31a3636d6">obd_refcount</a>));
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> != NULL) {
<a name="l00395"></a>00395                 <span class="keyword">struct </span>proc_dir_entry *mdc_symlink;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mdc_obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a> != NULL);
<a name="l00398"></a>00398                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mdc_obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a> != NULL);
<a name="l00399"></a>00399                 mdc_symlink = <a class="code" href="lprocfs__status_8h.html#a343ca57d34496aac06c99f2a13fa417c">lprocfs_add_symlink</a>(mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00400"></a>00400                                                   lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a>,
<a name="l00401"></a>00401                                                   <span class="stringliteral">&quot;../../../%s/%s&quot;</span>,
<a name="l00402"></a>00402                                                   mdc_obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>,
<a name="l00403"></a>00403                                                   mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00404"></a>00404                 <span class="keywordflow">if</span> (mdc_symlink == NULL) {
<a name="l00405"></a>00405                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;cannot register LMV target &quot;</span>
<a name="l00406"></a>00406                                <span class="stringliteral">&quot;/proc/fs/lustre/%s/%s/target_obds/%s\n&quot;</span>,
<a name="l00407"></a>00407                                obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00408"></a>00408                                mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00409"></a>00409                 }
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="lmv__obd_8c.html#ac45ea27cc91f6e323e5e8536e5efc49a">00414</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lmv__obd_8c.html#ac45ea27cc91f6e323e5e8536e5efc49a">lmv_del_target</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keywordtype">int</span> index)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index] == NULL)
<a name="l00417"></a>00417                 <span class="keywordflow">return</span>;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index]);
<a name="l00420"></a>00420         lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index] = NULL;
<a name="l00421"></a>00421         <span class="keywordflow">return</span>;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="lmv__obd_8c.html#aad58b1e1b2c6cf6d6ef68e97e629809d">00424</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#aad58b1e1b2c6cf6d6ef68e97e629809d">lmv_add_target</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *uuidp,
<a name="l00425"></a>00425                            __u32 index, <span class="keywordtype">int</span> gen)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a> *mdc_obd;
<a name="l00428"></a>00428         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>      *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00429"></a>00429         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt;
<a name="l00430"></a>00430         <span class="keywordtype">int</span>                  orig_tgt_count = 0;
<a name="l00431"></a>00431         <span class="keywordtype">int</span>                  rc = 0;
<a name="l00432"></a>00432         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;Target uuid: %s. index %d\n&quot;</span>, uuidp-&gt;<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, index);
<a name="l00435"></a>00435         mdc_obd = <a class="code" href="obd__class_8h.html#a4940b8f1c4bbf3f104525f63b3ef73de">class_find_client_obd</a>(uuidp, <a class="code" href="obd_8h.html#a398c916a3d6d401d2e581d42deaffb45">LUSTRE_MDC_NAME</a>,
<a name="l00436"></a>00436                                         &amp;obd-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>);
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (!mdc_obd) {
<a name="l00438"></a>00438                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: Target %s not attached: rc = %d\n&quot;</span>,
<a name="l00439"></a>00439                        obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, uuidp-&gt;<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, -EINVAL);
<a name="l00440"></a>00440                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         mutex_lock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00444"></a>00444         <span class="keywordflow">if</span> ((index &lt; lmv-&gt;tgts_size) &amp;&amp; (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index] != NULL)) {
<a name="l00445"></a>00445                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index];
<a name="l00446"></a>00446                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: UUID %s already assigned at LOV target index %d:&quot;</span>
<a name="l00447"></a>00447                        <span class="stringliteral">&quot; rc = %d\n&quot;</span>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00448"></a>00448                        <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>), index, -EEXIST);
<a name="l00449"></a>00449                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00450"></a>00450                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EEXIST);
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (index &gt;= lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>) {
<a name="l00454"></a>00454                 <span class="comment">/* We need to reallocate the lmv target array. */</span>
<a name="l00455"></a>00455                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> **newtgts, **old = NULL;
<a name="l00456"></a>00456                 __u32 newsize = 1;
<a name="l00457"></a>00457                 __u32 oldsize = 0;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 <span class="keywordflow">while</span> (newsize &lt; index + 1)
<a name="l00460"></a>00460                         newsize = newsize &lt;&lt; 1;
<a name="l00461"></a>00461                 <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(newtgts, <span class="keyword">sizeof</span>(*newtgts) * newsize);
<a name="l00462"></a>00462                 <span class="keywordflow">if</span> (newtgts == NULL) {
<a name="l00463"></a>00463                         mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00464"></a>00464                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00465"></a>00465                 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>) {
<a name="l00468"></a>00468                         memcpy(newtgts, lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>,
<a name="l00469"></a>00469                                <span class="keyword">sizeof</span>(*newtgts) * lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>);
<a name="l00470"></a>00470                         old = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>;
<a name="l00471"></a>00471                         oldsize = lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>;
<a name="l00472"></a>00472                 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474                 lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a> = newtgts;
<a name="l00475"></a>00475                 lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a> = newsize;
<a name="l00476"></a>00476                 smp_rmb();
<a name="l00477"></a>00477                 <span class="keywordflow">if</span> (old)
<a name="l00478"></a>00478                         <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(old, <span class="keyword">sizeof</span>(*old) * oldsize);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;tgts: %p size: %d\n&quot;</span>, lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>,
<a name="l00481"></a>00481                        lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>);
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(tgt);
<a name="l00485"></a>00485         <span class="keywordflow">if</span> (!tgt) {
<a name="l00486"></a>00486                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00487"></a>00487                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00488"></a>00488         }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         mutex_init(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#ac20324135fb3bf41a54bdd4f6e6c9649">ltd_fid_mutex</a>);
<a name="l00491"></a>00491         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a> = index;
<a name="l00492"></a>00492         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a> = *uuidp;
<a name="l00493"></a>00493         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> = 0;
<a name="l00494"></a>00494         lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index] = tgt;
<a name="l00495"></a>00495         <span class="keywordflow">if</span> (index &gt;= lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>) {
<a name="l00496"></a>00496                 orig_tgt_count = lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>;
<a name="l00497"></a>00497                 lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> = index + 1;
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a> == 0) {
<a name="l00501"></a>00501                 <span class="comment">/* lmv_check_connect() will connect this target. */</span>
<a name="l00502"></a>00502                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00503"></a>00503                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="comment">/* Otherwise let&apos;s connect it ourselves */</span>
<a name="l00507"></a>00507         mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00508"></a>00508         rc = <a class="code" href="lmv__obd_8c.html#ad43125a1293c73669c2dd0766b896d77">lmv_connect_mdc</a>(obd, tgt);
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (rc != 0) {
<a name="l00510"></a>00510                 spin_lock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#abb7417932d14e6a68a6b7d8b81c18243">lmv_lock</a>);
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> == index + 1)
<a name="l00512"></a>00512                         lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> = orig_tgt_count;
<a name="l00513"></a>00513                 memset(tgt, 0, <span class="keyword">sizeof</span>(*tgt));
<a name="l00514"></a>00514                 spin_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#abb7417932d14e6a68a6b7d8b81c18243">lmv_lock</a>);
<a name="l00515"></a>00515         } <span class="keywordflow">else</span> {
<a name="l00516"></a>00516                 <span class="keywordtype">int</span> easize = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>) +
<a name="l00517"></a>00517                         lmv-&gt;desc.ld_tgt_count * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>);
<a name="l00518"></a>00518                 <a class="code" href="lmv__obd_8c.html#affc5ccbd65650a05ba6a3ecf93f57695">lmv_init_ea_size</a>(obd-&gt;<a class="code" href="structobd__device.html#a11215b62af46c84584d2b3a7aa4e326e">obd_self_export</a>, easize, 0);
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="lmv__obd_8c.html#a09085a484116271aa4133de80a41928c">00524</a> <span class="keywordtype">int</span> <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00527"></a>00527         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l00528"></a>00528         __u32                    i;
<a name="l00529"></a>00529         <span class="keywordtype">int</span>                      rc;
<a name="l00530"></a>00530         <span class="keywordtype">int</span>                      easize;
<a name="l00531"></a>00531         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a>)
<a name="l00534"></a>00534                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         mutex_lock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a>) {
<a name="l00538"></a>00538                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00539"></a>00539                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> == 0) {
<a name="l00543"></a>00543                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00544"></a>00544                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: no targets configured.\n&quot;</span>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00545"></a>00545                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a> != NULL);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0] == NULL) {
<a name="l00551"></a>00551                 mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00552"></a>00552                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: no target configured for index 0.\n&quot;</span>,
<a name="l00553"></a>00553                        obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00554"></a>00554                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00555"></a>00555         }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;Time to connect %s to %s\n&quot;</span>,
<a name="l00558"></a>00558                lmv-&gt;<a class="code" href="structlmv__obd.html#a59c1f85316b740d7f323dc3c1cbf130a">cluuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00561"></a>00561                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00562"></a>00562                 <span class="keywordflow">if</span> (tgt == NULL)
<a name="l00563"></a>00563                         <span class="keywordflow">continue</span>;
<a name="l00564"></a>00564                 rc = <a class="code" href="lmv__obd_8c.html#ad43125a1293c73669c2dd0766b896d77">lmv_connect_mdc</a>(obd, tgt);
<a name="l00565"></a>00565                 <span class="keywordflow">if</span> (rc)
<a name="l00566"></a>00566                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_disc, rc);
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>);
<a name="l00570"></a>00570         lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a> = 1;
<a name="l00571"></a>00571         easize = <a class="code" href="group__lustreidl.html#ga22c12dbd6667b2e09848a6888a119428">lmv_mds_md_size</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>, <a class="code" href="group__lustreidl.html#ga20b8ea4b222fe119e252112c4c571804">LMV_MAGIC</a>);
<a name="l00572"></a>00572         <a class="code" href="lmv__obd_8c.html#affc5ccbd65650a05ba6a3ecf93f57695">lmv_init_ea_size</a>(obd-&gt;<a class="code" href="structobd__device.html#a11215b62af46c84584d2b3a7aa4e326e">obd_self_export</a>, easize, 0);
<a name="l00573"></a>00573         mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00574"></a>00574         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576  out_disc:
<a name="l00577"></a>00577         <span class="keywordflow">while</span> (i-- &gt; 0) {
<a name="l00578"></a>00578                 <span class="keywordtype">int</span> rc2;
<a name="l00579"></a>00579                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00580"></a>00580                 <span class="keywordflow">if</span> (tgt == NULL)
<a name="l00581"></a>00581                         <span class="keywordflow">continue</span>;
<a name="l00582"></a>00582                 tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> = 0;
<a name="l00583"></a>00583                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>) {
<a name="l00584"></a>00584                         --lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a1ba21704d398ca3271311f34748d440e">ld_active_tgt_count</a>;
<a name="l00585"></a>00585                         rc2 = <a class="code" href="obd__class_8h.html#ad85654fa90b63bedfe72444557aacd35">obd_disconnect</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00586"></a>00586                         <span class="keywordflow">if</span> (rc2) {
<a name="l00587"></a>00587                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;LMV target %s disconnect on &quot;</span>
<a name="l00588"></a>00588                                        <span class="stringliteral">&quot;MDC idx %d: error %d\n&quot;</span>,
<a name="l00589"></a>00589                                        tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, i, rc2);
<a name="l00590"></a>00590                         }
<a name="l00591"></a>00591                 }
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593         <a class="code" href="obd__class_8h.html#a97b78eb1cab3cb45cda4d526a2492f18">class_disconnect</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>);
<a name="l00594"></a>00594         mutex_unlock(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l00595"></a>00595         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a><a class="code" href="lmv__obd_8c.html#a80a17896c9642144eff88f0306cdd965">00598</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a80a17896c9642144eff88f0306cdd965">lmv_disconnect_mdc</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt)
<a name="l00599"></a>00599 {
<a name="l00600"></a>00600         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>         *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00601"></a>00601         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>      *mdc_obd;
<a name="l00602"></a>00602         <span class="keywordtype">int</span>                     rc;
<a name="l00603"></a>00603         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt != NULL);
<a name="l00606"></a>00606         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(obd != NULL);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         mdc_obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (mdc_obd) {
<a name="l00611"></a>00611                 mdc_obd-&gt;<a class="code" href="structobd__device.html#a3aff50fa8cb3fddc091671df5c5f9204">obd_force</a> = obd-&gt;<a class="code" href="structobd__device.html#a3aff50fa8cb3fddc091671df5c5f9204">obd_force</a>;
<a name="l00612"></a>00612                 mdc_obd-&gt;<a class="code" href="structobd__device.html#a32c7ae5a6d0fe19f36cd1986b7808990">obd_fail</a> = obd-&gt;<a class="code" href="structobd__device.html#a32c7ae5a6d0fe19f36cd1986b7808990">obd_fail</a>;
<a name="l00613"></a>00613                 mdc_obd-&gt;<a class="code" href="structobd__device.html#a461351cdb8e71bba07fa74da274cf4e6">obd_no_recov</a> = obd-&gt;<a class="code" href="structobd__device.html#a461351cdb8e71bba07fa74da274cf4e6">obd_no_recov</a>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> != NULL)
<a name="l00616"></a>00616                         <a class="code" href="lprocfs__status_8h.html#a1680f2f845838562a376c659699dceaf">lprocfs_remove_proc_entry</a>(mdc_obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00617"></a>00617                                                   lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a>);
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         rc = <a class="code" href="obd__class_8h.html#a61cf75bc3be905c11ce204b9deba0898">obd_fid_fini</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>);
<a name="l00621"></a>00621         <span class="keywordflow">if</span> (rc)
<a name="l00622"></a>00622                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Can&apos;t finanize fids factory\n&quot;</span>);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Disconnected from %s(%s) successfully\n&quot;</span>,
<a name="l00625"></a>00625                tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00626"></a>00626                tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a73f149cd166bf2e6ffe0f23a27591596">obd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         <a class="code" href="obd__class_8h.html#a1ea4749508957897f6b5531c48e86512">obd_register_observer</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>, NULL);
<a name="l00629"></a>00629         rc = <a class="code" href="obd__class_8h.html#ad85654fa90b63bedfe72444557aacd35">obd_disconnect</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00630"></a>00630         <span class="keywordflow">if</span> (rc) {
<a name="l00631"></a>00631                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>) {
<a name="l00632"></a>00632                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Target %s disconnect error %d\n&quot;</span>,
<a name="l00633"></a>00633                                tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, rc);
<a name="l00634"></a>00634                 }
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <a class="code" href="lmv__obd_8c.html#ac2c84bd171886ba98a55a62ae88e4491">lmv_activate_target</a>(lmv, tgt, 0);
<a name="l00638"></a>00638         tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> = NULL;
<a name="l00639"></a>00639         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a><a class="code" href="lmv__obd_8c.html#a8a025411eda85113b175add2a8b31199">00642</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a8a025411eda85113b175add2a8b31199">lmv_disconnect</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp)
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l00645"></a>00645         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00646"></a>00646         <span class="keywordtype">int</span>                      rc;
<a name="l00647"></a>00647         __u32                    i;
<a name="l00648"></a>00648         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="keywordflow">if</span> (!lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>)
<a name="l00651"></a>00651                 <span class="keywordflow">goto</span> out_local;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <span class="comment">/*</span>
<a name="l00654"></a>00654 <span class="comment">         * Only disconnect the underlying layers on the final disconnect.</span>
<a name="l00655"></a>00655 <span class="comment">         */</span>
<a name="l00656"></a>00656         lmv-&gt;<a class="code" href="structlmv__obd.html#a0d4f1d2397e4ea3f75c39626943be65e">refcount</a>--;
<a name="l00657"></a>00657         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a0d4f1d2397e4ea3f75c39626943be65e">refcount</a> != 0)
<a name="l00658"></a>00658                 <span class="keywordflow">goto</span> out_local;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00661"></a>00661                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i] == NULL || lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00662"></a>00662                         <span class="keywordflow">continue</span>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                 <a class="code" href="lmv__obd_8c.html#a80a17896c9642144eff88f0306cdd965">lmv_disconnect_mdc</a>(obd, lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]);
<a name="l00665"></a>00665         }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a> != NULL)
<a name="l00668"></a>00668                 <a class="code" href="lprocfs__status_8h.html#a64457b3c159bcc83be25b73908b966ee">lprocfs_remove</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#aeb2510307fca3808029987de95b5f6f1">targets_proc_entry</a>);
<a name="l00669"></a>00669         <span class="keywordflow">else</span>
<a name="l00670"></a>00670                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;/proc/fs/lustre/%s/%s/target_obds missing\n&quot;</span>,
<a name="l00671"></a>00671                        obd-&gt;<a class="code" href="structobd__device.html#a12f24300000bfbce9cdd752a638c0760">obd_type</a>-&gt;<a class="code" href="structobd__type.html#a43bd9bff60d57948dd0db78df194e7fb">typ_name</a>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 out_local:
<a name="l00674"></a>00674         <span class="comment">/*</span>
<a name="l00675"></a>00675 <span class="comment">         * This is the case when no real connection is established by</span>
<a name="l00676"></a>00676 <span class="comment">         * lmv_check_connect().</span>
<a name="l00677"></a>00677 <span class="comment">         */</span>
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (!lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a>)
<a name="l00679"></a>00679                 <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(exp);
<a name="l00680"></a>00680         rc = <a class="code" href="obd__class_8h.html#a97b78eb1cab3cb45cda4d526a2492f18">class_disconnect</a>(exp);
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a0d4f1d2397e4ea3f75c39626943be65e">refcount</a> == 0)
<a name="l00682"></a>00682                 lmv-&gt;<a class="code" href="structlmv__obd.html#a6d652e5945299783fb34f49c8ce45d49">connected</a> = 0;
<a name="l00683"></a>00683         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="lmv__obd_8c.html#a8cefc49b3fa55881bc63b08f9366976e">00686</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a8cefc49b3fa55881bc63b08f9366976e">lmv_fid2path</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keywordtype">int</span> len, <span class="keywordtype">void</span> *karg,
<a name="l00687"></a>00687                         <span class="keywordtype">void</span> <a class="code" href="ioctl_8h.html#ace6f17999da4ea3b93c4227beafcab95">__user</a> *uarg)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obddev = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l00690"></a>00690         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obddev-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00691"></a>00691         <span class="keyword">struct </span><a class="code" href="structgetinfo__fid2path.html" title="fid2path request/reply structure">getinfo_fid2path</a> *gf;
<a name="l00692"></a>00692         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l00693"></a>00693         <span class="keyword">struct </span><a class="code" href="structgetinfo__fid2path.html" title="fid2path request/reply structure">getinfo_fid2path</a> *remote_gf = NULL;
<a name="l00694"></a>00694         <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>           root_fid;
<a name="l00695"></a>00695         <span class="keywordtype">int</span>                     remote_gf_size = 0;
<a name="l00696"></a>00696         <span class="keywordtype">int</span>                     rc;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698         gf = karg;
<a name="l00699"></a>00699         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>);
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l00701"></a>00701                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l00702"></a>00702 
<a name="l00703"></a>00703         root_fid = *gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a0e9084ccd95a96befd600a3e175d515e">gf_root_fid</a>;
<a name="l00704"></a>00704         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;root_fid));
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 repeat_fid2path:
<a name="l00707"></a>00707         rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(<a class="code" href="lustre__ioctl_8h.html#af5ae6ba81e124503755b965718fda664">OBD_IOC_FID2PATH</a>, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, gf, uarg);
<a name="l00708"></a>00708         <span class="keywordflow">if</span> (rc != 0 &amp;&amp; rc != -EREMOTE)
<a name="l00709"></a>00709                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="comment">/* If remote_gf != NULL, it means just building the</span>
<a name="l00712"></a>00712 <span class="comment">         * path on the remote MDT, copy this path segement to gf */</span>
<a name="l00713"></a>00713         <span class="keywordflow">if</span> (remote_gf != NULL) {
<a name="l00714"></a>00714                 <span class="keyword">struct </span><a class="code" href="structgetinfo__fid2path.html" title="fid2path request/reply structure">getinfo_fid2path</a> *ori_gf;
<a name="l00715"></a>00715                 <span class="keywordtype">char</span> *ptr;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717                 ori_gf = (<span class="keyword">struct </span><a class="code" href="structgetinfo__fid2path.html" title="fid2path request/reply structure">getinfo_fid2path</a> *)karg;
<a name="l00718"></a>00718                 <span class="keywordflow">if</span> (strlen(ori_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>) +
<a name="l00719"></a>00719                     strlen(gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>) &gt; ori_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a9b07b0a2629b838040d0ff7fbac7327a">gf_pathlen</a>)
<a name="l00720"></a>00720                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc = -EOVERFLOW);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722                 ptr = ori_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724                 memmove(ptr + strlen(gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>) + 1, ptr,
<a name="l00725"></a>00725                         strlen(ori_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>));
<a name="l00726"></a>00726 
<a name="l00727"></a>00727                 strncpy(ptr, gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>,
<a name="l00728"></a>00728                         strlen(gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>));
<a name="l00729"></a>00729                 ptr += strlen(gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>);
<a name="l00730"></a>00730                 *ptr = <span class="charliteral">&apos;/&apos;</span>;
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s: get path %s &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; rec: &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; ln: %u\n&quot;</span>,
<a name="l00734"></a>00734                tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00735"></a>00735                gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>), gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a76ec44d74a921af7b166cae9d52e71d9">gf_recno</a>,
<a name="l00736"></a>00736                gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a31947c9d34b99725767abcb2eb2f8b21">gf_linkno</a>);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (rc == 0)
<a name="l00739"></a>00739                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <span class="comment">/* sigh, has to go to another MDT to do path building further */</span>
<a name="l00742"></a>00742         <span class="keywordflow">if</span> (remote_gf == NULL) {
<a name="l00743"></a>00743                 remote_gf_size = <span class="keyword">sizeof</span>(*remote_gf) + PATH_MAX;
<a name="l00744"></a>00744                 <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(remote_gf, remote_gf_size);
<a name="l00745"></a>00745                 <span class="keywordflow">if</span> (remote_gf == NULL)
<a name="l00746"></a>00746                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc = -ENOMEM);
<a name="l00747"></a>00747                 remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a9b07b0a2629b838040d0ff7fbac7327a">gf_pathlen</a> = PATH_MAX;
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (!<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>)) {
<a name="l00751"></a>00751                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: invalid FID &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>,
<a name="l00752"></a>00752                        tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00753"></a>00753                        <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>), -EINVAL);
<a name="l00754"></a>00754                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc = -EINVAL);
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>);
<a name="l00758"></a>00758         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l00759"></a>00759                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_fid2path, rc = -EINVAL);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a> = gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a3778ddcb31f669c84c9165a425671fa9">gf_fid</a>;
<a name="l00762"></a>00762         remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a76ec44d74a921af7b166cae9d52e71d9">gf_recno</a> = -1;
<a name="l00763"></a>00763         remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a31947c9d34b99725767abcb2eb2f8b21">gf_linkno</a> = -1;
<a name="l00764"></a>00764         memset(remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a2db548ec5d43f22cd8510bf212662713">gf_path</a>, 0, remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#a9b07b0a2629b838040d0ff7fbac7327a">gf_pathlen</a>);
<a name="l00765"></a>00765         *remote_gf-&gt;<a class="code" href="structgetinfo__fid2path.html#afc20bdbe4bf31576ca10fc0ad6a7e8e9">gf_u</a>.<a class="code" href="structgetinfo__fid2path.html#a0e9084ccd95a96befd600a3e175d515e">gf_root_fid</a> = root_fid;
<a name="l00766"></a>00766         gf = remote_gf;
<a name="l00767"></a>00767         <span class="keywordflow">goto</span> repeat_fid2path;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 out_fid2path:
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (remote_gf != NULL)
<a name="l00771"></a>00771                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(remote_gf, remote_gf_size);
<a name="l00772"></a>00772         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a><a class="code" href="lmv__obd_8c.html#ad9c4b4baef1afc86a2a3ca98bef3640e">00775</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad9c4b4baef1afc86a2a3ca98bef3640e">lmv_hsm_req_count</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv,
<a name="l00776"></a>00776                              <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structhsm__user__request.html">hsm_user_request</a> *hur,
<a name="l00777"></a>00777                              <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt_mds)
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779         __u32                    i;
<a name="l00780"></a>00780         <span class="keywordtype">int</span>                      nr = 0;
<a name="l00781"></a>00781         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *curr_tgt;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <span class="comment">/* count how many requests must be sent to the given target */</span>
<a name="l00784"></a>00784         <span class="keywordflow">for</span> (i = 0; i &lt; hur-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a467c984247c432b699ffc5926f6fa73e">hr_itemcount</a>; i++) {
<a name="l00785"></a>00785                 curr_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;hur-&gt;<a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[i].<a class="code" href="structhsm__user__item.html#a2d396fe913229ba8e3c594823b7b94e5">hui_fid</a>);
<a name="l00786"></a>00786                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;curr_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>, &amp;tgt_mds-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>))
<a name="l00787"></a>00787                         nr++;
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789         <span class="keywordflow">return</span> nr;
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a><a class="code" href="lmv__obd_8c.html#a4609a6f2df6370ae19bce78b6f42ad8c">00792</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lmv__obd_8c.html#a4609a6f2df6370ae19bce78b6f42ad8c">lmv_hsm_req_build</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv,
<a name="l00793"></a>00793                               <span class="keyword">struct</span> <a class="code" href="structhsm__user__request.html">hsm_user_request</a> *hur_in,
<a name="l00794"></a>00794                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt_mds,
<a name="l00795"></a>00795                               <span class="keyword">struct</span> <a class="code" href="structhsm__user__request.html">hsm_user_request</a> *hur_out)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797         __u32                    i, nr_out;
<a name="l00798"></a>00798         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *curr_tgt;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="comment">/* build the hsm_user_request for the given target */</span>
<a name="l00801"></a>00801         hur_out-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a> = hur_in-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>;
<a name="l00802"></a>00802         nr_out = 0;
<a name="l00803"></a>00803         <span class="keywordflow">for</span> (i = 0; i &lt; hur_in-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a467c984247c432b699ffc5926f6fa73e">hr_itemcount</a>; i++) {
<a name="l00804"></a>00804                 curr_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv,
<a name="l00805"></a>00805                                            &amp;hur_in-&gt;<a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[i].<a class="code" href="structhsm__user__item.html#a2d396fe913229ba8e3c594823b7b94e5">hui_fid</a>);
<a name="l00806"></a>00806                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;curr_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>, &amp;tgt_mds-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>)) {
<a name="l00807"></a>00807                         hur_out-&gt;<a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[nr_out] =
<a name="l00808"></a>00808                                                 hur_in-&gt;<a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[i];
<a name="l00809"></a>00809                         nr_out++;
<a name="l00810"></a>00810                 }
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         hur_out-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a467c984247c432b699ffc5926f6fa73e">hr_itemcount</a> = nr_out;
<a name="l00813"></a>00813         memcpy(<a class="code" href="group__lustreuser.html#ga0785c563d1ec17a55bc55d33dec53e0a" title="Return pointer to data field in a hsm user request.">hur_data</a>(hur_out), <a class="code" href="group__lustreuser.html#ga0785c563d1ec17a55bc55d33dec53e0a" title="Return pointer to data field in a hsm user request.">hur_data</a>(hur_in),
<a name="l00814"></a>00814                hur_in-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a029be1d934a91b465fe970481cdebc95">hr_data_len</a>);
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a><a class="code" href="lmv__obd_8c.html#a6e2141ccabf84032f49c16470e2d1b11">00817</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a6e2141ccabf84032f49c16470e2d1b11">lmv_hsm_ct_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mdsrate_8c.html#a7353cae57e2530c316ddacb27ef14932">cmd</a>, <span class="keywordtype">int</span> len,
<a name="l00818"></a>00818                                  <span class="keyword">struct</span> <a class="code" href="structlustre__kernelcomm.html">lustre_kernelcomm</a> *lk,
<a name="l00819"></a>00819                                  <span class="keywordtype">void</span> <a class="code" href="ioctl_8h.html#ace6f17999da4ea3b93c4227beafcab95">__user</a> *uarg)
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821         __u32   i;
<a name="l00822"></a>00822         <span class="keywordtype">int</span>     rc;
<a name="l00823"></a>00823         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         <span class="comment">/* unregister request (call from llapi_hsm_copytool_fini) */</span>
<a name="l00826"></a>00826         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00827"></a>00827                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00828"></a>00828 
<a name="l00829"></a>00829                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00830"></a>00830                         <span class="keywordflow">continue</span>;
<a name="l00831"></a>00831                 <span class="comment">/* best effort: try to clean as much as possible</span>
<a name="l00832"></a>00832 <span class="comment">                 * (continue on error) */</span>
<a name="l00833"></a>00833                 <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, lk, uarg);
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         <span class="comment">/* Whatever the result, remove copytool from kuc groups.</span>
<a name="l00837"></a>00837 <span class="comment">         * Unreached coordinators will get EPIPE on next requests</span>
<a name="l00838"></a>00838 <span class="comment">         * and will unregister automatically.</span>
<a name="l00839"></a>00839 <span class="comment">         */</span>
<a name="l00840"></a>00840         rc = <a class="code" href="lustre__kernelcomm_8h.html#ae2dee6d3dd3c08dad8d3dde1cb17574d">libcfs_kkuc_group_rem</a>(lk-&gt;<a class="code" href="structlustre__kernelcomm.html#ae0954b8663962152b724506dc077005c">lk_uid</a>, lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a6dea47080ed8cb8f4790eb70ecc575af">lk_group</a>);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00845"></a><a class="code" href="lmv__obd_8c.html#a912145721e1263885704291a2147f9d1">00845</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a912145721e1263885704291a2147f9d1">lmv_hsm_ct_register</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mdsrate_8c.html#a7353cae57e2530c316ddacb27ef14932">cmd</a>, <span class="keywordtype">int</span> len,
<a name="l00846"></a>00846                                <span class="keyword">struct</span> <a class="code" href="structlustre__kernelcomm.html">lustre_kernelcomm</a> *lk, <a class="code" href="ioctl_8h.html#ace6f17999da4ea3b93c4227beafcab95">__user</a> <span class="keywordtype">void</span> *uarg)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848         <span class="keyword">struct </span>file             *filp;
<a name="l00849"></a>00849         __u32                    i, j;
<a name="l00850"></a>00850         <span class="keywordtype">int</span>                      err, rc;
<a name="l00851"></a>00851         <span class="keywordtype">bool</span>                     any_set = <span class="keyword">false</span>;
<a name="l00852"></a>00852         <span class="keyword">struct </span><a class="code" href="structkkuc__ct__data.html">kkuc_ct_data</a>      kcd = { 0 };
<a name="l00853"></a>00853         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855         <span class="comment">/* All or nothing: try to register to all MDS.</span>
<a name="l00856"></a>00856 <span class="comment">         * In case of failure, unregister from previous MDS,</span>
<a name="l00857"></a>00857 <span class="comment">         * except if it because of inactive target. */</span>
<a name="l00858"></a>00858         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l00859"></a>00859                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00860"></a>00860 
<a name="l00861"></a>00861                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00862"></a>00862                         <span class="keywordflow">continue</span>;
<a name="l00863"></a>00863                 err = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, lk, uarg);
<a name="l00864"></a>00864                 <span class="keywordflow">if</span> (err) {
<a name="l00865"></a>00865                         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>) {
<a name="l00866"></a>00866                                 <span class="comment">/* permanent error */</span>
<a name="l00867"></a>00867                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: iocontrol MDC %s on MDT&quot;</span>
<a name="l00868"></a>00868                                        <span class="stringliteral">&quot; idx %d cmd %x: err = %d\n&quot;</span>,
<a name="l00869"></a>00869                                        <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>)-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00870"></a>00870                                        tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, i, cmd, err);
<a name="l00871"></a>00871                                 rc = err;
<a name="l00872"></a>00872                                 lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a770faaa7f65d5928932bb3377743b075">lk_flags</a> |= <a class="code" href="uapi__kernelcomm_8h.html#a9a3db3120fec219c9bc955ad7ccc0048">LK_FLG_STOP</a>;
<a name="l00873"></a>00873                                 <span class="comment">/* unregister from previous MDS */</span>
<a name="l00874"></a>00874                                 <span class="keywordflow">for</span> (j = 0; j &lt; i; j++) {
<a name="l00875"></a>00875                                         tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[j];
<a name="l00876"></a>00876                                         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00877"></a>00877                                                 <span class="keywordflow">continue</span>;
<a name="l00878"></a>00878                                         <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len,
<a name="l00879"></a>00879                                                       lk, uarg);
<a name="l00880"></a>00880                                 }
<a name="l00881"></a>00881                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00882"></a>00882                         }
<a name="l00883"></a>00883                         <span class="comment">/* else: transient error.</span>
<a name="l00884"></a>00884 <span class="comment">                         * kuc will register to the missing MDT</span>
<a name="l00885"></a>00885 <span class="comment">                         * when it is back */</span>
<a name="l00886"></a>00886                 } <span class="keywordflow">else</span> {
<a name="l00887"></a>00887                         any_set = <span class="keyword">true</span>;
<a name="l00888"></a>00888                 }
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         <span class="keywordflow">if</span> (!any_set)
<a name="l00892"></a>00892                 <span class="comment">/* no registration done: return error */</span>
<a name="l00893"></a>00893                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOTCONN);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         <span class="comment">/* at least one registration done, with no failure */</span>
<a name="l00896"></a>00896         filp = fget(lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a861ad4d978f2dc100f66d109a97bac8a">lk_wfd</a>);
<a name="l00897"></a>00897         <span class="keywordflow">if</span> (filp == NULL)
<a name="l00898"></a>00898                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EBADF);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900         kcd.<a class="code" href="structkkuc__ct__data.html#adb090d3e981e17d21b8e3936c1a336a8">kcd_magic</a> = <a class="code" href="group__export.html#ga9669ae433048c093ff6fde5ce211b7c0">KKUC_CT_DATA_MAGIC</a>;
<a name="l00901"></a>00901         kcd.<a class="code" href="structkkuc__ct__data.html#a870345b83d5d400b9807a44edc845721">kcd_uuid</a> = lmv-&gt;<a class="code" href="structlmv__obd.html#a59c1f85316b740d7f323dc3c1cbf130a">cluuid</a>;
<a name="l00902"></a>00902         kcd.<a class="code" href="structkkuc__ct__data.html#a5b8947dcd4cefc14cdefbc2d15b69ae7">kcd_archive</a> = lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a918d3d6723c431e3f32f996e05dc858e">lk_data</a>;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904         rc = <a class="code" href="lustre__kernelcomm_8h.html#a95dd3eddab9c126eb422f9565b6e5a33" title="Add a receiver to a broadcast group.">libcfs_kkuc_group_add</a>(filp, lk-&gt;<a class="code" href="structlustre__kernelcomm.html#ae0954b8663962152b724506dc077005c">lk_uid</a>, lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a6dea47080ed8cb8f4790eb70ecc575af">lk_group</a>,
<a name="l00905"></a>00905                                    &amp;kcd, <span class="keyword">sizeof</span>(kcd));
<a name="l00906"></a>00906         <span class="keywordflow">if</span> (rc != 0)
<a name="l00907"></a>00907                 fput(filp);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 
<a name="l00915"></a><a class="code" href="lmv__obd_8c.html#a1bc406e83f291f9544100be23621337d">00915</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a1bc406e83f291f9544100be23621337d">lmv_iocontrol</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mdsrate_8c.html#a7353cae57e2530c316ddacb27ef14932">cmd</a>, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l00916"></a>00916                          <span class="keywordtype">int</span> len, <span class="keywordtype">void</span> *karg, <span class="keywordtype">void</span> <a class="code" href="ioctl_8h.html#ace6f17999da4ea3b93c4227beafcab95">__user</a> *uarg)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obddev = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l00919"></a>00919         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obddev-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l00920"></a>00920         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = NULL;
<a name="l00921"></a>00921         __u32                    i = 0;
<a name="l00922"></a>00922         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00923"></a>00923         <span class="keywordtype">int</span>                      <span class="keyword">set</span> = 0;
<a name="l00924"></a>00924         __u32                    count = lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>;
<a name="l00925"></a>00925         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         <span class="keywordflow">if</span> (count == 0)
<a name="l00928"></a>00928                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOTTY);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930         <span class="keywordflow">switch</span> (cmd) {
<a name="l00931"></a>00931         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga1ecdfaccbc2208f6123c288f87506957">IOC_OBD_STATFS</a>: {
<a name="l00932"></a>00932                 <span class="keyword">struct </span><a class="code" href="structobd__ioctl__data.html">obd_ioctl_data</a> *data = karg;
<a name="l00933"></a>00933                 <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a> *mdc_obd;
<a name="l00934"></a>00934                 <span class="keyword">struct </span><a class="code" href="structobd__statfs.html">obd_statfs</a> stat_buf = {0};
<a name="l00935"></a>00935                 __u32 index;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937                 memcpy(&amp;index, data-&gt;<a class="code" href="structobd__ioctl__data.html#a67e99fcc246c8ecc74751de47555e97d">ioc_inlbuf2</a>, <span class="keyword">sizeof</span>(__u32));
<a name="l00938"></a>00938                 <span class="keywordflow">if</span> ((index &gt;= count))
<a name="l00939"></a>00939                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODEV);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[index];
<a name="l00942"></a>00942                 <span class="keywordflow">if</span> (tgt == NULL || !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>)
<a name="l00943"></a>00943                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODATA);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                 mdc_obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l00946"></a>00946                 <span class="keywordflow">if</span> (!mdc_obd)
<a name="l00947"></a>00947                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949                 <span class="comment">/* copy UUID */</span>
<a name="l00950"></a>00950                 <span class="keywordflow">if</span> (copy_to_user(data-&gt;<a class="code" href="structobd__ioctl__data.html#a809237165059fea647cb62d47ade964e">ioc_pbuf2</a>, <a class="code" href="obd_8h.html#a2f78844a2990c9d3de540a098f26264e">obd2cli_tgt</a>(mdc_obd),
<a name="l00951"></a>00951                                  min((<span class="keywordtype">int</span>) data-&gt;<a class="code" href="structobd__ioctl__data.html#afaa85cb0237217c089b91358e7bd1982">ioc_plen2</a>,
<a name="l00952"></a>00952                                      (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a>))))
<a name="l00953"></a>00953                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EFAULT);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955                 rc = <a class="code" href="obd__class_8h.html#ae3a5208e13b939f2e10136ab85bfe06d">obd_statfs</a>(NULL, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, &amp;stat_buf,
<a name="l00956"></a>00956                                 <a class="code" href="linux-time_8h.html#a393d812fd7b8e405c04bc45e4cbe13e2">cfs_time_shift_64</a>(-<a class="code" href="obd_8h.html#aa4599266fbff3d46d087ece4abef9a56">OBD_STATFS_CACHE_SECONDS</a>),
<a name="l00957"></a>00957                                 0);
<a name="l00958"></a>00958                 <span class="keywordflow">if</span> (rc)
<a name="l00959"></a>00959                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00960"></a>00960                 <span class="keywordflow">if</span> (copy_to_user(data-&gt;<a class="code" href="structobd__ioctl__data.html#ac3af4b9d4642abda41f705c3a34972a7">ioc_pbuf1</a>, &amp;stat_buf,
<a name="l00961"></a>00961                                  min((<span class="keywordtype">int</span>) data-&gt;<a class="code" href="structobd__ioctl__data.html#a5e5f2011b383d2a2e67e000f704020f3">ioc_plen1</a>,
<a name="l00962"></a>00962                                      (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(stat_buf))))
<a name="l00963"></a>00963                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EFAULT);
<a name="l00964"></a>00964                 <span class="keywordflow">break</span>;
<a name="l00965"></a>00965         }
<a name="l00966"></a>00966         <span class="keywordflow">case</span> <a class="code" href="lustre__ioctl_8h.html#a82467eb4729836808b9ea60a1d32a755">OBD_IOC_QUOTACTL</a>: {
<a name="l00967"></a>00967                 <span class="keyword">struct </span><a class="code" href="structif__quotactl.html">if_quotactl</a> *qctl = karg;
<a name="l00968"></a>00968                 <span class="keyword">struct </span><a class="code" href="structobd__quotactl.html">obd_quotactl</a> *oqctl;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970                 <span class="keywordflow">if</span> (qctl-&gt;<a class="code" href="structif__quotactl.html#a87dc0d741c73cde196715bdb76e112e6">qc_valid</a> == <a class="code" href="group__lustreuser.html#gga458e651af6690959efa2afb96be7d609aa7da3a55affababd97f6340ab65297b3">QC_MDTIDX</a>) {
<a name="l00971"></a>00971                         <span class="keywordflow">if</span> (count &lt;= qctl-&gt;qc_idx)
<a name="l00972"></a>00972                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974                         tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[qctl-&gt;<a class="code" href="structif__quotactl.html#a475a3dd42a1e084819df1da84fcc6211">qc_idx</a>];
<a name="l00975"></a>00975                         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00976"></a>00976                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00977"></a>00977                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qctl-&gt;<a class="code" href="structif__quotactl.html#a87dc0d741c73cde196715bdb76e112e6">qc_valid</a> == <a class="code" href="group__lustreuser.html#gga458e651af6690959efa2afb96be7d609ab1f6d7acde184200af0013ef1560a13a">QC_UUID</a>) {
<a name="l00978"></a>00978                         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l00979"></a>00979                                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l00980"></a>00980                                 <span class="keywordflow">if</span> (tgt == NULL)
<a name="l00981"></a>00981                                         <span class="keywordflow">continue</span>;
<a name="l00982"></a>00982                                 <span class="keywordflow">if</span> (!<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>,
<a name="l00983"></a>00983                                                      &amp;qctl-&gt;<a class="code" href="structif__quotactl.html#ac655440c7d009b98beb041657f05d74d">obd_uuid</a>))
<a name="l00984"></a>00984                                         <span class="keywordflow">continue</span>;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986                                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l00987"></a>00987                                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989                                 <span class="keywordflow">break</span>;
<a name="l00990"></a>00990                         }
<a name="l00991"></a>00991                 } <span class="keywordflow">else</span> {
<a name="l00992"></a>00992                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00993"></a>00993                 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995                 <span class="keywordflow">if</span> (i &gt;= count)
<a name="l00996"></a>00996                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EAGAIN);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(tgt != NULL &amp;&amp; tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> != NULL);
<a name="l00999"></a>00999                 <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(oqctl);
<a name="l01000"></a>01000                 <span class="keywordflow">if</span> (!oqctl)
<a name="l01001"></a>01001                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01002"></a>01002 
<a name="l01003"></a>01003                 <a class="code" href="group__lustreidl.html#ga0031301a60f0ef1ea828048716af4b53">QCTL_COPY</a>(oqctl, qctl);
<a name="l01004"></a>01004                 rc = <a class="code" href="obd__class_8h.html#a0c83ffae83466db4a350e58e4c4f728a">obd_quotactl</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, oqctl);
<a name="l01005"></a>01005                 <span class="keywordflow">if</span> (rc == 0) {
<a name="l01006"></a>01006                         <a class="code" href="group__lustreidl.html#ga0031301a60f0ef1ea828048716af4b53">QCTL_COPY</a>(qctl, oqctl);
<a name="l01007"></a>01007                         qctl-&gt;<a class="code" href="structif__quotactl.html#a87dc0d741c73cde196715bdb76e112e6">qc_valid</a> = <a class="code" href="group__lustreuser.html#gga458e651af6690959efa2afb96be7d609aa7da3a55affababd97f6340ab65297b3">QC_MDTIDX</a>;
<a name="l01008"></a>01008                         qctl-&gt;<a class="code" href="structif__quotactl.html#ac655440c7d009b98beb041657f05d74d">obd_uuid</a> = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>;
<a name="l01009"></a>01009                 }
<a name="l01010"></a>01010                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(oqctl);
<a name="l01011"></a>01011                 <span class="keywordflow">break</span>;
<a name="l01012"></a>01012         }
<a name="l01013"></a>01013         <span class="keywordflow">case</span> <a class="code" href="lustre__ioctl_8h.html#a0acfdceeab258bac679eced4ef37f5e3">OBD_IOC_CHANGELOG_SEND</a>:
<a name="l01014"></a>01014         <span class="keywordflow">case</span> <a class="code" href="lustre__ioctl_8h.html#a1d6b0c9694801f6e8b3660958c8531cb">OBD_IOC_CHANGELOG_CLEAR</a>: {
<a name="l01015"></a>01015                 <span class="keyword">struct </span><a class="code" href="structioc__changelog.html">ioc_changelog</a> *icc = karg;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017                 <span class="keywordflow">if</span> (icc-&gt;<a class="code" href="structioc__changelog.html#a928c9f28b8ddaca68ca48227f72b4807">icc_mdtindex</a> &gt;= count)
<a name="l01018"></a>01018                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODEV);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[icc-&gt;<a class="code" href="structioc__changelog.html#a928c9f28b8ddaca68ca48227f72b4807">icc_mdtindex</a>];
<a name="l01021"></a>01021                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL || !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>)
<a name="l01022"></a>01022                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODEV);
<a name="l01023"></a>01023                 rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, <span class="keyword">sizeof</span>(*icc), icc, NULL);
<a name="l01024"></a>01024                 <span class="keywordflow">break</span>;
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga0821403b815b8b2948569411cd4381fe">LL_IOC_GET_CONNECT_FLAGS</a>: {
<a name="l01027"></a>01027                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l01028"></a>01028                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01029"></a>01029                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENODATA);
<a name="l01030"></a>01030                 rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01031"></a>01031                 <span class="keywordflow">break</span>;
<a name="l01032"></a>01032         }
<a name="l01033"></a>01033         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga30829a8740b399b5ce9083d1204bb54b">LL_IOC_FID2MDTIDX</a>: {
<a name="l01034"></a>01034                 <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid = karg;
<a name="l01035"></a>01035                 <span class="keywordtype">int</span>             mdt_index;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037                 rc = <a class="code" href="lmv__fld_8c.html#a0ccd70c3e89b531f7ca3d300501ff064">lmv_fld_lookup</a>(lmv, fid, &amp;mdt_index);
<a name="l01038"></a>01038                 <span class="keywordflow">if</span> (rc != 0)
<a name="l01039"></a>01039                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                 <span class="comment">/* Note: this is from llite(see ll_dir_ioctl()), @uarg does not</span>
<a name="l01042"></a>01042 <span class="comment">                 * point to user space memory for FID2MDTIDX. */</span>
<a name="l01043"></a>01043                 *(__u32 *)uarg = mdt_index;
<a name="l01044"></a>01044                 <span class="keywordflow">break</span>;
<a name="l01045"></a>01045         }
<a name="l01046"></a>01046         <span class="keywordflow">case</span> <a class="code" href="lustre__ioctl_8h.html#af5ae6ba81e124503755b965718fda664">OBD_IOC_FID2PATH</a>: {
<a name="l01047"></a>01047                 rc = <a class="code" href="lmv__obd_8c.html#a8cefc49b3fa55881bc63b08f9366976e">lmv_fid2path</a>(exp, len, karg, uarg);
<a name="l01048"></a>01048                 <span class="keywordflow">break</span>;
<a name="l01049"></a>01049         }
<a name="l01050"></a>01050         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga085f62ea76a23fff64ed4779b9cda006">LL_IOC_HSM_STATE_GET</a>:
<a name="l01051"></a>01051         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#gac96938d69752fa18298c500bc10bc6bf">LL_IOC_HSM_STATE_SET</a>:
<a name="l01052"></a>01052         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga3a2760967ebf8f4a2cf0c769b7ca57ce">LL_IOC_HSM_ACTION</a>: {
<a name="l01053"></a>01053                 <span class="keyword">struct </span><a class="code" href="structmd__op__data.html">md_op_data</a>       *<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a> = karg;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01056"></a>01056                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01057"></a>01057                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01058"></a>01058 
<a name="l01059"></a>01059                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01060"></a>01060                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                 rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01063"></a>01063                 <span class="keywordflow">break</span>;
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga648311d4a24732ac88f12028ef3d59f2">LL_IOC_HSM_PROGRESS</a>: {
<a name="l01066"></a>01066                 <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structhsm__progress__kernel.html" title="On the wire version of hsm_progress structure.">hsm_progress_kernel</a> *hpk = karg;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;hpk-&gt;<a class="code" href="structhsm__progress__kernel.html#afd48dd63c07cd0a976a6f079f2c2ce2f">hpk_fid</a>);
<a name="l01069"></a>01069                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01070"></a>01070                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01071"></a>01071                 rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01072"></a>01072                 <span class="keywordflow">break</span>;
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga57e475b2b81c00601922387a52fd5ab6">LL_IOC_HSM_REQUEST</a>: {
<a name="l01075"></a>01075                 <span class="keyword">struct </span><a class="code" href="structhsm__user__request.html">hsm_user_request</a> *hur = karg;
<a name="l01076"></a>01076                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reqcount = hur-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a467c984247c432b699ffc5926f6fa73e">hr_itemcount</a>;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                 <span class="keywordflow">if</span> (reqcount == 0)
<a name="l01079"></a>01079                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01080"></a>01080 
<a name="l01081"></a>01081                 <span class="comment">/* if the request is about a single fid</span>
<a name="l01082"></a>01082 <span class="comment">                 * or if there is a single MDS, no need to split</span>
<a name="l01083"></a>01083 <span class="comment">                 * the request. */</span>
<a name="l01084"></a>01084                 <span class="keywordflow">if</span> (reqcount == 1 || count == 1) {
<a name="l01085"></a>01085                         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv,
<a name="l01086"></a>01086                                               &amp;hur-&gt;<a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[0].<a class="code" href="structhsm__user__item.html#a2d396fe913229ba8e3c594823b7b94e5">hui_fid</a>);
<a name="l01087"></a>01087                         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01088"></a>01088                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01089"></a>01089                         rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01090"></a>01090                 } <span class="keywordflow">else</span> {
<a name="l01091"></a>01091                         <span class="comment">/* split fid list to their respective MDS */</span>
<a name="l01092"></a>01092                         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l01093"></a>01093                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            nr, reqlen;
<a name="l01094"></a>01094                                 <span class="keywordtype">int</span>                     rc1;
<a name="l01095"></a>01095                                 <span class="keyword">struct </span><a class="code" href="structhsm__user__request.html">hsm_user_request</a> *req;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097                                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l01098"></a>01098                                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01099"></a>01099                                         <span class="keywordflow">continue</span>;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101                                 nr = <a class="code" href="lmv__obd_8c.html#ad9c4b4baef1afc86a2a3ca98bef3640e">lmv_hsm_req_count</a>(lmv, hur, tgt);
<a name="l01102"></a>01102                                 <span class="keywordflow">if</span> (nr == 0) <span class="comment">/* nothing for this MDS */</span>
<a name="l01103"></a>01103                                         <span class="keywordflow">continue</span>;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105                                 <span class="comment">/* build a request with fids for this MDS */</span>
<a name="l01106"></a>01106                                 reqlen = <a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(typeof(*hur),
<a name="l01107"></a>01107                                                   <a class="code" href="structhsm__user__request.html#a0b1ec5be1305de205eba88f70638086f">hur_user_item</a>[nr])
<a name="l01108"></a>01108                                                 + hur-&gt;<a class="code" href="structhsm__user__request.html#aec0b2b86b49e55aa5c3ccac62e5fbf94">hur_request</a>.<a class="code" href="structhsm__request.html#a029be1d934a91b465fe970481cdebc95">hr_data_len</a>;
<a name="l01109"></a>01109                                 <a class="code" href="obd__support_8h.html#afa959cd10c660882cd6c5fad07311897">OBD_ALLOC_LARGE</a>(req, reqlen);
<a name="l01110"></a>01110                                 <span class="keywordflow">if</span> (req == NULL)
<a name="l01111"></a>01111                                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113                                 <a class="code" href="lmv__obd_8c.html#a4609a6f2df6370ae19bce78b6f42ad8c">lmv_hsm_req_build</a>(lmv, hur, tgt, req);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115                                 rc1 = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, reqlen,
<a name="l01116"></a>01116                                                     req, uarg);
<a name="l01117"></a>01117                                 <span class="keywordflow">if</span> (rc1 != 0 &amp;&amp; rc == 0)
<a name="l01118"></a>01118                                         rc = rc1;
<a name="l01119"></a>01119                                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(req, reqlen);
<a name="l01120"></a>01120                         }
<a name="l01121"></a>01121                 }
<a name="l01122"></a>01122                 <span class="keywordflow">break</span>;
<a name="l01123"></a>01123         }
<a name="l01124"></a>01124         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#gacf373a2adf6de6b69e31c2ef01a69618">LL_IOC_LOV_SWAP_LAYOUTS</a>: {
<a name="l01125"></a>01125                 <span class="keyword">struct </span><a class="code" href="structmd__op__data.html">md_op_data</a>       *<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a> = karg;
<a name="l01126"></a>01126                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt1, *tgt2;
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                 tgt1 = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01129"></a>01129                 <span class="keywordflow">if</span> (IS_ERR(tgt1))
<a name="l01130"></a>01130                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt1));
<a name="l01131"></a>01131 
<a name="l01132"></a>01132                 tgt2 = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l01133"></a>01133                 <span class="keywordflow">if</span> (IS_ERR(tgt2))
<a name="l01134"></a>01134                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt2));
<a name="l01135"></a>01135 
<a name="l01136"></a>01136                 <span class="keywordflow">if</span> ((tgt1-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL) || (tgt2-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL))
<a name="l01137"></a>01137                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139                 <span class="comment">/* only files on same MDT can have their layouts swapped */</span>
<a name="l01140"></a>01140                 <span class="keywordflow">if</span> (tgt1-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a> != tgt2-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>)
<a name="l01141"></a>01141                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EPERM);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143                 rc = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt1-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01144"></a>01144                 <span class="keywordflow">break</span>;
<a name="l01145"></a>01145         }
<a name="l01146"></a>01146         <span class="keywordflow">case</span> <a class="code" href="group__lustreuser.html#ga6da855b1bed19001e476418bb1ed37e3">LL_IOC_HSM_CT_START</a>: {
<a name="l01147"></a>01147                 <span class="keyword">struct </span><a class="code" href="structlustre__kernelcomm.html">lustre_kernelcomm</a> *lk = karg;
<a name="l01148"></a>01148                 <span class="keywordflow">if</span> (lk-&gt;<a class="code" href="structlustre__kernelcomm.html#a770faaa7f65d5928932bb3377743b075">lk_flags</a> &amp; <a class="code" href="uapi__kernelcomm_8h.html#a9a3db3120fec219c9bc955ad7ccc0048">LK_FLG_STOP</a>)
<a name="l01149"></a>01149                         rc = <a class="code" href="lmv__obd_8c.html#a6e2141ccabf84032f49c16470e2d1b11">lmv_hsm_ct_unregister</a>(lmv, cmd, len, lk, uarg);
<a name="l01150"></a>01150                 <span class="keywordflow">else</span>
<a name="l01151"></a>01151                         rc = <a class="code" href="lmv__obd_8c.html#a912145721e1263885704291a2147f9d1">lmv_hsm_ct_register</a>(lmv, cmd, len, lk, uarg);
<a name="l01152"></a>01152                 <span class="keywordflow">break</span>;
<a name="l01153"></a>01153         }
<a name="l01154"></a>01154         <span class="keywordflow">default</span>:
<a name="l01155"></a>01155                 <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l01156"></a>01156                         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a> *mdc_obd;
<a name="l01157"></a>01157                         <span class="keywordtype">int</span> err;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159                         tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l01160"></a>01160                         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01161"></a>01161                                 <span class="keywordflow">continue</span>;
<a name="l01162"></a>01162                         <span class="comment">/* ll_umount_begin() sets force flag but for lmv, not</span>
<a name="l01163"></a>01163 <span class="comment">                         * mdc. Let&apos;s pass it through */</span>
<a name="l01164"></a>01164                         mdc_obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l01165"></a>01165                         mdc_obd-&gt;<a class="code" href="structobd__device.html#a3aff50fa8cb3fddc091671df5c5f9204">obd_force</a> = obddev-&gt;<a class="code" href="structobd__device.html#a3aff50fa8cb3fddc091671df5c5f9204">obd_force</a>;
<a name="l01166"></a>01166                         err = <a class="code" href="obd__class_8h.html#a3205d58b23cd8004e67a43ca2c021887">obd_iocontrol</a>(cmd, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, len, karg, uarg);
<a name="l01167"></a>01167                         <span class="keywordflow">if</span> (err) {
<a name="l01168"></a>01168                                 <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>) {
<a name="l01169"></a>01169                                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;error: iocontrol MDC %s on MDT&quot;</span>
<a name="l01170"></a>01170                                                <span class="stringliteral">&quot; idx %d cmd %x: err = %d\n&quot;</span>,
<a name="l01171"></a>01171                                                tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2f1adcd9d6e70d041edb8c7954fe578b">ltd_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>, i, cmd, err);
<a name="l01172"></a>01172                                         <span class="keywordflow">if</span> (!rc)
<a name="l01173"></a>01173                                                 rc = err;
<a name="l01174"></a>01174                                 }
<a name="l01175"></a>01175                         } <span class="keywordflow">else</span>
<a name="l01176"></a>01176                                 <span class="keyword">set</span> = 1;
<a name="l01177"></a>01177                 }
<a name="l01178"></a>01178                 <span class="keywordflow">if</span> (!<span class="keyword">set</span> &amp;&amp; !rc)
<a name="l01179"></a>01179                         rc = -EIO;
<a name="l01180"></a>01180         }
<a name="l01181"></a>01181         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01182"></a>01182 }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="preprocessor">#if 0</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> lmv_all_chars_policy(<span class="keywordtype">int</span> count, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>,
<a name="l01186"></a>01186                                 <span class="keywordtype">int</span> len)
<a name="l01187"></a>01187 {
<a name="l01188"></a>01188         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="keywordflow">while</span> (len &gt; 0)
<a name="l01191"></a>01191                 c += name[--len];
<a name="l01192"></a>01192         c = c % count;
<a name="l01193"></a>01193         <span class="keywordflow">return</span> c;
<a name="l01194"></a>01194 }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196 <span class="keyword">static</span> <span class="keywordtype">int</span> lmv_nid_policy(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>)
<a name="l01197"></a>01197 {
<a name="l01198"></a>01198         <span class="keyword">struct </span><a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> *imp;
<a name="l01199"></a>01199         __u32              id;
<a name="l01200"></a>01200 
<a name="l01201"></a>01201         <span class="comment">/*</span>
<a name="l01202"></a>01202 <span class="comment">         * XXX: To get nid we assume that underlying obd device is mdc.</span>
<a name="l01203"></a>01203 <span class="comment">         */</span>
<a name="l01204"></a>01204         imp = <a class="code" href="group__export.html#ga2d80493ea727d72caf23f5ef37b4b428">class_exp2cliimp</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0].<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>);
<a name="l01205"></a>01205         <span class="keywordtype">id</span> = imp-&gt;<a class="code" href="structobd__import.html#af8d2d08c0e13cf532ff05d8fddccb16e" title="Currently active connection.">imp_connection</a>-&gt;<a class="code" href="structptlrpc__connection.html#a002bdb401d67315c931ff672970178b8" title="Our own lnet nid for this connection.">c_self</a> ^ (imp-&gt;<a class="code" href="structobd__import.html#af8d2d08c0e13cf532ff05d8fddccb16e" title="Currently active connection.">imp_connection</a>-&gt;<a class="code" href="structptlrpc__connection.html#a002bdb401d67315c931ff672970178b8" title="Our own lnet nid for this connection.">c_self</a> &gt;&gt; 32);
<a name="l01206"></a>01206         <span class="keywordflow">return</span> <span class="keywordtype">id</span> % lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>;
<a name="l01207"></a>01207 }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209 <span class="keyword">static</span> <span class="keywordtype">int</span> lmv_choose_mds(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01210"></a>01210                           <a class="code" href="obd_8h.html#ad0b7d8cdbdf0006cde862b07f993a6d8">placement_policy_t</a> placement)
<a name="l01211"></a>01211 {
<a name="l01212"></a>01212         <span class="keywordflow">switch</span> (placement) {
<a name="l01213"></a>01213         <span class="keywordflow">case</span> <a class="code" href="obd_8h.html#a3f1ab6b546fba97769b6bf4a50a2566eae1c47edeb4b16f3878d6b8056442f185">PLACEMENT_CHAR_POLICY</a>:
<a name="l01214"></a>01214                 <span class="keywordflow">return</span> lmv_all_chars_policy(lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>,
<a name="l01215"></a>01215                                             op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l01216"></a>01216                                             op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>);
<a name="l01217"></a>01217         <span class="keywordflow">case</span> <a class="code" href="obd_8h.html#a3f1ab6b546fba97769b6bf4a50a2566ea0496c881304db61527badfe2bfbb0d63">PLACEMENT_NID_POLICY</a>:
<a name="l01218"></a>01218                 <span class="keywordflow">return</span> lmv_nid_policy(lmv);
<a name="l01219"></a>01219 
<a name="l01220"></a>01220         <span class="keywordflow">default</span>:
<a name="l01221"></a>01221                 <span class="keywordflow">break</span>;
<a name="l01222"></a>01222         }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Unsupported placement policy %x\n&quot;</span>, placement);
<a name="l01225"></a>01225         <span class="keywordflow">return</span> -EINVAL;
<a name="l01226"></a>01226 }
<a name="l01227"></a>01227 <span class="preprocessor">#endif</span>
<a name="l01228"></a>01228 <span class="preprocessor"></span>
<a name="l01232"></a><a class="code" href="lmv__obd_8c.html#a3a860ca092aac41cd077ebd54513dc61">01232</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a3a860ca092aac41cd077ebd54513dc61" title="This is _inode_ placement policy function (not name).">lmv_placement_policy</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd,
<a name="l01233"></a>01233                                 <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data, u32 *mds)
<a name="l01234"></a>01234 {
<a name="l01235"></a>01235         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01236"></a>01236         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mds != NULL);
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> == 1) {
<a name="l01241"></a>01241                 *mds = 0;
<a name="l01242"></a>01242                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01243"></a>01243         }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a8508b479a25da222e7b8c133c69612c6">op_default_stripe_offset</a> != -1) {
<a name="l01246"></a>01246                 *mds = op_data-&gt;<a class="code" href="structmd__op__data.html#a8508b479a25da222e7b8c133c69612c6">op_default_stripe_offset</a>;
<a name="l01247"></a>01247                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01248"></a>01248         }
<a name="l01249"></a>01249 
<a name="l01254"></a>01254         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#aaa51c7316a1a65ca308c9ab560ab11fd">op_cli_flags</a> &amp; <a class="code" href="obd_8h.html#afa2d07c3fe9ba07c8b95ddeabdc04a8fa24dae44088c8885e481bd46031aab518">CLI_SET_MEA</a> &amp;&amp; op_data-&gt;<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a> != NULL) {
<a name="l01255"></a>01255                 <span class="keyword">struct </span><a class="code" href="group__lustreuser.html#ga738c0eb770a010b5c6a8c6f4804cdbe4">lmv_user_md</a> *lum;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257                 lum = op_data-&gt;<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a>;
<a name="l01258"></a>01258 
<a name="l01259"></a>01259                 <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lum-&gt;lum_stripe_offset) != (__u32)-1) {
<a name="l01260"></a>01260                         *mds = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lum-&gt;lum_stripe_offset);
<a name="l01261"></a>01261                 } <span class="keywordflow">else</span> {
<a name="l01262"></a>01262                         <span class="comment">/* -1 means default, which will be in the same MDT with</span>
<a name="l01263"></a>01263 <span class="comment">                         * the stripe */</span>
<a name="l01264"></a>01264                         *mds = op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>;
<a name="l01265"></a>01265                         lum-&gt;lum_stripe_offset = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l01266"></a>01266                 }
<a name="l01267"></a>01267         } <span class="keywordflow">else</span> {
<a name="l01268"></a>01268                 <span class="comment">/* Allocate new fid on target according to operation type and</span>
<a name="l01269"></a>01269 <span class="comment">                 * parent home mds. */</span>
<a name="l01270"></a>01270                 *mds = op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>;
<a name="l01271"></a>01271         }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01274"></a>01274 }
<a name="l01275"></a>01275 
<a name="l01276"></a><a class="code" href="lmv__obd_8c.html#a279e2f8b9987a90b0b37d05e8f89c345">01276</a> <span class="keywordtype">int</span> <a class="code" href="lmv__internal_8h.html#a279e2f8b9987a90b0b37d05e8f89c345">__lmv_fid_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid, u32 mds)
<a name="l01277"></a>01277 {
<a name="l01278"></a>01278         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01279"></a>01279         <span class="keywordtype">int</span>                      rc;
<a name="l01280"></a>01280         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282         tgt = <a class="code" href="lmv__internal_8h.html#a8e5f17e406c63cfdc26419d34cf57d94">lmv_get_target</a>(lmv, mds, NULL);
<a name="l01283"></a>01283         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01284"></a>01284                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         <span class="comment">/*</span>
<a name="l01287"></a>01287 <span class="comment">         * New seq alloc and FLD setup should be atomic. Otherwise we may find</span>
<a name="l01288"></a>01288 <span class="comment">         * on server that seq in new allocated fid is not yet known.</span>
<a name="l01289"></a>01289 <span class="comment">         */</span>
<a name="l01290"></a>01290         mutex_lock(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#ac20324135fb3bf41a54bdd4f6e6c9649">ltd_fid_mutex</a>);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> == 0 || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01293"></a>01293                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENODEV);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295         <span class="comment">/*</span>
<a name="l01296"></a>01296 <span class="comment">         * Asking underlying tgt layer to allocate new fid.</span>
<a name="l01297"></a>01297 <span class="comment">         */</span>
<a name="l01298"></a>01298         rc = <a class="code" href="obd__class_8h.html#a1c606cb5cb81e5de9b9977ec5d6d7771">obd_fid_alloc</a>(NULL, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, NULL);
<a name="l01299"></a>01299         <span class="keywordflow">if</span> (rc &gt; 0) {
<a name="l01300"></a>01300                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(fid));
<a name="l01301"></a>01301                 rc = 0;
<a name="l01302"></a>01302         }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l01305"></a>01305 out:
<a name="l01306"></a>01306         mutex_unlock(&amp;tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#ac20324135fb3bf41a54bdd4f6e6c9649">ltd_fid_mutex</a>);
<a name="l01307"></a>01307         <span class="keywordflow">return</span> rc;
<a name="l01308"></a>01308 }
<a name="l01309"></a>01309 
<a name="l01310"></a><a class="code" href="lmv__obd_8c.html#aa4764c5b00212c1e2a298d6c4780d248">01310</a> <span class="keywordtype">int</span> <a class="code" href="lmv__internal_8h.html#aa4764c5b00212c1e2a298d6c4780d248">lmv_fid_alloc</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l01311"></a>01311                   <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data)
<a name="l01312"></a>01312 {
<a name="l01313"></a>01313         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>     *obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l01314"></a>01314         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>        *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01315"></a>01315         u32                    mds = 0;
<a name="l01316"></a>01316         <span class="keywordtype">int</span>                    rc;
<a name="l01317"></a>01317         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(op_data != NULL);
<a name="l01320"></a>01320         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(fid != NULL);
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         rc = <a class="code" href="lmv__obd_8c.html#a3a860ca092aac41cd077ebd54513dc61" title="This is _inode_ placement policy function (not name).">lmv_placement_policy</a>(obd, op_data, &amp;mds);
<a name="l01323"></a>01323         <span class="keywordflow">if</span> (rc) {
<a name="l01324"></a>01324                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Can&apos;t get target for allocating fid, &quot;</span>
<a name="l01325"></a>01325                        <span class="stringliteral">&quot;rc %d\n&quot;</span>, rc);
<a name="l01326"></a>01326                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01327"></a>01327         }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         rc = <a class="code" href="lmv__internal_8h.html#a279e2f8b9987a90b0b37d05e8f89c345">__lmv_fid_alloc</a>(lmv, fid, mds);
<a name="l01330"></a>01330         <span class="keywordflow">if</span> (rc) {
<a name="l01331"></a>01331                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Can&apos;t alloc new fid, rc %d\n&quot;</span>, rc);
<a name="l01332"></a>01332                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01333"></a>01333         }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01336"></a>01336 }
<a name="l01337"></a>01337 
<a name="l01338"></a><a class="code" href="lmv__obd_8c.html#a295efa072c780376181fc96771899903">01338</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a295efa072c780376181fc96771899903">lmv_setup</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keyword">struct</span> <a class="code" href="structlustre__cfg.html">lustre_cfg</a> *lcfg)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>  *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01341"></a>01341         <span class="keyword">struct </span><a class="code" href="structlmv__desc.html">lmv_desc</a> *desc;
<a name="l01342"></a>01342         <span class="keywordtype">int</span>             rc;
<a name="l01343"></a>01343         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01344"></a>01344 
<a name="l01345"></a>01345         <span class="keywordflow">if</span> (<a class="code" href="group__cfg.html#ga2145c6d25933ce4ecc942b4e3652399b">LUSTRE_CFG_BUFLEN</a>(lcfg, 1) &lt; 1) {
<a name="l01346"></a>01346                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;LMV setup requires a descriptor\n&quot;</span>);
<a name="l01347"></a>01347                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01348"></a>01348         }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350         desc = (<span class="keyword">struct </span><a class="code" href="structlmv__desc.html">lmv_desc</a> *)<a class="code" href="group__cfg.html#gac7c0aa48d30b4c1a417d8f72018a4fb6">lustre_cfg_buf</a>(lcfg, 1);
<a name="l01351"></a>01351         <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(*desc) &gt; <a class="code" href="group__cfg.html#ga2145c6d25933ce4ecc942b4e3652399b">LUSTRE_CFG_BUFLEN</a>(lcfg, 1)) {
<a name="l01352"></a>01352                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Lmv descriptor size wrong: %d &gt; %d\n&quot;</span>,
<a name="l01353"></a>01353                        (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(*desc), <a class="code" href="group__cfg.html#ga2145c6d25933ce4ecc942b4e3652399b">LUSTRE_CFG_BUFLEN</a>(lcfg, 1));
<a name="l01354"></a>01354                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l01355"></a>01355         }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357         lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a> = 32U;
<a name="l01358"></a>01358         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>, <span class="keyword">sizeof</span>(*lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>) * lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>);
<a name="l01359"></a>01359         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a> == NULL)
<a name="l01360"></a>01360                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362         <a class="code" href="group__lustreuser.html#gad22b0e3b947bae0ae7e719c79e6f9100">obd_str2uuid</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a578b89db75fe2aec66f740684377c728">ld_uuid</a>, desc-&gt;<a class="code" href="structlmv__desc.html#a578b89db75fe2aec66f740684377c728">ld_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l01363"></a>01363         lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> = 0;
<a name="l01364"></a>01364         lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a1ba21704d398ca3271311f34748d440e">ld_active_tgt_count</a> = 0;
<a name="l01365"></a>01365         lmv-&gt;<a class="code" href="structlmv__obd.html#a5519d50c84c91c59a6849a40ab55e8c5">max_def_easize</a> = 0;
<a name="l01366"></a>01366         lmv-&gt;<a class="code" href="structlmv__obd.html#aaac72fbc304f3642bc23f233304e2fca">max_easize</a> = 0;
<a name="l01367"></a>01367         lmv-&gt;<a class="code" href="structlmv__obd.html#a97b7d3941dd742307bca856445cfa14d">lmv_placement</a> = <a class="code" href="obd_8h.html#a3f1ab6b546fba97769b6bf4a50a2566eae1c47edeb4b16f3878d6b8056442f185">PLACEMENT_CHAR_POLICY</a>;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369         spin_lock_init(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#abb7417932d14e6a68a6b7d8b81c18243">lmv_lock</a>);
<a name="l01370"></a>01370         mutex_init(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a450490c8fd4e54654c2a2b9e3afb069b">lmv_init_mutex</a>);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 <span class="preprocessor">#ifdef CONFIG_PROC_FS</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span>        obd-&gt;<a class="code" href="structobd__device.html#aa055ce323549b9f6b5833fe02fcdce9f">obd_vars</a> = lprocfs_lmv_obd_vars;
<a name="l01374"></a>01374         <a class="code" href="lprocfs__status_8h.html#a9af4b6c3edbc6ce382a10dbd4af81177">lprocfs_obd_setup</a>(obd);
<a name="l01375"></a>01375         <a class="code" href="lprocfs__status_8h.html#a344be3bf5dd74a27ec378734a9b51581">lprocfs_alloc_md_stats</a>(obd, 0);
<a name="l01376"></a>01376         rc = lprocfs_seq_create(obd-&gt;<a class="code" href="structobd__device.html#a1be8ec6b61422e4cd9c2050efca4c82d">obd_proc_entry</a>, <span class="stringliteral">&quot;target_obd&quot;</span>,
<a name="l01377"></a>01377                                 0444, &amp;<a class="code" href="lmv__internal_8h.html#abd2bf8b8a13612db803c68e532c0babd">lmv_proc_target_fops</a>, obd);
<a name="l01378"></a>01378         <span class="keywordflow">if</span> (rc)
<a name="l01379"></a>01379                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%s: error adding LMV target_obd file: rc = %d\n&quot;</span>,
<a name="l01380"></a>01380                       obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l01381"></a>01381 <span class="preprocessor">#endif</span>
<a name="l01382"></a>01382 <span class="preprocessor"></span>        rc = <a class="code" href="group__fld.html#ga61d3efa605b8eef01775fbe46b903dc4">fld_client_init</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a6a04fc1150ffd264c7540a08870eccc7">lmv_fld</a>, obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l01383"></a>01383                              <a class="code" href="group__fld.html#gga900dca9b26de42491763226e12dcd47ba282ea7d84213535e09858482b42f9942">LUSTRE_CLI_FLD_HASH_DHT</a>);
<a name="l01384"></a>01384         <span class="keywordflow">if</span> (rc) {
<a name="l01385"></a>01385                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Can&apos;t init FLD, err %d\n&quot;</span>, rc);
<a name="l01386"></a>01386                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01387"></a>01387         }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 out:
<a name="l01392"></a>01392         <span class="keywordflow">return</span> rc;
<a name="l01393"></a>01393 }
<a name="l01394"></a>01394 
<a name="l01395"></a><a class="code" href="lmv__obd_8c.html#a6044af72bfa0163d8aa9859102b53cc9">01395</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a6044af72bfa0163d8aa9859102b53cc9">lmv_cleanup</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd)
<a name="l01396"></a>01396 {
<a name="l01397"></a>01397         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>   *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01398"></a>01398         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <a class="code" href="group__fld.html#gad4ee232ae9fa8a05b0c1c5cfabad08a6">fld_client_fini</a>(&amp;lmv-&gt;<a class="code" href="structlmv__obd.html#a6a04fc1150ffd264c7540a08870eccc7">lmv_fld</a>);
<a name="l01401"></a>01401         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a> != NULL) {
<a name="l01402"></a>01402                 <span class="keywordtype">int</span> i;
<a name="l01403"></a>01403                 <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l01404"></a>01404                         <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i] == NULL)
<a name="l01405"></a>01405                                 <span class="keywordflow">continue</span>;
<a name="l01406"></a>01406                         <a class="code" href="lmv__obd_8c.html#ac45ea27cc91f6e323e5e8536e5efc49a">lmv_del_target</a>(lmv, i);
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>, <span class="keyword">sizeof</span>(*lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>) * lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a>);
<a name="l01409"></a>01409                 lmv-&gt;<a class="code" href="structlmv__obd.html#a2885e35458264be6223ee7e1c2b83f4c">tgts_size</a> = 0;
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a><a class="code" href="lmv__obd_8c.html#a89db0aa4067690e5a01f919ec4ab9d12">01414</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a89db0aa4067690e5a01f919ec4ab9d12">lmv_process_config</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keywordtype">size_t</span> len, <span class="keywordtype">void</span> *<a class="code" href="parallel__grouplock_8c.html#a30581aaaef7980b9fc6df8f98406097c">buf</a>)
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416         <span class="keyword">struct </span><a class="code" href="structlustre__cfg.html">lustre_cfg</a>       *lcfg = buf;
<a name="l01417"></a>01417         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>         obd_uuid;
<a name="l01418"></a>01418         <span class="keywordtype">int</span>                     gen;
<a name="l01419"></a>01419         __u32                   index;
<a name="l01420"></a>01420         <span class="keywordtype">int</span>                     rc;
<a name="l01421"></a>01421         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="keywordflow">switch</span> (lcfg-&gt;<a class="code" href="structlustre__cfg.html#a6824ba74e4ba3b58420b05938eb8562d">lcfg_command</a>) {
<a name="l01424"></a>01424         <span class="keywordflow">case</span> <a class="code" href="group__cfg.html#gga980511536826a6f5df2877e44c9af68ba87e19d9a01d1ff51aed83d0d69905f4b" title="add an mdc to a lmv">LCFG_ADD_MDC</a>:
<a name="l01425"></a>01425                 <span class="comment">/* modify_mdc_tgts add 0:lustre-clilmv  1:lustre-MDT0000_UUID</span>
<a name="l01426"></a>01426 <span class="comment">                 * 2:0  3:1  4:lustre-MDT0000-mdc_UUID */</span>
<a name="l01427"></a>01427                 <span class="keywordflow">if</span> (<a class="code" href="group__cfg.html#ga2145c6d25933ce4ecc942b4e3652399b">LUSTRE_CFG_BUFLEN</a>(lcfg, 1) &gt; <span class="keyword">sizeof</span>(obd_uuid.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>))
<a name="l01428"></a>01428                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l01429"></a>01429 
<a name="l01430"></a>01430                 <a class="code" href="group__lustreuser.html#gad22b0e3b947bae0ae7e719c79e6f9100">obd_str2uuid</a>(&amp;obd_uuid,  <a class="code" href="group__cfg.html#gac7c0aa48d30b4c1a417d8f72018a4fb6">lustre_cfg_buf</a>(lcfg, 1));
<a name="l01431"></a>01431 
<a name="l01432"></a>01432                 <span class="keywordflow">if</span> (sscanf(<a class="code" href="group__cfg.html#gac7c0aa48d30b4c1a417d8f72018a4fb6">lustre_cfg_buf</a>(lcfg, 2), <span class="stringliteral">&quot;%u&quot;</span>, &amp;index) != 1)
<a name="l01433"></a>01433                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l01434"></a>01434                 <span class="keywordflow">if</span> (sscanf(<a class="code" href="group__cfg.html#gac7c0aa48d30b4c1a417d8f72018a4fb6">lustre_cfg_buf</a>(lcfg, 3), <span class="stringliteral">&quot;%d&quot;</span>, &amp;gen) != 1)
<a name="l01435"></a>01435                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l01436"></a>01436                 rc = <a class="code" href="lmv__obd_8c.html#aad58b1e1b2c6cf6d6ef68e97e629809d">lmv_add_target</a>(obd, &amp;obd_uuid, index, gen);
<a name="l01437"></a>01437                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l01438"></a>01438         <span class="keywordflow">default</span>:
<a name="l01439"></a>01439                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;Unknown command: %d\n&quot;</span>, lcfg-&gt;<a class="code" href="structlustre__cfg.html#a6824ba74e4ba3b58420b05938eb8562d">lcfg_command</a>);
<a name="l01440"></a>01440                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l01441"></a>01441         }
<a name="l01442"></a>01442 out:
<a name="l01443"></a>01443         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01444"></a>01444 }
<a name="l01445"></a>01445 
<a name="l01446"></a><a class="code" href="lmv__obd_8c.html#a3ab354bac566b6f197724735b8e99486">01446</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a3ab354bac566b6f197724735b8e99486">lmv_statfs</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l01447"></a>01447                       <span class="keyword">struct</span> <a class="code" href="structobd__statfs.html">obd_statfs</a> *osfs, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> max_age, __u32 flags)
<a name="l01448"></a>01448 {
<a name="l01449"></a>01449         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l01450"></a>01450         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01451"></a>01451         <span class="keyword">struct </span><a class="code" href="structobd__statfs.html">obd_statfs</a>       *temp;
<a name="l01452"></a>01452         <span class="keywordtype">int</span>                      rc = 0;
<a name="l01453"></a>01453         __u32                    i;
<a name="l01454"></a>01454         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01457"></a>01457         <span class="keywordflow">if</span> (rc)
<a name="l01458"></a>01458                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(temp, <span class="keyword">sizeof</span>(*temp));
<a name="l01461"></a>01461         <span class="keywordflow">if</span> (temp == NULL)
<a name="l01462"></a>01462                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l01465"></a>01465                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i] == NULL || lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01466"></a>01466                         <span class="keywordflow">continue</span>;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468                 rc = <a class="code" href="obd__class_8h.html#ae3a5208e13b939f2e10136ab85bfe06d">obd_statfs</a>(env, lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, temp,
<a name="l01469"></a>01469                                 max_age, flags);
<a name="l01470"></a>01470                 <span class="keywordflow">if</span> (rc) {
<a name="l01471"></a>01471                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;can&apos;t stat MDS #%d (%s), error %d\n&quot;</span>, i,
<a name="l01472"></a>01472                                lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l01473"></a>01473                                rc);
<a name="l01474"></a>01474                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_free_temp, rc);
<a name="l01475"></a>01475                 }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477                 <span class="keywordflow">if</span> (i == 0) {
<a name="l01478"></a>01478                         *osfs = *temp;
<a name="l01479"></a>01479                         <span class="comment">/* If the statfs is from mount, it will needs</span>
<a name="l01480"></a>01480 <span class="comment">                         * retrieve necessary information from MDT0.</span>
<a name="l01481"></a>01481 <span class="comment">                         * i.e. mount does not need the merged osfs</span>
<a name="l01482"></a>01482 <span class="comment">                         * from all of MDT.</span>
<a name="l01483"></a>01483 <span class="comment">                         * And also clients can be mounted as long as</span>
<a name="l01484"></a>01484 <span class="comment">                         * MDT0 is in service*/</span>
<a name="l01485"></a>01485                         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="obd__class_8h.html#acd53b92048ef9f39105c6e5a4b10b440">OBD_STATFS_FOR_MDT0</a>)
<a name="l01486"></a>01486                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_free_temp, rc);
<a name="l01487"></a>01487                 } <span class="keywordflow">else</span> {
<a name="l01488"></a>01488                         osfs-&gt;<a class="code" href="structobd__statfs.html#a7f951cad5548622404e7f191ee03c833">os_bavail</a> += temp-&gt;<a class="code" href="structobd__statfs.html#a7f951cad5548622404e7f191ee03c833">os_bavail</a>;
<a name="l01489"></a>01489                         osfs-&gt;<a class="code" href="structobd__statfs.html#a215b3668739be30efec2bd7f19fbb0c7">os_blocks</a> += temp-&gt;<a class="code" href="structobd__statfs.html#a215b3668739be30efec2bd7f19fbb0c7">os_blocks</a>;
<a name="l01490"></a>01490                         osfs-&gt;<a class="code" href="structobd__statfs.html#a36dd2709d23604535cf66c5e26ee0520">os_ffree</a> += temp-&gt;<a class="code" href="structobd__statfs.html#a36dd2709d23604535cf66c5e26ee0520">os_ffree</a>;
<a name="l01491"></a>01491                         osfs-&gt;<a class="code" href="structobd__statfs.html#a587a46e0db7f8e9f0da22f11bd7ae708">os_files</a> += temp-&gt;<a class="code" href="structobd__statfs.html#a587a46e0db7f8e9f0da22f11bd7ae708">os_files</a>;
<a name="l01492"></a>01492                 }
<a name="l01493"></a>01493         }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l01496"></a>01496 out_free_temp:
<a name="l01497"></a>01497         <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(temp, <span class="keyword">sizeof</span>(*temp));
<a name="l01498"></a>01498         <span class="keywordflow">return</span> rc;
<a name="l01499"></a>01499 }
<a name="l01500"></a>01500 
<a name="l01501"></a><a class="code" href="lmv__obd_8c.html#a8fa39ecac1dfe50f1ebdde9b8fb8798d">01501</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a8fa39ecac1dfe50f1ebdde9b8fb8798d">lmv_get_root</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keywordtype">char</span> *fileset,
<a name="l01502"></a>01502                         <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l01503"></a>01503 {
<a name="l01504"></a>01504         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>    *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01505"></a>01505         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>       *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01506"></a>01506         <span class="keywordtype">int</span>                   rc;
<a name="l01507"></a>01507         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01510"></a>01510         <span class="keywordflow">if</span> (rc)
<a name="l01511"></a>01511                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         rc = <a class="code" href="obd__class_8h.html#af88d7a96d7fe5ab69d7d14575b429840">md_get_root</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fileset, fid);
<a name="l01514"></a>01514         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01515"></a>01515 }
<a name="l01516"></a>01516 
<a name="l01517"></a><a class="code" href="lmv__obd_8c.html#a22af5ada04de1833fc34b44a81debfb3">01517</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a22af5ada04de1833fc34b44a81debfb3">lmv_getxattr</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l01518"></a>01518                         u64 valid, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
<a name="l01519"></a>01519                         <span class="keyword">const</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">int</span> input_size, <span class="keywordtype">int</span> output_size,
<a name="l01520"></a>01520                         <span class="keywordtype">int</span> flags, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01521"></a>01521 {
<a name="l01522"></a>01522         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>      *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01523"></a>01523         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>         *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01524"></a>01524         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>    *tgt;
<a name="l01525"></a>01525         <span class="keywordtype">int</span>                     rc;
<a name="l01526"></a>01526         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01527"></a>01527 
<a name="l01528"></a>01528         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01529"></a>01529         <span class="keywordflow">if</span> (rc)
<a name="l01530"></a>01530                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01531"></a>01531 
<a name="l01532"></a>01532         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01534"></a>01534                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01535"></a>01535 
<a name="l01536"></a>01536         rc = <a class="code" href="obd__class_8h.html#a6db67c4d16c288d2679b88ee71ff542b">md_getxattr</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, valid, name, input,
<a name="l01537"></a>01537                          input_size, output_size, flags, request);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01542"></a><a class="code" href="lmv__obd_8c.html#a912a94b2ced458d6853eddc7432dc9b5">01542</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a912a94b2ced458d6853eddc7432dc9b5">lmv_setxattr</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l01543"></a>01543                         u64 valid, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
<a name="l01544"></a>01544                         <span class="keyword">const</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">int</span> input_size, <span class="keywordtype">int</span> output_size,
<a name="l01545"></a>01545                         <span class="keywordtype">int</span> flags, __u32 suppgid,
<a name="l01546"></a>01546                         <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01547"></a>01547 {
<a name="l01548"></a>01548         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>      *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01549"></a>01549         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>         *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01550"></a>01550         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>    *tgt;
<a name="l01551"></a>01551         <span class="keywordtype">int</span>                     rc;
<a name="l01552"></a>01552         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01555"></a>01555         <span class="keywordflow">if</span> (rc)
<a name="l01556"></a>01556                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01557"></a>01557 
<a name="l01558"></a>01558         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l01559"></a>01559         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01560"></a>01560                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01561"></a>01561 
<a name="l01562"></a>01562         rc = <a class="code" href="obd__class_8h.html#a63a24656f772590352b5b524463b4b46">md_setxattr</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, valid, name, input,
<a name="l01563"></a>01563                          input_size, output_size, flags, suppgid,
<a name="l01564"></a>01564                          request);
<a name="l01565"></a>01565 
<a name="l01566"></a>01566         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a><a class="code" href="lmv__obd_8c.html#a609037f05523b500d549599233b7d83f">01569</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a609037f05523b500d549599233b7d83f">lmv_getattr</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01570"></a>01570                        <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01571"></a>01571 {
<a name="l01572"></a>01572         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01573"></a>01573         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01574"></a>01574         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01575"></a>01575         <span class="keywordtype">int</span>                      rc;
<a name="l01576"></a>01576         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01579"></a>01579         <span class="keywordflow">if</span> (rc)
<a name="l01580"></a>01580                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01581"></a>01581 
<a name="l01582"></a>01582         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01583"></a>01583         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01584"></a>01584                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01585"></a>01585 
<a name="l01586"></a>01586         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> &amp; <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a220472c0cf57a5c1fa2c93c4f96f135f">MF_GET_MDT_IDX</a>) {
<a name="l01587"></a>01587                 op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>;
<a name="l01588"></a>01588                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591         rc = <a class="code" href="obd__class_8h.html#ad9508bd988c6033991163b0a6ca4412a">md_getattr</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, request);
<a name="l01592"></a>01592 
<a name="l01593"></a>01593         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01594"></a>01594 }
<a name="l01595"></a>01595 
<a name="l01596"></a><a class="code" href="lmv__obd_8c.html#a1d77d1d8603229370a492c77d9b37b37">01596</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a1d77d1d8603229370a492c77d9b37b37">lmv_null_inode</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l01597"></a>01597 {
<a name="l01598"></a>01598         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>   *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01599"></a>01599         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>      *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01600"></a>01600         __u32                i;
<a name="l01601"></a>01601         <span class="keywordtype">int</span>                  rc;
<a name="l01602"></a>01602         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01605"></a>01605         <span class="keywordflow">if</span> (rc)
<a name="l01606"></a>01606                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01607"></a>01607 
<a name="l01608"></a>01608         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;CBDATA for &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid));
<a name="l01609"></a>01609 
<a name="l01610"></a>01610         <span class="comment">/*</span>
<a name="l01611"></a>01611 <span class="comment">         * With DNE every object can have two locks in different namespaces:</span>
<a name="l01612"></a>01612 <span class="comment">         * lookup lock in space of MDT storing direntry and update/open lock in</span>
<a name="l01613"></a>01613 <span class="comment">         * space of MDT storing inode.</span>
<a name="l01614"></a>01614 <span class="comment">         */</span>
<a name="l01615"></a>01615         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l01616"></a>01616                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i] == NULL || lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l01617"></a>01617                         <span class="keywordflow">continue</span>;
<a name="l01618"></a>01618                 <a class="code" href="obd__class_8h.html#a37c9340698cd24011c71014405d36a99">md_null_inode</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid);
<a name="l01619"></a>01619         }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01622"></a>01622 }
<a name="l01623"></a>01623 
<a name="l01624"></a><a class="code" href="lmv__obd_8c.html#a7e108407d78521b4877acad2a638886b">01624</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a7e108407d78521b4877acad2a638886b">lmv_close</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01625"></a>01625                      <span class="keyword">struct</span> <a class="code" href="structmd__open__data.html">md_open_data</a> *mod, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01626"></a>01626 {
<a name="l01627"></a>01627         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>     *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01628"></a>01628         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>        *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01629"></a>01629         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>   *tgt;
<a name="l01630"></a>01630         <span class="keywordtype">int</span>                    rc;
<a name="l01631"></a>01631         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01632"></a>01632 
<a name="l01633"></a>01633         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01634"></a>01634         <span class="keywordflow">if</span> (rc)
<a name="l01635"></a>01635                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01636"></a>01636 
<a name="l01637"></a>01637         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01638"></a>01638         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01639"></a>01639                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;CLOSE &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>));
<a name="l01642"></a>01642         rc = <a class="code" href="obd__class_8h.html#a1e007270d71e455b1f2562453168aaa0">md_close</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, mod, request);
<a name="l01643"></a>01643         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01644"></a>01644 }
<a name="l01645"></a>01645 
<a name="l01652"></a>01652 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *
<a name="l01653"></a><a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10">01653</a> <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> *lsm,
<a name="l01654"></a>01654                            <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> namelen, <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l01655"></a>01655                            u32 *mds)
<a name="l01656"></a>01656 {
<a name="l01657"></a>01657         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01658"></a>01658         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a>  *oinfo;
<a name="l01659"></a>01659 
<a name="l01660"></a>01660         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#a0b33d2087626258b3ab95a095ab9471a">OBD_FAIL_LFSCK_BAD_NAME_HASH</a>)) {
<a name="l01661"></a>01661                 <span class="keywordflow">if</span> (<a class="code" href="libcfs__fail_8h.html#a2ef1cb02c9a3c9f5a23b1f818d3b99ba">cfs_fail_val</a> &gt;= lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>)
<a name="l01662"></a>01662                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(ERR_PTR(-EBADF));
<a name="l01663"></a>01663                 oinfo = &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[<a class="code" href="libcfs__fail_8h.html#a2ef1cb02c9a3c9f5a23b1f818d3b99ba">cfs_fail_val</a>];
<a name="l01664"></a>01664         } <span class="keywordflow">else</span> {
<a name="l01665"></a>01665                 oinfo = <a class="code" href="lmv__internal_8h.html#a8314a1634e7809a525c9b510c62f6f54">lsm_name_to_stripe_info</a>(lsm, name, namelen);
<a name="l01666"></a>01666                 <span class="keywordflow">if</span> (IS_ERR(oinfo))
<a name="l01667"></a>01667                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(ERR_CAST(oinfo));
<a name="l01668"></a>01668         }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670         <span class="keywordflow">if</span> (fid != NULL)
<a name="l01671"></a>01671                 *fid = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l01672"></a>01672         <span class="keywordflow">if</span> (mds != NULL)
<a name="l01673"></a>01673                 *mds = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675         tgt = <a class="code" href="lmv__internal_8h.html#a8e5f17e406c63cfdc26419d34cf57d94">lmv_get_target</a>(lmv, oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>, NULL);
<a name="l01676"></a>01676 
<a name="l01677"></a>01677         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;locate on mds %u &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>,
<a name="l01678"></a>01678                <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>));
<a name="l01679"></a>01679         <span class="keywordflow">return</span> tgt;
<a name="l01680"></a>01680 }
<a name="l01681"></a>01681 
<a name="l01699"></a>01699 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>*
<a name="l01700"></a><a class="code" href="lmv__obd_8c.html#a6cbec485d68de683ee9aa59560c1b9b4">01700</a> <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01701"></a>01701                <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l01702"></a>01702 {
<a name="l01703"></a>01703         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l01704"></a>01704         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <span class="comment">/* During creating VOLATILE file, it should honor the mdt</span>
<a name="l01707"></a>01707 <span class="comment">         * index if the file under striped dir is being restored, see</span>
<a name="l01708"></a>01708 <span class="comment">         * ct_restore(). */</span>
<a name="l01709"></a>01709         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a2bb150a59e3e2b9a70387d685d9c25a4">op_bias</a> &amp; <a class="code" href="group__lustreidl.html#gga4b1c62e9fc5c50b5ad2eff80f77eb0e9a4c6de28d2175f61ec8a03cbfae76c50b">MDS_CREATE_VOLATILE</a> &amp;&amp;
<a name="l01710"></a>01710             (<span class="keywordtype">int</span>)op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> != -1) {
<a name="l01711"></a>01711                 <span class="keywordtype">int</span> i;
<a name="l01712"></a>01712                 tgt = <a class="code" href="lmv__internal_8h.html#a8e5f17e406c63cfdc26419d34cf57d94">lmv_get_target</a>(lmv, op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>, NULL);
<a name="l01713"></a>01713                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01714"></a>01714                         <span class="keywordflow">return</span> tgt;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716                 <span class="keywordflow">if</span> (lsm != NULL) {
<a name="l01717"></a>01717                         <span class="comment">/* refill the right parent fid */</span>
<a name="l01718"></a>01718                         <span class="keywordflow">for</span> (i = 0; i &lt; lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>; i++) {
<a name="l01719"></a>01719                                 <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a> *oinfo;
<a name="l01720"></a>01720 
<a name="l01721"></a>01721                                 oinfo = &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i];
<a name="l01722"></a>01722                                 <span class="keywordflow">if</span> (oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a> == op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>) {
<a name="l01723"></a>01723                                         *fid = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l01724"></a>01724                                         <span class="keywordflow">break</span>;
<a name="l01725"></a>01725                                 }
<a name="l01726"></a>01726                         }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                         <span class="keywordflow">if</span> (i == lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>)
<a name="l01729"></a>01729                                 *fid = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[0].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l01730"></a>01730                 }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732                 <span class="keywordflow">return</span> tgt;
<a name="l01733"></a>01733         }
<a name="l01734"></a>01734 
<a name="l01735"></a>01735         <span class="keywordflow">if</span> (lsm == NULL || op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a> == 0) {
<a name="l01736"></a>01736                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l01737"></a>01737                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01738"></a>01738                         <span class="keywordflow">return</span> tgt;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740                 op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>;
<a name="l01741"></a>01741                 <span class="keywordflow">return</span> tgt;
<a name="l01742"></a>01742         }
<a name="l01743"></a>01743 
<a name="l01744"></a>01744         <span class="keywordflow">return</span> <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(lmv, lsm, op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l01745"></a>01745                                           op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>, fid,
<a name="l01746"></a>01746                                           &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a><a class="code" href="lmv__obd_8c.html#ae3a46b26985b29c729e7f48c087c4359">01749</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ae3a46b26985b29c729e7f48c087c4359">lmv_create</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01750"></a>01750                 <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen, umode_t <a class="code" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>, uid_t uid,
<a name="l01751"></a>01751                 gid_t gid, <a class="code" href="curproc_8h.html#a3cb6e21040ca4be7dd02ad341b27c28b">cfs_cap_t</a> cap_effective, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> rdev,
<a name="l01752"></a>01752                 <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01753"></a>01753 {
<a name="l01754"></a>01754         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01755"></a>01755         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01756"></a>01756         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01757"></a>01757         <span class="keywordtype">int</span>                      rc;
<a name="l01758"></a>01758         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01761"></a>01761         <span class="keywordflow">if</span> (rc)
<a name="l01762"></a>01762                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01763"></a>01763 
<a name="l01764"></a>01764         <span class="keywordflow">if</span> (!lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a1ba21704d398ca3271311f34748d440e">ld_active_tgt_count</a>)
<a name="l01765"></a>01765                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EIO);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767         tgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01768"></a>01768         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01769"></a>01769                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01770"></a>01770 
<a name="l01771"></a>01771         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;CREATE name &apos;%.*s&apos; on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; -&gt; mds #%x\n&quot;</span>,
<a name="l01772"></a>01772                 (<span class="keywordtype">int</span>)op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>, op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l01773"></a>01773                 <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>), op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l01774"></a>01774 
<a name="l01775"></a>01775         rc = <a class="code" href="lmv__internal_8h.html#aa4764c5b00212c1e2a298d6c4780d248">lmv_fid_alloc</a>(NULL, exp, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>, op_data);
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (rc)
<a name="l01777"></a>01777                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01778"></a>01778         <span class="keywordflow">if</span> (<a class="code" href="group__export.html#ga88d9d5bec068d568aab0554ac8e91431">exp_connect_flags</a>(exp) &amp; <a class="code" href="group__lustreidl.html#ga46a1fd92cfe553a62ea70ebed7dd5b38">OBD_CONNECT_DIR_STRIPE</a>) {
<a name="l01779"></a>01779                 <span class="comment">/* Send the create request to the MDT where the object</span>
<a name="l01780"></a>01780 <span class="comment">                 * will be located */</span>
<a name="l01781"></a>01781                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l01782"></a>01782                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01783"></a>01783                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01784"></a>01784 
<a name="l01785"></a>01785                 op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>;
<a name="l01786"></a>01786         } <span class="keywordflow">else</span> {
<a name="l01787"></a>01787                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;Server doesn&apos;t support striped dirs\n&quot;</span>);
<a name="l01788"></a>01788         }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;CREATE obj &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; -&gt; mds #%x\n&quot;</span>,
<a name="l01791"></a>01791                <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>), op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l01792"></a>01792 
<a name="l01793"></a>01793         op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a1f9bccfb422835679c05221cdea088c4">MF_MDC_CANCEL_FID1</a>;
<a name="l01794"></a>01794         rc = <a class="code" href="obd__class_8h.html#a81944963c9f13fd59cc87741bb711fe4">md_create</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, data, datalen, mode, uid, gid,
<a name="l01795"></a>01795                        cap_effective, rdev, request);
<a name="l01796"></a>01796         <span class="keywordflow">if</span> (rc == 0) {
<a name="l01797"></a>01797                 <span class="keywordflow">if</span> (*request == NULL)
<a name="l01798"></a>01798                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01799"></a>01799                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;Created - &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>));
<a name="l01800"></a>01800         }
<a name="l01801"></a>01801         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01805"></a><a class="code" href="lmv__obd_8c.html#a400fcbf4f9ebb49443ca96f96b8d36f3">01805</a> <a class="code" href="lmv__obd_8c.html#a400fcbf4f9ebb49443ca96f96b8d36f3">lmv_enqueue</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structldlm__enqueue__info.html" title="Common ldlm_enqueue parameters.">ldlm_enqueue_info</a> *einfo,
<a name="l01806"></a>01806             <span class="keyword">const</span> <span class="keyword">union</span> <a class="code" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy,
<a name="l01807"></a>01807             <span class="keyword">struct</span> <a class="code" href="structlookup__intent.html">lookup_intent</a> *it, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01808"></a>01808             <span class="keyword">struct</span> <a class="code" href="structlustre__handle.html">lustre_handle</a> *lockh, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> extra_lock_flags)
<a name="l01809"></a>01809 {
<a name="l01810"></a>01810         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>        *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01811"></a>01811         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>           *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01812"></a>01812         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>      *tgt;
<a name="l01813"></a>01813         <span class="keywordtype">int</span>                       rc;
<a name="l01814"></a>01814         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01817"></a>01817         <span class="keywordflow">if</span> (rc)
<a name="l01818"></a>01818                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01819"></a>01819 
<a name="l01820"></a>01820         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;ENQUEUE &apos;%s&apos; on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01821"></a>01821                <a class="code" href="llite__internal_8h.html#afd65dd6f6497317885b1a36c3efa79cd">LL_IT2STR</a>(it), <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>));
<a name="l01822"></a>01822 
<a name="l01823"></a>01823         tgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01824"></a>01824         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01825"></a>01825                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01826"></a>01826 
<a name="l01827"></a>01827         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;ENQUEUE &apos;%s&apos; on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; -&gt; mds #%u\n&quot;</span>,
<a name="l01828"></a>01828                <a class="code" href="llite__internal_8h.html#afd65dd6f6497317885b1a36c3efa79cd">LL_IT2STR</a>(it), <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>), tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830         rc = <a class="code" href="obd__class_8h.html#af11d633f1a2b86b59a6089cc3d0125fd">md_enqueue</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, einfo, policy, it, op_data, lockh,
<a name="l01831"></a>01831                         extra_lock_flags);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01837"></a><a class="code" href="lmv__obd_8c.html#a064a9aa683e74e1fa42ad3cd120ddd47">01837</a> <a class="code" href="lmv__obd_8c.html#a064a9aa683e74e1fa42ad3cd120ddd47">lmv_getattr_name</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,<span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01838"></a>01838                  <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **preq)
<a name="l01839"></a>01839 {
<a name="l01840"></a>01840         <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a>   *req = NULL;
<a name="l01841"></a>01841         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01842"></a>01842         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01843"></a>01843         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01844"></a>01844         <span class="keyword">struct </span><a class="code" href="structmdt__body.html">mdt_body</a>         *body;
<a name="l01845"></a>01845         <span class="keywordtype">int</span>                      rc;
<a name="l01846"></a>01846         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01847"></a>01847 
<a name="l01848"></a>01848         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01849"></a>01849         <span class="keywordflow">if</span> (rc)
<a name="l01850"></a>01850                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         tgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l01853"></a>01853         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01854"></a>01854                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;GETATTR_NAME for %*s on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; -&gt; mds #%d\n&quot;</span>,
<a name="l01857"></a>01857                 (<span class="keywordtype">int</span>)op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>, op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l01858"></a>01858                 <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>), tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>);
<a name="l01859"></a>01859 
<a name="l01860"></a>01860         rc = <a class="code" href="obd__class_8h.html#a6a03da2ff8953c345ddf7bcae6ce8fda">md_getattr_name</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, preq);
<a name="l01861"></a>01861         <span class="keywordflow">if</span> (rc != 0)
<a name="l01862"></a>01862                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01863"></a>01863 
<a name="l01864"></a>01864         body = <a class="code" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer...">req_capsule_server_get</a>(&amp;(*preq)-&gt;rq_pill, &amp;<a class="code" href="group__req__layout.html#ga1c9ae136d2e4b00329d63bcb718c9d93">RMF_MDT_BODY</a>);
<a name="l01865"></a>01865         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(body != NULL);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867         <span class="keywordflow">if</span> (body-&gt;<a class="code" href="structmdt__body.html#a1b206c7182c4ded5e8b9fbb1e8670bb5">mbo_valid</a> &amp; <a class="code" href="group__lustreidl.html#ga9cad3716fc653975a6f2e1853515c49f">OBD_MD_MDS</a>) {
<a name="l01868"></a>01868                 <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> rid = body-&gt;<a class="code" href="structmdt__body.html#af95f5f511b3aacf651ad7822ee8b324b">mbo_fid1</a>;
<a name="l01869"></a>01869                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;Request attrs for &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01870"></a>01870                        <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;rid));
<a name="l01871"></a>01871 
<a name="l01872"></a>01872                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;rid);
<a name="l01873"></a>01873                 <span class="keywordflow">if</span> (IS_ERR(tgt)) {
<a name="l01874"></a>01874                         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(*preq);
<a name="l01875"></a>01875                         preq = NULL;
<a name="l01876"></a>01876                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01877"></a>01877                 }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879                 op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a> = rid;
<a name="l01880"></a>01880                 op_data-&gt;<a class="code" href="structmd__op__data.html#ac8d9d3433b6a82bc7b3bd0195407067d">op_valid</a> |= <a class="code" href="group__lustreidl.html#ga0d85ced5d4204c051bf228079caa85dc">OBD_MD_FLCROSSREF</a>;
<a name="l01881"></a>01881                 op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a> = 0;
<a name="l01882"></a>01882                 op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a> = NULL;
<a name="l01883"></a>01883                 rc = <a class="code" href="obd__class_8h.html#a6a03da2ff8953c345ddf7bcae6ce8fda">md_getattr_name</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, &amp;req);
<a name="l01884"></a>01884                 <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(*preq);
<a name="l01885"></a>01885                 *preq = req;
<a name="l01886"></a>01886         }
<a name="l01887"></a>01887 
<a name="l01888"></a>01888         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01889"></a>01889 }
<a name="l01890"></a>01890 
<a name="l01891"></a><a class="code" href="lmv__obd_8c.html#ae7e8e11aebe0552a7567575d1a0d2bef">01891</a> <span class="preprocessor">#define md_op_data_fid(op_data, fl)                     \</span>
<a name="l01892"></a>01892 <span class="preprocessor">        (fl == MF_MDC_CANCEL_FID1 ? &amp;op_data-&gt;op_fid1 : \</span>
<a name="l01893"></a>01893 <span class="preprocessor">         fl == MF_MDC_CANCEL_FID2 ? &amp;op_data-&gt;op_fid2 : \</span>
<a name="l01894"></a>01894 <span class="preprocessor">         fl == MF_MDC_CANCEL_FID3 ? &amp;op_data-&gt;op_fid3 : \</span>
<a name="l01895"></a>01895 <span class="preprocessor">         fl == MF_MDC_CANCEL_FID4 ? &amp;op_data-&gt;op_fid4 : \</span>
<a name="l01896"></a>01896 <span class="preprocessor">         NULL)</span>
<a name="l01897"></a>01897 <span class="preprocessor"></span>
<a name="l01898"></a><a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">01898</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt,
<a name="l01899"></a>01899                             <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data, __u32 op_tgt,
<a name="l01900"></a>01900                             <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="code" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>, <span class="keywordtype">int</span> bits, <span class="keywordtype">int</span> flag)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902         <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid = <a class="code" href="lmv__obd_8c.html#ae7e8e11aebe0552a7567575d1a0d2bef">md_op_data_fid</a>(op_data, flag);
<a name="l01903"></a>01903         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01904"></a>01904         <span class="keyword">union </span><a class="code" href="unionldlm__policy__data.html">ldlm_policy_data</a> policy = { { 0 } };
<a name="l01905"></a>01905         <span class="keywordtype">int</span> rc = 0;
<a name="l01906"></a>01906         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         <span class="keywordflow">if</span> (!<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(fid))
<a name="l01909"></a>01909                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01910"></a>01910 
<a name="l01911"></a>01911         <span class="keywordflow">if</span> (tgt == NULL) {
<a name="l01912"></a>01912                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l01913"></a>01913                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01914"></a>01914                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01915"></a>01915         }
<a name="l01916"></a>01916 
<a name="l01917"></a>01917         <span class="keywordflow">if</span> (tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a> != op_tgt) {
<a name="l01918"></a>01918                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;EARLY_CANCEL on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid));
<a name="l01919"></a>01919                 policy.<a class="code" href="unionldlm__policy__data.html#a6d8b68c43c1ab750df044bdd2efade68">l_inodebits</a>.<a class="code" href="structldlm__inodebits.html#ab5ac21017af5d925dd81a7699544ea07">bits</a> = bits;
<a name="l01920"></a>01920                 rc = <a class="code" href="obd__class_8h.html#a4b8047517ca7b6d1f42e6f596d5eed92">md_cancel_unused</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, &amp;policy,
<a name="l01921"></a>01921                                       mode, <a class="code" href="group__LDLM.html#gga0b718c2d27bc15f43205e50e4da16ec9a280acd6e88765fc97a4833aa18e30968">LCF_ASYNC</a>, NULL);
<a name="l01922"></a>01922         } <span class="keywordflow">else</span> {
<a name="l01923"></a>01923                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>,
<a name="l01924"></a>01924                        <span class="stringliteral">&quot;EARLY_CANCEL skip operation target %d on &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01925"></a>01925                        op_tgt, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid));
<a name="l01926"></a>01926                 op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= flag;
<a name="l01927"></a>01927                 rc = 0;
<a name="l01928"></a>01928         }
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01931"></a>01931 }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 <span class="comment">/*</span>
<a name="l01934"></a>01934 <span class="comment"> * llite passes fid of an target inode in op_data-&gt;op_fid1 and id of directory in</span>
<a name="l01935"></a>01935 <span class="comment"> * op_data-&gt;op_fid2</span>
<a name="l01936"></a>01936 <span class="comment"> */</span>
<a name="l01937"></a><a class="code" href="lmv__obd_8c.html#a65d95805f65731dcf53d86b1a6349280">01937</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a65d95805f65731dcf53d86b1a6349280">lmv_link</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01938"></a>01938                     <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01939"></a>01939 {
<a name="l01940"></a>01940         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01941"></a>01941         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01942"></a>01942         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l01943"></a>01943         <span class="keywordtype">int</span>                      rc;
<a name="l01944"></a>01944         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l01947"></a>01947         <span class="keywordflow">if</span> (rc)
<a name="l01948"></a>01948                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a> != 0);
<a name="l01951"></a>01951 
<a name="l01952"></a>01952         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;LINK &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;:%*s to &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01953"></a>01953                <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>), (<span class="keywordtype">int</span>)op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>,
<a name="l01954"></a>01954                op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>));
<a name="l01955"></a>01955 
<a name="l01956"></a>01956         op_data-&gt;<a class="code" href="structmd__op__data.html#a096091526fc09c7706fc69e3f8348afa">op_fsuid</a> = <a class="code" href="curproc_8h.html#a66f4039bb7934c36699e7bc632fd3512">from_kuid</a>(&amp;init_user_ns, current_fsuid());
<a name="l01957"></a>01957         op_data-&gt;<a class="code" href="structmd__op__data.html#a0ff380b4a51163ac87c64c4f16c15a3a">op_fsgid</a> = <a class="code" href="curproc_8h.html#ab3c61983407215e47d1c5ff73ee005b0">from_kgid</a>(&amp;init_user_ns, current_fsgid());
<a name="l01958"></a>01958         op_data-&gt;<a class="code" href="structmd__op__data.html#a06337a829b74dad906b39f3e98b0d6a3">op_cap</a> = <a class="code" href="curproc_8h.html#a747326670202c7f4aed1bc3da8f34b36">cfs_curproc_cap_pack</a>();
<a name="l01959"></a>01959         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a> != NULL) {
<a name="l01960"></a>01960                 <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a>;
<a name="l01961"></a>01961                 <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a>  *oinfo;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963                 oinfo = <a class="code" href="lmv__internal_8h.html#a8314a1634e7809a525c9b510c62f6f54">lsm_name_to_stripe_info</a>(lsm, op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l01964"></a>01964                                                 op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>);
<a name="l01965"></a>01965                 <span class="keywordflow">if</span> (IS_ERR(oinfo))
<a name="l01966"></a>01966                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(oinfo));
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                 op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a> = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l01969"></a>01969         }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971         tgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l01972"></a>01972         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l01973"></a>01973                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l01974"></a>01974 
<a name="l01975"></a>01975         <span class="comment">/*</span>
<a name="l01976"></a>01976 <span class="comment">         * Cancel UPDATE lock on child (fid1).</span>
<a name="l01977"></a>01977 <span class="comment">         */</span>
<a name="l01978"></a>01978         op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a7a13a85734f86ca674c7c13ea756b62c">MF_MDC_CANCEL_FID2</a>;
<a name="l01979"></a>01979         rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, NULL, op_data, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>, <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>,
<a name="l01980"></a>01980                               <a class="code" href="group__lustreidl.html#ga9d50ae902ff5fd451a9e0454aac20b8c">MDS_INODELOCK_UPDATE</a>, <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a1f9bccfb422835679c05221cdea088c4">MF_MDC_CANCEL_FID1</a>);
<a name="l01981"></a>01981         <span class="keywordflow">if</span> (rc != 0)
<a name="l01982"></a>01982                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01983"></a>01983 
<a name="l01984"></a>01984         rc = <a class="code" href="obd__class_8h.html#a585ff024b8af076b7892c098e9d41c4e">md_link</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, request);
<a name="l01985"></a>01985 
<a name="l01986"></a>01986         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a><a class="code" href="lmv__obd_8c.html#a4353f342e8661da339737eb530de97ca">01989</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a4353f342e8661da339737eb530de97ca">lmv_rename</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l01990"></a>01990                       <span class="keyword">const</span> <span class="keywordtype">char</span> *old, <span class="keywordtype">size_t</span> oldlen,
<a name="l01991"></a>01991                       <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">new</span>, <span class="keywordtype">size_t</span> newlen,
<a name="l01992"></a>01992                       <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l01993"></a>01993 {
<a name="l01994"></a>01994         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l01995"></a>01995         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l01996"></a>01996         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *src_tgt;
<a name="l01997"></a>01997         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt_tgt;
<a name="l01998"></a>01998         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *target_exp;
<a name="l01999"></a>01999         <span class="keyword">struct </span><a class="code" href="structmdt__body.html">mdt_body</a>         *body;
<a name="l02000"></a>02000         <span class="keywordtype">int</span>                     rc;
<a name="l02001"></a>02001         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(oldlen != 0);
<a name="l02004"></a>02004 
<a name="l02005"></a>02005         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;RENAME %.*s in &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;:%d to %.*s in &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;:%d\n&quot;</span>,
<a name="l02006"></a>02006                (<span class="keywordtype">int</span>)oldlen, old, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>),
<a name="l02007"></a>02007                op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a> ? op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a> : 0,
<a name="l02008"></a>02008                (<span class="keywordtype">int</span>)newlen, <span class="keyword">new</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>),
<a name="l02009"></a>02009                op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a> ? op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a>-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a> : 0);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02012"></a>02012         <span class="keywordflow">if</span> (rc)
<a name="l02013"></a>02013                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02014"></a>02014 
<a name="l02015"></a>02015         op_data-&gt;<a class="code" href="structmd__op__data.html#a096091526fc09c7706fc69e3f8348afa">op_fsuid</a> = <a class="code" href="curproc_8h.html#a66f4039bb7934c36699e7bc632fd3512">from_kuid</a>(&amp;init_user_ns, current_fsuid());
<a name="l02016"></a>02016         op_data-&gt;<a class="code" href="structmd__op__data.html#a0ff380b4a51163ac87c64c4f16c15a3a">op_fsgid</a> = <a class="code" href="curproc_8h.html#ab3c61983407215e47d1c5ff73ee005b0">from_kgid</a>(&amp;init_user_ns, current_fsgid());
<a name="l02017"></a>02017         op_data-&gt;<a class="code" href="structmd__op__data.html#a06337a829b74dad906b39f3e98b0d6a3">op_cap</a> = <a class="code" href="curproc_8h.html#a747326670202c7f4aed1bc3da8f34b36">cfs_curproc_cap_pack</a>();
<a name="l02018"></a>02018         <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#aaa51c7316a1a65ca308c9ab560ab11fd">op_cli_flags</a> &amp; <a class="code" href="obd_8h.html#afa2d07c3fe9ba07c8b95ddeabdc04a8fad2ccd8aed310bd8e74f0e6ae54248420">CLI_MIGRATE</a>) {
<a name="l02019"></a>02019                 <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a1e51f5ad7479e0a944264149171e3e4c">op_fid3</a>), <span class="stringliteral">&quot;invalid FID &quot;</span>DFID<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02020"></a>02020                          <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a1e51f5ad7479e0a944264149171e3e4c">op_fid3</a>));
<a name="l02021"></a>02021 
<a name="l02022"></a>02022                 <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a> != NULL) {
<a name="l02023"></a>02023                         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l02024"></a>02024                         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tmp;
<a name="l02025"></a>02025 
<a name="l02026"></a>02026                         <span class="comment">/* Fix the parent fid for striped dir */</span>
<a name="l02027"></a>02027                         tmp = <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(lmv, lsm, old,
<a name="l02028"></a>02028                                                          oldlen,
<a name="l02029"></a>02029                                                          &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>,
<a name="l02030"></a>02030                                                          NULL);
<a name="l02031"></a>02031                         <span class="keywordflow">if</span> (IS_ERR(tmp))
<a name="l02032"></a>02032                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tmp));
<a name="l02033"></a>02033                 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035                 rc = <a class="code" href="lmv__internal_8h.html#aa4764c5b00212c1e2a298d6c4780d248">lmv_fid_alloc</a>(NULL, exp, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>, op_data);
<a name="l02036"></a>02036                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02037"></a>02037                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02038"></a>02038 
<a name="l02039"></a>02039                 src_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a1e51f5ad7479e0a944264149171e3e4c">op_fid3</a>);
<a name="l02040"></a>02040                 <span class="keywordflow">if</span> (IS_ERR(src_tgt))
<a name="l02041"></a>02041                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(src_tgt));
<a name="l02042"></a>02042 
<a name="l02043"></a>02043                 target_exp = src_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>;
<a name="l02044"></a>02044         } <span class="keywordflow">else</span> {
<a name="l02045"></a>02045                 <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a> != NULL) {
<a name="l02046"></a>02046                         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l02047"></a>02047 
<a name="l02048"></a>02048                         src_tgt = <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(lmv, lsm, old,
<a name="l02049"></a>02049                                                              oldlen,
<a name="l02050"></a>02050                                                              &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>,
<a name="l02051"></a>02051                                                              &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l02052"></a>02052                 } <span class="keywordflow">else</span> {
<a name="l02053"></a>02053                         src_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02054"></a>02054                 }
<a name="l02055"></a>02055                 <span class="keywordflow">if</span> (IS_ERR(src_tgt))
<a name="l02056"></a>02056                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(src_tgt));
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 
<a name="l02059"></a>02059                 <span class="keywordflow">if</span> (op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a> != NULL) {
<a name="l02060"></a>02060                         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a28f18b5e205069aa3220b9ebabd0654b">op_mea2</a>;
<a name="l02061"></a>02061 
<a name="l02062"></a>02062                         tgt_tgt = <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(lmv, lsm, <span class="keyword">new</span>,
<a name="l02063"></a>02063                                                              newlen,
<a name="l02064"></a>02064                                                              &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>,
<a name="l02065"></a>02065                                                              &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l02066"></a>02066                 } <span class="keywordflow">else</span> {
<a name="l02067"></a>02067                         tgt_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l02068"></a>02068 
<a name="l02069"></a>02069                 }
<a name="l02070"></a>02070                 <span class="keywordflow">if</span> (IS_ERR(tgt_tgt))
<a name="l02071"></a>02071                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt_tgt));
<a name="l02072"></a>02072 
<a name="l02073"></a>02073                 target_exp = tgt_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>;
<a name="l02074"></a>02074         }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076         <span class="comment">/*</span>
<a name="l02077"></a>02077 <span class="comment">         * LOOKUP lock on src child (fid3) should also be cancelled for</span>
<a name="l02078"></a>02078 <span class="comment">         * src_tgt in mdc_rename.</span>
<a name="l02079"></a>02079 <span class="comment">         */</span>
<a name="l02080"></a>02080         op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a1f9bccfb422835679c05221cdea088c4">MF_MDC_CANCEL_FID1</a> | <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>;
<a name="l02081"></a>02081 
<a name="l02082"></a>02082         <span class="comment">/*</span>
<a name="l02083"></a>02083 <span class="comment">         * Cancel UPDATE locks on tgt parent (fid2), tgt_tgt is its</span>
<a name="l02084"></a>02084 <span class="comment">         * own target.</span>
<a name="l02085"></a>02085 <span class="comment">         */</span>
<a name="l02086"></a>02086         rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, NULL, op_data, src_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>,
<a name="l02087"></a>02087                               <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>, <a class="code" href="group__lustreidl.html#ga9d50ae902ff5fd451a9e0454aac20b8c">MDS_INODELOCK_UPDATE</a>,
<a name="l02088"></a>02088                               <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a7a13a85734f86ca674c7c13ea756b62c">MF_MDC_CANCEL_FID2</a>);
<a name="l02089"></a>02089 
<a name="l02090"></a>02090         <span class="keywordflow">if</span> (rc != 0)
<a name="l02091"></a>02091                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02092"></a>02092         <span class="comment">/*</span>
<a name="l02093"></a>02093 <span class="comment">         * Cancel LOOKUP locks on source child (fid3) for parent tgt_tgt.</span>
<a name="l02094"></a>02094 <span class="comment">         */</span>
<a name="l02095"></a>02095         <span class="keywordflow">if</span> (<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a1e51f5ad7479e0a944264149171e3e4c">op_fid3</a>)) {
<a name="l02096"></a>02096                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt;
<a name="l02097"></a>02097 
<a name="l02098"></a>02098                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02099"></a>02099                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02100"></a>02100                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02101"></a>02101 
<a name="l02102"></a>02102                 <span class="comment">/* Cancel LOOKUP lock on its parent */</span>
<a name="l02103"></a>02103                 rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, tgt, op_data, src_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>,
<a name="l02104"></a>02104                                       <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>, <a class="code" href="group__lustreidl.html#ga9d11fad9fae40d3723211869adb181e4">MDS_INODELOCK_LOOKUP</a>,
<a name="l02105"></a>02105                                       <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>);
<a name="l02106"></a>02106                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02107"></a>02107                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02108"></a>02108 
<a name="l02109"></a>02109                 rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, NULL, op_data, src_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>,
<a name="l02110"></a>02110                                       <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>, <a class="code" href="group__lustreidl.html#gade362e25bded32429e29cf9f8322c2d5">MDS_INODELOCK_FULL</a>,
<a name="l02111"></a>02111                                       <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>);
<a name="l02112"></a>02112                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02113"></a>02113                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02114"></a>02114         }
<a name="l02115"></a>02115 
<a name="l02116"></a>02116 retry_rename:
<a name="l02117"></a>02117         <span class="comment">/*</span>
<a name="l02118"></a>02118 <span class="comment">         * Cancel all the locks on tgt child (fid4).</span>
<a name="l02119"></a>02119 <span class="comment">         */</span>
<a name="l02120"></a>02120         <span class="keywordflow">if</span> (<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ae30c9edce290b5b33001950b2307a712">op_fid4</a>)) {
<a name="l02121"></a>02121                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt;
<a name="l02122"></a>02122 
<a name="l02123"></a>02123                 rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, NULL, op_data, src_tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>,
<a name="l02124"></a>02124                                       <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>, <a class="code" href="group__lustreidl.html#gade362e25bded32429e29cf9f8322c2d5">MDS_INODELOCK_FULL</a>,
<a name="l02125"></a>02125                                       <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41ad9a3439c4b7f8d023f541f9c7c27b604">MF_MDC_CANCEL_FID4</a>);
<a name="l02126"></a>02126                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02127"></a>02127                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02128"></a>02128 
<a name="l02129"></a>02129                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ae30c9edce290b5b33001950b2307a712">op_fid4</a>);
<a name="l02130"></a>02130                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02131"></a>02131                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                 <span class="comment">/* Since the target child might be destroyed, and it might</span>
<a name="l02134"></a>02134 <span class="comment">                 * become orphan, and we can only check orphan on the local</span>
<a name="l02135"></a>02135 <span class="comment">                 * MDT right now, so we send rename request to the MDT where</span>
<a name="l02136"></a>02136 <span class="comment">                 * target child is located. If target child does not exist,</span>
<a name="l02137"></a>02137 <span class="comment">                 * then it will send the request to the target parent */</span>
<a name="l02138"></a>02138                 target_exp = tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>;
<a name="l02139"></a>02139         }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141         rc = <a class="code" href="obd__class_8h.html#abe9fe94f24a25cae7eb32523e28d6b41">md_rename</a>(target_exp, op_data, old, oldlen, <span class="keyword">new</span>, newlen,
<a name="l02142"></a>02142                        request);
<a name="l02143"></a>02143 
<a name="l02144"></a>02144         <span class="keywordflow">if</span> (rc != 0 &amp;&amp; rc != -EXDEV)
<a name="l02145"></a>02145                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02146"></a>02146 
<a name="l02147"></a>02147         body = <a class="code" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer...">req_capsule_server_get</a>(&amp;(*request)-&gt;rq_pill, &amp;<a class="code" href="group__req__layout.html#ga1c9ae136d2e4b00329d63bcb718c9d93">RMF_MDT_BODY</a>);
<a name="l02148"></a>02148         <span class="keywordflow">if</span> (body == NULL)
<a name="l02149"></a>02149                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EPROTO);
<a name="l02150"></a>02150 
<a name="l02151"></a>02151         <span class="comment">/* Not cross-ref case, just get out of here. */</span>
<a name="l02152"></a>02152         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!(body-&gt;<a class="code" href="structmdt__body.html#a1b206c7182c4ded5e8b9fbb1e8670bb5">mbo_valid</a> &amp; <a class="code" href="group__lustreidl.html#ga9cad3716fc653975a6f2e1853515c49f">OBD_MD_MDS</a>)))
<a name="l02153"></a>02153                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02154"></a>02154 
<a name="l02155"></a>02155         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: try rename to another MDT for &quot;</span>DFID<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02156"></a>02156                exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;body-&gt;<a class="code" href="structmdt__body.html#af95f5f511b3aacf651ad7822ee8b324b">mbo_fid1</a>));
<a name="l02157"></a>02157 
<a name="l02158"></a>02158         op_data-&gt;<a class="code" href="structmd__op__data.html#ae30c9edce290b5b33001950b2307a712">op_fid4</a> = body-&gt;<a class="code" href="structmdt__body.html#af95f5f511b3aacf651ad7822ee8b324b">mbo_fid1</a>;
<a name="l02159"></a>02159         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(*request);
<a name="l02160"></a>02160         *request = NULL;
<a name="l02161"></a>02161         <span class="keywordflow">goto</span> retry_rename;
<a name="l02162"></a>02162 }
<a name="l02163"></a>02163 
<a name="l02164"></a><a class="code" href="lmv__obd_8c.html#a5253b73fcc04860f8fbe1ddf51a80aef">02164</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a5253b73fcc04860f8fbe1ddf51a80aef">lmv_setattr</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l02165"></a>02165                        <span class="keywordtype">void</span> *ea, <span class="keywordtype">size_t</span> ealen, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l02166"></a>02166 {
<a name="l02167"></a>02167         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02168"></a>02168         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02169"></a>02169         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l02170"></a>02170         <span class="keywordtype">int</span>                      rc = 0;
<a name="l02171"></a>02171         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02172"></a>02172 
<a name="l02173"></a>02173         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02174"></a>02174         <span class="keywordflow">if</span> (rc)
<a name="l02175"></a>02175                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02176"></a>02176 
<a name="l02177"></a>02177         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;SETATTR for &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;, valid 0x%x\n&quot;</span>,
<a name="l02178"></a>02178                <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>), op_data-&gt;<a class="code" href="structmd__op__data.html#a0ab042edfc995ef299ad50aab8ff85aa">op_attr</a>.ia_valid);
<a name="l02179"></a>02179 
<a name="l02180"></a>02180         op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a1f9bccfb422835679c05221cdea088c4">MF_MDC_CANCEL_FID1</a>;
<a name="l02181"></a>02181         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02182"></a>02182         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02183"></a>02183                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02184"></a>02184 
<a name="l02185"></a>02185         rc = <a class="code" href="obd__class_8h.html#ad3c29883560c5f919b67275ad2bd3eae">md_setattr</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, ea, ealen, request);
<a name="l02186"></a>02186 
<a name="l02187"></a>02187         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02188"></a>02188 }
<a name="l02189"></a>02189 
<a name="l02190"></a><a class="code" href="lmv__obd_8c.html#a24348514ac1032d2c71a05f4225faa2d">02190</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a24348514ac1032d2c71a05f4225faa2d">lmv_fsync</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l02191"></a>02191                      <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l02192"></a>02192 {
<a name="l02193"></a>02193         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02194"></a>02194         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02195"></a>02195         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l02196"></a>02196         <span class="keywordtype">int</span>                      rc;
<a name="l02197"></a>02197         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02198"></a>02198 
<a name="l02199"></a>02199         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02200"></a>02200         <span class="keywordflow">if</span> (rc != 0)
<a name="l02201"></a>02201                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02202"></a>02202 
<a name="l02203"></a>02203         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l02204"></a>02204         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02205"></a>02205                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02206"></a>02206 
<a name="l02207"></a>02207         rc = <a class="code" href="obd__class_8h.html#a91198476dbe1f407528219f3d00d55b9">md_fsync</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, request);
<a name="l02208"></a>02208         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02209"></a>02209 }
<a name="l02210"></a>02210 
<a name="l02239"></a><a class="code" href="lmv__obd_8c.html#ad3e540df724497316005ac3e543ec1bc">02239</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad3e540df724497316005ac3e543ec1bc" title="Get current minimum entry from striped directory.">lmv_get_min_striped_entry</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l02240"></a>02240                                      <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l02241"></a>02241                                      <span class="keyword">struct</span> <a class="code" href="structmd__callback.html">md_callback</a> *cb_op,
<a name="l02242"></a>02242                                      <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> hash_offset, <span class="keywordtype">int</span> *stripe_offset,
<a name="l02243"></a>02243                                      <span class="keyword">struct</span> <a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a> **entp,
<a name="l02244"></a>02244                                      <span class="keyword">struct</span> page **ppage)
<a name="l02245"></a>02245 {
<a name="l02246"></a>02246         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02247"></a>02247         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02248"></a>02248         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l02249"></a>02249         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l02250"></a>02250         <span class="keywordtype">int</span>                     stripe_count;
<a name="l02251"></a>02251         <span class="keyword">struct </span><a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a>        *min_ent = NULL;
<a name="l02252"></a>02252         <span class="keyword">struct </span>page             *min_page = NULL;
<a name="l02253"></a>02253         <span class="keywordtype">int</span>                     min_idx = 0;
<a name="l02254"></a>02254         <span class="keywordtype">int</span>                     i;
<a name="l02255"></a>02255         <span class="keywordtype">int</span>                     rc = 0;
<a name="l02256"></a>02256         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02257"></a>02257 
<a name="l02258"></a>02258         stripe_count = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>;
<a name="l02259"></a>02259         <span class="keywordflow">for</span> (i = 0; i &lt; stripe_count; i++) {
<a name="l02260"></a>02260                 <span class="keyword">struct </span><a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a>        *ent = NULL;
<a name="l02261"></a>02261                 <span class="keyword">struct </span>page             *page = NULL;
<a name="l02262"></a>02262                 <span class="keyword">struct </span><a class="code" href="structlu__dirpage.html">lu_dirpage</a>       *dp;
<a name="l02263"></a>02263                 <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   stripe_hash = hash_offset;
<a name="l02264"></a>02264 
<a name="l02265"></a>02265                 tgt = <a class="code" href="lmv__internal_8h.html#a8e5f17e406c63cfdc26419d34cf57d94">lmv_get_target</a>(lmv, lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>, NULL);
<a name="l02266"></a>02266                 <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02267"></a>02267                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = PTR_ERR(tgt));
<a name="l02268"></a>02268 
<a name="l02269"></a>02269                 <span class="comment">/* op_data will be shared by each stripe, so we need</span>
<a name="l02270"></a>02270 <span class="comment">                 * reset these value for each stripe */</span>
<a name="l02271"></a>02271                 op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a> = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l02272"></a>02272                 op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a> = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l02273"></a>02273                 op_data-&gt;<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a> = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a01c7eddb3fd23a901cc12462adfb07d5">lmo_root</a>;
<a name="l02274"></a>02274 next:
<a name="l02275"></a>02275                 rc = <a class="code" href="obd__class_8h.html#a4bae252fd84c041a7ffcbd8e7a34ba81">md_read_page</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, cb_op, stripe_hash,
<a name="l02276"></a>02276                                   &amp;page);
<a name="l02277"></a>02277                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02278"></a>02278                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l02279"></a>02279 
<a name="l02280"></a>02280                 dp = page_address(page);
<a name="l02281"></a>02281                 <span class="keywordflow">for</span> (ent = <a class="code" href="group__lu__dir.html#ga066a659ac9079ed9a992bc549addf78f">lu_dirent_start</a>(dp); ent != NULL;
<a name="l02282"></a>02282                      ent = <a class="code" href="group__lu__dir.html#gaa37cab0269c41a9d76a9c12e6c351f65">lu_dirent_next</a>(ent)) {
<a name="l02283"></a>02283                         <span class="comment">/* Skip dummy entry */</span>
<a name="l02284"></a>02284                         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>) == 0)
<a name="l02285"></a>02285                                 <span class="keywordflow">continue</span>;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287                         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>) &lt; hash_offset)
<a name="l02288"></a>02288                                 <span class="keywordflow">continue</span>;
<a name="l02289"></a>02289 
<a name="l02290"></a>02290                         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>) == hash_offset &amp;&amp;
<a name="l02291"></a>02291                             (*entp == ent || i &lt; *stripe_offset))
<a name="l02292"></a>02292                                 <span class="keywordflow">continue</span>;
<a name="l02293"></a>02293 
<a name="l02294"></a>02294                         <span class="comment">/* skip . and .. for other stripes */</span>
<a name="l02295"></a>02295                         <span class="keywordflow">if</span> (i != 0 &amp;&amp;
<a name="l02296"></a>02296                             (strncmp(ent-&gt;<a class="code" href="structlu__dirent.html#a3e3b5a552269757293891e23de373a3f" title="name is followed by the attributes indicated in -&amp;gt;ldp_attrs, in their natural...">lde_name</a>, <span class="stringliteral">&quot;.&quot;</span>,
<a name="l02297"></a>02297                                      <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>)) == 0 ||
<a name="l02298"></a>02298                              strncmp(ent-&gt;<a class="code" href="structlu__dirent.html#a3e3b5a552269757293891e23de373a3f" title="name is followed by the attributes indicated in -&amp;gt;ldp_attrs, in their natural...">lde_name</a>, <span class="stringliteral">&quot;..&quot;</span>,
<a name="l02299"></a>02299                                      <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>)) == 0))
<a name="l02300"></a>02300                                 <span class="keywordflow">continue</span>;
<a name="l02301"></a>02301                         <span class="keywordflow">break</span>;
<a name="l02302"></a>02302                 }
<a name="l02303"></a>02303 
<a name="l02304"></a>02304                 <span class="keywordflow">if</span> (ent == NULL) {
<a name="l02305"></a>02305                         stripe_hash = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(dp-&gt;<a class="code" href="structlu__dirpage.html#ae0ed53931187baf0548edcafe31345b1">ldp_hash_end</a>);
<a name="l02306"></a>02306 
<a name="l02307"></a>02307                         kunmap(page);
<a name="l02308"></a>02308                         page_cache_release(page);
<a name="l02309"></a>02309                         page = NULL;
<a name="l02310"></a>02310 
<a name="l02311"></a>02311                         <span class="comment">/* reach the end of current stripe, go to next stripe */</span>
<a name="l02312"></a>02312                         <span class="keywordflow">if</span> (stripe_hash == <a class="code" href="group__lu__dir.html#ga396a3df870ba4c0ad044488c8174bc43">MDS_DIR_END_OFF</a>)
<a name="l02313"></a>02313                                 <span class="keywordflow">continue</span>;
<a name="l02314"></a>02314                         <span class="keywordflow">else</span>
<a name="l02315"></a>02315                                 <span class="keywordflow">goto</span> next;
<a name="l02316"></a>02316                 }
<a name="l02317"></a>02317 
<a name="l02318"></a>02318                 <span class="keywordflow">if</span> (min_ent != NULL) {
<a name="l02319"></a>02319                         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>) &gt;
<a name="l02320"></a>02320                             <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>)) {
<a name="l02321"></a>02321                                 min_ent = ent;
<a name="l02322"></a>02322                                 kunmap(min_page);
<a name="l02323"></a>02323                                 page_cache_release(min_page);
<a name="l02324"></a>02324                                 min_idx = i;
<a name="l02325"></a>02325                                 min_page = page;
<a name="l02326"></a>02326                         } <span class="keywordflow">else</span> {
<a name="l02327"></a>02327                                 kunmap(page);
<a name="l02328"></a>02328                                 page_cache_release(page);
<a name="l02329"></a>02329                                 page = NULL;
<a name="l02330"></a>02330                         }
<a name="l02331"></a>02331                 } <span class="keywordflow">else</span> {
<a name="l02332"></a>02332                         min_ent = ent;
<a name="l02333"></a>02333                         min_page = page;
<a name="l02334"></a>02334                         min_idx = i;
<a name="l02335"></a>02335                 }
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337 
<a name="l02338"></a>02338 out:
<a name="l02339"></a>02339         <span class="keywordflow">if</span> (*ppage != NULL) {
<a name="l02340"></a>02340                 kunmap(*ppage);
<a name="l02341"></a>02341                 page_cache_release(*ppage);
<a name="l02342"></a>02342         }
<a name="l02343"></a>02343         *stripe_offset = min_idx;
<a name="l02344"></a>02344         *entp = min_ent;
<a name="l02345"></a>02345         *ppage = min_page;
<a name="l02346"></a>02346         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02347"></a>02347 }
<a name="l02348"></a>02348 
<a name="l02373"></a><a class="code" href="lmv__obd_8c.html#a9306d1671483ded885d429e7e6d1cdaa">02373</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a9306d1671483ded885d429e7e6d1cdaa" title="Build dir entry page from a striped directory.">lmv_read_striped_page</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l02374"></a>02374                                  <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l02375"></a>02375                                  <span class="keyword">struct</span> <a class="code" href="structmd__callback.html">md_callback</a> *cb_op,
<a name="l02376"></a>02376                                  <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> offset, <span class="keyword">struct</span> page **ppage)
<a name="l02377"></a>02377 {
<a name="l02378"></a>02378         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02379"></a>02379         <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>           master_fid = op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>;
<a name="l02380"></a>02380         <span class="keyword">struct </span>inode            *master_inode = op_data-&gt;<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a>;
<a name="l02381"></a>02381         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   hash_offset = offset;
<a name="l02382"></a>02382         <span class="keyword">struct </span><a class="code" href="structlu__dirpage.html">lu_dirpage</a>       *dp;
<a name="l02383"></a>02383         <span class="keyword">struct </span>page             *min_ent_page = NULL;
<a name="l02384"></a>02384         <span class="keyword">struct </span>page             *ent_page = NULL;
<a name="l02385"></a>02385         <span class="keyword">struct </span><a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a>        *ent;
<a name="l02386"></a>02386         <span class="keywordtype">void</span>                    *area;
<a name="l02387"></a>02387         <span class="keywordtype">int</span>                     ent_idx = 0;
<a name="l02388"></a>02388         <span class="keyword">struct </span><a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a>        *min_ent = NULL;
<a name="l02389"></a>02389         <span class="keyword">struct </span><a class="code" href="structlu__dirent.html" title="Layout of readdir pages, as transmitted on wire.">lu_dirent</a>        *last_ent;
<a name="l02390"></a>02390         <span class="keywordtype">size_t</span>                  left_bytes;
<a name="l02391"></a>02391         <span class="keywordtype">int</span>                     rc;
<a name="l02392"></a>02392         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02393"></a>02393 
<a name="l02394"></a>02394         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02395"></a>02395         <span class="keywordflow">if</span> (rc)
<a name="l02396"></a>02396                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02397"></a>02397 
<a name="l02398"></a>02398         <span class="comment">/* Allocate a page and read entries from all of stripes and fill</span>
<a name="l02399"></a>02399 <span class="comment">         * the page by hash order */</span>
<a name="l02400"></a>02400         ent_page = alloc_page(GFP_KERNEL);
<a name="l02401"></a>02401         <span class="keywordflow">if</span> (ent_page == NULL)
<a name="l02402"></a>02402                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l02403"></a>02403 
<a name="l02404"></a>02404         <span class="comment">/* Initialize the entry page */</span>
<a name="l02405"></a>02405         dp = kmap(ent_page);
<a name="l02406"></a>02406         memset(dp, 0, <span class="keyword">sizeof</span>(*dp));
<a name="l02407"></a>02407         dp-&gt;<a class="code" href="structlu__dirpage.html#acc1b482af185225738f5ce6caca3278c">ldp_hash_start</a> = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(offset);
<a name="l02408"></a>02408         dp-&gt;<a class="code" href="structlu__dirpage.html#ab9d7b9e4ef1334aac58c111b83b7abd3">ldp_flags</a> |= <a class="code" href="group__lu__dir.html#gga8e36a5c3ab28f2a81a6a17c6397bffeea2e5d9d6700b40d5386cd4a6597e74ab2" title="last entry&amp;#39;s lde_hash equals ldp_hash_end.">LDF_COLLIDE</a>;
<a name="l02409"></a>02409 
<a name="l02410"></a>02410         area = dp + 1;
<a name="l02411"></a>02411         left_bytes = PAGE_CACHE_SIZE - <span class="keyword">sizeof</span>(*dp);
<a name="l02412"></a>02412         ent = area;
<a name="l02413"></a>02413         last_ent = ent;
<a name="l02414"></a>02414         <span class="keywordflow">do</span> {
<a name="l02415"></a>02415                 __u16   ent_size;
<a name="l02416"></a>02416 
<a name="l02417"></a>02417                 <span class="comment">/* Find the minum entry from all sub-stripes */</span>
<a name="l02418"></a>02418                 rc = <a class="code" href="lmv__obd_8c.html#ad3e540df724497316005ac3e543ec1bc" title="Get current minimum entry from striped directory.">lmv_get_min_striped_entry</a>(exp, op_data, cb_op, hash_offset,
<a name="l02419"></a>02419                                                &amp;ent_idx, &amp;min_ent,
<a name="l02420"></a>02420                                                &amp;min_ent_page);
<a name="l02421"></a>02421                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02422"></a>02422                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l02423"></a>02423 
<a name="l02424"></a>02424                 <span class="comment">/* If it can not get minum entry, it means it already reaches</span>
<a name="l02425"></a>02425 <span class="comment">                 * the end of this directory */</span>
<a name="l02426"></a>02426                 <span class="keywordflow">if</span> (min_ent == NULL) {
<a name="l02427"></a>02427                         last_ent-&gt;<a class="code" href="structlu__dirent.html#a241bc48a83ebfb3219722f6a6afbe66a" title="total record length, including all attributes.">lde_reclen</a> = 0;
<a name="l02428"></a>02428                         hash_offset = <a class="code" href="group__lu__dir.html#ga396a3df870ba4c0ad044488c8174bc43">MDS_DIR_END_OFF</a>;
<a name="l02429"></a>02429                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l02430"></a>02430                 }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432                 ent_size = <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#a241bc48a83ebfb3219722f6a6afbe66a" title="total record length, including all attributes.">lde_reclen</a>);
<a name="l02433"></a>02433 
<a name="l02434"></a>02434                 <span class="comment">/* the last entry lde_reclen is 0, but it might not</span>
<a name="l02435"></a>02435 <span class="comment">                 * the end of this entry of this temporay entry */</span>
<a name="l02436"></a>02436                 <span class="keywordflow">if</span> (ent_size == 0)
<a name="l02437"></a>02437                         ent_size = <a class="code" href="group__lu__dir.html#ga4618cc1ec302c51ae82b9a80f4fdc1c8">lu_dirent_calc_size</a>(
<a name="l02438"></a>02438                                         <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>),
<a name="l02439"></a>02439                                         <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#af1fe2598c44bab695e849de0a2ca80dc" title="optional variable size attributes following this entry.">lde_attrs</a>));
<a name="l02440"></a>02440                 <span class="keywordflow">if</span> (ent_size &gt; left_bytes) {
<a name="l02441"></a>02441                         last_ent-&gt;<a class="code" href="structlu__dirent.html#a241bc48a83ebfb3219722f6a6afbe66a" title="total record length, including all attributes.">lde_reclen</a> = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(0);
<a name="l02442"></a>02442                         hash_offset = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>);
<a name="l02443"></a>02443                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l02444"></a>02444                 }
<a name="l02445"></a>02445 
<a name="l02446"></a>02446                 memcpy(ent, min_ent, ent_size);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448                 <span class="comment">/* Replace . with master FID and Replace .. with the parent FID</span>
<a name="l02449"></a>02449 <span class="comment">                 * of master object */</span>
<a name="l02450"></a>02450                 <span class="keywordflow">if</span> (strncmp(ent-&gt;<a class="code" href="structlu__dirent.html#a3e3b5a552269757293891e23de373a3f" title="name is followed by the attributes indicated in -&amp;gt;ldp_attrs, in their natural...">lde_name</a>, <span class="stringliteral">&quot;.&quot;</span>,
<a name="l02451"></a>02451                             <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>)) == 0 &amp;&amp;
<a name="l02452"></a>02452                     <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>) == 1)
<a name="l02453"></a>02453                         <a class="code" href="group__lu__fid.html#ga67ad15a9c2e4676b57dd84272d2e6849">fid_cpu_to_le</a>(&amp;ent-&gt;<a class="code" href="structlu__dirent.html#a58764bd31894298ed7ab119d7a245308" title="valid if LUDA_FID is set.">lde_fid</a>, &amp;master_fid);
<a name="l02454"></a>02454                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ent-&gt;<a class="code" href="structlu__dirent.html#a3e3b5a552269757293891e23de373a3f" title="name is followed by the attributes indicated in -&amp;gt;ldp_attrs, in their natural...">lde_name</a>, <span class="stringliteral">&quot;..&quot;</span>,
<a name="l02455"></a>02455                                    <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>)) == 0 &amp;&amp;
<a name="l02456"></a>02456                            <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(ent-&gt;<a class="code" href="structlu__dirent.html#a6cf011f9cdc36e619bad6e893a537c02" title="name length">lde_namelen</a>) == 2)
<a name="l02457"></a>02457                         <a class="code" href="group__lu__fid.html#ga67ad15a9c2e4676b57dd84272d2e6849">fid_cpu_to_le</a>(&amp;ent-&gt;<a class="code" href="structlu__dirent.html#a58764bd31894298ed7ab119d7a245308" title="valid if LUDA_FID is set.">lde_fid</a>, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a1e51f5ad7479e0a944264149171e3e4c">op_fid3</a>);
<a name="l02458"></a>02458 
<a name="l02459"></a>02459                 left_bytes -= ent_size;
<a name="l02460"></a>02460                 ent-&gt;<a class="code" href="structlu__dirent.html#a241bc48a83ebfb3219722f6a6afbe66a" title="total record length, including all attributes.">lde_reclen</a> = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(ent_size);
<a name="l02461"></a>02461                 last_ent = ent;
<a name="l02462"></a>02462                 ent = (<span class="keywordtype">void</span> *)ent + ent_size;
<a name="l02463"></a>02463                 hash_offset = <a class="code" href="byteorder_8h.html#a0987d88a4fac98f0b1d6355ef7aa77e2">le64_to_cpu</a>(min_ent-&gt;<a class="code" href="structlu__dirent.html#a93db8cf242015f8192bd7263f8a50e2e" title="a unique entry identifier: a hash or an offset.">lde_hash</a>);
<a name="l02464"></a>02464                 <span class="keywordflow">if</span> (hash_offset == <a class="code" href="group__lu__dir.html#ga396a3df870ba4c0ad044488c8174bc43">MDS_DIR_END_OFF</a>) {
<a name="l02465"></a>02465                         last_ent-&gt;<a class="code" href="structlu__dirent.html#a241bc48a83ebfb3219722f6a6afbe66a" title="total record length, including all attributes.">lde_reclen</a> = 0;
<a name="l02466"></a>02466                         <span class="keywordflow">break</span>;
<a name="l02467"></a>02467                 }
<a name="l02468"></a>02468         } <span class="keywordflow">while</span> (1);
<a name="l02469"></a>02469 out:
<a name="l02470"></a>02470         <span class="keywordflow">if</span> (min_ent_page != NULL) {
<a name="l02471"></a>02471                 kunmap(min_ent_page);
<a name="l02472"></a>02472                 page_cache_release(min_ent_page);
<a name="l02473"></a>02473         }
<a name="l02474"></a>02474 
<a name="l02475"></a>02475         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rc != 0)) {
<a name="l02476"></a>02476                 __free_page(ent_page);
<a name="l02477"></a>02477                 ent_page = NULL;
<a name="l02478"></a>02478         } <span class="keywordflow">else</span> {
<a name="l02479"></a>02479                 <span class="keywordflow">if</span> (ent == area)
<a name="l02480"></a>02480                         dp-&gt;ldp_flags |= <a class="code" href="group__lu__dir.html#gga8e36a5c3ab28f2a81a6a17c6397bffeea02f7885580c8a3b030cac3515ff7e3b6" title="dirpage contains no entry.">LDF_EMPTY</a>;
<a name="l02481"></a>02481                 dp-&gt;ldp_flags = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(dp-&gt;ldp_flags);
<a name="l02482"></a>02482                 dp-&gt;ldp_hash_end = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(hash_offset);
<a name="l02483"></a>02483         }
<a name="l02484"></a>02484 
<a name="l02485"></a>02485         <span class="comment">/* We do not want to allocate md_op_data during each</span>
<a name="l02486"></a>02486 <span class="comment">         * dir entry reading, so op_data will be shared by every stripe,</span>
<a name="l02487"></a>02487 <span class="comment">         * then we need to restore it back to original value before</span>
<a name="l02488"></a>02488 <span class="comment">         * return to the upper layer */</span>
<a name="l02489"></a>02489         op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a> = master_fid;
<a name="l02490"></a>02490         op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a> = master_fid;
<a name="l02491"></a>02491         op_data-&gt;<a class="code" href="structmd__op__data.html#a92923c286cac10ce4ddf7d7fe499843a">op_data</a> = master_inode;
<a name="l02492"></a>02492 
<a name="l02493"></a>02493         *ppage = ent_page;
<a name="l02494"></a>02494 
<a name="l02495"></a>02495         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02496"></a>02496 }
<a name="l02497"></a>02497 
<a name="l02498"></a><a class="code" href="lmv__obd_8c.html#a77ddaef3bfdf78719995a9b055348eb9">02498</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a77ddaef3bfdf78719995a9b055348eb9">lmv_read_page</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l02499"></a>02499                   <span class="keyword">struct</span> <a class="code" href="structmd__callback.html">md_callback</a> *cb_op, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> offset,
<a name="l02500"></a>02500                   <span class="keyword">struct</span> page **ppage)
<a name="l02501"></a>02501 {
<a name="l02502"></a>02502         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02503"></a>02503         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02504"></a>02504         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l02505"></a>02505         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l02506"></a>02506         <span class="keywordtype">int</span>                     rc;
<a name="l02507"></a>02507         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02508"></a>02508 
<a name="l02509"></a>02509         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02510"></a>02510         <span class="keywordflow">if</span> (rc != 0)
<a name="l02511"></a>02511                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02512"></a>02512 
<a name="l02513"></a>02513         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(lsm != NULL)) {
<a name="l02514"></a>02514                 rc = <a class="code" href="lmv__obd_8c.html#a9306d1671483ded885d429e7e6d1cdaa" title="Build dir entry page from a striped directory.">lmv_read_striped_page</a>(exp, op_data, cb_op, offset, ppage);
<a name="l02515"></a>02515                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02516"></a>02516         }
<a name="l02517"></a>02517 
<a name="l02518"></a>02518         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02519"></a>02519         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02520"></a>02520                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         rc = <a class="code" href="obd__class_8h.html#a4bae252fd84c041a7ffcbd8e7a34ba81">md_read_page</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, cb_op, offset, ppage);
<a name="l02523"></a>02523 
<a name="l02524"></a>02524         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02525"></a>02525 }
<a name="l02526"></a>02526 
<a name="l02551"></a><a class="code" href="lmv__obd_8c.html#a37f938dadecf8e635ec310b25da1af6e">02551</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a37f938dadecf8e635ec310b25da1af6e" title="Unlink a file/directory.">lmv_unlink</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structmd__op__data.html">md_op_data</a> *op_data,
<a name="l02552"></a>02552                       <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l02553"></a>02553 {
<a name="l02554"></a>02554         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l02555"></a>02555         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02556"></a>02556         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = NULL;
<a name="l02557"></a>02557         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *parent_tgt = NULL;
<a name="l02558"></a>02558         <span class="keyword">struct </span><a class="code" href="structmdt__body.html">mdt_body</a>         *body;
<a name="l02559"></a>02559         <span class="keywordtype">int</span>                     rc;
<a name="l02560"></a>02560         <span class="keywordtype">int</span>                     stripe_index = 0;
<a name="l02561"></a>02561         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>    *lsm = op_data-&gt;<a class="code" href="structmd__op__data.html#a26f0da80d5c3aec8055f9a62f68a4def">op_mea1</a>;
<a name="l02562"></a>02562         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02563"></a>02563 
<a name="l02564"></a>02564         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02565"></a>02565         <span class="keywordflow">if</span> (rc)
<a name="l02566"></a>02566                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02567"></a>02567 retry_unlink:
<a name="l02568"></a>02568         <span class="comment">/* For striped dir, we need to locate the parent as well */</span>
<a name="l02569"></a>02569         <span class="keywordflow">if</span> (lsm != NULL) {
<a name="l02570"></a>02570                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tmp;
<a name="l02571"></a>02571 
<a name="l02572"></a>02572                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a> != NULL &amp;&amp;
<a name="l02573"></a>02573                         op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a> != 0);
<a name="l02574"></a>02574 
<a name="l02575"></a>02575                 tmp = <a class="code" href="lmv__obd_8c.html#a88408ee5a618fea7f219445b92570a10" title="Choosing the MDT by name or FID in .">lmv_locate_target_for_name</a>(lmv, lsm,
<a name="l02576"></a>02576                                                  op_data-&gt;<a class="code" href="structmd__op__data.html#a3ab0aea452f6640f96badcaf1fc4ae57">op_name</a>,
<a name="l02577"></a>02577                                                  op_data-&gt;<a class="code" href="structmd__op__data.html#af911ffe374616a60b297e2b4837ac870">op_namelen</a>,
<a name="l02578"></a>02578                                                  &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>,
<a name="l02579"></a>02579                                                  &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>);
<a name="l02580"></a>02580 
<a name="l02581"></a>02581                 <span class="comment">/* return -EBADFD means unknown hash type, might</span>
<a name="l02582"></a>02582 <span class="comment">                 * need try all sub-stripe here */</span>
<a name="l02583"></a>02583                 <span class="keywordflow">if</span> (IS_ERR(tmp) &amp;&amp; PTR_ERR(tmp) != -EBADFD)
<a name="l02584"></a>02584                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tmp));
<a name="l02585"></a>02585 
<a name="l02586"></a>02586                 <span class="comment">/* Note: both migrating dir and unknown hash dir need to</span>
<a name="l02587"></a>02587 <span class="comment">                 * try all of sub-stripes, so we need start search the</span>
<a name="l02588"></a>02588 <span class="comment">                 * name from stripe 0, but migrating dir is already handled</span>
<a name="l02589"></a>02589 <span class="comment">                 * inside lmv_locate_target_for_name(), so we only check</span>
<a name="l02590"></a>02590 <span class="comment">                 * unknown hash type directory here */</span>
<a name="l02591"></a>02591                 <span class="keywordflow">if</span> (!<a class="code" href="lustre__lmv_8h.html#a59b0e1c5f0cd2696c14265a3dc4ee98e">lmv_is_known_hash_type</a>(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#ad4e0acda2e6c2fe0c6e385df05f78d88">lsm_md_hash_type</a>)) {
<a name="l02592"></a>02592                         <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a> *oinfo;
<a name="l02593"></a>02593 
<a name="l02594"></a>02594                         oinfo = &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[stripe_index];
<a name="l02595"></a>02595 
<a name="l02596"></a>02596                         op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a> = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l02597"></a>02597                         op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>;
<a name="l02598"></a>02598                 }
<a name="l02599"></a>02599         }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 try_next_stripe:
<a name="l02602"></a>02602         <span class="comment">/* Send unlink requests to the MDT where the child is located */</span>
<a name="l02603"></a>02603         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!<a class="code" href="group__lustreuser.html#ga2c265e188b56db802b9a4ca3b1deb9a9">fid_is_zero</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>)))
<a name="l02604"></a>02604                 tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l02605"></a>02605         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lsm != NULL)
<a name="l02606"></a>02606                 tgt = <a class="code" href="lmv__internal_8h.html#a8e5f17e406c63cfdc26419d34cf57d94">lmv_get_target</a>(lmv, op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a>, NULL);
<a name="l02607"></a>02607         <span class="keywordflow">else</span>
<a name="l02608"></a>02608                 tgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02609"></a>02609 
<a name="l02610"></a>02610         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l02611"></a>02611                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l02612"></a>02612 
<a name="l02613"></a>02613         op_data-&gt;<a class="code" href="structmd__op__data.html#a096091526fc09c7706fc69e3f8348afa">op_fsuid</a> = <a class="code" href="curproc_8h.html#a66f4039bb7934c36699e7bc632fd3512">from_kuid</a>(&amp;init_user_ns, current_fsuid());
<a name="l02614"></a>02614         op_data-&gt;<a class="code" href="structmd__op__data.html#a0ff380b4a51163ac87c64c4f16c15a3a">op_fsgid</a> = <a class="code" href="curproc_8h.html#ab3c61983407215e47d1c5ff73ee005b0">from_kgid</a>(&amp;init_user_ns, current_fsgid());
<a name="l02615"></a>02615         op_data-&gt;<a class="code" href="structmd__op__data.html#a06337a829b74dad906b39f3e98b0d6a3">op_cap</a> = <a class="code" href="curproc_8h.html#a747326670202c7f4aed1bc3da8f34b36">cfs_curproc_cap_pack</a>();
<a name="l02616"></a>02616 
<a name="l02617"></a>02617         <span class="comment">/*</span>
<a name="l02618"></a>02618 <span class="comment">         * If child&apos;s fid is given, cancel unused locks for it if it is from</span>
<a name="l02619"></a>02619 <span class="comment">         * another export than parent.</span>
<a name="l02620"></a>02620 <span class="comment">         *</span>
<a name="l02621"></a>02621 <span class="comment">         * LOOKUP lock for child (fid3) should also be cancelled on parent</span>
<a name="l02622"></a>02622 <span class="comment">         * tgt_tgt in mdc_unlink().</span>
<a name="l02623"></a>02623 <span class="comment">         */</span>
<a name="l02624"></a>02624         op_data-&gt;<a class="code" href="structmd__op__data.html#ab2377aa866ff6869d4268894d1ac44f2">op_flags</a> |= <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41a1f9bccfb422835679c05221cdea088c4">MF_MDC_CANCEL_FID1</a> | <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>;
<a name="l02625"></a>02625 
<a name="l02626"></a>02626         <span class="comment">/*</span>
<a name="l02627"></a>02627 <span class="comment">         * Cancel FULL locks on child (fid3).</span>
<a name="l02628"></a>02628 <span class="comment">         */</span>
<a name="l02629"></a>02629         parent_tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l02630"></a>02630         <span class="keywordflow">if</span> (IS_ERR(parent_tgt))
<a name="l02631"></a>02631                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(parent_tgt));
<a name="l02632"></a>02632 
<a name="l02633"></a>02633         <span class="keywordflow">if</span> (parent_tgt != tgt) {
<a name="l02634"></a>02634                 rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, parent_tgt, op_data, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>,
<a name="l02635"></a>02635                                       <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>, <a class="code" href="group__lustreidl.html#ga9d11fad9fae40d3723211869adb181e4">MDS_INODELOCK_LOOKUP</a>,
<a name="l02636"></a>02636                                       <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>);
<a name="l02637"></a>02637         }
<a name="l02638"></a>02638 
<a name="l02639"></a>02639         rc = <a class="code" href="lmv__obd_8c.html#acb28528e96bc841bc035cc1beaf7408d">lmv_early_cancel</a>(exp, NULL, op_data, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>, <a class="code" href="packet-lustre_8c.html#a815dc82e9e2dcd1843911ea0bdc3e3c7">LCK_EX</a>,
<a name="l02640"></a>02640                               <a class="code" href="group__lustreidl.html#gade362e25bded32429e29cf9f8322c2d5">MDS_INODELOCK_FULL</a>, <a class="code" href="obd_8h.html#af5f3a30050e9fc85c19ee2fff6bf4d41af3f650b715dd186cc2bee8eb6c7023a2">MF_MDC_CANCEL_FID3</a>);
<a name="l02641"></a>02641         <span class="keywordflow">if</span> (rc != 0)
<a name="l02642"></a>02642                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02643"></a>02643 
<a name="l02644"></a>02644         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;unlink with fid=&quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;/&quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; -&gt; mds #%u\n&quot;</span>,
<a name="l02645"></a>02645                <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>), <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>), tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a2938df43a26a6306d1e0c5016a1437e1">ltd_idx</a>);
<a name="l02646"></a>02646 
<a name="l02647"></a>02647         rc = <a class="code" href="obd__class_8h.html#aa99c3f0fae692364c4f0ec74147043ec">md_unlink</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, op_data, request);
<a name="l02648"></a>02648         <span class="keywordflow">if</span> (rc != 0 &amp;&amp; rc != -EREMOTE &amp;&amp; rc != -ENOENT)
<a name="l02649"></a>02649                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02650"></a>02650 
<a name="l02651"></a>02651         <span class="comment">/* Try next stripe if it is needed. */</span>
<a name="l02652"></a>02652         <span class="keywordflow">if</span> (rc == -ENOENT &amp;&amp; lsm != NULL &amp;&amp; <a class="code" href="lmv__internal_8h.html#a9a4be4c974a1bc3d3173f0fe61243af9">lmv_need_try_all_stripes</a>(lsm)) {
<a name="l02653"></a>02653                 <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a> *oinfo;
<a name="l02654"></a>02654 
<a name="l02655"></a>02655                 stripe_index++;
<a name="l02656"></a>02656                 <span class="keywordflow">if</span> (stripe_index &gt;= lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>)
<a name="l02657"></a>02657                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02658"></a>02658 
<a name="l02659"></a>02659                 oinfo = &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[stripe_index];
<a name="l02660"></a>02660 
<a name="l02661"></a>02661                 op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a> = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l02662"></a>02662                 op_data-&gt;<a class="code" href="structmd__op__data.html#a4dd8c2bfe3a67c84e6c0dcfbaad50c56">op_mds</a> = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>;
<a name="l02663"></a>02663 
<a name="l02664"></a>02664                 <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(*request);
<a name="l02665"></a>02665                 *request = NULL;
<a name="l02666"></a>02666 
<a name="l02667"></a>02667                 <span class="keywordflow">goto</span> try_next_stripe;
<a name="l02668"></a>02668         }
<a name="l02669"></a>02669 
<a name="l02670"></a>02670         body = <a class="code" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer...">req_capsule_server_get</a>(&amp;(*request)-&gt;rq_pill, &amp;<a class="code" href="group__req__layout.html#ga1c9ae136d2e4b00329d63bcb718c9d93">RMF_MDT_BODY</a>);
<a name="l02671"></a>02671         <span class="keywordflow">if</span> (body == NULL)
<a name="l02672"></a>02672                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EPROTO);
<a name="l02673"></a>02673 
<a name="l02674"></a>02674         <span class="comment">/* Not cross-ref case, just get out of here. */</span>
<a name="l02675"></a>02675         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!(body-&gt;<a class="code" href="structmdt__body.html#a1b206c7182c4ded5e8b9fbb1e8670bb5">mbo_valid</a> &amp; <a class="code" href="group__lustreidl.html#ga9cad3716fc653975a6f2e1853515c49f">OBD_MD_MDS</a>)))
<a name="l02676"></a>02676                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02677"></a>02677 
<a name="l02678"></a>02678         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;%s: try unlink to another MDT for &quot;</span>DFID<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02679"></a>02679                exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;body-&gt;<a class="code" href="structmdt__body.html#af95f5f511b3aacf651ad7822ee8b324b">mbo_fid1</a>));
<a name="l02680"></a>02680 
<a name="l02681"></a>02681         <span class="comment">/* This is a remote object, try remote MDT, Note: it may</span>
<a name="l02682"></a>02682 <span class="comment">         * try more than 1 time here, Considering following case</span>
<a name="l02683"></a>02683 <span class="comment">         * /mnt/lustre is root on MDT0, remote1 is on MDT1</span>
<a name="l02684"></a>02684 <span class="comment">         * 1. Initially A does not know where remote1 is, it send</span>
<a name="l02685"></a>02685 <span class="comment">         *    unlink RPC to MDT0, MDT0 return -EREMOTE, it will</span>
<a name="l02686"></a>02686 <span class="comment">         *    resend unlink RPC to MDT1 (retry 1st time).</span>
<a name="l02687"></a>02687 <span class="comment">         *</span>
<a name="l02688"></a>02688 <span class="comment">         * 2. During the unlink RPC in flight,</span>
<a name="l02689"></a>02689 <span class="comment">         *    client B mv /mnt/lustre/remote1 /mnt/lustre/remote2</span>
<a name="l02690"></a>02690 <span class="comment">         *    and create new remote1, but on MDT0</span>
<a name="l02691"></a>02691 <span class="comment">         *</span>
<a name="l02692"></a>02692 <span class="comment">         * 3. MDT1 get unlink RPC(from A), then do remote lock on</span>
<a name="l02693"></a>02693 <span class="comment">         *    /mnt/lustre, then lookup get fid of remote1, and find</span>
<a name="l02694"></a>02694 <span class="comment">         *    it is remote dir again, and replay -EREMOTE again.</span>
<a name="l02695"></a>02695 <span class="comment">         *</span>
<a name="l02696"></a>02696 <span class="comment">         * 4. Then A will resend unlink RPC to MDT0. (retry 2nd times).</span>
<a name="l02697"></a>02697 <span class="comment">         *</span>
<a name="l02698"></a>02698 <span class="comment">         * In theory, it might try unlimited time here, but it should</span>
<a name="l02699"></a>02699 <span class="comment">         * be very rare case.  */</span>
<a name="l02700"></a>02700         op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a> = body-&gt;<a class="code" href="structmdt__body.html#af95f5f511b3aacf651ad7822ee8b324b">mbo_fid1</a>;
<a name="l02701"></a>02701         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(*request);
<a name="l02702"></a>02702         *request = NULL;
<a name="l02703"></a>02703 
<a name="l02704"></a>02704         <span class="keywordflow">goto</span> retry_unlink;
<a name="l02705"></a>02705 }
<a name="l02706"></a>02706 
<a name="l02707"></a><a class="code" href="lmv__obd_8c.html#adaf72ea703c580a88031d1ffc03adf36">02707</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#adaf72ea703c580a88031d1ffc03adf36">lmv_precleanup</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd)
<a name="l02708"></a>02708 {
<a name="l02709"></a>02709         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02710"></a>02710         <a class="code" href="group__fld.html#ga72fe7bcae3d9844c63639aab20cb8ecd">fld_client_proc_fini</a>(&amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>.<a class="code" href="structlmv__obd.html#a6a04fc1150ffd264c7540a08870eccc7">lmv_fld</a>);
<a name="l02711"></a>02711         <a class="code" href="lprocfs__status_8h.html#a15158cecf82a91ab6030698de9743884">lprocfs_obd_cleanup</a>(obd);
<a name="l02712"></a>02712         <a class="code" href="lprocfs__status_8h.html#aaf56c490bc014c4386e0ab30d944060d">lprocfs_free_md_stats</a>(obd);
<a name="l02713"></a>02713         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l02714"></a>02714 }
<a name="l02715"></a>02715 
<a name="l02732"></a><a class="code" href="lmv__obd_8c.html#a185b85db495af14c9c1ae17f84ba2afa">02732</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a185b85db495af14c9c1ae17f84ba2afa" title="Get by key a value associated with a LMV device.">lmv_get_info</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l02733"></a>02733                         __u32 keylen, <span class="keywordtype">void</span> *key, __u32 *vallen, <span class="keywordtype">void</span> *val)
<a name="l02734"></a>02734 {
<a name="l02735"></a>02735         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd;
<a name="l02736"></a>02736         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv;
<a name="l02737"></a>02737         <span class="keywordtype">int</span>                      rc = 0;
<a name="l02738"></a>02738         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02739"></a>02739 
<a name="l02740"></a>02740         obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l02741"></a>02741         <span class="keywordflow">if</span> (obd == NULL) {
<a name="l02742"></a>02742                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#ac7f58d3617434ae1289aa59f62299d7e">D_IOCTL</a>, <span class="stringliteral">&quot;Invalid client cookie &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#abd4b7b7675c19f574aa3c3cd3a7f770f">LPX64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02743"></a>02743                        exp-&gt;<a class="code" href="structobd__export.html#acf1dc5c8a8a7a1f6830bc680e5784a61" title="Export handle, it&amp;#39;s id is provided to client on connect Subsequent client RPCs...">exp_handle</a>.<a class="code" href="structportals__handle.html#a69a5ee95c5da23f07b14dc3fb6d1440c">h_cookie</a>);
<a name="l02744"></a>02744                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l02745"></a>02745         }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747         lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02748"></a>02748         <span class="keywordflow">if</span> (keylen &gt;= strlen(<span class="stringliteral">&quot;remote_flag&quot;</span>) &amp;&amp; !strcmp(key, <span class="stringliteral">&quot;remote_flag&quot;</span>)) {
<a name="l02749"></a>02749                 <span class="keywordtype">int</span> i;
<a name="l02750"></a>02750 
<a name="l02751"></a>02751                 rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02752"></a>02752                 <span class="keywordflow">if</span> (rc)
<a name="l02753"></a>02753                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02754"></a>02754 
<a name="l02755"></a>02755                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(*vallen == <span class="keyword">sizeof</span>(__u32));
<a name="l02756"></a>02756                 <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l02757"></a>02757                         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l02758"></a>02758                         <span class="comment">/*</span>
<a name="l02759"></a>02759 <span class="comment">                         * All tgts should be connected when this gets called.</span>
<a name="l02760"></a>02760 <span class="comment">                         */</span>
<a name="l02761"></a>02761                         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l02762"></a>02762                                 <span class="keywordflow">continue</span>;
<a name="l02763"></a>02763 
<a name="l02764"></a>02764                         <span class="keywordflow">if</span> (!<a class="code" href="obd__class_8h.html#aca78facc3ff7e9e1a70e49178fec07e1">obd_get_info</a>(env, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, keylen, key,
<a name="l02765"></a>02765                                           vallen, val))
<a name="l02766"></a>02766                                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l02767"></a>02767                 }
<a name="l02768"></a>02768                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l02769"></a>02769         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#a656f554b7418373682e616ae45bcb4c0">KEY_MAX_EASIZE</a>) ||
<a name="l02770"></a>02770                    <a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#a68b6fa1506279c89e3c3210b3a991b60">KEY_DEFAULT_EASIZE</a>) ||
<a name="l02771"></a>02771                    <a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#ac67bd5467d39906397c8a0979d638f18">KEY_CONN_DATA</a>)) {
<a name="l02772"></a>02772                 rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l02773"></a>02773                 <span class="keywordflow">if</span> (rc)
<a name="l02774"></a>02774                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02775"></a>02775 
<a name="l02776"></a>02776                 <span class="comment">/*</span>
<a name="l02777"></a>02777 <span class="comment">                 * Forwarding this request to first MDS, it should know LOV</span>
<a name="l02778"></a>02778 <span class="comment">                 * desc.</span>
<a name="l02779"></a>02779 <span class="comment">                 */</span>
<a name="l02780"></a>02780                 rc = <a class="code" href="obd__class_8h.html#aca78facc3ff7e9e1a70e49178fec07e1">obd_get_info</a>(env, lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, keylen, key,
<a name="l02781"></a>02781                                   vallen, val);
<a name="l02782"></a>02782                 <span class="keywordflow">if</span> (!rc &amp;&amp; <a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#ac67bd5467d39906397c8a0979d638f18">KEY_CONN_DATA</a>))
<a name="l02783"></a>02783                         exp-&gt;<a class="code" href="structobd__export.html#a8955ea706fda03cf621ac71fc84d4b2f" title="Compatibility flags for this export are embedded into exp_connect_data.">exp_connect_data</a> = *(<span class="keyword">struct </span><a class="code" href="structobd__connect__data.html">obd_connect_data</a> *)val;
<a name="l02784"></a>02784                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02785"></a>02785         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#a02b2d8e8eca344b7739f331f9c0a506a">KEY_TGT_COUNT</a>)) {
<a name="l02786"></a>02786                 *((<span class="keywordtype">int</span> *)val) = lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>;
<a name="l02787"></a>02787                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l02788"></a>02788         }
<a name="l02789"></a>02789 
<a name="l02790"></a>02790         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#ac7f58d3617434ae1289aa59f62299d7e">D_IOCTL</a>, <span class="stringliteral">&quot;Invalid key\n&quot;</span>);
<a name="l02791"></a>02791         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l02792"></a>02792 }
<a name="l02793"></a>02793 
<a name="l02810"></a><a class="code" href="lmv__obd_8c.html#a1b3bf908edcdf584cba9261f2050f3c8">02810</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a1b3bf908edcdf584cba9261f2050f3c8" title="Asynchronously set by key a value associated with a LMV device.">lmv_set_info_async</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l02811"></a>02811                         __u32 keylen, <span class="keywordtype">void</span> *key, __u32 vallen, <span class="keywordtype">void</span> *val,
<a name="l02812"></a>02812                         <span class="keyword">struct</span> <a class="code" href="structptlrpc__request__set.html" title="Definition of request set structure.">ptlrpc_request_set</a> *<span class="keyword">set</span>)
<a name="l02813"></a>02813 {
<a name="l02814"></a>02814         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = NULL;
<a name="l02815"></a>02815         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd;
<a name="l02816"></a>02816         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv;
<a name="l02817"></a>02817         <span class="keywordtype">int</span> rc = 0;
<a name="l02818"></a>02818         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02819"></a>02819 
<a name="l02820"></a>02820         obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l02821"></a>02821         <span class="keywordflow">if</span> (obd == NULL) {
<a name="l02822"></a>02822                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#ac7f58d3617434ae1289aa59f62299d7e">D_IOCTL</a>, <span class="stringliteral">&quot;Invalid client cookie &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#abd4b7b7675c19f574aa3c3cd3a7f770f">LPX64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02823"></a>02823                        exp-&gt;<a class="code" href="structobd__export.html#acf1dc5c8a8a7a1f6830bc680e5784a61" title="Export handle, it&amp;#39;s id is provided to client on connect Subsequent client RPCs...">exp_handle</a>.<a class="code" href="structportals__handle.html#a69a5ee95c5da23f07b14dc3fb6d1440c">h_cookie</a>);
<a name="l02824"></a>02824                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l02825"></a>02825         }
<a name="l02826"></a>02826         lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02827"></a>02827 
<a name="l02828"></a>02828         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#ab7be067a7111d863f47d612cc584a429">KEY_READ_ONLY</a>) || <a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#a7e9a308df26c65562bde72c9cb7b732f">KEY_FLUSH_CTX</a>) ||
<a name="l02829"></a>02829             <a class="code" href="obd__support_8h.html#a22568ba23d33a17578fa2468404a2c14">KEY_IS</a>(<a class="code" href="obd_8h.html#a68b6fa1506279c89e3c3210b3a991b60">KEY_DEFAULT_EASIZE</a>)) {
<a name="l02830"></a>02830                 <span class="keywordtype">int</span> i, err = 0;
<a name="l02831"></a>02831 
<a name="l02832"></a>02832                 <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l02833"></a>02833                         tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l02834"></a>02834 
<a name="l02835"></a>02835                         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l02836"></a>02836                                 <span class="keywordflow">continue</span>;
<a name="l02837"></a>02837 
<a name="l02838"></a>02838                         err = <a class="code" href="obd__class_8h.html#af82ae5d7bd392a892b6f372513e68516">obd_set_info_async</a>(env, tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>,
<a name="l02839"></a>02839                                                  keylen, key, vallen, val, <span class="keyword">set</span>);
<a name="l02840"></a>02840                         <span class="keywordflow">if</span> (err &amp;&amp; rc == 0)
<a name="l02841"></a>02841                                 rc = err;
<a name="l02842"></a>02842                 }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02845"></a>02845         }
<a name="l02846"></a>02846 
<a name="l02847"></a>02847         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l02848"></a>02848 }
<a name="l02849"></a>02849 
<a name="l02850"></a><a class="code" href="lmv__obd_8c.html#ad0722531e71fe7341af7b17354466cdf">02850</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad0722531e71fe7341af7b17354466cdf">lmv_unpack_md_v1</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> *lsm,
<a name="l02851"></a>02851                             <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmm1)
<a name="l02852"></a>02852 {
<a name="l02853"></a>02853         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>  *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02854"></a>02854         <span class="keywordtype">int</span>             stripe_count;
<a name="l02855"></a>02855         <span class="keywordtype">int</span>             cplen;
<a name="l02856"></a>02856         <span class="keywordtype">int</span>             i;
<a name="l02857"></a>02857         <span class="keywordtype">int</span>             rc = 0;
<a name="l02858"></a>02858         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02859"></a>02859 
<a name="l02860"></a>02860         lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a41e46cdbced69112e98e20866e5a0926">lsm_md_magic</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#ac2b14a45c4dd28ad5872864b645fe944">lmv_magic</a>);
<a name="l02861"></a>02861         lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#a3002cd6110eb9b23fc13986d18d60591">lmv_stripe_count</a>);
<a name="l02862"></a>02862         lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a0f40bcd5b25187c14ddbaeff9b39320e">lsm_md_master_mdt_index</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#a84b8f3843894cd656966dc846fa36763">lmv_master_mdt_index</a>);
<a name="l02863"></a>02863         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#a8bdad201e8238e12a6952d84fbcd8da7">OBD_FAIL_UNKNOWN_LMV_STRIPE</a>))
<a name="l02864"></a>02864                 lsm-&gt;<a class="code" href="structlmv__stripe__md.html#ad4e0acda2e6c2fe0c6e385df05f78d88">lsm_md_hash_type</a> = <a class="code" href="group__lustreuser.html#gga87892a6b8b26aa39362f401a2f430b6ea6a8d8924aee9296e316c99a77cf295b4">LMV_HASH_TYPE_UNKNOWN</a>;
<a name="l02865"></a>02865         <span class="keywordflow">else</span>
<a name="l02866"></a>02866                 lsm-&gt;<a class="code" href="structlmv__stripe__md.html#ad4e0acda2e6c2fe0c6e385df05f78d88">lsm_md_hash_type</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#a319805ff1f68b1bf3354d715fbfdf1d5">lmv_hash_type</a>);
<a name="l02867"></a>02867         lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a65808d83b45696282b224f3363cc2e2f">lsm_md_layout_version</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#ac03443e0880b55f3105b28d2bbd683c1">lmv_layout_version</a>);
<a name="l02868"></a>02868         cplen = <a class="code" href="string_8h.html#a5b488cc7021bbdd3ed565cb03b1ee6d2">strlcpy</a>(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#aba632d84db105b7d10bab4b54a0ecedd">lsm_md_pool_name</a>, lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#aff7eefa84d5f28635b4886dca8eca7a2">lmv_pool_name</a>,
<a name="l02869"></a>02869                         <span class="keyword">sizeof</span>(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#aba632d84db105b7d10bab4b54a0ecedd">lsm_md_pool_name</a>));
<a name="l02870"></a>02870 
<a name="l02871"></a>02871         <span class="keywordflow">if</span> (cplen &gt;= <span class="keyword">sizeof</span>(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#aba632d84db105b7d10bab4b54a0ecedd">lsm_md_pool_name</a>))
<a name="l02872"></a>02872                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-E2BIG);
<a name="l02873"></a>02873 
<a name="l02874"></a>02874         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;unpack lsm count %d, master %d hash_type %d&quot;</span>
<a name="l02875"></a>02875                <span class="stringliteral">&quot;layout_version %d\n&quot;</span>, lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>,
<a name="l02876"></a>02876                lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a0f40bcd5b25187c14ddbaeff9b39320e">lsm_md_master_mdt_index</a>, lsm-&gt;<a class="code" href="structlmv__stripe__md.html#ad4e0acda2e6c2fe0c6e385df05f78d88">lsm_md_hash_type</a>,
<a name="l02877"></a>02877                lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a65808d83b45696282b224f3363cc2e2f">lsm_md_layout_version</a>);
<a name="l02878"></a>02878 
<a name="l02879"></a>02879         stripe_count = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#a3002cd6110eb9b23fc13986d18d60591">lmv_stripe_count</a>);
<a name="l02880"></a>02880         <span class="keywordflow">for</span> (i = 0; i &lt; stripe_count; i++) {
<a name="l02881"></a>02881                 <a class="code" href="group__lu__fid.html#ga4ec200cce2c251b81f3c49154ab9198e">fid_le_to_cpu</a>(&amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>,
<a name="l02882"></a>02882                               &amp;lmm1-&gt;<a class="code" href="structlmv__mds__md__v1.html#a665969d5fd3737b04b8d5a6c0bf556b7">lmv_stripe_fids</a>[i]);
<a name="l02883"></a>02883                 rc = <a class="code" href="lmv__fld_8c.html#a0ccd70c3e89b531f7ca3d300501ff064">lmv_fld_lookup</a>(lmv, &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>,
<a name="l02884"></a>02884                                     &amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a80066ed26677412315804c67c539a17f">lmo_mds</a>);
<a name="l02885"></a>02885                 <span class="keywordflow">if</span> (rc != 0)
<a name="l02886"></a>02886                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02887"></a>02887                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;unpack fid #%d &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, i,
<a name="l02888"></a>02888                        <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>));
<a name="l02889"></a>02889         }
<a name="l02890"></a>02890 
<a name="l02891"></a>02891         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l02892"></a>02892 }
<a name="l02893"></a>02893 
<a name="l02894"></a><a class="code" href="lmv__obd_8c.html#a9841ccb2cbc456a8ce1f0339b2e48eba">02894</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a9841ccb2cbc456a8ce1f0339b2e48eba">lmv_unpackmd</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> **lsmp,
<a name="l02895"></a>02895                         <span class="keyword">const</span> <span class="keyword">union</span> <a class="code" href="unionlmv__mds__md.html">lmv_mds_md</a> *lmm, <span class="keywordtype">size_t</span> lmm_size)
<a name="l02896"></a>02896 {
<a name="l02897"></a>02897         <span class="keyword">struct </span><a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a>     *lsm;
<a name="l02898"></a>02898         <span class="keywordtype">int</span>                      lsm_size;
<a name="l02899"></a>02899         <span class="keywordtype">int</span>                      rc;
<a name="l02900"></a>02900         <span class="keywordtype">bool</span>                     allocated = <span class="keyword">false</span>;
<a name="l02901"></a>02901         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02902"></a>02902 
<a name="l02903"></a>02903         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(lsmp != NULL);
<a name="l02904"></a>02904 
<a name="l02905"></a>02905         lsm = *lsmp;
<a name="l02906"></a>02906         <span class="comment">/* Free memmd */</span>
<a name="l02907"></a>02907         <span class="keywordflow">if</span> (lsm != NULL &amp;&amp; lmm == NULL) {
<a name="l02908"></a>02908                 <span class="keywordtype">int</span> i;
<a name="l02909"></a>02909                 <span class="keywordflow">for</span> (i = 0; i &lt; lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>; i++) {
<a name="l02910"></a>02910                         <span class="comment">/* For migrating inode, the master stripe and master</span>
<a name="l02911"></a>02911 <span class="comment">                         * object will be the same, so do not need iput, see</span>
<a name="l02912"></a>02912 <span class="comment">                         * ll_update_lsm_md */</span>
<a name="l02913"></a>02913                         <span class="keywordflow">if</span> (!(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#ad4e0acda2e6c2fe0c6e385df05f78d88">lsm_md_hash_type</a> &amp; <a class="code" href="group__lustreidl.html#gabb7a9c882172b0f9b0626528186b2162">LMV_HASH_FLAG_MIGRATION</a> &amp;&amp;
<a name="l02914"></a>02914                               i == 0) &amp;&amp; lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a01c7eddb3fd23a901cc12462adfb07d5">lmo_root</a> != NULL)
<a name="l02915"></a>02915                                 iput(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a01c7eddb3fd23a901cc12462adfb07d5">lmo_root</a>);
<a name="l02916"></a>02916                 }
<a name="l02917"></a>02917                 lsm_size = <a class="code" href="lmv__internal_8h.html#a3f57f90e28ad49923ee90a90c190b743">lmv_stripe_md_size</a>(lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>);
<a name="l02918"></a>02918                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(lsm, lsm_size);
<a name="l02919"></a>02919                 *lsmp = NULL;
<a name="l02920"></a>02920                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l02921"></a>02921         }
<a name="l02922"></a>02922 
<a name="l02923"></a>02923         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>) == <a class="code" href="group__lustreidl.html#ga09d0f6853dd711c331db80fb89fcd195">LMV_MAGIC_STRIPE</a>)
<a name="l02924"></a>02924                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EPERM);
<a name="l02925"></a>02925 
<a name="l02926"></a>02926         <span class="comment">/* Unpack memmd */</span>
<a name="l02927"></a>02927         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>) != <a class="code" href="group__lustreidl.html#gab6a609ad077d7b362a74873489238c89">LMV_MAGIC_V1</a> &amp;&amp;
<a name="l02928"></a>02928             <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>) != <a class="code" href="group__lustreuser.html#gabdf9dc5944d2440f0739a0d6c02e02e6">LMV_USER_MAGIC</a>) {
<a name="l02929"></a>02929                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: invalid lmv magic %x: rc = %d\n&quot;</span>,
<a name="l02930"></a>02930                        exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>),
<a name="l02931"></a>02931                        -EIO);
<a name="l02932"></a>02932                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EIO);
<a name="l02933"></a>02933         }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>) == <a class="code" href="group__lustreidl.html#gab6a609ad077d7b362a74873489238c89">LMV_MAGIC_V1</a>)
<a name="l02936"></a>02936                 lsm_size = <a class="code" href="lmv__internal_8h.html#a3f57f90e28ad49923ee90a90c190b743">lmv_stripe_md_size</a>(<a class="code" href="group__lustreidl.html#ga807d6c581494603dff0c259f4efc1be5">lmv_mds_md_stripe_count_get</a>(lmm));
<a name="l02937"></a>02937         <span class="keywordflow">else</span>
<a name="l02942"></a>02942                 lsm_size = <a class="code" href="lmv__internal_8h.html#a3f57f90e28ad49923ee90a90c190b743">lmv_stripe_md_size</a>(0);
<a name="l02943"></a>02943 
<a name="l02944"></a>02944         lsm_size = <a class="code" href="lmv__internal_8h.html#a3f57f90e28ad49923ee90a90c190b743">lmv_stripe_md_size</a>(<a class="code" href="group__lustreidl.html#ga807d6c581494603dff0c259f4efc1be5">lmv_mds_md_stripe_count_get</a>(lmm));
<a name="l02945"></a>02945         <span class="keywordflow">if</span> (lsm == NULL) {
<a name="l02946"></a>02946                 <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(lsm, lsm_size);
<a name="l02947"></a>02947                 <span class="keywordflow">if</span> (lsm == NULL)
<a name="l02948"></a>02948                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l02949"></a>02949                 allocated = <span class="keyword">true</span>;
<a name="l02950"></a>02950                 *lsmp = lsm;
<a name="l02951"></a>02951         }
<a name="l02952"></a>02952 
<a name="l02953"></a>02953         <span class="keywordflow">switch</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>)) {
<a name="l02954"></a>02954         <span class="keywordflow">case</span> <a class="code" href="group__lustreidl.html#gab6a609ad077d7b362a74873489238c89">LMV_MAGIC_V1</a>:
<a name="l02955"></a>02955                 rc = <a class="code" href="lmv__obd_8c.html#ad0722531e71fe7341af7b17354466cdf">lmv_unpack_md_v1</a>(exp, lsm, &amp;lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a4e9f4a4a56fa910ec829ec890a713130">lmv_md_v1</a>);
<a name="l02956"></a>02956                 <span class="keywordflow">break</span>;
<a name="l02957"></a>02957         <span class="keywordflow">default</span>:
<a name="l02958"></a>02958                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: unrecognized magic %x\n&quot;</span>, exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l02959"></a>02959                        <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(lmm-&gt;<a class="code" href="unionlmv__mds__md.html#a76a8b364103705d95533fd915cbfff17">lmv_magic</a>));
<a name="l02960"></a>02960                 rc = -EINVAL;
<a name="l02961"></a>02961                 <span class="keywordflow">break</span>;
<a name="l02962"></a>02962         }
<a name="l02963"></a>02963 
<a name="l02964"></a>02964         <span class="keywordflow">if</span> (rc != 0 &amp;&amp; allocated) {
<a name="l02965"></a>02965                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(lsm, lsm_size);
<a name="l02966"></a>02966                 *lsmp = NULL;
<a name="l02967"></a>02967                 lsm_size = rc;
<a name="l02968"></a>02968         }
<a name="l02969"></a>02969         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(lsm_size);
<a name="l02970"></a>02970 }
<a name="l02971"></a>02971 
<a name="l02972"></a><a class="code" href="lmv__obd_8c.html#a64b60257e23d09634ef0f4b5d9a84a13">02972</a> <span class="keywordtype">void</span> <a class="code" href="lustre__lmv_8h.html#a64b60257e23d09634ef0f4b5d9a84a13">lmv_free_memmd</a>(<span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> *lsm)
<a name="l02973"></a>02973 {
<a name="l02974"></a>02974         <a class="code" href="lmv__obd_8c.html#a9841ccb2cbc456a8ce1f0339b2e48eba">lmv_unpackmd</a>(NULL, &amp;lsm, NULL, 0);
<a name="l02975"></a>02975 }
<a name="l02976"></a>02976 EXPORT_SYMBOL(<a class="code" href="lustre__lmv_8h.html#a64b60257e23d09634ef0f4b5d9a84a13">lmv_free_memmd</a>);
<a name="l02977"></a>02977 
<a name="l02978"></a><a class="code" href="lmv__obd_8c.html#ad7e5a72922ae183585448166d397eff9">02978</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#ad7e5a72922ae183585448166d397eff9">lmv_cancel_unused</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l02979"></a>02979                              <span class="keyword">union</span> <a class="code" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy,
<a name="l02980"></a>02980                              <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="code" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>, <span class="keyword">enum</span> <a class="code" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9" title="Cancel flags.">ldlm_cancel_flags</a> flags,
<a name="l02981"></a>02981                              <span class="keywordtype">void</span> *opaque)
<a name="l02982"></a>02982 {
<a name="l02983"></a>02983         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a> *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l02984"></a>02984         <span class="keywordtype">int</span> rc = 0;
<a name="l02985"></a>02985         __u32 i;
<a name="l02986"></a>02986         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l02987"></a>02987 
<a name="l02988"></a>02988         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(fid != NULL);
<a name="l02989"></a>02989 
<a name="l02990"></a>02990         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l02991"></a>02991                 <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l02992"></a>02992                 <span class="keywordtype">int</span> err;
<a name="l02993"></a>02993 
<a name="l02994"></a>02994                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL || !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>)
<a name="l02995"></a>02995                         <span class="keywordflow">continue</span>;
<a name="l02996"></a>02996 
<a name="l02997"></a>02997                 err = <a class="code" href="obd__class_8h.html#a4b8047517ca7b6d1f42e6f596d5eed92">md_cancel_unused</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, policy, mode, flags,
<a name="l02998"></a>02998                                        opaque);
<a name="l02999"></a>02999                 <span class="keywordflow">if</span> (!rc)
<a name="l03000"></a>03000                         rc = err;
<a name="l03001"></a>03001         }
<a name="l03002"></a>03002         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03003"></a>03003 }
<a name="l03004"></a>03004 
<a name="l03005"></a><a class="code" href="lmv__obd_8c.html#aa41138bbba5fea3e7e2e6e7db587ab45">03005</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#aa41138bbba5fea3e7e2e6e7db587ab45">lmv_set_lock_data</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *lockh, <span class="keywordtype">void</span> *data,
<a name="l03006"></a>03006                       <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *bits)
<a name="l03007"></a>03007 {
<a name="l03008"></a>03008         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03009"></a>03009         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l03010"></a>03010         <span class="keywordtype">int</span>                      rc;
<a name="l03011"></a>03011         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l03014"></a>03014                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l03015"></a>03015         rc =  <a class="code" href="obd__class_8h.html#afef00b54bc35de2519563cfcc8b166c1">md_set_lock_data</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, lockh, data, bits);
<a name="l03016"></a>03016         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03017"></a>03017 }
<a name="l03018"></a>03018 
<a name="l03019"></a><a class="code" href="lmv__obd_8c.html#a2ebc911562ec532addf480e9d4cfa519">03019</a> <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="code" href="lmv__obd_8c.html#a2ebc911562ec532addf480e9d4cfa519">lmv_lock_match</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> flags,
<a name="l03020"></a>03020                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid, <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga5ced9a6707006817f5e2409b368f36b5">ldlm_type</a> type,
<a name="l03021"></a>03021                               <span class="keyword">union</span> <a class="code" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy,
<a name="l03022"></a>03022                               <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="code" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>, <span class="keyword">struct</span> <a class="code" href="structlustre__handle.html">lustre_handle</a> *lockh)
<a name="l03023"></a>03023 {
<a name="l03024"></a>03024         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03025"></a>03025         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03026"></a>03026         <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a>          rc;
<a name="l03027"></a>03027         <span class="keywordtype">int</span>                     tgt;
<a name="l03028"></a>03028         <span class="keywordtype">int</span>                     i;
<a name="l03029"></a>03029         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03030"></a>03030 
<a name="l03031"></a>03031         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;Lock match for &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid));
<a name="l03032"></a>03032 
<a name="l03033"></a>03033         <span class="comment">/*</span>
<a name="l03034"></a>03034 <span class="comment">         * With DNE every object can have two locks in different namespaces:</span>
<a name="l03035"></a>03035 <span class="comment">         * lookup lock in space of MDT storing direntry and update/open lock in</span>
<a name="l03036"></a>03036 <span class="comment">         * space of MDT storing inode.  Try the MDT that the FID maps to first,</span>
<a name="l03037"></a>03037 <span class="comment">         * since this can be easily found, and only try others if that fails.</span>
<a name="l03038"></a>03038 <span class="comment">         */</span>
<a name="l03039"></a>03039         <span class="keywordflow">for</span> (i = 0, tgt = <a class="code" href="lmv__internal_8h.html#a072e2d2eccdde38ed4a0006b0a66c92d">lmv_find_target_index</a>(lmv, fid);
<a name="l03040"></a>03040              i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>;
<a name="l03041"></a>03041              i++, tgt = (tgt + 1) % lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>) {
<a name="l03042"></a>03042                 <span class="keywordflow">if</span> (tgt &lt; 0) {
<a name="l03043"></a>03043                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;%s: &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; is inaccessible: rc = %d\n&quot;</span>,
<a name="l03044"></a>03044                                obd-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid), tgt);
<a name="l03045"></a>03045                         tgt = 0;
<a name="l03046"></a>03046                 }
<a name="l03047"></a>03047 
<a name="l03048"></a>03048                 <span class="keywordflow">if</span> (lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[tgt] == NULL ||
<a name="l03049"></a>03049                     lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[tgt]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL ||
<a name="l03050"></a>03050                     lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[tgt]-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> == 0)
<a name="l03051"></a>03051                         <span class="keywordflow">continue</span>;
<a name="l03052"></a>03052 
<a name="l03053"></a>03053                 rc = <a class="code" href="obd__class_8h.html#a900dfb4cbefa84ac9b1f03cedc5a255f">md_lock_match</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[tgt]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, flags, fid,
<a name="l03054"></a>03054                                    type, policy, mode, lockh);
<a name="l03055"></a>03055                 <span class="keywordflow">if</span> (rc)
<a name="l03056"></a>03056                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03057"></a>03057         }
<a name="l03058"></a>03058 
<a name="l03059"></a>03059         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l03060"></a>03060 }
<a name="l03061"></a>03061 
<a name="l03062"></a><a class="code" href="lmv__obd_8c.html#a8546b65d07e6108f640182b4d8abb4df">03062</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a8546b65d07e6108f640182b4d8abb4df">lmv_get_lustre_md</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *<a class="code" href="structlmv__obd.html#a4b7eefd1b2621c3a82312cef604ecef2">exp</a>, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req,
<a name="l03063"></a>03063                       <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *dt_exp, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *md_exp,
<a name="l03064"></a>03064                       <span class="keyword">struct</span> <a class="code" href="structlustre__md.html">lustre_md</a> *md)
<a name="l03065"></a>03065 {
<a name="l03066"></a>03066         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03067"></a>03067         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l03068"></a>03068 
<a name="l03069"></a>03069         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l03070"></a>03070                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l03071"></a>03071 
<a name="l03072"></a>03072         <span class="keywordflow">return</span> <a class="code" href="obd__class_8h.html#a8337b76a4926fdf6e5c0d237d81fa838">md_get_lustre_md</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, req, dt_exp, md_exp, md);
<a name="l03073"></a>03073 }
<a name="l03074"></a>03074 
<a name="l03075"></a><a class="code" href="lmv__obd_8c.html#a2cfaa349554a8fbaff692c14a174d4ba">03075</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a2cfaa349554a8fbaff692c14a174d4ba">lmv_free_lustre_md</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structlustre__md.html">lustre_md</a> *md)
<a name="l03076"></a>03076 {
<a name="l03077"></a>03077         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03078"></a>03078         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03079"></a>03079         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l03080"></a>03080         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03081"></a>03081 
<a name="l03082"></a>03082         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="structlustre__md.html#a5b1fa0c991a00f2e9827eba3d609908f">lmv</a> != NULL) {
<a name="l03083"></a>03083                 <a class="code" href="lustre__lmv_8h.html#a64b60257e23d09634ef0f4b5d9a84a13">lmv_free_memmd</a>(md-&gt;<a class="code" href="structlustre__md.html#a5b1fa0c991a00f2e9827eba3d609908f">lmv</a>);
<a name="l03084"></a>03084                 md-&gt;<a class="code" href="structlustre__md.html#a5b1fa0c991a00f2e9827eba3d609908f">lmv</a> = NULL;
<a name="l03085"></a>03085         }
<a name="l03086"></a>03086         <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL)
<a name="l03087"></a>03087                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l03088"></a>03088         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(<a class="code" href="obd__class_8h.html#aeef10c6aa2269e6a5b57c6b45c40d355">md_free_lustre_md</a>(lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0]-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, md));
<a name="l03089"></a>03089 }
<a name="l03090"></a>03090 
<a name="l03091"></a><a class="code" href="lmv__obd_8c.html#af57f91ac7d21cf3527c1b9eb97d2defe">03091</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#af57f91ac7d21cf3527c1b9eb97d2defe">lmv_set_open_replay_data</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03092"></a>03092                              <span class="keyword">struct</span> <a class="code" href="structobd__client__handle.html">obd_client_handle</a> *och,
<a name="l03093"></a>03093                              <span class="keyword">struct</span> <a class="code" href="structlookup__intent.html">lookup_intent</a> *it)
<a name="l03094"></a>03094 {
<a name="l03095"></a>03095         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03096"></a>03096         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03097"></a>03097         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l03098"></a>03098         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03099"></a>03099 
<a name="l03100"></a>03100         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;och-&gt;<a class="code" href="structobd__client__handle.html#aca2fbbd477d0174513f907f1c1f3d623">och_fid</a>);
<a name="l03101"></a>03101         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l03102"></a>03102                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l03103"></a>03103 
<a name="l03104"></a>03104         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(<a class="code" href="obd__class_8h.html#aa0137ba2e2255175e51e6f438003bb05">md_set_open_replay_data</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, och, it));
<a name="l03105"></a>03105 }
<a name="l03106"></a>03106 
<a name="l03107"></a><a class="code" href="lmv__obd_8c.html#a65eafe0ff27a1345e90853adb64b2829">03107</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a65eafe0ff27a1345e90853adb64b2829">lmv_clear_open_replay_data</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03108"></a>03108                                <span class="keyword">struct</span> <a class="code" href="structobd__client__handle.html">obd_client_handle</a> *och)
<a name="l03109"></a>03109 {
<a name="l03110"></a>03110         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03111"></a>03111         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03112"></a>03112         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l03113"></a>03113         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03114"></a>03114 
<a name="l03115"></a>03115         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, &amp;och-&gt;<a class="code" href="structobd__client__handle.html#aca2fbbd477d0174513f907f1c1f3d623">och_fid</a>);
<a name="l03116"></a>03116         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l03117"></a>03117                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l03118"></a>03118 
<a name="l03119"></a>03119         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(<a class="code" href="obd__class_8h.html#a03887eff183f596773ee6f43fdbc1f45">md_clear_open_replay_data</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, och));
<a name="l03120"></a>03120 }
<a name="l03121"></a>03121 
<a name="l03122"></a><a class="code" href="lmv__obd_8c.html#aa2bbb22e7c5a64e0bd3faad35d85fa7a">03122</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#aa2bbb22e7c5a64e0bd3faad35d85fa7a">lmv_get_remote_perm</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l03123"></a>03123                                u32 suppgid, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> **request)
<a name="l03124"></a>03124 {
<a name="l03125"></a>03125         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03126"></a>03126         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03127"></a>03127         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l03128"></a>03128         <span class="keywordtype">int</span>                      rc;
<a name="l03129"></a>03129         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03130"></a>03130 
<a name="l03131"></a>03131         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l03132"></a>03132         <span class="keywordflow">if</span> (rc)
<a name="l03133"></a>03133                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03134"></a>03134 
<a name="l03135"></a>03135         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l03136"></a>03136         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l03137"></a>03137                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l03138"></a>03138 
<a name="l03139"></a>03139         rc = <a class="code" href="obd__class_8h.html#a2bae589717c2ff7fba95f64975a704f2">md_get_remote_perm</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, fid, suppgid, request);
<a name="l03140"></a>03140         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03141"></a>03141 }
<a name="l03142"></a>03142 
<a name="l03143"></a><a class="code" href="lmv__obd_8c.html#aae835c2a7bd7abd5f52f7fc2930925e9">03143</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#aae835c2a7bd7abd5f52f7fc2930925e9">lmv_intent_getattr_async</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03144"></a>03144                              <span class="keyword">struct</span> <a class="code" href="structmd__enqueue__info.html">md_enqueue_info</a> *minfo)
<a name="l03145"></a>03145 {
<a name="l03146"></a>03146         <span class="keyword">struct </span><a class="code" href="structmd__op__data.html">md_op_data</a>       *op_data = &amp;minfo-&gt;<a class="code" href="structmd__enqueue__info.html#add1c048a91d08c6daedc8a1ca0bee905">mi_data</a>;
<a name="l03147"></a>03147         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03148"></a>03148         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03149"></a>03149         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *ptgt = NULL;
<a name="l03150"></a>03150         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *ctgt = NULL;
<a name="l03151"></a>03151         <span class="keywordtype">int</span>                      rc;
<a name="l03152"></a>03152         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03153"></a>03153 
<a name="l03154"></a>03154         <span class="keywordflow">if</span> (!<a class="code" href="group__lu__fid.html#ga4e4ae31eef33a87852483e02806e914a">fid_is_sane</a>(&amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>))
<a name="l03155"></a>03155                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l03156"></a>03156 
<a name="l03157"></a>03157         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l03158"></a>03158         <span class="keywordflow">if</span> (rc)
<a name="l03159"></a>03159                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03160"></a>03160 
<a name="l03161"></a>03161         ptgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#ad2ae696058372a6168d03e7d1ef38c03">op_fid1</a>);
<a name="l03162"></a>03162         <span class="keywordflow">if</span> (IS_ERR(ptgt))
<a name="l03163"></a>03163                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(ptgt));
<a name="l03164"></a>03164 
<a name="l03165"></a>03165         ctgt = <a class="code" href="lmv__internal_8h.html#a6cbec485d68de683ee9aa59560c1b9b4" title="Locate mds by fid or name.">lmv_locate_mds</a>(lmv, op_data, &amp;op_data-&gt;<a class="code" href="structmd__op__data.html#a8ba5fc2168b1ec3807d95cec8e2a32ce">op_fid2</a>);
<a name="l03166"></a>03166         <span class="keywordflow">if</span> (IS_ERR(ctgt))
<a name="l03167"></a>03167                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(ctgt));
<a name="l03168"></a>03168 
<a name="l03169"></a>03169         <span class="comment">/*</span>
<a name="l03170"></a>03170 <span class="comment">         * if child is on remote MDT, we need 2 async RPCs to fetch both LOOKUP</span>
<a name="l03171"></a>03171 <span class="comment">         * lock on parent, and UPDATE lock on child MDT, which makes all</span>
<a name="l03172"></a>03172 <span class="comment">         * complicated. Considering remote dir is rare case, and not supporting</span>
<a name="l03173"></a>03173 <span class="comment">         * it in statahead won&apos;t cause any issue, drop its support for now.</span>
<a name="l03174"></a>03174 <span class="comment">         */</span>
<a name="l03175"></a>03175         <span class="keywordflow">if</span> (ptgt != ctgt)
<a name="l03176"></a>03176                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOTSUPP);
<a name="l03177"></a>03177 
<a name="l03178"></a>03178         rc = <a class="code" href="obd__class_8h.html#ad38a09e19fa26c739c5923e987659597">md_intent_getattr_async</a>(ptgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, minfo);
<a name="l03179"></a>03179         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03180"></a>03180 }
<a name="l03181"></a>03181 
<a name="l03182"></a><a class="code" href="lmv__obd_8c.html#a5f0eedaeac41ef96418edde28accae10">03182</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a5f0eedaeac41ef96418edde28accae10">lmv_revalidate_lock</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp, <span class="keyword">struct</span> <a class="code" href="structlookup__intent.html">lookup_intent</a> *it,
<a name="l03183"></a>03183                         <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *bits)
<a name="l03184"></a>03184 {
<a name="l03185"></a>03185         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *obd = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>;
<a name="l03186"></a>03186         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>          *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03187"></a>03187         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a>     *tgt;
<a name="l03188"></a>03188         <span class="keywordtype">int</span>                      rc;
<a name="l03189"></a>03189         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03190"></a>03190 
<a name="l03191"></a>03191         rc = <a class="code" href="lmv__internal_8h.html#a09085a484116271aa4133de80a41928c">lmv_check_connect</a>(obd);
<a name="l03192"></a>03192         <span class="keywordflow">if</span> (rc)
<a name="l03193"></a>03193                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03194"></a>03194 
<a name="l03195"></a>03195         tgt = <a class="code" href="lmv__internal_8h.html#a136efad105412cd25591e27d97fa7c5f">lmv_find_target</a>(lmv, fid);
<a name="l03196"></a>03196         <span class="keywordflow">if</span> (IS_ERR(tgt))
<a name="l03197"></a>03197                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(tgt));
<a name="l03198"></a>03198 
<a name="l03199"></a>03199         rc = <a class="code" href="obd__class_8h.html#ab1253e47733d026d63e1fd5b5ad34f58">md_revalidate_lock</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, it, fid, bits);
<a name="l03200"></a>03200         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03201"></a>03201 }
<a name="l03202"></a>03202 
<a name="l03203"></a><a class="code" href="lmv__obd_8c.html#a1e320cfb95fa8eaf45092695276c1b16">03203</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a1e320cfb95fa8eaf45092695276c1b16">lmv_get_fid_from_lsm</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03204"></a>03204                          <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> *lsm,
<a name="l03205"></a>03205                          <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> namelen, <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l03206"></a>03206 {
<a name="l03207"></a>03207         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structlmv__oinfo.html">lmv_oinfo</a> *oinfo;
<a name="l03208"></a>03208 
<a name="l03209"></a>03209         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(lsm != NULL);
<a name="l03210"></a>03210         oinfo = <a class="code" href="lmv__internal_8h.html#a8314a1634e7809a525c9b510c62f6f54">lsm_name_to_stripe_info</a>(lsm, name, namelen);
<a name="l03211"></a>03211         <span class="keywordflow">if</span> (IS_ERR(oinfo))
<a name="l03212"></a>03212                 <span class="keywordflow">return</span> PTR_ERR(oinfo);
<a name="l03213"></a>03213 
<a name="l03214"></a>03214         *fid = oinfo-&gt;<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>;
<a name="l03215"></a>03215 
<a name="l03216"></a>03216         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l03217"></a>03217 }
<a name="l03218"></a>03218 
<a name="l03224"></a><a class="code" href="lmv__obd_8c.html#a93a6be8a582b30476451a0cfee6dd136">03224</a> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a93a6be8a582b30476451a0cfee6dd136" title="For lmv, only need to send request to master MDT, and the master MDT will process...">lmv_quotactl</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *unused, <span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03225"></a>03225                  <span class="keyword">struct</span> <a class="code" href="structobd__quotactl.html">obd_quotactl</a> *oqctl)
<a name="l03226"></a>03226 {
<a name="l03227"></a>03227         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>   *obd = <a class="code" href="obd__class_8h.html#a41be64d7aa3b470db49e45fdf90298b3">class_exp2obd</a>(exp);
<a name="l03228"></a>03228         <span class="keyword">struct </span><a class="code" href="structlmv__obd.html">lmv_obd</a>      *lmv = &amp;obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#adb39c29ebda1560c507c5f79e26f73a4">lmv</a>;
<a name="l03229"></a>03229         <span class="keyword">struct </span><a class="code" href="structlmv__tgt__desc.html">lmv_tgt_desc</a> *tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[0];
<a name="l03230"></a>03230         <span class="keywordtype">int</span>                  rc = 0;
<a name="l03231"></a>03231         __u32                i;
<a name="l03232"></a>03232         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                curspace, curinodes;
<a name="l03233"></a>03233         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l03234"></a>03234 
<a name="l03235"></a>03235         <span class="keywordflow">if</span> (tgt == NULL ||
<a name="l03236"></a>03236             tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL ||
<a name="l03237"></a>03237             !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a> ||
<a name="l03238"></a>03238             lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a> == 0) {
<a name="l03239"></a>03239                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;master lmv inactive\n&quot;</span>);
<a name="l03240"></a>03240                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EIO);
<a name="l03241"></a>03241         }
<a name="l03242"></a>03242 
<a name="l03243"></a>03243         <span class="keywordflow">if</span> (oqctl-&gt;<a class="code" href="structobd__quotactl.html#aea26e1f46a26a3ff0f7e9d388797cd6e">qc_cmd</a> != <a class="code" href="group__lustreuser.html#ga8ed3793a998f2fedb262536f2b256554">Q_GETOQUOTA</a>) {
<a name="l03244"></a>03244                 rc = <a class="code" href="obd__class_8h.html#a0c83ffae83466db4a350e58e4c4f728a">obd_quotactl</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, oqctl);
<a name="l03245"></a>03245                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03246"></a>03246         }
<a name="l03247"></a>03247 
<a name="l03248"></a>03248         curspace = curinodes = 0;
<a name="l03249"></a>03249         <span class="keywordflow">for</span> (i = 0; i &lt; lmv-&gt;<a class="code" href="structlmv__obd.html#a70e4937b8632fd4d89f7574ce5d7d6df">desc</a>.<a class="code" href="structlmv__desc.html#a4d4d4efe2de62e2d54e49dde2c2e2854">ld_tgt_count</a>; i++) {
<a name="l03250"></a>03250                 <span class="keywordtype">int</span> err;
<a name="l03251"></a>03251                 tgt = lmv-&gt;<a class="code" href="structlmv__obd.html#ab4ee833b277c597ce80c6c3cd8cd801d">tgts</a>[i];
<a name="l03252"></a>03252 
<a name="l03253"></a>03253                 <span class="keywordflow">if</span> (tgt == NULL || tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a> == NULL || !tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#a87a0e31c6c107af9350f0954407e76fa">ltd_active</a>)
<a name="l03254"></a>03254                         <span class="keywordflow">continue</span>;
<a name="l03255"></a>03255 
<a name="l03256"></a>03256                 err = <a class="code" href="obd__class_8h.html#a0c83ffae83466db4a350e58e4c4f728a">obd_quotactl</a>(tgt-&gt;<a class="code" href="structlmv__tgt__desc.html#aaf1c4bb06a44439c873e00ba4eab0edc">ltd_exp</a>, oqctl);
<a name="l03257"></a>03257                 <span class="keywordflow">if</span> (err) {
<a name="l03258"></a>03258                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;getquota on mdt %d failed. %d\n&quot;</span>, i, err);
<a name="l03259"></a>03259                         <span class="keywordflow">if</span> (!rc)
<a name="l03260"></a>03260                                 rc = err;
<a name="l03261"></a>03261                 } <span class="keywordflow">else</span> {
<a name="l03262"></a>03262                         curspace += oqctl-&gt;<a class="code" href="structobd__quotactl.html#afc30dadc5b3bbfab38692a28bf4b4d0d">qc_dqblk</a>.<a class="code" href="structobd__dqblk.html#a5aa03e351791e9cf09a12f32789f2040">dqb_curspace</a>;
<a name="l03263"></a>03263                         curinodes += oqctl-&gt;<a class="code" href="structobd__quotactl.html#afc30dadc5b3bbfab38692a28bf4b4d0d">qc_dqblk</a>.<a class="code" href="structobd__dqblk.html#a8ba495c46c1830b5cae65eab46464345">dqb_curinodes</a>;
<a name="l03264"></a>03264                 }
<a name="l03265"></a>03265         }
<a name="l03266"></a>03266         oqctl-&gt;<a class="code" href="structobd__quotactl.html#afc30dadc5b3bbfab38692a28bf4b4d0d">qc_dqblk</a>.<a class="code" href="structobd__dqblk.html#a5aa03e351791e9cf09a12f32789f2040">dqb_curspace</a> = curspace;
<a name="l03267"></a>03267         oqctl-&gt;<a class="code" href="structobd__quotactl.html#afc30dadc5b3bbfab38692a28bf4b4d0d">qc_dqblk</a>.<a class="code" href="structobd__dqblk.html#a8ba495c46c1830b5cae65eab46464345">dqb_curinodes</a> = curinodes;
<a name="l03268"></a>03268 
<a name="l03269"></a>03269         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l03270"></a>03270 }
<a name="l03271"></a>03271 
<a name="l03272"></a><a class="code" href="lmv__obd_8c.html#a3190d6d24fe70f402b9f47672045f0d8">03272</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lmv__obd_8c.html#a3190d6d24fe70f402b9f47672045f0d8">lmv_merge_attr</a>(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp,
<a name="l03273"></a>03273                           <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlmv__stripe__md.html">lmv_stripe_md</a> *lsm,
<a name="l03274"></a>03274                           <span class="keyword">struct</span> <a class="code" href="structcl__attr.html" title="&amp;quot;Data attributes&amp;quot; of cl_object.">cl_attr</a> *attr,
<a name="l03275"></a>03275                           <a class="code" href="group__LDLM.html#gac111233b56bdf7a4767dcd7a2f15b378" title="Type for blocking callback function of a lock.">ldlm_blocking_callback</a> cb_blocking)
<a name="l03276"></a>03276 {
<a name="l03277"></a>03277         <span class="keywordtype">int</span> rc;
<a name="l03278"></a>03278         <span class="keywordtype">int</span> i;
<a name="l03279"></a>03279 
<a name="l03280"></a>03280         rc = <a class="code" href="lmv__intent_8c.html#a3ff8414d51b08994bb17879b951542dd">lmv_revalidate_slaves</a>(exp, lsm, cb_blocking, 0);
<a name="l03281"></a>03281         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l03282"></a>03282                 <span class="keywordflow">return</span> rc;
<a name="l03283"></a>03283 
<a name="l03284"></a>03284         <span class="keywordflow">for</span> (i = 0; i &lt; lsm-&gt;<a class="code" href="structlmv__stripe__md.html#a8c725138b1f5dd6f2356f6d2eafc701c">lsm_md_stripe_count</a>; i++) {
<a name="l03285"></a>03285                 <span class="keyword">struct </span>inode *inode = lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#a01c7eddb3fd23a901cc12462adfb07d5">lmo_root</a>;
<a name="l03286"></a>03286 
<a name="l03287"></a>03287                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;&quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; size %llu, blocks %llu nlink %u,&quot;</span>
<a name="l03288"></a>03288                        <span class="stringliteral">&quot; atime %lu ctime %lu, mtime %lu.\n&quot;</span>,
<a name="l03289"></a>03289                        <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;lsm-&gt;<a class="code" href="structlmv__stripe__md.html#acd18f3e13b831dbe2cccba82cae40976">lsm_md_oinfo</a>[i].<a class="code" href="structlmv__oinfo.html#ab690fcced3fcfbad4e41b95fa7c3167a">lmo_fid</a>),
<a name="l03290"></a>03290                        i_size_read(inode), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)inode-&gt;i_blocks,
<a name="l03291"></a>03291                        inode-&gt;i_nlink, <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_atime),
<a name="l03292"></a>03292                        <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_ctime), <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_mtime));
<a name="l03293"></a>03293 
<a name="l03294"></a>03294                 <span class="comment">/* for slave stripe, it needs to subtract nlink for . and .. */</span>
<a name="l03295"></a>03295                 <span class="keywordflow">if</span> (i != 0)
<a name="l03296"></a>03296                         attr-&gt;<a class="code" href="structcl__attr.html#adb5d5843446f6e22035a41252821b558">cat_nlink</a> += inode-&gt;i_nlink - 2;
<a name="l03297"></a>03297                 <span class="keywordflow">else</span>
<a name="l03298"></a>03298                         attr-&gt;<a class="code" href="structcl__attr.html#adb5d5843446f6e22035a41252821b558">cat_nlink</a> = inode-&gt;i_nlink;
<a name="l03299"></a>03299 
<a name="l03300"></a>03300                 attr-&gt;<a class="code" href="structcl__attr.html#a301cbfa8e597852a6f7cf1b5a22d5269" title="Object size, in bytes.">cat_size</a> += i_size_read(inode);
<a name="l03301"></a>03301                 attr-&gt;<a class="code" href="structcl__attr.html#aa5bce270584ece6d9511008c0d827821" title="Blocks allocated to this cl_object on the server file system.">cat_blocks</a> += inode-&gt;i_blocks;
<a name="l03302"></a>03302 
<a name="l03303"></a>03303                 <span class="keywordflow">if</span> (attr-&gt;<a class="code" href="structcl__attr.html#a703fa4a91dbf487ea43a491efbcbb26c" title="Access time.">cat_atime</a> &lt; <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_atime))
<a name="l03304"></a>03304                         attr-&gt;<a class="code" href="structcl__attr.html#a703fa4a91dbf487ea43a491efbcbb26c" title="Access time.">cat_atime</a> = <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_atime);
<a name="l03305"></a>03305 
<a name="l03306"></a>03306                 <span class="keywordflow">if</span> (attr-&gt;<a class="code" href="structcl__attr.html#ad219a939eaf54b1de26b049f26d513e3" title="Change time.">cat_ctime</a> &lt; <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_ctime))
<a name="l03307"></a>03307                         attr-&gt;<a class="code" href="structcl__attr.html#ad219a939eaf54b1de26b049f26d513e3" title="Change time.">cat_ctime</a> = <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_ctime);
<a name="l03308"></a>03308 
<a name="l03309"></a>03309                 <span class="keywordflow">if</span> (attr-&gt;<a class="code" href="structcl__attr.html#ac337ab4467993ed3c1ed8a74407e933b" title="Modification time.">cat_mtime</a> &lt; <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_mtime))
<a name="l03310"></a>03310                         attr-&gt;<a class="code" href="structcl__attr.html#ac337ab4467993ed3c1ed8a74407e933b" title="Modification time.">cat_mtime</a> = <a class="code" href="lustre__compat_8h.html#ac6cd4f8f1fbf819ea7dc7e04982421d8">LTIME_S</a>(inode-&gt;i_mtime);
<a name="l03311"></a>03311         }
<a name="l03312"></a>03312         <span class="keywordflow">return</span> 0;
<a name="l03313"></a>03313 }
<a name="l03314"></a>03314 
<a name="l03315"></a><a class="code" href="lmv__obd_8c.html#a2315e48b42bb79af78f27d9b317566d8">03315</a> <span class="keyword">struct </span><a class="code" href="structobd__ops.html">obd_ops</a> <a class="code" href="lmv__obd_8c.html#a2315e48b42bb79af78f27d9b317566d8">lmv_obd_ops</a> = {
<a name="l03316"></a>03316         .<a class="code" href="structobd__ops.html#a1d905bfb7cd60e05ff0faff20732fe42">o_owner</a>                = THIS_MODULE,
<a name="l03317"></a>03317         .o_setup                = <a class="code" href="lmv__obd_8c.html#a295efa072c780376181fc96771899903">lmv_setup</a>,
<a name="l03318"></a>03318         .o_cleanup              = <a class="code" href="lmv__obd_8c.html#a6044af72bfa0163d8aa9859102b53cc9">lmv_cleanup</a>,
<a name="l03319"></a>03319         .o_precleanup           = <a class="code" href="lmv__obd_8c.html#adaf72ea703c580a88031d1ffc03adf36">lmv_precleanup</a>,
<a name="l03320"></a>03320         .o_process_config       = <a class="code" href="lmv__obd_8c.html#a89db0aa4067690e5a01f919ec4ab9d12">lmv_process_config</a>,
<a name="l03321"></a>03321         .o_connect              = <a class="code" href="lmv__obd_8c.html#a3215b4f2832988ae74e314ebf87a9d06" title="This is fake connect function.">lmv_connect</a>,
<a name="l03322"></a>03322         .o_disconnect           = <a class="code" href="lmv__obd_8c.html#a8a025411eda85113b175add2a8b31199">lmv_disconnect</a>,
<a name="l03323"></a>03323         .o_statfs               = <a class="code" href="lmv__obd_8c.html#a3ab354bac566b6f197724735b8e99486">lmv_statfs</a>,
<a name="l03324"></a>03324         .o_get_info             = <a class="code" href="lmv__obd_8c.html#a185b85db495af14c9c1ae17f84ba2afa" title="Get by key a value associated with a LMV device.">lmv_get_info</a>,
<a name="l03325"></a>03325         .o_set_info_async       = <a class="code" href="lmv__obd_8c.html#a1b3bf908edcdf584cba9261f2050f3c8" title="Asynchronously set by key a value associated with a LMV device.">lmv_set_info_async</a>,
<a name="l03326"></a>03326         .o_notify               = <a class="code" href="lmv__obd_8c.html#aa869ce80b25cd9b74ed5f744408b6b9d">lmv_notify</a>,
<a name="l03327"></a>03327         .o_get_uuid             = <a class="code" href="lmv__obd_8c.html#a4f4cbe72defaebbbd48d57c3e562dacf">lmv_get_uuid</a>,
<a name="l03328"></a>03328         .o_iocontrol            = <a class="code" href="lmv__obd_8c.html#a1bc406e83f291f9544100be23621337d">lmv_iocontrol</a>,
<a name="l03329"></a>03329         .o_quotactl             = <a class="code" href="lmv__obd_8c.html#a93a6be8a582b30476451a0cfee6dd136" title="For lmv, only need to send request to master MDT, and the master MDT will process...">lmv_quotactl</a>
<a name="l03330"></a>03330 };
<a name="l03331"></a>03331 
<a name="l03332"></a><a class="code" href="lmv__obd_8c.html#a4a222531b387bcb682a8a2cf3bc858e3">03332</a> <span class="keyword">struct </span><a class="code" href="structmd__ops.html">md_ops</a> <a class="code" href="lmv__obd_8c.html#a4a222531b387bcb682a8a2cf3bc858e3">lmv_md_ops</a> = {
<a name="l03333"></a>03333         .<a class="code" href="structmd__ops.html#aab55a23c0a0068009457d43984f403f2">m_get_root</a>             = <a class="code" href="lmv__obd_8c.html#a8fa39ecac1dfe50f1ebdde9b8fb8798d">lmv_get_root</a>,
<a name="l03334"></a>03334         .m_null_inode           = <a class="code" href="lmv__obd_8c.html#a1d77d1d8603229370a492c77d9b37b37">lmv_null_inode</a>,
<a name="l03335"></a>03335         .m_close                = <a class="code" href="lmv__obd_8c.html#a7e108407d78521b4877acad2a638886b">lmv_close</a>,
<a name="l03336"></a>03336         .m_create               = <a class="code" href="lmv__obd_8c.html#ae3a46b26985b29c729e7f48c087c4359">lmv_create</a>,
<a name="l03337"></a>03337         .m_enqueue              = <a class="code" href="lmv__obd_8c.html#a400fcbf4f9ebb49443ca96f96b8d36f3">lmv_enqueue</a>,
<a name="l03338"></a>03338         .m_getattr              = <a class="code" href="lmv__obd_8c.html#a609037f05523b500d549599233b7d83f">lmv_getattr</a>,
<a name="l03339"></a>03339         .m_getxattr             = <a class="code" href="lmv__obd_8c.html#a22af5ada04de1833fc34b44a81debfb3">lmv_getxattr</a>,
<a name="l03340"></a>03340         .m_getattr_name         = <a class="code" href="lmv__obd_8c.html#a064a9aa683e74e1fa42ad3cd120ddd47">lmv_getattr_name</a>,
<a name="l03341"></a>03341         .m_intent_lock          = <a class="code" href="lmv__intent_8c.html#a1b0e21180a6bf9e10164dab2b5ac957d">lmv_intent_lock</a>,
<a name="l03342"></a>03342         .m_link                 = <a class="code" href="lmv__obd_8c.html#a65d95805f65731dcf53d86b1a6349280">lmv_link</a>,
<a name="l03343"></a>03343         .m_rename               = <a class="code" href="lmv__obd_8c.html#a4353f342e8661da339737eb530de97ca">lmv_rename</a>,
<a name="l03344"></a>03344         .m_setattr              = <a class="code" href="lmv__obd_8c.html#a5253b73fcc04860f8fbe1ddf51a80aef">lmv_setattr</a>,
<a name="l03345"></a>03345         .m_setxattr             = <a class="code" href="lmv__obd_8c.html#a912a94b2ced458d6853eddc7432dc9b5">lmv_setxattr</a>,
<a name="l03346"></a>03346         .m_fsync                = <a class="code" href="lmv__obd_8c.html#a24348514ac1032d2c71a05f4225faa2d">lmv_fsync</a>,
<a name="l03347"></a>03347         .m_read_page            = <a class="code" href="lmv__obd_8c.html#a77ddaef3bfdf78719995a9b055348eb9">lmv_read_page</a>,
<a name="l03348"></a>03348         .m_unlink               = <a class="code" href="lmv__obd_8c.html#a37f938dadecf8e635ec310b25da1af6e" title="Unlink a file/directory.">lmv_unlink</a>,
<a name="l03349"></a>03349         .m_init_ea_size         = <a class="code" href="lmv__obd_8c.html#affc5ccbd65650a05ba6a3ecf93f57695">lmv_init_ea_size</a>,
<a name="l03350"></a>03350         .m_cancel_unused        = <a class="code" href="lmv__obd_8c.html#ad7e5a72922ae183585448166d397eff9">lmv_cancel_unused</a>,
<a name="l03351"></a>03351         .m_set_lock_data        = <a class="code" href="lmv__obd_8c.html#aa41138bbba5fea3e7e2e6e7db587ab45">lmv_set_lock_data</a>,
<a name="l03352"></a>03352         .m_lock_match           = <a class="code" href="lmv__obd_8c.html#a2ebc911562ec532addf480e9d4cfa519">lmv_lock_match</a>,
<a name="l03353"></a>03353         .m_get_lustre_md        = <a class="code" href="lmv__obd_8c.html#a8546b65d07e6108f640182b4d8abb4df">lmv_get_lustre_md</a>,
<a name="l03354"></a>03354         .m_free_lustre_md       = <a class="code" href="lmv__obd_8c.html#a2cfaa349554a8fbaff692c14a174d4ba">lmv_free_lustre_md</a>,
<a name="l03355"></a>03355         .m_merge_attr           = <a class="code" href="lmv__obd_8c.html#a3190d6d24fe70f402b9f47672045f0d8">lmv_merge_attr</a>,
<a name="l03356"></a>03356         .m_set_open_replay_data = <a class="code" href="lmv__obd_8c.html#af57f91ac7d21cf3527c1b9eb97d2defe">lmv_set_open_replay_data</a>,
<a name="l03357"></a>03357         .m_clear_open_replay_data = <a class="code" href="lmv__obd_8c.html#a65eafe0ff27a1345e90853adb64b2829">lmv_clear_open_replay_data</a>,
<a name="l03358"></a>03358         .m_get_remote_perm      = <a class="code" href="lmv__obd_8c.html#aa2bbb22e7c5a64e0bd3faad35d85fa7a">lmv_get_remote_perm</a>,
<a name="l03359"></a>03359         .m_intent_getattr_async = <a class="code" href="lmv__obd_8c.html#aae835c2a7bd7abd5f52f7fc2930925e9">lmv_intent_getattr_async</a>,
<a name="l03360"></a>03360         .m_revalidate_lock      = <a class="code" href="lmv__obd_8c.html#a5f0eedaeac41ef96418edde28accae10">lmv_revalidate_lock</a>,
<a name="l03361"></a>03361         .m_get_fid_from_lsm     = <a class="code" href="lmv__obd_8c.html#a1e320cfb95fa8eaf45092695276c1b16">lmv_get_fid_from_lsm</a>,
<a name="l03362"></a>03362         .m_unpackmd             = <a class="code" href="lmv__obd_8c.html#a9841ccb2cbc456a8ce1f0339b2e48eba">lmv_unpackmd</a>,
<a name="l03363"></a>03363 };
<a name="l03364"></a>03364 
<a name="l03365"></a><a class="code" href="lmv__obd_8c.html#a00db9320628641c4a5265a5f24014c28">03365</a> <span class="keyword">static</span> <span class="keywordtype">int</span> __init <a class="code" href="lmv__obd_8c.html#a00db9320628641c4a5265a5f24014c28">lmv_init</a>(<span class="keywordtype">void</span>)
<a name="l03366"></a>03366 {
<a name="l03367"></a>03367         <span class="keywordflow">return</span> <a class="code" href="obd__class_8h.html#a665023caafcfe1f305a0c4a43915f030">class_register_type</a>(&amp;lmv_obd_ops, &amp;lmv_md_ops, <span class="keyword">true</span>, NULL,
<a name="l03368"></a>03368                                    <a class="code" href="obd_8h.html#a144eb9f1cb91bf276a8b5d822f24cb29">LUSTRE_LMV_NAME</a>, NULL);
<a name="l03369"></a>03369 }
<a name="l03370"></a>03370 
<a name="l03371"></a><a class="code" href="lmv__obd_8c.html#a63836a421497b158a12c8a0ad65af700">03371</a> <span class="keyword">static</span> <span class="keywordtype">void</span> __exit <a class="code" href="lmv__obd_8c.html#a63836a421497b158a12c8a0ad65af700">lmv_exit</a>(<span class="keywordtype">void</span>)
<a name="l03372"></a>03372 {
<a name="l03373"></a>03373         <a class="code" href="obd__class_8h.html#a29f206a0cee106493944a2299db6b0de">class_unregister_type</a>(<a class="code" href="obd_8h.html#a144eb9f1cb91bf276a8b5d822f24cb29">LUSTRE_LMV_NAME</a>);
<a name="l03374"></a>03374 }
<a name="l03375"></a>03375 
<a name="l03376"></a>03376 <a class="code" href="fid__request_8c.html#adc10f40acba3bb9b2640e985276b0a7c">MODULE_AUTHOR</a>(<span class="stringliteral">&quot;OpenSFS, Inc. &lt;http://www.lustre.org/&gt;&quot;</span>);
<a name="l03377"></a>03377 <a class="code" href="fid__request_8c.html#a3776617b6b07366bf8b810cb05d9c2ad">MODULE_DESCRIPTION</a>(<span class="stringliteral">&quot;Lustre Logical Metadata Volume&quot;</span>);
<a name="l03378"></a>03378 <a class="code" href="fid__request_8c.html#ae9c321be2136fb8501887ee69dac11a2">MODULE_VERSION</a>(LUSTRE_VERSION_STRING);
<a name="l03379"></a>03379 <a class="code" href="fid__request_8c.html#ad94b36675e7eb067ea3ce6ff9e244a44">MODULE_LICENSE</a>(<span class="stringliteral">&quot;GPL&quot;</span>);
<a name="l03380"></a>03380 
<a name="l03381"></a>03381 <a class="code" href="lustre__compat_8h.html#a4b67244ef1fdd3ee4d5f3a591ceee9cf">module_init</a>(<a class="code" href="lmv__obd_8c.html#a00db9320628641c4a5265a5f24014c28">lmv_init</a>);
<a name="l03382"></a>03382 <a class="code" href="fid__request_8c.html#a89b857126cdbaea60008ebb5aa6161be">module_exit</a>(<a class="code" href="lmv__obd_8c.html#a63836a421497b158a12c8a0ad65af700">lmv_exit</a>);
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:37 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
