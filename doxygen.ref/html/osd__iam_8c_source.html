<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/osd-ldiskfs/osd_iam.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/osd-ldiskfs/osd_iam.c</h1><a href="osd__iam_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see [sun.com URL with a</span>
<a name="l00018"></a>00018 <span class="comment"> * copy of GPLv2].</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2011, 2015, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * iam.c</span>
<a name="l00037"></a>00037 <span class="comment"> * Top-level entry points into iam module</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * Author: Wang Di &lt;wangdi@clusterfs.com&gt;</span>
<a name="l00040"></a>00040 <span class="comment"> * Author: Nikita Danilov &lt;nikita@clusterfs.com&gt;</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">/*</span>
<a name="l00044"></a>00044 <span class="comment"> * iam: big theory statement.</span>
<a name="l00045"></a>00045 <span class="comment"> *</span>
<a name="l00046"></a>00046 <span class="comment"> * iam (Index Access Module) is a module providing abstraction of persistent</span>
<a name="l00047"></a>00047 <span class="comment"> * transactional container on top of generalized ldiskfs htree.</span>
<a name="l00048"></a>00048 <span class="comment"> *</span>
<a name="l00049"></a>00049 <span class="comment"> * iam supports:</span>
<a name="l00050"></a>00050 <span class="comment"> *</span>
<a name="l00051"></a>00051 <span class="comment"> *     - key, pointer, and record size specifiable per container.</span>
<a name="l00052"></a>00052 <span class="comment"> *</span>
<a name="l00053"></a>00053 <span class="comment"> *     - trees taller than 2 index levels.</span>
<a name="l00054"></a>00054 <span class="comment"> *</span>
<a name="l00055"></a>00055 <span class="comment"> *     - read/write to existing ldiskfs htree directories as iam containers.</span>
<a name="l00056"></a>00056 <span class="comment"> *</span>
<a name="l00057"></a>00057 <span class="comment"> * iam container is a tree, consisting of leaf nodes containing keys and</span>
<a name="l00058"></a>00058 <span class="comment"> * records stored in this container, and index nodes, containing keys and</span>
<a name="l00059"></a>00059 <span class="comment"> * pointers to leaf or index nodes.</span>
<a name="l00060"></a>00060 <span class="comment"> *</span>
<a name="l00061"></a>00061 <span class="comment"> * iam does not work with keys directly, instead it calls user-supplied key</span>
<a name="l00062"></a>00062 <span class="comment"> * comparison function (-&gt;dpo_keycmp()).</span>
<a name="l00063"></a>00063 <span class="comment"> *</span>
<a name="l00064"></a>00064 <span class="comment"> * Pointers are (currently) interpreted as logical offsets (measured in</span>
<a name="l00065"></a>00065 <span class="comment"> * blocksful) within underlying flat file on top of which iam tree lives.</span>
<a name="l00066"></a>00066 <span class="comment"> *</span>
<a name="l00067"></a>00067 <span class="comment"> * On-disk format:</span>
<a name="l00068"></a>00068 <span class="comment"> *</span>
<a name="l00069"></a>00069 <span class="comment"> * iam mostly tries to reuse existing htree formats.</span>
<a name="l00070"></a>00070 <span class="comment"> *</span>
<a name="l00071"></a>00071 <span class="comment"> * Format of index node:</span>
<a name="l00072"></a>00072 <span class="comment"> *</span>
<a name="l00073"></a>00073 <span class="comment"> * +-----+-------+-------+-------+------+-------+------------+</span>
<a name="l00074"></a>00074 <span class="comment"> * |     | count |       |       |      |       |            |</span>
<a name="l00075"></a>00075 <span class="comment"> * | gap |   /   | entry | entry | .... | entry | free space |</span>
<a name="l00076"></a>00076 <span class="comment"> * |     | limit |       |       |      |       |            |</span>
<a name="l00077"></a>00077 <span class="comment"> * +-----+-------+-------+-------+------+-------+------------+</span>
<a name="l00078"></a>00078 <span class="comment"> *</span>
<a name="l00079"></a>00079 <span class="comment"> *       gap           this part of node is never accessed by iam code. It</span>
<a name="l00080"></a>00080 <span class="comment"> *                     exists for binary compatibility with ldiskfs htree (that,</span>
<a name="l00081"></a>00081 <span class="comment"> *                     in turn, stores fake struct ext2_dirent for ext2</span>
<a name="l00082"></a>00082 <span class="comment"> *                     compatibility), and to keep some unspecified per-node</span>
<a name="l00083"></a>00083 <span class="comment"> *                     data. Gap can be different for root and non-root index</span>
<a name="l00084"></a>00084 <span class="comment"> *                     nodes. Gap size can be specified for each container</span>
<a name="l00085"></a>00085 <span class="comment"> *                     (gap of 0 is allowed).</span>
<a name="l00086"></a>00086 <span class="comment"> *</span>
<a name="l00087"></a>00087 <span class="comment"> *       count/limit   current number of entries in this node, and the maximal</span>
<a name="l00088"></a>00088 <span class="comment"> *                     number of entries that can fit into node. count/limit</span>
<a name="l00089"></a>00089 <span class="comment"> *                     has the same size as entry, and is itself counted in</span>
<a name="l00090"></a>00090 <span class="comment"> *                     count.</span>
<a name="l00091"></a>00091 <span class="comment"> *</span>
<a name="l00092"></a>00092 <span class="comment"> *       entry         index entry: consists of a key immediately followed by</span>
<a name="l00093"></a>00093 <span class="comment"> *                     a pointer to a child node. Size of a key and size of a</span>
<a name="l00094"></a>00094 <span class="comment"> *                     pointer depends on container. Entry has neither</span>
<a name="l00095"></a>00095 <span class="comment"> *                     alignment nor padding.</span>
<a name="l00096"></a>00096 <span class="comment"> *</span>
<a name="l00097"></a>00097 <span class="comment"> *       free space    portion of node new entries are added to</span>
<a name="l00098"></a>00098 <span class="comment"> *</span>
<a name="l00099"></a>00099 <span class="comment"> * Entries in index node are sorted by their key value.</span>
<a name="l00100"></a>00100 <span class="comment"> *</span>
<a name="l00101"></a>00101 <span class="comment"> * Format of a leaf node is not specified. Generic iam code accesses leaf</span>
<a name="l00102"></a>00102 <span class="comment"> * nodes through -&gt;id_leaf methods in struct iam_descr.</span>
<a name="l00103"></a>00103 <span class="comment"> *</span>
<a name="l00104"></a>00104 <span class="comment"> * The IAM root block is a special node, which contains the IAM descriptor.</span>
<a name="l00105"></a>00105 <span class="comment"> * It is on disk format:</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> * +---------+-------+--------+---------+-------+------+-------+------------+</span>
<a name="l00108"></a>00108 <span class="comment"> * |IAM desc | count |  idle  |         |       |      |       |            |</span>
<a name="l00109"></a>00109 <span class="comment"> * |(fix/var)|   /   | blocks | padding | entry | .... | entry | free space |</span>
<a name="l00110"></a>00110 <span class="comment"> * |         | limit |        |         |       |      |       |            |</span>
<a name="l00111"></a>00111 <span class="comment"> * +---------+-------+--------+---------+-------+------+-------+------------+</span>
<a name="l00112"></a>00112 <span class="comment"> *</span>
<a name="l00113"></a>00113 <span class="comment"> * The padding length is calculated with the parameters in the IAM descriptor.</span>
<a name="l00114"></a>00114 <span class="comment"> *</span>
<a name="l00115"></a>00115 <span class="comment"> * The field &quot;idle_blocks&quot; is used to record empty leaf nodes, which have not</span>
<a name="l00116"></a>00116 <span class="comment"> * been released but all contained entries in them have been removed. Usually,</span>
<a name="l00117"></a>00117 <span class="comment"> * the idle blocks in the IAM should be reused when need to allocate new leaf</span>
<a name="l00118"></a>00118 <span class="comment"> * nodes for new entries, it depends on the IAM hash functions to map the new</span>
<a name="l00119"></a>00119 <span class="comment"> * entries to these idle blocks. Unfortunately, it is not easy to design some</span>
<a name="l00120"></a>00120 <span class="comment"> * hash functions for such clever mapping, especially considering the insert/</span>
<a name="l00121"></a>00121 <span class="comment"> * lookup performance.</span>
<a name="l00122"></a>00122 <span class="comment"> *</span>
<a name="l00123"></a>00123 <span class="comment"> * So the IAM recycles the empty leaf nodes, and put them into a per-file based</span>
<a name="l00124"></a>00124 <span class="comment"> * idle blocks pool. If need some new leaf node, it will try to take idle block</span>
<a name="l00125"></a>00125 <span class="comment"> * from such pool with priority, in spite of how the IAM hash functions to map</span>
<a name="l00126"></a>00126 <span class="comment"> * the entry.</span>
<a name="l00127"></a>00127 <span class="comment"> *</span>
<a name="l00128"></a>00128 <span class="comment"> * The idle blocks pool is organized as a series of tables, and each table</span>
<a name="l00129"></a>00129 <span class="comment"> * can be described as following (on-disk format):</span>
<a name="l00130"></a>00130 <span class="comment"> *</span>
<a name="l00131"></a>00131 <span class="comment"> * +---------+---------+---------+---------+------+---------+-------+</span>
<a name="l00132"></a>00132 <span class="comment"> * |  magic  |  count  |  next   |  logic  |      |  logic  | free  |</span>
<a name="l00133"></a>00133 <span class="comment"> * |(16 bits)|(16 bits)|  table  |  blk #  | .... |  blk #  | space |</span>
<a name="l00134"></a>00134 <span class="comment"> * |         |         |(32 bits)|(32 bits)|      |(32 bits)|       |</span>
<a name="l00135"></a>00135 <span class="comment"> * +---------+---------+---------+---------+------+---------+-------+</span>
<a name="l00136"></a>00136 <span class="comment"> *</span>
<a name="l00137"></a>00137 <span class="comment"> * The logic blk# for the first table is stored in the root node &quot;idle_blocks&quot;.</span>
<a name="l00138"></a>00138 <span class="comment"> *</span>
<a name="l00139"></a>00139 <span class="comment"> */</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
<a name="l00142"></a>00142 <span class="preprocessor">#include &lt;linux/fs.h&gt;</span>
<a name="l00143"></a>00143 <span class="preprocessor">#include &lt;linux/pagemap.h&gt;</span>
<a name="l00144"></a>00144 <span class="preprocessor">#include &lt;linux/time.h&gt;</span>
<a name="l00145"></a>00145 <span class="preprocessor">#include &lt;linux/fcntl.h&gt;</span>
<a name="l00146"></a>00146 <span class="preprocessor">#include &lt;linux/stat.h&gt;</span>
<a name="l00147"></a>00147 <span class="preprocessor">#include &lt;linux/string.h&gt;</span>
<a name="l00148"></a>00148 <span class="preprocessor">#include &lt;linux/quotaops.h&gt;</span>
<a name="l00149"></a>00149 <span class="preprocessor">#include &lt;linux/buffer_head.h&gt;</span>
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="preprocessor">#include &lt;ldiskfs/ldiskfs.h&gt;</span>
<a name="l00152"></a>00152 <span class="preprocessor">#include &lt;ldiskfs/xattr.h&gt;</span>
<a name="l00153"></a>00153 <span class="preprocessor">#undef ENTRY</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>
<a name="l00155"></a>00155 <span class="preprocessor">#include &quot;<a class="code" href="osd-zfs_2osd__internal_8h.html">osd_internal.h</a>&quot;</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="preprocessor">#include &lt;ldiskfs/acl.h&gt;</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/*</span>
<a name="l00160"></a>00160 <span class="comment"> * List of all registered formats.</span>
<a name="l00161"></a>00161 <span class="comment"> *</span>
<a name="l00162"></a>00162 <span class="comment"> * No locking. Callers synchronize.</span>
<a name="l00163"></a>00163 <span class="comment"> */</span>
<a name="l00164"></a><a class="code" href="osd__iam_8c.html#aa6f00bfd21b6a068379d73c727ac57e6">00164</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> <a class="code" href="osd__iam_8c.html#aa6f00bfd21b6a068379d73c727ac57e6">iam_formats</a> = <a class="code" href="list_8h.html#a4642d4b7df28478bb762fe43c85b5c63">LIST_HEAD_INIT</a>(iam_formats);
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="osd__iam_8h.html#a06db6d51b5847b1d116e6881d00f5668">00166</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a06db6d51b5847b1d116e6881d00f5668">iam_format_register</a>(<span class="keyword">struct</span> <a class="code" href="structiam__format.html">iam_format</a> *fmt)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168         <a class="code" href="list_8h.html#a0373c4b3c8ce51a451a569ad978b32e1" title="Insert an entry at the start of a list.">list_add</a>(&amp;fmt-&gt;<a class="code" href="structiam__format.html#a5d17677a597d59e09b32cddb54448dfd">if_linkage</a>, &amp;iam_formats);
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keyword">struct </span>buffer_head *
<a name="l00172"></a><a class="code" href="osd__iam_8c.html#a73832112694bc2f520b001d23c522fed">00172</a> <a class="code" href="osd__iam_8c.html#a73832112694bc2f520b001d23c522fed">iam_load_idle_blocks</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> blk)
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174         <span class="keyword">struct </span>inode *inode = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l00175"></a>00175         <span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *<a class="code" href="writemany_8c.html#af39400667a953a7c5c34e3964aa1ce9f">head</a>;
<a name="l00176"></a>00176         <span class="keyword">struct </span>buffer_head *bh;
<a name="l00177"></a>00177         <span class="keywordtype">int</span> err = 0;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(mutex_is_locked(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>));
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="keywordflow">if</span> (blk == 0)
<a name="l00182"></a>00182                 <span class="keywordflow">return</span> NULL;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         bh = ldiskfs_bread(NULL, inode, blk, 0, &amp;err);
<a name="l00185"></a>00185         <span class="keywordflow">if</span> (bh == NULL) {
<a name="l00186"></a>00186                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%.16s: cannot load idle blocks, blk = %u, err = %d\n&quot;</span>,
<a name="l00187"></a>00187                        LDISKFS_SB(inode-&gt;i_sb)-&gt;s_es-&gt;s_volume_name, blk, err);
<a name="l00188"></a>00188                 c-&gt;<a class="code" href="structiam__container.html#a62e3cc423e725203de906903ae875e7f">ic_idle_failed</a> = 1;
<a name="l00189"></a>00189                 err = err ? err : -EIO;
<a name="l00190"></a>00190                 <span class="keywordflow">return</span> ERR_PTR(err);
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         head = (<span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *)(bh-&gt;b_data);
<a name="l00194"></a>00194         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(head-&gt;<a class="code" href="structiam__idle__head.html#a8bddc664b6d18597f86e2ba8fcb6fbf3">iih_magic</a>) != <a class="code" href="osd__iam_8h.html#a592aba11ab30da4dbf57e9736c8387a1ae825b385122e9e4c0554ef7fc414d3fb">IAM_IDLE_HEADER_MAGIC</a>) {
<a name="l00195"></a>00195                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%.16s: invalid idle block head, blk = %u, magic = %d\n&quot;</span>,
<a name="l00196"></a>00196                        LDISKFS_SB(inode-&gt;i_sb)-&gt;s_es-&gt;s_volume_name, blk,
<a name="l00197"></a>00197                        <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(head-&gt;<a class="code" href="structiam__idle__head.html#a8bddc664b6d18597f86e2ba8fcb6fbf3">iih_magic</a>));
<a name="l00198"></a>00198                 brelse(bh);
<a name="l00199"></a>00199                 c-&gt;<a class="code" href="structiam__container.html#a62e3cc423e725203de906903ae875e7f">ic_idle_failed</a> = 1;
<a name="l00200"></a>00200                 <span class="keywordflow">return</span> ERR_PTR(-EBADF);
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="keywordflow">return</span> bh;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="comment">/*</span>
<a name="l00207"></a>00207 <span class="comment"> * Determine format of given container. This is done by scanning list of</span>
<a name="l00208"></a>00208 <span class="comment"> * registered formats and calling -&gt;if_guess() method of each in turn.</span>
<a name="l00209"></a>00209 <span class="comment"> */</span>
<a name="l00210"></a><a class="code" href="osd__iam_8c.html#a64d243bd353a203fa90084460c1fa0a7">00210</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a64d243bd353a203fa90084460c1fa0a7">iam_format_guess</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212         <span class="keywordtype">int</span> result;
<a name="l00213"></a>00213         <span class="keyword">struct </span><a class="code" href="structiam__format.html">iam_format</a> *fmt;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="comment">/*</span>
<a name="l00216"></a>00216 <span class="comment">         * XXX temporary initialization hook.</span>
<a name="l00217"></a>00217 <span class="comment">         */</span>
<a name="l00218"></a>00218         {
<a name="l00219"></a>00219                 <span class="keyword">static</span> <span class="keywordtype">int</span> initialized = 0;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                 <span class="keywordflow">if</span> (!initialized) {
<a name="l00222"></a>00222                         <a class="code" href="osd__iam_8h.html#a89fafa24fd312caed26f05ac77d43c9f">iam_lvar_format_init</a>();
<a name="l00223"></a>00223                         <a class="code" href="osd__iam_8h.html#a75dbf34ccde7b0141e2598a19e6f2de8">iam_lfix_format_init</a>();
<a name="l00224"></a>00224                         initialized = 1;
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         result = -ENOENT;
<a name="l00229"></a>00229         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(fmt, &amp;iam_formats, <a class="code" href="structiam__format.html#a5d17677a597d59e09b32cddb54448dfd">if_linkage</a>) {
<a name="l00230"></a>00230                 result = fmt-&gt;<a class="code" href="structiam__format.html#afe0f14bd5f3e655f31d6e1dcab6f6065">if_guess</a>(c);
<a name="l00231"></a>00231                 <span class="keywordflow">if</span> (result == 0)
<a name="l00232"></a>00232                         <span class="keywordflow">break</span>;
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (result == 0) {
<a name="l00236"></a>00236                 <span class="keyword">struct </span>buffer_head *bh;
<a name="l00237"></a>00237                 __u32 *idle_blocks;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a> != NULL);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241                 idle_blocks = (__u32 *)(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>-&gt;b_data +
<a name="l00242"></a>00242                                         c-&gt;<a class="code" href="structiam__container.html#a33d58684b5bfc25a9e1498098435df96">ic_descr</a>-&gt;<a class="code" href="structiam__descr.html#a25bbbcb7becbec775fe8348f85374511">id_root_gap</a> +
<a name="l00243"></a>00243                                         <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdx__countlimit.html">dx_countlimit</a>));
<a name="l00244"></a>00244                 mutex_lock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l00245"></a>00245                 bh = <a class="code" href="osd__iam_8c.html#a73832112694bc2f520b001d23c522fed">iam_load_idle_blocks</a>(c, <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(*idle_blocks));
<a name="l00246"></a>00246                 <span class="keywordflow">if</span> (bh != NULL &amp;&amp; IS_ERR(bh))
<a name="l00247"></a>00247                         result = PTR_ERR(bh);
<a name="l00248"></a>00248                 <span class="keywordflow">else</span>
<a name="l00249"></a>00249                         c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> = bh;
<a name="l00250"></a>00250                 mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="keywordflow">return</span> result;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">/*</span>
<a name="l00257"></a>00257 <span class="comment"> * Initialize container @c.</span>
<a name="l00258"></a>00258 <span class="comment"> */</span>
<a name="l00259"></a><a class="code" href="osd__iam_8h.html#aa54328ea7def6378c750cbcbc2d89809">00259</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#aa54328ea7def6378c750cbcbc2d89809">iam_container_init</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c,
<a name="l00260"></a>00260                        <span class="keyword">struct</span> <a class="code" href="structiam__descr.html">iam_descr</a> *descr, <span class="keyword">struct</span> inode *inode)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262         memset(c, 0, <span class="keyword">sizeof</span> *c);
<a name="l00263"></a>00263         c-&gt;<a class="code" href="structiam__container.html#a33d58684b5bfc25a9e1498098435df96">ic_descr</a>  = descr;
<a name="l00264"></a>00264         c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a> = inode;
<a name="l00265"></a>00265         init_rwsem(&amp;c-&gt;<a class="code" href="structiam__container.html#a775b3664ec7ee0c1b31b35cd5e50fa4b">ic_sem</a>);
<a name="l00266"></a>00266         <a class="code" href="osd__dynlocks_8c.html#a82f7ed7e6ba13307fa97c9417b4ca9c1">dynlock_init</a>(&amp;c-&gt;<a class="code" href="structiam__container.html#a893d4066dc726fbf8876af868fe23e06">ic_tree_lock</a>);
<a name="l00267"></a>00267         mutex_init(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l00268"></a>00268         <span class="keywordflow">return</span> 0;
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="comment">/*</span>
<a name="l00272"></a>00272 <span class="comment"> * Determine container format.</span>
<a name="l00273"></a>00273 <span class="comment"> */</span>
<a name="l00274"></a><a class="code" href="osd__iam_8h.html#a201ab2f4f976eafebe4b484a0de296c1">00274</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a201ab2f4f976eafebe4b484a0de296c1">iam_container_setup</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a64d243bd353a203fa90084460c1fa0a7">iam_format_guess</a>(c);
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="comment">/*</span>
<a name="l00280"></a>00280 <span class="comment"> * Finalize container @c, release all resources.</span>
<a name="l00281"></a>00281 <span class="comment"> */</span>
<a name="l00282"></a><a class="code" href="osd__iam_8h.html#a4cf6104942f60fe5c8c62b48b2491d44">00282</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a4cf6104942f60fe5c8c62b48b2491d44">iam_container_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284         brelse(c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>);
<a name="l00285"></a>00285         c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> = NULL;
<a name="l00286"></a>00286         brelse(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l00287"></a>00287         c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a> = NULL;
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="osd__iam_8h.html#ae6a4c983524c4c07e1cf209cb56a60dc">00290</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#ae6a4c983524c4c07e1cf209cb56a60dc">iam_path_init</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c,
<a name="l00291"></a>00291                    <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293         memset(path, 0, <span class="keyword">sizeof</span> *path);
<a name="l00294"></a>00294         path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a> = c;
<a name="l00295"></a>00295         path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a> = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>;
<a name="l00296"></a>00296         path-&gt;<a class="code" href="structiam__path.html#a32b6d70accb42d559545d258a87274d9">ip_data</a> = pd;
<a name="l00297"></a>00297         path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>.<a class="code" href="structiam__leaf.html#a697c79bd22bbdbba1a763806ef593097">il_path</a> = path;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">iam_leaf_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf);
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="osd__iam_8h.html#a2d391de29e3a6a4a5315359b2a21ec87">00302</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a2d391de29e3a6a4a5315359b2a21ec87">iam_path_release</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304         <span class="keywordtype">int</span> i;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>); i++) {
<a name="l00307"></a>00307                 <span class="keywordflow">if</span> (path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> != NULL) {
<a name="l00308"></a>00308                         path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i].<a class="code" href="structiam__frame.html#ab52473c2d49f64e28edf64f629949a3b">at_shifted</a> = 0;
<a name="l00309"></a>00309                         brelse(path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00310"></a>00310                         path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> = NULL;
<a name="l00311"></a>00311                 }
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="osd__iam_8h.html#a1bd74b20cfb72d6cc7373ebc631f882e">00315</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317         <a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">iam_leaf_fini</a>(&amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l00318"></a>00318         <a class="code" href="osd__iam_8c.html#a2d391de29e3a6a4a5315359b2a21ec87">iam_path_release</a>(path);
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="osd__iam_8h.html#ad28f84a9f4277d97159f6c874a6625a8">00322</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#ad28f84a9f4277d97159f6c874a6625a8">iam_path_compat_init</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path__compat.html">iam_path_compat</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>, <span class="keyword">struct</span> inode *inode)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324         <span class="keywordtype">int</span> i;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         path-&gt;<a class="code" href="structiam__path__compat.html#af0de8bd58d0a03309dd876b880e56f47">ipc_hinfo</a> = &amp;path-&gt;<a class="code" href="structiam__path__compat.html#af5491d63d7f476b97800d5b5571011d7">ipc_hinfo_area</a>;
<a name="l00327"></a>00327         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(path-&gt;<a class="code" href="structiam__path__compat.html#a84f8f9a5f3ec80658cbf29e1e4b98718">ipc_scratch</a>); ++i)
<a name="l00328"></a>00328                 path-&gt;<a class="code" href="structiam__path__compat.html#a24a50415e6b1bdd06ec825bd7d8de2f8">ipc_descr</a>.<a class="code" href="structiam__path__descr.html#a6eef735a83e02b696cce83a5efdfb342">ipd_key_scratch</a>[i] =
<a name="l00329"></a>00329                         (<span class="keyword">struct</span> iam_ikey *)&amp;path-&gt;<a class="code" href="structiam__path__compat.html#a84f8f9a5f3ec80658cbf29e1e4b98718">ipc_scratch</a>[i];
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <a class="code" href="osd__iam_8c.html#ae6a4c983524c4c07e1cf209cb56a60dc">iam_path_init</a>(&amp;path-&gt;<a class="code" href="structiam__path__compat.html#a020b55ea71e1b8e04c92c8f418f0aec4">ipc_path</a>, &amp;path-&gt;<a class="code" href="structiam__path__compat.html#a466d6f213fae6983bf3d4c79eed649a4">ipc_container</a>, &amp;path-&gt;<a class="code" href="structiam__path__compat.html#a24a50415e6b1bdd06ec825bd7d8de2f8">ipc_descr</a>);
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a><a class="code" href="osd__iam_8h.html#a7a13690fc6d9f215873c4743cfcc427a">00334</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a7a13690fc6d9f215873c4743cfcc427a">iam_path_compat_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path__compat.html">iam_path_compat</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336         <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(&amp;path-&gt;<a class="code" href="structiam__path__compat.html#a020b55ea71e1b8e04c92c8f418f0aec4">ipc_path</a>);
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="comment">/*</span>
<a name="l00340"></a>00340 <span class="comment"> * Helper function initializing iam_path_descr and its key scratch area.</span>
<a name="l00341"></a>00341 <span class="comment"> */</span>
<a name="l00342"></a><a class="code" href="osd__iam_8h.html#a069654aefd1b06105e571301aad29204">00342</a> <span class="keyword">struct </span><a class="code" href="structiam__path__descr.html">iam_path_descr</a> *<a class="code" href="osd__iam_8c.html#a069654aefd1b06105e571301aad29204">iam_ipd_alloc</a>(<span class="keywordtype">void</span> *area, <span class="keywordtype">int</span> keysize)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344         <span class="keyword">struct </span><a class="code" href="structiam__path__descr.html">iam_path_descr</a> *ipd;
<a name="l00345"></a>00345         <span class="keywordtype">void</span> *karea;
<a name="l00346"></a>00346         <span class="keywordtype">int</span> i;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         ipd = area;
<a name="l00349"></a>00349         karea = ipd + 1;
<a name="l00350"></a>00350         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(ipd-&gt;<a class="code" href="structiam__path__descr.html#a6eef735a83e02b696cce83a5efdfb342">ipd_key_scratch</a>); ++i, karea += keysize)
<a name="l00351"></a>00351                 ipd-&gt;<a class="code" href="structiam__path__descr.html#a6eef735a83e02b696cce83a5efdfb342">ipd_key_scratch</a>[i] = karea;
<a name="l00352"></a>00352         <span class="keywordflow">return</span> ipd;
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a><a class="code" href="osd__iam_8h.html#a0846ac1690eb01723e745efb597f8b26">00355</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a0846ac1690eb01723e745efb597f8b26">iam_ipd_free</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *ipd)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a><a class="code" href="osd__iam_8h.html#ae6796e62b89447681d05b6cfc6fb9042">00359</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#af8b337f97c5725965c1bf07e60a2f725">iam_node_read</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> ptr,
<a name="l00360"></a>00360                   handle_t *h, <span class="keyword">struct</span> buffer_head **bh)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362         <span class="keywordtype">int</span> result = 0;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="comment">/* NB: it can be called by iam_lfix_guess() which is still at</span>
<a name="l00365"></a>00365 <span class="comment">         * very early stage, c-&gt;ic_root_bh and c-&gt;ic_descr-&gt;id_ops</span>
<a name="l00366"></a>00366 <span class="comment">         * haven&apos;t been intialized yet.</span>
<a name="l00367"></a>00367 <span class="comment">         * Also, we don&apos;t have this for IAM dir.</span>
<a name="l00368"></a>00368 <span class="comment">         */</span>
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a> != NULL &amp;&amp;
<a name="l00370"></a>00370             c-&gt;<a class="code" href="structiam__container.html#a33d58684b5bfc25a9e1498098435df96">ic_descr</a>-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a0a798507b68da74d81dc322ad1e228e6">id_root_ptr</a>(c) == ptr) {
<a name="l00371"></a>00371                 get_bh(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l00372"></a>00372                 *bh = c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>;
<a name="l00373"></a>00373                 <span class="keywordflow">return</span> 0;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         *bh = ldiskfs_bread(h, c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>, (<span class="keywordtype">int</span>)ptr, 0, &amp;result);
<a name="l00377"></a>00377         <span class="keywordflow">if</span> (*bh == NULL)
<a name="l00378"></a>00378                 result = result ? result : -EIO;
<a name="l00379"></a>00379         <span class="keywordflow">return</span> result;
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="comment">/*</span>
<a name="l00383"></a>00383 <span class="comment"> * Return pointer to current leaf record. Pointer is valid while corresponding</span>
<a name="l00384"></a>00384 <span class="comment"> * leaf node is locked and pinned.</span>
<a name="l00385"></a>00385 <span class="comment"> */</span>
<a name="l00386"></a><a class="code" href="osd__iam_8c.html#a9c0816ad24027b544a536c0412c20c94">00386</a> <span class="keyword">static</span> <span class="keyword">struct </span>iam_rec *<a class="code" href="osd__iam_8c.html#a9c0816ad24027b544a536c0412c20c94">iam_leaf_rec</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#ab2e80dc0fa19811d735e463b5f1b2fce">rec</a>(leaf);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">/*</span>
<a name="l00392"></a>00392 <span class="comment"> * Return pointer to the current leaf key. This function returns pointer to</span>
<a name="l00393"></a>00393 <span class="comment"> * the key stored in node.</span>
<a name="l00394"></a>00394 <span class="comment"> *</span>
<a name="l00395"></a>00395 <span class="comment"> * Caller should assume that returned pointer is only valid while leaf node is</span>
<a name="l00396"></a>00396 <span class="comment"> * pinned and locked.</span>
<a name="l00397"></a>00397 <span class="comment"> */</span>
<a name="l00398"></a><a class="code" href="osd__iam_8c.html#a77ed0022aa00e21b7f462d75a7dca2fc">00398</a> <span class="keyword">static</span> <span class="keyword">struct </span>iam_key *<a class="code" href="osd__iam_8c.html#a77ed0022aa00e21b7f462d75a7dca2fc">iam_leaf_key</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#af32553789d71ce222d45d488cae9d4be">key</a>(leaf);
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="osd__iam_8c.html#a511095348db7405ce6226aabb26dd907">00403</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a511095348db7405ce6226aabb26dd907">iam_leaf_key_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#ac58a89b13d8a828dbe98e622fdea96da">key_size</a>(leaf);
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a><a class="code" href="osd__iam_8c.html#ace3036486e409de1d4ccc8ea4eab24bd">00408</a> <span class="keyword">static</span> <span class="keyword">struct </span>iam_ikey *<a class="code" href="osd__iam_8c.html#ace3036486e409de1d4ccc8ea4eab24bd">iam_leaf_ikey</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf,
<a name="l00409"></a>00409                                       <span class="keyword">struct</span> iam_ikey *key)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#abfaf3b156c2bfb6f91ab4f8ffbff8db1">ikey</a>(leaf, key);
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="osd__iam_8c.html#a9186551d15b4aad58be021c0a91007e6">00414</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a9186551d15b4aad58be021c0a91007e6">iam_leaf_keycmp</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf,
<a name="l00415"></a>00415                            <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *key)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a4cd6d071e572aaeac0edd378c5c8d5aa">key_cmp</a>(leaf, key);
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a><a class="code" href="osd__iam_8c.html#abf4aa85f8f71183257914d1fd0765465">00420</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#abf4aa85f8f71183257914d1fd0765465">iam_leaf_keyeq</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf,
<a name="l00421"></a>00421                           <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *key)
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a720a54da8285a634c29fc71098bee9e3">key_eq</a>(leaf, key);
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="preprocessor">#if LDISKFS_INVARIANT_ON</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> iam_leaf_check(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf);
<a name="l00428"></a>00428 <span class="keyword">extern</span> <span class="keywordtype">int</span> dx_node_check(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *f);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 <span class="keyword">static</span> <span class="keywordtype">int</span> iam_path_check(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432         <span class="keywordtype">int</span> i;
<a name="l00433"></a>00433         <span class="keywordtype">int</span> result;
<a name="l00434"></a>00434         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *f;
<a name="l00435"></a>00435         <span class="keyword">struct </span><a class="code" href="structiam__descr.html">iam_descr</a> *param;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         result = 1;
<a name="l00438"></a>00438         param = <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(p);
<a name="l00439"></a>00439         <span class="keywordflow">for</span> (i = 0; result &amp;&amp; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(p-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>); ++i) {
<a name="l00440"></a>00440                 f = &amp;p-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i];
<a name="l00441"></a>00441                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> != NULL) {
<a name="l00442"></a>00442                         result = dx_node_check(p, f);
<a name="l00443"></a>00443                         <span class="keywordflow">if</span> (result)
<a name="l00444"></a>00444                                 result = !param-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a86f450c9e5abdf86c62b5a00c291328e">id_node_check</a>(p, f);
<a name="l00445"></a>00445                 }
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (result &amp;&amp; p-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>.<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a> != NULL)
<a name="l00448"></a>00448                 result = iam_leaf_check(&amp;p-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (result == 0) {
<a name="l00450"></a>00450                 ldiskfs_std_error(<a class="code" href="osd__iam_8h.html#a57e5447b6d363bd74838b2be2bc93fbd">iam_path_obj</a>(p)-&gt;i_sb, result);
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452         <span class="keywordflow">return</span> result;
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 <span class="preprocessor">#endif</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>
<a name="l00456"></a><a class="code" href="osd__iam_8c.html#a1ccff7f8e68c4ba567cdf24d297ea741">00456</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a1ccff7f8e68c4ba567cdf24d297ea741">iam_leaf_load</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458         <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> block;
<a name="l00459"></a>00459         <span class="keywordtype">int</span> err;
<a name="l00460"></a>00460         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c;
<a name="l00461"></a>00461         <span class="keyword">struct </span>buffer_head   *bh;
<a name="l00462"></a>00462         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a>      *leaf;
<a name="l00463"></a>00463         <span class="keyword">struct </span><a class="code" href="structiam__descr.html">iam_descr</a>     *descr;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         c     = path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l00466"></a>00466         leaf  = &amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l00467"></a>00467         descr = <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(path);
<a name="l00468"></a>00468         block = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>;
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (block == 0) {
<a name="l00470"></a>00470                 <span class="comment">/* XXX bug 11027 */</span>
<a name="l00471"></a>00471                 <a class="code" href="libcfs__private_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(KERN_EMERG <span class="stringliteral">&quot;wrong leaf: %lu %d [%p %p %p]\n&quot;</span>,
<a name="l00472"></a>00472                        (<span class="keywordtype">long</span> <span class="keywordtype">unsigned</span>)path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>,
<a name="l00473"></a>00473                        <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(<a class="code" href="osd__iam_8h.html#a12323a0a6d5039c6e6009cd50e7cf30b">dx_node_get_entries</a>(path, path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>)),
<a name="l00474"></a>00474                        path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[0].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>, path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[1].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>,
<a name="l00475"></a>00475                        path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[2].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         err = descr-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a8fa746c20c4bf4272fc0a623d3a8f3a5">id_node_read</a>(c, block, NULL, &amp;bh);
<a name="l00478"></a>00478         <span class="keywordflow">if</span> (err == 0) {
<a name="l00479"></a>00479                 leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a> = bh;
<a name="l00480"></a>00480                 leaf-&gt;<a class="code" href="structiam__leaf.html#a20b301c424a61a717b272fb3d0db754a">il_curidx</a> = block;
<a name="l00481"></a>00481                 err = <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#ab2601acd132b42568835b96c2113b674">init</a>(leaf);
<a name="l00482"></a>00482                 <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(err == 0, iam_leaf_check(leaf)));
<a name="l00483"></a>00483         }
<a name="l00484"></a>00484         <span class="keywordflow">return</span> err;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">00487</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic,
<a name="l00488"></a>00488                              <span class="keyword">struct</span> <a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (lh != NULL)
<a name="l00491"></a>00491                 <a class="code" href="osd__dynlocks_8c.html#a4c1a438286a1900be14d5efc048ed99e">dynlock_unlock</a>(&amp;ic-&gt;<a class="code" href="structiam__container.html#a893d4066dc726fbf8876af868fe23e06">ic_tree_lock</a>, lh);
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 
<a name="l00495"></a><a class="code" href="osd__iam_8c.html#aab42a5cb61f756c1f6ab1bde5395d75c">00495</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#aab42a5cb61f756c1f6ab1bde5395d75c">iam_leaf_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a> != NULL) {
<a name="l00498"></a>00498                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(<a class="code" href="osd__iam_8h.html#a8b6a48a770a730de61b3fb43d8572999">iam_leaf_container</a>(leaf),
<a name="l00499"></a>00499                                  leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a>);
<a name="l00500"></a>00500                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00501"></a>00501                 leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a> = NULL;
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">00505</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">iam_leaf_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507         <span class="keywordflow">if</span> (leaf-&gt;<a class="code" href="structiam__leaf.html#a697c79bd22bbdbba1a763806ef593097">il_path</a> != NULL) {
<a name="l00508"></a>00508                 <a class="code" href="osd__iam_8c.html#aab42a5cb61f756c1f6ab1bde5395d75c">iam_leaf_unlock</a>(leaf);
<a name="l00509"></a>00509                 <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a> != NULL, iam_leaf_check(leaf)));
<a name="l00510"></a>00510                 <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a2781803bd2c1479142e584f3bd25b463">fini</a>(leaf);
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>) {
<a name="l00512"></a>00512                         brelse(leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l00513"></a>00513                         leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a> = NULL;
<a name="l00514"></a>00514                         leaf-&gt;<a class="code" href="structiam__leaf.html#a20b301c424a61a717b272fb3d0db754a">il_curidx</a> = 0;
<a name="l00515"></a>00515                 }
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="osd__iam_8c.html#ad3d587f934d95c3db47b0a148775117b">00519</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#ad3d587f934d95c3db47b0a148775117b">iam_leaf_start</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *folio)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(folio)-&gt;<a class="code" href="structiam__leaf__operations.html#a54e03fe4fdacde29c5c463766ee74d7e">start</a>(folio);
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="osd__iam_8h.html#aa07d654d1db24cbe74f7927a44e6871f">00524</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#aa07d654d1db24cbe74f7927a44e6871f">iam_leaf_next</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *folio)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(folio)-&gt;<a class="code" href="structiam__leaf__operations.html#a2df24964f174f41bcbfeea94ebac48d0">next</a>(folio);
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="osd__iam_8c.html#ac2a300ed0c4cbe1cae9617b64f8ba8ba">00529</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#ac2a300ed0c4cbe1cae9617b64f8ba8ba">iam_leaf_rec_add</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *key,
<a name="l00530"></a>00530                              <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *rec)
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a0da0d29815971767a3a6c41d4c9d0b75">rec_add</a>(leaf, key, rec);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="osd__iam_8c.html#a45c343d2d4c7f9fe178a2c6a8dfe69a7">00535</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a45c343d2d4c7f9fe178a2c6a8dfe69a7">iam_rec_del</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf, <span class="keywordtype">int</span> shift)
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a04d0e687484c445c819a3836389d2d2d">rec_del</a>(leaf, shift);
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="osd__iam_8h.html#a477a6e777a1ed74b6023323711805a29">00540</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#a23d6dc37b39e94572a897294db308ad4">at_end</a>(leaf);
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="osd__iam_8c.html#aef95469d7f0dfbbdd0069123cca1e8c2">00545</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#aef95469d7f0dfbbdd0069123cca1e8c2">iam_leaf_split</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *l, <span class="keyword">struct</span> buffer_head **bh,
<a name="l00546"></a>00546                            <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> nr)
<a name="l00547"></a>00547 {
<a name="l00548"></a>00548         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(l)-&gt;<a class="code" href="structiam__leaf__operations.html#a0fc8c4d610cffb9ee5584c2e86175591">split</a>(l, bh, nr);
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a><a class="code" href="osd__iam_8c.html#af8e663c168a5c2c93be7ecb57f4e36db">00551</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#af8e663c168a5c2c93be7ecb57f4e36db">iam_leaf_empty</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *l)
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(l)-&gt;<a class="code" href="structiam__leaf__operations.html#acd68dfee744ae4dfa789f12422a9878a">leaf_empty</a>(l);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="osd__iam_8h.html#ad7afba510c9c0bb887dcaaac236ecf84">00556</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ad7afba510c9c0bb887dcaaac236ecf84">iam_leaf_can_add</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *l,
<a name="l00557"></a>00557                      <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k, <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(l)-&gt;<a class="code" href="structiam__leaf__operations.html#a7509addbc65a5a908ef331fc14f1e533">can_add</a>(l, k, r);
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="preprocessor">#if LDISKFS_INVARIANT_ON</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> iam_leaf_check(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565         <span class="keywordflow">return</span> 1;
<a name="l00566"></a>00566 <span class="preprocessor">#if 0</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span>        <span class="keyword">struct </span>iam_lentry    *orig;
<a name="l00568"></a>00568         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a>      *<a class="code" href="mdsrate_8c.html#ae8592c5c8f37a4598973aaa27f45dc4c">path</a>;
<a name="l00569"></a>00569         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *bag;
<a name="l00570"></a>00570         <span class="keyword">struct </span>iam_ikey       *k0;
<a name="l00571"></a>00571         <span class="keyword">struct </span>iam_ikey       *k1;
<a name="l00572"></a>00572         <span class="keywordtype">int</span> result;
<a name="l00573"></a>00573         <span class="keywordtype">int</span> first;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         orig = leaf-&gt;<a class="code" href="structiam__leaf.html#a9055f5821f70035d127abb1e4749d382">il_at</a>;
<a name="l00576"></a>00576         path = <a class="code" href="osd__iam_8h.html#af83ed0325a1a41254627530e40e925fb">iam_leaf_path</a>(leaf);
<a name="l00577"></a>00577         bag  = <a class="code" href="osd__iam_8h.html#a8b6a48a770a730de61b3fb43d8572999">iam_leaf_container</a>(leaf);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579         result = <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#ab2601acd132b42568835b96c2113b674">init</a>(leaf);
<a name="l00580"></a>00580         <span class="keywordflow">if</span> (result != 0)
<a name="l00581"></a>00581                 <span class="keywordflow">return</span> result;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         first = 1;
<a name="l00584"></a>00584         <a class="code" href="osd__iam_8c.html#ad3d587f934d95c3db47b0a148775117b">iam_leaf_start</a>(leaf);
<a name="l00585"></a>00585         k0 = <a class="code" href="osd__iam_8h.html#a95b1cb172d15f6e864bcfe03fd18da5f">iam_path_ikey</a>(path, 0);
<a name="l00586"></a>00586         k1 = <a class="code" href="osd__iam_8h.html#a95b1cb172d15f6e864bcfe03fd18da5f">iam_path_ikey</a>(path, 1);
<a name="l00587"></a>00587         <span class="keywordflow">while</span> (!<a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(leaf)) {
<a name="l00588"></a>00588                 <a class="code" href="osd__iam_8h.html#aaf3987795c8f268314cc993025cde088">iam_ikeycpy</a>(bag, k0, k1);
<a name="l00589"></a>00589                 <a class="code" href="osd__iam_8h.html#aaf3987795c8f268314cc993025cde088">iam_ikeycpy</a>(bag, k1, <a class="code" href="osd__iam_8c.html#ace3036486e409de1d4ccc8ea4eab24bd">iam_leaf_ikey</a>(leaf, k1));
<a name="l00590"></a>00590                 <span class="keywordflow">if</span> (!first &amp;&amp; <a class="code" href="osd__iam_8h.html#a70ee8bb7b36e9ee53a5b5b05ef5f0c67">iam_ikeycmp</a>(bag, k0, k1) &gt; 0) {
<a name="l00591"></a>00591                         <span class="keywordflow">return</span> 0;
<a name="l00592"></a>00592                 }
<a name="l00593"></a>00593                 first = 0;
<a name="l00594"></a>00594                 <a class="code" href="osd__iam_8c.html#aa07d654d1db24cbe74f7927a44e6871f">iam_leaf_next</a>(leaf);
<a name="l00595"></a>00595         }
<a name="l00596"></a>00596         leaf-&gt;<a class="code" href="structiam__leaf.html#a9055f5821f70035d127abb1e4749d382">il_at</a> = orig;
<a name="l00597"></a>00597         <span class="keywordflow">return</span> 1;
<a name="l00598"></a>00598 <span class="preprocessor">#endif</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span>}
<a name="l00600"></a>00600 <span class="preprocessor">#endif</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>
<a name="l00602"></a><a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">00602</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(handle_t *handle,
<a name="l00603"></a>00603                          <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> buffer_head *bh)
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605         <span class="keywordtype">int</span> result;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         result = ldiskfs_handle_dirty_metadata(handle, NULL, bh);
<a name="l00608"></a>00608         <span class="keywordflow">if</span> (result != 0)
<a name="l00609"></a>00609                 ldiskfs_std_error(<a class="code" href="osd__iam_8h.html#a57e5447b6d363bd74838b2be2bc93fbd">iam_path_obj</a>(path)-&gt;i_sb, result);
<a name="l00610"></a>00610         <span class="keywordflow">return</span> result;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">00613</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(handle_t *handle,
<a name="l00614"></a>00614                        <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> buffer_head *bh)
<a name="l00615"></a>00615 {
<a name="l00616"></a>00616         <span class="keywordtype">int</span> result;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         result = ldiskfs_journal_get_write_access(handle, bh);
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (result != 0)
<a name="l00620"></a>00620                 ldiskfs_std_error(<a class="code" href="osd__iam_8h.html#a57e5447b6d363bd74838b2be2bc93fbd">iam_path_obj</a>(path)-&gt;i_sb, result);
<a name="l00621"></a>00621         <span class="keywordflow">return</span> result;
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">/***********************************************************************/</span>
<a name="l00625"></a>00625 <span class="comment">/* iterator interface                                                  */</span>
<a name="l00626"></a>00626 <span class="comment">/***********************************************************************/</span>
<a name="l00627"></a>00627 
<a name="l00628"></a><a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">00628</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104">iam_it_state</a> <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l00629"></a>00629 {
<a name="l00630"></a>00630         <span class="keywordflow">return</span> it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a>;
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">/*</span>
<a name="l00634"></a>00634 <span class="comment"> * Helper function returning scratch key.</span>
<a name="l00635"></a>00635 <span class="comment"> */</span>
<a name="l00636"></a><a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">00636</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638         <span class="keywordflow">return</span> it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a><a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">00641</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l00642"></a>00642                             <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k)
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a9186551d15b4aad58be021c0a91007e6">iam_leaf_keycmp</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>, k);
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="osd__iam_8c.html#ac24f06cf66e6e46b18098b0ff6a25f99">00647</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ac24f06cf66e6e46b18098b0ff6a25f99">it_keyeq</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l00648"></a>00648                            <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#abf4aa85f8f71183257914d1fd0765465">iam_leaf_keyeq</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>, k);
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="osd__iam_8c.html#a35d26d9a4cd5902367e5276831096234">00653</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a35d26d9a4cd5902367e5276831096234">it_ikeycmp</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_ikey *ik)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#a70ee8bb7b36e9ee53a5b5b05ef5f0c67">iam_ikeycmp</a>(it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>,
<a name="l00656"></a>00656                            <a class="code" href="osd__iam_8c.html#ace3036486e409de1d4ccc8ea4eab24bd">iam_leaf_ikey</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>,
<a name="l00657"></a>00657                                          <a class="code" href="osd__iam_8h.html#a95b1cb172d15f6e864bcfe03fd18da5f">iam_path_ikey</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>, 0)), ik);
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a><a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">00660</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662         <span class="keywordflow">return</span> !<a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a><a class="code" href="osd__iam_8c.html#ab3199edf371c72e25185abf229c278ac">00665</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ab3199edf371c72e25185abf229c278ac">it_before</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a> &amp;&amp; <a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it);
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 <span class="comment">/*</span>
<a name="l00671"></a>00671 <span class="comment"> * Helper wrapper around iam_it_get(): returns 0 (success) only when record</span>
<a name="l00672"></a>00672 <span class="comment"> * with exactly the same key as asked is found.</span>
<a name="l00673"></a>00673 <span class="comment"> */</span>
<a name="l00674"></a><a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">00674</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676         <span class="keywordtype">int</span> result;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         result = <a class="code" href="osd__iam_8c.html#a3f2bbe9d9c399db684093ba91265617b">iam_it_get</a>(it, k);
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (result &gt; 0)
<a name="l00680"></a>00680                 result = 0;
<a name="l00681"></a>00681         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == 0)
<a name="l00682"></a>00682                 <span class="comment">/*</span>
<a name="l00683"></a>00683 <span class="comment">                 * Return -ENOENT if cursor is located above record with a key</span>
<a name="l00684"></a>00684 <span class="comment">                 * different from one specified, or in the empty leaf.</span>
<a name="l00685"></a>00685 <span class="comment">                 *</span>
<a name="l00686"></a>00686 <span class="comment">                 * XXX returning -ENOENT only works if iam_it_get() never</span>
<a name="l00687"></a>00687 <span class="comment">                 * returns -ENOENT as a legitimate error.</span>
<a name="l00688"></a>00688 <span class="comment">                 */</span>
<a name="l00689"></a>00689                 result = -ENOENT;
<a name="l00690"></a>00690         <span class="keywordflow">return</span> result;
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="osd__iam_8h.html#a43d5d1d8b0474dc9683eb071effd8e3f">00693</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a3aa536f1a9988d415b9d29561fcbbdf1">iam_container_write_lock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695         down_write(&amp;ic-&gt;<a class="code" href="structiam__container.html#a775b3664ec7ee0c1b31b35cd5e50fa4b">ic_sem</a>);
<a name="l00696"></a>00696 }
<a name="l00697"></a>00697 
<a name="l00698"></a><a class="code" href="osd__iam_8h.html#aaf3ad125e570437ebcba8ec97af5040a">00698</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a008f05ee9ff061d732e66e40f02cc4ac">iam_container_write_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700         up_write(&amp;ic-&gt;<a class="code" href="structiam__container.html#a775b3664ec7ee0c1b31b35cd5e50fa4b">ic_sem</a>);
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a><a class="code" href="osd__iam_8h.html#aa920b597f090736287fe40e9608e89d9">00703</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a9600bc3b002cd9f8f2583f16a2767017">iam_container_read_lock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705         down_read(&amp;ic-&gt;<a class="code" href="structiam__container.html#a775b3664ec7ee0c1b31b35cd5e50fa4b">ic_sem</a>);
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="osd__iam_8h.html#a71f61a60c8c030d441fa8739512ca92c">00708</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a103e938d7ad8d51964122a4e26e84c1f">iam_container_read_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710         up_read(&amp;ic-&gt;<a class="code" href="structiam__container.html#a775b3664ec7ee0c1b31b35cd5e50fa4b">ic_sem</a>);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="comment">/*</span>
<a name="l00714"></a>00714 <span class="comment"> * Initialize iterator to IAM_IT_DETACHED state.</span>
<a name="l00715"></a>00715 <span class="comment"> *</span>
<a name="l00716"></a>00716 <span class="comment"> * postcondition: it_state(it) == IAM_IT_DETACHED</span>
<a name="l00717"></a>00717 <span class="comment"> */</span>
<a name="l00718"></a><a class="code" href="osd__iam_8h.html#ae765e676c41bce576bd10e7c315776bf">00718</a> <span class="keywordtype">int</span>  <a class="code" href="osd__iam_8c.html#ae765e676c41bce576bd10e7c315776bf">iam_it_init</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, __u32 flags,
<a name="l00719"></a>00719                  <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721         memset(it, 0, <span class="keyword">sizeof</span> *it);
<a name="l00722"></a>00722         it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>  = flags;
<a name="l00723"></a>00723         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a>  = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>;
<a name="l00724"></a>00724         <a class="code" href="osd__iam_8c.html#ae6a4c983524c4c07e1cf209cb56a60dc">iam_path_init</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>, c, pd);
<a name="l00725"></a>00725         <span class="keywordflow">return</span> 0;
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 <span class="comment">/*</span>
<a name="l00729"></a>00729 <span class="comment"> * Finalize iterator and release all resources.</span>
<a name="l00730"></a>00730 <span class="comment"> *</span>
<a name="l00731"></a>00731 <span class="comment"> * precondition: it_state(it) == IAM_IT_DETACHED</span>
<a name="l00732"></a>00732 <span class="comment"> */</span>
<a name="l00733"></a><a class="code" href="osd__iam_8h.html#ad11528ab34a5b9d19a2c5dec3ea25e15">00733</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>);
<a name="l00736"></a>00736         <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>);
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="comment">/*</span>
<a name="l00740"></a>00740 <span class="comment"> * this locking primitives are used to protect parts</span>
<a name="l00741"></a>00741 <span class="comment"> * of dir&apos;s htree. protection unit is block: leaf or index</span>
<a name="l00742"></a>00742 <span class="comment"> */</span>
<a name="l00743"></a><a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">00743</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *<a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic,
<a name="l00744"></a>00744                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value,
<a name="l00745"></a>00745                                              <span class="keyword">enum</span> <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8">dynlock_type</a> lt)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747         <span class="keywordflow">return</span> <a class="code" href="osd__dynlocks_8c.html#aac0b9926ce2522deec3a4129fc79c150">dynlock_lock</a>(&amp;ic-&gt;<a class="code" href="structiam__container.html#a893d4066dc726fbf8876af868fe23e06">ic_tree_lock</a>, value, lt, GFP_NOFS);
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="osd__iam_8c.html#a41ca0ef0c8d67fc23f0e0f15dc3161bd">00750</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a41ca0ef0c8d67fc23f0e0f15dc3161bd">iam_index_lock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structdynlock__handle.html">dynlock_handle</a> **lh)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *f;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="keywordflow">for</span> (f = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>; f &gt;= path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>; --f, ++lh) {
<a name="l00755"></a>00755                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00756"></a>00756                 *lh = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, f-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a>, <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8a44e58598ac5d93a19f6b54faeddf1296">DLT_READ</a>);
<a name="l00757"></a>00757                 <span class="keywordflow">if</span> (*lh == NULL)
<a name="l00758"></a>00758                         <span class="keywordflow">return</span> -ENOMEM;
<a name="l00759"></a>00759         }
<a name="l00760"></a>00760         <span class="keywordflow">return</span> 0;
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="comment">/*</span>
<a name="l00764"></a>00764 <span class="comment"> * Fast check for frame consistency.</span>
<a name="l00765"></a>00765 <span class="comment"> */</span>
<a name="l00766"></a><a class="code" href="osd__iam_8c.html#a3081a81bfea2f3a37747d314092584c0">00766</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a3081a81bfea2f3a37747d314092584c0">iam_check_fast</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *bag;
<a name="l00769"></a>00769         <span class="keyword">struct </span>iam_entry *next;
<a name="l00770"></a>00770         <span class="keyword">struct </span>iam_entry *last;
<a name="l00771"></a>00771         <span class="keyword">struct </span>iam_entry *entries;
<a name="l00772"></a>00772         <span class="keyword">struct </span>iam_entry *at;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774         bag     = path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l00775"></a>00775         at      = frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>;
<a name="l00776"></a>00776         entries = frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>;
<a name="l00777"></a>00777         last    = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries, <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(entries) - 1);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(at &gt; last))
<a name="l00780"></a>00780                 <span class="keywordflow">return</span> -EAGAIN;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, at) != frame-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>))
<a name="l00783"></a>00783                 <span class="keywordflow">return</span> -EAGAIN;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a class="code" href="osd__iam_8h.html#a70ee8bb7b36e9ee53a5b5b05ef5f0c67">iam_ikeycmp</a>(bag, <a class="code" href="osd__iam_8h.html#ae505ffd16df2b5844c5a5129f76a327a">iam_ikey_at</a>(path, at),
<a name="l00786"></a>00786                                  path-&gt;<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a>) &gt; 0))
<a name="l00787"></a>00787                 <span class="keywordflow">return</span> -EAGAIN;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         next = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, at, +1);
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (next &lt;= last) {
<a name="l00791"></a>00791                 <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a class="code" href="osd__iam_8h.html#a70ee8bb7b36e9ee53a5b5b05ef5f0c67">iam_ikeycmp</a>(bag, <a class="code" href="osd__iam_8h.html#ae505ffd16df2b5844c5a5129f76a327a">iam_ikey_at</a>(path, next),
<a name="l00792"></a>00792                                          path-&gt;<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a>) &lt;= 0))
<a name="l00793"></a>00793                         <span class="keywordflow">return</span> -EAGAIN;
<a name="l00794"></a>00794         }
<a name="l00795"></a>00795         <span class="keywordflow">return</span> 0;
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a><a class="code" href="osd__iam_8h.html#a391fdf43e3f6cb912b7765a5b5fbe4aa">00798</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a391fdf43e3f6cb912b7765a5b5fbe4aa">dx_index_is_compat</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path)
<a name="l00799"></a>00799 {
<a name="l00800"></a>00800         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(path) == NULL;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="comment">/*</span>
<a name="l00804"></a>00804 <span class="comment"> * dx_find_position</span>
<a name="l00805"></a>00805 <span class="comment"> *</span>
<a name="l00806"></a>00806 <span class="comment"> * search position of specified hash in index</span>
<a name="l00807"></a>00807 <span class="comment"> *</span>
<a name="l00808"></a>00808 <span class="comment"> */</span>
<a name="l00809"></a>00809 
<a name="l00810"></a><a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">00810</a> <span class="keyword">static</span> <span class="keyword">struct </span>iam_entry *<a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">iam_find_position</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path,
<a name="l00811"></a>00811                                            <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813         <span class="keywordtype">int</span> count;
<a name="l00814"></a>00814         <span class="keyword">struct </span>iam_entry *p;
<a name="l00815"></a>00815         <span class="keyword">struct </span>iam_entry *q;
<a name="l00816"></a>00816         <span class="keyword">struct </span>iam_entry *m;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         count = <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>);
<a name="l00819"></a>00819         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(count &amp;&amp; count &lt;= <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>));
<a name="l00820"></a>00820         p = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>,
<a name="l00821"></a>00821                             <a class="code" href="osd__iam_8c.html#a391fdf43e3f6cb912b7765a5b5fbe4aa">dx_index_is_compat</a>(path) ? 1 : 2);
<a name="l00822"></a>00822         q = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>, count - 1);
<a name="l00823"></a>00823         <span class="keywordflow">while</span> (p &lt;= q) {
<a name="l00824"></a>00824                 m = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, p, <a class="code" href="osd__iam_8h.html#a9296bb2f812475a35b79e9835bd1d4d3">iam_entry_diff</a>(path, q, p) / 2);
<a name="l00825"></a>00825                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8h.html#a70ee8bb7b36e9ee53a5b5b05ef5f0c67">iam_ikeycmp</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, <a class="code" href="osd__iam_8h.html#ae505ffd16df2b5844c5a5129f76a327a">iam_ikey_at</a>(path, m),
<a name="l00826"></a>00826                                 path-&gt;<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a>) &gt; 0)
<a name="l00827"></a>00827                         q = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, m, -1);
<a name="l00828"></a>00828                 <span class="keywordflow">else</span>
<a name="l00829"></a>00829                         p = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, m, +1);
<a name="l00830"></a>00830         }
<a name="l00831"></a>00831         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, p, -1);
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 
<a name="l00836"></a><a class="code" href="osd__iam_8c.html#ade2b6af6adb6067e6eccadba550207f4">00836</a> <span class="keyword">static</span> <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> <a class="code" href="osd__iam_8c.html#ade2b6af6adb6067e6eccadba550207f4">iam_find_ptr</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame)
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, <a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">iam_find_position</a>(path, frame));
<a name="l00839"></a>00839 }
<a name="l00840"></a>00840 
<a name="l00841"></a><a class="code" href="osd__iam_8h.html#a1515c279fd8136cad5fd9f45e750a8fd">00841</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a1515c279fd8136cad5fd9f45e750a8fd">iam_insert_key</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame,
<a name="l00842"></a>00842                     <span class="keyword">const</span> <span class="keyword">struct</span> iam_ikey *key, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> ptr)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844         <span class="keyword">struct </span>iam_entry *entries = frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>;
<a name="l00845"></a>00845         <span class="keyword">struct </span>iam_entry *<span class="keyword">new</span> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, +1);
<a name="l00846"></a>00846         <span class="keywordtype">int</span> count = <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(entries);
<a name="l00847"></a>00847 
<a name="l00848"></a>00848         <span class="comment">/*</span>
<a name="l00849"></a>00849 <span class="comment">         * Unfortunately we cannot assert this, as this function is sometimes</span>
<a name="l00850"></a>00850 <span class="comment">         * called by VFS under i_sem and without pdirops lock.</span>
<a name="l00851"></a>00851 <span class="comment">         */</span>
<a name="l00852"></a>00852         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(1 || <a class="code" href="osd__iam_8h.html#a51cc0e1aa1126ed8897e130ac196f463">iam_frame_is_locked</a>(path, frame));
<a name="l00853"></a>00853         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(count &lt; <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(entries));
<a name="l00854"></a>00854         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> &lt; <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries, count));
<a name="l00855"></a>00855         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         memmove(<a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, <span class="keyword">new</span>, 1), <span class="keyword">new</span>,
<a name="l00858"></a>00858                 (<span class="keywordtype">char</span> *)<a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries, count) - (<span class="keywordtype">char</span> *)<span class="keyword">new</span>);
<a name="l00859"></a>00859         <a class="code" href="osd__iam_8h.html#a9868726857a8be286cff5d89e72bdebf">dx_set_ikey</a>(path, <span class="keyword">new</span>, key);
<a name="l00860"></a>00860         <a class="code" href="osd__iam_8h.html#afc3410f42cbf2ddf838a046e4ed2d502">dx_set_block</a>(path, <span class="keyword">new</span>, ptr);
<a name="l00861"></a>00861         <a class="code" href="osd__iam_8h.html#a5297cab8b16cd5d141e0c1846e15d1f8">dx_set_count</a>(entries, count + 1);
<a name="l00862"></a>00862         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l00863"></a>00863 }
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="osd__iam_8h.html#af168cf550bf6461681004a0d8278710b">00865</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#af168cf550bf6461681004a0d8278710b">iam_insert_key_lock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame,
<a name="l00866"></a>00866                          <span class="keyword">const</span> <span class="keyword">struct</span> iam_ikey *key, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> ptr)
<a name="l00867"></a>00867 {
<a name="l00868"></a>00868         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00869"></a>00869         <a class="code" href="osd__iam_8c.html#a1515c279fd8136cad5fd9f45e750a8fd">iam_insert_key</a>(path, frame, key, ptr);
<a name="l00870"></a>00870         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 <span class="comment">/*</span>
<a name="l00873"></a>00873 <span class="comment"> * returns 0 if path was unchanged, -EAGAIN otherwise.</span>
<a name="l00874"></a>00874 <span class="comment"> */</span>
<a name="l00875"></a><a class="code" href="osd__iam_8c.html#a32e85876a84b6e92ea585b018998e3d9">00875</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a32e85876a84b6e92ea585b018998e3d9">iam_check_path</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame)
<a name="l00876"></a>00876 {
<a name="l00877"></a>00877         <span class="keywordtype">int</span> equal;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00880"></a>00880         equal = <a class="code" href="osd__iam_8c.html#a3081a81bfea2f3a37747d314092584c0">iam_check_fast</a>(path, frame) == 0 ||
<a name="l00881"></a>00881                 frame-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> == <a class="code" href="osd__iam_8c.html#ade2b6af6adb6067e6eccadba550207f4">iam_find_ptr</a>(path, frame);
<a name="l00882"></a>00882         <a class="code" href="osd__iam_8h.html#a036ba6fcff3487f6839f8e0989e54d6b">DX_DEVAL</a>(iam_lock_stats.dls_bh_again += !equal);
<a name="l00883"></a>00883         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885         <span class="keywordflow">return</span> equal ? 0 : -EAGAIN;
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a><a class="code" href="osd__iam_8c.html#aca0dafd4b505e4b010becd27d41b5425">00888</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#aca0dafd4b505e4b010becd27d41b5425">iam_lookup_try</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890         u32 ptr;
<a name="l00891"></a>00891         <span class="keywordtype">int</span> err = 0;
<a name="l00892"></a>00892         <span class="keywordtype">int</span> i;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894         <span class="keyword">struct </span><a class="code" href="structiam__descr.html">iam_descr</a> *param;
<a name="l00895"></a>00895         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *frame;
<a name="l00896"></a>00896         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         param = <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(path);
<a name="l00899"></a>00899         c = path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901         ptr = param-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a0a798507b68da74d81dc322ad1e228e6">id_root_ptr</a>(c);
<a name="l00902"></a>00902         <span class="keywordflow">for</span> (frame = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>, i = 0; i &lt;= path-&gt;ip_indirect;
<a name="l00903"></a>00903              ++frame, ++i) {
<a name="l00904"></a>00904                 err = param-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a8fa746c20c4bf4272fc0a623d3a8f3a5">id_node_read</a>(c, (<a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a>)ptr, NULL,
<a name="l00905"></a>00905                                                   &amp;frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00906"></a>00906                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00907"></a>00907 
<a name="l00908"></a>00908                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00909"></a>00909                 <span class="comment">/*</span>
<a name="l00910"></a>00910 <span class="comment">                 * node must be initialized under bh lock because concurrent</span>
<a name="l00911"></a>00911 <span class="comment">                 * creation procedure may change it and iam_lookup_try() will</span>
<a name="l00912"></a>00912 <span class="comment">                 * see obsolete tree height. -bzzz</span>
<a name="l00913"></a>00913 <span class="comment">                 */</span>
<a name="l00914"></a>00914                 <span class="keywordflow">if</span> (err != 0)
<a name="l00915"></a>00915                         <span class="keywordflow">break</span>;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8h.html#a708316b6f6a85ecf42d4d9184ced7eec">LDISKFS_INVARIANT_ON</a>) {
<a name="l00918"></a>00918                         err = param-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a86f450c9e5abdf86c62b5a00c291328e">id_node_check</a>(path, frame);
<a name="l00919"></a>00919                         <span class="keywordflow">if</span> (err != 0)
<a name="l00920"></a>00920                                 <span class="keywordflow">break</span>;
<a name="l00921"></a>00921                 }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923                 err = param-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a16e9f44c41c7fcfb25f9d1723032ded6">id_node_load</a>(path, frame);
<a name="l00924"></a>00924                 <span class="keywordflow">if</span> (err != 0)
<a name="l00925"></a>00925                         <span class="keywordflow">break</span>;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927                 <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l00928"></a>00928                 <span class="comment">/*</span>
<a name="l00929"></a>00929 <span class="comment">                 * splitting may change root index block and move hash we&apos;re</span>
<a name="l00930"></a>00930 <span class="comment">                 * looking for into another index block so, we have to check</span>
<a name="l00931"></a>00931 <span class="comment">                 * this situation and repeat from begining if path got changed</span>
<a name="l00932"></a>00932 <span class="comment">                 * -bzzz</span>
<a name="l00933"></a>00933 <span class="comment">                 */</span>
<a name="l00934"></a>00934                 <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l00935"></a>00935                         err = <a class="code" href="osd__iam_8c.html#a32e85876a84b6e92ea585b018998e3d9">iam_check_path</a>(path, frame - 1);
<a name="l00936"></a>00936                         <span class="keywordflow">if</span> (err != 0)
<a name="l00937"></a>00937                                 <span class="keywordflow">break</span>;
<a name="l00938"></a>00938                 }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940                 frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">iam_find_position</a>(path, frame);
<a name="l00941"></a>00941                 frame-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a> = ptr;
<a name="l00942"></a>00942                 frame-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> = ptr = <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00945"></a>00945                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947         <span class="keywordflow">if</span> (err != 0)
<a name="l00948"></a>00948                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00949"></a>00949         path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a> = --frame;
<a name="l00950"></a>00950         <span class="keywordflow">return</span> err;
<a name="l00951"></a>00951 }
<a name="l00952"></a>00952 
<a name="l00953"></a><a class="code" href="osd__iam_8c.html#af206b7bb35c205113cf5dda417f3b1e3">00953</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#af206b7bb35c205113cf5dda417f3b1e3">__iam_path_lookup</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955         <span class="keywordtype">int</span> err;
<a name="l00956"></a>00956         <span class="keywordtype">int</span> i;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>; ++ i)
<a name="l00959"></a>00959                 <a class="code" href="osd__iam_8h.html#ac88d9686b15e03eb62e2a66109845f86">assert</a>(path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> == NULL);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="keywordflow">do</span> {
<a name="l00962"></a>00962                 err = <a class="code" href="osd__iam_8c.html#aca0dafd4b505e4b010becd27d41b5425">iam_lookup_try</a>(path);
<a name="l00963"></a>00963                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00964"></a>00964                 <span class="keywordflow">if</span> (err != 0)
<a name="l00965"></a>00965                         <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(path);
<a name="l00966"></a>00966         } <span class="keywordflow">while</span> (err == -EAGAIN);
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <span class="keywordflow">return</span> err;
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 <span class="comment">/*</span>
<a name="l00972"></a>00972 <span class="comment"> * returns 0 if path was unchanged, -EAGAIN otherwise.</span>
<a name="l00973"></a>00973 <span class="comment"> */</span>
<a name="l00974"></a><a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">00974</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keywordtype">int</span> search)
<a name="l00975"></a>00975 {
<a name="l00976"></a>00976         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *bottom;
<a name="l00977"></a>00977         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *scan;
<a name="l00978"></a>00978         <span class="keywordtype">int</span> i;
<a name="l00979"></a>00979         <span class="keywordtype">int</span> result;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l00982"></a>00982 
<a name="l00983"></a>00983         <span class="keywordflow">for</span> (bottom = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>, i = 0;
<a name="l00984"></a>00984              i &lt; DX_MAX_TREE_HEIGHT &amp;&amp; bottom-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> != NULL; ++bottom, ++i) {
<a name="l00985"></a>00985                 ; <span class="comment">/* find last filled in frame */</span>
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="comment">/*</span>
<a name="l00989"></a>00989 <span class="comment">         * Lock frames, bottom to top.</span>
<a name="l00990"></a>00990 <span class="comment">         */</span>
<a name="l00991"></a>00991         <span class="keywordflow">for</span> (scan = bottom - 1; scan &gt;= path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>; --scan)
<a name="l00992"></a>00992                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(scan-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l00993"></a>00993         <span class="comment">/*</span>
<a name="l00994"></a>00994 <span class="comment">         * Check them top to bottom.</span>
<a name="l00995"></a>00995 <span class="comment">         */</span>
<a name="l00996"></a>00996         result = 0;
<a name="l00997"></a>00997         <span class="keywordflow">for</span> (scan = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>; scan &lt; bottom; ++scan) {
<a name="l00998"></a>00998                 <span class="keyword">struct </span>iam_entry *pos;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000                 <span class="keywordflow">if</span> (search) {
<a name="l01001"></a>01001                         <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#a3081a81bfea2f3a37747d314092584c0">iam_check_fast</a>(path, scan) == 0)
<a name="l01002"></a>01002                                 <span class="keywordflow">continue</span>;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004                         pos = <a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">iam_find_position</a>(path, scan);
<a name="l01005"></a>01005                         <span class="keywordflow">if</span> (scan-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> != <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, pos)) {
<a name="l01006"></a>01006                                 result = -EAGAIN;
<a name="l01007"></a>01007                                 <span class="keywordflow">break</span>;
<a name="l01008"></a>01008                         }
<a name="l01009"></a>01009                         scan-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = pos;
<a name="l01010"></a>01010                 } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011                         pos = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, scan-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>,
<a name="l01012"></a>01012                                               <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(scan-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>) - 1);
<a name="l01013"></a>01013                         <span class="keywordflow">if</span> (scan-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> &gt; pos ||
<a name="l01014"></a>01014                             scan-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> != <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, scan-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>)) {
<a name="l01015"></a>01015                                 result = -EAGAIN;
<a name="l01016"></a>01016                                 <span class="keywordflow">break</span>;
<a name="l01017"></a>01017                         }
<a name="l01018"></a>01018                 }
<a name="l01019"></a>01019         }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         <span class="comment">/*</span>
<a name="l01022"></a>01022 <span class="comment">         * Unlock top to bottom.</span>
<a name="l01023"></a>01023 <span class="comment">         */</span>
<a name="l01024"></a>01024         <span class="keywordflow">for</span> (scan = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>; scan &lt; bottom; ++scan)
<a name="l01025"></a>01025                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(scan-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01026"></a>01026         <a class="code" href="osd__iam_8h.html#a036ba6fcff3487f6839f8e0989e54d6b">DX_DEVAL</a>(iam_lock_stats.dls_bh_full_again += !!result);
<a name="l01027"></a>01027         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="keywordflow">return</span> result;
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 <span class="comment">/*</span>
<a name="l01034"></a>01034 <span class="comment"> * Performs path lookup and returns with found leaf (if any) locked by htree</span>
<a name="l01035"></a>01035 <span class="comment"> * lock.</span>
<a name="l01036"></a>01036 <span class="comment"> */</span>
<a name="l01037"></a><a class="code" href="osd__iam_8c.html#a6b9c741f0315ee77b7e5170340f2f2f7">01037</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a6b9c741f0315ee77b7e5170340f2f2f7">iam_lookup_lock</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path,
<a name="l01038"></a>01038                            <span class="keyword">struct</span> <a class="code" href="structdynlock__handle.html">dynlock_handle</a> **dl, <span class="keyword">enum</span> <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8">dynlock_type</a> lt)
<a name="l01039"></a>01039 {
<a name="l01040"></a>01040         <span class="keywordtype">int</span> result;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="keywordflow">while</span> ((result = <a class="code" href="osd__iam_8c.html#af206b7bb35c205113cf5dda417f3b1e3">__iam_path_lookup</a>(path)) == 0) {
<a name="l01043"></a>01043                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01044"></a>01044                 *dl = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>,
<a name="l01045"></a>01045                                      lt);
<a name="l01046"></a>01046                 <span class="keywordflow">if</span> (*dl == NULL) {
<a name="l01047"></a>01047                         <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(path);
<a name="l01048"></a>01048                         result = -ENOMEM;
<a name="l01049"></a>01049                         <span class="keywordflow">break</span>;
<a name="l01050"></a>01050                 }
<a name="l01051"></a>01051                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01052"></a>01052                 <span class="comment">/*</span>
<a name="l01053"></a>01053 <span class="comment">                 * while locking leaf we just found may get split so we need</span>
<a name="l01054"></a>01054 <span class="comment">                 * to check this -bzzz</span>
<a name="l01055"></a>01055 <span class="comment">                 */</span>
<a name="l01056"></a>01056                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(path, 1) == 0)
<a name="l01057"></a>01057                         <span class="keywordflow">break</span>;
<a name="l01058"></a>01058                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, *dl);
<a name="l01059"></a>01059                 *dl = NULL;
<a name="l01060"></a>01060                 <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(path);
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062         <span class="keywordflow">return</span> result;
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 <span class="comment">/*</span>
<a name="l01065"></a>01065 <span class="comment"> * Performs tree top-to-bottom traversal starting from root, and loads leaf</span>
<a name="l01066"></a>01066 <span class="comment"> * node.</span>
<a name="l01067"></a>01067 <span class="comment"> */</span>
<a name="l01068"></a><a class="code" href="osd__iam_8c.html#a896ecc5dff1516f6e3f9881bd41cc894">01068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a896ecc5dff1516f6e3f9881bd41cc894">iam_path_lookup</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, <span class="keywordtype">int</span> index)
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c;
<a name="l01071"></a>01071         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a>  *leaf;
<a name="l01072"></a>01072         <span class="keywordtype">int</span> result;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         c = path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l01075"></a>01075         leaf = &amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l01076"></a>01076         result = <a class="code" href="osd__iam_8c.html#a6b9c741f0315ee77b7e5170340f2f2f7">iam_lookup_lock</a>(path, &amp;leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a>, <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l01077"></a>01077         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l01078"></a>01078         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (result == 0) {
<a name="l01080"></a>01080                 result = <a class="code" href="osd__iam_8c.html#a1ccff7f8e68c4ba567cdf24d297ea741">iam_leaf_load</a>(path);
<a name="l01081"></a>01081                 <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result == 0, iam_leaf_check(leaf)));
<a name="l01082"></a>01082                 <span class="keywordflow">if</span> (result == 0) {
<a name="l01083"></a>01083                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01084"></a>01084                         <span class="keywordflow">if</span> (index)
<a name="l01085"></a>01085                                 result = <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;
<a name="l01086"></a>01086                                         ilookup(leaf, path-&gt;<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a>);
<a name="l01087"></a>01087                         <span class="keywordflow">else</span>
<a name="l01088"></a>01088                                 result = <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;
<a name="l01089"></a>01089                                         <a class="code" href="iam__ut_8c.html#a8a036fe43302ce2891c4f2854f4c44e8">lookup</a>(leaf, path-&gt;<a class="code" href="structiam__path.html#a7ce7e0d54e6907597e8f841b2c233ec3">ip_key_target</a>);
<a name="l01090"></a>01090                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01091"></a>01091                 }
<a name="l01092"></a>01092                 <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01093"></a>01093                         <a class="code" href="osd__iam_8c.html#aab42a5cb61f756c1f6ab1bde5395d75c">iam_leaf_unlock</a>(leaf);
<a name="l01094"></a>01094         }
<a name="l01095"></a>01095         <span class="keywordflow">return</span> result;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 <span class="comment">/*</span>
<a name="l01099"></a>01099 <span class="comment"> * Common part of iam_it_{i,}get().</span>
<a name="l01100"></a>01100 <span class="comment"> */</span>
<a name="l01101"></a><a class="code" href="osd__iam_8c.html#ad05c6e285b565160498f04ed1845036a">01101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ad05c6e285b565160498f04ed1845036a">__iam_it_get</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keywordtype">int</span> index)
<a name="l01102"></a>01102 {
<a name="l01103"></a>01103         <span class="keywordtype">int</span> result;
<a name="l01104"></a>01104         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         result = <a class="code" href="osd__iam_8c.html#a896ecc5dff1516f6e3f9881bd41cc894">iam_path_lookup</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>, index);
<a name="l01107"></a>01107         <span class="keywordflow">if</span> (result &gt;= 0) {
<a name="l01108"></a>01108                 <span class="keywordtype">int</span> collision;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 collision = result &amp; <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea2abe825f79095f9cdf28c99397e51104">IAM_LOOKUP_LAST</a>;
<a name="l01111"></a>01111                 <span class="keywordflow">switch</span> (result &amp; ~IAM_LOOKUP_LAST) {
<a name="l01112"></a>01112                 <span class="keywordflow">case</span> <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525feacdf919bec38e7dbd242be3e5cc407cd4">IAM_LOOKUP_EXACT</a>:
<a name="l01113"></a>01113                         result = +1;
<a name="l01114"></a>01114                         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>;
<a name="l01115"></a>01115                         <span class="keywordflow">break</span>;
<a name="l01116"></a>01116                 <span class="keywordflow">case</span> <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525feaa4c243de71cea0244c7aa5ab245f2e9d">IAM_LOOKUP_OK</a>:
<a name="l01117"></a>01117                         result = 0;
<a name="l01118"></a>01118                         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>;
<a name="l01119"></a>01119                         <span class="keywordflow">break</span>;
<a name="l01120"></a>01120                 <span class="keywordflow">case</span> <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea99f667a3b12ef2b90d05be697c6b70fc">IAM_LOOKUP_BEFORE</a>:
<a name="l01121"></a>01121                 <span class="keywordflow">case</span> <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea5b1e0d39a718453863a1e05622384a16">IAM_LOOKUP_EMPTY</a>:
<a name="l01122"></a>01122                         result = 0;
<a name="l01123"></a>01123                         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>;
<a name="l01124"></a>01124                         <span class="keywordflow">break</span>;
<a name="l01125"></a>01125                 <span class="keywordflow">default</span>:
<a name="l01126"></a>01126                         <a class="code" href="osd__iam_8h.html#ac88d9686b15e03eb62e2a66109845f86">assert</a>(0);
<a name="l01127"></a>01127                 }
<a name="l01128"></a>01128                 result |= collision;
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130         <span class="comment">/*</span>
<a name="l01131"></a>01131 <span class="comment">         * See iam_it_get_exact() for explanation.</span>
<a name="l01132"></a>01132 <span class="comment">         */</span>
<a name="l01133"></a>01133         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(result != -ENOENT);
<a name="l01134"></a>01134         <span class="keywordflow">return</span> result;
<a name="l01135"></a>01135 }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137 <span class="comment">/*</span>
<a name="l01138"></a>01138 <span class="comment"> * Correct hash, but not the same key was found, iterate through hash</span>
<a name="l01139"></a>01139 <span class="comment"> * collision chain, looking for correct record.</span>
<a name="l01140"></a>01140 <span class="comment"> */</span>
<a name="l01141"></a><a class="code" href="osd__iam_8c.html#a709000911c51d9f5a685ccd37c658d9c">01141</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a709000911c51d9f5a685ccd37c658d9c">iam_it_collision</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01142"></a>01142 {
<a name="l01143"></a>01143         <span class="keywordtype">int</span> result;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145         <a class="code" href="osd__iam_8h.html#ac88d9686b15e03eb62e2a66109845f86">assert</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it), !<a class="code" href="osd__iam_8c.html#ac24f06cf66e6e46b18098b0ff6a25f99">it_keyeq</a>(it, it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a7ce7e0d54e6907597e8f841b2c233ec3">ip_key_target</a>)));
<a name="l01146"></a>01146 
<a name="l01147"></a>01147         <span class="keywordflow">while</span> ((result = <a class="code" href="group__libiam.html#ga04c8e4213d97fa4c6a6b027d8d06d41a">iam_it_next</a>(it)) == 0) {
<a name="l01148"></a>01148                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01149"></a>01149                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#a35d26d9a4cd5902367e5276831096234">it_ikeycmp</a>(it, it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a>) != 0)
<a name="l01150"></a>01150                         <span class="keywordflow">return</span> -ENOENT;
<a name="l01151"></a>01151                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#ac24f06cf66e6e46b18098b0ff6a25f99">it_keyeq</a>(it, it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a7ce7e0d54e6907597e8f841b2c233ec3">ip_key_target</a>))
<a name="l01152"></a>01152                         <span class="keywordflow">return</span> 0;
<a name="l01153"></a>01153         }
<a name="l01154"></a>01154         <span class="keywordflow">return</span> result;
<a name="l01155"></a>01155 }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157 <span class="comment">/*</span>
<a name="l01158"></a>01158 <span class="comment"> * Attach iterator. After successful completion, @it points to record with</span>
<a name="l01159"></a>01159 <span class="comment"> * least key not larger than @k.</span>
<a name="l01160"></a>01160 <span class="comment"> *</span>
<a name="l01161"></a>01161 <span class="comment"> * Return value: 0: positioned on existing record,</span>
<a name="l01162"></a>01162 <span class="comment"> *             +ve: exact position found,</span>
<a name="l01163"></a>01163 <span class="comment"> *             -ve: error.</span>
<a name="l01164"></a>01164 <span class="comment"> *</span>
<a name="l01165"></a>01165 <span class="comment"> * precondition:  it_state(it) == IAM_IT_DETACHED</span>
<a name="l01166"></a>01166 <span class="comment"> * postcondition: ergo(result == 0 &amp;&amp; it_state(it) == IAM_IT_ATTACHED,</span>
<a name="l01167"></a>01167 <span class="comment"> *                     it_keycmp(it, k) &lt;= 0)</span>
<a name="l01168"></a>01168 <span class="comment"> */</span>
<a name="l01169"></a><a class="code" href="osd__iam_8h.html#a3f2bbe9d9c399db684093ba91265617b">01169</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a3f2bbe9d9c399db684093ba91265617b">iam_it_get</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k)
<a name="l01170"></a>01170 {
<a name="l01171"></a>01171         <span class="keywordtype">int</span> result;
<a name="l01172"></a>01172         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174         it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a> = NULL;
<a name="l01175"></a>01175         it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a7ce7e0d54e6907597e8f841b2c233ec3">ip_key_target</a>  = k;
<a name="l01176"></a>01176 
<a name="l01177"></a>01177         result = <a class="code" href="osd__iam_8c.html#ad05c6e285b565160498f04ed1845036a">__iam_it_get</a>(it, 0);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179         <span class="keywordflow">if</span> (result == <a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea2abe825f79095f9cdf28c99397e51104">IAM_LOOKUP_LAST</a>) {
<a name="l01180"></a>01180                 result = <a class="code" href="osd__iam_8c.html#a709000911c51d9f5a685ccd37c658d9c">iam_it_collision</a>(it);
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (result != 0) {
<a name="l01182"></a>01182                         <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(it);
<a name="l01183"></a>01183                         <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(it);
<a name="l01184"></a>01184                         result = <a class="code" href="osd__iam_8c.html#ad05c6e285b565160498f04ed1845036a">__iam_it_get</a>(it, 0);
<a name="l01185"></a>01185                 } <span class="keywordflow">else</span>
<a name="l01186"></a>01186                         result = +1;
<a name="l01187"></a>01187         }
<a name="l01188"></a>01188         <span class="keywordflow">if</span> (result &gt; 0)
<a name="l01189"></a>01189                 result &amp;= ~<a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea2abe825f79095f9cdf28c99397e51104">IAM_LOOKUP_LAST</a>;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result &gt; 0, <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(it, k) == 0));
<a name="l01192"></a>01192         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result == 0 &amp;&amp; <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>,
<a name="l01193"></a>01193                          <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(it, k) &lt;= 0));
<a name="l01194"></a>01194         <span class="keywordflow">return</span> result;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 <span class="comment">/*</span>
<a name="l01198"></a>01198 <span class="comment"> * Attach iterator by index key.</span>
<a name="l01199"></a>01199 <span class="comment"> */</span>
<a name="l01200"></a><a class="code" href="osd__iam_8c.html#a8b9dce5678234feeb89ec2b73cef25eb">01200</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a8b9dce5678234feeb89ec2b73cef25eb">iam_it_iget</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_ikey *k)
<a name="l01201"></a>01201 {
<a name="l01202"></a>01202         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>);
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a1877852737368b413cdcb7b6a98799bb">ip_ikey_target</a> = k;
<a name="l01205"></a>01205         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#ad05c6e285b565160498f04ed1845036a">__iam_it_get</a>(it, 1) &amp; ~<a class="code" href="osd__iam_8h.html#a4b7c31c8bace4ac1a204a3c9ce0525fea2abe825f79095f9cdf28c99397e51104">IAM_LOOKUP_LAST</a>;
<a name="l01206"></a>01206 }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208 <span class="comment">/*</span>
<a name="l01209"></a>01209 <span class="comment"> * Attach iterator, and assure it points to the record (not skewed).</span>
<a name="l01210"></a>01210 <span class="comment"> *</span>
<a name="l01211"></a>01211 <span class="comment"> * Return value: 0: positioned on existing record,</span>
<a name="l01212"></a>01212 <span class="comment"> *             +ve: exact position found,</span>
<a name="l01213"></a>01213 <span class="comment"> *             -ve: error.</span>
<a name="l01214"></a>01214 <span class="comment"> *</span>
<a name="l01215"></a>01215 <span class="comment"> * precondition:  it_state(it) == IAM_IT_DETACHED &amp;&amp;</span>
<a name="l01216"></a>01216 <span class="comment"> *                !(it-&gt;ii_flags&amp;IAM_IT_WRITE)</span>
<a name="l01217"></a>01217 <span class="comment"> * postcondition: ergo(result == 0, it_state(it) == IAM_IT_ATTACHED)</span>
<a name="l01218"></a>01218 <span class="comment"> */</span>
<a name="l01219"></a><a class="code" href="osd__iam_8h.html#a58ac1b467df5cef1af6526d39507b516">01219</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a58ac1b467df5cef1af6526d39507b516">iam_it_get_at</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k)
<a name="l01220"></a>01220 {
<a name="l01221"></a>01221         <span class="keywordtype">int</span> result;
<a name="l01222"></a>01222         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a> &amp;&amp;
<a name="l01223"></a>01223                     !(it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>));
<a name="l01224"></a>01224         result = <a class="code" href="osd__iam_8c.html#a3f2bbe9d9c399db684093ba91265617b">iam_it_get</a>(it, k);
<a name="l01225"></a>01225         <span class="keywordflow">if</span> (result == 0) {
<a name="l01226"></a>01226                 <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) != <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>) {
<a name="l01227"></a>01227                         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l01228"></a>01228                         result = <a class="code" href="group__libiam.html#ga04c8e4213d97fa4c6a6b027d8d06d41a">iam_it_next</a>(it);
<a name="l01229"></a>01229                 }
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result &gt;= 0, <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>));
<a name="l01232"></a>01232         <span class="keywordflow">return</span> result;
<a name="l01233"></a>01233 }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235 <span class="comment">/*</span>
<a name="l01236"></a>01236 <span class="comment"> * Duplicates iterator.</span>
<a name="l01237"></a>01237 <span class="comment"> *</span>
<a name="l01238"></a>01238 <span class="comment"> * postcondition: it_state(dst) == it_state(src) &amp;&amp;</span>
<a name="l01239"></a>01239 <span class="comment"> *                iam_it_container(dst) == iam_it_container(src) &amp;&amp;</span>
<a name="l01240"></a>01240 <span class="comment"> *                dst-&gt;ii_flags = src-&gt;ii_flags &amp;&amp;</span>
<a name="l01241"></a>01241 <span class="comment"> *                ergo(it_state(src) == IAM_IT_ATTACHED,</span>
<a name="l01242"></a>01242 <span class="comment"> *                     iam_it_rec_get(dst) == iam_it_rec_get(src) &amp;&amp;</span>
<a name="l01243"></a>01243 <span class="comment"> *                     iam_it_key_get(dst) == iam_it_key_get(src))</span>
<a name="l01244"></a>01244 <span class="comment"> */</span>
<a name="l01245"></a><a class="code" href="osd__iam_8h.html#a52e101701c32bf83a39175e3c0b8fcd4">01245</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a52e101701c32bf83a39175e3c0b8fcd4">iam_it_dup</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *dst, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *src)
<a name="l01246"></a>01246 {
<a name="l01247"></a>01247         dst-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>     = src-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>;
<a name="l01248"></a>01248         dst-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a>     = src-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a>;
<a name="l01249"></a>01249         <span class="comment">/* XXX not yet. iam_path_dup(&amp;dst-&gt;ii_path, &amp;src-&gt;ii_path); */</span>
<a name="l01250"></a>01250         <span class="comment">/*</span>
<a name="l01251"></a>01251 <span class="comment">         * XXX: duplicate lock.</span>
<a name="l01252"></a>01252 <span class="comment">         */</span>
<a name="l01253"></a>01253         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(dst) == <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(src));
<a name="l01254"></a>01254         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(dst) == <a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(src));
<a name="l01255"></a>01255         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(dst-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a> = src-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>);
<a name="l01256"></a>01256         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(src) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>,
<a name="l01257"></a>01257                     <a class="code" href="osd__iam_8c.html#a09f4c5f2289141b864accbfb2dc39fd3">iam_it_rec_get</a>(dst) == <a class="code" href="osd__iam_8c.html#a09f4c5f2289141b864accbfb2dc39fd3">iam_it_rec_get</a>(src) &amp;&amp;
<a name="l01258"></a>01258                     <a class="code" href="osd__iam_8c.html#a0692f0f413c237a5892fb0e1c3140ac9">iam_it_key_get</a>(dst) == <a class="code" href="osd__iam_8c.html#a0692f0f413c237a5892fb0e1c3140ac9">iam_it_key_get</a>(src)));
<a name="l01259"></a>01259 
<a name="l01260"></a>01260 }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 <span class="comment">/*</span>
<a name="l01263"></a>01263 <span class="comment"> * Detach iterator. Does nothing it detached state.</span>
<a name="l01264"></a>01264 <span class="comment"> *</span>
<a name="l01265"></a>01265 <span class="comment"> * postcondition: it_state(it) == IAM_IT_DETACHED</span>
<a name="l01266"></a>01266 <span class="comment"> */</span>
<a name="l01267"></a><a class="code" href="osd__iam_8h.html#aff48cbfa1eeab11046c2ff104130f7b9">01267</a> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01268"></a>01268 {
<a name="l01269"></a>01269         <span class="keywordflow">if</span> (it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> != <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>) {
<a name="l01270"></a>01270                 it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>;
<a name="l01271"></a>01271                 <a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">iam_leaf_fini</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l01272"></a>01272         }
<a name="l01273"></a>01273 }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 <span class="keyword">static</span> <span class="keyword">struct </span>iam_ikey *<a class="code" href="osd__iam_8c.html#a4b636e2ce22ee1d05ac35f0b04cb4c83">iam_it_ikey_get</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l01276"></a>01276                                         <span class="keyword">struct</span> iam_ikey *ikey);
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 
<a name="l01279"></a>01279 <span class="comment">/*</span>
<a name="l01280"></a>01280 <span class="comment"> * This function increments the frame pointer to search the next leaf</span>
<a name="l01281"></a>01281 <span class="comment"> * block, and reads in the necessary intervening nodes if the search</span>
<a name="l01282"></a>01282 <span class="comment"> * should be necessary.  Whether or not the search is necessary is</span>
<a name="l01283"></a>01283 <span class="comment"> * controlled by the hash parameter.  If the hash value is even, then</span>
<a name="l01284"></a>01284 <span class="comment"> * the search is only continued if the next block starts with that</span>
<a name="l01285"></a>01285 <span class="comment"> * hash value.  This is used if we are searching for a specific file.</span>
<a name="l01286"></a>01286 <span class="comment"> *</span>
<a name="l01287"></a>01287 <span class="comment"> * If the hash value is HASH_NB_ALWAYS, then always go to the next block.</span>
<a name="l01288"></a>01288 <span class="comment"> *</span>
<a name="l01289"></a>01289 <span class="comment"> * This function returns 1 if the caller should continue to search,</span>
<a name="l01290"></a>01290 <span class="comment"> * or 0 if it should not.  If there is an error reading one of the</span>
<a name="l01291"></a>01291 <span class="comment"> * index blocks, it will a negative error code.</span>
<a name="l01292"></a>01292 <span class="comment"> *</span>
<a name="l01293"></a>01293 <span class="comment"> * If start_hash is non-null, it will be filled in with the starting</span>
<a name="l01294"></a>01294 <span class="comment"> * hash of the next page.</span>
<a name="l01295"></a>01295 <span class="comment"> */</span>
<a name="l01296"></a><a class="code" href="osd__iam_8c.html#a1106fe1c038668b75829bde22d77f857">01296</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a1106fe1c038668b75829bde22d77f857">iam_htree_advance</a>(<span class="keyword">struct</span> inode *<a class="code" href="mmap__sanity_8c.html#a73da71b9c136e698a3ccaa1366e455a8">dir</a>, __u32 hash,
<a name="l01297"></a>01297                               <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path, __u32 *start_hash,
<a name="l01298"></a>01298                               <span class="keywordtype">int</span> compat)
<a name="l01299"></a>01299 {
<a name="l01300"></a>01300         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *p;
<a name="l01301"></a>01301         <span class="keyword">struct </span>buffer_head *bh;
<a name="l01302"></a>01302         <span class="keywordtype">int</span> err, num_frames = 0;
<a name="l01303"></a>01303         __u32 bhash;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         p = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>;
<a name="l01306"></a>01306         <span class="comment">/*</span>
<a name="l01307"></a>01307 <span class="comment">         * Find the next leaf page by incrementing the frame pointer.</span>
<a name="l01308"></a>01308 <span class="comment">         * If we run out of entries in the interior node, loop around and</span>
<a name="l01309"></a>01309 <span class="comment">         * increment pointer in the parent node.  When we break out of</span>
<a name="l01310"></a>01310 <span class="comment">         * this loop, num_frames indicates the number of interior</span>
<a name="l01311"></a>01311 <span class="comment">         * nodes need to be read.</span>
<a name="l01312"></a>01312 <span class="comment">         */</span>
<a name="l01313"></a>01313         <span class="keywordflow">while</span> (1) {
<a name="l01314"></a>01314                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01315"></a>01315                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01316"></a>01316                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiam__frame.html#ab52473c2d49f64e28edf64f629949a3b">at_shifted</a>)
<a name="l01317"></a>01317                         p-&gt;<a class="code" href="structiam__frame.html#ab52473c2d49f64e28edf64f629949a3b">at_shifted</a> = 0;
<a name="l01318"></a>01318                 <span class="keywordflow">else</span>
<a name="l01319"></a>01319                         p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, +1);
<a name="l01320"></a>01320                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> &lt; <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, p-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>,
<a name="l01321"></a>01321                                             <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(p-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>))) {
<a name="l01322"></a>01322                         p-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> = <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>);
<a name="l01323"></a>01323                         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01324"></a>01324                         <span class="keywordflow">break</span>;
<a name="l01325"></a>01325                 }
<a name="l01326"></a>01326                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01327"></a>01327                 <span class="keywordflow">if</span> (p == path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>)
<a name="l01328"></a>01328                         <span class="keywordflow">return</span> 0;
<a name="l01329"></a>01329                 num_frames++;
<a name="l01330"></a>01330                 --p;
<a name="l01331"></a>01331         }
<a name="l01332"></a>01332 
<a name="l01333"></a>01333         <span class="keywordflow">if</span> (compat) {
<a name="l01334"></a>01334                 <span class="comment">/*</span>
<a name="l01335"></a>01335 <span class="comment">                 * Htree hash magic.</span>
<a name="l01336"></a>01336 <span class="comment">                 */</span>
<a name="l01337"></a>01337         <span class="comment">/*</span>
<a name="l01338"></a>01338 <span class="comment">         * If the hash is 1, then continue only if the next page has a</span>
<a name="l01339"></a>01339 <span class="comment">         * continuation hash of any value.  This is used for readdir</span>
<a name="l01340"></a>01340 <span class="comment">         * handling.  Otherwise, check to see if the hash matches the</span>
<a name="l01341"></a>01341 <span class="comment">         * desired contiuation hash.  If it doesn&apos;t, return since</span>
<a name="l01342"></a>01342 <span class="comment">         * there&apos;s no point to read in the successive index pages.</span>
<a name="l01343"></a>01343 <span class="comment">         */</span>
<a name="l01344"></a>01344                 <a class="code" href="osd__iam_8h.html#a0cfaccc96060d465f3b39540c4399ef5">dx_get_ikey</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, (<span class="keyword">struct</span> iam_ikey *)&amp;bhash);
<a name="l01345"></a>01345         <span class="keywordflow">if</span> (start_hash)
<a name="l01346"></a>01346                 *start_hash = bhash;
<a name="l01347"></a>01347         <span class="keywordflow">if</span> ((hash &amp; 1) == 0) {
<a name="l01348"></a>01348                 <span class="keywordflow">if</span> ((bhash &amp; ~1) != hash)
<a name="l01349"></a>01349                         <span class="keywordflow">return</span> 0;
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351         }
<a name="l01352"></a>01352         <span class="comment">/*</span>
<a name="l01353"></a>01353 <span class="comment">         * If the hash is HASH_NB_ALWAYS, we always go to the next</span>
<a name="l01354"></a>01354 <span class="comment">         * block so no check is necessary</span>
<a name="l01355"></a>01355 <span class="comment">         */</span>
<a name="l01356"></a>01356         <span class="keywordflow">while</span> (num_frames--) {
<a name="l01357"></a>01357                 <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> idx;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01360"></a>01360                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01361"></a>01361                 idx = p-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> = <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>);
<a name="l01362"></a>01362                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01363"></a>01363                 err = <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(path)-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;
<a name="l01364"></a>01364                         id_node_read(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, idx, NULL, &amp;bh);
<a name="l01365"></a>01365                 <span class="keywordflow">if</span> (err != 0)
<a name="l01366"></a>01366                         <span class="keywordflow">return</span> err; <span class="comment">/* Failure */</span>
<a name="l01367"></a>01367                 ++p;
<a name="l01368"></a>01368                 brelse(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01369"></a>01369                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> != bh);
<a name="l01370"></a>01370                 p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> = bh;
<a name="l01371"></a>01371                 p-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a> = <a class="code" href="osd__iam_8h.html#a12323a0a6d5039c6e6009cd50e7cf30b">dx_node_get_entries</a>(path, p);
<a name="l01372"></a>01372                 p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, p-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>, !compat);
<a name="l01373"></a>01373                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(p-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a> != idx);
<a name="l01374"></a>01374                 p-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a> = idx;
<a name="l01375"></a>01375                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01376"></a>01376                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(p-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> != <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>));
<a name="l01377"></a>01377                 p-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> = <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(path, p-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>);
<a name="l01378"></a>01378                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(p-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01379"></a>01379                 <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, p));
<a name="l01380"></a>01380         }
<a name="l01381"></a>01381         <span class="keywordflow">return</span> 1;
<a name="l01382"></a>01382 }
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 
<a name="l01385"></a><a class="code" href="osd__iam_8c.html#a3a4b372c12e626cf96dedadcd33e6987">01385</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a3a4b372c12e626cf96dedadcd33e6987">iam_index_advance</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a1106fe1c038668b75829bde22d77f857">iam_htree_advance</a>(<a class="code" href="osd__iam_8h.html#a57e5447b6d363bd74838b2be2bc93fbd">iam_path_obj</a>(path), 0, path, NULL, 0);
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a><a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">01390</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *ic,
<a name="l01391"></a>01391                              <span class="keyword">struct</span> <a class="code" href="structdynlock__handle.html">dynlock_handle</a> **lh)
<a name="l01392"></a>01392 {
<a name="l01393"></a>01393         <span class="keywordtype">int</span> i;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>; ++i, ++lh) {
<a name="l01396"></a>01396                 <span class="keywordflow">if</span> (*lh != NULL) {
<a name="l01397"></a>01397                         <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(ic, *lh);
<a name="l01398"></a>01398                         *lh = NULL;
<a name="l01399"></a>01399                 }
<a name="l01400"></a>01400         }
<a name="l01401"></a>01401 }
<a name="l01402"></a>01402 <span class="comment">/*</span>
<a name="l01403"></a>01403 <span class="comment"> * Advance index part of @path to point to the next leaf. Returns 1 on</span>
<a name="l01404"></a>01404 <span class="comment"> * success, 0, when end of container was reached. Leaf node is locked.</span>
<a name="l01405"></a>01405 <span class="comment"> */</span>
<a name="l01406"></a><a class="code" href="osd__iam_8h.html#a32d95b2877d75c8b852c6f09d29e054c">01406</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#abd5487d43ee28193e1b28753c563f08f">iam_index_next</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path)
<a name="l01407"></a>01407 {
<a name="l01408"></a>01408         <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> cursor;
<a name="l01409"></a>01409         <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh[<a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>] = { NULL, };
<a name="l01410"></a>01410         <span class="keywordtype">int</span> result;
<a name="l01411"></a>01411         <span class="keyword">struct </span>inode *object;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413         <span class="comment">/*</span>
<a name="l01414"></a>01414 <span class="comment">         * Locking for iam_index_next()... is to be described.</span>
<a name="l01415"></a>01415 <span class="comment">         */</span>
<a name="l01416"></a>01416 
<a name="l01417"></a>01417         <span class="keywordtype">object</span> = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l01418"></a>01418         cursor = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420         <span class="keywordflow">while</span> (1) {
<a name="l01421"></a>01421                 result = <a class="code" href="osd__iam_8c.html#a41ca0ef0c8d67fc23f0e0f15dc3161bd">iam_index_lock</a>(path, lh);
<a name="l01422"></a>01422                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01423"></a>01423                 <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01424"></a>01424                         <span class="keywordflow">break</span>;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426                 result = <a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(path, 0);
<a name="l01427"></a>01427                 <span class="keywordflow">if</span> (result == 0 &amp;&amp; cursor == path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>) {
<a name="l01428"></a>01428                         result = <a class="code" href="osd__iam_8c.html#a3a4b372c12e626cf96dedadcd33e6987">iam_index_advance</a>(path);
<a name="l01429"></a>01429 
<a name="l01430"></a>01430                         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(result == 0 ||
<a name="l01431"></a>01431                                     cursor != path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>);
<a name="l01432"></a>01432                         <span class="keywordflow">break</span>;
<a name="l01433"></a>01433                 }
<a name="l01434"></a>01434                 <span class="keywordflow">do</span> {
<a name="l01435"></a>01435                         <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(c, lh);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437                         <a class="code" href="osd__iam_8c.html#a2d391de29e3a6a4a5315359b2a21ec87">iam_path_release</a>(path);
<a name="l01438"></a>01438                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01439"></a>01439 
<a name="l01440"></a>01440                         result = <a class="code" href="osd__iam_8c.html#af206b7bb35c205113cf5dda417f3b1e3">__iam_path_lookup</a>(path);
<a name="l01441"></a>01441                         <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01442"></a>01442                                 <span class="keywordflow">break</span>;
<a name="l01443"></a>01443 
<a name="l01444"></a>01444                         <span class="keywordflow">while</span> (path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> != cursor) {
<a name="l01445"></a>01445                                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01446"></a>01446 
<a name="l01447"></a>01447                                 result = <a class="code" href="osd__iam_8c.html#a41ca0ef0c8d67fc23f0e0f15dc3161bd">iam_index_lock</a>(path, lh);
<a name="l01448"></a>01448                                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01449"></a>01449                                 <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01450"></a>01450                                         <span class="keywordflow">break</span>;
<a name="l01451"></a>01451 
<a name="l01452"></a>01452                                 result = <a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(path, 0);
<a name="l01453"></a>01453                                 <span class="keywordflow">if</span> (result != 0)
<a name="l01454"></a>01454                                         <span class="keywordflow">break</span>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456                                 result = <a class="code" href="osd__iam_8c.html#a3a4b372c12e626cf96dedadcd33e6987">iam_index_advance</a>(path);
<a name="l01457"></a>01457                                 <span class="keywordflow">if</span> (result == 0) {
<a name="l01458"></a>01458                                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;cannot find cursor : %u\n&quot;</span>,
<a name="l01459"></a>01459                                                 cursor);
<a name="l01460"></a>01460                                         result = -EIO;
<a name="l01461"></a>01461                                 }
<a name="l01462"></a>01462                                 <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01463"></a>01463                                         <span class="keywordflow">break</span>;
<a name="l01464"></a>01464                                 result = <a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(path, 0);
<a name="l01465"></a>01465                                 <span class="keywordflow">if</span> (result != 0)
<a name="l01466"></a>01466                                         <span class="keywordflow">break</span>;
<a name="l01467"></a>01467                                 <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(c, lh);
<a name="l01468"></a>01468                         }
<a name="l01469"></a>01469                 } <span class="keywordflow">while</span> (result == -EAGAIN);
<a name="l01470"></a>01470                 <span class="keywordflow">if</span> (result &lt; 0)
<a name="l01471"></a>01471                         <span class="keywordflow">break</span>;
<a name="l01472"></a>01472         }
<a name="l01473"></a>01473         <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(c, lh);
<a name="l01474"></a>01474         <span class="keywordflow">return</span> result;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477 <span class="comment">/*</span>
<a name="l01478"></a>01478 <span class="comment"> * Move iterator one record right.</span>
<a name="l01479"></a>01479 <span class="comment"> *</span>
<a name="l01480"></a>01480 <span class="comment"> * Return value: 0: success,</span>
<a name="l01481"></a>01481 <span class="comment"> *              +1: end of container reached</span>
<a name="l01482"></a>01482 <span class="comment"> *             -ve: error</span>
<a name="l01483"></a>01483 <span class="comment"> *</span>
<a name="l01484"></a>01484 <span class="comment"> * precondition:  (it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l01485"></a>01485 <span class="comment"> *                 it_state(it) == IAM_IT_SKEWED) &amp;&amp; it-&gt;ii_flags&amp;IAM_IT_MOVE</span>
<a name="l01486"></a>01486 <span class="comment"> * postcondition: ergo(result == 0, it_state(it) == IAM_IT_ATTACHED) &amp;&amp;</span>
<a name="l01487"></a>01487 <span class="comment"> *                ergo(result &gt;  0, it_state(it) == IAM_IT_DETACHED)</span>
<a name="l01488"></a>01488 <span class="comment"> */</span>
<a name="l01489"></a><a class="code" href="osd__iam_8h.html#a7d9937b250db08a0814a59c5861385f9">01489</a> <span class="keywordtype">int</span> <a class="code" href="group__libiam.html#ga04c8e4213d97fa4c6a6b027d8d06d41a">iam_it_next</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01490"></a>01490 {
<a name="l01491"></a>01491         <span class="keywordtype">int</span> result;
<a name="l01492"></a>01492         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a>      *path;
<a name="l01493"></a>01493         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a>      *leaf;
<a name="l01494"></a>01494         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(<span class="keyword">struct</span> iam_ikey *ik_orig);
<a name="l01495"></a>01495 
<a name="l01496"></a>01496         <span class="comment">/* assert_corr(it-&gt;ii_flags&amp;IAM_IT_MOVE); */</span>
<a name="l01497"></a>01497         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l01498"></a>01498                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500         path = &amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>;
<a name="l01501"></a>01501         leaf = &amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a26daa7d03d7088fccdc418717479f72a">iam_leaf_is_locked</a>(leaf));
<a name="l01504"></a>01504 
<a name="l01505"></a>01505         result = 0;
<a name="l01506"></a>01506         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(ik_orig = <a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it) ?
<a name="l01507"></a>01507                 <a class="code" href="osd__iam_8c.html#a4b636e2ce22ee1d05ac35f0b04cb4c83">iam_it_ikey_get</a>(it, <a class="code" href="osd__iam_8h.html#a95b1cb172d15f6e864bcfe03fd18da5f">iam_path_ikey</a>(path, 2)) : NULL);
<a name="l01508"></a>01508         <span class="keywordflow">if</span> (<a class="code" href="osd__iam_8c.html#ab3199edf371c72e25185abf229c278ac">it_before</a>(it)) {
<a name="l01509"></a>01509                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(!<a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(leaf));
<a name="l01510"></a>01510                 it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>;
<a name="l01511"></a>01511         } <span class="keywordflow">else</span> {
<a name="l01512"></a>01512                 <span class="keywordflow">if</span> (!<a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(leaf))
<a name="l01513"></a>01513                         <span class="comment">/* advance within leaf node */</span>
<a name="l01514"></a>01514                         <a class="code" href="osd__iam_8c.html#aa07d654d1db24cbe74f7927a44e6871f">iam_leaf_next</a>(leaf);
<a name="l01515"></a>01515                 <span class="comment">/*</span>
<a name="l01516"></a>01516 <span class="comment">                 * multiple iterations may be necessary due to empty leaves.</span>
<a name="l01517"></a>01517 <span class="comment">                 */</span>
<a name="l01518"></a>01518                 <span class="keywordflow">while</span> (result == 0 &amp;&amp; <a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(leaf)) {
<a name="l01519"></a>01519                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01520"></a>01520                         <span class="comment">/* advance index portion of the path */</span>
<a name="l01521"></a>01521                         result = <a class="code" href="osd__iam_8c.html#abd5487d43ee28193e1b28753c563f08f">iam_index_next</a>(<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(it), path);
<a name="l01522"></a>01522                         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a26daa7d03d7088fccdc418717479f72a">iam_leaf_is_locked</a>(leaf));
<a name="l01523"></a>01523                         <span class="keywordflow">if</span> (result == 1) {
<a name="l01524"></a>01524                                 <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh;
<a name="l01525"></a>01525                                 lh = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(it),
<a name="l01526"></a>01526                                                     path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>,
<a name="l01527"></a>01527                                                     <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l01528"></a>01528                                 <span class="keywordflow">if</span> (lh != NULL) {
<a name="l01529"></a>01529                                         <a class="code" href="osd__iam_8c.html#a201da97cc4f03e0a7ff59254d7d75083">iam_leaf_fini</a>(leaf);
<a name="l01530"></a>01530                                         leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a> = lh;
<a name="l01531"></a>01531                                         result = <a class="code" href="osd__iam_8c.html#a1ccff7f8e68c4ba567cdf24d297ea741">iam_leaf_load</a>(path);
<a name="l01532"></a>01532                                         <span class="keywordflow">if</span> (result == 0)
<a name="l01533"></a>01533                                                 <a class="code" href="osd__iam_8c.html#ad3d587f934d95c3db47b0a148775117b">iam_leaf_start</a>(leaf);
<a name="l01534"></a>01534                                 } <span class="keywordflow">else</span>
<a name="l01535"></a>01535                                         result = -ENOMEM;
<a name="l01536"></a>01536                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == 0)
<a name="l01537"></a>01537                                 <span class="comment">/* end of container reached */</span>
<a name="l01538"></a>01538                                 result = +1;
<a name="l01539"></a>01539                         <span class="keywordflow">if</span> (result != 0)
<a name="l01540"></a>01540                                 <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(it);
<a name="l01541"></a>01541                 }
<a name="l01542"></a>01542                 <span class="keywordflow">if</span> (result == 0)
<a name="l01543"></a>01543                         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>;
<a name="l01544"></a>01544         }
<a name="l01545"></a>01545         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result == 0, <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>));
<a name="l01546"></a>01546         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result &gt;  0, <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>));
<a name="l01547"></a>01547         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result == 0 &amp;&amp; ik_orig != NULL,
<a name="l01548"></a>01548                          <a class="code" href="osd__iam_8c.html#a35d26d9a4cd5902367e5276831096234">it_ikeycmp</a>(it, ik_orig) &gt;= 0));
<a name="l01549"></a>01549         <span class="keywordflow">return</span> result;
<a name="l01550"></a>01550 }
<a name="l01551"></a>01551 
<a name="l01552"></a>01552 <span class="comment">/*</span>
<a name="l01553"></a>01553 <span class="comment"> * Return pointer to the record under iterator.</span>
<a name="l01554"></a>01554 <span class="comment"> *</span>
<a name="l01555"></a>01555 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED &amp;&amp; it_at_rec(it)</span>
<a name="l01556"></a>01556 <span class="comment"> * postcondition: it_state(it) == IAM_IT_ATTACHED</span>
<a name="l01557"></a>01557 <span class="comment"> */</span>
<a name="l01558"></a><a class="code" href="osd__iam_8h.html#a09f4c5f2289141b864accbfb2dc39fd3">01558</a> <span class="keyword">struct </span>iam_rec *<a class="code" href="osd__iam_8c.html#a09f4c5f2289141b864accbfb2dc39fd3">iam_it_rec_get</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01559"></a>01559 {
<a name="l01560"></a>01560         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>);
<a name="l01561"></a>01561         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l01562"></a>01562         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a9c0816ad24027b544a536c0412c20c94">iam_leaf_rec</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l01563"></a>01563 }
<a name="l01564"></a>01564 
<a name="l01565"></a><a class="code" href="osd__iam_8c.html#adfcf5b92e4477dc6afe80af07bce2c6e">01565</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#adfcf5b92e4477dc6afe80af07bce2c6e">iam_it_reccpy</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r)
<a name="l01566"></a>01566 {
<a name="l01567"></a>01567         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a> *folio;
<a name="l01568"></a>01568 
<a name="l01569"></a>01569         folio = &amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l01570"></a>01570         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(folio)-&gt;<a class="code" href="structiam__leaf__operations.html#adbd426fef3906f03166306103473d0c1">rec_set</a>(folio, r);
<a name="l01571"></a>01571 }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 <span class="comment">/*</span>
<a name="l01574"></a>01574 <span class="comment"> * Replace contents of record under iterator.</span>
<a name="l01575"></a>01575 <span class="comment"> *</span>
<a name="l01576"></a>01576 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l01577"></a>01577 <span class="comment"> *                it-&gt;ii_flags&amp;IAM_IT_WRITE</span>
<a name="l01578"></a>01578 <span class="comment"> * postcondition: it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l01579"></a>01579 <span class="comment"> *                ergo(result == 0, !memcmp(iam_it_rec_get(it), r, ...))</span>
<a name="l01580"></a>01580 <span class="comment"> */</span>
<a name="l01581"></a><a class="code" href="osd__iam_8h.html#a40e1003d26e9b6b9d9e19b687c158b22">01581</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a40e1003d26e9b6b9d9e19b687c158b22">iam_it_rec_set</a>(handle_t *h,
<a name="l01582"></a>01582                    <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r)
<a name="l01583"></a>01583 {
<a name="l01584"></a>01584         <span class="keywordtype">int</span> result;
<a name="l01585"></a>01585         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a> *path;
<a name="l01586"></a>01586         <span class="keyword">struct </span>buffer_head *bh;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> &amp;&amp;
<a name="l01589"></a>01589                     it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>);
<a name="l01590"></a>01590         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l01591"></a>01591 
<a name="l01592"></a>01592         path = &amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>;
<a name="l01593"></a>01593         bh   = path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>.<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>;
<a name="l01594"></a>01594         result = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(h, path, bh);
<a name="l01595"></a>01595         <span class="keywordflow">if</span> (result == 0) {
<a name="l01596"></a>01596                 <a class="code" href="osd__iam_8c.html#adfcf5b92e4477dc6afe80af07bce2c6e">iam_it_reccpy</a>(it, r);
<a name="l01597"></a>01597                 result = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, path, bh);
<a name="l01598"></a>01598         }
<a name="l01599"></a>01599         <span class="keywordflow">return</span> result;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="comment">/*</span>
<a name="l01603"></a>01603 <span class="comment"> * Return pointer to the index key under iterator.</span>
<a name="l01604"></a>01604 <span class="comment"> *</span>
<a name="l01605"></a>01605 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l01606"></a>01606 <span class="comment"> *                it_state(it) == IAM_IT_SKEWED</span>
<a name="l01607"></a>01607 <span class="comment"> */</span>
<a name="l01608"></a><a class="code" href="osd__iam_8c.html#a4b636e2ce22ee1d05ac35f0b04cb4c83">01608</a> <span class="keyword">static</span> <span class="keyword">struct </span>iam_ikey *<a class="code" href="osd__iam_8c.html#a4b636e2ce22ee1d05ac35f0b04cb4c83">iam_it_ikey_get</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l01609"></a>01609                                         <span class="keyword">struct</span> iam_ikey *ikey)
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l01612"></a>01612                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l01613"></a>01613         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l01614"></a>01614         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#ace3036486e409de1d4ccc8ea4eab24bd">iam_leaf_ikey</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>, ikey);
<a name="l01615"></a>01615 }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617 <span class="comment">/*</span>
<a name="l01618"></a>01618 <span class="comment"> * Return pointer to the key under iterator.</span>
<a name="l01619"></a>01619 <span class="comment"> *</span>
<a name="l01620"></a>01620 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l01621"></a>01621 <span class="comment"> *                it_state(it) == IAM_IT_SKEWED</span>
<a name="l01622"></a>01622 <span class="comment"> */</span>
<a name="l01623"></a><a class="code" href="osd__iam_8h.html#a0692f0f413c237a5892fb0e1c3140ac9">01623</a> <span class="keyword">struct </span>iam_key *<a class="code" href="osd__iam_8c.html#a0692f0f413c237a5892fb0e1c3140ac9">iam_it_key_get</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01624"></a>01624 {
<a name="l01625"></a>01625         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l01626"></a>01626                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l01627"></a>01627         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l01628"></a>01628         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a77ed0022aa00e21b7f462d75a7dca2fc">iam_leaf_key</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l01629"></a>01629 }
<a name="l01630"></a>01630 
<a name="l01631"></a>01631 <span class="comment">/*</span>
<a name="l01632"></a>01632 <span class="comment"> * Return size of key under iterator (in bytes)</span>
<a name="l01633"></a>01633 <span class="comment"> *</span>
<a name="l01634"></a>01634 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l01635"></a>01635 <span class="comment"> *                it_state(it) == IAM_IT_SKEWED</span>
<a name="l01636"></a>01636 <span class="comment"> */</span>
<a name="l01637"></a><a class="code" href="osd__iam_8h.html#a8f4c6d09f8c2cdd4c13bfb6e552aa158">01637</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a8f4c6d09f8c2cdd4c13bfb6e552aa158">iam_it_key_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l01638"></a>01638 {
<a name="l01639"></a>01639         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l01640"></a>01640                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l01641"></a>01641         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l01642"></a>01642         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a511095348db7405ce6226aabb26dd907">iam_leaf_key_size</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>);
<a name="l01643"></a>01643 }
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 <span class="keyword">static</span> <span class="keyword">struct </span>buffer_head *
<a name="l01646"></a><a class="code" href="osd__iam_8c.html#aa3ca8041f5851e4ffa008e7b130d5cf7">01646</a> <a class="code" href="osd__iam_8c.html#aa3ca8041f5851e4ffa008e7b130d5cf7">iam_new_node</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> *b, <span class="keywordtype">int</span> *e)
<a name="l01647"></a>01647 {
<a name="l01648"></a>01648         <span class="keyword">struct </span>inode *inode = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l01649"></a>01649         <span class="keyword">struct </span>buffer_head *bh = NULL;
<a name="l01650"></a>01650         <span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *<a class="code" href="writemany_8c.html#af39400667a953a7c5c34e3964aa1ce9f">head</a>;
<a name="l01651"></a>01651         <span class="keyword">struct </span>buffer_head *idle;
<a name="l01652"></a>01652         __u32 *idle_blocks;
<a name="l01653"></a>01653         __u16 count;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> == NULL)
<a name="l01656"></a>01656                 <span class="keywordflow">goto</span> newblock;
<a name="l01657"></a>01657 
<a name="l01658"></a>01658         mutex_lock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> == NULL)) {
<a name="l01660"></a>01660                 mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l01661"></a>01661                 <span class="keywordflow">goto</span> newblock;
<a name="l01662"></a>01662         }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         head = (<span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *)(c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>-&gt;b_data);
<a name="l01665"></a>01665         count = <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(head-&gt;<a class="code" href="structiam__idle__head.html#aa79d3c1f91ec68f94723c70df23aa4f9">iih_count</a>);
<a name="l01666"></a>01666         <span class="keywordflow">if</span> (count &gt; 0) {
<a name="l01667"></a>01667                 *e = ldiskfs_journal_get_write_access(h, c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>);
<a name="l01668"></a>01668                 <span class="keywordflow">if</span> (*e != 0)
<a name="l01669"></a>01669                         <span class="keywordflow">goto</span> fail;
<a name="l01670"></a>01670 
<a name="l01671"></a>01671                 --count;
<a name="l01672"></a>01672                 *b = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(head-&gt;<a class="code" href="structiam__idle__head.html#ab74c24613285e0224ee4ef98de79f2e1">iih_blks</a>[count]);
<a name="l01673"></a>01673                 head-&gt;<a class="code" href="structiam__idle__head.html#aa79d3c1f91ec68f94723c70df23aa4f9">iih_count</a> = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(count);
<a name="l01674"></a>01674                 *e = ldiskfs_handle_dirty_metadata(h, inode, c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>);
<a name="l01675"></a>01675                 <span class="keywordflow">if</span> (*e != 0)
<a name="l01676"></a>01676                         <span class="keywordflow">goto</span> fail;
<a name="l01677"></a>01677 
<a name="l01678"></a>01678                 mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l01679"></a>01679                 bh = ldiskfs_bread(NULL, inode, *b, 0, e);
<a name="l01680"></a>01680                 <span class="keywordflow">if</span> (bh == NULL) {
<a name="l01681"></a>01681                         *e = *e ? *e : -EIO;
<a name="l01682"></a>01682                         <span class="keywordflow">return</span> NULL;
<a name="l01683"></a>01683                 }
<a name="l01684"></a>01684                 <span class="keywordflow">goto</span> got;
<a name="l01685"></a>01685         }
<a name="l01686"></a>01686 
<a name="l01687"></a>01687         <span class="comment">/* The block itself which contains the iam_idle_head is</span>
<a name="l01688"></a>01688 <span class="comment">         * also an idle block, and can be used as the new node. */</span>
<a name="l01689"></a>01689         idle_blocks = (__u32 *)(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>-&gt;b_data +
<a name="l01690"></a>01690                                 c-&gt;<a class="code" href="structiam__container.html#a33d58684b5bfc25a9e1498098435df96">ic_descr</a>-&gt;<a class="code" href="structiam__descr.html#a25bbbcb7becbec775fe8348f85374511">id_root_gap</a> +
<a name="l01691"></a>01691                                 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdx__countlimit.html">dx_countlimit</a>));
<a name="l01692"></a>01692         *e = ldiskfs_journal_get_write_access(h, c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01693"></a>01693         <span class="keywordflow">if</span> (*e != 0)
<a name="l01694"></a>01694                 <span class="keywordflow">goto</span> fail;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696         *b = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(*idle_blocks);
<a name="l01697"></a>01697         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01698"></a>01698         *idle_blocks = head-&gt;<a class="code" href="structiam__idle__head.html#a34b77ac9f56e11329845948d746154f9">iih_next</a>;
<a name="l01699"></a>01699         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01700"></a>01700         *e = ldiskfs_handle_dirty_metadata(h, inode, c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01701"></a>01701         <span class="keywordflow">if</span> (*e != 0) {
<a name="l01702"></a>01702                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01703"></a>01703                 *idle_blocks = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(*b);
<a name="l01704"></a>01704                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l01705"></a>01705                 <span class="keywordflow">goto</span> fail;
<a name="l01706"></a>01706         }
<a name="l01707"></a>01707 
<a name="l01708"></a>01708         bh = c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>;
<a name="l01709"></a>01709         idle = <a class="code" href="osd__iam_8c.html#a73832112694bc2f520b001d23c522fed">iam_load_idle_blocks</a>(c, <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(*idle_blocks));
<a name="l01710"></a>01710         <span class="keywordflow">if</span> (idle != NULL &amp;&amp; IS_ERR(idle)) {
<a name="l01711"></a>01711                 *e = PTR_ERR(idle);
<a name="l01712"></a>01712                 c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> = NULL;
<a name="l01713"></a>01713                 brelse(bh);
<a name="l01714"></a>01714                 <span class="keywordflow">goto</span> fail;
<a name="l01715"></a>01715         }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> = idle;
<a name="l01718"></a>01718         mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l01719"></a>01719 
<a name="l01720"></a>01720 got:
<a name="l01721"></a>01721         <span class="comment">/* get write access for the found buffer head */</span>
<a name="l01722"></a>01722         *e = ldiskfs_journal_get_write_access(h, bh);
<a name="l01723"></a>01723         <span class="keywordflow">if</span> (*e != 0) {
<a name="l01724"></a>01724                 brelse(bh);
<a name="l01725"></a>01725                 bh = NULL;
<a name="l01726"></a>01726                 ldiskfs_std_error(inode-&gt;i_sb, *e);
<a name="l01727"></a>01727         } <span class="keywordflow">else</span> {
<a name="l01728"></a>01728                 <span class="comment">/* Clear the reused node as new node does. */</span>
<a name="l01729"></a>01729                 memset(bh-&gt;b_data, 0, inode-&gt;i_sb-&gt;s_blocksize);
<a name="l01730"></a>01730                 set_buffer_uptodate(bh);
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732         <span class="keywordflow">return</span> bh;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 newblock:
<a name="l01735"></a>01735         bh = <a class="code" href="osd-ldiskfs_2osd__internal_8h.html#a135b1e0120ac64a6114b94322ae0b424">osd_ldiskfs_append</a>(h, inode, b);
<a name="l01736"></a>01736         <span class="keywordflow">if</span> (IS_ERR(bh)) {
<a name="l01737"></a>01737                 *e = PTR_ERR(bh);
<a name="l01738"></a>01738                 bh = NULL;
<a name="l01739"></a>01739         }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         <span class="keywordflow">return</span> bh;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 fail:
<a name="l01744"></a>01744         mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l01745"></a>01745         ldiskfs_std_error(inode-&gt;i_sb, *e);
<a name="l01746"></a>01746         <span class="keywordflow">return</span> NULL;
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 <span class="comment">/*</span>
<a name="l01750"></a>01750 <span class="comment"> * Insertion of new record. Interaction with jbd during non-trivial case (when</span>
<a name="l01751"></a>01751 <span class="comment"> * split happens) is as following:</span>
<a name="l01752"></a>01752 <span class="comment"> *</span>
<a name="l01753"></a>01753 <span class="comment"> *  - new leaf node is involved into transaction by iam_new_node();</span>
<a name="l01754"></a>01754 <span class="comment"> *</span>
<a name="l01755"></a>01755 <span class="comment"> *  - old leaf node is involved into transaction by iam_add_rec();</span>
<a name="l01756"></a>01756 <span class="comment"> *</span>
<a name="l01757"></a>01757 <span class="comment"> *  - leaf where insertion point ends in, is marked dirty by iam_add_rec();</span>
<a name="l01758"></a>01758 <span class="comment"> *</span>
<a name="l01759"></a>01759 <span class="comment"> *  - leaf without insertion point is marked dirty (as @new_leaf) by</span>
<a name="l01760"></a>01760 <span class="comment"> *  iam_new_leaf();</span>
<a name="l01761"></a>01761 <span class="comment"> *</span>
<a name="l01762"></a>01762 <span class="comment"> *  - split index nodes are involved into transaction and marked dirty by</span>
<a name="l01763"></a>01763 <span class="comment"> *  split_index_node().</span>
<a name="l01764"></a>01764 <span class="comment"> *</span>
<a name="l01765"></a>01765 <span class="comment"> *  - &quot;safe&quot; index node, which is no split, but where new pointer is inserted</span>
<a name="l01766"></a>01766 <span class="comment"> *  is involved into transaction and marked dirty by split_index_node().</span>
<a name="l01767"></a>01767 <span class="comment"> *</span>
<a name="l01768"></a>01768 <span class="comment"> *  - index node where pointer to new leaf is inserted is involved into</span>
<a name="l01769"></a>01769 <span class="comment"> *  transaction by split_index_node() and marked dirty by iam_add_rec().</span>
<a name="l01770"></a>01770 <span class="comment"> *</span>
<a name="l01771"></a>01771 <span class="comment"> *  - inode is marked dirty by iam_add_rec().</span>
<a name="l01772"></a>01772 <span class="comment"> *</span>
<a name="l01773"></a>01773 <span class="comment"> */</span>
<a name="l01774"></a>01774 
<a name="l01775"></a><a class="code" href="osd__iam_8c.html#a7a1789f8a2476656ad6fb477d01db48c">01775</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a7a1789f8a2476656ad6fb477d01db48c">iam_new_leaf</a>(handle_t *handle, <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf)
<a name="l01776"></a>01776 {
<a name="l01777"></a>01777         <span class="keywordtype">int</span> err;
<a name="l01778"></a>01778         <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> blknr;
<a name="l01779"></a>01779         <span class="keyword">struct </span>buffer_head   *new_leaf;
<a name="l01780"></a>01780         <span class="keyword">struct </span>buffer_head   *old_leaf;
<a name="l01781"></a>01781         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c;
<a name="l01782"></a>01782         <span class="keyword">struct </span>inode         *obj;
<a name="l01783"></a>01783         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a>      *path;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l01786"></a>01786 
<a name="l01787"></a>01787         c = <a class="code" href="osd__iam_8h.html#a8b6a48a770a730de61b3fb43d8572999">iam_leaf_container</a>(leaf);
<a name="l01788"></a>01788         path = leaf-&gt;<a class="code" href="structiam__leaf.html#a697c79bd22bbdbba1a763806ef593097">il_path</a>;
<a name="l01789"></a>01789 
<a name="l01790"></a>01790         obj = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l01791"></a>01791         new_leaf = <a class="code" href="osd__iam_8c.html#aa3ca8041f5851e4ffa008e7b130d5cf7">iam_new_node</a>(handle, c, &amp;blknr, &amp;err);
<a name="l01792"></a>01792         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01793"></a>01793         <span class="keywordflow">if</span> (new_leaf != NULL) {
<a name="l01794"></a>01794                 <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh;
<a name="l01795"></a>01795 
<a name="l01796"></a>01796                 lh = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(c, blknr, <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l01797"></a>01797                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01798"></a>01798                 <span class="keywordflow">if</span> (lh != NULL) {
<a name="l01799"></a>01799                         <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(leaf)-&gt;<a class="code" href="structiam__leaf__operations.html#af9b5558385fe83dad045aca6f7f99699">init_new</a>(c, new_leaf);
<a name="l01800"></a>01800                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01801"></a>01801                         old_leaf = leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>;
<a name="l01802"></a>01802                         <a class="code" href="osd__iam_8c.html#aef95469d7f0dfbbdd0069123cca1e8c2">iam_leaf_split</a>(leaf, &amp;new_leaf, blknr);
<a name="l01803"></a>01803                         <span class="keywordflow">if</span> (old_leaf != leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>) {
<a name="l01804"></a>01804                                 <span class="comment">/*</span>
<a name="l01805"></a>01805 <span class="comment">                                 * Switched to the new leaf.</span>
<a name="l01806"></a>01806 <span class="comment">                                 */</span>
<a name="l01807"></a>01807                                 <a class="code" href="osd__iam_8c.html#aab42a5cb61f756c1f6ab1bde5395d75c">iam_leaf_unlock</a>(leaf);
<a name="l01808"></a>01808                                 leaf-&gt;<a class="code" href="structiam__leaf.html#a8c1b2d7e8c5c5cb5408d03d1b22ab212">il_lock</a> = lh;
<a name="l01809"></a>01809                                 path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> = blknr;
<a name="l01810"></a>01810                         } <span class="keywordflow">else</span>
<a name="l01811"></a>01811                                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, lh);
<a name="l01812"></a>01812                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01813"></a>01813                         err = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(handle, path, new_leaf);
<a name="l01814"></a>01814                         <span class="keywordflow">if</span> (err == 0)
<a name="l01815"></a>01815                                 err = ldiskfs_mark_inode_dirty(handle, obj);
<a name="l01816"></a>01816                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01817"></a>01817                 } <span class="keywordflow">else</span>
<a name="l01818"></a>01818                         err = -ENOMEM;
<a name="l01819"></a>01819                 brelse(new_leaf);
<a name="l01820"></a>01820         }
<a name="l01821"></a>01821         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l01822"></a>01822         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(&amp;<a class="code" href="osd__iam_8h.html#af83ed0325a1a41254627530e40e925fb">iam_leaf_path</a>(leaf)-&gt;ip_leaf));
<a name="l01823"></a>01823         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(<a class="code" href="osd__iam_8h.html#af83ed0325a1a41254627530e40e925fb">iam_leaf_path</a>(leaf)));
<a name="l01824"></a>01824         <span class="keywordflow">return</span> err;
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01827"></a><a class="code" href="osd__iam_8c.html#aa6e2eae944b8d6e65fe9f6b58e9b2520">01827</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#aa6e2eae944b8d6e65fe9f6b58e9b2520">dx_set_limit</a>(<span class="keyword">struct</span> iam_entry *entries, <span class="keywordtype">unsigned</span> value)
<a name="l01828"></a>01828 {
<a name="l01829"></a>01829         ((<span class="keyword">struct </span><a class="code" href="structdx__countlimit.html">dx_countlimit</a> *) entries)-&gt;limit = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(value);
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01832"></a><a class="code" href="osd__iam_8c.html#ad07b23e27c15047bc51a506c6a177ee1">01832</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#ad07b23e27c15047bc51a506c6a177ee1">iam_shift_entries</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path,
<a name="l01833"></a>01833                          <span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *frame, <span class="keywordtype">unsigned</span> <a class="code" href="structdx__countlimit.html#ae0c881ec1d1c517052723cfcd9c25746">count</a>,
<a name="l01834"></a>01834                          <span class="keyword">struct</span> iam_entry *entries, <span class="keyword">struct</span> iam_entry *entries2,
<a name="l01835"></a>01835                          u32 newblock)
<a name="l01836"></a>01836 {
<a name="l01837"></a>01837         <span class="keywordtype">unsigned</span> count1;
<a name="l01838"></a>01838         <span class="keywordtype">unsigned</span> count2;
<a name="l01839"></a>01839         <span class="keywordtype">int</span> delta;
<a name="l01840"></a>01840 
<a name="l01841"></a>01841         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *parent = frame - 1;
<a name="l01842"></a>01842         <span class="keyword">struct </span>iam_ikey *pivot = <a class="code" href="osd__iam_8h.html#a95b1cb172d15f6e864bcfe03fd18da5f">iam_path_ikey</a>(path, 3);
<a name="l01843"></a>01843 
<a name="l01844"></a>01844         delta = <a class="code" href="osd__iam_8c.html#a391fdf43e3f6cb912b7765a5b5fbe4aa">dx_index_is_compat</a>(path) ? 0 : +1;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846         count1 = count/2 + delta;
<a name="l01847"></a>01847         count2 = count - count1;
<a name="l01848"></a>01848         <a class="code" href="osd__iam_8h.html#a0cfaccc96060d465f3b39540c4399ef5">dx_get_ikey</a>(path, <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries, count1), pivot);
<a name="l01849"></a>01849 
<a name="l01850"></a>01850         <a class="code" href="osd__iam_8h.html#a48a6e79bd4cd23a373f7555bcdc19a94">dxtrace</a>(<a class="code" href="libcfs__private_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;Split index %d/%d\n&quot;</span>, count1, count2));
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         memcpy((<span class="keywordtype">char</span> *) <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries2, delta),
<a name="l01853"></a>01853                (<span class="keywordtype">char</span> *) <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries, count1),
<a name="l01854"></a>01854                count2 * <a class="code" href="osd__iam_8h.html#a23d9f0aefa56ce04a383539e6ac3fc9f">iam_entry_size</a>(path));
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         <a class="code" href="osd__iam_8h.html#a5297cab8b16cd5d141e0c1846e15d1f8">dx_set_count</a>(entries2, count2 + delta);
<a name="l01857"></a>01857         <a class="code" href="osd__iam_8c.html#aa6e2eae944b8d6e65fe9f6b58e9b2520">dx_set_limit</a>(entries2, <a class="code" href="osd__iam_8h.html#ab2f20f839ddfc48e360f2afa753a08c1">dx_node_limit</a>(path));
<a name="l01858"></a>01858 
<a name="l01859"></a>01859         <span class="comment">/*</span>
<a name="l01860"></a>01860 <span class="comment">         * NOTE: very subtle piece of code competing dx_probe() may find 2nd</span>
<a name="l01861"></a>01861 <span class="comment">         * level index in root index, then we insert new index here and set</span>
<a name="l01862"></a>01862 <span class="comment">         * new count in that 2nd level index. so, dx_probe() may see 2nd level</span>
<a name="l01863"></a>01863 <span class="comment">         * index w/o hash it looks for. the solution is to check root index</span>
<a name="l01864"></a>01864 <span class="comment">         * after we locked just founded 2nd level index -bzzz</span>
<a name="l01865"></a>01865 <span class="comment">         */</span>
<a name="l01866"></a>01866         <a class="code" href="osd__iam_8c.html#af168cf550bf6461681004a0d8278710b">iam_insert_key_lock</a>(path, parent, pivot, newblock);
<a name="l01867"></a>01867 
<a name="l01868"></a>01868         <span class="comment">/*</span>
<a name="l01869"></a>01869 <span class="comment">         * now old and new 2nd level index blocks contain all pointers, so</span>
<a name="l01870"></a>01870 <span class="comment">         * dx_probe() may find it in the both.  it&apos;s OK -bzzz</span>
<a name="l01871"></a>01871 <span class="comment">         */</span>
<a name="l01872"></a>01872         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01873"></a>01873         <a class="code" href="osd__iam_8h.html#a5297cab8b16cd5d141e0c1846e15d1f8">dx_set_count</a>(entries, count1);
<a name="l01874"></a>01874         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01875"></a>01875 
<a name="l01876"></a>01876         <span class="comment">/*</span>
<a name="l01877"></a>01877 <span class="comment">         * now old 2nd level index block points to first half of leafs. it&apos;s</span>
<a name="l01878"></a>01878 <span class="comment">         * importand that dx_probe() must check root index block for changes</span>
<a name="l01879"></a>01879 <span class="comment">         * under dx_lock_bh(frame-&gt;bh) -bzzz</span>
<a name="l01880"></a>01880 <span class="comment">         */</span>
<a name="l01881"></a>01881 
<a name="l01882"></a>01882         <span class="keywordflow">return</span> count1;
<a name="l01883"></a>01883 }
<a name="l01884"></a>01884 
<a name="l01885"></a>01885 
<a name="l01886"></a><a class="code" href="osd__iam_8h.html#a74101d055d12deede6ed7f0c35b44056">01886</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a74101d055d12deede6ed7f0c35b44056">split_index_node</a>(handle_t *handle, <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path,
<a name="l01887"></a>01887                      <span class="keyword">struct</span> <a class="code" href="structdynlock__handle.html">dynlock_handle</a> **lh)
<a name="l01888"></a>01888 {
<a name="l01889"></a>01889 
<a name="l01890"></a>01890         <span class="keyword">struct </span>iam_entry *entries;   <span class="comment">/* old block contents */</span>
<a name="l01891"></a>01891         <span class="keyword">struct </span>iam_entry *entries2;  <span class="comment">/* new block contents */</span>
<a name="l01892"></a>01892         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *frame, *safe;
<a name="l01893"></a>01893         <span class="keyword">struct </span>buffer_head *bh_new[<a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>] = {NULL};
<a name="l01894"></a>01894         u32 newblock[<a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>] = {0};
<a name="l01895"></a>01895         <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lock[<a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>] = {NULL,};
<a name="l01896"></a>01896         <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *new_lock[<a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>] = {NULL,};
<a name="l01897"></a>01897         <span class="keyword">struct </span>inode *<a class="code" href="mmap__sanity_8c.html#a73da71b9c136e698a3ccaa1366e455a8">dir</a> = <a class="code" href="osd__iam_8h.html#a57e5447b6d363bd74838b2be2bc93fbd">iam_path_obj</a>(path);
<a name="l01898"></a>01898         <span class="keyword">struct </span><a class="code" href="structiam__descr.html">iam_descr</a> *descr;
<a name="l01899"></a>01899         <span class="keywordtype">int</span> nr_splet;
<a name="l01900"></a>01900         <span class="keywordtype">int</span> i, err;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         descr = <a class="code" href="osd__iam_8h.html#a9863c0b0490035155ea07fe34be961c0">iam_path_descr</a>(path);
<a name="l01903"></a>01903         <span class="comment">/*</span>
<a name="l01904"></a>01904 <span class="comment">         * Algorithm below depends on this.</span>
<a name="l01905"></a>01905 <span class="comment">         */</span>
<a name="l01906"></a>01906         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a2f03e458ab275c0359c4f004251746db">dx_root_limit</a>(path) &lt; <a class="code" href="osd__iam_8h.html#ab2f20f839ddfc48e360f2afa753a08c1">dx_node_limit</a>(path));
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         frame = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>;
<a name="l01909"></a>01909         entries = frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>;
<a name="l01910"></a>01910 
<a name="l01911"></a>01911         <span class="comment">/*</span>
<a name="l01912"></a>01912 <span class="comment">         * Tall-tree handling: we might have to split multiple index blocks</span>
<a name="l01913"></a>01913 <span class="comment">         * all the way up to tree root. Tricky point here is error handling:</span>
<a name="l01914"></a>01914 <span class="comment">         * to avoid complicated undo/rollback we</span>
<a name="l01915"></a>01915 <span class="comment">         *</span>
<a name="l01916"></a>01916 <span class="comment">         *   - first allocate all necessary blocks</span>
<a name="l01917"></a>01917 <span class="comment">         *</span>
<a name="l01918"></a>01918 <span class="comment">         *   - insert pointers into them atomically.</span>
<a name="l01919"></a>01919 <span class="comment">         */</span>
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <span class="comment">/*</span>
<a name="l01922"></a>01922 <span class="comment">         * Locking: leaf is already locked. htree-locks are acquired on all</span>
<a name="l01923"></a>01923 <span class="comment">         * index nodes that require split bottom-to-top, on the &quot;safe&quot; node,</span>
<a name="l01924"></a>01924 <span class="comment">         * and on all new nodes</span>
<a name="l01925"></a>01925 <span class="comment">         */</span>
<a name="l01926"></a>01926 
<a name="l01927"></a>01927         <a class="code" href="osd__iam_8h.html#a48a6e79bd4cd23a373f7555bcdc19a94">dxtrace</a>(<a class="code" href="libcfs__private_8h.html#a92c0fd9bbafd520c7435afb41b1f1e65">printk</a>(<span class="stringliteral">&quot;using %u of %u node entries\n&quot;</span>,
<a name="l01928"></a>01928                        <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(entries), <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(entries)));
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <span class="comment">/* What levels need split? */</span>
<a name="l01931"></a>01931         <span class="keywordflow">for</span> (nr_splet = 0; frame &gt;= path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a> &amp;&amp;
<a name="l01932"></a>01932              <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>) == <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>);
<a name="l01933"></a>01933              --frame, ++nr_splet) {
<a name="l01934"></a>01934                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01935"></a>01935                 <span class="keywordflow">if</span> (nr_splet == <a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a>) {
<a name="l01936"></a>01936                         <span class="comment">/*</span>
<a name="l01937"></a>01937 <span class="comment">                        CWARN(dir-&gt;i_sb, __FUNCTION__,</span>
<a name="l01938"></a>01938 <span class="comment">                                     &quot;Directory index full!\n&quot;);</span>
<a name="l01939"></a>01939 <span class="comment">                                     */</span>
<a name="l01940"></a>01940                         err = -ENOSPC;
<a name="l01941"></a>01941                         <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01942"></a>01942                 }
<a name="l01943"></a>01943         }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         safe = frame;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947         <span class="comment">/*</span>
<a name="l01948"></a>01948 <span class="comment">         * Lock all nodes, bottom to top.</span>
<a name="l01949"></a>01949 <span class="comment">         */</span>
<a name="l01950"></a>01950         <span class="keywordflow">for</span> (frame = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>, i = nr_splet; i &gt;= 0; --i, --frame) {
<a name="l01951"></a>01951                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01952"></a>01952                 lock[i] = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, frame-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a>,
<a name="l01953"></a>01953                                          <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l01954"></a>01954                 <span class="keywordflow">if</span> (lock[i] == NULL) {
<a name="l01955"></a>01955                         err = -ENOMEM;
<a name="l01956"></a>01956                         <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01957"></a>01957                 }
<a name="l01958"></a>01958         }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960         <span class="comment">/*</span>
<a name="l01961"></a>01961 <span class="comment">         * Check for concurrent index modification.</span>
<a name="l01962"></a>01962 <span class="comment">         */</span>
<a name="l01963"></a>01963         err = <a class="code" href="osd__iam_8c.html#ad877f6c2f100b02691e170c64fc6ce4b">iam_check_full_path</a>(path, 1);
<a name="l01964"></a>01964         <span class="keywordflow">if</span> (err)
<a name="l01965"></a>01965                 <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01966"></a>01966         <span class="comment">/*</span>
<a name="l01967"></a>01967 <span class="comment">         * And check that the same number of nodes is to be split.</span>
<a name="l01968"></a>01968 <span class="comment">         */</span>
<a name="l01969"></a>01969         <span class="keywordflow">for</span> (i = 0, frame = path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>; frame &gt;= path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a> &amp;&amp;
<a name="l01970"></a>01970              <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>) == <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>);
<a name="l01971"></a>01971              --frame, ++i) {
<a name="l01972"></a>01972                 ;
<a name="l01973"></a>01973         }
<a name="l01974"></a>01974         <span class="keywordflow">if</span> (i != nr_splet) {
<a name="l01975"></a>01975                 err = -EAGAIN;
<a name="l01976"></a>01976                 <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01977"></a>01977         }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979         <span class="comment">/* Go back down, allocating blocks, locking them, and adding into</span>
<a name="l01980"></a>01980 <span class="comment">         * transaction... */</span>
<a name="l01981"></a>01981         <span class="keywordflow">for</span> (frame = safe + 1, i = 0; i &lt; nr_splet; ++i, ++frame) {
<a name="l01982"></a>01982                 bh_new[i] = <a class="code" href="osd__iam_8c.html#aa3ca8041f5851e4ffa008e7b130d5cf7">iam_new_node</a>(handle, path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>,
<a name="l01983"></a>01983                                          &amp;newblock[i], &amp;err);
<a name="l01984"></a>01984                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01985"></a>01985                 <span class="keywordflow">if</span> (!bh_new[i] ||
<a name="l01986"></a>01986                     descr-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a7f022922e8db1688e9ba182d706b2ec1">id_node_init</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>,
<a name="l01987"></a>01987                                                 bh_new[i], 0) != 0)
<a name="l01988"></a>01988                         <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01989"></a>01989                 new_lock[i] = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, newblock[i],
<a name="l01990"></a>01990                                              <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l01991"></a>01991                 <span class="keywordflow">if</span> (new_lock[i] == NULL) {
<a name="l01992"></a>01992                         err = -ENOMEM;
<a name="l01993"></a>01993                         <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l01994"></a>01994                 }
<a name="l01995"></a>01995                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l01996"></a>01996                 BUFFER_TRACE(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>, <span class="stringliteral">&quot;get_write_access&quot;</span>);
<a name="l01997"></a>01997                 err = ldiskfs_journal_get_write_access(handle, frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l01998"></a>01998                 <span class="keywordflow">if</span> (err)
<a name="l01999"></a>01999                         <span class="keywordflow">goto</span> journal_error;
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001         <span class="comment">/* Add &quot;safe&quot; node to transaction too */</span>
<a name="l02002"></a>02002         <span class="keywordflow">if</span> (safe + 1 != path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>) {
<a name="l02003"></a>02003                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02004"></a>02004                 err = ldiskfs_journal_get_write_access(handle, safe-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02005"></a>02005                 <span class="keywordflow">if</span> (err)
<a name="l02006"></a>02006                         <span class="keywordflow">goto</span> journal_error;
<a name="l02007"></a>02007         }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009         <span class="comment">/* Go through nodes once more, inserting pointers */</span>
<a name="l02010"></a>02010         <span class="keywordflow">for</span> (frame = safe + 1, i = 0; i &lt; nr_splet; ++i, ++frame) {
<a name="l02011"></a>02011                 <span class="keywordtype">unsigned</span> count;
<a name="l02012"></a>02012                 <span class="keywordtype">int</span> idx;
<a name="l02013"></a>02013                 <span class="keyword">struct </span>buffer_head *bh2;
<a name="l02014"></a>02014                 <span class="keyword">struct </span>buffer_head *bh;
<a name="l02015"></a>02015 
<a name="l02016"></a>02016                 entries = frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>;
<a name="l02017"></a>02017                 count = <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(entries);
<a name="l02018"></a>02018                 idx = <a class="code" href="osd__iam_8h.html#a9296bb2f812475a35b79e9835bd1d4d3">iam_entry_diff</a>(path, frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, entries);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020                 bh2 = bh_new[i];
<a name="l02021"></a>02021                 entries2 = <a class="code" href="osd__iam_8h.html#a3e2a1808861e3025221904d05ead00d3">dx_get_entries</a>(path, bh2-&gt;b_data, 0);
<a name="l02022"></a>02022 
<a name="l02023"></a>02023                 bh = frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>;
<a name="l02024"></a>02024                 <span class="keywordflow">if</span> (frame == path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>) {
<a name="l02025"></a>02025                         <span class="comment">/* splitting root node. Tricky point:</span>
<a name="l02026"></a>02026 <span class="comment">                         *</span>
<a name="l02027"></a>02027 <span class="comment">                         * In the &quot;normal&quot; B-tree we&apos;d split root *and* add</span>
<a name="l02028"></a>02028 <span class="comment">                         * new root to the tree with pointers to the old root</span>
<a name="l02029"></a>02029 <span class="comment">                         * and its sibling (thus introducing two new nodes).</span>
<a name="l02030"></a>02030 <span class="comment">                         *</span>
<a name="l02031"></a>02031 <span class="comment">                         * In htree it&apos;s enough to add one node, because</span>
<a name="l02032"></a>02032 <span class="comment">                         * capacity of the root node is smaller than that of</span>
<a name="l02033"></a>02033 <span class="comment">                         * non-root one.</span>
<a name="l02034"></a>02034 <span class="comment">                         */</span>
<a name="l02035"></a>02035                         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *frames;
<a name="l02036"></a>02036                         <span class="keyword">struct </span>iam_entry *next;
<a name="l02037"></a>02037 
<a name="l02038"></a>02038                         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(i == 0);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02041"></a>02041 
<a name="l02042"></a>02042                         frames = path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>;
<a name="l02043"></a>02043                         memcpy((<span class="keywordtype">char</span> *) entries2, (<span class="keywordtype">char</span> *) entries,
<a name="l02044"></a>02044                                count * <a class="code" href="osd__iam_8h.html#a23d9f0aefa56ce04a383539e6ac3fc9f">iam_entry_size</a>(path));
<a name="l02045"></a>02045                         <a class="code" href="osd__iam_8c.html#aa6e2eae944b8d6e65fe9f6b58e9b2520">dx_set_limit</a>(entries2, <a class="code" href="osd__iam_8h.html#ab2f20f839ddfc48e360f2afa753a08c1">dx_node_limit</a>(path));
<a name="l02046"></a>02046 
<a name="l02047"></a>02047                         <span class="comment">/* Set up root */</span>
<a name="l02048"></a>02048                           <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02049"></a>02049                         next = descr-&gt;<a class="code" href="structiam__descr.html#a787056febee9a53ec7bc8032d5fa68f3">id_ops</a>-&gt;<a class="code" href="structiam__operations.html#a0a3c62b84c0a452426df6d8df46ac52d">id_root_inc</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>,
<a name="l02050"></a>02050                                                           path, frame);
<a name="l02051"></a>02051                         <a class="code" href="osd__iam_8h.html#afc3410f42cbf2ddf838a046e4ed2d502">dx_set_block</a>(path, next, newblock[0]);
<a name="l02052"></a>02052                           <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02053"></a>02053 
<a name="l02054"></a>02054                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02055"></a>02055                         <span class="comment">/* Shift frames in the path */</span>
<a name="l02056"></a>02056                         memmove(frames + 2, frames + 1,
<a name="l02057"></a>02057                                 (<span class="keyword">sizeof</span> path-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>) - 2 * <span class="keyword">sizeof</span> frames[0]);
<a name="l02058"></a>02058                         <span class="comment">/* Add new access path frame */</span>
<a name="l02059"></a>02059                         frames[1].<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries2, idx);
<a name="l02060"></a>02060                         frames[1].<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a> = entries = entries2;
<a name="l02061"></a>02061                         frames[1].<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> = bh2;
<a name="l02062"></a>02062                         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l02063"></a>02063                         ++ path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>;
<a name="l02064"></a>02064                         ++ frame;
<a name="l02065"></a>02065                         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l02066"></a>02066                         bh_new[0] = NULL; <span class="comment">/* buffer head is &quot;consumed&quot; */</span>
<a name="l02067"></a>02067                         err = ldiskfs_handle_dirty_metadata(handle, NULL, bh2);
<a name="l02068"></a>02068                         <span class="keywordflow">if</span> (err)
<a name="l02069"></a>02069                                 <span class="keywordflow">goto</span> journal_error;
<a name="l02070"></a>02070                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02071"></a>02071                 } <span class="keywordflow">else</span> {
<a name="l02072"></a>02072                         <span class="comment">/* splitting non-root index node. */</span>
<a name="l02073"></a>02073                         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *parent = frame - 1;
<a name="l02074"></a>02074 
<a name="l02075"></a>02075                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02076"></a>02076                         count = <a class="code" href="osd__iam_8c.html#ad07b23e27c15047bc51a506c6a177ee1">iam_shift_entries</a>(path, frame, count,
<a name="l02077"></a>02077                                               entries, entries2, newblock[i]);
<a name="l02078"></a>02078                         <span class="comment">/* Which index block gets the new entry? */</span>
<a name="l02079"></a>02079                         <span class="keywordflow">if</span> (idx &gt;= count) {
<a name="l02080"></a>02080                                 <span class="keywordtype">int</span> d = <a class="code" href="osd__iam_8c.html#a391fdf43e3f6cb912b7765a5b5fbe4aa">dx_index_is_compat</a>(path) ? 0 : +1;
<a name="l02081"></a>02081 
<a name="l02082"></a>02082                                 frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path, entries2,
<a name="l02083"></a>02083                                                             idx - count + d);
<a name="l02084"></a>02084                                 frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a> = entries = entries2;
<a name="l02085"></a>02085                                 frame-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a> = newblock[i];
<a name="l02086"></a>02086                                 <a class="code" href="osd__iam_8h.html#a369180e5e0a23addbc2a6a9e24fee590">swap</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>, bh2);
<a name="l02087"></a>02087                                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(lock[i + 1] != NULL);
<a name="l02088"></a>02088                                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(new_lock[i] != NULL);
<a name="l02089"></a>02089                                 <a class="code" href="osd__iam_8h.html#a369180e5e0a23addbc2a6a9e24fee590">swap</a>(lock[i + 1], new_lock[i]);
<a name="l02090"></a>02090                                 bh_new[i] = bh2;
<a name="l02091"></a>02091                                 parent-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(path,
<a name="l02092"></a>02092                                                              parent-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, +1);
<a name="l02093"></a>02093                         }
<a name="l02094"></a>02094                         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, frame));
<a name="l02095"></a>02095                         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(dx_node_check(path, parent));
<a name="l02096"></a>02096                         <a class="code" href="osd__iam_8h.html#a48a6e79bd4cd23a373f7555bcdc19a94">dxtrace</a>(dx_show_index (<span class="stringliteral">&quot;node&quot;</span>, frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>));
<a name="l02097"></a>02097                         <a class="code" href="osd__iam_8h.html#a48a6e79bd4cd23a373f7555bcdc19a94">dxtrace</a>(dx_show_index (<span class="stringliteral">&quot;node&quot;</span>,
<a name="l02098"></a>02098                                ((<span class="keyword">struct</span> <a class="code" href="structdx__node.html">dx_node</a> *) bh2-&gt;b_data)-&gt;entries));
<a name="l02099"></a>02099                         err = ldiskfs_handle_dirty_metadata(handle, NULL, bh2);
<a name="l02100"></a>02100                         <span class="keywordflow">if</span> (err)
<a name="l02101"></a>02101                                 <span class="keywordflow">goto</span> journal_error;
<a name="l02102"></a>02102                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02103"></a>02103                         err = ldiskfs_handle_dirty_metadata(handle, NULL,
<a name="l02104"></a>02104                                                             parent-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02105"></a>02105                         <span class="keywordflow">if</span> (err)
<a name="l02106"></a>02106                                 <span class="keywordflow">goto</span> journal_error;
<a name="l02107"></a>02107                 }
<a name="l02108"></a>02108                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02109"></a>02109                 err = ldiskfs_handle_dirty_metadata(handle, NULL, bh);
<a name="l02110"></a>02110                 <span class="keywordflow">if</span> (err)
<a name="l02111"></a>02111                         <span class="keywordflow">goto</span> journal_error;
<a name="l02112"></a>02112         }
<a name="l02113"></a>02113                 <span class="comment">/*</span>
<a name="l02114"></a>02114 <span class="comment">                 * This function was called to make insertion of new leaf</span>
<a name="l02115"></a>02115 <span class="comment">                 * possible. Check that it fulfilled its obligations.</span>
<a name="l02116"></a>02116 <span class="comment">                 */</span>
<a name="l02117"></a>02117                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>) &lt;
<a name="l02118"></a>02118                             <a class="code" href="osd__iam_8h.html#ae6ea380d35fb86b80afd18215ea3c513">dx_get_limit</a>(path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>));
<a name="l02119"></a>02119         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(lock[nr_splet] != NULL);
<a name="l02120"></a>02120         *lh = lock[nr_splet];
<a name="l02121"></a>02121         lock[nr_splet] = NULL;
<a name="l02122"></a>02122         <span class="keywordflow">if</span> (nr_splet &gt; 0) {
<a name="l02123"></a>02123                 <span class="comment">/*</span>
<a name="l02124"></a>02124 <span class="comment">                 * Log -&gt;i_size modification.</span>
<a name="l02125"></a>02125 <span class="comment">                 */</span>
<a name="l02126"></a>02126                 err = ldiskfs_mark_inode_dirty(handle, dir);
<a name="l02127"></a>02127                 <span class="keywordflow">if</span> (err)
<a name="l02128"></a>02128                         <span class="keywordflow">goto</span> journal_error;
<a name="l02129"></a>02129         }
<a name="l02130"></a>02130         <span class="keywordflow">goto</span> <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>;
<a name="l02131"></a>02131 journal_error:
<a name="l02132"></a>02132         ldiskfs_std_error(dir-&gt;i_sb, err);
<a name="l02133"></a>02133 
<a name="l02134"></a>02134 <a class="code" href="fsx_8c.html#aa79b2985b495e6db8bf7675d0a32c3c5">cleanup</a>:
<a name="l02135"></a>02135         <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, lock);
<a name="l02136"></a>02136         <a class="code" href="osd__iam_8c.html#abd685d1cf0a148148a587f7fcd9cd149">iam_unlock_array</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, new_lock);
<a name="l02137"></a>02137 
<a name="l02138"></a>02138         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(err || <a class="code" href="osd__iam_8h.html#a51cc0e1aa1126ed8897e130ac196f463">iam_frame_is_locked</a>(path, path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>));
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02141"></a>02141         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(bh_new); ++i) {
<a name="l02142"></a>02142                 <span class="keywordflow">if</span> (bh_new[i] != NULL)
<a name="l02143"></a>02143                         brelse(bh_new[i]);
<a name="l02144"></a>02144         }
<a name="l02145"></a>02145         <span class="keywordflow">return</span> err;
<a name="l02146"></a>02146 }
<a name="l02147"></a>02147 
<a name="l02148"></a><a class="code" href="osd__iam_8c.html#a361d823a7f504cda7edc295759efa955">02148</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a361d823a7f504cda7edc295759efa955">iam_add_rec</a>(handle_t *handle, <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l02149"></a>02149                        <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *path,
<a name="l02150"></a>02150                        <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k, <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r)
<a name="l02151"></a>02151 {
<a name="l02152"></a>02152         <span class="keywordtype">int</span> err;
<a name="l02153"></a>02153         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf;
<a name="l02154"></a>02154 
<a name="l02155"></a>02155         leaf = &amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l02156"></a>02156         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l02157"></a>02157         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l02158"></a>02158         err = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(handle, path, leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l02159"></a>02159         <span class="keywordflow">if</span> (err == 0) {
<a name="l02160"></a>02160                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02161"></a>02161                 <span class="keywordflow">if</span> (!<a class="code" href="osd__iam_8c.html#ad7afba510c9c0bb887dcaaac236ecf84">iam_leaf_can_add</a>(leaf, k, r)) {
<a name="l02162"></a>02162                         <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh = NULL;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164                         <span class="keywordflow">do</span> {
<a name="l02165"></a>02165                                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(lh == NULL);
<a name="l02166"></a>02166                                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02167"></a>02167                                 err = <a class="code" href="osd__iam_8c.html#a74101d055d12deede6ed7f0c35b44056">split_index_node</a>(handle, path, &amp;lh);
<a name="l02168"></a>02168                                 <span class="keywordflow">if</span> (err == -EAGAIN) {
<a name="l02169"></a>02169                                         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(lh == NULL);
<a name="l02170"></a>02170 
<a name="l02171"></a>02171                                         <a class="code" href="osd__iam_8c.html#a1bd74b20cfb72d6cc7373ebc631f882e">iam_path_fini</a>(path);
<a name="l02172"></a>02172                                         it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>;
<a name="l02173"></a>02173 
<a name="l02174"></a>02174                                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02175"></a>02175                                         err = <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(it, k);
<a name="l02176"></a>02176                                         <span class="keywordflow">if</span> (err == -ENOENT)
<a name="l02177"></a>02177                                                 err = +1; <span class="comment">/* repeat split */</span>
<a name="l02178"></a>02178                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == 0)
<a name="l02179"></a>02179                                                 err = -EEXIST;
<a name="l02180"></a>02180                                 }
<a name="l02181"></a>02181                         } <span class="keywordflow">while</span> (err &gt; 0);
<a name="l02182"></a>02182                         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l02183"></a>02183                         <span class="keywordflow">if</span> (err == 0) {
<a name="l02184"></a>02184                                 <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(lh != NULL);
<a name="l02185"></a>02185                                 <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02186"></a>02186                                 err = <a class="code" href="osd__iam_8c.html#a7a1789f8a2476656ad6fb477d01db48c">iam_new_leaf</a>(handle, leaf);
<a name="l02187"></a>02187                                 <span class="keywordflow">if</span> (err == 0)
<a name="l02188"></a>02188                                         err = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(handle, path,
<a name="l02189"></a>02189                                                             path-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02190"></a>02190                         }
<a name="l02191"></a>02191                         <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(path-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>, lh);
<a name="l02192"></a>02192                         <a class="code" href="osd__iam_8h.html#aeafefef605fbcd0120d60828a43074de">do_corr</a>(schedule());
<a name="l02193"></a>02193                 }
<a name="l02194"></a>02194                 <span class="keywordflow">if</span> (err == 0) {
<a name="l02195"></a>02195                         <a class="code" href="osd__iam_8c.html#ac2a300ed0c4cbe1cae9617b64f8ba8ba">iam_leaf_rec_add</a>(leaf, k, r);
<a name="l02196"></a>02196                         err = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(handle, path, leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l02197"></a>02197                 }
<a name="l02198"></a>02198         }
<a name="l02199"></a>02199         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l02200"></a>02200         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(&amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>));
<a name="l02201"></a>02201         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l02202"></a>02202         <span class="keywordflow">return</span> err;
<a name="l02203"></a>02203 }
<a name="l02204"></a>02204 
<a name="l02205"></a>02205 <span class="comment">/*</span>
<a name="l02206"></a>02206 <span class="comment"> * Insert new record with key @k and contents from @r, shifting records to the</span>
<a name="l02207"></a>02207 <span class="comment"> * right. On success, iterator is positioned on the newly inserted record.</span>
<a name="l02208"></a>02208 <span class="comment"> *</span>
<a name="l02209"></a>02209 <span class="comment"> * precondition: it-&gt;ii_flags&amp;IAM_IT_WRITE &amp;&amp;</span>
<a name="l02210"></a>02210 <span class="comment"> *               (it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l02211"></a>02211 <span class="comment"> *                it_state(it) == IAM_IT_SKEWED) &amp;&amp;</span>
<a name="l02212"></a>02212 <span class="comment"> *               ergo(it_state(it) == IAM_IT_ATTACHED,</span>
<a name="l02213"></a>02213 <span class="comment"> *                    it_keycmp(it, k) &lt;= 0) &amp;&amp;</span>
<a name="l02214"></a>02214 <span class="comment"> *               ergo(it_before(it), it_keycmp(it, k) &gt; 0));</span>
<a name="l02215"></a>02215 <span class="comment"> * postcondition: ergo(result == 0,</span>
<a name="l02216"></a>02216 <span class="comment"> *                     it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l02217"></a>02217 <span class="comment"> *                     it_keycmp(it, k) == 0 &amp;&amp;</span>
<a name="l02218"></a>02218 <span class="comment"> *                     !memcmp(iam_it_rec_get(it), r, ...))</span>
<a name="l02219"></a>02219 <span class="comment"> */</span>
<a name="l02220"></a><a class="code" href="osd__iam_8h.html#a485ef7f7c8a2172fd44301a07124b909">02220</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a485ef7f7c8a2172fd44301a07124b909">iam_it_rec_insert</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it,
<a name="l02221"></a>02221                       <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k, <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r)
<a name="l02222"></a>02222 {
<a name="l02223"></a>02223         <span class="keywordtype">int</span> result;
<a name="l02224"></a>02224         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a> *path;
<a name="l02225"></a>02225 
<a name="l02226"></a>02226         path = &amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>;
<a name="l02227"></a>02227 
<a name="l02228"></a>02228         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>);
<a name="l02229"></a>02229         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l02230"></a>02230                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>);
<a name="l02231"></a>02231         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>,
<a name="l02232"></a>02232                          <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(it, k) &lt;= 0));
<a name="l02233"></a>02233         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(<a class="code" href="osd__iam_8c.html#ab3199edf371c72e25185abf229c278ac">it_before</a>(it), <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(it, k) &gt; 0));
<a name="l02234"></a>02234         result = <a class="code" href="osd__iam_8c.html#a361d823a7f504cda7edc295759efa955">iam_add_rec</a>(h, it, path, k, r);
<a name="l02235"></a>02235         <span class="keywordflow">if</span> (result == 0)
<a name="l02236"></a>02236                 it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> = <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>;
<a name="l02237"></a>02237         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(result == 0,
<a name="l02238"></a>02238                          <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> &amp;&amp;
<a name="l02239"></a>02239                          <a class="code" href="osd__iam_8c.html#ae1e792f3566ef93029864b6ba8ef58f6">it_keycmp</a>(it, k) == 0));
<a name="l02240"></a>02240         <span class="keywordflow">return</span> result;
<a name="l02241"></a>02241 }
<a name="l02242"></a>02242 
<a name="l02243"></a><a class="code" href="osd__iam_8c.html#a6d214b3db1ac222524c0a0c0d300e773">02243</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a6d214b3db1ac222524c0a0c0d300e773">iam_idle_blocks_limit</a>(<span class="keyword">struct</span> inode *inode)
<a name="l02244"></a>02244 {
<a name="l02245"></a>02245         <span class="keywordflow">return</span> (inode-&gt;i_sb-&gt;s_blocksize - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structiam__idle__head.html">iam_idle_head</a>)) &gt;&gt; 2;
<a name="l02246"></a>02246 }
<a name="l02247"></a>02247 
<a name="l02248"></a>02248 <span class="comment">/*</span>
<a name="l02249"></a>02249 <span class="comment"> * If the leaf cannnot be recycled, we will lose one block for reusing.</span>
<a name="l02250"></a>02250 <span class="comment"> * It is not a serious issue because it almost the same of non-recycle.</span>
<a name="l02251"></a>02251 <span class="comment"> */</span>
<a name="l02252"></a><a class="code" href="osd__iam_8c.html#ab8d2a715a38aa9da67ac72bb35bc9be7">02252</a> <span class="keyword">static</span> <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> <a class="code" href="osd__iam_8c.html#ab8d2a715a38aa9da67ac72bb35bc9be7">iam_index_shrink</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p,
<a name="l02253"></a>02253                                   <span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *l, <span class="keyword">struct</span> buffer_head **bh)
<a name="l02254"></a>02254 {
<a name="l02255"></a>02255         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c = p-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l02256"></a>02256         <span class="keyword">struct </span>inode *inode = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l02257"></a>02257         <span class="keyword">struct </span><a class="code" href="structiam__frame.html">iam_frame</a> *frame = p-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a>;
<a name="l02258"></a>02258         <span class="keyword">struct </span>iam_entry *entries;
<a name="l02259"></a>02259         <span class="keyword">struct </span>iam_entry *pos;
<a name="l02260"></a>02260         <span class="keyword">struct </span><a class="code" href="structdynlock__handle.html">dynlock_handle</a> *lh;
<a name="l02261"></a>02261         <span class="keywordtype">int</span> count;
<a name="l02262"></a>02262         <span class="keywordtype">int</span> rc;
<a name="l02263"></a>02263 
<a name="l02264"></a>02264         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structiam__container.html#a62e3cc423e725203de906903ae875e7f">ic_idle_failed</a>)
<a name="l02265"></a>02265                 <span class="keywordflow">return</span> 0;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(frame == NULL))
<a name="l02268"></a>02268                 <span class="keywordflow">return</span> 0;
<a name="l02269"></a>02269 
<a name="l02270"></a>02270         <span class="keywordflow">if</span> (!<a class="code" href="osd__iam_8c.html#af8e663c168a5c2c93be7ecb57f4e36db">iam_leaf_empty</a>(l))
<a name="l02271"></a>02271                 <span class="keywordflow">return</span> 0;
<a name="l02272"></a>02272 
<a name="l02273"></a>02273         lh = <a class="code" href="osd__iam_8c.html#aee9df49e73ed580a2b1f1d1d21953649">iam_lock_htree</a>(c, frame-&gt;<a class="code" href="structiam__frame.html#a16b02963aa48c6720da17e886a349d66">curidx</a>, <a class="code" href="osd__dynlocks_8h.html#a2965700a02be69cd5a2339f3d4b289f8aace42992de4c44dbab812f2f0ee5d8b4">DLT_WRITE</a>);
<a name="l02274"></a>02274         <span class="keywordflow">if</span> (lh == NULL) {
<a name="l02275"></a>02275                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%.16s: No memory to recycle idle blocks\n&quot;</span>,
<a name="l02276"></a>02276                       LDISKFS_SB(inode-&gt;i_sb)-&gt;s_es-&gt;s_volume_name);
<a name="l02277"></a>02277                 <span class="keywordflow">return</span> 0;
<a name="l02278"></a>02278         }
<a name="l02279"></a>02279 
<a name="l02280"></a>02280         rc = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(h, p, frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02281"></a>02281         <span class="keywordflow">if</span> (rc != 0) {
<a name="l02282"></a>02282                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(c, lh);
<a name="l02283"></a>02283                 <span class="keywordflow">return</span> 0;
<a name="l02284"></a>02284         }
<a name="l02285"></a>02285 
<a name="l02286"></a>02286         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02287"></a>02287         entries = frame-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>;
<a name="l02288"></a>02288         count = <a class="code" href="osd__iam_8h.html#a0f2b8e89b82fc91918a3ca89f6bf15d5">dx_get_count</a>(entries);
<a name="l02289"></a>02289         <span class="comment">/* NOT shrink the last entry in the index node, which can be reused</span>
<a name="l02290"></a>02290 <span class="comment">         * directly by next new node. */</span>
<a name="l02291"></a>02291         <span class="keywordflow">if</span> (count == 2) {
<a name="l02292"></a>02292                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02293"></a>02293                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(c, lh);
<a name="l02294"></a>02294                 <span class="keywordflow">return</span> 0;
<a name="l02295"></a>02295         }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297         pos = <a class="code" href="osd__iam_8c.html#a5cf3d2f7f72b0416fa45b17c494bfc39">iam_find_position</a>(p, frame);
<a name="l02298"></a>02298         <span class="comment">/* There may be some new leaf nodes have been added or empty leaf nodes</span>
<a name="l02299"></a>02299 <span class="comment">         * have been shrinked during my delete operation.</span>
<a name="l02300"></a>02300 <span class="comment">         *</span>
<a name="l02301"></a>02301 <span class="comment">         * If the empty leaf is not under current index node because the index</span>
<a name="l02302"></a>02302 <span class="comment">         * node has been split, then just skip the empty leaf, which is rare. */</span>
<a name="l02303"></a>02303         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(frame-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a> != <a class="code" href="osd__iam_8h.html#a11763cbe60107952bf7ce954b77fa090">dx_get_block</a>(p, pos))) {
<a name="l02304"></a>02304                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02305"></a>02305                 <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(c, lh);
<a name="l02306"></a>02306                 <span class="keywordflow">return</span> 0;
<a name="l02307"></a>02307         }
<a name="l02308"></a>02308 
<a name="l02309"></a>02309         frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> = pos;
<a name="l02310"></a>02310         <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a> &lt; <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(p, entries, count - 1)) {
<a name="l02311"></a>02311                 <span class="keyword">struct </span>iam_entry *n = <a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(p, frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, 1);
<a name="l02312"></a>02312 
<a name="l02313"></a>02313                 memmove(frame-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>, n,
<a name="l02314"></a>02314                         (<span class="keywordtype">char</span> *)<a class="code" href="osd__iam_8h.html#a4e22d740cfb87fc2328cf552c2f7e893">iam_entry_shift</a>(p, entries, count) - (<span class="keywordtype">char</span> *)n);
<a name="l02315"></a>02315                 frame-&gt;<a class="code" href="structiam__frame.html#ab52473c2d49f64e28edf64f629949a3b">at_shifted</a> = 1;
<a name="l02316"></a>02316         }
<a name="l02317"></a>02317         <a class="code" href="osd__iam_8h.html#a5297cab8b16cd5d141e0c1846e15d1f8">dx_set_count</a>(entries, count - 1);
<a name="l02318"></a>02318         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02319"></a>02319         rc = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, p, frame-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>);
<a name="l02320"></a>02320         <a class="code" href="osd__iam_8c.html#a2816c62d45446a3de24f1ae8b6ee14f1">iam_unlock_htree</a>(c, lh);
<a name="l02321"></a>02321         <span class="keywordflow">if</span> (rc != 0)
<a name="l02322"></a>02322                 <span class="keywordflow">return</span> 0;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324         get_bh(l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l02325"></a>02325         *bh = l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>;
<a name="l02326"></a>02326         <span class="keywordflow">return</span> frame-&gt;<a class="code" href="structiam__frame.html#a43ecbabb071ac76f1056f07b2c4a3aa4">leaf</a>;
<a name="l02327"></a>02327 }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02330"></a><a class="code" href="osd__iam_8c.html#a752a65cffef258d540e1ae61b8b5abae">02330</a> <a class="code" href="osd__iam_8c.html#a752a65cffef258d540e1ae61b8b5abae">iam_install_idle_blocks</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p, <span class="keyword">struct</span> buffer_head *bh,
<a name="l02331"></a>02331                         __u32 *idle_blocks, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> blk)
<a name="l02332"></a>02332 {
<a name="l02333"></a>02333         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c = p-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l02334"></a>02334         <span class="keyword">struct </span>buffer_head *old = c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>;
<a name="l02335"></a>02335         <span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *<a class="code" href="writemany_8c.html#af39400667a953a7c5c34e3964aa1ce9f">head</a>;
<a name="l02336"></a>02336         <span class="keywordtype">int</span> rc;
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         head = (<span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *)(bh-&gt;b_data);
<a name="l02339"></a>02339         head-&gt;<a class="code" href="structiam__idle__head.html#a8bddc664b6d18597f86e2ba8fcb6fbf3">iih_magic</a> = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(<a class="code" href="osd__iam_8h.html#a592aba11ab30da4dbf57e9736c8387a1ae825b385122e9e4c0554ef7fc414d3fb">IAM_IDLE_HEADER_MAGIC</a>);
<a name="l02340"></a>02340         head-&gt;<a class="code" href="structiam__idle__head.html#aa79d3c1f91ec68f94723c70df23aa4f9">iih_count</a> = 0;
<a name="l02341"></a>02341         head-&gt;<a class="code" href="structiam__idle__head.html#a34b77ac9f56e11329845948d746154f9">iih_next</a> = *idle_blocks;
<a name="l02342"></a>02342         <span class="comment">/* The bh already get_write_accessed. */</span>
<a name="l02343"></a>02343         rc = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, p, bh);
<a name="l02344"></a>02344         <span class="keywordflow">if</span> (rc != 0)
<a name="l02345"></a>02345                 <span class="keywordflow">return</span> rc;
<a name="l02346"></a>02346 
<a name="l02347"></a>02347         rc = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(h, p, c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02348"></a>02348         <span class="keywordflow">if</span> (rc != 0)
<a name="l02349"></a>02349                 <span class="keywordflow">return</span> rc;
<a name="l02350"></a>02350 
<a name="l02351"></a>02351         <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02352"></a>02352         *idle_blocks = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(blk);
<a name="l02353"></a>02353         <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02354"></a>02354         rc = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, p, c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02355"></a>02355         <span class="keywordflow">if</span> (rc == 0) {
<a name="l02356"></a>02356                 <span class="comment">/* NOT release old before new assigned. */</span>
<a name="l02357"></a>02357                 get_bh(bh);
<a name="l02358"></a>02358                 c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> = bh;
<a name="l02359"></a>02359                 brelse(old);
<a name="l02360"></a>02360         } <span class="keywordflow">else</span> {
<a name="l02361"></a>02361                 <a class="code" href="osd__iam_8h.html#a3bf29041dce46f355188f2fe62be0d58">iam_lock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02362"></a>02362                 *idle_blocks = head-&gt;<a class="code" href="structiam__idle__head.html#a34b77ac9f56e11329845948d746154f9">iih_next</a>;
<a name="l02363"></a>02363                 <a class="code" href="osd__iam_8h.html#aeb2b94a452e78f7bc9253965761988da">iam_unlock_bh</a>(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>);
<a name="l02364"></a>02364         }
<a name="l02365"></a>02365         <span class="keywordflow">return</span> rc;
<a name="l02366"></a>02366 }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368 <span class="comment">/*</span>
<a name="l02369"></a>02369 <span class="comment"> * If the leaf cannnot be recycled, we will lose one block for reusing.</span>
<a name="l02370"></a>02370 <span class="comment"> * It is not a serious issue because it almost the same of non-recycle.</span>
<a name="l02371"></a>02371 <span class="comment"> */</span>
<a name="l02372"></a><a class="code" href="osd__iam_8c.html#a7fd5851da0d869986e86b620c7a5918b">02372</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="osd__iam_8c.html#a7fd5851da0d869986e86b620c7a5918b">iam_recycle_leaf</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p,
<a name="l02373"></a>02373                              <span class="keyword">struct</span> buffer_head *bh, <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> blk)
<a name="l02374"></a>02374 {
<a name="l02375"></a>02375         <span class="keyword">struct </span><a class="code" href="structiam__container.html">iam_container</a> *c = p-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a>;
<a name="l02376"></a>02376         <span class="keyword">struct </span>inode *inode = c-&gt;<a class="code" href="structiam__container.html#a1ca1a3e54c3afd3a0bf7dfffe0e58894">ic_object</a>;
<a name="l02377"></a>02377         <span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *<a class="code" href="writemany_8c.html#af39400667a953a7c5c34e3964aa1ce9f">head</a>;
<a name="l02378"></a>02378         __u32 *idle_blocks;
<a name="l02379"></a>02379         <span class="keywordtype">int</span> count;
<a name="l02380"></a>02380         <span class="keywordtype">int</span> rc;
<a name="l02381"></a>02381 
<a name="l02382"></a>02382         mutex_lock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l02383"></a>02383         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(c-&gt;<a class="code" href="structiam__container.html#a62e3cc423e725203de906903ae875e7f">ic_idle_failed</a>)) {
<a name="l02384"></a>02384                 rc = -EFAULT;
<a name="l02385"></a>02385                 <span class="keywordflow">goto</span> unlock;
<a name="l02386"></a>02386         }
<a name="l02387"></a>02387 
<a name="l02388"></a>02388         idle_blocks = (__u32 *)(c-&gt;<a class="code" href="structiam__container.html#ac92cd8cde5286d5f44240449b1e7a34b">ic_root_bh</a>-&gt;b_data +
<a name="l02389"></a>02389                                 c-&gt;<a class="code" href="structiam__container.html#a33d58684b5bfc25a9e1498098435df96">ic_descr</a>-&gt;<a class="code" href="structiam__descr.html#a25bbbcb7becbec775fe8348f85374511">id_root_gap</a> +
<a name="l02390"></a>02390                                 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdx__countlimit.html">dx_countlimit</a>));
<a name="l02391"></a>02391         <span class="comment">/* It is the first idle block. */</span>
<a name="l02392"></a>02392         <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a> == NULL) {
<a name="l02393"></a>02393                 rc = <a class="code" href="osd__iam_8c.html#a752a65cffef258d540e1ae61b8b5abae">iam_install_idle_blocks</a>(h, p, bh, idle_blocks, blk);
<a name="l02394"></a>02394                 <span class="keywordflow">goto</span> unlock;
<a name="l02395"></a>02395         }
<a name="l02396"></a>02396 
<a name="l02397"></a>02397         head = (<span class="keyword">struct </span><a class="code" href="structiam__idle__head.html">iam_idle_head</a> *)(c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>-&gt;b_data);
<a name="l02398"></a>02398         count = <a class="code" href="byteorder_8h.html#a65e9510f535c1ee2f826d447471289fa">le16_to_cpu</a>(head-&gt;<a class="code" href="structiam__idle__head.html#aa79d3c1f91ec68f94723c70df23aa4f9">iih_count</a>);
<a name="l02399"></a>02399         <span class="comment">/* Current ic_idle_bh is full, to be replaced by the leaf. */</span>
<a name="l02400"></a>02400         <span class="keywordflow">if</span> (count == <a class="code" href="osd__iam_8c.html#a6d214b3db1ac222524c0a0c0d300e773">iam_idle_blocks_limit</a>(inode)) {
<a name="l02401"></a>02401                 rc = <a class="code" href="osd__iam_8c.html#a752a65cffef258d540e1ae61b8b5abae">iam_install_idle_blocks</a>(h, p, bh, idle_blocks, blk);
<a name="l02402"></a>02402                 <span class="keywordflow">goto</span> unlock;
<a name="l02403"></a>02403         }
<a name="l02404"></a>02404 
<a name="l02405"></a>02405         <span class="comment">/* Just add to ic_idle_bh. */</span>
<a name="l02406"></a>02406         rc = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(h, p, c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>);
<a name="l02407"></a>02407         <span class="keywordflow">if</span> (rc != 0)
<a name="l02408"></a>02408                 <span class="keywordflow">goto</span> unlock;
<a name="l02409"></a>02409 
<a name="l02410"></a>02410         head-&gt;<a class="code" href="structiam__idle__head.html#ab74c24613285e0224ee4ef98de79f2e1">iih_blks</a>[count] = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(blk);
<a name="l02411"></a>02411         head-&gt;<a class="code" href="structiam__idle__head.html#aa79d3c1f91ec68f94723c70df23aa4f9">iih_count</a> = <a class="code" href="byteorder_8h.html#aeda3065f344779edb9023e22d84d5f92">cpu_to_le16</a>(count + 1);
<a name="l02412"></a>02412         rc = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, p, c-&gt;<a class="code" href="structiam__container.html#a237299cd4e01a280714cc981b092685e">ic_idle_bh</a>);
<a name="l02413"></a>02413 
<a name="l02414"></a>02414 unlock:
<a name="l02415"></a>02415         mutex_unlock(&amp;c-&gt;<a class="code" href="structiam__container.html#ac69da04e9047f24b9fcaedefed9fc5fc">ic_idle_mutex</a>);
<a name="l02416"></a>02416         <span class="keywordflow">if</span> (rc != 0)
<a name="l02417"></a>02417                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%.16s: idle blocks failed, will lose the blk %u\n&quot;</span>,
<a name="l02418"></a>02418                       LDISKFS_SB(inode-&gt;i_sb)-&gt;s_es-&gt;s_volume_name, blk);
<a name="l02419"></a>02419 }
<a name="l02420"></a>02420 
<a name="l02421"></a>02421 <span class="comment">/*</span>
<a name="l02422"></a>02422 <span class="comment"> * Delete record under iterator.</span>
<a name="l02423"></a>02423 <span class="comment"> *</span>
<a name="l02424"></a>02424 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l02425"></a>02425 <span class="comment"> *                it-&gt;ii_flags&amp;IAM_IT_WRITE &amp;&amp;</span>
<a name="l02426"></a>02426 <span class="comment"> *                it_at_rec(it)</span>
<a name="l02427"></a>02427 <span class="comment"> * postcondition: it_state(it) == IAM_IT_ATTACHED ||</span>
<a name="l02428"></a>02428 <span class="comment"> *                it_state(it) == IAM_IT_DETACHED</span>
<a name="l02429"></a>02429 <span class="comment"> */</span>
<a name="l02430"></a><a class="code" href="osd__iam_8h.html#a32dc3c9d0a01153e628061cb01d9a32b">02430</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a32dc3c9d0a01153e628061cb01d9a32b">iam_it_rec_delete</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l02431"></a>02431 {
<a name="l02432"></a>02432         <span class="keywordtype">int</span> result;
<a name="l02433"></a>02433         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a> *leaf;
<a name="l02434"></a>02434         <span class="keyword">struct </span><a class="code" href="structiam__path.html">iam_path</a> *path;
<a name="l02435"></a>02435 
<a name="l02436"></a>02436         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> &amp;&amp;
<a name="l02437"></a>02437                     it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>);
<a name="l02438"></a>02438         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l02439"></a>02439 
<a name="l02440"></a>02440         path = &amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>;
<a name="l02441"></a>02441         leaf = &amp;path-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l02442"></a>02442 
<a name="l02443"></a>02443         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l02444"></a>02444         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l02445"></a>02445 
<a name="l02446"></a>02446         result = <a class="code" href="osd__iam_8c.html#a38c057ad1b2a8ad85391a4f08c581347">iam_txn_add</a>(h, path, leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l02447"></a>02447         <span class="comment">/*</span>
<a name="l02448"></a>02448 <span class="comment">         * no compaction for now.</span>
<a name="l02449"></a>02449 <span class="comment">         */</span>
<a name="l02450"></a>02450         <span class="keywordflow">if</span> (result == 0) {
<a name="l02451"></a>02451                 <a class="code" href="osd__iam_8c.html#a45c343d2d4c7f9fe178a2c6a8dfe69a7">iam_rec_del</a>(leaf, it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960ae73115fe064bb6b26280bb4cfdb1befd">IAM_IT_MOVE</a>);
<a name="l02452"></a>02452                 result = <a class="code" href="osd__iam_8c.html#a617acffb24cc88757e4630f3ed6b40c0">iam_txn_dirty</a>(h, path, leaf-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>);
<a name="l02453"></a>02453                 <span class="keywordflow">if</span> (result == 0 &amp;&amp; <a class="code" href="osd__iam_8c.html#ac660377b16b956c8842ed7d9cb6d2ab2">iam_leaf_at_end</a>(leaf)) {
<a name="l02454"></a>02454                         <span class="keyword">struct </span>buffer_head *bh = NULL;
<a name="l02455"></a>02455                         <a class="code" href="osd__iam_8h.html#aff3644cc661c29ad82f7d783c29c2baf">iam_ptr_t</a> blk;
<a name="l02456"></a>02456 
<a name="l02457"></a>02457                         blk = <a class="code" href="osd__iam_8c.html#ab8d2a715a38aa9da67ac72bb35bc9be7">iam_index_shrink</a>(h, path, leaf, &amp;bh);
<a name="l02458"></a>02458                         <span class="keywordflow">if</span> (it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a> &amp; <a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960ae73115fe064bb6b26280bb4cfdb1befd">IAM_IT_MOVE</a>) {
<a name="l02459"></a>02459                                 result = <a class="code" href="group__libiam.html#ga04c8e4213d97fa4c6a6b027d8d06d41a">iam_it_next</a>(it);
<a name="l02460"></a>02460                                 <span class="keywordflow">if</span> (result &gt; 0)
<a name="l02461"></a>02461                                         result = 0;
<a name="l02462"></a>02462                         }
<a name="l02463"></a>02463 
<a name="l02464"></a>02464                         <span class="keywordflow">if</span> (bh != NULL) {
<a name="l02465"></a>02465                                 <a class="code" href="osd__iam_8c.html#a7fd5851da0d869986e86b620c7a5918b">iam_recycle_leaf</a>(h, path, bh, blk);
<a name="l02466"></a>02466                                 brelse(bh);
<a name="l02467"></a>02467                         }
<a name="l02468"></a>02468                 }
<a name="l02469"></a>02469         }
<a name="l02470"></a>02470         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_leaf_check(leaf));
<a name="l02471"></a>02471         <a class="code" href="osd__iam_8h.html#ae5d371cf0bb7a4e068c8864bb0dd4897">assert_inv</a>(iam_path_check(path));
<a name="l02472"></a>02472         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l02473"></a>02473                     <a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a>);
<a name="l02474"></a>02474         <span class="keywordflow">return</span> result;
<a name="l02475"></a>02475 }
<a name="l02476"></a>02476 
<a name="l02477"></a>02477 <span class="comment">/*</span>
<a name="l02478"></a>02478 <span class="comment"> * Convert iterator to cookie.</span>
<a name="l02479"></a>02479 <span class="comment"> *</span>
<a name="l02480"></a>02480 <span class="comment"> * precondition:  it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l02481"></a>02481 <span class="comment"> *                iam_path_descr(it-&gt;ii_path)-&gt;id_key_size &lt;= sizeof(iam_pos_t)</span>
<a name="l02482"></a>02482 <span class="comment"> * postcondition: it_state(it) == IAM_IT_ATTACHED</span>
<a name="l02483"></a>02483 <span class="comment"> */</span>
<a name="l02484"></a><a class="code" href="osd__iam_8h.html#a4587ddaa094e9012abd7158135c7c9e7">02484</a> <a class="code" href="osd__iam_8h.html#a4fe89cf55be48878639b97383a89de85">iam_pos_t</a> <a class="code" href="osd__iam_8c.html#a4587ddaa094e9012abd7158135c7c9e7">iam_it_store</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l02485"></a>02485 {
<a name="l02486"></a>02486         <a class="code" href="osd__iam_8h.html#a4fe89cf55be48878639b97383a89de85">iam_pos_t</a> result;
<a name="l02487"></a>02487 
<a name="l02488"></a>02488         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a>);
<a name="l02489"></a>02489         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it));
<a name="l02490"></a>02490         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(it)-&gt;ic_descr-&gt;id_ikey_size &lt;=
<a name="l02491"></a>02491                     <span class="keyword">sizeof</span> result);
<a name="l02492"></a>02492 
<a name="l02493"></a>02493         result = 0;
<a name="l02494"></a>02494         <span class="keywordflow">return</span> *(<a class="code" href="osd__iam_8h.html#a4fe89cf55be48878639b97383a89de85">iam_pos_t</a> *)<a class="code" href="osd__iam_8c.html#a4b636e2ce22ee1d05ac35f0b04cb4c83">iam_it_ikey_get</a>(it, (<span class="keywordtype">void</span> *)&amp;result);
<a name="l02495"></a>02495 }
<a name="l02496"></a>02496 
<a name="l02497"></a>02497 <span class="comment">/*</span>
<a name="l02498"></a>02498 <span class="comment"> * Restore iterator from cookie.</span>
<a name="l02499"></a>02499 <span class="comment"> *</span>
<a name="l02500"></a>02500 <span class="comment"> * precondition:  it_state(it) == IAM_IT_DETACHED &amp;&amp; it-&gt;ii_flags&amp;IAM_IT_MOVE &amp;&amp;</span>
<a name="l02501"></a>02501 <span class="comment"> *                iam_path_descr(it-&gt;ii_path)-&gt;id_key_size &lt;= sizeof(iam_pos_t)</span>
<a name="l02502"></a>02502 <span class="comment"> * postcondition: ergo(result == 0, it_state(it) == IAM_IT_ATTACHED &amp;&amp;</span>
<a name="l02503"></a>02503 <span class="comment"> *                                  iam_it_store(it) == pos)</span>
<a name="l02504"></a>02504 <span class="comment"> */</span>
<a name="l02505"></a><a class="code" href="osd__iam_8h.html#a2078d57795a8ec16f0dab220071f5405">02505</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a2078d57795a8ec16f0dab220071f5405">iam_it_load</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it, <a class="code" href="osd__iam_8h.html#a4fe89cf55be48878639b97383a89de85">iam_pos_t</a> pos)
<a name="l02506"></a>02506 {
<a name="l02507"></a>02507         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a531ca097c00c9d1177e813e1f5a28d4b">it_state</a>(it) == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a> &amp;&amp;
<a name="l02508"></a>02508                     it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a>&amp;<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960ae73115fe064bb6b26280bb4cfdb1befd">IAM_IT_MOVE</a>);
<a name="l02509"></a>02509         <a class="code" href="osd__iam_8h.html#a4c2457194c1c1a6a8f58c3b832d38297">assert_corr</a>(<a class="code" href="osd__iam_8c.html#a7c10b59cbb2561b6c0d336c1437619c8">iam_it_container</a>(it)-&gt;ic_descr-&gt;id_ikey_size &lt;= <span class="keyword">sizeof</span> pos);
<a name="l02510"></a>02510         <span class="keywordflow">return</span> <a class="code" href="osd__iam_8c.html#a8b9dce5678234feeb89ec2b73cef25eb">iam_it_iget</a>(it, (<span class="keyword">struct</span> iam_ikey *)&amp;pos);
<a name="l02511"></a>02511 }
<a name="l02512"></a>02512 
<a name="l02513"></a>02513 <span class="comment">/***********************************************************************/</span>
<a name="l02514"></a>02514 <span class="comment">/* invariants                                                          */</span>
<a name="l02515"></a>02515 <span class="comment">/***********************************************************************/</span>
<a name="l02516"></a>02516 
<a name="l02517"></a><a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">02517</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">ptr_inside</a>(<span class="keywordtype">void</span> *base, <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>, <span class="keywordtype">void</span> *ptr)
<a name="l02518"></a>02518 {
<a name="l02519"></a>02519         <span class="keywordflow">return</span> (base &lt;= ptr) &amp;&amp; (ptr &lt; base + size);
<a name="l02520"></a>02520 }
<a name="l02521"></a>02521 
<a name="l02522"></a><a class="code" href="osd__iam_8c.html#a6414644a53d3ceca88ebf895b080106a">02522</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a6414644a53d3ceca88ebf895b080106a">iam_frame_invariant</a>(<span class="keyword">struct</span> <a class="code" href="structiam__frame.html">iam_frame</a> *f)
<a name="l02523"></a>02523 {
<a name="l02524"></a>02524         <span class="keywordflow">return</span>
<a name="l02525"></a>02525                 (f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a> != NULL &amp;&amp;
<a name="l02526"></a>02526                 f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>-&gt;b_data != NULL &amp;&amp;
<a name="l02527"></a>02527                 <a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">ptr_inside</a>(f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>-&gt;b_data, f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>-&gt;b_size, f-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a>) &amp;&amp;
<a name="l02528"></a>02528                 <a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">ptr_inside</a>(f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>-&gt;b_data, f-&gt;<a class="code" href="structiam__frame.html#a798bc9e90259a7e9f92405e4ae86911c">bh</a>-&gt;b_size, f-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>) &amp;&amp;
<a name="l02529"></a>02529                 f-&gt;<a class="code" href="structiam__frame.html#acb600c4f1f40d29574c74e8131bbc987">entries</a> &lt;= f-&gt;<a class="code" href="structiam__frame.html#a4341d860517428fa428b09b9030340f7">at</a>);
<a name="l02530"></a>02530 }
<a name="l02531"></a>02531 
<a name="l02532"></a><a class="code" href="osd__iam_8c.html#a29230d5ed7b7d804adbf92ec22f34521">02532</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a29230d5ed7b7d804adbf92ec22f34521">iam_leaf_invariant</a>(<span class="keyword">struct</span> <a class="code" href="structiam__leaf.html">iam_leaf</a> *l)
<a name="l02533"></a>02533 {
<a name="l02534"></a>02534         <span class="keywordflow">return</span>
<a name="l02535"></a>02535                 l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a> != NULL &amp;&amp;
<a name="l02536"></a>02536                 l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>-&gt;b_data != NULL &amp;&amp;
<a name="l02537"></a>02537                 <a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">ptr_inside</a>(l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>-&gt;b_data, l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>-&gt;b_size, l-&gt;<a class="code" href="structiam__leaf.html#a73ab48cfc1fd79fa00888226e7ece886">il_entries</a>) &amp;&amp;
<a name="l02538"></a>02538                 <a class="code" href="osd__iam_8c.html#acef134c0a74beb902356d694210c4c41">ptr_inside</a>(l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>-&gt;b_data, l-&gt;<a class="code" href="structiam__leaf.html#ae70636fc0a36395d998a1c594b34f83f">il_bh</a>-&gt;b_size, l-&gt;<a class="code" href="structiam__leaf.html#a9055f5821f70035d127abb1e4749d382">il_at</a>) &amp;&amp;
<a name="l02539"></a>02539                 l-&gt;<a class="code" href="structiam__leaf.html#a73ab48cfc1fd79fa00888226e7ece886">il_entries</a> &lt;= l-&gt;<a class="code" href="structiam__leaf.html#a9055f5821f70035d127abb1e4749d382">il_at</a>;
<a name="l02540"></a>02540 }
<a name="l02541"></a>02541 
<a name="l02542"></a><a class="code" href="osd__iam_8c.html#a66ee2ffb31042e4ee5a2bdb2375cc1fe">02542</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a66ee2ffb31042e4ee5a2bdb2375cc1fe">iam_path_invariant</a>(<span class="keyword">struct</span> <a class="code" href="structiam__path.html">iam_path</a> *p)
<a name="l02543"></a>02543 {
<a name="l02544"></a>02544         <span class="keywordtype">int</span> i;
<a name="l02545"></a>02545 
<a name="l02546"></a>02546         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiam__path.html#aeae09a53f7d44fa246a33a0ea7099393">ip_container</a> == NULL ||
<a name="l02547"></a>02547             p-&gt;<a class="code" href="structiam__path.html#a2030b8d9ebbbb62627baf196f7f7c0bc">ip_indirect</a> &lt; 0 || p-&gt;<a class="code" href="structiam__path.html#a2030b8d9ebbbb62627baf196f7f7c0bc">ip_indirect</a> &gt; <a class="code" href="osd__iam_8h.html#a4d29ca5db06e2ae647d1ec22548a9d2aae0f4446bdd4678d68da660a9ba4b0972">DX_MAX_TREE_HEIGHT</a> - 1 ||
<a name="l02548"></a>02548             p-&gt;<a class="code" href="structiam__path.html#ae47969026ec6532f59195d4be4968518">ip_frame</a> != p-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a> + p-&gt;<a class="code" href="structiam__path.html#a2030b8d9ebbbb62627baf196f7f7c0bc">ip_indirect</a> ||
<a name="l02549"></a>02549             !<a class="code" href="osd__iam_8c.html#a29230d5ed7b7d804adbf92ec22f34521">iam_leaf_invariant</a>(&amp;p-&gt;<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>))
<a name="l02550"></a>02550                 <span class="keywordflow">return</span> 0;
<a name="l02551"></a>02551         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__llapi.html#ga25f003de16c08a4888b69f619d70f427">ARRAY_SIZE</a>(p-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>); ++i) {
<a name="l02552"></a>02552                 <span class="keywordflow">if</span> (i &lt;= p-&gt;ip_indirect) {
<a name="l02553"></a>02553                         <span class="keywordflow">if</span> (!<a class="code" href="osd__iam_8c.html#a6414644a53d3ceca88ebf895b080106a">iam_frame_invariant</a>(&amp;p-&gt;<a class="code" href="structiam__path.html#a8a979900904cf8d6d97d2650d97fb730">ip_frames</a>[i]))
<a name="l02554"></a>02554                                 <span class="keywordflow">return</span> 0;
<a name="l02555"></a>02555                 }
<a name="l02556"></a>02556         }
<a name="l02557"></a>02557         <span class="keywordflow">return</span> 1;
<a name="l02558"></a>02558 }
<a name="l02559"></a>02559 
<a name="l02560"></a><a class="code" href="osd__iam_8c.html#a7e982deb08d80ca288adfaa39aed0eb2">02560</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a7e982deb08d80ca288adfaa39aed0eb2">iam_it_invariant</a>(<span class="keyword">struct</span> <a class="code" href="structiam__iterator.html">iam_iterator</a> *it)
<a name="l02561"></a>02561 {
<a name="l02562"></a>02562         <span class="keywordflow">return</span>
<a name="l02563"></a>02563                 (it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104aab7386d88af4974f191d2bb6796b4dd9">IAM_IT_DETACHED</a> ||
<a name="l02564"></a>02564                  it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l02565"></a>02565                  it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>) &amp;&amp;
<a name="l02566"></a>02566                 !(it-&gt;<a class="code" href="structiam__iterator.html#a22452b8b36827119786772a4edf7cde3">ii_flags</a> &amp; ~(<a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960ae73115fe064bb6b26280bb4cfdb1befd">IAM_IT_MOVE</a> | <a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>)) &amp;&amp;
<a name="l02567"></a>02567                 <a class="code" href="osd__iam_8h.html#a7f75ab6839d468f4d23480a9c65724c5">ergo</a>(it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104a09bcb6f88f563785b3647cd2b916c4af">IAM_IT_ATTACHED</a> ||
<a name="l02568"></a>02568                      it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>,
<a name="l02569"></a>02569                      <a class="code" href="osd__iam_8c.html#a66ee2ffb31042e4ee5a2bdb2375cc1fe">iam_path_invariant</a>(&amp;it-&gt;<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>) &amp;&amp;
<a name="l02570"></a>02570                      <a class="code" href="osd__iam_8h.html#aeefd33b919b7320ecefdf0d16ca7d993">equi</a>(<a class="code" href="osd__iam_8c.html#ae72c8e872931c02c239b73ae9e74088f">it_at_rec</a>(it), it-&gt;<a class="code" href="structiam__iterator.html#a5de9622edc0ecd991f8368a7aef7965b">ii_state</a> == <a class="code" href="osd__iam_8h.html#af1dff4a57281a9e4327c3bf399057104ab69d3fc927ee13742380e2ee43c36f6e">IAM_IT_SKEWED</a>));
<a name="l02571"></a>02571 }
<a name="l02572"></a>02572 
<a name="l02573"></a>02573 <span class="comment">/*</span>
<a name="l02574"></a>02574 <span class="comment"> * Search container @c for record with key @k. If record is found, its data</span>
<a name="l02575"></a>02575 <span class="comment"> * are moved into @r.</span>
<a name="l02576"></a>02576 <span class="comment"> *</span>
<a name="l02577"></a>02577 <span class="comment"> * Return values: 0: found, -ENOENT: not-found, -ve: error</span>
<a name="l02578"></a>02578 <span class="comment"> */</span>
<a name="l02579"></a><a class="code" href="osd__iam_8h.html#a88ccf17a8c0be13956ccb2655481fe74">02579</a> <span class="keywordtype">int</span> <a class="code" href="group__libiam.html#gac7fd49d9f7b738852f2e7fb2761a5033">iam_lookup</a>(<span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k,
<a name="l02580"></a>02580                <span class="keyword">struct</span> iam_rec *r, <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l02581"></a>02581 {
<a name="l02582"></a>02582         <span class="keyword">struct </span><a class="code" href="structiam__iterator.html">iam_iterator</a> it;
<a name="l02583"></a>02583         <span class="keywordtype">int</span> result;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585         <a class="code" href="osd__iam_8c.html#ae765e676c41bce576bd10e7c315776bf">iam_it_init</a>(&amp;it, c, 0, pd);
<a name="l02586"></a>02586 
<a name="l02587"></a>02587         result = <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(&amp;it, k);
<a name="l02588"></a>02588         <span class="keywordflow">if</span> (result == 0)
<a name="l02589"></a>02589                 <span class="comment">/*</span>
<a name="l02590"></a>02590 <span class="comment">                 * record with required key found, copy it into user buffer</span>
<a name="l02591"></a>02591 <span class="comment">                 */</span>
<a name="l02592"></a>02592                 <a class="code" href="osd__iam_8h.html#ab78febeef8bb8bfed11512fc03912715">iam_reccpy</a>(&amp;it.<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>, r);
<a name="l02593"></a>02593         <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(&amp;it);
<a name="l02594"></a>02594         <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(&amp;it);
<a name="l02595"></a>02595         <span class="keywordflow">return</span> result;
<a name="l02596"></a>02596 }
<a name="l02597"></a>02597 
<a name="l02598"></a>02598 <span class="comment">/*</span>
<a name="l02599"></a>02599 <span class="comment"> * Insert new record @r with key @k into container @c (within context of</span>
<a name="l02600"></a>02600 <span class="comment"> * transaction @h).</span>
<a name="l02601"></a>02601 <span class="comment"> *</span>
<a name="l02602"></a>02602 <span class="comment"> * Return values: 0: success, -ve: error, including -EEXIST when record with</span>
<a name="l02603"></a>02603 <span class="comment"> * given key is already present.</span>
<a name="l02604"></a>02604 <span class="comment"> *</span>
<a name="l02605"></a>02605 <span class="comment"> * postcondition: ergo(result == 0 || result == -EEXIST,</span>
<a name="l02606"></a>02606 <span class="comment"> *                                  iam_lookup(c, k, r2) &gt; 0;</span>
<a name="l02607"></a>02607 <span class="comment"> */</span>
<a name="l02608"></a><a class="code" href="osd__iam_8h.html#a5e6be0b621546120b770df6bb1fc1c26">02608</a> <span class="keywordtype">int</span> <a class="code" href="group__libiam.html#ga0747cd8a7f812e81c4d433c130c7d6be">iam_insert</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k,
<a name="l02609"></a>02609                <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r, <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l02610"></a>02610 {
<a name="l02611"></a>02611         <span class="keyword">struct </span><a class="code" href="structiam__iterator.html">iam_iterator</a> it;
<a name="l02612"></a>02612         <span class="keywordtype">int</span> result;
<a name="l02613"></a>02613 
<a name="l02614"></a>02614         <a class="code" href="osd__iam_8c.html#ae765e676c41bce576bd10e7c315776bf">iam_it_init</a>(&amp;it, c, <a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>, pd);
<a name="l02615"></a>02615 
<a name="l02616"></a>02616         result = <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(&amp;it, k);
<a name="l02617"></a>02617         <span class="keywordflow">if</span> (result == -ENOENT)
<a name="l02618"></a>02618                 result = <a class="code" href="osd__iam_8c.html#a485ef7f7c8a2172fd44301a07124b909">iam_it_rec_insert</a>(h, &amp;it, k, r);
<a name="l02619"></a>02619         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == 0)
<a name="l02620"></a>02620                 result = -EEXIST;
<a name="l02621"></a>02621         <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(&amp;it);
<a name="l02622"></a>02622         <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(&amp;it);
<a name="l02623"></a>02623         <span class="keywordflow">return</span> result;
<a name="l02624"></a>02624 }
<a name="l02625"></a>02625 
<a name="l02626"></a>02626 <span class="comment">/*</span>
<a name="l02627"></a>02627 <span class="comment"> * Update record with the key @k in container @c (within context of</span>
<a name="l02628"></a>02628 <span class="comment"> * transaction @h), new record is given by @r.</span>
<a name="l02629"></a>02629 <span class="comment"> *</span>
<a name="l02630"></a>02630 <span class="comment"> * Return values: +1: skip because of the same rec value, 0: success,</span>
<a name="l02631"></a>02631 <span class="comment"> * -ve: error, including -ENOENT if no record with the given key found.</span>
<a name="l02632"></a>02632 <span class="comment"> */</span>
<a name="l02633"></a><a class="code" href="osd__iam_8h.html#a9fbc3535d96068b353d8aba737b6653a">02633</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a9fbc3535d96068b353d8aba737b6653a">iam_update</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k,
<a name="l02634"></a>02634                <span class="keyword">const</span> <span class="keyword">struct</span> iam_rec *r, <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l02635"></a>02635 {
<a name="l02636"></a>02636         <span class="keyword">struct </span><a class="code" href="structiam__iterator.html">iam_iterator</a> it;
<a name="l02637"></a>02637         <span class="keyword">struct </span><a class="code" href="structiam__leaf.html">iam_leaf</a> *folio;
<a name="l02638"></a>02638         <span class="keywordtype">int</span> result;
<a name="l02639"></a>02639 
<a name="l02640"></a>02640         <a class="code" href="osd__iam_8c.html#ae765e676c41bce576bd10e7c315776bf">iam_it_init</a>(&amp;it, c, <a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>, pd);
<a name="l02641"></a>02641 
<a name="l02642"></a>02642         result = <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(&amp;it, k);
<a name="l02643"></a>02643         <span class="keywordflow">if</span> (result == 0) {
<a name="l02644"></a>02644                 folio = &amp;it.<a class="code" href="structiam__iterator.html#a71ec3536926e54ca339bcc96c06aaa65">ii_path</a>.<a class="code" href="structiam__path.html#a8ff087eca43225573d850ba01c551cf9">ip_leaf</a>;
<a name="l02645"></a>02645                 result = <a class="code" href="osd__iam_8h.html#aea703aa36c6a44fc48e0c56ccc2f55ea">iam_leaf_ops</a>(folio)-&gt;<a class="code" href="structiam__leaf__operations.html#a12c5f41aaea16644dc71fa665504e1da">rec_eq</a>(folio, r);
<a name="l02646"></a>02646                 <span class="keywordflow">if</span> (result == 0)
<a name="l02647"></a>02647                         <a class="code" href="osd__iam_8c.html#a40e1003d26e9b6b9d9e19b687c158b22">iam_it_rec_set</a>(h, &amp;it, r);
<a name="l02648"></a>02648                 <span class="keywordflow">else</span>
<a name="l02649"></a>02649                         result = 1;
<a name="l02650"></a>02650         }
<a name="l02651"></a>02651         <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(&amp;it);
<a name="l02652"></a>02652         <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(&amp;it);
<a name="l02653"></a>02653         <span class="keywordflow">return</span> result;
<a name="l02654"></a>02654 }
<a name="l02655"></a>02655 
<a name="l02656"></a>02656 <span class="comment">/*</span>
<a name="l02657"></a>02657 <span class="comment"> * Delete existing record with key @k.</span>
<a name="l02658"></a>02658 <span class="comment"> *</span>
<a name="l02659"></a>02659 <span class="comment"> * Return values: 0: success, -ENOENT: not-found, -ve: other error.</span>
<a name="l02660"></a>02660 <span class="comment"> *</span>
<a name="l02661"></a>02661 <span class="comment"> * postcondition: ergo(result == 0 || result == -ENOENT,</span>
<a name="l02662"></a>02662 <span class="comment"> *                                 !iam_lookup(c, k, *));</span>
<a name="l02663"></a>02663 <span class="comment"> */</span>
<a name="l02664"></a><a class="code" href="osd__iam_8h.html#a416f2d04675a2965e571fd9f487632e7">02664</a> <span class="keywordtype">int</span> <a class="code" href="group__libiam.html#ga8f7ae5cc2213dbd1f864a2375e315dc4">iam_delete</a>(handle_t *h, <span class="keyword">struct</span> <a class="code" href="structiam__container.html">iam_container</a> *c, <span class="keyword">const</span> <span class="keyword">struct</span> iam_key *k,
<a name="l02665"></a>02665                <span class="keyword">struct</span> <a class="code" href="structiam__path__descr.html">iam_path_descr</a> *pd)
<a name="l02666"></a>02666 {
<a name="l02667"></a>02667         <span class="keyword">struct </span><a class="code" href="structiam__iterator.html">iam_iterator</a> it;
<a name="l02668"></a>02668         <span class="keywordtype">int</span> result;
<a name="l02669"></a>02669 
<a name="l02670"></a>02670         <a class="code" href="osd__iam_8c.html#ae765e676c41bce576bd10e7c315776bf">iam_it_init</a>(&amp;it, c, <a class="code" href="osd__iam_8h.html#aca02dabda7e3ab8db62ffcf276f46960a419e416496c5fc025604b3201d1765f3">IAM_IT_WRITE</a>, pd);
<a name="l02671"></a>02671 
<a name="l02672"></a>02672         result = <a class="code" href="osd__iam_8c.html#ae928db85c010451613d23384a20fe007">iam_it_get_exact</a>(&amp;it, k);
<a name="l02673"></a>02673         <span class="keywordflow">if</span> (result == 0)
<a name="l02674"></a>02674                 <a class="code" href="osd__iam_8c.html#a32dc3c9d0a01153e628061cb01d9a32b">iam_it_rec_delete</a>(h, &amp;it);
<a name="l02675"></a>02675         <a class="code" href="osd__iam_8c.html#aff48cbfa1eeab11046c2ff104130f7b9">iam_it_put</a>(&amp;it);
<a name="l02676"></a>02676         <a class="code" href="osd__iam_8c.html#ad11528ab34a5b9d19a2c5dec3ea25e15">iam_it_fini</a>(&amp;it);
<a name="l02677"></a>02677         <span class="keywordflow">return</span> result;
<a name="l02678"></a>02678 }
<a name="l02679"></a>02679 
<a name="l02680"></a><a class="code" href="osd__iam_8h.html#a8e1d06ee935abbecb474c36aedf1531e">02680</a> <span class="keywordtype">int</span> <a class="code" href="osd__iam_8c.html#a8e1d06ee935abbecb474c36aedf1531e">iam_root_limit</a>(<span class="keywordtype">int</span> rootgap, <span class="keywordtype">int</span> <a class="code" href="osd__iam__lvar_8c.html#ade58e20d5ef741f92db607504a0b0c95">blocksize</a>, <span class="keywordtype">int</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l02681"></a>02681 {
<a name="l02682"></a>02682         <span class="keywordtype">int</span> limit;
<a name="l02683"></a>02683         <span class="keywordtype">int</span> nlimit;
<a name="l02684"></a>02684 
<a name="l02685"></a>02685         limit = (blocksize - rootgap) / size;
<a name="l02686"></a>02686         nlimit = blocksize / size;
<a name="l02687"></a>02687         <span class="keywordflow">if</span> (limit == nlimit)
<a name="l02688"></a>02688                 limit--;
<a name="l02689"></a>02689         <span class="keywordflow">return</span> limit;
<a name="l02690"></a>02690 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:41 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
