<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/osp/osp_sync.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/osp/osp_sync.c File Reference</h1><code>#include &lt;linux/kthread.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__log_8h_source.html">lustre_log.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__update_8h_source.html">lustre_update.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="osp__internal_8h_source.html">osp_internal.h</a>&quot;</code><br/>

<p><a href="osp__sync_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structosp__job__req__args.html">osp_job_req_args</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_MDS</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#af76ae7c4ab5361ca2106fc4e93329d3b">OSP_SYN_THRESHOLD</a>&nbsp;&nbsp;&nbsp;10</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a442679c7ec42c464006bc36d0ecb06be">OSP_MAX_IN_FLIGHT</a>&nbsp;&nbsp;&nbsp;8</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#adf1676bfc56b91e2d7201b3b41e7b6d9">OSP_MAX_IN_PROGRESS</a>&nbsp;&nbsp;&nbsp;4096</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a98c07c6e87ff165157741b88110aeeb6">OSP_JOB_MAGIC</a>&nbsp;&nbsp;&nbsp;0x26112005</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a45de2795a3c7800781f9451ef19b6d3a">osp_sync_check_for_work</a>(d)</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#abf8555d012e3aad2b46b362e92222673">osp_sync_id_traction_init</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize commit tracking mechanism.  <a href="#abf8555d012e3aad2b46b362e92222673"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a1319afe0f841fe199a4a22ac0fad8ad9">osp_sync_id_traction_fini</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release commit tracker.  <a href="#a1319afe0f841fe199a4a22ac0fad8ad9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static __u32&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a9ccb4ec32d0127beae7e3a6db8112834">osp_sync_id_get</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, __u32 id)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a new ID on a tracker.  <a href="#a9ccb4ec32d0127beae7e3a6db8112834"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a298967b0454970ad561dba030cf2c357">osp_sync_remove_from_tracker</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Stop to propagate commit status to OSP.  <a href="#a298967b0454970ad561dba030cf2c357"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#aa293420ce1e7f4c70e7238eb8704c10c">osp_sync_running</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#aa3eb6a90c19d78fd6e103a1e338f329a">osp_sync_stopped</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check status: whether OSP thread has stopped.  <a href="#aa3eb6a90c19d78fd6e103a1e338f329a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a536b872514bdfe907cc4526b528bf115">osp_sync_has_new_job</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#afaaca90cb07c6ad72b3350e0afa0d1dd">osp_sync_inflight_conflict</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *h)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#aff7057eb50a01ecfc852914c394a240f">osp_sync_low_in_progress</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a503c93f3d6cbff0d4001b9ee3d32740f">osp_sync_low_in_flight</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check for room in the <a class="el" href="structnetwork.html">network</a> pipe to OST.  <a href="#a503c93f3d6cbff0d4001b9ee3d32740f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#ab1f35ce1625da63d49e1eba926fe2f56">osp_sync_has_work</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Wake up check for the main sync thread.  <a href="#ab1f35ce1625da63d49e1eba926fe2f56"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a0ee09d7a7bbe9d8629ef0cb19e5e57d5">__osp_sync_check_for_work</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a4af19cc2db53ff60e3d8e706d061f7da">osp_sync_can_process_new</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *rec)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check and return ready-for-new status.  <a href="#a4af19cc2db53ff60e3d8e706d061f7da"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#af6eb77a1052667e2af318b2b5b934f80">osp_sync_declare_add</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__object.html">osp_object</a> *o, <a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a> type, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Declare intention to add a new change.  <a href="#af6eb77a1052667e2af318b2b5b934f80"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#ad44bc1b0ff0f9b933db07b0fd5143e29">osp_sync_add_rec</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d, const struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid, <a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a> type, int count, struct <a class="el" href="structthandle.html">thandle</a> *th, const struct <a class="el" href="structlu__attr.html">lu_attr</a> *attr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a llog record for a given change.  <a href="#ad44bc1b0ff0f9b933db07b0fd5143e29"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#ad84dcbea0dbe8c7aba1d3a5514e236f0">osp_sync_add</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__object.html">osp_object</a> *o, <a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a> type, struct <a class="el" href="structthandle.html">thandle</a> *th, const struct <a class="el" href="structlu__attr.html">lu_attr</a> *attr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a015695c08ff7f4d27e3936845ddb83ab">osp_sync_gap</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid, int lost, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#aa4b213415741d3928d984779b48b88d9">osp_sync_request_commit_cb</a> (struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ptlrpc commit callback.  <a href="#aa4b213415741d3928d984779b48b88d9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a493750e3fc30f696798aaf1aa690bdae">osp_sync_interpret</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, void *aa, int rc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">RPC interpretation callback.  <a href="#a493750e3fc30f696798aaf1aa690bdae"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a0b597dbd85f05976ebd53a62e56cc5f4">osp_sync_send_new_rpc</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a52c4135d84ad5934bd60d59fb2006e8b">osp_sync_new_job</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *h, <a class="el" href="packet-lustre_8c.html#adeda0b7c376c32e2a7c49c7eee01c065">ost_cmd_t</a> <a class="el" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>, const struct <a class="el" href="structreq__format.html">req_format</a> *format)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate and prepare RPC for a new change.  <a href="#a52c4135d84ad5934bd60d59fb2006e8b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a9da01b5c5b83c1b6db38c38bccfbb415">osp_sync_new_setattr_job</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a request for setattr change.  <a href="#a9da01b5c5b83c1b6db38c38bccfbb415"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a7a75d5b81c54b98fa42cf0f6d5aea8b8">osp_sync_new_unlink_job</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a request for unlink change.  <a href="#a7a75d5b81c54b98fa42cf0f6d5aea8b8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#ae00074f3e64a985cfb149e71f0444c87">osp_sync_new_unlink64_job</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *h)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a request for unlink change.  <a href="#ae00074f3e64a985cfb149e71f0444c87"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a92f53f43a5c8a87d8f09b986021c16dc">osp_sync_process_record</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *rec)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Process llog records.  <a href="#a92f53f43a5c8a87d8f09b986021c16dc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#adc4574cb21d6ff16f6211ce271cc4a5c">osp_sync_process_committed</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cancel llog records for the committed changes.  <a href="#adc4574cb21d6ff16f6211ce271cc4a5c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a15fc77c40df3fca55b7a55d66b5b7ab6">osp_sync_process_queues</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structllog__handle.html">llog_handle</a> *llh, struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *rec, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The core of the syncing mechanism.  <a href="#a15fc77c40df3fca55b7a55d66b5b7ab6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a775a5561afc9b3daa77f0bf9dfa9e19e">osp_sync_thread</a> (void *_arg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">OSP sync thread.  <a href="#a775a5561afc9b3daa77f0bf9dfa9e19e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a71af9165422344b21507b6398998439c">osp_sync_llog_init</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize llog.  <a href="#a71af9165422344b21507b6398998439c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a9083eb58f14a0b01c50a006006d11a4d">osp_sync_llog_fini</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cleanup llog used for syncing.  <a href="#a9083eb58f14a0b01c50a006006d11a4d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a09b409cb21b03007d14cc16ca03c172d">osp_sync_init</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialization of the sync component of OSP.  <a href="#a09b409cb21b03007d14cc16ca03c172d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a9fad5e902635f80345fb875169be1e03">osp_sync_fini</a> (struct <a class="el" href="structosp__device.html">osp_device</a> *d)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Stop the syncing thread.  <a href="#a9fad5e902635f80345fb875169be1e03"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#af44fd409bd44a3061aa7b3de151696fd">DEFINE_MUTEX</a> (osp_id_tracker_sem)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a1b3a3246bd146ad7ecfe9f113bca8fe4">osp_sync_tracker_commit_cb</a> (struct <a class="el" href="structthandle.html">thandle</a> *th, void *cookie)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">OSD commit callback.  <a href="#a1b3a3246bd146ad7ecfe9f113bca8fe4"></a><br/></td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structlist__head.html">list_head</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="osp__sync_8c.html#a286f86d5ed3059117935e8ddfde47449">osp_id_tracker_list</a></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="osp_sync.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_MDS</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00044">44</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

</div>
</div>
<a class="anchor" id="a98c07c6e87ff165157741b88110aeeb6"></a><!-- doxytag: member="osp_sync.c::OSP_JOB_MAGIC" ref="a98c07c6e87ff165157741b88110aeeb6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OSP_JOB_MAGIC&nbsp;&nbsp;&nbsp;0x26112005</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00096">96</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00139">osp_sync_inflight_conflict()</a>, <a class="el" href="osp__sync_8c_source.html#l00515">osp_sync_interpret()</a>, <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>, <a class="el" href="osp__sync_8c_source.html#l00470">osp_sync_request_commit_cb()</a>, and <a class="el" href="osp__sync_8c_source.html#l00602">osp_sync_send_new_rpc()</a>.</p>

</div>
</div>
<a class="anchor" id="a442679c7ec42c464006bc36d0ecb06be"></a><!-- doxytag: member="osp_sync.c::OSP_MAX_IN_FLIGHT" ref="a442679c7ec42c464006bc36d0ecb06be" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OSP_MAX_IN_FLIGHT&nbsp;&nbsp;&nbsp;8</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00093">93</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="adf1676bfc56b91e2d7201b3b41e7b6d9"></a><!-- doxytag: member="osp_sync.c::OSP_MAX_IN_PROGRESS" ref="adf1676bfc56b91e2d7201b3b41e7b6d9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OSP_MAX_IN_PROGRESS&nbsp;&nbsp;&nbsp;4096</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00094">94</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="af76ae7c4ab5361ca2106fc4e93329d3b"></a><!-- doxytag: member="osp_sync.c::OSP_SYN_THRESHOLD" ref="af76ae7c4ab5361ca2106fc4e93329d3b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OSP_SYN_THRESHOLD&nbsp;&nbsp;&nbsp;10</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00092">92</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

</div>
</div>
<a class="anchor" id="a45de2795a3c7800781f9451ef19b6d3a"></a><!-- doxytag: member="osp_sync.c::osp_sync_check_for_work" ref="a45de2795a3c7800781f9451ef19b6d3a" args="(d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define osp_sync_check_for_work</td>
          <td>(</td>
          <td class="paramtype">d&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment">{                                                       \
        <span class="keywordflow">if</span> (<a class="code" href="osp__sync_8c.html#ab1f35ce1625da63d49e1eba926fe2f56" title="Wake up check for the main sync thread.">osp_sync_has_work</a>(d)) {                     \
                wake_up(&amp;d-&gt;opd_syn_waitq);    \
        }                                               \
}
</pre></div>
<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00229">229</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00236">__osp_sync_check_for_work()</a>, <a class="el" href="osp__sync_8c_source.html#l00515">osp_sync_interpret()</a>, and <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0ee09d7a7bbe9d8629ef0cb19e5e57d5"></a><!-- doxytag: member="osp_sync.c::__osp_sync_check_for_work" ref="a0ee09d7a7bbe9d8629ef0cb19e5e57d5" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void __osp_sync_check_for_work </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00236">236</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__sync_8c_source.html#l00229">osp_sync_check_for_work</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l01574">osp_import_event()</a>, and <a class="el" href="osp__dev_8c_source.html#l00781">osp_sync()</a>.</p>

</div>
</div>
<a class="anchor" id="af44fd409bd44a3061aa7b3de151696fd"></a><!-- doxytag: member="osp_sync.c::DEFINE_MUTEX" ref="af44fd409bd44a3061aa7b3de151696fd" args="(osp_id_tracker_sem)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static DEFINE_MUTEX </td>
          <td>(</td>
          <td class="paramtype">osp_id_tracker_sem&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="ad84dcbea0dbe8c7aba1d3a5514e236f0"></a><!-- doxytag: member="osp_sync.c::osp_sync_add" ref="ad84dcbea0dbe8c7aba1d3a5514e236f0" args="(const struct lu_env *env, struct osp_object *o, llog_op_type type, struct thandle *th, const struct lu_attr *attr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_sync_add </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__object.html">osp_object</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__attr.html">lu_attr</a> *&nbsp;</td>
          <td class="paramname"> <em>attr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00429">429</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="osp__internal_8h_source.html#l00443">lu2osp_dev()</a>, <a class="el" href="lu__object_8h_source.html#l00770">lu_object_fid()</a>, <a class="el" href="osp__internal_8h_source.html#l00291">osp_object::opo_obj</a>, and <a class="el" href="osp__sync_8c_source.html#l00357">osp_sync_add_rec()</a>.</p>

<p>Referenced by <a class="el" href="osp__object_8c_source.html#l00709">osp_attr_set()</a>, and <a class="el" href="osp__object_8c_source.html#l01562">osp_object_destroy()</a>.</p>

</div>
</div>
<a class="anchor" id="ad44bc1b0ff0f9b933db07b0fd5143e29"></a><!-- doxytag: member="osp_sync.c::osp_sync_add_rec" ref="ad44bc1b0ff0f9b933db07b0fd5143e29" args="(const struct lu_env *env, struct osp_device *d, const struct lu_fid *fid, llog_op_type type, int count, struct thandle *th, const struct lu_attr *attr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_add_rec </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__attr.html">lu_attr</a> *&nbsp;</td>
          <td class="paramname"> <em>attr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a llog record for a given change. </p>
<p>Generates a llog record for the change passed. The change can be of two types: unlink and setattr. The record gets an ID which later will be used to track commit status of the change. For unlink changes, the caller can supply a starting FID and the count of the objects to destroy. For setattr the caller should apply attributes to apply.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>fid of the object the change should be applied to </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>type</em>&nbsp;</td><td>type of change: MDS_UNLINK64_REC or MDS_SETATTR64_REC </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>count</em>&nbsp;</td><td>count of objects to destroy </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle (local) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>attr</em>&nbsp;</td><td>attributes for setattr</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00357">357</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lustre__user_8h_source.html#l00223">DOSTID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="lu__object_8h_source.html#l00450">LA_GID</a>, <a class="el" href="lu__object_8h_source.html#l00423">lu_attr::la_gid</a>, <a class="el" href="lu__object_8h_source.html#l00449">LA_UID</a>, <a class="el" href="lu__object_8h_source.html#l00421">lu_attr::la_uid</a>, <a class="el" href="lu__object_8h_source.html#l00439">lu_attr::la_valid</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l03346">llog_cookie::lgc_index</a>, <a class="el" href="lustre__idl_8h_source.html#l03344">llog_cookie::lgc_lgl</a>, <a class="el" href="lustre__idl_8h_source.html#l03065">llog_logid::lgl_ogen</a>, <a class="el" href="lustre__idl_8h_source.html#l03064">llog_logid::lgl_oi</a>, <a class="el" href="libcfs__private_8h_source.html#l00309">likely</a>, <a class="el" href="llog_8c_source.html#l00918">llog_add()</a>, <a class="el" href="lustre__log_8h_source.html#l00375">llog_ctxt_put()</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, <a class="el" href="lustre__idl_8h_source.html#l03117">llog_rec_hdr::lrh_id</a>, <a class="el" href="lustre__idl_8h_source.html#l03114">llog_rec_hdr::lrh_len</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__idl_8h_source.html#l03171">llog_setattr64_rec::lsr_gid</a>, <a class="el" href="lustre__idl_8h_source.html#l03168">llog_setattr64_rec::lsr_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03169">llog_setattr64_rec::lsr_uid</a>, <a class="el" href="lustre__idl_8h_source.html#l03173">llog_setattr64_rec::lsr_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03159">llog_unlink64_rec::lur_count</a>, <a class="el" href="lustre__idl_8h_source.html#l03158">llog_unlink64_rec::lur_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l03092">MDS_SETATTR64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l01666">OBD_MD_FLGID</a>, <a class="el" href="lustre__idl_8h_source.html#l01665">OBD_MD_FLUID</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00324">osp_thread_info::osi_cookie</a>, <a class="el" href="osp__internal_8h_source.html#l00319">osp_thread_info::osi_hdr</a>, <a class="el" href="osp__internal_8h_source.html#l00314">osp_thread_info::osi_oi</a>, <a class="el" href="osp__internal_8h_source.html#l00321">osp_thread_info::osi_setattr</a>, <a class="el" href="osp__internal_8h_source.html#l00320">osp_thread_info::osi_unlink</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__sync_8c_source.html#l01617">osp_sync_id_get()</a>, <a class="el" href="osp__internal_8h_source.html#l00428">osp_txn_info()</a>, <a class="el" href="osp__internal_8h_source.html#l00423">osp_txn_info::oti_current_id</a>, <a class="el" href="lustre__user_8h_source.html#l00224">POSTID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="dt__object_8h_source.html#l01838">thandle::th_ctx</a>, <a class="el" href="dt__object_8h_source.html#l01836">thandle::th_top</a>, and <a class="el" href="update__trans_8c_source.html#l01164">thandle_get_sub_by_dt()</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00429">osp_sync_add()</a>, and <a class="el" href="osp__sync_8c_source.html#l00438">osp_sync_gap()</a>.</p>

</div>
</div>
<a class="anchor" id="a4af19cc2db53ff60e3d8e706d061f7da"></a><!-- doxytag: member="osp_sync.c::osp_sync_can_process_new" ref="a4af19cc2db53ff60e3d8e706d061f7da" args="(struct osp_device *d, struct llog_rec_hdr *rec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_can_process_new </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>rec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check and return ready-for-new status. </p>
<p>The thread processing llog record uses this function to check whether it's time to take another record and process it. The number of conditions must be met: the connection should be ready, RPCs in flight not exceeding the limit, the record is committed locally, etc (see the lines below).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rec</em>&nbsp;</td><td>next llog record to process</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>not ready </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>ready </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00255">255</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03117">llog_rec_hdr::lrh_id</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_imp_connected</a>, <a class="el" href="osp__internal_8h_source.html#l00227">osp_device::opd_syn_barrier</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00221">osp_device::opd_syn_last_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00199">osp_device::opd_syn_prev_done</a>, <a class="el" href="osp__sync_8c_source.html#l00139">osp_sync_inflight_conflict()</a>, <a class="el" href="osp__sync_8c_source.html#l00202">osp_sync_low_in_flight()</a>, <a class="el" href="osp__sync_8c_source.html#l00189">osp_sync_low_in_progress()</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>.</p>

</div>
</div>
<a class="anchor" id="af6eb77a1052667e2af318b2b5b934f80"></a><!-- doxytag: member="osp_sync.c::osp_sync_declare_add" ref="af6eb77a1052667e2af318b2b5b934f80" args="(const struct lu_env *env, struct osp_object *o, llog_op_type type, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_sync_declare_add </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__object.html">osp_object</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="packet-lustre_8c.html#a46267c71f9f2221271c977534b08c789">llog_op_type</a>&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Declare intention to add a new change. </p>
<p>With regard to OSD API, we have to declare any changes ahead. In this case we declare an intention to add a llog record representing the change on the local storage.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>o</em>&nbsp;</td><td>OSP object </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>type</em>&nbsp;</td><td>type of change: MDS_UNLINK64_REC or MDS_SETATTR64_REC </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle (local)</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00294">294</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="lu__object_8h_source.html#l01016">LCT_OSP_THREAD</a>, <a class="el" href="lustre__log_8h_source.html#l00375">llog_ctxt_put()</a>, <a class="el" href="llog_8c_source.html#l00939">llog_declare_add()</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, <a class="el" href="lustre__idl_8h_source.html#l03114">llog_rec_hdr::lrh_len</a>, <a class="el" href="osp__internal_8h_source.html#l00443">lu2osp_dev()</a>, <a class="el" href="lustre__idl_8h_source.html#l03092">MDS_SETATTR64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00291">osp_object::opo_obj</a>, <a class="el" href="osp__internal_8h_source.html#l00319">osp_thread_info::osi_hdr</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="dt__object_8h_source.html#l01841">thandle::th_tags</a>, <a class="el" href="dt__object_8h_source.html#l01836">thandle::th_top</a>, and <a class="el" href="update__trans_8c_source.html#l01164">thandle_get_sub_by_dt()</a>.</p>

<p>Referenced by <a class="el" href="osp__object_8c_source.html#l00638">osp_declare_attr_set()</a>, and <a class="el" href="osp__object_8c_source.html#l01530">osp_declare_object_destroy()</a>.</p>

</div>
</div>
<a class="anchor" id="a9fad5e902635f80345fb875169be1e03"></a><!-- doxytag: member="osp_sync.c::osp_sync_fini" ref="a9fad5e902635f80345fb875169be1e03" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_sync_fini </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Stop the syncing thread. </p>
<p>Asks the syncing thread to stop and wait until it's stopped.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01444">1444</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="osp__internal_8h_source.html#l00201">osp_device::opd_syn_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l01576">osp_sync_id_traction_fini()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, <a class="el" href="lustre__net_8h_source.html#l01495">SVC_STOPPING</a>, <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>, <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>, and <a class="el" href="obd_8c_source.html#l00114">thread</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l00996">osp_init0()</a>, and <a class="el" href="osp__dev_8c_source.html#l00587">osp_shutdown()</a>.</p>

</div>
</div>
<a class="anchor" id="a015695c08ff7f4d27e3936845ddb83ab"></a><!-- doxytag: member="osp_sync.c::osp_sync_gap" ref="a015695c08ff7f4d27e3936845ddb83ab" args="(const struct lu_env *env, struct osp_device *d, struct lu_fid *fid, int lost, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_sync_gap </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>lost</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00438">438</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, and <a class="el" href="osp__sync_8c_source.html#l00357">osp_sync_add_rec()</a>.</p>

</div>
</div>
<a class="anchor" id="a536b872514bdfe907cc4526b528bf115"></a><!-- doxytag: member="osp_sync.c::osp_sync_has_new_job" ref="a536b872514bdfe907cc4526b528bf115" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_has_new_job </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00132">132</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00221">osp_device::opd_syn_last_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00223">osp_device::opd_syn_last_processed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00218">osp_device::opd_syn_last_used_id</a>, and <a class="el" href="osp__internal_8h_source.html#l00199">osp_device::opd_syn_prev_done</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00215">osp_sync_has_work()</a>.</p>

</div>
</div>
<a class="anchor" id="ab1f35ce1625da63d49e1eba926fe2f56"></a><!-- doxytag: member="osp_sync.c::osp_sync_has_work" ref="ab1f35ce1625da63d49e1eba926fe2f56" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_has_work </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wake up check for the main sync thread. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>time to wake up </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>no need to wake up </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00215">215</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="osp__internal_8h_source.html#l00167">osp_device::opd_imp_connected</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__sync_8c_source.html#l00132">osp_sync_has_new_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00202">osp_sync_low_in_flight()</a>, and <a class="el" href="osp__sync_8c_source.html#l00189">osp_sync_low_in_progress()</a>.</p>

</div>
</div>
<a class="anchor" id="a9ccb4ec32d0127beae7e3a6db8112834"></a><!-- doxytag: member="osp_sync.c::osp_sync_id_get" ref="a9ccb4ec32d0127beae7e3a6db8112834" args="(struct osp_device *d, __u32 id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static __u32 osp_sync_id_get </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a new ID on a tracker. </p>
<p>Generates a new ID using the tracker associated with the given OSP device <em>d</em>, if the given ID <em>id</em> is non-zero. Unconditially adds OSP device to the wakeup list, so OSP won't miss when a transaction using the ID is committed. Notice ID is 32bit, but llog doesn't support &gt;2^32 records anyway.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>id</em>&nbsp;</td><td>0 or ID generated previously</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ID</em>&nbsp;</td><td>the caller should use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01617">1617</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="list_8h_source.html#l00076">list_add()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00218">osp_device::opd_syn_last_used_id</a>, <a class="el" href="osp__internal_8h_source.html#l00225">osp_device::opd_syn_ontrack</a>, <a class="el" href="osp__internal_8h_source.html#l00224">osp_device::opd_syn_tracker</a>, <a class="el" href="osp__internal_8h_source.html#l00057">osp_id_tracker::otr_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00058">osp_id_tracker::otr_next_id</a>, <a class="el" href="osp__internal_8h_source.html#l00063">osp_id_tracker::otr_wakeup_list</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00357">osp_sync_add_rec()</a>.</p>

</div>
</div>
<a class="anchor" id="a1319afe0f841fe199a4a22ac0fad8ad9"></a><!-- doxytag: member="osp_sync.c::osp_sync_id_traction_fini" ref="a1319afe0f841fe199a4a22ac0fad8ad9" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_id_traction_fini </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Release commit tracker. </p>
<p>Decrease a refcounter on the tracker used by the given OSP device <em>d</em>. If no more users left, then the tracker is released.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01576">1576</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="dt__object_8c_source.html#l00073">dt_txn_callback_del()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00116">list_del()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00224">osp_device::opd_syn_tracker</a>, <a class="el" href="osp__sync_8c_source.html#l01655">osp_sync_remove_from_tracker()</a>, <a class="el" href="osp__internal_8h_source.html#l00064">osp_id_tracker::otr_list</a>, <a class="el" href="osp__internal_8h_source.html#l00068">osp_id_tracker::otr_refcount</a>, <a class="el" href="osp__internal_8h_source.html#l00061">osp_id_tracker::otr_tx_cb</a>, and <a class="el" href="osp__internal_8h_source.html#l00063">osp_id_tracker::otr_wakeup_list</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01444">osp_sync_fini()</a>, and <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="abf8555d012e3aad2b46b362e92222673"></a><!-- doxytag: member="osp_sync.c::osp_sync_id_traction_init" ref="abf8555d012e3aad2b46b362e92222673" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_id_traction_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize commit tracking mechanism. </p>
<p>Some setups may have thousands of OSTs and each will be represented by OSP. Meaning order of magnitute many more changes to apply every second. In order to keep the number of commit callbacks low this mechanism was introduced. The mechanism is very similar to transno used by MDT service: it's an single ID stream which can be assigned by any OSP to its llog records. The tricky part is that ID is stored in per-transaction data and re-used by all the OSPs involved in that transaction. Then all these OSPs are woken up utilizing a single OSD commit callback.</p>
<p>The function initializes the data used by the tracker described above. A singler tracker per OSD device is created.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01522">1522</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="dt__object_8c_source.html#l00067">dt_txn_callback_add()</a>, <a class="el" href="dt__object_8h_source.html#l01874">dt_txn_callback::dtc_cookie</a>, <a class="el" href="dt__object_8h_source.html#l01875">dt_txn_callback::dtc_tag</a>, <a class="el" href="structdt__txn__callback.html#ac794bcdc1945fadee56a4afd2199487a">dt_txn_callback::dtc_txn_commit</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l00995">LCT_MD_THREAD</a>, <a class="el" href="list_8h_source.html#l00076">list_add()</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00225">osp_device::opd_syn_ontrack</a>, <a class="el" href="osp__internal_8h_source.html#l00224">osp_device::opd_syn_tracker</a>, <a class="el" href="osp__sync_8c_source.html#l01476">osp_sync_tracker_commit_cb()</a>, <a class="el" href="osp__internal_8h_source.html#l00059">osp_id_tracker::otr_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00066">osp_id_tracker::otr_dev</a>, <a class="el" href="osp__internal_8h_source.html#l00064">osp_id_tracker::otr_list</a>, <a class="el" href="osp__internal_8h_source.html#l00057">osp_id_tracker::otr_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00058">osp_id_tracker::otr_next_id</a>, <a class="el" href="osp__internal_8h_source.html#l00068">osp_id_tracker::otr_refcount</a>, <a class="el" href="osp__internal_8h_source.html#l00061">osp_id_tracker::otr_tx_cb</a>, and <a class="el" href="osp__internal_8h_source.html#l00063">osp_id_tracker::otr_wakeup_list</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="afaaca90cb07c6ad72b3350e0afa0d1dd"></a><!-- doxytag: member="osp_sync.c::osp_sync_inflight_conflict" ref="afaaca90cb07c6ad72b3350e0afa0d1dd" args="(struct osp_device *d, struct llog_rec_hdr *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_inflight_conflict </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00139">139</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="osp__sync_8c_source.html#l00103">osp_job_req_args::jra_magic</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="packet-lustre_8c_source.html#l00347">LLOG_GEN_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__idl_8h_source.html#l03092">MDS_SETATTR64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, <a class="el" href="packet-lustre_8c_source.html#l00343">MDS_UNLINK_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="osp__internal_8h_source.html#l00204">osp_device::opd_syn_inflight_list</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__sync_8c_source.html#l00096">OSP_JOB_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l00594">ostid_set_id()</a>, <a class="el" href="lustre__idl_8h_source.html#l00561">ostid_set_seq()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l00873">rq_async_args</a>, and <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00255">osp_sync_can_process_new()</a>.</p>

</div>
</div>
<a class="anchor" id="a09b409cb21b03007d14cc16ca03c172d"></a><!-- doxytag: member="osp_sync.c::osp_sync_init" ref="a09b409cb21b03007d14cc16ca03c172d" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int osp_sync_init </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialization of the sync component of OSP. </p>
<p>Initializes the llog and starts a new thread to handle the changes to the remote target (OST or MDT).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01381">1381</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00145">osp_device::opd_group</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00228">osp_device::opd_syn_barrier_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00204">osp_device::opd_syn_inflight_list</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00211">osp_device::opd_syn_max_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00214">osp_device::opd_syn_max_rpc_in_progress</a>, <a class="el" href="osp__internal_8h_source.html#l00201">osp_device::opd_syn_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00093">OSP_MAX_IN_FLIGHT</a>, <a class="el" href="osp__sync_8c_source.html#l00094">OSP_MAX_IN_PROGRESS</a>, <a class="el" href="osp__sync_8c_source.html#l01576">osp_sync_id_traction_fini()</a>, <a class="el" href="osp__sync_8c_source.html#l01522">osp_sync_id_traction_init()</a>, <a class="el" href="osp__sync_8c_source.html#l01359">osp_sync_llog_fini()</a>, <a class="el" href="osp__sync_8c_source.html#l01244">osp_sync_llog_init()</a>, <a class="el" href="osp__sync_8c_source.html#l00106">osp_sync_running()</a>, <a class="el" href="osp__sync_8c_source.html#l00119">osp_sync_stopped()</a>, <a class="el" href="osp__sync_8c_source.html#l01142">osp_sync_thread()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>.</p>

<p>Referenced by <a class="el" href="osp__dev_8c_source.html#l00996">osp_init0()</a>.</p>

</div>
</div>
<a class="anchor" id="a493750e3fc30f696798aaf1aa690bdae"></a><!-- doxytag: member="osp_sync.c::osp_sync_interpret" ref="a493750e3fc30f696798aaf1aa690bdae" args="(const struct lu_env *env, struct ptlrpc_request *req, void *aa, int rc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_interpret </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>aa</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>RPC interpretation callback. </p>
<p>The callback is called by ptlrpc when RPC is replied. Now we have to decide whether we should:</p>
<ul>
<li>put request on a special list to wait until it's committed by the target, if the request is successful</li>
<li>schedule llog record cancel if no target object is found</li>
<li>try later (essentially after reboot) in case of unexpected error</li>
</ul>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>req</em>&nbsp;</td><td>request replied </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>aa</em>&nbsp;</td><td>callback data </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rc</em>&nbsp;</td><td>result of RPC</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>always </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00515">515</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00146">D_ERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lustre__net_8h_source.html#l01302">DEBUG_REQ</a>, <a class="el" href="lustre__import_8h_source.html#l00237">obd_import::imp_generation</a>, <a class="el" href="osp__sync_8c_source.html#l00101">osp_job_req_args::jra_committed_link</a>, <a class="el" href="osp__sync_8c_source.html#l00102">osp_job_req_args::jra_inflight_link</a>, <a class="el" href="osp__sync_8c_source.html#l00103">osp_job_req_args::jra_magic</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="list_8h_source.html#l00076">list_add()</a>, <a class="el" href="list_8h_source.html#l00125">list_del_init()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00227">osp_device::opd_syn_barrier</a>, <a class="el" href="osp__internal_8h_source.html#l00228">osp_device::opd_syn_barrier_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00096">OSP_JOB_MAGIC</a>, <a class="el" href="osp__precreate_8c_source.html#l00231">osp_statfs_need_now()</a>, <a class="el" href="osp__sync_8c_source.html#l00229">osp_sync_check_for_work</a>, <a class="el" href="client_8c_source.html#l02757">ptlrpc_request_addref()</a>, <a class="el" href="lustre__net_8h_source.html#l01104">ptlrpc_request::rq_import</a>, <a class="el" href="lustre__net_8h_source.html#l01016">ptlrpc_request::rq_refcount</a>, <a class="el" href="lustre__net_8h_source.html#l01034">ptlrpc_request::rq_transno</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00637">osp_sync_new_job()</a>.</p>

</div>
</div>
<a class="anchor" id="a9083eb58f14a0b01c50a006006d11a4d"></a><!-- doxytag: member="osp_sync.c::osp_sync_llog_fini" ref="a9083eb58f14a0b01c50a006006d11a4d" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_llog_fini </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cleanup llog used for syncing. </p>
<p>Closes and cleanups the llog. The function is called when the device is shutting down.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01359">1359</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="llog__cat_8c_source.html#l00271">llog_cat_close()</a>, <a class="el" href="llog__obd_8c_source.html#l00108">llog_cleanup()</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, and <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a71af9165422344b21507b6398998439c"></a><!-- doxytag: member="osp_sync.c::osp_sync_llog_init" ref="a71af9165422344b21507b6398998439c" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_llog_init </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize llog. </p>
<p>Initializes the llog. Specific llog to be used depends on the type of the target OSP represents (OST or MDT). The function adds appends a new llog record to mark the place where the records associated with this boot start.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01244">1244</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="linux-time_8h_source.html#l00152">cfs_time_current()</a>, <a class="el" href="lustre__idl_8h_source.html#l03272">llog_gen::conn_cnt</a>, <a class="el" href="libcfs__debug_8h_source.html#l00135">D_INFO</a>, <a class="el" href="dt__object_8h_source.html#l01723">dt_device::dd_lu_dev</a>, <a class="el" href="lustre__user_8h_source.html#l00223">DOSTID</a>, <a class="el" href="lvfs_8h_source.html#l00061">lvfs_run_ctxt::dt</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03071">llog_catid::lci_logid</a>, <a class="el" href="lu__object_8h_source.html#l00287">lu_device::ld_obd</a>, <a class="el" href="lustre__log_8h_source.html#l00265">llog_handle::lgh_id</a>, <a class="el" href="lustre__idl_8h_source.html#l03065">llog_logid::lgl_ogen</a>, <a class="el" href="lustre__idl_8h_source.html#l03064">llog_logid::lgl_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03277">llog_gen_rec::lgr_gen</a>, <a class="el" href="lustre__idl_8h_source.html#l03276">llog_gen_rec::lgr_hdr</a>, <a class="el" href="libcfs__private_8h_source.html#l00309">likely</a>, <a class="el" href="llog__cat_8c_source.html#l00631">llog_cat_add()</a>, <a class="el" href="llog__cat_8c_source.html#l00271">llog_cat_close()</a>, <a class="el" href="lustre__fid_8h_source.html#l00230">LLOG_CATALOGS_OID</a>, <a class="el" href="llog__obd_8c_source.html#l00108">llog_cleanup()</a>, <a class="el" href="lustre__log_8h_source.html#l00375">llog_ctxt_put()</a>, <a class="el" href="packet-lustre_8c_source.html#l00356">LLOG_F_IS_CAT</a>, <a class="el" href="packet-lustre_8c_source.html#l00347">LLOG_GEN_REC</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="llog_8c_source.html#l00345">llog_init_handle()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="llog_8c_source.html#l01083">llog_open()</a>, <a class="el" href="llog_8c_source.html#l00963">llog_open_create()</a>, <a class="el" href="lustre__log_8h_source.html#l00064">LLOG_OPEN_EXISTS</a>, <a class="el" href="llog__osd_8c_source.html#l01913">llog_osd_get_cat_list()</a>, <a class="el" href="llog__osd_8c_source.html#l02031">llog_osd_put_cat_list()</a>, <a class="el" href="llog__obd_8c_source.html#l00146">llog_setup()</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, <a class="el" href="lustre__log__user_8h_source.html#l00072">logid_id()</a>, <a class="el" href="lustre__log__user_8h_source.html#l00067">logid_set_id()</a>, <a class="el" href="lustre__idl_8h_source.html#l03114">llog_rec_hdr::lrh_len</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__fid_8h_source.html#l00242">lu_local_obj_fid()</a>, <a class="el" href="lustre__idl_8h_source.html#l03271">llog_gen::mnt_cnt</a>, <a class="el" href="obd_8h_source.html#l00650">obd_device::obd_lvfs_ctxt</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="obd_8h_source.html#l00651">obd_device::obd_olg</a>, <a class="el" href="lvfs_8h_source.html#l00067">OBD_SET_CTXT_MAGIC()</a>, <a class="el" href="osp__internal_8h_source.html#l00141">osp_device::opd_index</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00148">osp_device::opd_storage</a>, <a class="el" href="osp__internal_8h_source.html#l00195">osp_device::opd_syn_generation</a>, <a class="el" href="osp__internal_8h_source.html#l00325">osp_thread_info::osi_cid</a>, <a class="el" href="osp__internal_8h_source.html#l00324">osp_thread_info::osi_cookie</a>, <a class="el" href="osp__internal_8h_source.html#l00312">osp_thread_info::osi_fid</a>, <a class="el" href="osp__internal_8h_source.html#l00322">osp_thread_info::osi_gen</a>, <a class="el" href="osp__internal_8h_source.html#l00319">osp_thread_info::osi_hdr</a>, <a class="el" href="osp__internal_8h_source.html#l00409">osp_env_info()</a>, <a class="el" href="osp__dev_8c_source.html#l01900">osp_mds_ost_orig_logops</a>, <a class="el" href="lustre__user_8h_source.html#l00224">POSTID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a503c93f3d6cbff0d4001b9ee3d32740f"></a><!-- doxytag: member="osp_sync.c::osp_sync_low_in_flight" ref="a503c93f3d6cbff0d4001b9ee3d32740f" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_low_in_flight </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check for room in the <a class="el" href="structnetwork.html">network</a> pipe to OST. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>there is room </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>no room, the pipe is full </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00202">202</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00211">osp_device::opd_syn_max_rpc_in_flight</a>, and <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00255">osp_sync_can_process_new()</a>, and <a class="el" href="osp__sync_8c_source.html#l00215">osp_sync_has_work()</a>.</p>

</div>
</div>
<a class="anchor" id="aff7057eb50a01ecfc852914c394a240f"></a><!-- doxytag: member="osp_sync.c::osp_sync_low_in_progress" ref="aff7057eb50a01ecfc852914c394a240f" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_low_in_progress </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00189">189</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00214">osp_device::opd_syn_max_rpc_in_progress</a>, and <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00255">osp_sync_can_process_new()</a>, and <a class="el" href="osp__sync_8c_source.html#l00215">osp_sync_has_work()</a>.</p>

</div>
</div>
<a class="anchor" id="a52c4135d84ad5934bd60d59fb2006e8b"></a><!-- doxytag: member="osp_sync.c::osp_sync_new_job" ref="a52c4135d84ad5934bd60d59fb2006e8b" args="(struct osp_device *d, struct llog_handle *llh, struct llog_rec_hdr *h, ost_cmd_t op, const struct req_format *format)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a>* osp_sync_new_job </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="packet-lustre_8c.html#adeda0b7c376c32e2a7c49c7eee01c065">ost_cmd_t</a>&nbsp;</td>
          <td class="paramname"> <em>op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structreq__format.html">req_format</a> *&nbsp;</td>
          <td class="paramname"> <em>format</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate and prepare RPC for a new change. </p>
<p>The function allocates and initializes an RPC which will be sent soon to apply the change to the target OST. The request is initialized from the llog record passed. Notice only the fields common to all type of changes are initialized.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle where the record is stored </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>h</em>&nbsp;</td><td>llog record </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>op</em>&nbsp;</td><td>type of the change </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>format</em>&nbsp;</td><td>request format to be used</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pointer</em>&nbsp;</td><td>new request on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ERR_PTR(errno)</em>&nbsp;</td><td>on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00637">637</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03346">llog_cookie::lgc_index</a>, <a class="el" href="lustre__idl_8h_source.html#l03344">llog_cookie::lgc_lgl</a>, <a class="el" href="lustre__idl_8h_source.html#l03345">llog_cookie::lgc_subsys</a>, <a class="el" href="lustre__log_8h_source.html#l00265">llog_handle::lgh_id</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__idl_8h_source.html#l03115">llog_rec_hdr::lrh_index</a>, <a class="el" href="packet-lustre_8c_source.html#l00078">LUSTRE_OST_VERSION</a>, <a class="el" href="lustre__idl_8h_source.html#l03408">obdo::o_lcookie</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00615">OBD_FAIL_OSP_CHECK_ENOMEM</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__sync_8c_source.html#l00515">osp_sync_interpret()</a>, <a class="el" href="osp__sync_8c_source.html#l00470">osp_sync_request_commit_cb()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00700">osp_sync_new_setattr_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00804">osp_sync_new_unlink64_job()</a>, and <a class="el" href="osp__sync_8c_source.html#l00758">osp_sync_new_unlink_job()</a>.</p>

</div>
</div>
<a class="anchor" id="a9da01b5c5b83c1b6db38c38bccfbb415"></a><!-- doxytag: member="osp_sync.c::osp_sync_new_setattr_job" ref="a9da01b5c5b83c1b6db38c38bccfbb415" args="(struct osp_device *d, struct llog_handle *llh, struct llog_rec_hdr *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_new_setattr_job </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a request for setattr change. </p>
<p>The function prepares a new RPC, initializes it with setattr specific bits and send the RPC.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle where the record is stored </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>h</em>&nbsp;</td><td>llog record</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>on invalid record </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00700">700</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__idl_8h_source.html#l03171">llog_setattr64_rec::lsr_gid</a>, <a class="el" href="lustre__idl_8h_source.html#l03168">llog_setattr64_rec::lsr_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03169">llog_setattr64_rec::lsr_uid</a>, <a class="el" href="lustre__idl_8h_source.html#l03173">llog_setattr64_rec::lsr_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03092">MDS_SETATTR64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03397">obdo::o_gid</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03396">obdo::o_uid</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00614">OBD_FAIL_OSP_CHECK_INVALID_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l01666">OBD_MD_FLGID</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="lustre__idl_8h_source.html#l01656">OBD_MD_FLID</a>, <a class="el" href="lustre__idl_8h_source.html#l01665">OBD_MD_FLUID</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__sync_8c_source.html#l00637">osp_sync_new_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00602">osp_sync_send_new_rpc()</a>, <a class="el" href="packet-lustre_8c_source.html#l00165">OST_SETATTR</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="layout_8c_source.html#l01618">RQF_OST_SETATTR</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00849">osp_sync_process_record()</a>.</p>

</div>
</div>
<a class="anchor" id="ae00074f3e64a985cfb149e71f0444c87"></a><!-- doxytag: member="osp_sync.c::osp_sync_new_unlink64_job" ref="ae00074f3e64a985cfb149e71f0444c87" args="(struct osp_device *d, struct llog_handle *llh, struct llog_rec_hdr *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_new_unlink64_job </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a request for unlink change. </p>
<p>The function prepares a new RPC, initializes it with unlink(destroy) specific bits and sends the RPC. Depending on the target (MDT or OST) two different protocols are used. For MDT we use OUT (basically OSD API updates transferred via a <a class="el" href="structnetwork.html">network</a>). For OST we still use the old protocol (OBD?), originally for compatibility. Later we can start to use OUT for OST as well, this will allow batching and better code unification.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle where the record is stored </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>h</em>&nbsp;</td><td>llog record</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00804">804</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00706">fid_to_ostid()</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__idl_8h_source.html#l03159">llog_unlink64_rec::lur_count</a>, <a class="el" href="lustre__idl_8h_source.html#l03158">llog_unlink64_rec::lur_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03401">obdo::o_misc</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="lustre__idl_8h_source.html#l01656">OBD_MD_FLID</a>, <a class="el" href="lustre__idl_8h_source.html#l01707">OBD_MD_FLOBJCOUNT</a>, <a class="el" href="osp__sync_8c_source.html#l00637">osp_sync_new_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00602">osp_sync_send_new_rpc()</a>, <a class="el" href="packet-lustre_8c_source.html#l00169">OST_DESTROY</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="layout_8c_source.html#l01634">RQF_OST_DESTROY</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00849">osp_sync_process_record()</a>.</p>

</div>
</div>
<a class="anchor" id="a7a75d5b81c54b98fa42cf0f6d5aea8b8"></a><!-- doxytag: member="osp_sync.c::osp_sync_new_unlink_job" ref="a7a75d5b81c54b98fa42cf0f6d5aea8b8" args="(struct osp_device *d, struct llog_handle *llh, struct llog_rec_hdr *h)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_new_unlink_job </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>h</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a request for unlink change. </p>
<p>The function prepares a new RPC, initializes it with unlink(destroy) specific bits and sends the RPC. The function is used to handle <a class="el" href="structllog__unlink__rec.html">llog_unlink_rec</a> which were used in the older versions of Lustre. Current version uses llog_unlink_rec64.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle where the record is stored </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>h</em>&nbsp;</td><td>llog record</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00758">758</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lustre__idl_8h_source.html#l03152">llog_unlink_rec::lur_count</a>, <a class="el" href="lustre__idl_8h_source.html#l03150">llog_unlink_rec::lur_oid</a>, <a class="el" href="lustre__idl_8h_source.html#l03151">llog_unlink_rec::lur_oseq</a>, <a class="el" href="packet-lustre_8c_source.html#l00343">MDS_UNLINK_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03401">obdo::o_misc</a>, <a class="el" href="lustre__idl_8h_source.html#l03384">obdo::o_oi</a>, <a class="el" href="lustre__idl_8h_source.html#l03383">obdo::o_valid</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="lustre__idl_8h_source.html#l01679">OBD_MD_FLGROUP</a>, <a class="el" href="lustre__idl_8h_source.html#l01656">OBD_MD_FLID</a>, <a class="el" href="lustre__idl_8h_source.html#l01707">OBD_MD_FLOBJCOUNT</a>, <a class="el" href="osp__sync_8c_source.html#l00637">osp_sync_new_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00602">osp_sync_send_new_rpc()</a>, <a class="el" href="packet-lustre_8c_source.html#l00169">OST_DESTROY</a>, <a class="el" href="lustre__idl_8h_source.html#l00594">ostid_set_id()</a>, <a class="el" href="lustre__idl_8h_source.html#l00561">ostid_set_seq()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="layout_8c_source.html#l01634">RQF_OST_DESTROY</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00849">osp_sync_process_record()</a>.</p>

</div>
</div>
<a class="anchor" id="adc4574cb21d6ff16f6211ce271cc4a5c"></a><!-- doxytag: member="osp_sync.c::osp_sync_process_committed" ref="adc4574cb21d6ff16f6211ce271cc4a5c" args="(const struct lu_env *env, struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_process_committed </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cancel llog records for the committed changes. </p>
<p>The function walks through the list of the committed RPCs and cancels corresponding llog records. see <a class="el" href="osp__sync_8c.html#aa4b213415741d3928d984779b48b88d9" title="ptlrpc commit callback.">osp_sync_request_commit_cb()</a> for the details.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00966">966</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd_8h_source.html#l00162">client_obd::cl_import</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lustre__net_8h_source.html#l01302">DEBUG_REQ</a>, <a class="el" href="parser_8c_source.html#l00044">done</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__import_8h_source.html#l00237">obd_import::imp_generation</a>, <a class="el" href="lustre__import_8h_source.html#l00248">obd_import::imp_peer_committed_transno</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="osp__sync_8c_source.html#l00101">osp_job_req_args::jra_committed_link</a>, <a class="el" href="osp__sync_8c_source.html#l00103">osp_job_req_args::jra_magic</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00125">list_del_init()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="list_8h_source.html#l00242">list_entry</a>, <a class="el" href="list_8h_source.html#l00206">list_splice()</a>, <a class="el" href="llog__cat_8c_source.html#l00673">llog_cat_cancel_records()</a>, <a class="el" href="lustre__log_8h_source.html#l00375">llog_ctxt_put()</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="list_8h_source.html#l00043">list_head::next</a>, <a class="el" href="lustre__idl_8h_source.html#l03408">obdo::o_lcookie</a>, <a class="el" href="lustre__idl_8h_source.html#l03486">ost_body::oa</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00179">osp_device::opd_pre</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00096">OSP_JOB_MAGIC</a>, <a class="el" href="osp__precreate_8c_source.html#l00231">osp_statfs_need_now()</a>, <a class="el" href="osp__sync_8c_source.html#l00229">osp_sync_check_for_work</a>, <a class="el" href="osp__sync_8c_source.html#l00106">osp_sync_running()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l01105">RMF_OST_BODY</a>, <a class="el" href="lustre__net_8h_source.html#l00873">rq_async_args</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>, and <a class="el" href="osp__sync_8c_source.html#l01142">osp_sync_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a15fc77c40df3fca55b7a55d66b5b7ab6"></a><!-- doxytag: member="osp_sync.c::osp_sync_process_queues" ref="a15fc77c40df3fca55b7a55d66b5b7ab6" args="(const struct lu_env *env, struct llog_handle *llh, struct llog_rec_hdr *rec, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_process_queues </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>rec</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The core of the syncing mechanism. </p>
<p>This is a callback called by the llog processing function. Essentially it suspends llog processing until there is a record to process (it's supposed to be committed locally). The function handles RPCs committed by the target and cancels corresponding llog records.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle we're processing </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rec</em>&nbsp;</td><td>current llog record </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>data</em>&nbsp;</td><td>callback data containing a pointer to the device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>to ask the caller (<a class="el" href="group__log.html#ga80616f32350d097166d698292330b6b2">llog_process()</a>) to continue </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>LLOG_PROC_BREAK</em>&nbsp;</td><td>to ask the caller to break </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01076">1076</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="lustre__log_8h_source.html#l00328">LLOG_PROC_BREAK</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00223">osp_device::opd_syn_last_processed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00218">osp_device::opd_syn_last_used_id</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00255">osp_sync_can_process_new()</a>, <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>, <a class="el" href="osp__sync_8c_source.html#l00849">osp_sync_process_record()</a>, <a class="el" href="osp__sync_8c_source.html#l01655">osp_sync_remove_from_tracker()</a>, and <a class="el" href="osp__sync_8c_source.html#l00106">osp_sync_running()</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01142">osp_sync_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="a92f53f43a5c8a87d8f09b986021c16dc"></a><!-- doxytag: member="osp_sync.c::osp_sync_process_record" ref="a92f53f43a5c8a87d8f09b986021c16dc" args="(const struct lu_env *env, struct osp_device *d, struct llog_handle *llh, struct llog_rec_hdr *rec)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_process_record </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__handle.html">llog_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>llh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structllog__rec__hdr.html">llog_rec_hdr</a> *&nbsp;</td>
          <td class="paramname"> <em>rec</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Process llog records. </p>
<p>This function is called to process the llog records committed locally. In the recovery model used by OSP we can apply a change to a remote target once corresponding transaction (like posix unlink) is committed locally so can't revert. Depending on the llog record type, a given handler is called that is responsible for preparing and sending the RPC to apply the change. Special record type LLOG_GEN_REC marking a reboot is cancelled right away.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>LU environment provided by the caller </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llh</em>&nbsp;</td><td>llog handle where the record is stored </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>rec</em>&nbsp;</td><td>llog record </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00849">849</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l03346">llog_cookie::lgc_index</a>, <a class="el" href="lustre__idl_8h_source.html#l03344">llog_cookie::lgc_lgl</a>, <a class="el" href="lustre__idl_8h_source.html#l03345">llog_cookie::lgc_subsys</a>, <a class="el" href="lustre__log_8h_source.html#l00265">llog_handle::lgh_id</a>, <a class="el" href="lustre__log_8h_source.html#l00268">llog_handle::lgh_obj</a>, <a class="el" href="lustre__idl_8h_source.html#l03277">llog_gen_rec::lgr_gen</a>, <a class="el" href="llog__cat_8c_source.html#l00673">llog_cat_cancel_records()</a>, <a class="el" href="packet-lustre_8c_source.html#l00347">LLOG_GEN_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__idl_8h_source.html#l03117">llog_rec_hdr::lrh_id</a>, <a class="el" href="lustre__idl_8h_source.html#l03115">llog_rec_hdr::lrh_index</a>, <a class="el" href="lustre__idl_8h_source.html#l03114">llog_rec_hdr::lrh_len</a>, <a class="el" href="lustre__idl_8h_source.html#l03116">llog_rec_hdr::lrh_type</a>, <a class="el" href="lu__object_8h_source.html#l00770">lu_object_fid()</a>, <a class="el" href="lustre__idl_8h_source.html#l03092">MDS_SETATTR64_REC</a>, <a class="el" href="lustre__idl_8h_source.html#l03089">MDS_UNLINK64_REC</a>, <a class="el" href="packet-lustre_8c_source.html#l00343">MDS_UNLINK_REC</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00228">osp_device::opd_syn_barrier_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00195">osp_device::opd_syn_generation</a>, <a class="el" href="osp__internal_8h_source.html#l00221">osp_device::opd_syn_last_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00223">osp_device::opd_syn_last_processed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00199">osp_device::opd_syn_prev_done</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__sync_8c_source.html#l00700">osp_sync_new_setattr_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00804">osp_sync_new_unlink64_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00758">osp_sync_new_unlink_job()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="lustre__log_8h_source.html#l00280">llog_handle::phd</a>, <a class="el" href="lustre__log_8h_source.html#l00070">plain_handle_data::phd_cat_handle</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, <a class="el" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">llog_handle::u</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>.</p>

</div>
</div>
<a class="anchor" id="a298967b0454970ad561dba030cf2c357"></a><!-- doxytag: member="osp_sync.c::osp_sync_remove_from_tracker" ref="a298967b0454970ad561dba030cf2c357" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_remove_from_tracker </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Stop to propagate commit status to OSP. </p>
<p>If the OSP does not have any llog records she's waiting to commit, then it is possible to unsubscribe from wakeups from the tracking using this method.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device not willing to wakeup </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01655">1655</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00125">list_del_init()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="osp__internal_8h_source.html#l00225">osp_device::opd_syn_ontrack</a>, <a class="el" href="osp__internal_8h_source.html#l00224">osp_device::opd_syn_tracker</a>, and <a class="el" href="osp__internal_8h_source.html#l00057">osp_id_tracker::otr_lock</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01576">osp_sync_id_traction_fini()</a>, and <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>.</p>

</div>
</div>
<a class="anchor" id="aa4b213415741d3928d984779b48b88d9"></a><!-- doxytag: member="osp_sync.c::osp_sync_request_commit_cb" ref="aa4b213415741d3928d984779b48b88d9" args="(struct ptlrpc_request *req)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_request_commit_cb </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>ptlrpc commit callback. </p>
<p>The callback is called by PTLRPC when a RPC is reported committed by the target (OST). We register the callback for the every RPC applying a change from the llog. This way we know then the llog records can be cancelled. Notice the callback can be called when OSP is finishing. We can detect this checking that actual transno in the request is less or equal of known committed transno (see <a class="el" href="osp__sync_8c.html#adc4574cb21d6ff16f6211ce271cc4a5c" title="Cancel llog records for the committed changes.">osp_sync_process_committed()</a> for the details). XXX: this is pretty expensive and can be improved later using batching.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>req</em>&nbsp;</td><td>request </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00470">470</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00148">D_HA</a>, <a class="el" href="osp__sync_8c_source.html#l00101">osp_job_req_args::jra_committed_link</a>, <a class="el" href="osp__sync_8c_source.html#l00103">osp_job_req_args::jra_magic</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00076">list_add()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00096">OSP_JOB_MAGIC</a>, <a class="el" href="lustre__net_8h_source.html#l00505">ptlrpc_req_async_args</a>, <a class="el" href="client_8c_source.html#l02757">ptlrpc_request_addref()</a>, <a class="el" href="lustre__net_8h_source.html#l01034">ptlrpc_request::rq_transno</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00637">osp_sync_new_job()</a>.</p>

</div>
</div>
<a class="anchor" id="aa293420ce1e7f4c70e7238eb8704c10c"></a><!-- doxytag: member="osp_sync.c::osp_sync_running" ref="aa293420ce1e7f4c70e7238eb8704c10c" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_running </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00106">106</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00201">osp_device::opd_syn_thread</a>, <a class="el" href="lustre__net_8h_source.html#l01497">SVC_RUNNING</a>, and <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>, <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>, and <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>.</p>

</div>
</div>
<a class="anchor" id="a0b597dbd85f05976ebd53a62e56cc5f4"></a><!-- doxytag: member="osp_sync.c::osp_sync_send_new_rpc" ref="a0b597dbd85f05976ebd53a62e56cc5f4" args="(struct osp_device *d, struct ptlrpc_request *req)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_send_new_rpc </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00602">602</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="osp__sync_8c_source.html#l00101">osp_job_req_args::jra_committed_link</a>, <a class="el" href="osp__sync_8c_source.html#l00102">osp_job_req_args::jra_inflight_link</a>, <a class="el" href="osp__sync_8c_source.html#l00103">osp_job_req_args::jra_magic</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00090">list_add_tail()</a>, <a class="el" href="osp__internal_8h_source.html#l00204">osp_device::opd_syn_inflight_list</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00211">osp_device::opd_syn_max_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__sync_8c_source.html#l00096">OSP_JOB_MAGIC</a>, <a class="el" href="lustre__net_8h_source.html#l00505">ptlrpc_req_async_args</a>, and <a class="el" href="ptlrpcd_8c_source.html#l00268">ptlrpcd_add_req()</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l00700">osp_sync_new_setattr_job()</a>, <a class="el" href="osp__sync_8c_source.html#l00804">osp_sync_new_unlink64_job()</a>, and <a class="el" href="osp__sync_8c_source.html#l00758">osp_sync_new_unlink_job()</a>.</p>

</div>
</div>
<a class="anchor" id="aa3eb6a90c19d78fd6e103a1e338f329a"></a><!-- doxytag: member="osp_sync.c::osp_sync_stopped" ref="aa3eb6a90c19d78fd6e103a1e338f329a" args="(struct osp_device *d)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_stopped </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structosp__device.html">osp_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check status: whether OSP thread has stopped. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>OSP device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>still running </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>stopped </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l00119">119</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="osp__internal_8h_source.html#l00201">osp_device::opd_syn_thread</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, and <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a775a5561afc9b3daa77f0bf9dfa9e19e"></a><!-- doxytag: member="osp_sync.c::osp_sync_thread" ref="a775a5561afc9b3daa77f0bf9dfa9e19e" args="(void *_arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int osp_sync_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>_arg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>OSP sync thread. </p>
<p>This thread runs <a class="el" href="group__log.html#ga466f538de595963c4d02460408b4ca01">llog_cat_process()</a> scanner calling our callback to process llog records. in the callback we implement tricky state machine as we don't want to start scanning of the llog again and again, also we don't want to process too many records and send too many RPCs a time. so, depending on current load (num of changes being synced to OST) the callback can suspend awaiting for some new conditions, like syncs completed.</p>
<p>In order to process llog records left by previous boots and to allow <a class="el" href="llog_8c.html#ac9d38e164ec46dc2fb164ee78d093493">llog_process_thread()</a> to find something (otherwise it'd just exit immediately) we add a special GENERATATION record on each boot.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>_arg</em>&nbsp;</td><td>a pointer to thread's arguments</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01142">1142</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="linux-time_8h_source.html#l00182">cfs_time_seconds()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="lu__object_8h_source.html#l01024">LCT_LOCAL</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="llog__cat_8c_source.html#l00271">llog_cat_close()</a>, <a class="el" href="llog__cat_8c_source.html#l00838">llog_cat_process()</a>, <a class="el" href="llog__obd_8c_source.html#l00108">llog_cleanup()</a>, <a class="el" href="lustre__log_8h_source.html#l00375">llog_ctxt_put()</a>, <a class="el" href="lustre__log_8h_source.html#l00431">llog_get_context()</a>, <a class="el" href="lustre__idl_8h_source.html#l03046">LLOG_MDS_OST_ORIG_CTXT</a>, <a class="el" href="lustre__log_8h_source.html#l00328">LLOG_PROC_BREAK</a>, <a class="el" href="lustre__log_8h_source.html#l00316">llog_ctxt::loc_handle</a>, <a class="el" href="lu__object_8c_source.html#l01881">lu_env_fini()</a>, <a class="el" href="lu__object_8c_source.html#l01869">lu_env_init()</a>, <a class="el" href="lustre__lib_8h_source.html#l00171">LWI_TIMEOUT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="osp__internal_8h_source.html#l00159">osp_device::opd_obd</a>, <a class="el" href="osp__internal_8h_source.html#l00197">osp_device::opd_syn_changes</a>, <a class="el" href="osp__internal_8h_source.html#l00206">osp_device::opd_syn_committed_there</a>, <a class="el" href="osp__internal_8h_source.html#l00193">osp_device::opd_syn_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00210">osp_device::opd_syn_rpc_in_flight</a>, <a class="el" href="osp__internal_8h_source.html#l00213">osp_device::opd_syn_rpc_in_progress</a>, <a class="el" href="osp__internal_8h_source.html#l00201">osp_device::opd_syn_thread</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__sync_8c_source.html#l00966">osp_sync_process_committed()</a>, <a class="el" href="osp__sync_8c_source.html#l01076">osp_sync_process_queues()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="lustre__net_8h_source.html#l01497">SVC_RUNNING</a>, <a class="el" href="lustre__net_8h_source.html#l01494">SVC_STOPPED</a>, <a class="el" href="lustre__net_8h_source.html#l01532">ptlrpc_thread::t_ctl_waitq</a>, <a class="el" href="lustre__net_8h_source.html#l01515">ptlrpc_thread::t_flags</a>, and <a class="el" href="obd_8c_source.html#l00114">thread</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01381">osp_sync_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a1b3a3246bd146ad7ecfe9f113bca8fe4"></a><!-- doxytag: member="osp_sync.c::osp_sync_tracker_commit_cb" ref="a1b3a3246bd146ad7ecfe9f113bca8fe4" args="(struct thandle *th, void *cookie)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void osp_sync_tracker_commit_cb </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>cookie</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>OSD commit callback. </p>
<p>The function is used as a local OSD commit callback to track the highest committed llog record id. see <a class="el" href="osp__sync_8c.html#abf8555d012e3aad2b46b362e92222673" title="Initialize commit tracking mechanism.">osp_sync_id_traction_init()</a> for the details.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>local transaction handle committed </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cookie</em>&nbsp;</td><td>commit callback data (our private structure) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01476">1476</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__private_8h_source.html#l00309">likely</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="osp__internal_8h_source.html#l00221">osp_device::opd_syn_last_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00202">osp_device::opd_syn_waitq</a>, <a class="el" href="osp__internal_8h_source.html#l00428">osp_txn_info()</a>, <a class="el" href="osp__internal_8h_source.html#l00423">osp_txn_info::oti_current_id</a>, <a class="el" href="osp__internal_8h_source.html#l00059">osp_id_tracker::otr_committed_id</a>, <a class="el" href="osp__internal_8h_source.html#l00057">osp_id_tracker::otr_lock</a>, <a class="el" href="osp__internal_8h_source.html#l00063">osp_id_tracker::otr_wakeup_list</a>, and <a class="el" href="dt__object_8h_source.html#l01838">thandle::th_ctx</a>.</p>

<p>Referenced by <a class="el" href="osp__sync_8c_source.html#l01522">osp_sync_id_traction_init()</a>.</p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a286f86d5ed3059117935e8ddfde47449"></a><!-- doxytag: member="osp_sync.c::osp_id_tracker_list" ref="a286f86d5ed3059117935e8ddfde47449" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structlist__head.html">list_head</a> <a class="el" href="osp__sync_8c.html#a286f86d5ed3059117935e8ddfde47449">osp_id_tracker_list</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment">
                <a class="code" href="list_8h.html#a4642d4b7df28478bb762fe43c85b5c63">LIST_HEAD_INIT</a>(<a class="code" href="osp__sync_8c.html#a286f86d5ed3059117935e8ddfde47449">osp_id_tracker_list</a>)
</pre></div>
<p>Definition at line <a class="el" href="osp__sync_8c_source.html#l01464">1464</a> of file <a class="el" href="osp__sync_8c_source.html">osp_sync.c</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:50 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
