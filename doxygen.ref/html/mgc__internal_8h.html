<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/mgc/mgc_internal.h File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/mgc/mgc_internal.h File Reference</h1><code>#include &lt;<a class="el" href="libcfs_8h_source.html">libcfs/libcfs.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__idl_8h_source.html">lustre/lustre_idl.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__lib_8h_source.html">lustre_lib.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__dlm_8h_source.html">lustre_dlm.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__log_8h_source.html">lustre_log.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__export_8h_source.html">lustre_export.h</a>&gt;</code><br/>

<p><a href="mgc__internal_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="mgc__internal_8h.html#aa41264fe823f5ec74ae97e9b28b0d6c3">mgc_process_log</a> (struct <a class="el" href="structobd__device.html">obd_device</a> *mgc, struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *cld)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get a configuration log from the MGS and process it.  <a href="#aa41264fe823f5ec74ae97e9b28b0d6c3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="mgc__internal_8h.html#a31bd05c0e89a7f0c5ef6c03d3e23aa10">cld_is_sptlrpc</a> (struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *cld)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="mgc__internal_8h.html#a0fbc38cc0e41e4f805a3e23a9f7bff8c">cld_is_recover</a> (struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *cld)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0fbc38cc0e41e4f805a3e23a9f7bff8c"></a><!-- doxytag: member="mgc_internal.h::cld_is_recover" ref="a0fbc38cc0e41e4f805a3e23a9f7bff8c" args="(struct config_llog_data *cld)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int cld_is_recover </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *&nbsp;</td>
          <td class="paramname"> <em>cld</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mgc__internal_8h_source.html#l00059">59</a> of file <a class="el" href="mgc__internal_8h_source.html">mgc_internal.h</a>.</p>

<p>References <a class="el" href="obd__class_8h_source.html#l00204">config_llog_data::cld_type</a>, and <a class="el" href="obd__class_8h_source.html#l00185">CONFIG_T_RECOVER</a>.</p>

<p>Referenced by <a class="el" href="mgc__request_8c_source.html#l01878">mgc_process_log()</a>, and <a class="el" href="mgc__request_8c_source.html#l01537">mgc_process_recover_log()</a>.</p>

</div>
</div>
<a class="anchor" id="a31bd05c0e89a7f0c5ef6c03d3e23aa10"></a><!-- doxytag: member="mgc_internal.h::cld_is_sptlrpc" ref="a31bd05c0e89a7f0c5ef6c03d3e23aa10" args="(struct config_llog_data *cld)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int cld_is_sptlrpc </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *&nbsp;</td>
          <td class="paramname"> <em>cld</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="mgc__internal_8h_source.html#l00054">54</a> of file <a class="el" href="mgc__internal_8h_source.html">mgc_internal.h</a>.</p>

<p>References <a class="el" href="obd__class_8h_source.html#l00204">config_llog_data::cld_type</a>, and <a class="el" href="obd__class_8h_source.html#l00184">CONFIG_T_SPTLRPC</a>.</p>

<p>Referenced by <a class="el" href="mgc__request_8c_source.html#l00168">config_log_find()</a>, <a class="el" href="mgc__request_8c_source.html#l00135">config_log_put()</a>, <a class="el" href="mgc__request_8c_source.html#l00200">do_config_log_add()</a>, <a class="el" href="mgc__request_8c_source.html#l01049">mgc_enqueue()</a>, and <a class="el" href="mgc__request_8c_source.html#l01728">mgc_process_cfg_log()</a>.</p>

</div>
</div>
<a class="anchor" id="aa41264fe823f5ec74ae97e9b28b0d6c3"></a><!-- doxytag: member="mgc_internal.h::mgc_process_log" ref="aa41264fe823f5ec74ae97e9b28b0d6c3" args="(struct obd_device *mgc, struct config_llog_data *cld)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int mgc_process_log </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__device.html">obd_device</a> *&nbsp;</td>
          <td class="paramname"> <em>mgc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconfig__llog__data.html">config_llog_data</a> *&nbsp;</td>
          <td class="paramname"> <em>cld</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get a configuration log from the MGS and process it. </p>
<p>This function is called for both clients and servers to process the configuration log from the MGS. The MGC enqueues a DLM lock on the log from the MGS, and if the lock gets revoked the MGC will be notified by the lock cancellation callback that the config log has changed, and will enqueue another MGS lock on it, and then continue processing the new additions to the end of the log.</p>
<p>Since the MGC import is not replayable, if the import is being evicted (rcl == -ESHUTDOWN, </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="client_8c.html#a74e44d223c09372b3da86638b5621408" title="Based on the current state of the import, determine if the request can be sent, is...">ptlrpc_import_delay_req()</a>), retry to <a class="el" href="parser_8c.html#ab711deb59ead2a3a9484204fef62b906">process</a> the <a class="el" href="group__log.html">log</a> until recovery is finished or the import is closed.</dd></dl>
<p>Make a local copy of the log before parsing it if appropriate (non-MGS server) so that the server can start even when the MGS is down.</p>
<p>There shouldn't be multiple processes running process_log at once -- sounds like badness. It actually might be fine, as long as they're not trying to update from the same log simultaneously, in which case we should use a per-log semaphore instead of cld_lock.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>mgc</em>&nbsp;</td><td>MGC device by which to fetch the configuration log </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cld</em>&nbsp;</td><td>log processing state (stored in lock callback data)</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>errno on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="mgc__request_8c_source.html#l01878">1878</a> of file <a class="el" href="mgc__request_8c_source.html">mgc_request.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="obd__class_8h_source.html#l00171">config_llog_instance::cfg_instance</a>, <a class="el" href="obd__class_8h_source.html#l00175">config_llog_instance::cfg_last_idx</a>, <a class="el" href="linux-time_8h_source.html#l00182">cfs_time_seconds()</a>, <a class="el" href="obd_8h_source.html#l00309">client_obd::cl_mgc_mgsexp</a>, <a class="el" href="obd_8h_source.html#l00308">client_obd::cl_mgc_refcount</a>, <a class="el" href="genops_8c_source.html#l00749">class_exp2cliimp()</a>, <a class="el" href="obd__class_8h_source.html#l00196">config_llog_data::cld_cfg</a>, <a class="el" href="mgc__internal_8h_source.html#l00059">cld_is_recover()</a>, <a class="el" href="obd__class_8h_source.html#l00203">config_llog_data::cld_lock</a>, <a class="el" href="obd__class_8h_source.html#l00208">config_llog_data::cld_logname</a>, <a class="el" href="obd__class_8h_source.html#l00205">config_llog_data::cld_lostlock</a>, <a class="el" href="obd__class_8h_source.html#l00205">config_llog_data::cld_stopping</a>, <a class="el" href="obd_8h_source.html#l00699">obd_device::cli</a>, <a class="el" href="mgc__request_8c_source.html#l00124">config_log_get()</a>, <a class="el" href="mgc__request_8c_source.html#l00042">D_MGC</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__import_8h_source.html#l00217">obd_import::imp_recovery_waitq</a>, <a class="el" href="lustre__import_8h_source.html#l00230">obd_import::imp_state</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="packet-lustre_8c_source.html#l00295">LCK_CR</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00289">LDLM_FL_NO_LRU</a>, <a class="el" href="ldlm__lock_8c_source.html#l02293">ldlm_lock_set_data()</a>, <a class="el" href="packet-lustre_8c_source.html#l00298">LDLM_PLAIN</a>, <a class="el" href="lustre__import_8h_source.html#l00106">LUSTRE_IMP_FULL</a>, <a class="el" href="lustre__lib_8h_source.html#l00171">LWI_TIMEOUT</a>, <a class="el" href="mgc__request_8c_source.html#l01097">mgc_cancel()</a>, <a class="el" href="mgc__request_8c_source.html#l01049">mgc_enqueue()</a>, <a class="el" href="mgc__request_8c_source.html#l01837">mgc_import_in_recovery()</a>, <a class="el" href="mgc__request_8c_source.html#l01728">mgc_process_cfg_log()</a>, <a class="el" href="mgc__request_8c_source.html#l01537">mgc_process_recover_log()</a>, <a class="el" href="obd__support_8h_source.html#l00458">OBD_FAIL_MGC_PAUSE_PROCESS_LOG</a>, <a class="el" href="obd__support_8h_source.html#l00624">OBD_FAIL_TIMEOUT</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="class__obd_8c_source.html#l00083">obd_timeout</a>, <a class="el" href="import_8c_source.html#l00415">ptlrpc_pinger_force()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">obd_device::u</a>.</p>

<p>Referenced by <a class="el" href="mgc__request_8c_source.html#l00200">do_config_log_add()</a>, <a class="el" href="mgc__request_8c_source.html#l00514">do_requeue()</a>, and <a class="el" href="mgc__request_8c_source.html#l01990">mgc_process_config()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:49 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
