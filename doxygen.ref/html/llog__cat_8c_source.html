<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/obdclass/llog_cat.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/obdclass/llog_cat.c</h1><a href="llog__cat_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.sun.com/software/products/lustre/docs/GPLv2.pdf</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2003, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2012, 2015, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * lustre/obdclass/llog_cat.c</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * OST&lt;-&gt;MDS recovery logging infrastructure.</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Invariants in implementation:</span>
<a name="l00041"></a>00041 <span class="comment"> * - we do not share logs among different OST&lt;-&gt;MDS connections, so that</span>
<a name="l00042"></a>00042 <span class="comment"> *   if an OST or MDS fails it need only look at log(s) relevant to itself</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * Author: Andreas Dilger &lt;adilger@clusterfs.com&gt;</span>
<a name="l00045"></a>00045 <span class="comment"> * Author: Alexey Zhuravlev &lt;alexey.zhuravlev@intel.com&gt;</span>
<a name="l00046"></a>00046 <span class="comment"> * Author: Mikhail Pershin &lt;mike.pershin@intel.com&gt;</span>
<a name="l00047"></a>00047 <span class="comment"> */</span>
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="llog__cat_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00049</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_LOG</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="obd__class_8h.html">obd_class.h</a>&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="llog__internal_8h.html">llog_internal.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/* Create a new log handle and add it to the open list.</span>
<a name="l00057"></a>00057 <span class="comment"> * This log handle will be closed when all of the records in it are removed.</span>
<a name="l00058"></a>00058 <span class="comment"> *</span>
<a name="l00059"></a>00059 <span class="comment"> * Assumes caller has already pushed us into the kernel context and is locking.</span>
<a name="l00060"></a>00060 <span class="comment"> */</span>
<a name="l00061"></a><a class="code" href="llog__cat_8c.html#aa06aabd6c419f312c2eddb8d7141b169">00061</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#aa06aabd6c419f312c2eddb8d7141b169">llog_cat_new_log</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00062"></a>00062                             <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00063"></a>00063                             <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *loghandle,
<a name="l00064"></a>00064                             <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066         <span class="keyword">struct </span><a class="code" href="structllog__thread__info.html">llog_thread_info</a> *lgi = <a class="code" href="llog__internal_8h.html#aced0fd9169ddaecf43a6cd75c11bfbfb">llog_info</a>(env);
<a name="l00067"></a>00067         <span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a>   *rec = &amp;lgi-&gt;<a class="code" href="structllog__thread__info.html#aaec48c6846322edb549007784736ff71">lgi_logid</a>;
<a name="l00068"></a>00068         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *handle = NULL;
<a name="l00069"></a>00069         <span class="keyword">struct </span><a class="code" href="structdt__device.html">dt_device</a> *dt = NULL;
<a name="l00070"></a>00070         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a>     *llh = cathandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00071"></a>00071         <span class="keywordtype">int</span>                      rc, index;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         index = (cathandle-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a> + 1) %
<a name="l00076"></a>00076                 (<a class="code" href="obd__support_8h.html#a2894b095c98960b30c09449ce0b2cd4b">OBD_FAIL_PRECHECK</a>(<a class="code" href="obd__support_8h.html#a3071dcdc4af4192bdb7260c3bdd3b756">OBD_FAIL_CAT_RECORDS</a>) ? (<a class="code" href="libcfs__fail_8h.html#a2ef1cb02c9a3c9f5a23b1f818d3b99ba">cfs_fail_val</a> + 1) :
<a name="l00077"></a>00077                                                 <a class="code" href="group__lustreidl.html#gab2b7cae67de8c1053d1e5bb6d0293092">LLOG_HDR_BITMAP_SIZE</a>(llh));
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="comment">/* check that new llog index will not overlap with the first one.</span>
<a name="l00080"></a>00080 <span class="comment">         * - llh_cat_idx is the index just before the first/oldest still in-use</span>
<a name="l00081"></a>00081 <span class="comment">         *      index in catalog</span>
<a name="l00082"></a>00082 <span class="comment">         * - lgh_last_idx is the last/newest used index in catalog</span>
<a name="l00083"></a>00083 <span class="comment">         *</span>
<a name="l00084"></a>00084 <span class="comment">         * When catalog is not wrapped yet then lgh_last_idx is always larger</span>
<a name="l00085"></a>00085 <span class="comment">         * than llh_cat_idx. After the wrap around lgh_last_idx re-starts</span>
<a name="l00086"></a>00086 <span class="comment">         * from 0 and llh_cat_idx becomes the upper limit for it</span>
<a name="l00087"></a>00087 <span class="comment">         *</span>
<a name="l00088"></a>00088 <span class="comment">         * Check if catalog has already wrapped around or not by comparing</span>
<a name="l00089"></a>00089 <span class="comment">         * last_idx and cat_idx */</span>
<a name="l00090"></a>00090         <span class="keywordflow">if</span> ((index == llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> + 1 &amp;&amp; llh-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> &gt; 1) ||
<a name="l00091"></a>00091             (index == 0 &amp;&amp; llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> == 0)) {
<a name="l00092"></a>00092                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%s: there are no more free slots in catalog\n&quot;</span>,
<a name="l00093"></a>00093                       loghandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>);
<a name="l00094"></a>00094                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOSPC);
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#a159fcf9a7f87ef5815883d6358a2a1e4">OBD_FAIL_MDS_LLOG_CREATE_FAILED</a>))
<a name="l00098"></a>00098                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOSPC);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         <span class="keywordflow">if</span> (loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a> != NULL) {
<a name="l00101"></a>00101                 <span class="comment">/* If llog object is remote and creation is failed, lgh_hdr</span>
<a name="l00102"></a>00102 <span class="comment">                 * might be left over here, free it first */</span>
<a name="l00103"></a>00103                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(loghandle));
<a name="l00104"></a>00104                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>, loghandle-&gt;<a class="code" href="structllog__handle.html#a35be130a0a3b5ef609f19c0677670c42">lgh_hdr_size</a>);
<a name="l00105"></a>00105                 loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a> = NULL;
<a name="l00106"></a>00106         }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">if</span> (th == NULL) {
<a name="l00109"></a>00109                 dt = <a class="code" href="group__dt.html#ga194153652787b274d44d8e2ed6ad8a23">lu2dt_dev</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a>-&gt;<a class="code" href="structdt__object.html#af646d1f1afe6acdc83ad0778a29163d7">do_lu</a>.<a class="code" href="structlu__object.html#a5b9108a283d9901c95bdf32833f70601" title="Device for this layer.">lo_dev</a>);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111                 handle = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, dt);
<a name="l00112"></a>00112                 <span class="keywordflow">if</span> (IS_ERR(handle))
<a name="l00113"></a>00113                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(handle));
<a name="l00114"></a>00114 
<a name="l00115"></a>00115                 <span class="comment">/* Create update llog object synchronously, which</span>
<a name="l00116"></a>00116 <span class="comment">                 * happens during inialization process see</span>
<a name="l00117"></a>00117 <span class="comment">                 * lod_sub_prep_llog(), to make sure the update</span>
<a name="l00118"></a>00118 <span class="comment">                 * llog object is created before corss-MDT writing</span>
<a name="l00119"></a>00119 <span class="comment">                 * updates into the llog object */</span>
<a name="l00120"></a>00120                 <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#a415612178c6234f1dae35f8181ebbaf5">loc_flags</a> &amp; <a class="code" href="group__log.html#ga4fb64387d4343fd5387485fc0f600cb0">LLOG_CTXT_FLAG_NORMAL_FID</a>)
<a name="l00121"></a>00121                         handle-&gt;<a class="code" href="structthandle.html#a4ebd1192a1e6fd4868826aee3ad1ec05" title="whether we need sync commit">th_sync</a> = 1;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123                 handle-&gt;<a class="code" href="structthandle.html#ac9e6b3e5dc1efd29172c0f4ce214094c">th_wait_submit</a> = 1;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125                 rc = <a class="code" href="group__log.html#ga4f29ac09d8ce9183650aa713038b2c92">llog_declare_create</a>(env, loghandle, handle);
<a name="l00126"></a>00126                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00127"></a>00127                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129                 rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#ad78574b9a0f5e0400ba90c351a0add96">lrh_len</a> = <span class="keyword">sizeof</span>(*rec);
<a name="l00130"></a>00130                 rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#aed3a83bae3600611db70e81a693e2ec4">lrh_type</a> = <a class="code" href="group__lustreidl.html#gga46267c71f9f2221271c977534b08c789ab129649a06968f909cf43e2705008040">LLOG_LOGID_MAGIC</a>;
<a name="l00131"></a>00131                 rec-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a> = loghandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>;
<a name="l00132"></a>00132                 rc = <a class="code" href="group__log.html#ga1db1cffd9f210c9f081370af6106a606">llog_declare_write_rec</a>(env, cathandle, &amp;rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>, -1,
<a name="l00133"></a>00133                                             handle);
<a name="l00134"></a>00134                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00135"></a>00135                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137                 rc = <a class="code" href="group__dt.html#gaec633f618ffdd701fa5f233dd4c1d161">dt_trans_start_local</a>(env, dt, handle);
<a name="l00138"></a>00138                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00139"></a>00139                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141                 th = handle;
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         rc = <a class="code" href="group__log.html#gad1dcf7f6a3d54acd725f99455d849ca8">llog_create</a>(env, loghandle, th);
<a name="l00145"></a>00145         <span class="comment">/* if llog is already created, no need to initialize it */</span>
<a name="l00146"></a>00146         <span class="keywordflow">if</span> (rc == -EEXIST) {
<a name="l00147"></a>00147                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = 0);
<a name="l00148"></a>00148         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != 0) {
<a name="l00149"></a>00149                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: can&apos;t create new plain llog in catalog: rc = %d\n&quot;</span>,
<a name="l00150"></a>00150                        loghandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l00151"></a>00151                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154         rc = <a class="code" href="group__log.html#ga546fd23355c24d4ee2a5a668423c0156">llog_init_handle</a>(env, loghandle,
<a name="l00155"></a>00155                               <a class="code" href="packet-lustre_8c.html#add954ed69fa13ff781aa8433731a5ea2">LLOG_F_IS_PLAIN</a> | <a class="code" href="packet-lustre_8c.html#a2d868eaf522881c3349b8e375f6b9757">LLOG_F_ZAP_WHEN_EMPTY</a>,
<a name="l00156"></a>00156                               &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>-&gt;<a class="code" href="structllog__log__hdr.html#a89d0129ca1b69188449a32ce6d7481a4">llh_tgtuuid</a>);
<a name="l00157"></a>00157         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00158"></a>00158                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         <span class="comment">/* build the record for this log in the catalog */</span>
<a name="l00161"></a>00161         rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#ad78574b9a0f5e0400ba90c351a0add96">lrh_len</a> = <span class="keyword">sizeof</span>(*rec);
<a name="l00162"></a>00162         rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#aed3a83bae3600611db70e81a693e2ec4">lrh_type</a> = <a class="code" href="group__lustreidl.html#gga46267c71f9f2221271c977534b08c789ab129649a06968f909cf43e2705008040">LLOG_LOGID_MAGIC</a>;
<a name="l00163"></a>00163         rec-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a> = loghandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="comment">/* append the new record into catalog. The new index will be</span>
<a name="l00166"></a>00166 <span class="comment">         * assigned to the record and updated in rec header */</span>
<a name="l00167"></a>00167         rc = <a class="code" href="group__log.html#ga38790001c86a4ad331c76a6e8698b6e9">llog_write_rec</a>(env, cathandle, &amp;rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>,
<a name="l00168"></a>00168                             &amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>, <a class="code" href="group__log.html#gga2f80701c36e79c0640d91c788feee0b3a9e3f5a45a9b1488b2fc203fe85242388">LLOG_NEXT_IDX</a>, th);
<a name="l00169"></a>00169         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00170"></a>00170                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(<a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>, rc);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#ab317254094d62cdd1f3b99bf74c98edc">D_OTHER</a>, <span class="stringliteral">&quot;new plain log &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;:%x for index %u of catalog&quot;</span>
<a name="l00173"></a>00173                <a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>),
<a name="l00174"></a>00174                loghandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>, rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>,
<a name="l00175"></a>00175                <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> = rec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>;
<a name="l00178"></a>00178 out:
<a name="l00179"></a>00179         <span class="keywordflow">if</span> (handle != NULL) {
<a name="l00180"></a>00180                 handle-&gt;<a class="code" href="structthandle.html#a768f192711e7d5c5280da153173cb463" title="the last operation result in this transaction.">th_result</a> = rc &gt;= 0 ? 0 : rc;
<a name="l00181"></a>00181                 <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, dt, handle);
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <a class="code" href="out__handler_8c.html#a824a9dd339ab3546f17e52bafc044db3">out_destroy</a>:
<a name="l00186"></a>00186         <span class="comment">/* to signal llog_cat_close() it shouldn&apos;t try to destroy the llog,</span>
<a name="l00187"></a>00187 <span class="comment">         * we want to destroy it in this transaction, otherwise the object</span>
<a name="l00188"></a>00188 <span class="comment">         * becomes an orphan */</span>
<a name="l00189"></a>00189         loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp;= ~<a class="code" href="packet-lustre_8c.html#a2d868eaf522881c3349b8e375f6b9757">LLOG_F_ZAP_WHEN_EMPTY</a>;
<a name="l00190"></a>00190         <span class="comment">/* this is to mimic full log, so another llog_cat_current_log()</span>
<a name="l00191"></a>00191 <span class="comment">         * can skip it and ask for another onet */</span>
<a name="l00192"></a>00192         loghandle-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a> = <a class="code" href="group__lustreidl.html#gab2b7cae67de8c1053d1e5bb6d0293092">LLOG_HDR_BITMAP_SIZE</a>(llh) + 1;
<a name="l00193"></a>00193         <a class="code" href="group__log.html#gadac4383f18bef43704ff9b2403398263">llog_trans_destroy</a>(env, loghandle, th);
<a name="l00194"></a>00194         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">/* Open an existent log handle and add it to the open list.</span>
<a name="l00198"></a>00198 <span class="comment"> * This log handle will be closed when all of the records in it are removed.</span>
<a name="l00199"></a>00199 <span class="comment"> *</span>
<a name="l00200"></a>00200 <span class="comment"> * Assumes caller has already pushed us into the kernel context and is locking.</span>
<a name="l00201"></a>00201 <span class="comment"> * We return a lock on the handle to ensure nobody yanks it from us.</span>
<a name="l00202"></a>00202 <span class="comment"> *</span>
<a name="l00203"></a>00203 <span class="comment"> * This takes extra reference on llog_handle via llog_handle_get() and require</span>
<a name="l00204"></a>00204 <span class="comment"> * this reference to be put by caller using llog_handle_put()</span>
<a name="l00205"></a>00205 <span class="comment"> */</span>
<a name="l00206"></a><a class="code" href="llog__internal_8h.html#abb315a9e5d0cec5f9cc55473a596304c">00206</a> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#abb315a9e5d0cec5f9cc55473a596304c">llog_cat_id2handle</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00207"></a>00207                        <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> **res, <span class="keyword">struct</span> <a class="code" href="structllog__logid.html" title="Identifier for a single log object.">llog_logid</a> *logid)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a>      *loghandle;
<a name="l00210"></a>00210         <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga950dc01c678c8dd1bc502584cbbe3850">llog_flag</a>           fmt;
<a name="l00211"></a>00211         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (cathandle == NULL)
<a name="l00216"></a>00216                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EBADF);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         fmt = cathandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="group__lustreidl.html#gga950dc01c678c8dd1bc502584cbbe3850ad0904b78d4957bd652442e4e4d17cbad">LLOG_F_EXT_MASK</a>;
<a name="l00219"></a>00219         down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00220"></a>00220         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(loghandle, &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>,
<a name="l00221"></a>00221                             <a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.phd.phd_entry) {
<a name="l00222"></a>00222                 <span class="keyword">struct </span><a class="code" href="structllog__logid.html" title="Identifier for a single log object.">llog_logid</a> *cgl = &amp;loghandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224                 <span class="keywordflow">if</span> (<a class="code" href="group__lu__fid.html#gae170c03ac79b0ef0ac57ff115eea190b">ostid_id</a>(&amp;cgl-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>) == <a class="code" href="group__lu__fid.html#gae170c03ac79b0ef0ac57ff115eea190b">ostid_id</a>(&amp;logid-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>) &amp;&amp;
<a name="l00225"></a>00225                     <a class="code" href="group__lu__fid.html#ga55a38b1a4563e06997d5696d86a70d3f">ostid_seq</a>(&amp;cgl-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>) == <a class="code" href="group__lu__fid.html#ga55a38b1a4563e06997d5696d86a70d3f">ostid_seq</a>(&amp;logid-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>)) {
<a name="l00226"></a>00226                         <span class="keywordflow">if</span> (cgl-&gt;<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a> != logid-&gt;<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>) {
<a name="l00227"></a>00227                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: log &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot; generation %x != %x\n&quot;</span>,
<a name="l00228"></a>00228                                        loghandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00229"></a>00229                                        <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;logid-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), cgl-&gt;<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>,
<a name="l00230"></a>00230                                        logid-&gt;<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>);
<a name="l00231"></a>00231                                 <span class="keywordflow">continue</span>;
<a name="l00232"></a>00232                         }
<a name="l00233"></a>00233                         loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#ad451ee1ad3ba2debc574e34b619d9282">phd_cat_handle</a> = cathandle;
<a name="l00234"></a>00234                         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00235"></a>00235                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = 0);
<a name="l00236"></a>00236                 }
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         rc = <a class="code" href="group__log.html#gae5358b955b7d709ed7f5416022472539">llog_open</a>(env, cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>, &amp;loghandle, logid, NULL,
<a name="l00241"></a>00241                        <a class="code" href="group__log.html#gga2f1ab12fceef20a1f6a2c3fbf3b28afaa073db74e795998cce75026e71ba61132">LLOG_OPEN_EXISTS</a>);
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00243"></a>00243                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error opening log id &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;:%x: rc = %d\n&quot;</span>,
<a name="l00244"></a>00244                        cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00245"></a>00245                        <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;logid-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), logid-&gt;<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>, rc);
<a name="l00246"></a>00246                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         rc = <a class="code" href="group__log.html#ga546fd23355c24d4ee2a5a668423c0156">llog_init_handle</a>(env, loghandle, <a class="code" href="packet-lustre_8c.html#add954ed69fa13ff781aa8433731a5ea2">LLOG_F_IS_PLAIN</a> | fmt, NULL);
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00251"></a>00251                 <a class="code" href="group__log.html#ga9487d7128a3cf457ff2a9181ce152b74">llog_close</a>(env, loghandle);
<a name="l00252"></a>00252                 loghandle = NULL;
<a name="l00253"></a>00253                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00257"></a>00257         <a class="code" href="list_8h.html#a588bec046f1e9797b33a5c5ab250f447" title="Insert an entry at the end of a list.">list_add_tail</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#a5aa609866edc9f7dab3d8ec7b1ac977d">phd_entry</a>, &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>);
<a name="l00258"></a>00258         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#ad451ee1ad3ba2debc574e34b619d9282">phd_cat_handle</a> = cathandle;
<a name="l00261"></a>00261         loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#afbfca2521da7a09b5e2839589c418408">lgc_lgl</a> = cathandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>;
<a name="l00262"></a>00262         loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a> =
<a name="l00263"></a>00263                                 loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a>;
<a name="l00264"></a>00264         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00265"></a>00265 out:
<a name="l00266"></a>00266         <a class="code" href="llog_8c.html#a6758bef27c12d168b20957085d251cef">llog_handle_get</a>(loghandle);
<a name="l00267"></a>00267         *res = loghandle;
<a name="l00268"></a>00268         <span class="keywordflow">return</span> 0;
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a><a class="code" href="group__log.html#ga8b069ab8307aa0e5c401f0d0c3a2f43d">00271</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga8b069ab8307aa0e5c401f0d0c3a2f43d">llog_cat_close</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a>      *loghandle, *n;
<a name="l00274"></a>00274         <span class="keywordtype">int</span>                      rc;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <a class="code" href="list_8h.html#ac3f72d6bd5144c7970824813810d2da1" title="Iterate over a list of given type safe against removal of list entry.">list_for_each_entry_safe</a>(loghandle, n, &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>,
<a name="l00279"></a>00279                                  <a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.phd.phd_entry) {
<a name="l00280"></a>00280                 <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a>     *llh = loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00281"></a>00281                 <span class="keywordtype">int</span>                      index;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283                 <span class="comment">/* unlink open-not-created llogs */</span>
<a name="l00284"></a>00284                 <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#a5aa609866edc9f7dab3d8ec7b1ac977d">phd_entry</a>);
<a name="l00285"></a>00285                 llh = loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00286"></a>00286                 <span class="keywordflow">if</span> (loghandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a> != NULL &amp;&amp; llh != NULL &amp;&amp;
<a name="l00287"></a>00287                     (llh-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="packet-lustre_8c.html#a2d868eaf522881c3349b8e375f6b9757">LLOG_F_ZAP_WHEN_EMPTY</a>) &amp;&amp;
<a name="l00288"></a>00288                     (llh-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> == 1)) {
<a name="l00289"></a>00289                         rc = <a class="code" href="group__log.html#ga5fbc4e5a4154513556d4dedc7d23e486">llog_destroy</a>(env, loghandle);
<a name="l00290"></a>00290                         <span class="keywordflow">if</span> (rc)
<a name="l00291"></a>00291                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: failure destroying log during &quot;</span>
<a name="l00292"></a>00292                                        <span class="stringliteral">&quot;cleanup: rc = %d\n&quot;</span>,
<a name="l00293"></a>00293                                        loghandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00294"></a>00294                                        rc);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                         index = loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>;
<a name="l00297"></a>00297                         <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cathandle, NULL, index);
<a name="l00298"></a>00298                 }
<a name="l00299"></a>00299                 <a class="code" href="group__log.html#ga9487d7128a3cf457ff2a9181ce152b74">llog_close</a>(env, loghandle);
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301         <span class="comment">/* if handle was stored in ctxt, remove it too */</span>
<a name="l00302"></a>00302         <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#aaab133ab19e5aa7a60c180698d4a831c">loc_handle</a> == cathandle)
<a name="l00303"></a>00303                 cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#aaab133ab19e5aa7a60c180698d4a831c">loc_handle</a> = NULL;
<a name="l00304"></a>00304         rc = <a class="code" href="group__log.html#ga9487d7128a3cf457ff2a9181ce152b74">llog_close</a>(env, cathandle);
<a name="l00305"></a>00305         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga8b069ab8307aa0e5c401f0d0c3a2f43d">llog_cat_close</a>);
<a name="l00308"></a>00308 
<a name="l00312"></a>00312 <span class="keyword">enum</span> {
<a name="l00313"></a><a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">00313</a>         <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>,
<a name="l00314"></a><a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">00314</a>         <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>
<a name="l00315"></a>00315 };
<a name="l00316"></a>00316 
<a name="l00327"></a><a class="code" href="llog__cat_8c.html#a9d0f268fbd6fc13f083efc42b672b35f">00327</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *<a class="code" href="llog__cat_8c.html#a9d0f268fbd6fc13f083efc42b672b35f" title="Return the currently active log handle.">llog_cat_current_log</a>(<span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00328"></a>00328                                                 <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *loghandle = NULL;
<a name="l00331"></a>00331         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (<a class="code" href="obd__support_8h.html#a1a625df67e59932bc7ef6f87a8548cda">OBD_FAIL_CHECK</a>(<a class="code" href="obd__support_8h.html#a6455be94d24e0574897d36178570a093">OBD_FAIL_MDS_LLOG_CREATE_FAILED2</a>)) {
<a name="l00335"></a>00335                 down_write_nested(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>);
<a name="l00336"></a>00336                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(next, loghandle);
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         down_read_nested(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>);
<a name="l00340"></a>00340         loghandle = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>;
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (loghandle) {
<a name="l00342"></a>00342                 <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *llh;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344                 down_write_nested(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>);
<a name="l00345"></a>00345                 llh = loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00346"></a>00346                 <span class="keywordflow">if</span> (llh == NULL || !<a class="code" href="group__log.html#ga5c4343d7efacc22e7fe33fe6597ccf9c">llog_is_full</a>(loghandle)) {
<a name="l00347"></a>00347                         up_read(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00348"></a>00348                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(loghandle);
<a name="l00349"></a>00349                 } <span class="keywordflow">else</span> {
<a name="l00350"></a>00350                         up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00351"></a>00351                 }
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353         up_read(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="comment">/* time to use next log */</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="comment">/* first, we have to make sure the state hasn&apos;t changed */</span>
<a name="l00358"></a>00358         down_write_nested(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>);
<a name="l00359"></a>00359         loghandle = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>;
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (loghandle) {
<a name="l00361"></a>00361                 <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *llh;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363                 down_write_nested(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>);
<a name="l00364"></a>00364                 llh = loghandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00365"></a>00365                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(llh);
<a name="l00366"></a>00366                 <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#ga5c4343d7efacc22e7fe33fe6597ccf9c">llog_is_full</a>(loghandle)) {
<a name="l00367"></a>00367                         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00368"></a>00368                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(loghandle);
<a name="l00369"></a>00369                 } <span class="keywordflow">else</span> {
<a name="l00370"></a>00370                         up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00371"></a>00371                 }
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 next:
<a name="l00375"></a>00375         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a4ae73d482880c25247baaad951ba6543">D_INODE</a>, <span class="stringliteral">&quot;use next log\n&quot;</span>);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         loghandle = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a>;
<a name="l00378"></a>00378         cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> = loghandle;
<a name="l00379"></a>00379         cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a> = NULL;
<a name="l00380"></a>00380         down_write_nested(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>);
<a name="l00381"></a>00381         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00382"></a>00382         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(loghandle);
<a name="l00383"></a>00383         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(loghandle);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="llog__cat_8c.html#af66d537a970154a9ee7ed7e70695bb68">00386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#af66d537a970154a9ee7ed7e70695bb68">llog_cat_update_header</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00387"></a>00387                            <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle)
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *loghandle;
<a name="l00390"></a>00390         <span class="keywordtype">int</span> rc;
<a name="l00391"></a>00391         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="comment">/* refresh llog */</span>
<a name="l00394"></a>00394         down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00395"></a>00395         <span class="keywordflow">if</span> (!cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a>) {
<a name="l00396"></a>00396                 up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00397"></a>00397                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(loghandle, &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>,
<a name="l00400"></a>00400                             <a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.phd.phd_entry) {
<a name="l00401"></a>00401                 <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(loghandle))
<a name="l00402"></a>00402                         <span class="keywordflow">continue</span>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404                 rc = <a class="code" href="group__log.html#ga3dff118eacffed836e2f50775e042350">llog_read_header</a>(env, loghandle, NULL);
<a name="l00405"></a>00405                 <span class="keywordflow">if</span> (rc != 0) {
<a name="l00406"></a>00406                         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00407"></a>00407                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00408"></a>00408                 }
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         rc = <a class="code" href="group__log.html#ga3dff118eacffed836e2f50775e042350">llog_read_header</a>(env, cathandle, NULL);
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (rc == 0)
<a name="l00412"></a>00412                 cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a> = 0;
<a name="l00413"></a>00413         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (rc != 0)
<a name="l00415"></a>00415                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00416"></a>00416 out:
<a name="l00417"></a>00417         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="comment">/* Add a single record to the recovery log(s) using a catalog</span>
<a name="l00421"></a>00421 <span class="comment"> * Returns as llog_write_record</span>
<a name="l00422"></a>00422 <span class="comment"> *</span>
<a name="l00423"></a>00423 <span class="comment"> * Assumes caller has already pushed us into the kernel context.</span>
<a name="l00424"></a>00424 <span class="comment"> */</span>
<a name="l00425"></a><a class="code" href="group__log.html#gab876e211f585e8c75174f6b974e658c6">00425</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#gab876e211f585e8c75174f6b974e658c6">llog_cat_add_rec</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00426"></a>00426                      <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keyword">struct</span> <a class="code" href="structllog__cookie.html" title="log cookies are used to reference a specific log file and a record therein">llog_cookie</a> *reccookie,
<a name="l00427"></a>00427                      <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *loghandle;
<a name="l00430"></a>00430         <span class="keywordtype">int</span> rc, retried = 0;
<a name="l00431"></a>00431         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(rec-&gt;<a class="code" href="structllog__rec__hdr.html#ad78574b9a0f5e0400ba90c351a0add96">lrh_len</a> &lt;= cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#a615b7885d02ab2de69f1eb869f4ddfac">loc_chunk_size</a>);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 retry:
<a name="l00436"></a>00436         loghandle = <a class="code" href="llog__cat_8c.html#a9d0f268fbd6fc13f083efc42b672b35f" title="Return the currently active log handle.">llog_cat_current_log</a>(cathandle, th);
<a name="l00437"></a>00437         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(!IS_ERR(loghandle));
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         <span class="comment">/* loghandle is already locked by llog_cat_current_log() for us */</span>
<a name="l00440"></a>00440         <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(loghandle)) {
<a name="l00441"></a>00441                 rc = <a class="code" href="llog__cat_8c.html#aa06aabd6c419f312c2eddb8d7141b169">llog_cat_new_log</a>(env, cathandle, loghandle, th);
<a name="l00442"></a>00442                 <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00443"></a>00443                         up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00444"></a>00444                         <span class="comment">/* nobody should be trying to use this llog */</span>
<a name="l00445"></a>00445                         down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00446"></a>00446                         <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> == loghandle)
<a name="l00447"></a>00447                                 cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> = NULL;
<a name="l00448"></a>00448                         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00449"></a>00449                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00450"></a>00450                 }
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452         <span class="comment">/* now let&apos;s try to add the record */</span>
<a name="l00453"></a>00453         rc = <a class="code" href="group__log.html#ga38790001c86a4ad331c76a6e8698b6e9">llog_write_rec</a>(env, loghandle, rec, reccookie, <a class="code" href="group__log.html#gga2f80701c36e79c0640d91c788feee0b3a9e3f5a45a9b1488b2fc203fe85242388">LLOG_NEXT_IDX</a>, th);
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00455"></a>00455                 <a class="code" href="libcfs__debug_8h.html#a95d182fe8a5397ab14c86e78add3f3ae">CDEBUG_LIMIT</a>(rc == -ENOSPC ? <a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a> : <a class="code" href="libcfs__debug_8h.html#af25fefaf5c55ce92d41da370dc9399c2">D_ERROR</a>,
<a name="l00456"></a>00456                              <span class="stringliteral">&quot;llog_write_rec %d: lh=%p\n&quot;</span>, rc, loghandle);
<a name="l00457"></a>00457                 <span class="comment">/* -ENOSPC is returned if no empty records left</span>
<a name="l00458"></a>00458 <span class="comment">                 * and when it&apos;s lack of space on the stogage.</span>
<a name="l00459"></a>00459 <span class="comment">                 * there is no point to try again if it&apos;s the second</span>
<a name="l00460"></a>00460 <span class="comment">                 * case. many callers (like llog test) expect ENOSPC,</span>
<a name="l00461"></a>00461 <span class="comment">                 * so we preserve this error code, but look for the</span>
<a name="l00462"></a>00462 <span class="comment">                 * actual cause here */</span>
<a name="l00463"></a>00463                 <span class="keywordflow">if</span> (rc == -ENOSPC &amp;&amp; <a class="code" href="group__log.html#ga5c4343d7efacc22e7fe33fe6597ccf9c">llog_is_full</a>(loghandle))
<a name="l00464"></a>00464                         rc = -ENOBUFS;
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466         up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (rc == -ENOBUFS) {
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> (retried++ == 0)
<a name="l00470"></a>00470                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(retry, rc);
<a name="l00471"></a>00471                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: error on 2nd llog: rc = %d\n&quot;</span>,
<a name="l00472"></a>00472                        cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 EXPORT_SYMBOL(<a class="code" href="group__log.html#gab876e211f585e8c75174f6b974e658c6">llog_cat_add_rec</a>);
<a name="l00478"></a>00478 
<a name="l00479"></a><a class="code" href="group__log.html#ga7eff35965cc93d0bc953eb542a1d6a28">00479</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga7eff35965cc93d0bc953eb542a1d6a28">llog_cat_declare_add_rec</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00480"></a>00480                              <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00481"></a>00481                              <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keyword">struct</span> <a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a> *th)
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483         <span class="keyword">struct </span><a class="code" href="structllog__thread__info.html">llog_thread_info</a> *lgi = <a class="code" href="llog__internal_8h.html#aced0fd9169ddaecf43a6cd75c11bfbfb">llog_info</a>(env);
<a name="l00484"></a>00484         <span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a>   *lirec = &amp;lgi-&gt;<a class="code" href="structllog__thread__info.html#aaec48c6846322edb549007784736ff71">lgi_logid</a>;
<a name="l00485"></a>00485         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a>      *loghandle, *next;
<a name="l00486"></a>00486         <span class="keywordtype">int</span>                      rc = 0;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> == NULL) {
<a name="l00491"></a>00491                 <span class="comment">/* declare new plain llog */</span>
<a name="l00492"></a>00492                 down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00493"></a>00493                 <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> == NULL) {
<a name="l00494"></a>00494                         rc = <a class="code" href="group__log.html#gae5358b955b7d709ed7f5416022472539">llog_open</a>(env, cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>, &amp;loghandle,
<a name="l00495"></a>00495                                        NULL, NULL, <a class="code" href="group__log.html#gga2f1ab12fceef20a1f6a2c3fbf3b28afaa4d8bcc2f3a93dd7afb6b4bb857f7d103">LLOG_OPEN_NEW</a>);
<a name="l00496"></a>00496                         <span class="keywordflow">if</span> (rc == 0) {
<a name="l00497"></a>00497                                 cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> = loghandle;
<a name="l00498"></a>00498                                 <a class="code" href="list_8h.html#a588bec046f1e9797b33a5c5ab250f447" title="Insert an entry at the end of a list.">list_add_tail</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#a5aa609866edc9f7dab3d8ec7b1ac977d">phd_entry</a>,
<a name="l00499"></a>00499                                               &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>);
<a name="l00500"></a>00500                         }
<a name="l00501"></a>00501                 }
<a name="l00502"></a>00502                 up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00503"></a>00503         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a> == NULL) {
<a name="l00504"></a>00504                 <span class="comment">/* declare next plain llog */</span>
<a name="l00505"></a>00505                 down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00506"></a>00506                 <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a> == NULL) {
<a name="l00507"></a>00507                         rc = <a class="code" href="group__log.html#gae5358b955b7d709ed7f5416022472539">llog_open</a>(env, cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>, &amp;loghandle,
<a name="l00508"></a>00508                                        NULL, NULL, <a class="code" href="group__log.html#gga2f1ab12fceef20a1f6a2c3fbf3b28afaa4d8bcc2f3a93dd7afb6b4bb857f7d103">LLOG_OPEN_NEW</a>);
<a name="l00509"></a>00509                         <span class="keywordflow">if</span> (rc == 0) {
<a name="l00510"></a>00510                                 cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a> = loghandle;
<a name="l00511"></a>00511                                 <a class="code" href="list_8h.html#a588bec046f1e9797b33a5c5ab250f447" title="Insert an entry at the end of a list.">list_add_tail</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#a5aa609866edc9f7dab3d8ec7b1ac977d">phd_entry</a>,
<a name="l00512"></a>00512                                               &amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a2975687d0c8cfda735d4d8c30ee8dcb7">chd_head</a>);
<a name="l00513"></a>00513                         }
<a name="l00514"></a>00514                 }
<a name="l00515"></a>00515                 up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (rc)
<a name="l00518"></a>00518                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520         lirec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>.<a class="code" href="structllog__rec__hdr.html#ad78574b9a0f5e0400ba90c351a0add96">lrh_len</a> = <span class="keyword">sizeof</span>(*lirec);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>)) {
<a name="l00523"></a>00523                 <span class="keywordflow">if</span> (<a class="code" href="group__dt.html#ga05bf8b28c64f19745cc7c892f1783b8c">dt_object_remote</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a>)) {
<a name="l00524"></a>00524                         <span class="comment">/* For remote operation, if we put the llog object</span>
<a name="l00525"></a>00525 <span class="comment">                         * creation in the current transaction, then the</span>
<a name="l00526"></a>00526 <span class="comment">                         * llog object will not be created on the remote</span>
<a name="l00527"></a>00527 <span class="comment">                         * target until the transaction stop, if other</span>
<a name="l00528"></a>00528 <span class="comment">                         * operations start before the transaction stop,</span>
<a name="l00529"></a>00529 <span class="comment">                         * and use the same llog object, will be dependent</span>
<a name="l00530"></a>00530 <span class="comment">                         * on the success of this transaction. So let&apos;s</span>
<a name="l00531"></a>00531 <span class="comment">                         * create the llog object synchronously here to</span>
<a name="l00532"></a>00532 <span class="comment">                         * remove the dependency. */</span>
<a name="l00533"></a>00533 create_again:
<a name="l00534"></a>00534                         down_read_nested(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>);
<a name="l00535"></a>00535                         loghandle = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>;
<a name="l00536"></a>00536                         down_write_nested(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>);
<a name="l00537"></a>00537                         <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a>) {
<a name="l00538"></a>00538                                 up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00539"></a>00539                                 up_read(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00540"></a>00540                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EIO);
<a name="l00541"></a>00541                         }
<a name="l00542"></a>00542                         <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(loghandle)) {
<a name="l00543"></a>00543                                 rc = <a class="code" href="llog__cat_8c.html#aa06aabd6c419f312c2eddb8d7141b169">llog_cat_new_log</a>(env, cathandle, loghandle,
<a name="l00544"></a>00544                                                       NULL);
<a name="l00545"></a>00545                                 <span class="keywordflow">if</span> (rc == -ESTALE)
<a name="l00546"></a>00546                                         cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a> = 1;
<a name="l00547"></a>00547                         }
<a name="l00548"></a>00548                         up_write(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00549"></a>00549                         up_read(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00550"></a>00550                         <span class="keywordflow">if</span> (rc == -ESTALE) {
<a name="l00551"></a>00551                                 rc = <a class="code" href="llog__cat_8c.html#af66d537a970154a9ee7ed7e70695bb68">llog_cat_update_header</a>(env, cathandle);
<a name="l00552"></a>00552                                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00553"></a>00553                                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00554"></a>00554                                 <span class="keywordflow">goto</span> create_again;
<a name="l00555"></a>00555                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00556"></a>00556                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00557"></a>00557                         }
<a name="l00558"></a>00558                 } <span class="keywordflow">else</span> {
<a name="l00559"></a>00559                         rc = <a class="code" href="group__log.html#ga4f29ac09d8ce9183650aa713038b2c92">llog_declare_create</a>(env,
<a name="l00560"></a>00560                                         cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>, th);
<a name="l00561"></a>00561                         <span class="keywordflow">if</span> (rc)
<a name="l00562"></a>00562                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00563"></a>00563                         <a class="code" href="group__log.html#ga1db1cffd9f210c9f081370af6106a606">llog_declare_write_rec</a>(env, cathandle,
<a name="l00564"></a>00564                                                &amp;lirec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>, -1, th);
<a name="l00565"></a>00565                 }
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 write_again:
<a name="l00569"></a>00569         <span class="comment">/* declare records in the llogs */</span>
<a name="l00570"></a>00570         rc = <a class="code" href="group__log.html#ga1db1cffd9f210c9f081370af6106a606">llog_declare_write_rec</a>(env, cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>,
<a name="l00571"></a>00571                                     rec, -1, th);
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (rc == -ESTALE) {
<a name="l00573"></a>00573                 down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00574"></a>00574                 <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a>) {
<a name="l00575"></a>00575                         up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00576"></a>00576                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EIO);
<a name="l00577"></a>00577                 }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                 cathandle-&gt;<a class="code" href="structllog__handle.html#a290b35412d13bbeffa5131d02ec8bb9a">lgh_stale</a> = 1;
<a name="l00580"></a>00580                 up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00581"></a>00581                 rc = <a class="code" href="llog__cat_8c.html#af66d537a970154a9ee7ed7e70695bb68">llog_cat_update_header</a>(env, cathandle);
<a name="l00582"></a>00582                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00583"></a>00583                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00584"></a>00584                 <span class="keywordflow">goto</span> write_again;
<a name="l00585"></a>00585         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00586"></a>00586                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         next = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a>;
<a name="l00590"></a>00590         <span class="keywordflow">if</span> (next) {
<a name="l00591"></a>00591                 <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(next)) {
<a name="l00592"></a>00592                         <span class="keywordflow">if</span> (<a class="code" href="group__dt.html#ga05bf8b28c64f19745cc7c892f1783b8c">dt_object_remote</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a>)) {
<a name="l00593"></a>00593                                 <span class="comment">/* For remote operation, if we put the llog</span>
<a name="l00594"></a>00594 <span class="comment">                                 * object creation in the current transaction,</span>
<a name="l00595"></a>00595 <span class="comment">                                 * then the llog object will not be created on</span>
<a name="l00596"></a>00596 <span class="comment">                                 * the remote target until the transaction stop,</span>
<a name="l00597"></a>00597 <span class="comment">                                 * if other operations start before the</span>
<a name="l00598"></a>00598 <span class="comment">                                 * transaction stop, and use the same llog</span>
<a name="l00599"></a>00599 <span class="comment">                                 * object, will be dependent on the success of</span>
<a name="l00600"></a>00600 <span class="comment">                                 * this transaction. So let&apos;s create the llog</span>
<a name="l00601"></a>00601 <span class="comment">                                 * object synchronously here to remove the</span>
<a name="l00602"></a>00602 <span class="comment">                                 * dependency. */</span>
<a name="l00603"></a>00603                                 down_read_nested(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>,
<a name="l00604"></a>00604                                                  <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5dabe5fb8bf298585db94af30036cd7219e">LLOGH_CAT</a>);
<a name="l00605"></a>00605                                 next = cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a9b3bbc4f87ab7f504750732c8edaa197">chd_next_log</a>;
<a name="l00606"></a>00606                                 down_write_nested(&amp;next-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>, <a class="code" href="llog__cat_8c.html#a81929fb3d21206b62f55bcb744f71d5daf4c6b648b1c4de28cf1307e705d2feac">LLOGH_LOG</a>);
<a name="l00607"></a>00607                                 <span class="keywordflow">if</span> (!<a class="code" href="group__log.html#gab4498d20e447d4dbeaff34eb3b305d57" title="new llog API">llog_exist</a>(next))
<a name="l00608"></a>00608                                         rc = <a class="code" href="llog__cat_8c.html#aa06aabd6c419f312c2eddb8d7141b169">llog_cat_new_log</a>(env, cathandle,
<a name="l00609"></a>00609                                                               next, NULL);
<a name="l00610"></a>00610                                 up_write(&amp;next-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00611"></a>00611                                 up_read(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l00612"></a>00612                                 <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00613"></a>00613                                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00614"></a>00614                         } <span class="keywordflow">else</span> {
<a name="l00615"></a>00615                                 rc = <a class="code" href="group__log.html#ga4f29ac09d8ce9183650aa713038b2c92">llog_declare_create</a>(env, next, th);
<a name="l00616"></a>00616                                 <a class="code" href="group__log.html#ga1db1cffd9f210c9f081370af6106a606">llog_declare_write_rec</a>(env, cathandle,
<a name="l00617"></a>00617                                                 &amp;lirec-&gt;<a class="code" href="structllog__logid__rec.html#aab1a578cebcec6c2c8a0a9f512623521">lid_hdr</a>, -1, th);
<a name="l00618"></a>00618                         }
<a name="l00619"></a>00619                 }
<a name="l00620"></a>00620                 <span class="comment">/* XXX: we hope for declarations made for existing llog</span>
<a name="l00621"></a>00621 <span class="comment">                 *      this might be not correct with some backends</span>
<a name="l00622"></a>00622 <span class="comment">                 *      where declarations are expected against specific</span>
<a name="l00623"></a>00623 <span class="comment">                 *      object like ZFS with full debugging enabled */</span>
<a name="l00624"></a>00624                 <span class="comment">/*llog_declare_write_rec(env, next, rec, -1, th);*/</span>
<a name="l00625"></a>00625         }
<a name="l00626"></a>00626 out:
<a name="l00627"></a>00627         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga7eff35965cc93d0bc953eb542a1d6a28">llog_cat_declare_add_rec</a>);
<a name="l00630"></a>00630 
<a name="l00631"></a><a class="code" href="group__log.html#ga29a5a9134a1ef39c0042541245851ec6">00631</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga29a5a9134a1ef39c0042541245851ec6">llog_cat_add</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l00632"></a>00632                  <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keyword">struct</span> <a class="code" href="structllog__cookie.html" title="log cookies are used to reference a specific log file and a record therein">llog_cookie</a> *reccookie)
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634         <span class="keyword">struct </span><a class="code" href="structllog__ctxt.html">llog_ctxt</a>        *ctxt;
<a name="l00635"></a>00635         <span class="keyword">struct </span><a class="code" href="structdt__device.html">dt_device</a>        *dt;
<a name="l00636"></a>00636         <span class="keyword">struct </span><a class="code" href="structthandle.html" title="This is the general purpose transaction handle.">thandle</a>          *th = NULL;
<a name="l00637"></a>00637         <span class="keywordtype">int</span>                      rc;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         ctxt = cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>;
<a name="l00640"></a>00640         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ctxt);
<a name="l00641"></a>00641         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(ctxt-&gt;<a class="code" href="structllog__ctxt.html#a93f50121ade9b2988083cebd479bf427">loc_exp</a>);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a> != NULL);
<a name="l00644"></a>00644         dt = <a class="code" href="group__dt.html#ga194153652787b274d44d8e2ed6ad8a23">lu2dt_dev</a>(cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a>-&gt;<a class="code" href="structdt__object.html#af646d1f1afe6acdc83ad0778a29163d7">do_lu</a>.<a class="code" href="structlu__object.html#a5b9108a283d9901c95bdf32833f70601" title="Device for this layer.">lo_dev</a>);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         th = <a class="code" href="group__dt.html#ga689a89697bff3936cf4d60bd2651dc8a">dt_trans_create</a>(env, dt);
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (IS_ERR(th))
<a name="l00648"></a>00648                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(th));
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         rc = <a class="code" href="group__log.html#ga7eff35965cc93d0bc953eb542a1d6a28">llog_cat_declare_add_rec</a>(env, cathandle, rec, th);
<a name="l00651"></a>00651         <span class="keywordflow">if</span> (rc)
<a name="l00652"></a>00652                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_trans, rc);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         rc = <a class="code" href="group__dt.html#gaec633f618ffdd701fa5f233dd4c1d161">dt_trans_start_local</a>(env, dt, th);
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (rc)
<a name="l00656"></a>00656                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_trans, rc);
<a name="l00657"></a>00657         rc = <a class="code" href="group__log.html#gab876e211f585e8c75174f6b974e658c6">llog_cat_add_rec</a>(env, cathandle, rec, reccookie, th);
<a name="l00658"></a>00658 out_trans:
<a name="l00659"></a>00659         <a class="code" href="group__dt.html#gac5cb16311e5767ec9068c9aac417628a">dt_trans_stop</a>(env, dt, th);
<a name="l00660"></a>00660         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga29a5a9134a1ef39c0042541245851ec6">llog_cat_add</a>);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="comment">/* For each cookie in the cookie array, we clear the log in-use bit and either:</span>
<a name="l00665"></a>00665 <span class="comment"> * - the log is empty, so mark it free in the catalog header and delete it</span>
<a name="l00666"></a>00666 <span class="comment"> * - the log is not empty, just write out the log header</span>
<a name="l00667"></a>00667 <span class="comment"> *</span>
<a name="l00668"></a>00668 <span class="comment"> * The cookies may be in different log files, so we need to get new logs</span>
<a name="l00669"></a>00669 <span class="comment"> * each time.</span>
<a name="l00670"></a>00670 <span class="comment"> *</span>
<a name="l00671"></a>00671 <span class="comment"> * Assumes caller has already pushed us into the kernel context.</span>
<a name="l00672"></a>00672 <span class="comment"> */</span>
<a name="l00673"></a><a class="code" href="group__log.html#ga0c7162acb072c7ebd237441cab38a622">00673</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga0c7162acb072c7ebd237441cab38a622">llog_cat_cancel_records</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00674"></a>00674                             <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle, <span class="keywordtype">int</span> count,
<a name="l00675"></a>00675                             <span class="keyword">struct</span> <a class="code" href="structllog__cookie.html" title="log cookies are used to reference a specific log file and a record therein">llog_cookie</a> *cookies)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677         <span class="keywordtype">int</span> i, index, rc = 0, failed = 0;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++, cookies++) {
<a name="l00682"></a>00682                 <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a>      *loghandle;
<a name="l00683"></a>00683                 <span class="keyword">struct </span><a class="code" href="structllog__logid.html" title="Identifier for a single log object.">llog_logid</a>       *lgl = &amp;cookies-&gt;<a class="code" href="structllog__cookie.html#afbfca2521da7a09b5e2839589c418408">lgc_lgl</a>;
<a name="l00684"></a>00684                 <span class="keywordtype">int</span>                      lrc;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686                 rc = <a class="code" href="llog__cat_8c.html#abb315a9e5d0cec5f9cc55473a596304c">llog_cat_id2handle</a>(env, cathandle, &amp;loghandle, lgl);
<a name="l00687"></a>00687                 <span class="keywordflow">if</span> (rc) {
<a name="l00688"></a>00688                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: cannot find handle for llog &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;: %d\n&quot;</span>,
<a name="l00689"></a>00689                                cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00690"></a>00690                                <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lgl-&gt;<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), rc);
<a name="l00691"></a>00691                         failed++;
<a name="l00692"></a>00692                         <span class="keywordflow">continue</span>;
<a name="l00693"></a>00693                 }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695                 lrc = <a class="code" href="group__log.html#gae7cdad9d32ae44d0ae5428b11741368d">llog_cancel_rec</a>(env, loghandle, cookies-&gt;<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>);
<a name="l00696"></a>00696                 <span class="keywordflow">if</span> (lrc == <a class="code" href="group__log.html#ga537dcd78aa2fe2715b25f811bd5b4484">LLOG_DEL_PLAIN</a>) { <span class="comment">/* log has been destroyed */</span>
<a name="l00697"></a>00697                         index = loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>;
<a name="l00698"></a>00698                         rc = <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cathandle, loghandle,
<a name="l00699"></a>00699                                               index);
<a name="l00700"></a>00700                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lrc == -ENOENT) {
<a name="l00701"></a>00701                         <span class="keywordflow">if</span> (rc == 0) <span class="comment">/* ENOENT shouldn&apos;t rewrite any error */</span>
<a name="l00702"></a>00702                                 rc = lrc;
<a name="l00703"></a>00703                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lrc &lt; 0) {
<a name="l00704"></a>00704                         failed++;
<a name="l00705"></a>00705                         rc = lrc;
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707                 <a class="code" href="llog_8c.html#ac0d6206e62438f1c670a131d9ebe6221">llog_handle_put</a>(loghandle);
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         <span class="keywordflow">if</span> (rc)
<a name="l00710"></a>00710                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: fail to cancel %d of %d llog-records: rc = %d\n&quot;</span>,
<a name="l00711"></a>00711                        cathandle-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, failed, count,
<a name="l00712"></a>00712                        rc);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga0c7162acb072c7ebd237441cab38a622">llog_cat_cancel_records</a>);
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="llog__cat_8c.html#a0d5d11d027eb06bf1b25bc558a0ee13c">00718</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#a0d5d11d027eb06bf1b25bc558a0ee13c">llog_cat_process_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00719"></a>00719                                <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh,
<a name="l00720"></a>00720                                <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keywordtype">void</span> *data)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722         <span class="keyword">struct </span><a class="code" href="structllog__process__data.html">llog_process_data</a> *d = data;
<a name="l00723"></a>00723         <span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *lir = (<span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *)rec;
<a name="l00724"></a>00724         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *llh;
<a name="l00725"></a>00725         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *hdr;
<a name="l00726"></a>00726         <span class="keywordtype">int</span> rc;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00729"></a>00729         <span class="keywordflow">if</span> (rec-&gt;<a class="code" href="structllog__rec__hdr.html#aed3a83bae3600611db70e81a693e2ec4">lrh_type</a> != <a class="code" href="group__lustreidl.html#gga46267c71f9f2221271c977534b08c789ab129649a06968f909cf43e2705008040">LLOG_LOGID_MAGIC</a>) {
<a name="l00730"></a>00730                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;invalid record in catalog\n&quot;</span>);
<a name="l00731"></a>00731                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;processing log &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;:%x at index %u of catalog &quot;</span>
<a name="l00734"></a>00734                <a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>,
<a name="l00735"></a>00735                rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cat_llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00736"></a>00736 
<a name="l00737"></a>00737         rc = <a class="code" href="llog__cat_8c.html#abb315a9e5d0cec5f9cc55473a596304c">llog_cat_id2handle</a>(env, cat_llh, &amp;llh, &amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>);
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (rc) {
<a name="l00739"></a>00739                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: cannot find handle for llog &quot;</span>DOSTID<span class="stringliteral">&quot;: %d\n&quot;</span>,
<a name="l00740"></a>00740                        cat_llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00741"></a>00741                        <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), rc);
<a name="l00742"></a>00742                 <span class="keywordflow">if</span> (rc == -ENOENT || rc == -ESTALE) {
<a name="l00743"></a>00743                         <span class="comment">/* After a server crash, a stub of index</span>
<a name="l00744"></a>00744 <span class="comment">                         * record in catlog could be kept, because</span>
<a name="l00745"></a>00745 <span class="comment">                         * plain log destroy + catlog index record</span>
<a name="l00746"></a>00746 <span class="comment">                         * deletion are not atomic. So we end up with</span>
<a name="l00747"></a>00747 <span class="comment">                         * an index but no actual record. Destroy the</span>
<a name="l00748"></a>00748 <span class="comment">                         * index and move on. */</span>
<a name="l00749"></a>00749                         rc = <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cat_llh, NULL,
<a name="l00750"></a>00750                                               rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>);
<a name="l00751"></a>00751                 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="comment">/* clean old empty llogs, do not consider current llog in use */</span>
<a name="l00757"></a>00757         <span class="comment">/* ignore remote (lgh_obj=NULL) llogs */</span>
<a name="l00758"></a>00758         hdr = llh-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00759"></a>00759         <span class="keywordflow">if</span> ((hdr-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="packet-lustre_8c.html#a2d868eaf522881c3349b8e375f6b9757">LLOG_F_ZAP_WHEN_EMPTY</a>) &amp;&amp;
<a name="l00760"></a>00760             hdr-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> == 1 &amp;&amp; cat_llh-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a> != NULL &amp;&amp;
<a name="l00761"></a>00761             llh != cat_llh-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>) {
<a name="l00762"></a>00762                 rc = <a class="code" href="group__log.html#ga5fbc4e5a4154513556d4dedc7d23e486">llog_destroy</a>(env, llh);
<a name="l00763"></a>00763                 <span class="keywordflow">if</span> (rc)
<a name="l00764"></a>00764                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: fail to destroy empty log: rc = %d\n&quot;</span>,
<a name="l00765"></a>00765                                llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l00766"></a>00766                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = <a class="code" href="group__log.html#ga537dcd78aa2fe2715b25f811bd5b4484">LLOG_DEL_PLAIN</a>);
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a> &lt; d-&gt;<a class="code" href="structllog__process__data.html#a051255f0e379f17774529e445a4549ac" title="Start processing the catalog from startcat/startidx.">lpd_startcat</a>) {
<a name="l00770"></a>00770                 <span class="comment">/* Skip processing of the logs until startcat */</span>
<a name="l00771"></a>00771                 rc = 0;
<a name="l00772"></a>00772         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structllog__process__data.html#af8b2675e8cc4723c5aa534b0f2abd159">lpd_startidx</a> &gt; 0) {
<a name="l00773"></a>00773                 <span class="keyword">struct </span><a class="code" href="structllog__process__cat__data.html">llog_process_cat_data</a> cd;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775                 cd.<a class="code" href="structllog__process__cat__data.html#a7ab2ded8bab7d2d749f397911acc686a" title="Temporary stored first_idx while scanning log.">lpcd_first_idx</a> = d-&gt;<a class="code" href="structllog__process__data.html#af8b2675e8cc4723c5aa534b0f2abd159">lpd_startidx</a>;
<a name="l00776"></a>00776                 cd.<a class="code" href="structllog__process__cat__data.html#aed95ee6a3cc58810fe47fad32e072b1b" title="Temporary stored last_idx while scanning log.">lpcd_last_idx</a> = 0;
<a name="l00777"></a>00777                 rc = <a class="code" href="group__log.html#gaf0d3652ea7d74d6ac5ee335584a33d72">llog_process_or_fork</a>(env, llh, d-&gt;<a class="code" href="structllog__process__data.html#a1a2d3c012640e757f3da9ab5a10725f0" title="Catalog process callback function, called for each record in catalog.">lpd_cb</a>, d-&gt;<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a>,
<a name="l00778"></a>00778                                           &amp;cd, <span class="keyword">false</span>);
<a name="l00779"></a>00779                 <span class="comment">/* Continue processing the next log from idx 0 */</span>
<a name="l00780"></a>00780                 d-&gt;<a class="code" href="structllog__process__data.html#af8b2675e8cc4723c5aa534b0f2abd159">lpd_startidx</a> = 0;
<a name="l00781"></a>00781         } <span class="keywordflow">else</span> {
<a name="l00782"></a>00782                 rc = <a class="code" href="group__log.html#gaf0d3652ea7d74d6ac5ee335584a33d72">llog_process_or_fork</a>(env, llh, d-&gt;<a class="code" href="structllog__process__data.html#a1a2d3c012640e757f3da9ab5a10725f0" title="Catalog process callback function, called for each record in catalog.">lpd_cb</a>, d-&gt;<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a>,
<a name="l00783"></a>00783                                           NULL, <span class="keyword">false</span>);
<a name="l00784"></a>00784         }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 out:
<a name="l00787"></a>00787         <span class="comment">/* The empty plain log was destroyed while processing */</span>
<a name="l00788"></a>00788         <span class="keywordflow">if</span> (rc == <a class="code" href="group__log.html#ga537dcd78aa2fe2715b25f811bd5b4484">LLOG_DEL_PLAIN</a>)
<a name="l00789"></a>00789                 rc = <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cat_llh, llh,
<a name="l00790"></a>00790                                       llh-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>);
<a name="l00791"></a>00791         <a class="code" href="llog_8c.html#ac0d6206e62438f1c670a131d9ebe6221">llog_handle_put</a>(llh);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="group__log.html#ga3a958539869b4156163d2c006bd92f5a">00796</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga3a958539869b4156163d2c006bd92f5a">llog_cat_process_or_fork</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00797"></a>00797                              <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh, <a class="code" href="obd__class_8h.html#a6753dc16f88d31c1a4fdd28a48dc1cf9">llog_cb_t</a> cat_cb,
<a name="l00798"></a>00798                              <a class="code" href="obd__class_8h.html#a6753dc16f88d31c1a4fdd28a48dc1cf9">llog_cb_t</a> <a class="code" href="it__test_8c.html#a3edc96db5310d665bb056d7adc554a8f">cb</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> startcat,
<a name="l00799"></a>00799                              <span class="keywordtype">int</span> startidx, <span class="keywordtype">bool</span> fork)
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801         <span class="keyword">struct </span><a class="code" href="structllog__process__data.html">llog_process_data</a> d;
<a name="l00802"></a>00802         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *llh = cat_llh-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00803"></a>00803         <span class="keywordtype">int</span> rc;
<a name="l00804"></a>00804         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(llh-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="packet-lustre_8c.html#a07cc7ed983b75325d920507e6bee579d">LLOG_F_IS_CAT</a>);
<a name="l00807"></a>00807         d.<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a> = data;
<a name="l00808"></a>00808         d.<a class="code" href="structllog__process__data.html#a1a2d3c012640e757f3da9ab5a10725f0" title="Catalog process callback function, called for each record in catalog.">lpd_cb</a> = cb;
<a name="l00809"></a>00809         d.<a class="code" href="structllog__process__data.html#a051255f0e379f17774529e445a4549ac" title="Start processing the catalog from startcat/startidx.">lpd_startcat</a> = startcat;
<a name="l00810"></a>00810         d.<a class="code" href="structllog__process__data.html#af8b2675e8cc4723c5aa534b0f2abd159">lpd_startidx</a> = startidx;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> &gt;= cat_llh-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a> &amp;&amp;
<a name="l00813"></a>00813             llh-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> &gt; 1) {
<a name="l00814"></a>00814                 <span class="keyword">struct </span><a class="code" href="structllog__process__cat__data.html">llog_process_cat_data</a> cd;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;catlog &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot; crosses index zero\n&quot;</span>,
<a name="l00817"></a>00817                       <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cat_llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00818"></a>00818 
<a name="l00819"></a>00819                 cd.<a class="code" href="structllog__process__cat__data.html#a7ab2ded8bab7d2d749f397911acc686a" title="Temporary stored first_idx while scanning log.">lpcd_first_idx</a> = llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a>;
<a name="l00820"></a>00820                 cd.<a class="code" href="structllog__process__cat__data.html#aed95ee6a3cc58810fe47fad32e072b1b" title="Temporary stored last_idx while scanning log.">lpcd_last_idx</a> = 0;
<a name="l00821"></a>00821                 rc = <a class="code" href="group__log.html#gaf0d3652ea7d74d6ac5ee335584a33d72">llog_process_or_fork</a>(env, cat_llh, cat_cb,
<a name="l00822"></a>00822                                           &amp;d, &amp;cd, fork);
<a name="l00823"></a>00823                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00824"></a>00824                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826                 cd.<a class="code" href="structllog__process__cat__data.html#a7ab2ded8bab7d2d749f397911acc686a" title="Temporary stored first_idx while scanning log.">lpcd_first_idx</a> = 0;
<a name="l00827"></a>00827                 cd.<a class="code" href="structllog__process__cat__data.html#aed95ee6a3cc58810fe47fad32e072b1b" title="Temporary stored last_idx while scanning log.">lpcd_last_idx</a> = cat_llh-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a>;
<a name="l00828"></a>00828                 rc = <a class="code" href="group__log.html#gaf0d3652ea7d74d6ac5ee335584a33d72">llog_process_or_fork</a>(env, cat_llh, cat_cb,
<a name="l00829"></a>00829                                           &amp;d, &amp;cd, fork);
<a name="l00830"></a>00830         } <span class="keywordflow">else</span> {
<a name="l00831"></a>00831                 rc = <a class="code" href="group__log.html#gaf0d3652ea7d74d6ac5ee335584a33d72">llog_process_or_fork</a>(env, cat_llh, cat_cb,
<a name="l00832"></a>00832                                           &amp;d, NULL, fork);
<a name="l00833"></a>00833         }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00836"></a>00836 }
<a name="l00837"></a>00837 
<a name="l00838"></a><a class="code" href="group__log.html#ga466f538de595963c4d02460408b4ca01">00838</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga466f538de595963c4d02460408b4ca01">llog_cat_process</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh,
<a name="l00839"></a>00839                      <a class="code" href="obd__class_8h.html#a6753dc16f88d31c1a4fdd28a48dc1cf9">llog_cb_t</a> <a class="code" href="it__test_8c.html#a3edc96db5310d665bb056d7adc554a8f">cb</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> startcat, <span class="keywordtype">int</span> startidx)
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841         <span class="keywordflow">return</span> <a class="code" href="group__log.html#ga3a958539869b4156163d2c006bd92f5a">llog_cat_process_or_fork</a>(env, cat_llh, <a class="code" href="llog__cat_8c.html#a0d5d11d027eb06bf1b25bc558a0ee13c">llog_cat_process_cb</a>,
<a name="l00842"></a>00842                                         cb, data, startcat, startidx, <span class="keyword">false</span>);
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga466f538de595963c4d02460408b4ca01">llog_cat_process</a>);
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="llog__cat_8c.html#aedbe253a06f33b4c8e90ed55638a3c18">00846</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#aedbe253a06f33b4c8e90ed55638a3c18">llog_cat_size_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00847"></a>00847                              <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh,
<a name="l00848"></a>00848                              <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keywordtype">void</span> *data)
<a name="l00849"></a>00849 {
<a name="l00850"></a>00850         <span class="keyword">struct </span><a class="code" href="structllog__process__data.html">llog_process_data</a> *d = data;
<a name="l00851"></a>00851         <span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *lir = (<span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *)rec;
<a name="l00852"></a>00852         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *llh;
<a name="l00853"></a>00853         <span class="keywordtype">int</span> rc;
<a name="l00854"></a>00854         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *cum_size = d-&gt;<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a>;
<a name="l00855"></a>00855         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (rec-&gt;<a class="code" href="structllog__rec__hdr.html#aed3a83bae3600611db70e81a693e2ec4">lrh_type</a> != <a class="code" href="group__lustreidl.html#gga46267c71f9f2221271c977534b08c789ab129649a06968f909cf43e2705008040">LLOG_LOGID_MAGIC</a>) {
<a name="l00859"></a>00859                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: invalid record in catalog, rc = %d\n&quot;</span>,
<a name="l00860"></a>00860                        cat_llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, -EINVAL);
<a name="l00861"></a>00861                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00862"></a>00862         }
<a name="l00863"></a>00863         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;processing log &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;:%x at index %u of catalog &quot;</span>
<a name="l00864"></a>00864                <a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>,
<a name="l00865"></a>00865                rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cat_llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         rc = <a class="code" href="llog__cat_8c.html#abb315a9e5d0cec5f9cc55473a596304c">llog_cat_id2handle</a>(env, cat_llh, &amp;llh, &amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>);
<a name="l00868"></a>00868         <span class="keywordflow">if</span> (rc) {
<a name="l00869"></a>00869                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;%s: cannot find handle for llog &quot;</span>DOSTID<span class="stringliteral">&quot;: rc = %d\n&quot;</span>,
<a name="l00870"></a>00870                       cat_llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00871"></a>00871                       <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), rc);
<a name="l00872"></a>00872                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         size = <a class="code" href="group__log.html#gaae74cc5ecdf5ceda1159ad495cef0113">llog_size</a>(env, llh);
<a name="l00875"></a>00875         *cum_size += size;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;Add llog entry &quot;</span>DOSTID<span class="stringliteral">&quot; size &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00878"></a>00878                <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), size);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         <a class="code" href="llog_8c.html#ac0d6206e62438f1c670a131d9ebe6221">llog_handle_put</a>(llh);
<a name="l00881"></a>00881 
<a name="l00882"></a>00882         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00886"></a><a class="code" href="group__log.html#ga27b76b93ed632e0efcdeb31e0fac56a3">00886</a> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="group__log.html#ga27b76b93ed632e0efcdeb31e0fac56a3">llog_cat_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <a class="code" href="group__log.html#gaae74cc5ecdf5ceda1159ad495cef0113">llog_size</a>(env, cat_llh);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890         <a class="code" href="group__log.html#ga3a958539869b4156163d2c006bd92f5a">llog_cat_process_or_fork</a>(env, cat_llh, <a class="code" href="llog__cat_8c.html#aedbe253a06f33b4c8e90ed55638a3c18">llog_cat_size_cb</a>,
<a name="l00891"></a>00891                                  NULL, &amp;size, 0, 0, <span class="keyword">false</span>);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         <span class="keywordflow">return</span> size;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga27b76b93ed632e0efcdeb31e0fac56a3">llog_cat_size</a>);
<a name="l00896"></a>00896 
<a name="l00897"></a><a class="code" href="llog__cat_8c.html#af5c122bd807bc378461cfbcc9cd91485">00897</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#af5c122bd807bc378461cfbcc9cd91485">llog_cat_reverse_process_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00898"></a>00898                                        <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh,
<a name="l00899"></a>00899                                        <span class="keyword">struct</span> <a class="code" href="structllog__rec__hdr.html" title="Log record header - stored in little endian order.">llog_rec_hdr</a> *rec, <span class="keywordtype">void</span> *data)
<a name="l00900"></a>00900 {
<a name="l00901"></a>00901         <span class="keyword">struct </span><a class="code" href="structllog__process__data.html">llog_process_data</a> *d = data;
<a name="l00902"></a>00902         <span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *lir = (<span class="keyword">struct </span><a class="code" href="structllog__logid__rec.html">llog_logid_rec</a> *)rec;
<a name="l00903"></a>00903         <span class="keyword">struct </span><a class="code" href="structllog__handle.html">llog_handle</a> *llh;
<a name="l00904"></a>00904         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *hdr;
<a name="l00905"></a>00905         <span class="keywordtype">int</span> rc;
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         <span class="keywordflow">if</span> (<a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(rec-&gt;<a class="code" href="structllog__rec__hdr.html#aed3a83bae3600611db70e81a693e2ec4">lrh_type</a>) != <a class="code" href="group__lustreidl.html#gga46267c71f9f2221271c977534b08c789ab129649a06968f909cf43e2705008040">LLOG_LOGID_MAGIC</a>) {
<a name="l00908"></a>00908                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;invalid record in catalog\n&quot;</span>);
<a name="l00909"></a>00909                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;processing log &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;:%x at index %u of catalog &quot;</span>
<a name="l00912"></a>00912                <a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#ad5c09437286c500a5f9b3e14b83d914d">lgl_ogen</a>,
<a name="l00913"></a>00913                <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>), <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cat_llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00914"></a>00914 
<a name="l00915"></a>00915         rc = <a class="code" href="llog__cat_8c.html#abb315a9e5d0cec5f9cc55473a596304c">llog_cat_id2handle</a>(env, cat_llh, &amp;llh, &amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>);
<a name="l00916"></a>00916         <span class="keywordflow">if</span> (rc) {
<a name="l00917"></a>00917                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: cannot find handle for llog &quot;</span>DOSTID<span class="stringliteral">&quot;: %d\n&quot;</span>,
<a name="l00918"></a>00918                        cat_llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>,
<a name="l00919"></a>00919                        <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;lir-&gt;<a class="code" href="structllog__logid__rec.html#a28432fbfab23b63747c3028c0ab85d85">lid_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>), rc);
<a name="l00920"></a>00920                 <span class="keywordflow">if</span> (rc == -ENOENT || rc == -ESTALE) {
<a name="l00921"></a>00921                         <span class="comment">/* After a server crash, a stub of index</span>
<a name="l00922"></a>00922 <span class="comment">                         * record in catlog could be kept, because</span>
<a name="l00923"></a>00923 <span class="comment">                         * plain log destroy + catlog index record</span>
<a name="l00924"></a>00924 <span class="comment">                         * deletion are not atomic. So we end up with</span>
<a name="l00925"></a>00925 <span class="comment">                         * an index but no actual record. Destroy the</span>
<a name="l00926"></a>00926 <span class="comment">                         * index and move on. */</span>
<a name="l00927"></a>00927                         rc = <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cat_llh, NULL,
<a name="l00928"></a>00928                                               rec-&gt;<a class="code" href="structllog__rec__hdr.html#a553d87b769afcdf9b1f3fe3328268fdc">lrh_index</a>);
<a name="l00929"></a>00929                 }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         <span class="comment">/* clean old empty llogs, do not consider current llog in use */</span>
<a name="l00935"></a>00935         hdr = llh-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00936"></a>00936         <span class="keywordflow">if</span> ((hdr-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="packet-lustre_8c.html#a2d868eaf522881c3349b8e375f6b9757">LLOG_F_ZAP_WHEN_EMPTY</a>) &amp;&amp;
<a name="l00937"></a>00937             hdr-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> == 1 &amp;&amp;
<a name="l00938"></a>00938             llh != cat_llh-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a>) {
<a name="l00939"></a>00939                 rc = <a class="code" href="group__log.html#ga5fbc4e5a4154513556d4dedc7d23e486">llog_destroy</a>(env, llh);
<a name="l00940"></a>00940                 <span class="keywordflow">if</span> (rc)
<a name="l00941"></a>00941                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: fail to destroy empty log: rc = %d\n&quot;</span>,
<a name="l00942"></a>00942                                llh-&gt;<a class="code" href="structllog__handle.html#aa4ded7ba0f2bdfb242813efe5d7dd761">lgh_ctxt</a>-&gt;<a class="code" href="structllog__ctxt.html#af4ce05673ba2fbb2557f1a014c0e9b21">loc_obd</a>-&gt;<a class="code" href="structobd__device.html#a47f3a5a4e3b9ce7d39282c2aa1058985">obd_name</a>, rc);
<a name="l00943"></a>00943                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = <a class="code" href="group__log.html#ga537dcd78aa2fe2715b25f811bd5b4484">LLOG_DEL_PLAIN</a>);
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         rc = <a class="code" href="group__log.html#ga97008e41a5f1114f3b26e8718c8e73de">llog_reverse_process</a>(env, llh, d-&gt;<a class="code" href="structllog__process__data.html#a1a2d3c012640e757f3da9ab5a10725f0" title="Catalog process callback function, called for each record in catalog.">lpd_cb</a>, d-&gt;<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a>, NULL);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948 out:
<a name="l00949"></a>00949         <span class="comment">/* The empty plain was destroyed while processing */</span>
<a name="l00950"></a>00950         <span class="keywordflow">if</span> (rc == <a class="code" href="group__log.html#ga537dcd78aa2fe2715b25f811bd5b4484">LLOG_DEL_PLAIN</a>)
<a name="l00951"></a>00951                 rc = <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(env, cat_llh, llh,
<a name="l00952"></a>00952                                       llh-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         <a class="code" href="llog_8c.html#ac0d6206e62438f1c670a131d9ebe6221">llog_handle_put</a>(llh);
<a name="l00955"></a>00955         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a><a class="code" href="group__log.html#ga8fed8fb641b91d077e635dfdc6b8446c">00958</a> <span class="keywordtype">int</span> <a class="code" href="group__log.html#ga8fed8fb641b91d077e635dfdc6b8446c">llog_cat_reverse_process</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00959"></a>00959                              <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cat_llh,
<a name="l00960"></a>00960                              <a class="code" href="obd__class_8h.html#a6753dc16f88d31c1a4fdd28a48dc1cf9">llog_cb_t</a> <a class="code" href="it__test_8c.html#a3edc96db5310d665bb056d7adc554a8f">cb</a>, <span class="keywordtype">void</span> *data)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962         <span class="keyword">struct </span><a class="code" href="structllog__process__data.html">llog_process_data</a> d;
<a name="l00963"></a>00963         <span class="keyword">struct </span><a class="code" href="structllog__process__cat__data.html">llog_process_cat_data</a> cd;
<a name="l00964"></a>00964         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *llh = cat_llh-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l00965"></a>00965         <span class="keywordtype">int</span> rc;
<a name="l00966"></a>00966         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(llh-&gt;<a class="code" href="structllog__log__hdr.html#a9b1a8a1ad4277201afc8bdbaf2304a37">llh_flags</a> &amp; <a class="code" href="packet-lustre_8c.html#a07cc7ed983b75325d920507e6bee579d">LLOG_F_IS_CAT</a>);
<a name="l00969"></a>00969         d.<a class="code" href="structllog__process__data.html#a648146cbe02366a5d4d9f0c02f80a405" title="Any useful data needed while processing catalog.">lpd_data</a> = data;
<a name="l00970"></a>00970         d.<a class="code" href="structllog__process__data.html#a1a2d3c012640e757f3da9ab5a10725f0" title="Catalog process callback function, called for each record in catalog.">lpd_cb</a> = cb;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="keywordflow">if</span> (llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> &gt;= cat_llh-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a> &amp;&amp;
<a name="l00973"></a>00973             llh-&gt;<a class="code" href="structllog__log__hdr.html#acf8a93eebfdf7cb367365aabd9de6187">llh_count</a> &gt; 1) {
<a name="l00974"></a>00974                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;catalog &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot; crosses index zero\n&quot;</span>,
<a name="l00975"></a>00975                       <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cat_llh-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l00976"></a>00976 
<a name="l00977"></a>00977                 cd.<a class="code" href="structllog__process__cat__data.html#a7ab2ded8bab7d2d749f397911acc686a" title="Temporary stored first_idx while scanning log.">lpcd_first_idx</a> = 0;
<a name="l00978"></a>00978                 cd.<a class="code" href="structllog__process__cat__data.html#aed95ee6a3cc58810fe47fad32e072b1b" title="Temporary stored last_idx while scanning log.">lpcd_last_idx</a> = cat_llh-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a>;
<a name="l00979"></a>00979                 rc = <a class="code" href="group__log.html#ga97008e41a5f1114f3b26e8718c8e73de">llog_reverse_process</a>(env, cat_llh,
<a name="l00980"></a>00980                                           <a class="code" href="llog__cat_8c.html#af5c122bd807bc378461cfbcc9cd91485">llog_cat_reverse_process_cb</a>,
<a name="l00981"></a>00981                                           &amp;d, &amp;cd);
<a name="l00982"></a>00982                 <span class="keywordflow">if</span> (rc != 0)
<a name="l00983"></a>00983                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                 cd.<a class="code" href="structllog__process__cat__data.html#a7ab2ded8bab7d2d749f397911acc686a" title="Temporary stored first_idx while scanning log.">lpcd_first_idx</a> = <a class="code" href="byteorder_8h.html#a48f527b00bc1d5e46366d720280a1039">le32_to_cpu</a>(llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a>);
<a name="l00986"></a>00986                 cd.<a class="code" href="structllog__process__cat__data.html#aed95ee6a3cc58810fe47fad32e072b1b" title="Temporary stored last_idx while scanning log.">lpcd_last_idx</a> = 0;
<a name="l00987"></a>00987                 rc = <a class="code" href="group__log.html#ga97008e41a5f1114f3b26e8718c8e73de">llog_reverse_process</a>(env, cat_llh,
<a name="l00988"></a>00988                                           <a class="code" href="llog__cat_8c.html#af5c122bd807bc378461cfbcc9cd91485">llog_cat_reverse_process_cb</a>,
<a name="l00989"></a>00989                                           &amp;d, &amp;cd);
<a name="l00990"></a>00990         } <span class="keywordflow">else</span> {
<a name="l00991"></a>00991                 rc = <a class="code" href="group__log.html#ga97008e41a5f1114f3b26e8718c8e73de">llog_reverse_process</a>(env, cat_llh,
<a name="l00992"></a>00992                                           <a class="code" href="llog__cat_8c.html#af5c122bd807bc378461cfbcc9cd91485">llog_cat_reverse_process_cb</a>,
<a name="l00993"></a>00993                                           &amp;d, NULL);
<a name="l00994"></a>00994         }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 EXPORT_SYMBOL(<a class="code" href="group__log.html#ga8fed8fb641b91d077e635dfdc6b8446c">llog_cat_reverse_process</a>);
<a name="l00999"></a>00999 
<a name="l01000"></a><a class="code" href="llog__cat_8c.html#a7021ae9dddb0c35b51656c0c228b6c51">01000</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#a7021ae9dddb0c35b51656c0c228b6c51">llog_cat_set_first_idx</a>(<span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle, <span class="keywordtype">int</span> idx)
<a name="l01001"></a>01001 {
<a name="l01002"></a>01002         <span class="keyword">struct </span><a class="code" href="structllog__log__hdr.html">llog_log_hdr</a> *llh = cathandle-&gt;<a class="code" href="structllog__handle.html#a1e70205e9f7abb9140cfcb37a42611e8">lgh_hdr</a>;
<a name="l01003"></a>01003         <span class="keywordtype">int</span> bitmap_size;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007         bitmap_size = <a class="code" href="group__lustreidl.html#gab2b7cae67de8c1053d1e5bb6d0293092">LLOG_HDR_BITMAP_SIZE</a>(llh);
<a name="l01008"></a>01008         <span class="comment">/*</span>
<a name="l01009"></a>01009 <span class="comment">         * The llh_cat_idx equals to the first used index minus 1</span>
<a name="l01010"></a>01010 <span class="comment">         * so if we canceled the first index then llh_cat_idx</span>
<a name="l01011"></a>01011 <span class="comment">         * must be renewed.</span>
<a name="l01012"></a>01012 <span class="comment">         */</span>
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> == (idx - 1)) {
<a name="l01014"></a>01014                 llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> = idx;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016                 <span class="keywordflow">while</span> (idx != cathandle-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a>) {
<a name="l01017"></a>01017                         idx = (idx + 1) % bitmap_size;
<a name="l01018"></a>01018                         <span class="keywordflow">if</span> (!<a class="code" href="lustre__compat_8h.html#ae3b56fd9bd358d45610ca2982c6d00c8">ext2_test_bit</a>(idx, <a class="code" href="group__lustreidl.html#ga54ffef033dec3b56ccb23b2ba3c242d7">LLOG_HDR_BITMAP</a>(llh))) {
<a name="l01019"></a>01019                                 <span class="comment">/* update llh_cat_idx for each unset bit,</span>
<a name="l01020"></a>01020 <span class="comment">                                 * expecting the next one is set */</span>
<a name="l01021"></a>01021                                 llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> = idx;
<a name="l01022"></a>01022                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idx == 0) {
<a name="l01023"></a>01023                                 <span class="comment">/* skip header bit */</span>
<a name="l01024"></a>01024                                 llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a> = 0;
<a name="l01025"></a>01025                                 <span class="keywordflow">continue</span>;
<a name="l01026"></a>01026                         } <span class="keywordflow">else</span> {
<a name="l01027"></a>01027                                 <span class="comment">/* the first index is found */</span>
<a name="l01028"></a>01028                                 <span class="keywordflow">break</span>;
<a name="l01029"></a>01029                         }
<a name="l01030"></a>01030                 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#aed4daa7096c3237824e93375e1473af7">D_RPCTRACE</a>, <span class="stringliteral">&quot;Set catlog &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot; first idx %u,&quot;</span>
<a name="l01033"></a>01033                        <span class="stringliteral">&quot; (last_idx %u)\n&quot;</span>, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>),
<a name="l01034"></a>01034                        llh-&gt;<a class="code" href="structllog__log__hdr.html#aed9fa10f72e1506da0590d542f853635">llh_cat_idx</a>, cathandle-&gt;<a class="code" href="structllog__handle.html#a35595d2c187895289c2ced0ee281bbec">lgh_last_idx</a>);
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="comment">/* Cleanup deleted plain llog traces from catalog */</span>
<a name="l01041"></a><a class="code" href="llog__internal_8h.html#a82dcda95b1953d670f7cc2575081efdb">01041</a> <span class="keywordtype">int</span> <a class="code" href="llog__cat_8c.html#a82dcda95b1953d670f7cc2575081efdb">llog_cat_cleanup</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env, <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *cathandle,
<a name="l01042"></a>01042                      <span class="keyword">struct</span> <a class="code" href="structllog__handle.html">llog_handle</a> *loghandle, <span class="keywordtype">int</span> index)
<a name="l01043"></a>01043 {
<a name="l01044"></a>01044         <span class="keywordtype">int</span> rc;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(index);
<a name="l01047"></a>01047         <span class="keywordflow">if</span> (loghandle != NULL) {
<a name="l01048"></a>01048                 <span class="comment">/* remove destroyed llog from catalog list and</span>
<a name="l01049"></a>01049 <span class="comment">                 * chd_current_log variable */</span>
<a name="l01050"></a>01050                 down_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l01051"></a>01051                 <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> == loghandle)
<a name="l01052"></a>01052                         cathandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#a9afa53f25e1d6aedc2ce515c793bb7ba">chd</a>.<a class="code" href="structcat__handle__data.html#a5692057e5e819d115a73b35a7121379b">chd_current_log</a> = NULL;
<a name="l01053"></a>01053                 <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#a5aa609866edc9f7dab3d8ec7b1ac977d">phd_entry</a>);
<a name="l01054"></a>01054                 up_write(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#a775258f953291914424fb99fae414d06">lgh_lock</a>);
<a name="l01055"></a>01055                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(index == loghandle-&gt;<a class="code" href="structllog__handle.html#a6b57b14cf19ad1632ccff6ca9d53ef1c">u</a>.<a class="code" href="structllog__handle.html#aaa9c3d45d9ff8e095efc9d5982b19e5d">phd</a>.<a class="code" href="structplain__handle__data.html#afd78de1ff0100703057fe5536ab27ad7">phd_cookie</a>.<a class="code" href="structllog__cookie.html#a029c7e1d4ab34722091fbc220add0cb2">lgc_index</a>);
<a name="l01056"></a>01056                 <span class="comment">/* llog was opened and keep in a list, close it now */</span>
<a name="l01057"></a>01057                 <a class="code" href="group__log.html#ga9487d7128a3cf457ff2a9181ce152b74">llog_close</a>(env, loghandle);
<a name="l01058"></a>01058         }
<a name="l01059"></a>01059 
<a name="l01060"></a>01060         <span class="comment">/* do not attempt to cleanup on-disk llog if on client side */</span>
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (cathandle-&gt;<a class="code" href="structllog__handle.html#afa5bbd13c6d5f5760b79ec0f01856a49">lgh_obj</a> == NULL)
<a name="l01062"></a>01062                 <span class="keywordflow">return</span> 0;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064         <span class="comment">/* remove plain llog entry from catalog by index */</span>
<a name="l01065"></a>01065         <a class="code" href="llog__cat_8c.html#a7021ae9dddb0c35b51656c0c228b6c51">llog_cat_set_first_idx</a>(cathandle, index);
<a name="l01066"></a>01066         rc = <a class="code" href="group__log.html#gae7cdad9d32ae44d0ae5428b11741368d">llog_cancel_rec</a>(env, cathandle, index);
<a name="l01067"></a>01067         <span class="keywordflow">if</span> (rc == 0)
<a name="l01068"></a>01068                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a125b66aada63eaccd986e27e8dac1ab2">D_HA</a>, <span class="stringliteral">&quot;cancel plain log at index&quot;</span>
<a name="l01069"></a>01069                        <span class="stringliteral">&quot; %u of catalog &quot;</span><a class="code" href="group__lustreuser.html#gac64b04c9d195f0918fc22b881d2260e5">DOSTID</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01070"></a>01070                        index, <a class="code" href="group__lustreuser.html#gad3b44cf710fe39c4adc4ae65a2a98543">POSTID</a>(&amp;cathandle-&gt;<a class="code" href="structllog__handle.html#ac6111ff7a45bf2191577f4a8174488fb">lgh_id</a>.<a class="code" href="structllog__logid.html#a49d0055dc4c80c98d931f4a7e78c5c70">lgl_oi</a>));
<a name="l01071"></a>01071         <span class="keywordflow">return</span> rc;
<a name="l01072"></a>01072 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:39 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
