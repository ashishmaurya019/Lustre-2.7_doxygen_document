<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/target/update_records.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/target/update_records.c</h1><a href="update__records_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.gnu.org/licenses/gpl-2.0.html</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * GPL HEADER END</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 <span class="comment">/*</span>
<a name="l00023"></a>00023 <span class="comment"> * Copyright (c) 2014, 2015, Intel Corporation.</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * lustre/target/update_records.c</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * This file implement the methods to pack updates as update records, which</span>
<a name="l00030"></a>00030 <span class="comment"> * will be written to the disk as llog record, and might be used during</span>
<a name="l00031"></a>00031 <span class="comment"> * recovery.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * For cross-MDT operation, all of updates of the operation needs to be</span>
<a name="l00034"></a>00034 <span class="comment"> * recorded in the disk, then during recovery phase, the recovery thread</span>
<a name="l00035"></a>00035 <span class="comment"> * will retrieve and redo these updates if it needed.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * See comments above struct update_records for the format of update_records.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * Author: Di Wang &lt;di.wang@intel.com&gt;</span>
<a name="l00040"></a>00040 <span class="comment"> */</span>
<a name="l00041"></a><a class="code" href="update__records_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00041</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_CLASS</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="lu__target_8h.html">lu_target.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="lustre__obdo_8h.html">lustre_obdo.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="lustre__update_8h.html">lustre_update.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="obd_8h.html">obd.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="obd__class_8h.html">obd_class.h</a>&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="tgt__internal_8h.html">tgt_internal.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="update__records_8c.html#acada94ed8c998be34e7c491abdf175c1">00051</a> <span class="preprocessor">#define UPDATE_RECORDS_BUFFER_SIZE      8192</span>
<a name="l00052"></a><a class="code" href="update__records_8c.html#a7d473853c875c101a45128c57a911e36">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define UPDATE_PARAMS_BUFFER_SIZE       8192</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="update__records_8c.html#af5e8c053444ba3fed9d4f22db1e0e643">00063</a> <span class="keywordtype">void</span> <a class="code" href="tgt__internal_8h.html#af5e8c053444ba3fed9d4f22db1e0e643" title="Dump update record.">update_records_dump</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structupdate__records.html">update_records</a> *records,
<a name="l00064"></a>00064                          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mask, <span class="keywordtype">bool</span> dump_updates)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structupdate__ops.html">update_ops</a> *ops;
<a name="l00067"></a>00067         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structupdate__op.html">update_op</a>  *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a> = NULL;
<a name="l00068"></a>00068         <span class="keyword">struct </span><a class="code" href="structupdate__params.html">update_params</a>    *params = NULL;
<a name="l00069"></a>00069         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            i;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(mask, <span class="stringliteral">&quot;master transno = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; batchid = &quot;</span><a class="code" href="libcfs_2include_2libcfs_2types_8h.html#a5ef11521803262dc2f972061520e41f2">LPU64</a><span class="stringliteral">&quot; flags = %x&quot;</span>
<a name="l00072"></a>00072                <span class="stringliteral">&quot; ops = %d params = %d\n&quot;</span>, records-&gt;<a class="code" href="structupdate__records.html#af1342ae9b7b02cf47b9302ec544b1b57">ur_master_transno</a>,
<a name="l00073"></a>00073                records-&gt;<a class="code" href="structupdate__records.html#a689a2fa2a66db9e494365763a2e22080">ur_batchid</a>, records-&gt;<a class="code" href="structupdate__records.html#a371c3f6f09bca53059265560eadfa3be">ur_flags</a>, records-&gt;<a class="code" href="structupdate__records.html#a7cd9154022dc7f8b2bc672f885275e32">ur_update_count</a>,
<a name="l00074"></a>00074                records-&gt;<a class="code" href="structupdate__records.html#aaee500e2e7c4db6d9c6074412fd60a1d">ur_param_count</a>);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (records-&gt;<a class="code" href="structupdate__records.html#a7cd9154022dc7f8b2bc672f885275e32">ur_update_count</a> == 0)
<a name="l00077"></a>00077                 <span class="keywordflow">return</span>;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (!dump_updates)
<a name="l00080"></a>00080                 <span class="keywordflow">return</span>;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         ops = &amp;records-&gt;<a class="code" href="structupdate__records.html#aa60c13bd360671ab80023099519f35b7">ur_ops</a>;
<a name="l00083"></a>00083         <span class="keywordflow">if</span> (records-&gt;<a class="code" href="structupdate__records.html#aaee500e2e7c4db6d9c6074412fd60a1d">ur_param_count</a> &gt; 0)
<a name="l00084"></a>00084                 params = <a class="code" href="lustre__update_8h.html#ab95b7122b03937df0e071bb72d47fd0a">update_records_get_params</a>(records);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         op = &amp;ops-&gt;<a class="code" href="structupdate__ops.html#a6ca7941a888f88390a579b48c8acf5c2">uops_op</a>[0];
<a name="l00087"></a>00087         <span class="keywordflow">for</span> (i = 0; i &lt; records-&gt;<a class="code" href="structupdate__records.html#a7cd9154022dc7f8b2bc672f885275e32">ur_update_count</a>; i++,
<a name="l00088"></a>00088                                   op = <a class="code" href="lustre__update_8h.html#a87394f6e5041a5b45b126e468d7b838d">update_op_next_op</a>(op)) {
<a name="l00089"></a>00089                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(mask, <span class="stringliteral">&quot;update %dth &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; %s params_count = %hu\n&quot;</span>, i,
<a name="l00092"></a>00092                        <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(&amp;op-&gt;uop_fid), <a class="code" href="lustre__update_8h.html#af41e2b72019c67f5f929c6a944d0801e">update_op_str</a>(op-&gt;uop_type),
<a name="l00093"></a>00093                        op-&gt;uop_param_count);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                 <span class="keywordflow">if</span> (params == NULL)
<a name="l00096"></a>00096                         <span class="keywordflow">continue</span>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098                 <span class="keywordflow">for</span> (j = 0;  j &lt; op-&gt;uop_param_count; j++) {
<a name="l00099"></a>00099                         <span class="keyword">struct </span><a class="code" href="structobject__update__param.html">object_update_param</a> *param;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101                         param = <a class="code" href="lustre__update_8h.html#a31a578b3fb7d88f8ccf86225440b3bd2">update_params_get_param</a>(params,
<a name="l00102"></a>00102                                 (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)op-&gt;uop_params_off[j],
<a name="l00103"></a>00103                                         records-&gt;<a class="code" href="structupdate__records.html#aaee500e2e7c4db6d9c6074412fd60a1d">ur_param_count</a>);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105                         <span class="keywordflow">if</span> (param == NULL)
<a name="l00106"></a>00106                                 <span class="keywordflow">continue</span>;
<a name="l00107"></a>00107                         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(mask, <span class="stringliteral">&quot;param = %p %dth off = %hu size = %hu\n&quot;</span>,
<a name="l00108"></a>00108                                param, j, op-&gt;uop_params_off[j], param-&gt;<a class="code" href="structobject__update__param.html#aa13ecdd0d46b5e5065dccbf185300d30">oup_len</a>);
<a name="l00109"></a>00109                 }
<a name="l00110"></a>00110         }
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00128"></a><a class="code" href="update__records_8c.html#adfc09a873cdee1de17b1753f221b2661">00128</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="update__records_8c.html#adfc09a873cdee1de17b1753f221b2661" title="Pack parameters to update records.">update_records_param_pack</a>(<span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00129"></a>00129                                               <span class="keyword">const</span> <span class="keywordtype">void</span> *new_param,
<a name="l00130"></a>00130                                               <span class="keywordtype">size_t</span> new_param_size,
<a name="l00131"></a>00131                                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133         <span class="keyword">struct </span><a class="code" href="structobject__update__param.html">object_update_param</a>      *param;
<a name="l00134"></a>00134         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                    i;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="keywordflow">for</span> (i = 0; i &lt; *param_count; i++) {
<a name="l00137"></a>00137                 <span class="keyword">struct </span><a class="code" href="structobject__update__param.html">object_update_param</a> *param;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139                 param = <a class="code" href="lustre__update_8h.html#a31a578b3fb7d88f8ccf86225440b3bd2">update_params_get_param</a>(params, i, *param_count);
<a name="l00140"></a>00140                 <span class="keywordflow">if</span> ((new_param == NULL &amp;&amp; param-&gt;<a class="code" href="structobject__update__param.html#aa13ecdd0d46b5e5065dccbf185300d30">oup_len</a> == new_param_size) ||
<a name="l00141"></a>00141                     (param-&gt;<a class="code" href="structobject__update__param.html#aa13ecdd0d46b5e5065dccbf185300d30">oup_len</a> == new_param_size &amp;&amp;
<a name="l00142"></a>00142                      memcmp(param-&gt;<a class="code" href="structobject__update__param.html#aec4c8816c45a563d520e9189a59b7c2a">oup_buf</a>, new_param, new_param_size) == 0))
<a name="l00143"></a>00143                         <span class="comment">/* Found the parameter and return its index */</span>
<a name="l00144"></a>00144                         <span class="keywordflow">return</span> i;
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         param = (<span class="keyword">struct </span><a class="code" href="structobject__update__param.html">object_update_param</a> *)((<span class="keywordtype">char</span> *)params +
<a name="l00148"></a>00148                                 <a class="code" href="lustre__update_8h.html#ab1178c4f1e649ee44d63f24ce145c1e1">update_params_size</a>(params, *param_count));
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         param-&gt;<a class="code" href="structobject__update__param.html#aa13ecdd0d46b5e5065dccbf185300d30">oup_len</a> = new_param_size;
<a name="l00151"></a>00151         <span class="keywordflow">if</span> (new_param != NULL)
<a name="l00152"></a>00152                 memcpy(param-&gt;<a class="code" href="structobject__update__param.html#aec4c8816c45a563d520e9189a59b7c2a">oup_buf</a>, new_param, new_param_size);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154         *param_count = *param_count + 1;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="keywordflow">return</span> *param_count - 1;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00184"></a><a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40">00184</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00185"></a>00185                                       <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00186"></a>00186                                       <span class="keyword">enum</span> <a class="code" href="group__lustreidl.html#ga2d1a90f202540bfbcbd72a8c0f94b586" title="OUT_UPDATE RPC Format.">update_type</a> op_type,
<a name="l00187"></a>00187                                       <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00188"></a>00188                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00189"></a>00189                                       <span class="keywordtype">size_t</span> *max_op_size,
<a name="l00190"></a>00190                                       <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00191"></a>00191                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00192"></a>00192                                       <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00193"></a>00193                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> param_bufs_count,
<a name="l00194"></a>00194                                       <span class="keyword">const</span> <span class="keywordtype">void</span> **param_bufs,
<a name="l00195"></a>00195                                       <span class="keywordtype">size_t</span> *param_sizes)
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197         <span class="keyword">struct </span><a class="code" href="structupdate__op.html">update_op</a>        *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>;
<a name="l00198"></a>00198         <span class="keywordtype">size_t</span>                  total_param_sizes = 0;
<a name="l00199"></a>00199         <span class="keywordtype">int</span>                     index;
<a name="l00200"></a>00200         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            i;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="comment">/* Check whether the packing exceeding the maximum update size */</span>
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(*max_op_size &lt; <a class="code" href="lustre__update_8h.html#af47faf7c6c34f6ec15cb8f989cb91992">update_op_size</a>(param_bufs_count))) {
<a name="l00204"></a>00204                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;max_op_size = %zu update_op = %zu\n&quot;</span>,
<a name="l00205"></a>00205                        *max_op_size, <a class="code" href="lustre__update_8h.html#af47faf7c6c34f6ec15cb8f989cb91992">update_op_size</a>(param_bufs_count));
<a name="l00206"></a>00206                 *max_op_size = <a class="code" href="lustre__update_8h.html#af47faf7c6c34f6ec15cb8f989cb91992">update_op_size</a>(param_bufs_count);
<a name="l00207"></a>00207                 <span class="keywordflow">return</span> -E2BIG;
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="keywordflow">for</span> (i = 0; i &lt; param_bufs_count; i++)
<a name="l00211"></a>00211                 total_param_sizes +=
<a name="l00212"></a>00212                         <a class="code" href="group__lustreuser.html#ga605663c49f0739d2448d229b0ba3474d">cfs_size_round</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structobject__update__param.html">object_update_param</a>) +
<a name="l00213"></a>00213                                        param_sizes[i]);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="comment">/* Check whether the packing exceeding the maximum parameter size */</span>
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (<a class="code" href="libcfs__private_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(*max_param_size &lt; total_param_sizes)) {
<a name="l00217"></a>00217                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;max_param_size = %zu params size = %zu\n&quot;</span>,
<a name="l00218"></a>00218                        *max_param_size, total_param_sizes);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220                 *max_param_size = total_param_sizes;
<a name="l00221"></a>00221                 <span class="keywordflow">return</span> -E2BIG;
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         op = <a class="code" href="lustre__update_8h.html#a0d5ea619cc4563262c93308d5550d9b1">update_ops_get_op</a>(ops, *op_count, *op_count);
<a name="l00225"></a>00225         op-&gt;<a class="code" href="structupdate__op.html#a68cc3d1a7f0e144e7c1886a1d2496480">uop_fid</a> = *fid;
<a name="l00226"></a>00226         op-&gt;<a class="code" href="structupdate__op.html#a05578a7f57b44d07ae8fb2cce6e41a2d">uop_type</a> = op_type;
<a name="l00227"></a>00227         op-&gt;<a class="code" href="structupdate__op.html#a367a2a2316f4af2754d20d25158447bc">uop_param_count</a> = param_bufs_count;
<a name="l00228"></a>00228         <span class="keywordflow">for</span> (i = 0; i &lt; param_bufs_count; i++) {
<a name="l00229"></a>00229                 index = <a class="code" href="update__records_8c.html#adfc09a873cdee1de17b1753f221b2661" title="Pack parameters to update records.">update_records_param_pack</a>(params, param_bufs[i],
<a name="l00230"></a>00230                                                   param_sizes[i], param_count);
<a name="l00231"></a>00231                 <span class="keywordflow">if</span> (index &lt; 0)
<a name="l00232"></a>00232                         <span class="keywordflow">return</span> index;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%s %uth param offset = %d size = %zu\n&quot;</span>,
<a name="l00235"></a>00235                        <a class="code" href="lustre__update_8h.html#af41e2b72019c67f5f929c6a944d0801e">update_op_str</a>(op_type), i, index, param_sizes[i]);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237                 op-&gt;<a class="code" href="structupdate__op.html#a9abb43618e02db57c7b31424e187f7f8">uop_params_off</a>[i] = index;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;%huth &quot;</span><a class="code" href="group__lustreuser.html#gada965b87689690ab45635c329842df61">DFID</a><span class="stringliteral">&quot; %s param_count = %u\n&quot;</span>,
<a name="l00240"></a>00240                *op_count, <a class="code" href="group__lustreuser.html#ga00397843677b819317199a3198f5ecc2">PFID</a>(fid), <a class="code" href="lustre__update_8h.html#af41e2b72019c67f5f929c6a944d0801e">update_op_str</a>(op_type), *param_count);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         *op_count = *op_count + 1;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="keywordflow">return</span> 0;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00257"></a><a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8">00257</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(__u32 param_count, <span class="keywordtype">size_t</span> *sizes)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259         <span class="keywordtype">int</span> i;
<a name="l00260"></a>00260         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         <span class="comment">/* Check whether the packing exceeding the maximum update size */</span>
<a name="l00263"></a>00263         size = <a class="code" href="lustre__update_8h.html#af47faf7c6c34f6ec15cb8f989cb91992">update_op_size</a>(param_count);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keywordflow">for</span> (i = 0; i &lt; param_count; i++)
<a name="l00266"></a>00266                 size += <a class="code" href="group__lustreuser.html#ga605663c49f0739d2448d229b0ba3474d">cfs_size_round</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structobject__update__param.html">object_update_param</a>) +
<a name="l00267"></a>00267                                        sizes[i]);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">return</span> size;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00284"></a><a class="code" href="update__records_8c.html#a326d1ece7c3e09d476144648cd9c92d3">00284</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a326d1ece7c3e09d476144648cd9c92d3" title="Calculate create update size.">update_records_create_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00285"></a>00285                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00286"></a>00286                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__attr.html" title="Common object attributes.">lu_attr</a> *attr,
<a name="l00287"></a>00287                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structdt__allocation__hint.html" title="This is a general purpose dt allocation hint.">dt_allocation_hint</a> *hint,
<a name="l00288"></a>00288                                   <span class="keyword">struct</span> <a class="code" href="structdt__object__format.html" title="object format specifier.">dt_object_format</a> *dof)
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290         <span class="keywordtype">size_t</span>  sizes[2];
<a name="l00291"></a>00291         <span class="keywordtype">int</span>     param_count = 0;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="keywordflow">if</span> (attr != NULL) {
<a name="l00294"></a>00294                 sizes[param_count] = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structobdo.html">obdo</a>);
<a name="l00295"></a>00295                 param_count++;
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (hint != NULL &amp;&amp; hint-&gt;<a class="code" href="structdt__allocation__hint.html#a1a5f086e9baef8016e95fcd7f751dbee">dah_parent</a> != NULL) {
<a name="l00299"></a>00299                 sizes[param_count] = <span class="keyword">sizeof</span>(*fid);
<a name="l00300"></a>00300                 param_count++;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(param_count, sizes);
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a326d1ece7c3e09d476144648cd9c92d3" title="Calculate create update size.">update_records_create_size</a>);
<a name="l00306"></a>00306 
<a name="l00327"></a><a class="code" href="update__records_8c.html#a536f2912b198af6ae7b47e81fb5123cb">00327</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a536f2912b198af6ae7b47e81fb5123cb" title="Pack create update.">update_records_create_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00328"></a>00328                                <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00329"></a>00329                                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00330"></a>00330                                <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00331"></a>00331                                <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00332"></a>00332                                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00333"></a>00333                                <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00334"></a>00334                                <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00335"></a>00335                                <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__attr.html" title="Common object attributes.">lu_attr</a> *attr,
<a name="l00336"></a>00336                                <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structdt__allocation__hint.html" title="This is a general purpose dt allocation hint.">dt_allocation_hint</a> *hint,
<a name="l00337"></a>00337                                <span class="keyword">struct</span> <a class="code" href="structdt__object__format.html" title="object format specifier.">dt_object_format</a> *dof)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339         <span class="keywordtype">size_t</span>                  sizes[2];
<a name="l00340"></a>00340         <span class="keyword">const</span> <span class="keywordtype">void</span>              *bufs[2];
<a name="l00341"></a>00341         <span class="keywordtype">int</span>                     buf_count = 0;
<a name="l00342"></a>00342         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>     *parent_fid = NULL;
<a name="l00343"></a>00343         <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>           tmp_fid;
<a name="l00344"></a>00344         <span class="keywordtype">int</span>                     rc;
<a name="l00345"></a>00345         <span class="keyword">struct </span><a class="code" href="structobdo.html">obdo</a>             *<a class="code" href="structobdo.html">obdo</a>;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (attr != NULL) {
<a name="l00348"></a>00348                 obdo = &amp;<a class="code" href="tgt__internal_8h.html#a845853d38061c7c808963fb15039deae">update_env_info</a>(env)-&gt;<a class="code" href="structupdate__thread__info.html#a07efb1f21e2bbff977d98fe17006087e">uti_obdo</a>;
<a name="l00349"></a>00349                 obdo-&gt;<a class="code" href="structobdo.html#a0602c2272bf3c8483593a6c0bf01a66e">o_valid</a> = 0;
<a name="l00350"></a>00350                 <a class="code" href="obd__class_8h.html#a605366d6a6ba57642370a0d9bba22814">obdo_from_la</a>(obdo, attr, attr-&gt;<a class="code" href="structlu__attr.html#a6ebc7938388954da75a9b75f0689d469" title="valid bits">la_valid</a>);
<a name="l00351"></a>00351                 <a class="code" href="lustre__obdo_8h.html#a05a7a973405edf524acfa4ab2497fa1d" title="Create an obdo to send over the wire.">lustre_set_wire_obdo</a>(NULL, obdo, obdo);
<a name="l00352"></a>00352                 bufs[buf_count] = obdo;
<a name="l00353"></a>00353                 sizes[buf_count] = <span class="keyword">sizeof</span>(*obdo);
<a name="l00354"></a>00354                 buf_count++;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (hint != NULL &amp;&amp; hint-&gt;<a class="code" href="structdt__allocation__hint.html#a1a5f086e9baef8016e95fcd7f751dbee">dah_parent</a> != NULL) {
<a name="l00358"></a>00358                 parent_fid = <a class="code" href="group__lu.html#gab5b77e911368f64cb01c054ccabf51f3" title="Pointer to the fid of this object.">lu_object_fid</a>(&amp;hint-&gt;<a class="code" href="structdt__allocation__hint.html#a1a5f086e9baef8016e95fcd7f751dbee">dah_parent</a>-&gt;<a class="code" href="structdt__object.html#af646d1f1afe6acdc83ad0778a29163d7">do_lu</a>);
<a name="l00359"></a>00359                 <a class="code" href="group__lu__fid.html#ga67ad15a9c2e4676b57dd84272d2e6849">fid_cpu_to_le</a>(&amp;tmp_fid, parent_fid);
<a name="l00360"></a>00360                 bufs[buf_count] = &amp;tmp_fid;
<a name="l00361"></a>00361                 sizes[buf_count] = <span class="keyword">sizeof</span>(tmp_fid);
<a name="l00362"></a>00362                 buf_count++;
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         rc = <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586ad40a8cf7212d0e9186afae8c248b170e">OUT_CREATE</a>, ops, op_count,
<a name="l00366"></a>00366                                         max_ops_size, params, param_count,
<a name="l00367"></a>00367                                         max_param_size, buf_count, bufs, sizes);
<a name="l00368"></a>00368         <span class="keywordflow">return</span> rc;
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a536f2912b198af6ae7b47e81fb5123cb" title="Pack create update.">update_records_create_pack</a>);
<a name="l00371"></a>00371 
<a name="l00382"></a><a class="code" href="update__records_8c.html#a4bf05d79caeadc1273a5a62b66232154">00382</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a4bf05d79caeadc1273a5a62b66232154" title="Calculate attr set update size.">update_records_attr_set_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00383"></a>00383                                     <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00384"></a>00384                                     <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__attr.html" title="Common object attributes.">lu_attr</a> *attr)
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structobdo.html">obdo</a>);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(1, &amp;size);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a4bf05d79caeadc1273a5a62b66232154" title="Calculate attr set update size.">update_records_attr_set_size</a>);
<a name="l00391"></a>00391 
<a name="l00410"></a><a class="code" href="update__records_8c.html#aa11aad46fa862adb0b2d1a6790c20c36">00410</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#aa11aad46fa862adb0b2d1a6790c20c36" title="Pack attr set update.">update_records_attr_set_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00411"></a>00411                                  <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00412"></a>00412                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00413"></a>00413                                  <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00414"></a>00414                                  <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00415"></a>00415                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00416"></a>00416                                  <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00417"></a>00417                                  <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00418"></a>00418                                  <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__attr.html" title="Common object attributes.">lu_attr</a> *attr)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420         <span class="keyword">struct </span><a class="code" href="structobdo.html">obdo</a> *<a class="code" href="structobdo.html">obdo</a> = &amp;<a class="code" href="tgt__internal_8h.html#a845853d38061c7c808963fb15039deae">update_env_info</a>(env)-&gt;<a class="code" href="structupdate__thread__info.html#a07efb1f21e2bbff977d98fe17006087e">uti_obdo</a>;
<a name="l00421"></a>00421         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(*obdo);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         obdo-&gt;<a class="code" href="structobdo.html#a0602c2272bf3c8483593a6c0bf01a66e">o_valid</a> = 0;
<a name="l00424"></a>00424         <a class="code" href="obd__class_8h.html#a605366d6a6ba57642370a0d9bba22814">obdo_from_la</a>(obdo, attr, attr-&gt;<a class="code" href="structlu__attr.html#a6ebc7938388954da75a9b75f0689d469" title="valid bits">la_valid</a>);
<a name="l00425"></a>00425         <a class="code" href="lustre__obdo_8h.html#a05a7a973405edf524acfa4ab2497fa1d" title="Create an obdo to send over the wire.">lustre_set_wire_obdo</a>(NULL, obdo, obdo);
<a name="l00426"></a>00426         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a9d7d20f0bdf123028c17e80f443d1f49">OUT_ATTR_SET</a>, ops, op_count,
<a name="l00427"></a>00427                                           max_ops_size, params, param_count,
<a name="l00428"></a>00428                                           max_param_size, 1,
<a name="l00429"></a>00429                                           (<span class="keyword">const</span> <span class="keywordtype">void</span> **)&amp;obdo, &amp;size);
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#aa11aad46fa862adb0b2d1a6790c20c36" title="Pack attr set update.">update_records_attr_set_pack</a>);
<a name="l00432"></a>00432 
<a name="l00441"></a><a class="code" href="update__records_8c.html#ad64a0bb9fb472f09125a383580d779ed">00441</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#ad64a0bb9fb472f09125a383580d779ed" title="Calculate ref add update size.">update_records_ref_add_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00442"></a>00442                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(0, NULL);
<a name="l00445"></a>00445 }
<a name="l00446"></a>00446 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ad64a0bb9fb472f09125a383580d779ed" title="Calculate ref add update size.">update_records_ref_add_size</a>);
<a name="l00447"></a>00447 
<a name="l00465"></a><a class="code" href="update__records_8c.html#aa5c1ba7c90bb603fa32b3ce2cc3c80f9">00465</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#aa5c1ba7c90bb603fa32b3ce2cc3c80f9" title="Pack ref add update.">update_records_ref_add_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00466"></a>00466                                 <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00467"></a>00467                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00468"></a>00468                                 <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00469"></a>00469                                 <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00470"></a>00470                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00471"></a>00471                                 <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00472"></a>00472                                 <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a8e9697036fc0096f6b5e2e119dd64d4b">OUT_REF_ADD</a>, ops, op_count,
<a name="l00475"></a>00475                                           max_ops_size, params, param_count,
<a name="l00476"></a>00476                                           max_param_size, 0, NULL, NULL);
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#aa5c1ba7c90bb603fa32b3ce2cc3c80f9" title="Pack ref add update.">update_records_ref_add_pack</a>);
<a name="l00479"></a>00479 
<a name="l00499"></a><a class="code" href="update__records_8c.html#af2bca6df33e94f5dba3cc73e8020bd66">00499</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#af2bca6df33e94f5dba3cc73e8020bd66" title="Pack noop update.">update_records_noop_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00500"></a>00500                              <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00501"></a>00501                              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00502"></a>00502                              <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00503"></a>00503                              <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00504"></a>00504                              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00505"></a>00505                              <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00506"></a>00506                              <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586ac656347a3ab7fbf4bdca0d38d7f2f915">OUT_NOOP</a>, ops, op_count,
<a name="l00509"></a>00509                                           max_ops_size, params, param_count,
<a name="l00510"></a>00510                                           max_param_size, 0, NULL, NULL);
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#af2bca6df33e94f5dba3cc73e8020bd66" title="Pack noop update.">update_records_noop_pack</a>);
<a name="l00513"></a>00513 
<a name="l00522"></a><a class="code" href="update__records_8c.html#a63d3ba51338da1e9d0ab76f3838d2330">00522</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a63d3ba51338da1e9d0ab76f3838d2330" title="Calculate ref del update size.">update_records_ref_del_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00523"></a>00523                                    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(0, NULL);
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a63d3ba51338da1e9d0ab76f3838d2330" title="Calculate ref del update size.">update_records_ref_del_size</a>);
<a name="l00528"></a>00528 
<a name="l00546"></a><a class="code" href="update__records_8c.html#a5d679792a3b5e49d0170a1ce55df8ce4">00546</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a5d679792a3b5e49d0170a1ce55df8ce4" title="Pack ref del update.">update_records_ref_del_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00547"></a>00547                                 <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00548"></a>00548                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00549"></a>00549                                 <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00550"></a>00550                                 <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00551"></a>00551                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00552"></a>00552                                 <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00553"></a>00553                                 <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a1464664334225be19fb046470de4b9ef">OUT_REF_DEL</a>, ops, op_count,
<a name="l00556"></a>00556                                           max_ops_size, params, param_count,
<a name="l00557"></a>00557                                           max_param_size, 0, NULL, NULL);
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a5d679792a3b5e49d0170a1ce55df8ce4" title="Pack ref del update.">update_records_ref_del_pack</a>);
<a name="l00560"></a>00560 
<a name="l00569"></a><a class="code" href="update__records_8c.html#a8bb4f27514127c7fddfed05269fddd6e">00569</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a8bb4f27514127c7fddfed05269fddd6e" title="Calculate object destroy update size.">update_records_object_destroy_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00570"></a>00570                                           <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(0, NULL);
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a8bb4f27514127c7fddfed05269fddd6e" title="Calculate object destroy update size.">update_records_object_destroy_size</a>);
<a name="l00575"></a>00575 
<a name="l00593"></a><a class="code" href="update__records_8c.html#af464d53afef74f1b3918d3571fa2581e">00593</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#af464d53afef74f1b3918d3571fa2581e" title="Pack object destroy update.">update_records_object_destroy_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00594"></a>00594                                        <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00595"></a>00595                                        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00596"></a>00596                                        <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00597"></a>00597                                        <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00598"></a>00598                                        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00599"></a>00599                                        <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00600"></a>00600                                        <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a458a757397ae8cdb41a514582cd179dc">OUT_DESTROY</a>, ops, op_count,
<a name="l00603"></a>00603                                           max_ops_size, params, param_count,
<a name="l00604"></a>00604                                           max_param_size, 0, NULL, NULL);
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#af464d53afef74f1b3918d3571fa2581e" title="Pack object destroy update.">update_records_object_destroy_pack</a>);
<a name="l00607"></a>00607 
<a name="l00618"></a><a class="code" href="update__records_8c.html#ab0351ffc2e1e9c70f887fbfa8181ab0e">00618</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#ab0351ffc2e1e9c70f887fbfa8181ab0e" title="Calculate index insert update size.">update_records_index_insert_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00619"></a>00619                                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00620"></a>00620                                         <span class="keyword">const</span> <span class="keyword">struct</span> dt_rec *rec,
<a name="l00621"></a>00621                                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="dt__object_8h.html#aa088e3c821ba20ee0bd6bad2f8ece91c">dt_key</a> *key)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623         <span class="keywordtype">size_t</span>                     sizes[3] = { strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)key) + 1,
<a name="l00624"></a>00624                                                 <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>),
<a name="l00625"></a>00625                                                 sizeof(__u32) };
<a name="l00626"></a>00626         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(3, sizes);
<a name="l00627"></a>00627 }
<a name="l00628"></a>00628 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ab0351ffc2e1e9c70f887fbfa8181ab0e" title="Calculate index insert update size.">update_records_index_insert_size</a>);
<a name="l00629"></a>00629 
<a name="l00649"></a><a class="code" href="update__records_8c.html#a2ba66c5a47966557f3ac9310ff1774dd">00649</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a2ba66c5a47966557f3ac9310ff1774dd" title="Pack index insert update.">update_records_index_insert_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00650"></a>00650                                      <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00651"></a>00651                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00652"></a>00652                                      <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00653"></a>00653                                      <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00654"></a>00654                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00655"></a>00655                                      <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00656"></a>00656                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00657"></a>00657                                      <span class="keyword">const</span> <span class="keyword">struct</span> dt_rec *rec,
<a name="l00658"></a>00658                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="dt__object_8h.html#aa088e3c821ba20ee0bd6bad2f8ece91c">dt_key</a> *key)
<a name="l00659"></a>00659 {
<a name="l00660"></a>00660         <span class="keyword">struct </span><a class="code" href="structdt__insert__rec.html">dt_insert_rec</a>       *rec1 = (<span class="keyword">struct </span><a class="code" href="structdt__insert__rec.html">dt_insert_rec</a> *)rec;
<a name="l00661"></a>00661         <span class="keyword">struct </span><a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a>              rec_fid;
<a name="l00662"></a>00662         __u32                      type = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(rec1-&gt;<a class="code" href="structdt__insert__rec.html#a97c41340c3d91b4b6b2e85dd143d41b7">rec_type</a>);
<a name="l00663"></a>00663         <span class="keywordtype">size_t</span>                     sizes[3] = { strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)key) + 1,
<a name="l00664"></a>00664                                                 <span class="keyword">sizeof</span>(rec_fid),
<a name="l00665"></a>00665                                                 <span class="keyword">sizeof</span>(type) };
<a name="l00666"></a>00666         <span class="keyword">const</span> <span class="keywordtype">void</span>                 *bufs[3] = { key,
<a name="l00667"></a>00667                                                 &amp;rec_fid,
<a name="l00668"></a>00668                                                 &amp;type };
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         <a class="code" href="group__lu__fid.html#ga67ad15a9c2e4676b57dd84272d2e6849">fid_cpu_to_le</a>(&amp;rec_fid, rec1-&gt;<a class="code" href="structdt__insert__rec.html#a248b6f944adb19db965a8107130bc120">rec_fid</a>);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a70df7367cf818023b4000c85573ad03a">OUT_INDEX_INSERT</a>, ops,
<a name="l00673"></a>00673                                           op_count, max_ops_size, params,
<a name="l00674"></a>00674                                           param_count, max_param_size,
<a name="l00675"></a>00675                                           3, bufs, sizes);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a2ba66c5a47966557f3ac9310ff1774dd" title="Pack index insert update.">update_records_index_insert_pack</a>);
<a name="l00678"></a>00678 
<a name="l00688"></a><a class="code" href="update__records_8c.html#a178056dec37f7d672b8c2989b2b3c24d">00688</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a178056dec37f7d672b8c2989b2b3c24d" title="Calculate index delete update size.">update_records_index_delete_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00689"></a>00689                                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00690"></a>00690                                         <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="dt__object_8h.html#aa088e3c821ba20ee0bd6bad2f8ece91c">dt_key</a> *key)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)key) + 1;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(1, &amp;size);
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a178056dec37f7d672b8c2989b2b3c24d" title="Calculate index delete update size.">update_records_index_delete_size</a>);
<a name="l00697"></a>00697 
<a name="l00716"></a><a class="code" href="update__records_8c.html#ad37f503135c466368b42b72fc0061fe1">00716</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#ad37f503135c466368b42b72fc0061fe1" title="Pack index delete update.">update_records_index_delete_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00717"></a>00717                                      <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00718"></a>00718                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00719"></a>00719                                      <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00720"></a>00720                                      <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00721"></a>00721                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00722"></a>00722                                      <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00723"></a>00723                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00724"></a>00724                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="dt__object_8h.html#aa088e3c821ba20ee0bd6bad2f8ece91c">dt_key</a> *key)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726         <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)key) + 1;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586ac86dcbb94c937ebcd43c21030db30edd">OUT_INDEX_DELETE</a>, ops,
<a name="l00729"></a>00729                                           op_count, max_ops_size, params,
<a name="l00730"></a>00730                                           param_count, max_param_size,
<a name="l00731"></a>00731                                           1, (<span class="keyword">const</span> <span class="keywordtype">void</span> **)&amp;key, &amp;size);
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ad37f503135c466368b42b72fc0061fe1" title="Pack index delete update.">update_records_index_delete_pack</a>);
<a name="l00734"></a>00734 
<a name="l00746"></a><a class="code" href="update__records_8c.html#ac4e8a1f313a91e3776612c227750ac27">00746</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#ac4e8a1f313a91e3776612c227750ac27" title="Calculate xattr set size.">update_records_xattr_set_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00747"></a>00747                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00748"></a>00748                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *<a class="code" href="parallel__grouplock_8c.html#a30581aaaef7980b9fc6df8f98406097c">buf</a>,
<a name="l00749"></a>00749                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, __u32 flag)
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751         <span class="keywordtype">size_t</span>  sizes[3] = {strlen(name) + 1, buf-&gt;<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a>, <span class="keyword">sizeof</span>(flag)};
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(3, sizes);
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ac4e8a1f313a91e3776612c227750ac27" title="Calculate xattr set size.">update_records_xattr_set_size</a>);
<a name="l00756"></a>00756 
<a name="l00777"></a><a class="code" href="update__records_8c.html#ab5cbaa54ac4deb3eb969c29688a56f28">00777</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#ab5cbaa54ac4deb3eb969c29688a56f28" title="Pack xattr set update.">update_records_xattr_set_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00778"></a>00778                                   <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00779"></a>00779                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00780"></a>00780                                   <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00781"></a>00781                                   <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00782"></a>00782                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00783"></a>00783                                   <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00784"></a>00784                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00785"></a>00785                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *buf, <span class="keyword">const</span> <span class="keywordtype">char</span> *name,
<a name="l00786"></a>00786                                   __u32 flag)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788         <span class="keywordtype">size_t</span>  sizes[3] = {strlen(name) + 1, buf-&gt;<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a>, <span class="keyword">sizeof</span>(flag)};
<a name="l00789"></a>00789         <span class="keyword">const</span> <span class="keywordtype">void</span> *bufs[3] = {name, buf-&gt;<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a>, &amp;flag};
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         flag = <a class="code" href="byteorder_8h.html#a1d5ae0c36d519a1b0a789db69a598f28">cpu_to_le32</a>(flag);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a6a4fa2d2cd7643a6e9f80d8ab4f5f502">OUT_XATTR_SET</a>, ops,
<a name="l00794"></a>00794                                           op_count, max_ops_size, params,
<a name="l00795"></a>00795                                           param_count, max_param_size,
<a name="l00796"></a>00796                                           3, bufs, sizes);
<a name="l00797"></a>00797 }
<a name="l00798"></a>00798 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ab5cbaa54ac4deb3eb969c29688a56f28" title="Pack xattr set update.">update_records_xattr_set_pack</a>);
<a name="l00799"></a>00799 
<a name="l00809"></a><a class="code" href="update__records_8c.html#a6c4c7df106878116b11868e232551086">00809</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a6c4c7df106878116b11868e232551086" title="Calculate xattr delete update size.">update_records_xattr_del_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00810"></a>00810                                      <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00811"></a>00811                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813         <span class="keywordtype">size_t</span>  <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = strlen(name) + 1;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(1, &amp;size);
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a6c4c7df106878116b11868e232551086" title="Calculate xattr delete update size.">update_records_xattr_del_size</a>);
<a name="l00818"></a>00818 
<a name="l00837"></a><a class="code" href="update__records_8c.html#a79c727b585d2b96accddc19a646fecb5">00837</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a79c727b585d2b96accddc19a646fecb5" title="Pack xattr delete update.">update_records_xattr_del_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00838"></a>00838                                   <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00839"></a>00839                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00840"></a>00840                                   <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00841"></a>00841                                   <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00842"></a>00842                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00843"></a>00843                                   <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00844"></a>00844                                   <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00845"></a>00845                                   <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00846"></a>00846 {
<a name="l00847"></a>00847         <span class="keywordtype">size_t</span>  <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = strlen(name) + 1;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a93cf4b6ad421a5f74f74ff1b566ef7e0">OUT_XATTR_DEL</a>, ops,
<a name="l00850"></a>00850                                           op_count, max_ops_size, params,
<a name="l00851"></a>00851                                           param_count, max_param_size,
<a name="l00852"></a>00852                                           1, (<span class="keyword">const</span> <span class="keywordtype">void</span> **)&amp;name, &amp;size);
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a79c727b585d2b96accddc19a646fecb5" title="Pack xattr delete update.">update_records_xattr_del_pack</a>);
<a name="l00855"></a>00855 
<a name="l00866"></a><a class="code" href="update__records_8c.html#a9a613a028497e370001345de3c47ee5b">00866</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a9a613a028497e370001345de3c47ee5b" title="Calculate write update size.">update_records_write_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00867"></a>00867                                  <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00868"></a>00868                                  <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *buf,
<a name="l00869"></a>00869                                  <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> pos)
<a name="l00870"></a>00870 {
<a name="l00871"></a>00871         <span class="keywordtype">size_t</span>  sizes[2] = {buf-&gt;<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a>, <span class="keyword">sizeof</span>(pos)};
<a name="l00872"></a>00872 
<a name="l00873"></a>00873         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(2, sizes);
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a9a613a028497e370001345de3c47ee5b" title="Calculate write update size.">update_records_write_size</a>);
<a name="l00876"></a>00876 
<a name="l00896"></a><a class="code" href="update__records_8c.html#ac13bcde2bee8f3032877e62eaef1841f">00896</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#ac13bcde2bee8f3032877e62eaef1841f" title="Pack write update.">update_records_write_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00897"></a>00897                               <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00898"></a>00898                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00899"></a>00899                               <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00900"></a>00900                               <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00901"></a>00901                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00902"></a>00902                               <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00903"></a>00903                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00904"></a>00904                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__buf.html" title="Common buffer structure to be passed around for various xattr_{s,g}et() methods.">lu_buf</a> *buf,
<a name="l00905"></a>00905                               <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> pos)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907         <span class="keywordtype">size_t</span>          sizes[2] = {buf-&gt;<a class="code" href="structlu__buf.html#a99a05a4a568085620bc4e62265a6fc9b">lb_len</a>, <span class="keyword">sizeof</span>(pos)};
<a name="l00908"></a>00908         <span class="keyword">const</span> <span class="keywordtype">void</span>      *bufs[2] = {buf-&gt;<a class="code" href="structlu__buf.html#a91128fd207a48747473072790fd3ad84">lb_buf</a>, &amp;pos};
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         pos = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(pos);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586aecf98f45b4260d6b4e78fd8bd9beb542">OUT_WRITE</a>, ops,
<a name="l00913"></a>00913                                           op_count, max_ops_size, params,
<a name="l00914"></a>00914                                           param_count, max_param_size,
<a name="l00915"></a>00915                                           2, bufs, sizes);
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ac13bcde2bee8f3032877e62eaef1841f" title="Pack write update.">update_records_write_pack</a>);
<a name="l00918"></a>00918 
<a name="l00929"></a><a class="code" href="update__records_8c.html#a22158bbaf3c1c6e48822b0046db9532e">00929</a> <span class="keywordtype">size_t</span> <a class="code" href="lustre__update_8h.html#a22158bbaf3c1c6e48822b0046db9532e" title="Calculate size of punch update.">update_records_punch_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00930"></a>00930                                  <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00931"></a>00931                                  <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="rename__many_8c.html#ac452537b6646180ccdf7beba12c1b331">start</a>, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="mdsrate_8c.html#abce9f5dc9c83f2639b72024fdee5d388">end</a>)
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933         <span class="keywordtype">size_t</span>  sizes[2] = {<span class="keyword">sizeof</span>(start), <span class="keyword">sizeof</span>(end)};
<a name="l00934"></a>00934 
<a name="l00935"></a>00935         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#ab9c9d7287a010ab7190c3c4ee5e58de8" title="Calculate update_records size.">update_records_update_size</a>(2, sizes);
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a22158bbaf3c1c6e48822b0046db9532e" title="Calculate size of punch update.">update_records_punch_size</a>);
<a name="l00938"></a>00938 
<a name="l00958"></a><a class="code" href="update__records_8c.html#a0c8abdcf750282a719ba9c11582a210e">00958</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a0c8abdcf750282a719ba9c11582a210e" title="Pack punch.">update_records_punch_pack</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l00959"></a>00959                               <span class="keyword">struct</span> <a class="code" href="structupdate__ops.html">update_ops</a> *ops,
<a name="l00960"></a>00960                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *op_count,
<a name="l00961"></a>00961                               <span class="keywordtype">size_t</span> *max_ops_size,
<a name="l00962"></a>00962                               <span class="keyword">struct</span> <a class="code" href="structupdate__params.html">update_params</a> *params,
<a name="l00963"></a>00963                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *param_count,
<a name="l00964"></a>00964                               <span class="keywordtype">size_t</span> *max_param_size,
<a name="l00965"></a>00965                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__fid.html" title="File IDentifier.">lu_fid</a> *fid,
<a name="l00966"></a>00966                               <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="rename__many_8c.html#ac452537b6646180ccdf7beba12c1b331">start</a>, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="mdsrate_8c.html#abce9f5dc9c83f2639b72024fdee5d388">end</a>)
<a name="l00967"></a>00967 {
<a name="l00968"></a>00968         <span class="keywordtype">size_t</span>          sizes[2] = {<span class="keyword">sizeof</span>(start), <span class="keyword">sizeof</span>(end)};
<a name="l00969"></a>00969         <span class="keyword">const</span> <span class="keywordtype">void</span>      *bufs[2] = {&amp;start, &amp;end};
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         start = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(start);
<a name="l00972"></a>00972         end = <a class="code" href="byteorder_8h.html#aa170dc4b2dae5b00bdec3a307427240f">cpu_to_le64</a>(end);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974         <span class="keywordflow">return</span> <a class="code" href="update__records_8c.html#a8eca2f7719b11d7f4bce26350591ce40" title="Pack update to update records.">update_records_update_pack</a>(env, fid, <a class="code" href="group__lustreidl.html#gga2d1a90f202540bfbcbd72a8c0f94b586a97cc01efc58263d5d48a0f2764891a58">OUT_PUNCH</a>, ops, op_count,
<a name="l00975"></a>00975                                           max_ops_size, params, param_count,
<a name="l00976"></a>00976                                           max_param_size, 2, bufs, sizes);
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a0c8abdcf750282a719ba9c11582a210e" title="Pack punch.">update_records_punch_pack</a>);
<a name="l00979"></a>00979 
<a name="l00991"></a><a class="code" href="update__records_8c.html#a6a2d06df1f1cf3cd53e74ec16fccd2f1">00991</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="update__records_8c.html#a6a2d06df1f1cf3cd53e74ec16fccd2f1" title="Create update records in thandle_update_records.">tur_update_records_create</a>(<span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur)
<a name="l00992"></a>00992 {
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> != NULL)
<a name="l00994"></a>00994                 <span class="keywordflow">return</span> 0;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996         <a class="code" href="obd__support_8h.html#afa959cd10c660882cd6c5fad07311897">OBD_ALLOC_LARGE</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>,
<a name="l00997"></a>00997                         <a class="code" href="update__records_8c.html#acada94ed8c998be34e7c491abdf175c1">UPDATE_RECORDS_BUFFER_SIZE</a>);
<a name="l00998"></a>00998 
<a name="l00999"></a>00999         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> == NULL)
<a name="l01000"></a>01000                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a> = <a class="code" href="update__records_8c.html#acada94ed8c998be34e7c491abdf175c1">UPDATE_RECORDS_BUFFER_SIZE</a>;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         <span class="keywordflow">return</span> 0;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01017"></a><a class="code" href="update__records_8c.html#a1015e587064445a57adea2dc3f93c47e">01017</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a1015e587064445a57adea2dc3f93c47e" title="Extend update records.">tur_update_records_extend</a>(<span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur,
<a name="l01018"></a>01018                               <span class="keywordtype">size_t</span> new_size)
<a name="l01019"></a>01019 {
<a name="l01020"></a>01020         <span class="keyword">struct </span><a class="code" href="structllog__update__record.html">llog_update_record</a>       *record;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <a class="code" href="obd__support_8h.html#afa959cd10c660882cd6c5fad07311897">OBD_ALLOC_LARGE</a>(record, new_size);
<a name="l01023"></a>01023         <span class="keywordflow">if</span> (record == NULL)
<a name="l01024"></a>01024                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> != NULL) {
<a name="l01027"></a>01027                 memcpy(record, tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>,
<a name="l01028"></a>01028                        tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a>);
<a name="l01029"></a>01029                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>,
<a name="l01030"></a>01030                                tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a>);
<a name="l01031"></a>01031         }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033         tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> = record;
<a name="l01034"></a>01034         tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a> = new_size;
<a name="l01035"></a>01035 
<a name="l01036"></a>01036         <span class="keywordflow">return</span> 0;
<a name="l01037"></a>01037 }
<a name="l01038"></a>01038 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a1015e587064445a57adea2dc3f93c47e" title="Extend update records.">tur_update_records_extend</a>);
<a name="l01039"></a>01039 
<a name="l01054"></a><a class="code" href="update__records_8c.html#ad210f707a77f4c3b34e784df2fa88f02">01054</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#ad210f707a77f4c3b34e784df2fa88f02" title="Extend update records.">tur_update_extend</a>(<span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur,
<a name="l01055"></a>01055                       <span class="keywordtype">size_t</span> new_op_size, <span class="keywordtype">size_t</span> new_param_size)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057         <span class="keywordtype">size_t</span> record_size;
<a name="l01058"></a>01058         <span class="keywordtype">size_t</span> params_size;
<a name="l01059"></a>01059         <span class="keywordtype">size_t</span> extend_size;
<a name="l01060"></a>01060         <span class="keywordtype">int</span> rc;
<a name="l01061"></a>01061         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         record_size = <a class="code" href="lustre__update_8h.html#a1255fb1ec405f9b11f0768aa7e6068c3">llog_update_record_size</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>);
<a name="l01064"></a>01064         <span class="comment">/* extend update records buffer */</span>
<a name="l01065"></a>01065         <span class="keywordflow">if</span> (new_op_size &gt;= (tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a> - record_size)) {
<a name="l01066"></a>01066                 extend_size = round_up(new_op_size, <a class="code" href="update__records_8c.html#acada94ed8c998be34e7c491abdf175c1">UPDATE_RECORDS_BUFFER_SIZE</a>);
<a name="l01067"></a>01067                 rc = <a class="code" href="lustre__update_8h.html#a1015e587064445a57adea2dc3f93c47e" title="Extend update records.">tur_update_records_extend</a>(tur,
<a name="l01068"></a>01068                                 tur-&gt;<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a> +
<a name="l01069"></a>01069                                 extend_size);
<a name="l01070"></a>01070                 <span class="keywordflow">if</span> (rc != 0)
<a name="l01071"></a>01071                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <span class="comment">/* extend parameters buffer */</span>
<a name="l01075"></a>01075         params_size = <a class="code" href="lustre__update_8h.html#ab1178c4f1e649ee44d63f24ce145c1e1">update_params_size</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a>,
<a name="l01076"></a>01076                                          tur-&gt;<a class="code" href="structthandle__update__records.html#a0172269b4f60d5cb41714de26139940a">tur_update_param_count</a>);
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (new_param_size &gt;= (tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a> -
<a name="l01078"></a>01078                               params_size)) {
<a name="l01079"></a>01079                 extend_size = round_up(new_param_size,
<a name="l01080"></a>01080                                        <a class="code" href="update__records_8c.html#a7d473853c875c101a45128c57a911e36">UPDATE_PARAMS_BUFFER_SIZE</a>);
<a name="l01081"></a>01081                 rc = <a class="code" href="lustre__update_8h.html#a23a3a01eea42de3cf2cc943246e9b157" title="Extend update params.">tur_update_params_extend</a>(tur,
<a name="l01082"></a>01082                                 tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a> +
<a name="l01083"></a>01083                                 extend_size);
<a name="l01084"></a>01084                 <span class="keywordflow">if</span> (rc != 0)
<a name="l01085"></a>01085                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01086"></a>01086         }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01089"></a>01089 }
<a name="l01090"></a>01090 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#ad210f707a77f4c3b34e784df2fa88f02" title="Extend update records.">tur_update_extend</a>);
<a name="l01091"></a>01091 
<a name="l01103"></a><a class="code" href="update__records_8c.html#ad1d8fe575b8f17af66c1e4856279877c">01103</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="update__records_8c.html#ad1d8fe575b8f17af66c1e4856279877c" title="Create update params in thandle_update_records.">tur_update_params_create</a>(<span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> != NULL)
<a name="l01106"></a>01106                 <span class="keywordflow">return</span> 0;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <a class="code" href="obd__support_8h.html#afa959cd10c660882cd6c5fad07311897">OBD_ALLOC_LARGE</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a>, <a class="code" href="update__records_8c.html#a7d473853c875c101a45128c57a911e36">UPDATE_PARAMS_BUFFER_SIZE</a>);
<a name="l01109"></a>01109         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> == NULL)
<a name="l01110"></a>01110                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a> = <a class="code" href="update__records_8c.html#a7d473853c875c101a45128c57a911e36">UPDATE_PARAMS_BUFFER_SIZE</a>;
<a name="l01113"></a>01113         <span class="keywordflow">return</span> 0;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01126"></a><a class="code" href="update__records_8c.html#a23a3a01eea42de3cf2cc943246e9b157">01126</a> <span class="keywordtype">int</span> <a class="code" href="lustre__update_8h.html#a23a3a01eea42de3cf2cc943246e9b157" title="Extend update params.">tur_update_params_extend</a>(<span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur,
<a name="l01127"></a>01127                              <span class="keywordtype">size_t</span> new_size)
<a name="l01128"></a>01128 {
<a name="l01129"></a>01129         <span class="keyword">struct </span><a class="code" href="structupdate__params.html">update_params</a>    *params;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131         <a class="code" href="obd__support_8h.html#afa959cd10c660882cd6c5fad07311897">OBD_ALLOC_LARGE</a>(params, new_size);
<a name="l01132"></a>01132         <span class="keywordflow">if</span> (params == NULL)
<a name="l01133"></a>01133                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l01134"></a>01134 
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> != NULL) {
<a name="l01136"></a>01136                 memcpy(params, tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a>,
<a name="l01137"></a>01137                        tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a>);
<a name="l01138"></a>01138                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a>,
<a name="l01139"></a>01139                                tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a>);
<a name="l01140"></a>01140         }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> = params;
<a name="l01143"></a>01143         tur-&gt;<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a> = new_size;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145         <span class="keywordflow">return</span> 0;
<a name="l01146"></a>01146 }
<a name="l01147"></a>01147 EXPORT_SYMBOL(<a class="code" href="lustre__update_8h.html#a23a3a01eea42de3cf2cc943246e9b157" title="Extend update params.">tur_update_params_extend</a>);
<a name="l01148"></a>01148 
<a name="l01161"></a><a class="code" href="update__records_8c.html#a18a6ce30ff68ba772a30fd9a164b9a18">01161</a> <span class="keywordtype">int</span> <a class="code" href="tgt__internal_8h.html#a18a6ce30ff68ba772a30fd9a164b9a18" title="Check and prepare whether it needs to record update.">check_and_prepare_update_record</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__env.html" title="Environment.">lu_env</a> *env,
<a name="l01162"></a>01162                                     <span class="keyword">struct</span> <a class="code" href="structthandle__update__records.html" title="Attached in the thandle to record the updates for distribute distribution.">thandle_update_records</a> *tur)
<a name="l01163"></a>01163 {
<a name="l01164"></a>01164         <span class="keyword">struct </span><a class="code" href="structllog__update__record.html">llog_update_record</a>       *<a class="code" href="llog__test_8c.html#a691936eb94060f108728643f5af5a196">lur</a>;
<a name="l01165"></a>01165         <span class="keywordtype">int</span> rc;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> == NULL) {
<a name="l01168"></a>01168                 rc = <a class="code" href="update__records_8c.html#a6a2d06df1f1cf3cd53e74ec16fccd2f1" title="Create update records in thandle_update_records.">tur_update_records_create</a>(tur);
<a name="l01169"></a>01169                 <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01170"></a>01170                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01171"></a>01171         }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173         <span class="keywordflow">if</span> (tur-&gt;<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> == NULL) {
<a name="l01174"></a>01174                 rc = <a class="code" href="update__records_8c.html#ad1d8fe575b8f17af66c1e4856279877c" title="Create update params in thandle_update_records.">tur_update_params_create</a>(tur);
<a name="l01175"></a>01175                 <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01176"></a>01176                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l01177"></a>01177         }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179         lur = tur-&gt;<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>;
<a name="l01180"></a>01180         lur-&gt;<a class="code" href="structllog__update__record.html#a618dbb1f180c8450cb15cfb62d905537">lur_update_rec</a>.<a class="code" href="structupdate__records.html#a7cd9154022dc7f8b2bc672f885275e32">ur_update_count</a> = 0;
<a name="l01181"></a>01181         lur-&gt;<a class="code" href="structllog__update__record.html#a618dbb1f180c8450cb15cfb62d905537">lur_update_rec</a>.<a class="code" href="structupdate__records.html#aaee500e2e7c4db6d9c6074412fd60a1d">ur_param_count</a> = 0;
<a name="l01182"></a>01182         lur-&gt;<a class="code" href="structllog__update__record.html#a618dbb1f180c8450cb15cfb62d905537">lur_update_rec</a>.<a class="code" href="structupdate__records.html#af1342ae9b7b02cf47b9302ec544b1b57">ur_master_transno</a> = 0;
<a name="l01183"></a>01183         lur-&gt;<a class="code" href="structllog__update__record.html#a618dbb1f180c8450cb15cfb62d905537">lur_update_rec</a>.<a class="code" href="structupdate__records.html#a689a2fa2a66db9e494365763a2e22080">ur_batchid</a> = 0;
<a name="l01184"></a>01184         lur-&gt;<a class="code" href="structllog__update__record.html#a618dbb1f180c8450cb15cfb62d905537">lur_update_rec</a>.<a class="code" href="structupdate__records.html#a371c3f6f09bca53059265560eadfa3be">ur_flags</a> = 0;
<a name="l01185"></a>01185         lur-&gt;<a class="code" href="structllog__update__record.html#af532ed0e881f26dbe5f2e30e51302404">lur_hdr</a>.<a class="code" href="structllog__rec__hdr.html#ad78574b9a0f5e0400ba90c351a0add96">lrh_len</a> = <a class="code" href="group__lustreidl.html#ga3f2d81734d4c0731223e0db9a86d9514">LLOG_MIN_CHUNK_SIZE</a>;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         tur-&gt;<a class="code" href="structthandle__update__records.html#a0172269b4f60d5cb41714de26139940a">tur_update_param_count</a> = 0;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01192"></a><a class="code" href="update__records_8c.html#a37c7cabb6a8f94532a8c3b9041d04194">01192</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="update__records_8c.html#a37c7cabb6a8f94532a8c3b9041d04194">update_key_fini</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structlu__context.html" title="lu_context.">lu_context</a> *ctx,
<a name="l01193"></a>01193                             <span class="keyword">struct</span> <a class="code" href="structlu__context__key.html" title="Key.">lu_context_key</a> *key, <span class="keywordtype">void</span> *data)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195         <span class="keyword">struct </span><a class="code" href="structupdate__thread__info.html">update_thread_info</a> *info = data;
<a name="l01196"></a>01196         <span class="keyword">struct </span><a class="code" href="structthandle__exec__args.html">thandle_exec_args</a>  *args = &amp;info-&gt;<a class="code" href="structupdate__thread__info.html#a19fab634108c6c3c6f52cd2e4ba18e96">uti_tea</a>;
<a name="l01197"></a>01197         <span class="keywordtype">int</span>                       i;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199         <span class="keywordflow">for</span> (i = 0; i &lt; args-&gt;<a class="code" href="structthandle__exec__args.html#a5df0e99c1855a89787965df69fa3cbe6">ta_alloc_args</a>; i++) {
<a name="l01200"></a>01200                 <span class="keywordflow">if</span> (args-&gt;<a class="code" href="structthandle__exec__args.html#abd5480d903d1a6ddb1b6c3121465cff5">ta_args</a>[i] != NULL)
<a name="l01201"></a>01201                         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(args-&gt;<a class="code" href="structthandle__exec__args.html#abd5480d903d1a6ddb1b6c3121465cff5">ta_args</a>[i]);
<a name="l01202"></a>01202         }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         <span class="keywordflow">if</span> (args-&gt;<a class="code" href="structthandle__exec__args.html#abd5480d903d1a6ddb1b6c3121465cff5">ta_args</a> != NULL)
<a name="l01205"></a>01205                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(args-&gt;<a class="code" href="structthandle__exec__args.html#abd5480d903d1a6ddb1b6c3121465cff5">ta_args</a>, <span class="keyword">sizeof</span>(args-&gt;<a class="code" href="structthandle__exec__args.html#abd5480d903d1a6ddb1b6c3121465cff5">ta_args</a>[0]) *
<a name="l01206"></a>01206                          args-&gt;<a class="code" href="structthandle__exec__args.html#a5df0e99c1855a89787965df69fa3cbe6">ta_alloc_args</a>);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a> != NULL)
<a name="l01209"></a>01209                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#ae588134beae8f70c0d087e1fbc6135d0">tur_update_records</a>,
<a name="l01210"></a>01210                                info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#af851df0af7a693b9cae756147d4e4425">tur_update_records_buf_size</a>);
<a name="l01211"></a>01211         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a> != NULL)
<a name="l01212"></a>01212                 <a class="code" href="obd__support_8h.html#a23d443ea219d6893da5645c760e0c28a">OBD_FREE_LARGE</a>(info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#afc0cac5e46a69dec7699bc480c2b9cd2">tur_update_params</a>,
<a name="l01213"></a>01213                                info-&gt;<a class="code" href="structupdate__thread__info.html#a8fe918f102a5618090fa736683e419b1">uti_tur</a>.<a class="code" href="structthandle__update__records.html#a590d47160520eff819dd7892bae19e30">tur_update_params_buf_size</a>);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(info);
<a name="l01216"></a>01216 }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 <span class="comment">/* context key constructor/destructor: update_key_init, update_key_fini */</span>
<a name="l01219"></a>01219 <a class="code" href="group__lu.html#ga0b29c45a8b7394108cd5565b0aae188d">LU_KEY_INIT</a>(update, <span class="keyword">struct</span> <a class="code" href="structupdate__thread__info.html">update_thread_info</a>);
<a name="l01220"></a>01220 <span class="comment">/* context key: update_thread_key */</span>
<a name="l01221"></a>01221 <a class="code" href="group__lu.html#gaa018139e0d1873e79fc3f2e5c167fc0f">LU_CONTEXT_KEY_DEFINE</a>(update, <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aa51f264f8e3ea36a381cf8aaaa9672752" title="Thread on md server.">LCT_MD_THREAD</a> | <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aa582fa482375137187e808b1f5f8662d1" title="MGS device thread.">LCT_MG_THREAD</a> |
<a name="l01222"></a>01222                               <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aa130ed4529679eed5a88d5dc63db1921f" title="Thread on dt server.">LCT_DT_THREAD</a> | <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aae4ff6019628711d8f1dbefee9e3edfee" title="Context for transaction handle.">LCT_TX_HANDLE</a> | <a class="code" href="group__lu.html#ggad7e2d14b1b91480b0b25656f63169a0aa87bf2c0c71c5af685cf15e809a7ed551" title="Context for local operations.">LCT_LOCAL</a>);
<a name="l01223"></a>01223 EXPORT_SYMBOL(update_thread_key);
<a name="l01224"></a>01224 <a class="code" href="group__lu.html#gae44eda3313c603a02014b7281ebcf53c">LU_KEY_INIT_GENERIC</a>(update);
<a name="l01225"></a>01225 
<a name="l01226"></a><a class="code" href="update__records_8c.html#abb3102b38b590d56d0c531397be53292">01226</a> <span class="keywordtype">void</span> <a class="code" href="tgt__internal_8h.html#abb3102b38b590d56d0c531397be53292">update_info_init</a>(<span class="keywordtype">void</span>)
<a name="l01227"></a>01227 {
<a name="l01228"></a>01228         update_key_init_generic(&amp;<a class="code" href="tgt__internal_8h.html#aa001baf045dcb5ffc759648eceddbccb">update_thread_key</a>, NULL);
<a name="l01229"></a>01229         <a class="code" href="group__lu.html#ga1eef6b147da5ae4489576e136772d404" title="Register new key.">lu_context_key_register</a>(&amp;<a class="code" href="tgt__internal_8h.html#aa001baf045dcb5ffc759648eceddbccb">update_thread_key</a>);
<a name="l01230"></a>01230 }
<a name="l01231"></a>01231 
<a name="l01232"></a><a class="code" href="update__records_8c.html#a50e52cb7df7ffa36c19228b8fd137c28">01232</a> <span class="keywordtype">void</span> <a class="code" href="tgt__internal_8h.html#a50e52cb7df7ffa36c19228b8fd137c28">update_info_fini</a>(<span class="keywordtype">void</span>)
<a name="l01233"></a>01233 {
<a name="l01234"></a>01234         <a class="code" href="group__lu.html#ga6e069db37ac446fe47b8b211c3d721c5" title="Deregister key.">lu_context_key_degister</a>(&amp;<a class="code" href="tgt__internal_8h.html#aa001baf045dcb5ffc759648eceddbccb">update_thread_key</a>);
<a name="l01235"></a>01235 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:44 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
