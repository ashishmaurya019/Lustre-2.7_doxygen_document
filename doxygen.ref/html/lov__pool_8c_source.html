<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/lov/lov_pool.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/lov/lov_pool.c</h1><a href="lov__pool_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see [sun.com URL with a</span>
<a name="l00018"></a>00018 <span class="comment"> * copy of GPLv2].</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2012, 2014, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * lustre/lov/lov_pool.c</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * OST pool methods</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Author: Jacques-Charles LAFOUCRIERE &lt;jc.lafoucriere@cea.fr&gt;</span>
<a name="l00041"></a>00041 <span class="comment"> * Author: Alex Lyashkov &lt;Alexey.Lyashkov@Sun.COM&gt;</span>
<a name="l00042"></a>00042 <span class="comment"> * Author: Nathaniel Rutman &lt;Nathan.Rutman@Sun.COM&gt;</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="lov__pool_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00045</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_LOV</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="libcfs_8h.html">libcfs/libcfs.h</a>&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="obd_8h.html">obd.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="lov__internal_8h.html">lov_internal.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="lov__pool_8c.html#ac611d04d8b780ca53d1e4384a199411f">00052</a> <span class="preprocessor">#define pool_tgt(_p, _i) \</span>
<a name="l00053"></a>00053 <span class="preprocessor">                _p-&gt;pool_lobd-&gt;u.lov.lov_tgts[_p-&gt;pool_obds.op_array[_i]]</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">00055</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">lov_pool_getref</a>(<span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a> *pool)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;pool %p\n&quot;</span>, pool);
<a name="l00058"></a>00058         atomic_inc(&amp;pool-&gt;<a class="code" href="structpool__desc.html#aebad5e146f57d634849727cb60356c8d">pool_refcount</a>);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">00061</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(<span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a> *pool)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;pool %p\n&quot;</span>, pool);
<a name="l00064"></a>00064         <span class="keywordflow">if</span> (atomic_dec_and_test(&amp;pool-&gt;<a class="code" href="structpool__desc.html#aebad5e146f57d634849727cb60356c8d">pool_refcount</a>)) {
<a name="l00065"></a>00065                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="group__hlist.html#ga7f946d296ab41ce808e96d529a4106d6">hlist_unhashed</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>));
<a name="l00066"></a>00066                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a9c9f29848054f3cdf2a2cdc74561da3d">pool_list</a>));
<a name="l00067"></a>00067                 <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a> == NULL);
<a name="l00068"></a>00068                 <a class="code" href="lov__internal_8h.html#ae4f9386136340d4af3b52c72bf24e7ea">lov_ost_pool_free</a>(&amp;(pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>));
<a name="l00069"></a>00069                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(pool);
<a name="l00070"></a>00070                 <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="lov__pool_8c.html#a3debde11fd6d355e03a1a13c1fedc10e">00074</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lov__pool_8c.html#a3debde11fd6d355e03a1a13c1fedc10e">lov_pool_putref_locked</a>(<span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a> *pool)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;pool %p\n&quot;</span>, pool);
<a name="l00077"></a>00077         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(atomic_read(&amp;pool-&gt;<a class="code" href="structpool__desc.html#aebad5e146f57d634849727cb60356c8d">pool_refcount</a>) &gt; 1);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         atomic_dec(&amp;pool-&gt;<a class="code" href="structpool__desc.html#aebad5e146f57d634849727cb60356c8d">pool_refcount</a>);
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">/*</span>
<a name="l00083"></a>00083 <span class="comment"> * hash function using a Rotating Hash algorithm</span>
<a name="l00084"></a>00084 <span class="comment"> * Knuth, D. The Art of Computer Programming,</span>
<a name="l00085"></a>00085 <span class="comment"> * Volume 3: Sorting and Searching,</span>
<a name="l00086"></a>00086 <span class="comment"> * Chapter 6.4.</span>
<a name="l00087"></a>00087 <span class="comment"> * Addison Wesley, 1973</span>
<a name="l00088"></a>00088 <span class="comment"> */</span>
<a name="l00089"></a><a class="code" href="lov__pool_8c.html#a9bf5114e691ab53f89240552e2b92698">00089</a> <span class="keyword">static</span> __u32 <a class="code" href="lov__pool_8c.html#a9bf5114e691ab53f89240552e2b92698">pool_hashfn</a>(<span class="keyword">struct</span> <a class="code" href="structcfs__hash.html" title="cfs_hash is a hash-table implementation for general purpose, it can support: .">cfs_hash</a> *hash_body, <span class="keyword">const</span> <span class="keywordtype">void</span> *key,
<a name="l00090"></a>00090                          <span class="keywordtype">unsigned</span> mask)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092         <span class="keywordtype">int</span> i;
<a name="l00093"></a>00093         __u32 result;
<a name="l00094"></a>00094         <span class="keywordtype">char</span> *<a class="code" href="llapi__layout__test_8c.html#a9d096844ad7d6672fe415306cd352062">poolname</a>;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         result = 0;
<a name="l00097"></a>00097         poolname = (<span class="keywordtype">char</span> *)key;
<a name="l00098"></a>00098         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__lustreuser.html#gaff040b96729bd1570b96fa43d7b40f35">LOV_MAXPOOLNAME</a>; i++) {
<a name="l00099"></a>00099                 <span class="keywordflow">if</span> (poolname[i] == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l00100"></a>00100                         <span class="keywordflow">break</span>;
<a name="l00101"></a>00101                 result = (result &lt;&lt; 4)^(result &gt;&gt; 28) ^  poolname[i];
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103         <span class="keywordflow">return</span> (result % mask);
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="lov__pool_8c.html#a1ea2d56eab78b9a73e98c0c33b4c4db0">00106</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="lov__pool_8c.html#a1ea2d56eab78b9a73e98c0c33b4c4db0">pool_key</a>(<span class="keyword">struct</span> <a class="code" href="structhlist__node.html">hlist_node</a> *hnode)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         pool = <a class="code" href="group__hlist.html#gae6c5fc3a7207aad6b8ea756eaa8bb043">hlist_entry</a>(hnode, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a>, <a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00111"></a>00111         <span class="keywordflow">return</span> (pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>);
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00115"></a><a class="code" href="lov__pool_8c.html#ae9c440052cba8363e80934414c404829">00115</a> <a class="code" href="lov__pool_8c.html#ae9c440052cba8363e80934414c404829">pool_hashkey_keycmp</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *key, <span class="keyword">struct</span> <a class="code" href="structhlist__node.html">hlist_node</a> *compared_hnode)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117         <span class="keywordtype">char</span> *<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>;
<a name="l00118"></a>00118         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         pool_name = (<span class="keywordtype">char</span> *)key;
<a name="l00121"></a>00121         pool = <a class="code" href="group__hlist.html#gae6c5fc3a7207aad6b8ea756eaa8bb043">hlist_entry</a>(compared_hnode, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a>, <a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00122"></a>00122         <span class="keywordflow">return</span> !strncmp(pool_name, pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>, <a class="code" href="group__lustreuser.html#gaff040b96729bd1570b96fa43d7b40f35">LOV_MAXPOOLNAME</a>);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="lov__pool_8c.html#a8761a765d566cfb21ca464450267070e">00125</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="lov__pool_8c.html#a8761a765d566cfb21ca464450267070e">pool_hashobject</a>(<span class="keyword">struct</span> <a class="code" href="structhlist__node.html">hlist_node</a> *hnode)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127         <span class="keywordflow">return</span> <a class="code" href="group__hlist.html#gae6c5fc3a7207aad6b8ea756eaa8bb043">hlist_entry</a>(hnode, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a>, <a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="lov__pool_8c.html#a2d15e2b4d125ff7f7b29bb40a019a134">00130</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lov__pool_8c.html#a2d15e2b4d125ff7f7b29bb40a019a134">pool_hashrefcount_get</a>(<span class="keyword">struct</span> <a class="code" href="structcfs__hash.html" title="cfs_hash is a hash-table implementation for general purpose, it can support: .">cfs_hash</a> *hs, <span class="keyword">struct</span> <a class="code" href="structhlist__node.html">hlist_node</a> *hnode)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         pool = <a class="code" href="group__hlist.html#gae6c5fc3a7207aad6b8ea756eaa8bb043">hlist_entry</a>(hnode, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a>, <a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00135"></a>00135         <a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">lov_pool_getref</a>(pool);
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="lov__pool_8c.html#a36613f3ccaf392cfa511bae9a8fafac6">00138</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lov__pool_8c.html#a36613f3ccaf392cfa511bae9a8fafac6">pool_hashrefcount_put_locked</a>(<span class="keyword">struct</span> <a class="code" href="structcfs__hash.html" title="cfs_hash is a hash-table implementation for general purpose, it can support: .">cfs_hash</a> *hs,
<a name="l00139"></a>00139                                          <span class="keyword">struct</span> <a class="code" href="structhlist__node.html">hlist_node</a> *hnode)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         pool = <a class="code" href="group__hlist.html#gae6c5fc3a7207aad6b8ea756eaa8bb043">hlist_entry</a>(hnode, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a>, <a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00144"></a>00144         <a class="code" href="lov__pool_8c.html#a3debde11fd6d355e03a1a13c1fedc10e">lov_pool_putref_locked</a>(pool);
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="lov__pool_8c.html#a482f6f8430424db32b75a1344cb3eaea">00147</a> <span class="keyword">struct </span><a class="code" href="structcfs__hash__ops.html">cfs_hash_ops</a> <a class="code" href="lod__internal_8h.html#a482f6f8430424db32b75a1344cb3eaea">pool_hash_operations</a> = {
<a name="l00148"></a>00148         .<a class="code" href="structcfs__hash__ops.html#a648437e728a587206b341e66ea8f6c32" title="return hashed value from ">hs_hash</a>        = <a class="code" href="lov__pool_8c.html#a9bf5114e691ab53f89240552e2b92698">pool_hashfn</a>,
<a name="l00149"></a>00149         .hs_key         = <a class="code" href="lov__pool_8c.html#a1ea2d56eab78b9a73e98c0c33b4c4db0">pool_key</a>,
<a name="l00150"></a>00150         .hs_keycmp      = <a class="code" href="lov__pool_8c.html#ae9c440052cba8363e80934414c404829">pool_hashkey_keycmp</a>,
<a name="l00151"></a>00151         .hs_object      = <a class="code" href="lov__pool_8c.html#a8761a765d566cfb21ca464450267070e">pool_hashobject</a>,
<a name="l00152"></a>00152         .hs_get         = <a class="code" href="lov__pool_8c.html#a2d15e2b4d125ff7f7b29bb40a019a134">pool_hashrefcount_get</a>,
<a name="l00153"></a>00153         .hs_put_locked  = <a class="code" href="lov__pool_8c.html#a36613f3ccaf392cfa511bae9a8fafac6">pool_hashrefcount_put_locked</a>,
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 };
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="preprocessor">#ifdef CONFIG_PROC_FS</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span><span class="comment">/* ifdef needed for liblustre support */</span>
<a name="l00159"></a>00159 <span class="comment">/*</span>
<a name="l00160"></a>00160 <span class="comment"> * pool /proc seq_file methods</span>
<a name="l00161"></a>00161 <span class="comment"> */</span>
<a name="l00162"></a>00162 <span class="comment">/*</span>
<a name="l00163"></a>00163 <span class="comment"> * iterator is used to go through the target pool entries</span>
<a name="l00164"></a>00164 <span class="comment"> * index is the current entry index in the lp_array[] array</span>
<a name="l00165"></a>00165 <span class="comment"> * index &gt;= pos returned to the seq_file interface</span>
<a name="l00166"></a>00166 <span class="comment"> * pos is from 0 to (pool-&gt;pool_obds.op_count - 1)</span>
<a name="l00167"></a>00167 <span class="comment"> */</span>
<a name="l00168"></a>00168 <span class="preprocessor">#define POOL_IT_MAGIC 0xB001CEA0</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="keyword">struct </span>pool_iterator {
<a name="l00170"></a>00170         <span class="keywordtype">int</span> magic;
<a name="l00171"></a>00171         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00172"></a>00172         <span class="keywordtype">int</span> idx;        <span class="comment">/* from 0 to pool_tgt_size - 1 */</span>
<a name="l00173"></a>00173 };
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="lod__pool_8c.html#a48aba6b5fd7228b3b0607fbbb186d714" title="Return the next configured target within one pool for seq_file iteration.">pool_proc_next</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v, loff_t *pos)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177         <span class="keyword">struct </span>pool_iterator *iter = (<span class="keyword">struct </span>pool_iterator *)s-&gt;private;
<a name="l00178"></a>00178         <span class="keywordtype">int</span> prev_idx;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(iter-&gt;magic == <a class="code" href="lod__pool_8c.html#a74776e86adbb0e52a86e0df5d13ea7e6">POOL_IT_MAGIC</a>, <span class="stringliteral">&quot;%08X\n&quot;</span>, iter-&gt;magic);
<a name="l00181"></a>00181 
<a name="l00182"></a>00182         <span class="comment">/* test if end of file */</span>
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (*pos &gt;= <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(iter-&gt;pool))
<a name="l00184"></a>00184                 <span class="keywordflow">return</span> NULL;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         <span class="comment">/* iterate to find a non empty entry */</span>
<a name="l00187"></a>00187         prev_idx = iter-&gt;idx;
<a name="l00188"></a>00188         down_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(iter-&gt;pool));
<a name="l00189"></a>00189         iter-&gt;idx++;
<a name="l00190"></a>00190         <span class="keywordflow">if</span> (iter-&gt;idx == <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(iter-&gt;pool)) {
<a name="l00191"></a>00191                 iter-&gt;idx = prev_idx; <span class="comment">/* we stay on the last entry */</span>
<a name="l00192"></a>00192                 up_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(iter-&gt;pool));
<a name="l00193"></a>00193                 <span class="keywordflow">return</span> NULL;
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         up_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(iter-&gt;pool));
<a name="l00196"></a>00196         (*pos)++;
<a name="l00197"></a>00197         <span class="comment">/* return != NULL to continue */</span>
<a name="l00198"></a>00198         <span class="keywordflow">return</span> iter;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="lod__pool_8c.html#a536e66dda7929b5cbb40c9b9a8fecfc6" title="Start seq_file iteration via /proc for a single pool.">pool_proc_start</a>(<span class="keyword">struct</span> seq_file *s, loff_t *pos)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool = (<span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *)s-&gt;private;
<a name="l00204"></a>00204         <span class="keyword">struct</span> pool_iterator *iter;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">lov_pool_getref</a>(pool);
<a name="l00207"></a>00207         <span class="keywordflow">if</span> ((<a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(pool) == 0) ||
<a name="l00208"></a>00208             (*pos &gt;= <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(pool))) {
<a name="l00209"></a>00209                 <span class="comment">/* iter is not created, so stop() has no way to</span>
<a name="l00210"></a>00210 <span class="comment">                 * find pool to dec ref */</span>
<a name="l00211"></a>00211                 <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00212"></a>00212                 <span class="keywordflow">return</span> NULL;
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(iter);
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (!iter)
<a name="l00217"></a>00217                 <span class="keywordflow">return</span> ERR_PTR(-ENOMEM);
<a name="l00218"></a>00218         iter-&gt;magic = <a class="code" href="lod__pool_8c.html#a74776e86adbb0e52a86e0df5d13ea7e6">POOL_IT_MAGIC</a>;
<a name="l00219"></a>00219         iter-&gt;pool = pool;
<a name="l00220"></a>00220         iter-&gt;idx = 0;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         <span class="comment">/* we use seq_file private field to memorized iterator so</span>
<a name="l00223"></a>00223 <span class="comment">         * we can free it at stop() */</span>
<a name="l00224"></a>00224         <span class="comment">/* /!\ do not forget to restore it to pool before freeing it */</span>
<a name="l00225"></a>00225         s-&gt;private = iter;
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (*pos &gt; 0) {
<a name="l00227"></a>00227                 loff_t i;
<a name="l00228"></a>00228                 <span class="keywordtype">void</span> *ptr;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230                 i = 0;
<a name="l00231"></a>00231                 <span class="keywordflow">do</span> {
<a name="l00232"></a>00232                      ptr = <a class="code" href="lod__pool_8c.html#a48aba6b5fd7228b3b0607fbbb186d714" title="Return the next configured target within one pool for seq_file iteration.">pool_proc_next</a>(s, &amp;iter, &amp;i);
<a name="l00233"></a>00233                 } <span class="keywordflow">while</span> ((i &lt; *pos) &amp;&amp; (ptr != NULL));
<a name="l00234"></a>00234                 <span class="keywordflow">return</span> ptr;
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236         <span class="keywordflow">return</span> iter;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lod__pool_8c.html#aa0de3f05bf6cf48061b4189f793c014a" title="Finish seq_file iteration for a single pool.">pool_proc_stop</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241         <span class="keyword">struct </span>pool_iterator *iter = (<span class="keyword">struct </span>pool_iterator *)s-&gt;private;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         <span class="comment">/* in some cases stop() method is called 2 times, without</span>
<a name="l00244"></a>00244 <span class="comment">         * calling start() method (see seq_read() from fs/seq_file.c)</span>
<a name="l00245"></a>00245 <span class="comment">         * we have to free only if s-&gt;private is an iterator */</span>
<a name="l00246"></a>00246         if ((iter) &amp;&amp; (iter-&gt;magic == <a class="code" href="lod__pool_8c.html#a74776e86adbb0e52a86e0df5d13ea7e6">POOL_IT_MAGIC</a>)) {
<a name="l00247"></a>00247                 <span class="comment">/* we restore s-&gt;private so next call to pool_proc_start()</span>
<a name="l00248"></a>00248 <span class="comment">                 * will work */</span>
<a name="l00249"></a>00249                 s-&gt;private = iter-&gt;pool;
<a name="l00250"></a>00250                 <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(iter-&gt;pool);
<a name="l00251"></a>00251                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(iter);
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         <span class="keywordflow">return</span>;
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lod__pool_8c.html#a6d3e838bad8804086770637dc06c0353" title="Print out one target entry from the pool for seq_file iteration.">pool_proc_show</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258         <span class="keyword">struct </span>pool_iterator *iter = (<span class="keyword">struct </span>pool_iterator *)v;
<a name="l00259"></a>00259         <span class="keyword">struct </span><a class="code" href="structlov__tgt__desc.html">lov_tgt_desc</a> *tgt;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <a class="code" href="utils_2wirehdr_8c.html#a2e063b87e63a187e8b2302ef6628b842">LASSERTF</a>(iter-&gt;magic == <a class="code" href="lod__pool_8c.html#a74776e86adbb0e52a86e0df5d13ea7e6">POOL_IT_MAGIC</a>, <span class="stringliteral">&quot;%08X\n&quot;</span>, iter-&gt;magic);
<a name="l00262"></a>00262         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(iter-&gt;pool != NULL);
<a name="l00263"></a>00263         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(iter-&gt;idx &lt;= <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(iter-&gt;pool));
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         down_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(iter-&gt;pool));
<a name="l00266"></a>00266         tgt = <a class="code" href="lod__pool_8c.html#ac611d04d8b780ca53d1e4384a199411f">pool_tgt</a>(iter-&gt;pool, iter-&gt;idx);
<a name="l00267"></a>00267         up_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(iter-&gt;pool));
<a name="l00268"></a>00268         <span class="keywordflow">if</span> (tgt)
<a name="l00269"></a>00269                 seq_printf(s, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;(tgt-&gt;<a class="code" href="structlov__tgt__desc.html#a020a8b90ccc6f0faa5ad35873f3634c1">ltd_uuid</a>)));
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="keywordflow">return</span> 0;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="keyword">static</span> <span class="keyword">struct </span>seq_operations <a class="code" href="lod__pool_8c.html#a78164d0ba4682a7f995a63e2f3641134">pool_proc_ops</a> = {
<a name="l00275"></a>00275         .start          = <a class="code" href="lod__pool_8c.html#a536e66dda7929b5cbb40c9b9a8fecfc6" title="Start seq_file iteration via /proc for a single pool.">pool_proc_start</a>,
<a name="l00276"></a>00276         .next           = <a class="code" href="lod__pool_8c.html#a48aba6b5fd7228b3b0607fbbb186d714" title="Return the next configured target within one pool for seq_file iteration.">pool_proc_next</a>,
<a name="l00277"></a>00277         .stop           = <a class="code" href="lod__pool_8c.html#aa0de3f05bf6cf48061b4189f793c014a" title="Finish seq_file iteration for a single pool.">pool_proc_stop</a>,
<a name="l00278"></a>00278         .show           = <a class="code" href="lod__pool_8c.html#a6d3e838bad8804086770637dc06c0353" title="Print out one target entry from the pool for seq_file iteration.">pool_proc_show</a>,
<a name="l00279"></a>00279 };
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lod__pool_8c.html#a2e4e7acd4df0efd345b41293bf44f673" title="Open a new /proc file for seq_file iteration of targets in one pool.">pool_proc_open</a>(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283         <span class="keywordtype">int</span> rc;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         rc = seq_open(file, &amp;pool_proc_ops);
<a name="l00286"></a>00286         <span class="keywordflow">if</span> (!rc) {
<a name="l00287"></a>00287                 <span class="keyword">struct </span>seq_file *s = file-&gt;private_data;
<a name="l00288"></a>00288                 s-&gt;private = PDE_DATA(inode);
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290         <span class="keywordflow">return</span> rc;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="keyword">static</span> <span class="keyword">struct </span>file_operations <a class="code" href="lod__pool_8c.html#a183ceba94cb42c36e82da892a3a26a54">pool_proc_operations</a> = {
<a name="l00294"></a>00294         .open           = <a class="code" href="lod__pool_8c.html#a2e4e7acd4df0efd345b41293bf44f673" title="Open a new /proc file for seq_file iteration of targets in one pool.">pool_proc_open</a>,
<a name="l00295"></a>00295         .read           = seq_read,
<a name="l00296"></a>00296         .llseek         = seq_lseek,
<a name="l00297"></a>00297         .release        = seq_release,
<a name="l00298"></a>00298 };
<a name="l00299"></a>00299 <span class="preprocessor">#endif </span><span class="comment">/* CONFIG_PROC_FS */</span>
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="lov__pool_8c.html#aef7fb022877489a35faac5de1e7c2ada">00301</a> <span class="keywordtype">void</span> <a class="code" href="lov__internal_8h.html#aef7fb022877489a35faac5de1e7c2ada">lov_dump_pool</a>(<span class="keywordtype">int</span> level, <span class="keyword">struct</span> <a class="code" href="structpool__desc.html">pool_desc</a> *pool)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303         <span class="keywordtype">int</span> i;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">lov_pool_getref</a>(pool);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(level, <span class="stringliteral">&quot;pool &quot;</span><a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot; has %d members\n&quot;</span>,
<a name="l00308"></a>00308                pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>, pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>.<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>);
<a name="l00309"></a>00309         down_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(pool));
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(pool) ; i++) {
<a name="l00312"></a>00312                 <span class="keywordflow">if</span> (!<a class="code" href="lod__pool_8c.html#ac611d04d8b780ca53d1e4384a199411f">pool_tgt</a>(pool, i) || !(<a class="code" href="lod__pool_8c.html#ac611d04d8b780ca53d1e4384a199411f">pool_tgt</a>(pool, i))-&gt;ltd_exp)
<a name="l00313"></a>00313                         <span class="keywordflow">continue</span>;
<a name="l00314"></a>00314                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(level, <span class="stringliteral">&quot;pool &quot;</span><a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot;[%d] = %s\n&quot;</span>,
<a name="l00315"></a>00315                        pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>, i,
<a name="l00316"></a>00316                        <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;((<a class="code" href="lod__pool_8c.html#ac611d04d8b780ca53d1e4384a199411f">pool_tgt</a>(pool, i))-&gt;ltd_uuid)));
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         up_read(&amp;<a class="code" href="lod__internal_8h.html#a1a950bea7090a45731d9cef2e9a4d90c">pool_tgt_rw_sem</a>(pool));
<a name="l00320"></a>00320         <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a><a class="code" href="lov__pool_8c.html#a0a88d9190d19ff80181c5c5745054a51">00323</a> <span class="preprocessor">#define LOV_POOL_INIT_COUNT 2</span>
<a name="l00324"></a><a class="code" href="lov__pool_8c.html#a4604cb83f00be3bc6e749f08b2eb4b35">00324</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#a4604cb83f00be3bc6e749f08b2eb4b35">lov_ost_pool_init</a>(<span class="keyword">struct</span> <a class="code" href="structost__pool.html">ost_pool</a> *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (count == 0)
<a name="l00329"></a>00329                 count = <a class="code" href="lov__pool_8c.html#a0a88d9190d19ff80181c5c5745054a51">LOV_POOL_INIT_COUNT</a>;
<a name="l00330"></a>00330         op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a> = NULL;
<a name="l00331"></a>00331         op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a> = 0;
<a name="l00332"></a>00332         init_rwsem(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00333"></a>00333         op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> = count;
<a name="l00334"></a>00334         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>, op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a> == NULL) {
<a name="l00336"></a>00336                 op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> = 0;
<a name="l00337"></a>00337                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00340"></a>00340         <span class="keywordflow">return</span> 0;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="comment">/* Caller must hold write op_rwlock */</span>
<a name="l00344"></a><a class="code" href="lov__pool_8c.html#a7eaa731697d01fd6ee010ec50980ad0f">00344</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#a7eaa731697d01fd6ee010ec50980ad0f">lov_ost_pool_extend</a>(<span class="keyword">struct</span> <a class="code" href="structost__pool.html">ost_pool</a> *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_count)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346         __u32 *<span class="keyword">new</span>;
<a name="l00347"></a>00347         <span class="keywordtype">int</span> new_size;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(min_count != 0);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a> &lt; op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a>)
<a name="l00352"></a>00352                 <span class="keywordflow">return</span> 0;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         new_size = <a class="code" href="lnet_2utils_2debug_8c.html#ae1e1dde676c120fa6d10f3bb2c14059e">max</a>(min_count, 2 * op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a>);
<a name="l00355"></a>00355         <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(<span class="keyword">new</span>, new_size * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (<span class="keyword">new</span> == NULL)
<a name="l00357"></a>00357                 <span class="keywordflow">return</span> -ENOMEM;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="comment">/* copy old array to new one */</span>
<a name="l00360"></a>00360         memcpy(<span class="keyword">new</span>, op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>, op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00361"></a>00361         <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>, op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00362"></a>00362         op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a> = <span class="keyword">new</span>;
<a name="l00363"></a>00363         op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> = new_size;
<a name="l00364"></a>00364         <span class="keywordflow">return</span> 0;
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a><a class="code" href="lov__pool_8c.html#a5cb4f0153231802f4156a6d81d2905d1">00367</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#a5cb4f0153231802f4156a6d81d2905d1">lov_ost_pool_add</a>(<span class="keyword">struct</span> <a class="code" href="structost__pool.html">ost_pool</a> *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>, __u32 idx, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_count)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369         <span class="keywordtype">int</span> rc = 0, i;
<a name="l00370"></a>00370         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         down_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         rc = <a class="code" href="lov__internal_8h.html#a7eaa731697d01fd6ee010ec50980ad0f">lov_ost_pool_extend</a>(op, min_count);
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (rc)
<a name="l00376"></a>00376                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="comment">/* search ost in pool array */</span>
<a name="l00379"></a>00379         <span class="keywordflow">for</span> (i = 0; i &lt; op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>; i++) {
<a name="l00380"></a>00380                 <span class="keywordflow">if</span> (op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[i] == idx)
<a name="l00381"></a>00381                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EEXIST);
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         <span class="comment">/* ost not found we add it */</span>
<a name="l00384"></a>00384         op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>] = idx;
<a name="l00385"></a>00385         op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>++;
<a name="l00386"></a>00386         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00387"></a>00387 out:
<a name="l00388"></a>00388         up_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00389"></a>00389         <span class="keywordflow">return</span> rc;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a><a class="code" href="lov__pool_8c.html#a93b0242b5ae8e3ff311ad94e218c74a9">00392</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#a93b0242b5ae8e3ff311ad94e218c74a9">lov_ost_pool_remove</a>(<span class="keyword">struct</span> <a class="code" href="structost__pool.html">ost_pool</a> *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>, __u32 idx)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394         <span class="keywordtype">int</span> i;
<a name="l00395"></a>00395         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         down_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="keywordflow">for</span> (i = 0; i &lt; op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>; i++) {
<a name="l00400"></a>00400                 <span class="keywordflow">if</span> (op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[i] == idx) {
<a name="l00401"></a>00401                         memmove(&amp;op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[i], &amp;op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[i + 1],
<a name="l00402"></a>00402                                 (op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a> - i - 1) * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00403"></a>00403                         op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a>--;
<a name="l00404"></a>00404                         up_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00405"></a>00405                         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00406"></a>00406                         <span class="keywordflow">return</span> 0;
<a name="l00407"></a>00407                 }
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         up_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00411"></a>00411         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-EINVAL);
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="lov__pool_8c.html#ae4f9386136340d4af3b52c72bf24e7ea">00414</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#ae4f9386136340d4af3b52c72bf24e7ea">lov_ost_pool_free</a>(<span class="keyword">struct</span> <a class="code" href="structost__pool.html">ost_pool</a> *<a class="code" href="iam__ut_8c.html#a99a30df0f2488360cdd46b4b88e5f5f0">op</a>)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> == 0)
<a name="l00419"></a>00419                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         down_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>, op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> * <span class="keyword">sizeof</span>(op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a>[0]));
<a name="l00424"></a>00424         op-&gt;<a class="code" href="structost__pool.html#aa34253b9b1bf5f8ffc3b00aafcd490d1">op_array</a> = NULL;
<a name="l00425"></a>00425         op-&gt;<a class="code" href="structost__pool.html#a642dbef96d4109035969f8fe6bf81a35">op_count</a> = 0;
<a name="l00426"></a>00426         op-&gt;<a class="code" href="structost__pool.html#af519518b3702868b1745d18f6c09e883">op_size</a> = 0;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         up_write(&amp;op-&gt;<a class="code" href="structost__pool.html#aa9670591e6b9b67187fbf8cc4ddc778b">op_rw_sem</a>);
<a name="l00429"></a>00429         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 
<a name="l00433"></a><a class="code" href="lov__pool_8c.html#ac81997d28bd015b7520206f3ddb17949">00433</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#ac81997d28bd015b7520206f3ddb17949">lov_pool_new</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keywordtype">char</span> *<a class="code" href="llapi__layout__test_8c.html#a9d096844ad7d6672fe415306cd352062">poolname</a>)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435         <span class="keyword">struct </span><a class="code" href="structlov__obd.html">lov_obd</a> *lov;
<a name="l00436"></a>00436         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *new_pool;
<a name="l00437"></a>00437         <span class="keywordtype">int</span> rc;
<a name="l00438"></a>00438         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         lov = &amp;(obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#a855c7bb370bc328f8ffde620f5618801">lov</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (strlen(poolname) &gt; <a class="code" href="group__lustreuser.html#gaff040b96729bd1570b96fa43d7b40f35">LOV_MAXPOOLNAME</a>)
<a name="l00443"></a>00443                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENAMETOOLONG);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(new_pool);
<a name="l00446"></a>00446         <span class="keywordflow">if</span> (new_pool == NULL)
<a name="l00447"></a>00447                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <a class="code" href="string_8h.html#a5b488cc7021bbdd3ed565cb03b1ee6d2">strlcpy</a>(new_pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>, poolname, <span class="keyword">sizeof</span>(new_pool-&gt;<a class="code" href="structpool__desc.html#a76d8b7de9d9b2258a4de8718761d92d8">pool_name</a>));
<a name="l00450"></a>00450         new_pool-&gt;<a class="code" href="structpool__desc.html#a37a28ec38a85c63de62d5f1056a01e95">pool_lobd</a> = obd;
<a name="l00451"></a>00451         <span class="comment">/* ref count init to 1 because when created a pool is always used</span>
<a name="l00452"></a>00452 <span class="comment">         * up to deletion</span>
<a name="l00453"></a>00453 <span class="comment">         */</span>
<a name="l00454"></a>00454         atomic_set(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#aebad5e146f57d634849727cb60356c8d">pool_refcount</a>, 1);
<a name="l00455"></a>00455         rc = <a class="code" href="lov__internal_8h.html#a4604cb83f00be3bc6e749f08b2eb4b35">lov_ost_pool_init</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>, 0);
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (rc)
<a name="l00457"></a>00457                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_err, rc);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <a class="code" href="group__hlist.html#ga9d36ad2cdc5a41b254c71b707760bcce">INIT_HLIST_NODE</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="preprocessor">#ifdef CONFIG_PROC_FS</span>
<a name="l00462"></a>00462 <span class="preprocessor"></span>        <span class="comment">/* get ref for /proc file */</span>
<a name="l00463"></a>00463         <a class="code" href="lov__pool_8c.html#afcf4a51670036b406e0311ef3ab86efb">lov_pool_getref</a>(new_pool);
<a name="l00464"></a>00464         new_pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a> = <a class="code" href="lprocfs__status_8h.html#a83a9a2ebd19213ed17f3febbafcddb44">lprocfs_add_simple</a>(lov-&gt;<a class="code" href="structlov__obd.html#a7c6989b57efd123b1c9aeba4bf77d042">lov_pool_proc_entry</a>,
<a name="l00465"></a>00465                                                        poolname, new_pool,
<a name="l00466"></a>00466                                                        &amp;pool_proc_operations);
<a name="l00467"></a>00467         <span class="keywordflow">if</span> (IS_ERR(new_pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a>)) {
<a name="l00468"></a>00468                 <a class="code" href="libcfs__debug_8h.html#af03883cada59830b0488595cf5d571a0">CWARN</a>(<span class="stringliteral">&quot;Cannot add proc pool entry &quot;</span><a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot;\n&quot;</span>, poolname);
<a name="l00469"></a>00469                 new_pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a> = NULL;
<a name="l00470"></a>00470                 <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(new_pool);
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;pool %p - proc %p\n&quot;</span>,
<a name="l00473"></a>00473                new_pool, new_pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a>);
<a name="l00474"></a>00474 <span class="preprocessor">#endif</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>
<a name="l00476"></a>00476         spin_lock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00477"></a>00477         <a class="code" href="list_8h.html#a588bec046f1e9797b33a5c5ab250f447" title="Insert an entry at the end of a list.">list_add_tail</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a9c9f29848054f3cdf2a2cdc74561da3d">pool_list</a>, &amp;lov-&gt;<a class="code" href="structlov__obd.html#a8ccdcdac03003fa110ac2a0f7bca9d2b">lov_pool_list</a>);
<a name="l00478"></a>00478         lov-&gt;<a class="code" href="structlov__obd.html#a94fe6c01f54a859dd1cde184d17842a0">lov_pool_count</a>++;
<a name="l00479"></a>00479         spin_unlock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="comment">/* add to find only when it fully ready  */</span>
<a name="l00482"></a>00482         rc = <a class="code" href="libcfs__hash_8h.html#a4be9049de769cd2632a3941b4517c26f" title="Add item  to libcfs hash  using .">cfs_hash_add_unique</a>(lov-&gt;<a class="code" href="structlov__obd.html#af00a5b77449cce7e1f9cd314194c14f6">lov_pools_hash_body</a>, poolname,
<a name="l00483"></a>00483                                  &amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a94ed63d73545d7b7d74b1c52f2678a95">pool_hash</a>);
<a name="l00484"></a>00484         <span class="keywordflow">if</span> (rc)
<a name="l00485"></a>00485                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_err, rc = -EEXIST);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot; is pool #%d\n&quot;</span>,
<a name="l00488"></a>00488                poolname, lov-&gt;<a class="code" href="structlov__obd.html#a94fe6c01f54a859dd1cde184d17842a0">lov_pool_count</a>);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 out_err:
<a name="l00493"></a>00493         spin_lock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00494"></a>00494         <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a9c9f29848054f3cdf2a2cdc74561da3d">pool_list</a>);
<a name="l00495"></a>00495         lov-&gt;<a class="code" href="structlov__obd.html#a94fe6c01f54a859dd1cde184d17842a0">lov_pool_count</a>--;
<a name="l00496"></a>00496         spin_unlock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00497"></a>00497         <a class="code" href="lprocfs__status_8h.html#a64457b3c159bcc83be25b73908b966ee">lprocfs_remove</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a>);
<a name="l00498"></a>00498         <a class="code" href="lov__internal_8h.html#ae4f9386136340d4af3b52c72bf24e7ea">lov_ost_pool_free</a>(&amp;new_pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>);
<a name="l00499"></a>00499         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(new_pool);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         <span class="keywordflow">return</span> rc;
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a><a class="code" href="lov__pool_8c.html#a987564df47264c3b98587d8dfd8afdbf">00504</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#a987564df47264c3b98587d8dfd8afdbf">lov_pool_del</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keywordtype">char</span> *<a class="code" href="llapi__layout__test_8c.html#a9d096844ad7d6672fe415306cd352062">poolname</a>)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506         <span class="keyword">struct </span><a class="code" href="structlov__obd.html">lov_obd</a> *lov;
<a name="l00507"></a>00507         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00508"></a>00508         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         lov = &amp;(obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#a855c7bb370bc328f8ffde620f5618801">lov</a>);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <span class="comment">/* lookup and kill hash reference */</span>
<a name="l00513"></a>00513         pool = <a class="code" href="libcfs__hash_8h.html#a076b3fecfda52c19b151c57c16f7414a" title="Delete item given  in libcfs hash .">cfs_hash_del_key</a>(lov-&gt;<a class="code" href="structlov__obd.html#af00a5b77449cce7e1f9cd314194c14f6">lov_pools_hash_body</a>, poolname);
<a name="l00514"></a>00514         <span class="keywordflow">if</span> (pool == NULL)
<a name="l00515"></a>00515                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOENT);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a> != NULL) {
<a name="l00518"></a>00518                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a61818a4c2cf85e96d77e6e46ca4ea853">D_INFO</a>, <span class="stringliteral">&quot;proc entry %p\n&quot;</span>, pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a>);
<a name="l00519"></a>00519                 <a class="code" href="lprocfs__status_8h.html#a64457b3c159bcc83be25b73908b966ee">lprocfs_remove</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a1a7e9bb4033caf989f7d244953e6f542">pool_proc_entry</a>);
<a name="l00520"></a>00520                 <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         spin_lock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00524"></a>00524         <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a9c9f29848054f3cdf2a2cdc74561da3d">pool_list</a>);
<a name="l00525"></a>00525         lov-&gt;<a class="code" href="structlov__obd.html#a94fe6c01f54a859dd1cde184d17842a0">lov_pool_count</a>--;
<a name="l00526"></a>00526         spin_unlock(&amp;obd-&gt;<a class="code" href="structobd__device.html#a318ff629a967bb291952c902b3357474">obd_dev_lock</a>);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="comment">/* release last reference */</span>
<a name="l00529"></a>00529         <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="lov__pool_8c.html#afa1867437d6e3ddad410fb9ab93fd248">00535</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#afa1867437d6e3ddad410fb9ab93fd248">lov_pool_add</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keywordtype">char</span> *<a class="code" href="llapi__layout__test_8c.html#a9d096844ad7d6672fe415306cd352062">poolname</a>, <span class="keywordtype">char</span> *ostname)
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a> ost_uuid;
<a name="l00538"></a>00538         <span class="keyword">struct </span><a class="code" href="structlov__obd.html">lov_obd</a> *lov;
<a name="l00539"></a>00539         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00540"></a>00540         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lov_idx;
<a name="l00541"></a>00541         <span class="keywordtype">int</span> rc;
<a name="l00542"></a>00542         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         lov = &amp;(obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#a855c7bb370bc328f8ffde620f5618801">lov</a>);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         pool = <a class="code" href="libcfs__hash_8h.html#a8e2a5b89d520bf4a2d61a615d2b4db59" title="Lookup an item using  in the libcfs hash  and return it.">cfs_hash_lookup</a>(lov-&gt;<a class="code" href="structlov__obd.html#af00a5b77449cce7e1f9cd314194c14f6">lov_pools_hash_body</a>, poolname);
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (pool == NULL)
<a name="l00548"></a>00548                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOENT);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <a class="code" href="group__lustreuser.html#gad22b0e3b947bae0ae7e719c79e6f9100">obd_str2uuid</a>(&amp;ost_uuid, ostname);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <span class="comment">/* search ost in lov array */</span>
<a name="l00554"></a>00554         <a class="code" href="obd__class_8h.html#abb5793f82207c90e20c892bc6321d7b2">obd_getref</a>(obd);
<a name="l00555"></a>00555         <span class="keywordflow">for</span> (lov_idx = 0; lov_idx &lt; lov-&gt;<a class="code" href="structlov__obd.html#ac0068c71ca8df1759c5a9cf0843d4535">desc</a>.<a class="code" href="structlov__desc.html#ae0dab4d70fbf47fb1396118063e29efc">ld_tgt_count</a>; lov_idx++) {
<a name="l00556"></a>00556                 <span class="keywordflow">if</span> (!lov-&gt;<a class="code" href="structlov__obd.html#a3005cc9dd368a7771b7c7cd9d6a50b4e">lov_tgts</a>[lov_idx])
<a name="l00557"></a>00557                         <span class="keywordflow">continue</span>;
<a name="l00558"></a>00558                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;ost_uuid,
<a name="l00559"></a>00559                                     &amp;(lov-&gt;<a class="code" href="structlov__obd.html#a3005cc9dd368a7771b7c7cd9d6a50b4e">lov_tgts</a>[lov_idx]-&gt;<a class="code" href="structlov__tgt__desc.html#a020a8b90ccc6f0faa5ad35873f3634c1">ltd_uuid</a>)))
<a name="l00560"></a>00560                         <span class="keywordflow">break</span>;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562         <span class="comment">/* test if ost found in lov */</span>
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (lov_idx == lov-&gt;<a class="code" href="structlov__obd.html#ac0068c71ca8df1759c5a9cf0843d4535">desc</a>.<a class="code" href="structlov__desc.html#ae0dab4d70fbf47fb1396118063e29efc">ld_tgt_count</a>)
<a name="l00564"></a>00564                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         rc = <a class="code" href="lov__internal_8h.html#a5cb4f0153231802f4156a6d81d2905d1">lov_ost_pool_add</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>, lov_idx, lov-&gt;<a class="code" href="structlov__obd.html#ad769efed8bef10ad81a2fc88d4770f63">lov_tgt_size</a>);
<a name="l00567"></a>00567         <span class="keywordflow">if</span> (rc)
<a name="l00568"></a>00568                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;Added %s to &quot;</span><a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot; as member %d\n&quot;</span>,
<a name="l00571"></a>00571                ostname, poolname,  <a class="code" href="lod__internal_8h.html#ae822a98627ba236ff5909a9f10a60359">pool_tgt_count</a>(pool));
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00574"></a>00574 out:
<a name="l00575"></a>00575         <a class="code" href="obd__class_8h.html#a9633824cf250b61711871e72def8d960">obd_putref</a>(obd);
<a name="l00576"></a>00576         <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00577"></a>00577         <span class="keywordflow">return</span> rc;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a><a class="code" href="lov__pool_8c.html#aed2bd2316b21c5bddf0fcac2212a36a9">00580</a> <span class="keywordtype">int</span> <a class="code" href="lov__internal_8h.html#aed2bd2316b21c5bddf0fcac2212a36a9">lov_pool_remove</a>(<span class="keyword">struct</span> <a class="code" href="structobd__device.html">obd_device</a> *obd, <span class="keywordtype">char</span> *<a class="code" href="llapi__layout__test_8c.html#a9d096844ad7d6672fe415306cd352062">poolname</a>, <span class="keywordtype">char</span> *ostname)
<a name="l00581"></a>00581 {
<a name="l00582"></a>00582         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a> ost_uuid;
<a name="l00583"></a>00583         <span class="keyword">struct </span><a class="code" href="structlov__obd.html">lov_obd</a> *lov;
<a name="l00584"></a>00584         <span class="keyword">struct </span><a class="code" href="structpool__desc.html">pool_desc</a> *pool;
<a name="l00585"></a>00585         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lov_idx;
<a name="l00586"></a>00586         <span class="keywordtype">int</span> rc = 0;
<a name="l00587"></a>00587         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         lov = &amp;(obd-&gt;<a class="code" href="structobd__device.html#aebe227afed9945c803b5bda6794bb729">u</a>.<a class="code" href="structobd__device.html#a855c7bb370bc328f8ffde620f5618801">lov</a>);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         pool = <a class="code" href="libcfs__hash_8h.html#a8e2a5b89d520bf4a2d61a615d2b4db59" title="Lookup an item using  in the libcfs hash  and return it.">cfs_hash_lookup</a>(lov-&gt;<a class="code" href="structlov__obd.html#af00a5b77449cce7e1f9cd314194c14f6">lov_pools_hash_body</a>, poolname);
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (pool == NULL)
<a name="l00593"></a>00593                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOENT);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         <a class="code" href="group__lustreuser.html#gad22b0e3b947bae0ae7e719c79e6f9100">obd_str2uuid</a>(&amp;ost_uuid, ostname);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <a class="code" href="obd__class_8h.html#abb5793f82207c90e20c892bc6321d7b2">obd_getref</a>(obd);
<a name="l00598"></a>00598         <span class="comment">/* search ost in lov array, to get index */</span>
<a name="l00599"></a>00599         <span class="keywordflow">for</span> (lov_idx = 0; lov_idx &lt; lov-&gt;<a class="code" href="structlov__obd.html#ac0068c71ca8df1759c5a9cf0843d4535">desc</a>.<a class="code" href="structlov__desc.html#ae0dab4d70fbf47fb1396118063e29efc">ld_tgt_count</a>; lov_idx++) {
<a name="l00600"></a>00600                 <span class="keywordflow">if</span> (!lov-&gt;<a class="code" href="structlov__obd.html#a3005cc9dd368a7771b7c7cd9d6a50b4e">lov_tgts</a>[lov_idx])
<a name="l00601"></a>00601                         <span class="keywordflow">continue</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;ost_uuid,
<a name="l00604"></a>00604                                     &amp;(lov-&gt;<a class="code" href="structlov__obd.html#a3005cc9dd368a7771b7c7cd9d6a50b4e">lov_tgts</a>[lov_idx]-&gt;<a class="code" href="structlov__tgt__desc.html#a020a8b90ccc6f0faa5ad35873f3634c1">ltd_uuid</a>)))
<a name="l00605"></a>00605                         <span class="keywordflow">break</span>;
<a name="l00606"></a>00606         }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="comment">/* test if ost found in lov */</span>
<a name="l00609"></a>00609         <span class="keywordflow">if</span> (lov_idx == lov-&gt;<a class="code" href="structlov__obd.html#ac0068c71ca8df1759c5a9cf0843d4535">desc</a>.<a class="code" href="structlov__desc.html#ae0dab4d70fbf47fb1396118063e29efc">ld_tgt_count</a>)
<a name="l00610"></a>00610                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -EINVAL);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         <a class="code" href="lov__internal_8h.html#a93b0242b5ae8e3ff311ad94e218c74a9">lov_ost_pool_remove</a>(&amp;pool-&gt;<a class="code" href="structpool__desc.html#a591a5ebd7139be28d74bdfbc9e58c82e">pool_obds</a>, lov_idx);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a1a7ddf300065d1c472a227a658bacc1a">D_CONFIG</a>, <span class="stringliteral">&quot;%s removed from &quot;</span><a class="code" href="group__lustreuser.html#gaff938af4b40f997eaaca2d7f4f5a8a95">LOV_POOLNAMEF</a><span class="stringliteral">&quot;\n&quot;</span>, ostname,
<a name="l00615"></a>00615                poolname);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <a class="code" href="flock_8c.html#ad111e603bbebe5d87f6bc39264ce4733">EXIT</a>;
<a name="l00618"></a>00618 out:
<a name="l00619"></a>00619         <a class="code" href="obd__class_8h.html#a9633824cf250b61711871e72def8d960">obd_putref</a>(obd);
<a name="l00620"></a>00620         <a class="code" href="lov__pool_8c.html#ab95ab7e8d59ec8a0470e2e382ddf0582">lov_pool_putref</a>(pool);
<a name="l00621"></a>00621         <span class="keywordflow">return</span> rc;
<a name="l00622"></a>00622 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:37 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
