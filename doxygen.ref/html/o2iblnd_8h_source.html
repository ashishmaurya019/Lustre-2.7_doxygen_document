<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lnet/klnds/o2iblnd/o2iblnd.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lnet/klnds/o2iblnd/o2iblnd.h</h1><a href="o2iblnd_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.sun.com/software/products/lustre/docs/GPLv2.pdf</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2011, 2015, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * lnet/klnds/o2iblnd/o2iblnd.h</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * Author: Eric Barton &lt;eric@bartonsoftware.com&gt;</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#ifdef HAVE_COMPAT_RDMA</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/compat-2.6.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;linux/kthread.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;linux/mm.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;linux/string.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;linux/stat.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;linux/errno.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;linux/unistd.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;linux/uio.h&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;asm/uaccess.h&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;linux/init.h&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;linux/fs.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;linux/file.h&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;linux/stat.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;linux/list.h&gt;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;linux/kmod.h&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;linux/sysctl.h&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;linux/pci.h&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,6,32)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/pci-dma.h&gt;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#endif</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &lt;net/sock.h&gt;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &lt;linux/in.h&gt;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &lt;rdma/rdma_cm.h&gt;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &lt;rdma/ib_cm.h&gt;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &lt;rdma/ib_verbs.h&gt;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &lt;rdma/ib_fmr_pool.h&gt;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="o2iblnd_8h.html#abda60744d497fcfe370cfd6b2d65c7ed">00079</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_LND</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &lt;<a class="code" href="libcfs_8h.html">libcfs/libcfs.h</a>&gt;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &lt;<a class="code" href="lnet_8h.html">lnet/lnet.h</a>&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;<a class="code" href="lib-lnet_8h.html">lnet/lib-lnet.h</a>&gt;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="o2iblnd_8h.html#a0abcd2c20b01120ed799d0b4fb7bd02a">00085</a> <span class="preprocessor">#define IBLND_PEER_HASH_SIZE            101     </span><span class="comment">/* # peer lists */</span>
<a name="l00086"></a>00086 <span class="comment">/* # scheduler loops before reschedule */</span>
<a name="l00087"></a><a class="code" href="o2iblnd_8h.html#a57b925c5664db292fc3254f470a3698a">00087</a> <span class="preprocessor">#define IBLND_RESCHED                   100</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="o2iblnd_8h.html#ada1d37729a6210fdde9350334aa51872">00089</a> <span class="preprocessor">#define IBLND_N_SCHED                   2</span>
<a name="l00090"></a><a class="code" href="o2iblnd_8h.html#a749b637e8c484cf4c4bcd7836e1fec85">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_N_SCHED_HIGH              4</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="structkib__tunables__t.html">00092</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00093"></a>00093 {
<a name="l00094"></a><a class="code" href="structkib__tunables__t.html#a28c39d00c8f3c0d40b2b2db8a3b23969">00094</a>         <span class="keywordtype">int</span>              *kib_dev_failover;     <span class="comment">/* HCA failover */</span>
<a name="l00095"></a><a class="code" href="structkib__tunables__t.html#a1039232952c99bfffffc12abcd07c20a">00095</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     *kib_service;          <span class="comment">/* IB service number */</span>
<a name="l00096"></a><a class="code" href="structkib__tunables__t.html#a6a1745e79e9698f6e30066fb92ccda1f">00096</a>         <span class="keywordtype">int</span>              *kib_min_reconnect_interval; <span class="comment">/* first failed connection retry... */</span>
<a name="l00097"></a><a class="code" href="structkib__tunables__t.html#a66984ca7ec0d5cafff002cdc73fa109e">00097</a>         <span class="keywordtype">int</span>              *kib_max_reconnect_interval; <span class="comment">/* ...exponentially increasing to this */</span>
<a name="l00098"></a><a class="code" href="structkib__tunables__t.html#ae0ee8c34cf75913ea0d7160feb0d9405">00098</a>         <span class="keywordtype">int</span>              *kib_cksum;            <span class="comment">/* checksum kib_msg_t? */</span>
<a name="l00099"></a><a class="code" href="structkib__tunables__t.html#aa1475f9af7b1821ef9cd061d141e63e5">00099</a>         <span class="keywordtype">int</span>              *kib_timeout;          <span class="comment">/* comms timeout (seconds) */</span>
<a name="l00100"></a><a class="code" href="structkib__tunables__t.html#ace391c9a4d5b90594bb4fba5cf7119ae">00100</a>         <span class="keywordtype">int</span>              *kib_keepalive;        <span class="comment">/* keepalive timeout (seconds) */</span>
<a name="l00101"></a><a class="code" href="structkib__tunables__t.html#a78fff2019e6b36c34623d11f3dc625a9">00101</a>         <span class="keywordtype">int</span>              *kib_ntx;              <span class="comment">/* # tx descs */</span>
<a name="l00102"></a><a class="code" href="structkib__tunables__t.html#aa9a3d0de3e855408daaf8c17821a750e">00102</a>         <span class="keywordtype">char</span>            **kib_default_ipif;     <span class="comment">/* default IPoIB interface */</span>
<a name="l00103"></a><a class="code" href="structkib__tunables__t.html#a904465e88fa7cff9b32005d40d9170ba">00103</a>         <span class="keywordtype">int</span>              *kib_retry_count;
<a name="l00104"></a><a class="code" href="structkib__tunables__t.html#af3d0bc9861d698b041370a0fdc9f49f6">00104</a>         <span class="keywordtype">int</span>              *kib_rnr_retry_count;
<a name="l00105"></a><a class="code" href="structkib__tunables__t.html#aee6ba8531dee4b7a78e71d3cbe706fe9">00105</a>         <span class="keywordtype">int</span>              *kib_ib_mtu;           <span class="comment">/* IB MTU */</span>
<a name="l00106"></a><a class="code" href="structkib__tunables__t.html#af94a3d1b0749569f1baffcd71771fcab">00106</a>         <span class="keywordtype">int</span>              *kib_require_priv_port;<span class="comment">/* accept only privileged ports */</span>
<a name="l00107"></a><a class="code" href="structkib__tunables__t.html#a1dfb83a9184d777c1d208fce570fb35e">00107</a>         <span class="keywordtype">int</span>              *kib_use_priv_port;    <span class="comment">/* use privileged port for active connect */</span>
<a name="l00108"></a>00108         <span class="comment">/* # threads on each CPT */</span>
<a name="l00109"></a><a class="code" href="structkib__tunables__t.html#a0deb164ac897dc70f77dfd0081c7ebaf">00109</a>         <span class="keywordtype">int</span>              *kib_nscheds;
<a name="l00110"></a>00110 } <a class="code" href="structkib__tunables__t.html">kib_tunables_t</a>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="keyword">extern</span> <a class="code" href="structkib__tunables__t.html">kib_tunables_t</a>  <a class="code" href="o2iblnd_8h.html#ac386cd6c28aad86fdd3ea879e394c3f9">kiblnd_tunables</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="o2iblnd_8h.html#a01bb739a54d77884a2e32265d45ebc93">00114</a> <span class="preprocessor">#define IBLND_MSG_QUEUE_SIZE_V1      8          </span><span class="comment">/* V1 only : # messages/RDMAs in-flight */</span>
<a name="l00115"></a><a class="code" href="o2iblnd_8h.html#ae304e055d2b4c0be6385b6de23e06f32">00115</a> <span class="preprocessor">#define IBLND_CREDIT_HIGHWATER_V1    7          </span><span class="comment">/* V1 only : when eagerly to return credits */</span>
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="o2iblnd_8h.html#a1d3d97ce73b08312b99b7e266b78b61b">00117</a> <span class="preprocessor">#define IBLND_CREDITS_DEFAULT        8          </span><span class="comment">/* default # of peer credits */</span>
<a name="l00118"></a><a class="code" href="o2iblnd_8h.html#a3b2bf97636cc88aa8fb48f56da9b08ed">00118</a> <span class="preprocessor">#define IBLND_CREDITS_MAX          ((typeof(((kib_msg_t*) 0)-&gt;ibm_credits)) - 1)  </span><span class="comment">/* Max # of peer credits */</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">/* when eagerly to return credits */</span>
<a name="l00121"></a><a class="code" href="o2iblnd_8h.html#a857dd81441a17520c5670f5df068364b">00121</a> <span class="preprocessor">#define IBLND_CREDITS_HIGHWATER(t, v) ((v) == IBLND_MSG_VERSION_1 ? \</span>
<a name="l00122"></a>00122 <span class="preprocessor">                                        IBLND_CREDIT_HIGHWATER_V1 : \</span>
<a name="l00123"></a>00123 <span class="preprocessor">                                        t-&gt;lnd_peercredits_hiw)</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>
<a name="l00125"></a>00125 <span class="preprocessor">#ifdef HAVE_RDMA_CREATE_ID_5ARG</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor"># define kiblnd_rdma_create_id(cb, dev, ps, qpt) rdma_create_id(current-&gt;nsproxy-&gt;net_ns, \</span>
<a name="l00127"></a>00127 <span class="preprocessor">                                                                cb, dev, \</span>
<a name="l00128"></a>00128 <span class="preprocessor">                                                                ps, qpt)</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span><span class="preprocessor"># ifdef HAVE_RDMA_CREATE_ID_4ARG</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span><span class="preprocessor">#  define kiblnd_rdma_create_id(cb, dev, ps, qpt) rdma_create_id(cb, dev, \</span>
<a name="l00132"></a>00132 <span class="preprocessor">                                                                 ps, qpt)</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="preprocessor"># else</span>
<a name="l00134"></a><a class="code" href="o2iblnd_8h.html#a5ecfcaa8dfbffbdbdc03175009470202">00134</a> <span class="preprocessor"></span><span class="preprocessor">#  define kiblnd_rdma_create_id(cb, dev, ps, qpt) rdma_create_id(cb, dev, ps)</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>
<a name="l00138"></a>00138 <span class="comment">/* 2 OOB shall suffice for 1 keepalive and 1 returning credits */</span>
<a name="l00139"></a><a class="code" href="o2iblnd_8h.html#a92e29daa81985bba27cddd0f20939132">00139</a> <span class="preprocessor">#define IBLND_OOB_CAPABLE(v)       ((v) != IBLND_MSG_VERSION_1)</span>
<a name="l00140"></a><a class="code" href="o2iblnd_8h.html#a7b103b3c3bd8fd4aefca6de443754d57">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_OOB_MSGS(v)           (IBLND_OOB_CAPABLE(v) ? 2 : 0)</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00142"></a><a class="code" href="o2iblnd_8h.html#a6f0ed413fecaa6023504a6043d6658ee">00142</a> <span class="preprocessor">#define IBLND_MSG_SIZE              (4&lt;&lt;10)                 </span><span class="comment">/* max size of queued messages (inc hdr) */</span>
<a name="l00143"></a><a class="code" href="o2iblnd_8h.html#aa1d72a0430435e010f8eb84893421d50">00143</a> <span class="preprocessor">#define IBLND_MAX_RDMA_FRAGS         LNET_MAX_IOV           </span><span class="comment">/* max # of fragments supported */</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/************************/</span>
<a name="l00146"></a>00146 <span class="comment">/* derived constants... */</span>
<a name="l00147"></a>00147 <span class="comment">/* Pools (shared by connections on each CPT) */</span>
<a name="l00148"></a>00148 <span class="comment">/* These pools can grow at runtime, so don&apos;t need give a very large value */</span>
<a name="l00149"></a><a class="code" href="o2iblnd_8h.html#a97e4df2b233c4dfb324068fb611d4abd">00149</a> <span class="preprocessor">#define IBLND_TX_POOL                   256</span>
<a name="l00150"></a><a class="code" href="o2iblnd_8h.html#abced397b95aef15738911d95eb2aa26f">00150</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_FMR_POOL                  256</span>
<a name="l00151"></a><a class="code" href="o2iblnd_8h.html#aaf1e58ad1845dce69784391539f3a834">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_FMR_POOL_FLUSH            192</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>
<a name="l00153"></a>00153 <span class="comment">/* RX messages (per connection) */</span>
<a name="l00154"></a><a class="code" href="o2iblnd_8h.html#ab497c83ab83bbd6d5841ed457ef3fb0b">00154</a> <span class="preprocessor">#define IBLND_RX_MSGS(c)        \</span>
<a name="l00155"></a>00155 <span class="preprocessor">        ((c-&gt;ibc_queue_depth) * 2 + IBLND_OOB_MSGS(c-&gt;ibc_version))</span>
<a name="l00156"></a><a class="code" href="o2iblnd_8h.html#afd4d103e1b128a4960c4fc8643eef025">00156</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_RX_MSG_BYTES(c)       (IBLND_RX_MSGS(c) * IBLND_MSG_SIZE)</span>
<a name="l00157"></a><a class="code" href="o2iblnd_8h.html#a397ac7bee120b3805d236ed0c5f21d77">00157</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_RX_MSG_PAGES(c)   \</span>
<a name="l00158"></a>00158 <span class="preprocessor">        ((IBLND_RX_MSG_BYTES(c) + PAGE_SIZE - 1) / PAGE_SIZE)</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>
<a name="l00160"></a>00160 <span class="comment">/* WRs and CQEs (per connection) */</span>
<a name="l00161"></a><a class="code" href="o2iblnd_8h.html#ae5aea8822c0e0023196dee7093e6dc65">00161</a> <span class="preprocessor">#define IBLND_RECV_WRS(c)            IBLND_RX_MSGS(c)</span>
<a name="l00162"></a><a class="code" href="o2iblnd_8h.html#afdbf97eb3abe2ed428cef86c57d083ea">00162</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_SEND_WRS(c)       \</span>
<a name="l00163"></a>00163 <span class="preprocessor">        ((c-&gt;ibc_max_frags + 1) * kiblnd_concurrent_sends(c-&gt;ibc_version, \</span>
<a name="l00164"></a>00164 <span class="preprocessor">                                                          c-&gt;ibc_peer-&gt;ibp_ni))</span>
<a name="l00165"></a><a class="code" href="o2iblnd_8h.html#a848b552998ea238e0d9b260e605b5bef">00165</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_CQ_ENTRIES(c)         (IBLND_RECV_WRS(c) + IBLND_SEND_WRS(c))</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>
<a name="l00167"></a>00167 <span class="keyword">struct </span><a class="code" href="structkib__hca__dev.html">kib_hca_dev</a>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="comment">/* o2iblnd can run over aliased interface */</span>
<a name="l00170"></a>00170 <span class="preprocessor">#ifdef IFALIASZ</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span><span class="preprocessor">#define KIB_IFNAME_SIZE              IFALIASZ</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00173"></a><a class="code" href="o2iblnd_8h.html#a836e3a74188b89061eddaa6031cb7f7e">00173</a> <span class="preprocessor"></span><span class="preprocessor">#define KIB_IFNAME_SIZE              256</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>
<a name="l00176"></a><a class="code" href="structkib__dev__t.html">00176</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00177"></a>00177 {
<a name="l00178"></a><a class="code" href="structkib__dev__t.html#a7399a811e1dea2057239fb08513a8616">00178</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        ibd_list;       <span class="comment">/* chain on kib_devs */</span>
<a name="l00179"></a><a class="code" href="structkib__dev__t.html#af846dbd904fc79a5c54d5fb1b3a71f2c">00179</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        ibd_fail_list;  <span class="comment">/* chain on kib_failed_devs */</span>
<a name="l00180"></a><a class="code" href="structkib__dev__t.html#afe4124ab582fa2ed52d082181506a73f">00180</a>         __u32                   ibd_ifip;       <span class="comment">/* IPoIB interface IP */</span>
<a name="l00182"></a><a class="code" href="structkib__dev__t.html#a05f36292a22fb55a3717ad29612b9dd0">00182</a>         <span class="keywordtype">char</span>                    ibd_ifname[<a class="code" href="o2iblnd_8h.html#a836e3a74188b89061eddaa6031cb7f7e">KIB_IFNAME_SIZE</a>];
<a name="l00183"></a><a class="code" href="structkib__dev__t.html#a02a207ba8f7e98262e4c322257eaf08c">00183</a>         <span class="keywordtype">int</span>                     ibd_nnets;      <span class="comment">/* # nets extant */</span>
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="structkib__dev__t.html#a161a00aa0bdc9b880a35a7a165e7d8e4">00185</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              ibd_next_failover;
<a name="l00186"></a>00186         <span class="comment">/* # failover failures */</span>
<a name="l00187"></a><a class="code" href="structkib__dev__t.html#a8138feb70b5962fe422cbdb191eaaf6f">00187</a>         <span class="keywordtype">int</span>                     ibd_failed_failover;
<a name="l00188"></a>00188         <span class="comment">/* failover in progress */</span>
<a name="l00189"></a><a class="code" href="structkib__dev__t.html#a534fab31ea2c2f1977fd9662f2495b97">00189</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            ibd_failover;
<a name="l00190"></a>00190         <span class="comment">/* IPoIB interface is a bonding master */</span>
<a name="l00191"></a><a class="code" href="structkib__dev__t.html#a3c28e616bf93fe0670b8498173ba8941">00191</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            ibd_can_failover;
<a name="l00192"></a><a class="code" href="structkib__dev__t.html#ae324e36e8c10495de993a1b20e02e868">00192</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        ibd_nets;
<a name="l00193"></a><a class="code" href="structkib__dev__t.html#a421ed606736bcd0d5c2d037c49c3f195">00193</a>         <span class="keyword">struct </span><a class="code" href="structkib__hca__dev.html">kib_hca_dev</a>      *ibd_hdev;
<a name="l00194"></a>00194 } <a class="code" href="structkib__dev__t.html">kib_dev_t</a>;
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="structkib__hca__dev.html">00196</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__hca__dev.html">kib_hca_dev</a>
<a name="l00197"></a>00197 {
<a name="l00198"></a><a class="code" href="structkib__hca__dev.html#a833d70008bb69ff2caa7451695c381f4">00198</a>         <span class="keyword">struct </span>rdma_cm_id   *<a class="code" href="structkib__hca__dev.html#a833d70008bb69ff2caa7451695c381f4">ibh_cmid</a>;          <span class="comment">/* listener cmid */</span>
<a name="l00199"></a><a class="code" href="structkib__hca__dev.html#a746e4e5fdc85b5d9cd95aeb2848c4ecc">00199</a>         <span class="keyword">struct </span>ib_device    *<a class="code" href="structkib__hca__dev.html#a746e4e5fdc85b5d9cd95aeb2848c4ecc">ibh_ibdev</a>;         <span class="comment">/* IB device */</span>
<a name="l00200"></a><a class="code" href="structkib__hca__dev.html#a34d48db9b27854572aafad22cd73c274">00200</a>         <span class="keywordtype">int</span>                  <a class="code" href="structkib__hca__dev.html#a34d48db9b27854572aafad22cd73c274">ibh_page_shift</a>;    <span class="comment">/* page shift of current HCA */</span>
<a name="l00201"></a><a class="code" href="structkib__hca__dev.html#af6712337b12c97cd54d8414557910504">00201</a>         <span class="keywordtype">int</span>                  <a class="code" href="structkib__hca__dev.html#af6712337b12c97cd54d8414557910504">ibh_page_size</a>;     <span class="comment">/* page size of current HCA */</span>
<a name="l00202"></a><a class="code" href="structkib__hca__dev.html#a36c528a48ebafd6ecda5aa11f735228a">00202</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                <a class="code" href="structkib__hca__dev.html#a36c528a48ebafd6ecda5aa11f735228a">ibh_page_mask</a>;     <span class="comment">/* page mask of current HCA */</span>
<a name="l00203"></a><a class="code" href="structkib__hca__dev.html#a6519daee6158b10923b4ad4319a89b18">00203</a>         <span class="keywordtype">int</span>                  <a class="code" href="structkib__hca__dev.html#a6519daee6158b10923b4ad4319a89b18">ibh_mr_shift</a>;      <span class="comment">/* bits shift of max MR size */</span>
<a name="l00204"></a><a class="code" href="structkib__hca__dev.html#a069dec26d57ddea4ac30a982c88befbe">00204</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                <a class="code" href="structkib__hca__dev.html#a069dec26d57ddea4ac30a982c88befbe">ibh_mr_size</a>;       <span class="comment">/* size of MR */</span>
<a name="l00205"></a><a class="code" href="structkib__hca__dev.html#a7d6c99aeefb386a31247c609dd3b67a6">00205</a>         <span class="keyword">struct </span>ib_mr        *<a class="code" href="structkib__hca__dev.html#a7d6c99aeefb386a31247c609dd3b67a6">ibh_mrs</a>;           <span class="comment">/* global MR */</span>
<a name="l00206"></a><a class="code" href="structkib__hca__dev.html#a478f16b3013777d5c6bfcfcfdcf77cf1">00206</a>         <span class="keyword">struct </span>ib_pd        *<a class="code" href="structkib__hca__dev.html#a478f16b3013777d5c6bfcfcfdcf77cf1">ibh_pd</a>;            <span class="comment">/* PD */</span>
<a name="l00207"></a><a class="code" href="structkib__hca__dev.html#aab6315da898ac6ecf625b4381fe5ecde">00207</a>         <a class="code" href="structkib__dev__t.html">kib_dev_t</a>           *<a class="code" href="structkib__hca__dev.html#aab6315da898ac6ecf625b4381fe5ecde">ibh_dev</a>;           <span class="comment">/* owner */</span>
<a name="l00208"></a><a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">00208</a>         atomic_t             <a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">ibh_ref</a>;           <span class="comment">/* refcount */</span>
<a name="l00209"></a>00209 } <a class="code" href="structkib__hca__dev.html">kib_hca_dev_t</a>;
<a name="l00210"></a>00210 
<a name="l00212"></a><a class="code" href="o2iblnd_8h.html#a91aa76019747736cb4396020d86c34f3">00212</a> <span class="preprocessor">#define IBLND_POOL_DEADLINE     300</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>
<a name="l00214"></a><a class="code" href="o2iblnd_8h.html#acdf342eace0765be9027f5505a35beff">00214</a> <span class="preprocessor">#define IBLND_POOL_RETRY        1</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span>
<a name="l00216"></a><a class="code" href="structkib__pages__t.html">00216</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00217"></a>00217 {
<a name="l00218"></a><a class="code" href="structkib__pages__t.html#a6d47839337d1da2b2f10d42a3cb09edd">00218</a>         <span class="keywordtype">int</span>                     ibp_npages;             <span class="comment">/* # pages */</span>
<a name="l00219"></a><a class="code" href="structkib__pages__t.html#afcdaaabf3816431e4d4ceba470d99bdb">00219</a>         <span class="keyword">struct </span>page            *ibp_pages[0];           <span class="comment">/* page array */</span>
<a name="l00220"></a>00220 } <a class="code" href="structkib__pages__t.html">kib_pages_t</a>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a>;
<a name="l00223"></a>00223 <span class="keyword">struct </span><a class="code" href="structkib__poolset.html">kib_poolset</a>;
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="o2iblnd_8h.html#a33cdf4d5753869cf8571f7ae2a1a32aa">00225</a> <span class="keyword">typedef</span> int  (*<a class="code" href="o2iblnd_8h.html#a33cdf4d5753869cf8571f7ae2a1a32aa">kib_ps_pool_create_t</a>)(<span class="keyword">struct </span><a class="code" href="structkib__poolset.html">kib_poolset</a> *ps,
<a name="l00226"></a>00226                                      <span class="keywordtype">int</span> inc, <span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a> **pp_po);
<a name="l00227"></a><a class="code" href="o2iblnd_8h.html#a06d06ffdfb232244c1d0b4c83496ed1d">00227</a> <span class="keyword">typedef</span> void (*<a class="code" href="o2iblnd_8h.html#a06d06ffdfb232244c1d0b4c83496ed1d">kib_ps_pool_destroy_t</a>)(<span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a> *po);
<a name="l00228"></a><a class="code" href="o2iblnd_8h.html#a87343931e79e0e30925316c7354c38fe">00228</a> <span class="keyword">typedef</span> void (*<a class="code" href="o2iblnd_8h.html#a87343931e79e0e30925316c7354c38fe">kib_ps_node_init_t</a>)(<span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a> *po, <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> *node);
<a name="l00229"></a><a class="code" href="o2iblnd_8h.html#ab69392a61eae3bded472829ca50c5a69">00229</a> <span class="keyword">typedef</span> void (*<a class="code" href="o2iblnd_8h.html#ab69392a61eae3bded472829ca50c5a69">kib_ps_node_fini_t</a>)(<span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a> *po, <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> *node);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 <span class="keyword">struct </span><a class="code" href="structkib__net.html">kib_net</a>;
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="o2iblnd_8h.html#a7517e587e125804548dfae38e5ca4dba">00233</a> <span class="preprocessor">#define IBLND_POOL_NAME_LEN     32</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>
<a name="l00235"></a><a class="code" href="structkib__poolset.html">00235</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__poolset.html">kib_poolset</a>
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237         <span class="comment">/* serialize */</span>
<a name="l00238"></a><a class="code" href="structkib__poolset.html#a7593da42109ca12b49cc372228a71051">00238</a>         spinlock_t              <a class="code" href="structkib__poolset.html#a7593da42109ca12b49cc372228a71051">ps_lock</a>;
<a name="l00239"></a>00239         <span class="comment">/* network it belongs to */</span>
<a name="l00240"></a><a class="code" href="structkib__poolset.html#a08fb63a411eb2d0ac69c9ac18c752195">00240</a>         <span class="keyword">struct </span><a class="code" href="structkib__net.html">kib_net</a>          *<a class="code" href="structkib__poolset.html#a08fb63a411eb2d0ac69c9ac18c752195">ps_net</a>;
<a name="l00241"></a>00241         <span class="comment">/* pool set name */</span>
<a name="l00242"></a><a class="code" href="structkib__poolset.html#ace997a128182e2aaea67a500b40fc57f">00242</a>         <span class="keywordtype">char</span>                    <a class="code" href="structkib__poolset.html#ace997a128182e2aaea67a500b40fc57f">ps_name</a>[<a class="code" href="o2iblnd_8h.html#a7517e587e125804548dfae38e5ca4dba">IBLND_POOL_NAME_LEN</a>];
<a name="l00243"></a>00243         <span class="comment">/* list of pools */</span>
<a name="l00244"></a><a class="code" href="structkib__poolset.html#acc6388e5bf2573240ce2034208d66237">00244</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__poolset.html#acc6388e5bf2573240ce2034208d66237">ps_pool_list</a>;
<a name="l00245"></a>00245         <span class="comment">/* failed pool list */</span>
<a name="l00246"></a><a class="code" href="structkib__poolset.html#afa4d056108a3bf5b0380b617b9aee781">00246</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__poolset.html#afa4d056108a3bf5b0380b617b9aee781">ps_failed_pool_list</a>;
<a name="l00247"></a>00247         <span class="comment">/* time stamp for retry if failed to allocate */</span>
<a name="l00248"></a><a class="code" href="structkib__poolset.html#a04377752690ac712e1f99606d1c2f912">00248</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              <a class="code" href="structkib__poolset.html#a04377752690ac712e1f99606d1c2f912">ps_next_retry</a>;
<a name="l00249"></a>00249         <span class="comment">/* is allocating new pool */</span>
<a name="l00250"></a><a class="code" href="structkib__poolset.html#a16c1a4b2473932332bc2ca8117371a6b">00250</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__poolset.html#a16c1a4b2473932332bc2ca8117371a6b">ps_increasing</a>;
<a name="l00251"></a>00251         <span class="comment">/* new pool size */</span>
<a name="l00252"></a><a class="code" href="structkib__poolset.html#a2bf46320aada06e2c49a8f4643b15f5b">00252</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__poolset.html#a2bf46320aada06e2c49a8f4643b15f5b">ps_pool_size</a>;
<a name="l00253"></a>00253         <span class="comment">/* CPT id */</span>
<a name="l00254"></a><a class="code" href="structkib__poolset.html#ae7a84eecbb679b9196ef4102f8d24f20">00254</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__poolset.html#ae7a84eecbb679b9196ef4102f8d24f20">ps_cpt</a>;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">/* create a new pool */</span>
<a name="l00257"></a><a class="code" href="structkib__poolset.html#af8451aa6c3cea7212307bb86ba74d367">00257</a>         <a class="code" href="o2iblnd_8h.html#a33cdf4d5753869cf8571f7ae2a1a32aa">kib_ps_pool_create_t</a>    <a class="code" href="structkib__poolset.html#af8451aa6c3cea7212307bb86ba74d367">ps_pool_create</a>;
<a name="l00258"></a>00258         <span class="comment">/* destroy a pool */</span>
<a name="l00259"></a><a class="code" href="structkib__poolset.html#a9edb73101a154e489fc15ca290904ce7">00259</a>         <a class="code" href="o2iblnd_8h.html#a06d06ffdfb232244c1d0b4c83496ed1d">kib_ps_pool_destroy_t</a>   <a class="code" href="structkib__poolset.html#a9edb73101a154e489fc15ca290904ce7">ps_pool_destroy</a>;
<a name="l00260"></a>00260         <span class="comment">/* initialize new allocated node */</span>
<a name="l00261"></a><a class="code" href="structkib__poolset.html#a8d308010e3135ee2db04666819d774f0">00261</a>         <a class="code" href="o2iblnd_8h.html#a87343931e79e0e30925316c7354c38fe">kib_ps_node_init_t</a>      <a class="code" href="structkib__poolset.html#a8d308010e3135ee2db04666819d774f0">ps_node_init</a>;
<a name="l00262"></a>00262         <span class="comment">/* finalize node */</span>
<a name="l00263"></a><a class="code" href="structkib__poolset.html#a836f0be59cf577b50ff6922bd2d79159">00263</a>         <a class="code" href="o2iblnd_8h.html#ab69392a61eae3bded472829ca50c5a69">kib_ps_node_fini_t</a>      <a class="code" href="structkib__poolset.html#a836f0be59cf577b50ff6922bd2d79159">ps_node_fini</a>;
<a name="l00264"></a>00264 } <a class="code" href="structkib__poolset.html">kib_poolset_t</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="structkib__pool.html">00266</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__pool.html">kib_pool</a>
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268         <span class="comment">/* chain on pool list */</span>
<a name="l00269"></a><a class="code" href="structkib__pool.html#ad8d3d339a651cfa4abdc3165c42fbc62">00269</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__pool.html#ad8d3d339a651cfa4abdc3165c42fbc62">po_list</a>;
<a name="l00270"></a>00270         <span class="comment">/* pre-allocated node */</span>
<a name="l00271"></a><a class="code" href="structkib__pool.html#a2c5be254fed144034255293207698bd7">00271</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__pool.html#a2c5be254fed144034255293207698bd7">po_free_list</a>;
<a name="l00272"></a>00272         <span class="comment">/* pool_set of this pool */</span>
<a name="l00273"></a><a class="code" href="structkib__pool.html#affefe3bed109f7183fb167819521249a">00273</a>         <a class="code" href="structkib__poolset.html">kib_poolset_t</a>          *<a class="code" href="structkib__pool.html#affefe3bed109f7183fb167819521249a">po_owner</a>;
<a name="l00274"></a>00274         <span class="comment">/* deadline of this pool */</span>
<a name="l00275"></a><a class="code" href="structkib__pool.html#a4478cb373ef53232809d5e1a8760c559">00275</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              <a class="code" href="structkib__pool.html#a4478cb373ef53232809d5e1a8760c559">po_deadline</a>;
<a name="l00276"></a>00276         <span class="comment">/* # of elements in use */</span>
<a name="l00277"></a><a class="code" href="structkib__pool.html#a0d5a86bc650ba8c54b498de8423dfd57">00277</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__pool.html#a0d5a86bc650ba8c54b498de8423dfd57">po_allocated</a>;
<a name="l00278"></a>00278         <span class="comment">/* pool is created on failed HCA */</span>
<a name="l00279"></a><a class="code" href="structkib__pool.html#a02a8d2538f360534066c00b088f44c5c">00279</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__pool.html#a02a8d2538f360534066c00b088f44c5c">po_failed</a>;
<a name="l00280"></a>00280         <span class="comment">/* # of pre-allocated elements */</span>
<a name="l00281"></a><a class="code" href="structkib__pool.html#a6268bd37063688c7a5f4cbd68a868bb9">00281</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__pool.html#a6268bd37063688c7a5f4cbd68a868bb9">po_size</a>;
<a name="l00282"></a>00282 } <a class="code" href="structkib__pool.html">kib_pool_t</a>;
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="structkib__tx__poolset__t.html">00284</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00285"></a><a class="code" href="structkib__tx__poolset__t.html#a7de5bb669215bcdd17263016033a0d23">00285</a>         <a class="code" href="structkib__poolset.html">kib_poolset_t</a>           tps_poolset;            <span class="comment">/* pool-set */</span>
<a name="l00286"></a><a class="code" href="structkib__tx__poolset__t.html#acff440ce342b1275bd36166264e6ae3f">00286</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   tps_next_tx_cookie;     <span class="comment">/* cookie of TX */</span>
<a name="l00287"></a>00287 } <a class="code" href="structkib__tx__poolset__t.html">kib_tx_poolset_t</a>;
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="structkib__tx__pool__t.html">00289</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00290"></a><a class="code" href="structkib__tx__pool__t.html#a250a6dd5f7e6daf0c173522c98d51619">00290</a>         <a class="code" href="structkib__pool.html">kib_pool_t</a>              tpo_pool;               <span class="comment">/* pool */</span>
<a name="l00291"></a><a class="code" href="structkib__tx__pool__t.html#a78d86361ae0c6e750a3b9c07ba28eb38">00291</a>         <span class="keyword">struct </span><a class="code" href="structkib__hca__dev.html">kib_hca_dev</a>     *tpo_hdev;               <span class="comment">/* device for this pool */</span>
<a name="l00292"></a><a class="code" href="structkib__tx__pool__t.html#ad116df5d588e6b30d8e8ddaa99bb614d">00292</a>         <span class="keyword">struct </span><a class="code" href="structkib__tx.html">kib_tx</a>          *tpo_tx_descs;           <span class="comment">/* all the tx descriptors */</span>
<a name="l00293"></a><a class="code" href="structkib__tx__pool__t.html#ada5291870df4a955f3d81aefefe5d4d3">00293</a>         <a class="code" href="structkib__pages__t.html">kib_pages_t</a>            *tpo_tx_pages;           <span class="comment">/* premapped tx msg pages */</span>
<a name="l00294"></a>00294 } <a class="code" href="structkib__tx__pool__t.html">kib_tx_pool_t</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="structkib__fmr__poolset__t.html">00296</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00297"></a>00297 {
<a name="l00298"></a><a class="code" href="structkib__fmr__poolset__t.html#a1f59dd74dc70825b3885c237e6ff36ca">00298</a>         spinlock_t              fps_lock;               <span class="comment">/* serialize */</span>
<a name="l00299"></a><a class="code" href="structkib__fmr__poolset__t.html#aa8c2f3b13b85f1de0a589c6dd77f6299">00299</a>         <span class="keyword">struct </span><a class="code" href="structkib__net.html">kib_net</a>         *fps_net;                <span class="comment">/* IB network */</span>
<a name="l00300"></a><a class="code" href="structkib__fmr__poolset__t.html#a3752bf3ba069775e9c2c76e52aee0dc3">00300</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        fps_pool_list;          <span class="comment">/* FMR pool list */</span>
<a name="l00301"></a><a class="code" href="structkib__fmr__poolset__t.html#ab898034a087004dc19ec09f8b00a9abf">00301</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        fps_failed_pool_list;   <span class="comment">/* FMR pool list */</span>
<a name="l00302"></a><a class="code" href="structkib__fmr__poolset__t.html#adcba27e74ca47736a040e1efb2d8d3fe">00302</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   fps_version;            <span class="comment">/* validity stamp */</span>
<a name="l00303"></a><a class="code" href="structkib__fmr__poolset__t.html#a1f10879a8c0446e7981cde29188aa769">00303</a>         <span class="keywordtype">int</span>                     fps_cpt;                <span class="comment">/* CPT id */</span>
<a name="l00304"></a><a class="code" href="structkib__fmr__poolset__t.html#adf9ed0ac99aaacc5b71973d9d8d4b00b">00304</a>         <span class="keywordtype">int</span>                     fps_pool_size;
<a name="l00305"></a><a class="code" href="structkib__fmr__poolset__t.html#ad1e9fa421451d90df5ae9cb1ba68e162">00305</a>         <span class="keywordtype">int</span>                     fps_flush_trigger;
<a name="l00306"></a><a class="code" href="structkib__fmr__poolset__t.html#a7743852140d384cdb9e151e773bb6c3f">00306</a>         <span class="keywordtype">int</span>                     fps_cache;
<a name="l00307"></a>00307         <span class="comment">/* is allocating new pool */</span>
<a name="l00308"></a><a class="code" href="structkib__fmr__poolset__t.html#a1d6e5f69c481490ade8a38a67399f388">00308</a>         <span class="keywordtype">int</span>                     fps_increasing;
<a name="l00309"></a>00309         <span class="comment">/* time stamp for retry if failed to allocate */</span>
<a name="l00310"></a><a class="code" href="structkib__fmr__poolset__t.html#abb16640d387445840db5a6eb009d2ae7">00310</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              fps_next_retry;
<a name="l00311"></a>00311 } <a class="code" href="structkib__fmr__poolset__t.html">kib_fmr_poolset_t</a>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="preprocessor">#ifndef HAVE_IB_RDMA_WR</span>
<a name="l00314"></a><a class="code" href="structib__rdma__wr.html">00314</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structib__rdma__wr.html">ib_rdma_wr</a> {
<a name="l00315"></a><a class="code" href="structib__rdma__wr.html#a2b6ce2bce799b570f5483c058475ee0f">00315</a>         <span class="keyword">struct </span>ib_send_wr <a class="code" href="structib__rdma__wr.html#a2b6ce2bce799b570f5483c058475ee0f">wr</a>;
<a name="l00316"></a>00316 };
<a name="l00317"></a>00317 <span class="preprocessor">#endif</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>
<a name="l00319"></a><a class="code" href="structkib__fast__reg__descriptor.html">00319</a> <span class="keyword">struct </span><a class="code" href="structkib__fast__reg__descriptor.html">kib_fast_reg_descriptor</a> { <span class="comment">/* For fast registration */</span>
<a name="l00320"></a><a class="code" href="structkib__fast__reg__descriptor.html#a3bf7dfe0b65a99c9a2652d5efd511588">00320</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>                 <a class="code" href="structkib__fast__reg__descriptor.html#a3bf7dfe0b65a99c9a2652d5efd511588">frd_list</a>;
<a name="l00321"></a><a class="code" href="structkib__fast__reg__descriptor.html#af01de7405406d7f94297ff71d86ede5f">00321</a>         <span class="keyword">struct </span><a class="code" href="structib__rdma__wr.html">ib_rdma_wr</a>                <a class="code" href="structkib__fast__reg__descriptor.html#af01de7405406d7f94297ff71d86ede5f">frd_inv_wr</a>;
<a name="l00322"></a>00322 <span class="preprocessor">#ifdef HAVE_IB_MAP_MR_SG</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>        <span class="keyword">struct </span>ib_reg_wr                 <a class="code" href="structkib__fast__reg__descriptor.html#a791edb3816163912f2a21c69712056a5">frd_fastreg_wr</a>;
<a name="l00324"></a>00324 <span class="preprocessor">#else</span>
<a name="l00325"></a><a class="code" href="structkib__fast__reg__descriptor.html#a791edb3816163912f2a21c69712056a5">00325</a> <span class="preprocessor"></span>        <span class="keyword">struct </span><a class="code" href="structib__rdma__wr.html">ib_rdma_wr</a>                <a class="code" href="structkib__fast__reg__descriptor.html#a791edb3816163912f2a21c69712056a5">frd_fastreg_wr</a>;
<a name="l00326"></a><a class="code" href="structkib__fast__reg__descriptor.html#abac992e16158ff0c58eb858491699f61">00326</a>         <span class="keyword">struct </span>ib_fast_reg_page_list    *<a class="code" href="structkib__fast__reg__descriptor.html#abac992e16158ff0c58eb858491699f61">frd_frpl</a>;
<a name="l00327"></a>00327 <span class="preprocessor">#endif</span>
<a name="l00328"></a><a class="code" href="structkib__fast__reg__descriptor.html#a4f26a909781e677ef6f556311725a440">00328</a> <span class="preprocessor"></span>        <span class="keyword">struct </span>ib_mr                    *<a class="code" href="structkib__fast__reg__descriptor.html#a4f26a909781e677ef6f556311725a440">frd_mr</a>;
<a name="l00329"></a><a class="code" href="structkib__fast__reg__descriptor.html#a4797c44b9da28a94b6646b85d08b81bb">00329</a>         <span class="keywordtype">bool</span>                             <a class="code" href="structkib__fast__reg__descriptor.html#a4797c44b9da28a94b6646b85d08b81bb">frd_valid</a>;
<a name="l00330"></a>00330 };
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="structkib__fmr__pool__t.html">00332</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00333"></a>00333 {
<a name="l00334"></a><a class="code" href="structkib__fmr__pool__t.html#a71d0c70a797f4684f306398a06843806">00334</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        fpo_list;       <span class="comment">/* chain on pool list */</span>
<a name="l00335"></a><a class="code" href="structkib__fmr__pool__t.html#a346d3f772d795f2b5f4401bcb09aed71">00335</a>         <span class="keyword">struct </span><a class="code" href="structkib__hca__dev.html">kib_hca_dev</a>     *fpo_hdev;       <span class="comment">/* device for this pool */</span>
<a name="l00336"></a><a class="code" href="structkib__fmr__pool__t.html#a7a8fdfaab7a627206db5a2d39984a72f">00336</a>         <a class="code" href="structkib__fmr__poolset__t.html">kib_fmr_poolset_t</a>      *fpo_owner;      <span class="comment">/* owner of this pool */</span>
<a name="l00337"></a>00337         <span class="keyword">union </span>{
<a name="l00338"></a>00338                 <span class="keyword">struct </span>{
<a name="l00339"></a><a class="code" href="structkib__fmr__pool__t.html#ab591c9f592df66c9155c7466cfd99e47">00339</a>                         <span class="keyword">struct </span>ib_fmr_pool *fpo_fmr_pool; <span class="comment">/* IB FMR pool */</span>
<a name="l00340"></a>00340                 } fmr;
<a name="l00341"></a>00341                 <span class="keyword">struct </span>{ <span class="comment">/* For fast registration */</span>
<a name="l00342"></a><a class="code" href="structkib__fmr__pool__t.html#a919da46e292d3b5c3fcb5732f3b1e4f4">00342</a>                         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>  fpo_pool_list;
<a name="l00343"></a><a class="code" href="structkib__fmr__pool__t.html#a1fbce1811bb1d6ad4a1f5d09012fe821">00343</a>                         <span class="keywordtype">int</span>               fpo_pool_size;
<a name="l00344"></a>00344                 } fast_reg;
<a name="l00345"></a>00345         };
<a name="l00346"></a><a class="code" href="structkib__fmr__pool__t.html#ac15b7bb7630195d45d82b321ec82559f">00346</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              fpo_deadline;   <span class="comment">/* deadline of this pool */</span>
<a name="l00347"></a><a class="code" href="structkib__fmr__pool__t.html#ac20322e060b032aed6144e079aa2ce0d">00347</a>         <span class="keywordtype">int</span>                     fpo_failed;     <span class="comment">/* fmr pool is failed */</span>
<a name="l00348"></a><a class="code" href="structkib__fmr__pool__t.html#a3ef00f6fe8271e4b7c000acfd0687815">00348</a>         <span class="keywordtype">int</span>                     fpo_map_count;  <span class="comment">/* # of mapped FMR */</span>
<a name="l00349"></a><a class="code" href="structkib__fmr__pool__t.html#af101887dc6584306d9e29d54bc170aa6">00349</a>         <span class="keywordtype">int</span>                     fpo_is_fmr;
<a name="l00350"></a>00350 } <a class="code" href="structkib__fmr__pool__t.html">kib_fmr_pool_t</a>;
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="structkib__fmr__t.html">00352</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00353"></a><a class="code" href="structkib__fmr__t.html#a079eb906113f095e41afef6bb0ee8fce">00353</a>         <a class="code" href="structkib__fmr__pool__t.html">kib_fmr_pool_t</a>                  *fmr_pool;      <span class="comment">/* pool of FMR */</span>
<a name="l00354"></a><a class="code" href="structkib__fmr__t.html#ad8907aca1f400ff476bca478bed9925e">00354</a>         <span class="keyword">struct </span>ib_pool_fmr              *fmr_pfmr;      <span class="comment">/* IB pool fmr */</span>
<a name="l00355"></a><a class="code" href="structkib__fmr__t.html#a300934d3d8f6faf7594a0906ac7cbca6">00355</a>         <span class="keyword">struct </span><a class="code" href="structkib__fast__reg__descriptor.html">kib_fast_reg_descriptor</a>  *fmr_frd;
<a name="l00356"></a><a class="code" href="structkib__fmr__t.html#a3ee7715bee758b6e0c81e464695771ac">00356</a>         u32                              fmr_key;
<a name="l00357"></a>00357 } <a class="code" href="structkib__fmr__t.html">kib_fmr_t</a>;
<a name="l00358"></a>00358 
<a name="l00359"></a><a class="code" href="structkib__net.html">00359</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__net.html">kib_net</a>
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361         <span class="comment">/* chain on kib_dev_t::ibd_nets */</span>
<a name="l00362"></a><a class="code" href="structkib__net.html#a80130889fd5486c7e443c8e8e45ff609">00362</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__net.html#a80130889fd5486c7e443c8e8e45ff609">ibn_list</a>;
<a name="l00363"></a><a class="code" href="structkib__net.html#a27c7655fda82a53ac914ef31b61b00d4">00363</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__net.html#a27c7655fda82a53ac914ef31b61b00d4">ibn_incarnation</a>;<span class="comment">/* my epoch */</span>
<a name="l00364"></a><a class="code" href="structkib__net.html#ae28505c441613fb31a8e987e5b2ea813">00364</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__net.html#ae28505c441613fb31a8e987e5b2ea813">ibn_init</a>;       <span class="comment">/* initialisation state */</span>
<a name="l00365"></a><a class="code" href="structkib__net.html#aef53c216944d186613fe9df42b19f2a9">00365</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__net.html#aef53c216944d186613fe9df42b19f2a9">ibn_shutdown</a>;   <span class="comment">/* shutting down? */</span>
<a name="l00366"></a>00366 
<a name="l00367"></a><a class="code" href="structkib__net.html#abaed68c0d039bc1aff4e22c06f1563c8">00367</a>         atomic_t                <a class="code" href="structkib__net.html#abaed68c0d039bc1aff4e22c06f1563c8">ibn_npeers</a>;     <span class="comment">/* # peers extant */</span>
<a name="l00368"></a><a class="code" href="structkib__net.html#a452e5a6ef793a0c77757b2ecf00ea67e">00368</a>         atomic_t                <a class="code" href="structkib__net.html#a452e5a6ef793a0c77757b2ecf00ea67e">ibn_nconns</a>;     <span class="comment">/* # connections extant */</span>
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="structkib__net.html#aaadca5b3704b918a3194fc3ee7dec26c">00370</a>         <a class="code" href="structkib__tx__poolset__t.html">kib_tx_poolset_t</a>        **<a class="code" href="structkib__net.html#aaadca5b3704b918a3194fc3ee7dec26c">ibn_tx_ps</a>;    <span class="comment">/* tx pool-set */</span>
<a name="l00371"></a><a class="code" href="structkib__net.html#a479dc496d41c743180789ad3285df7fd">00371</a>         <a class="code" href="structkib__fmr__poolset__t.html">kib_fmr_poolset_t</a>       **<a class="code" href="structkib__net.html#a479dc496d41c743180789ad3285df7fd">ibn_fmr_ps</a>;   <span class="comment">/* fmr pool-set */</span>
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="structkib__net.html#a1636f757dc63d376398816034acbf9a6">00373</a>         <a class="code" href="structkib__dev__t.html">kib_dev_t</a>               *<a class="code" href="structkib__net.html#a1636f757dc63d376398816034acbf9a6">ibn_dev</a>;       <span class="comment">/* underlying IB device */</span>
<a name="l00374"></a>00374 } <a class="code" href="structkib__net.html">kib_net_t</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a><a class="code" href="o2iblnd_8h.html#ac658f3b13dda2f5d6cb957b23c638fe3">00376</a> <span class="preprocessor">#define KIB_THREAD_SHIFT                16</span>
<a name="l00377"></a><a class="code" href="o2iblnd_8h.html#a2a793753886dd1a7d32c2817420f1ae5">00377</a> <span class="preprocessor"></span><span class="preprocessor">#define KIB_THREAD_ID(cpt, tid)         ((cpt) &lt;&lt; KIB_THREAD_SHIFT | (tid))</span>
<a name="l00378"></a><a class="code" href="o2iblnd_8h.html#a1a6bc46dd28ca8584fb4dc57e08bf502">00378</a> <span class="preprocessor"></span><span class="preprocessor">#define KIB_THREAD_CPT(id)              ((id) &gt;&gt; KIB_THREAD_SHIFT)</span>
<a name="l00379"></a><a class="code" href="o2iblnd_8h.html#af658a24e3d4a7f8f51ae19ed4fa5b03a">00379</a> <span class="preprocessor"></span><span class="preprocessor">#define KIB_THREAD_TID(id)              ((id) &amp; ((1UL &lt;&lt; KIB_THREAD_SHIFT) - 1))</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span>
<a name="l00381"></a><a class="code" href="structkib__sched__info.html">00381</a> <span class="keyword">struct </span><a class="code" href="structkib__sched__info.html">kib_sched_info</a> {
<a name="l00382"></a>00382         <span class="comment">/* serialise */</span>
<a name="l00383"></a><a class="code" href="structkib__sched__info.html#a103b76fe6299e1b9058f8fa73a3c50b6">00383</a>         spinlock_t              <a class="code" href="structkib__sched__info.html#a103b76fe6299e1b9058f8fa73a3c50b6">ibs_lock</a>;
<a name="l00384"></a>00384         <span class="comment">/* schedulers sleep here */</span>
<a name="l00385"></a><a class="code" href="structkib__sched__info.html#adf3e3591a9d2d8159cfe176249b24178">00385</a>         wait_queue_head_t       <a class="code" href="structkib__sched__info.html#adf3e3591a9d2d8159cfe176249b24178">ibs_waitq</a>;
<a name="l00386"></a>00386         <span class="comment">/* conns to check for rx completions */</span>
<a name="l00387"></a><a class="code" href="structkib__sched__info.html#ab9b79284d0b5d689c1d9e0504da702a8">00387</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__sched__info.html#ab9b79284d0b5d689c1d9e0504da702a8">ibs_conns</a>;
<a name="l00388"></a>00388         <span class="comment">/* number of scheduler threads */</span>
<a name="l00389"></a><a class="code" href="structkib__sched__info.html#adeaf596142e9df61feeec041aadded84">00389</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__sched__info.html#adeaf596142e9df61feeec041aadded84">ibs_nthreads</a>;
<a name="l00390"></a>00390         <span class="comment">/* max allowed scheduler threads */</span>
<a name="l00391"></a><a class="code" href="structkib__sched__info.html#ad2fbde3679e9bee805b19d29486e2c49">00391</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__sched__info.html#ad2fbde3679e9bee805b19d29486e2c49">ibs_nthreads_max</a>;
<a name="l00392"></a><a class="code" href="structkib__sched__info.html#acc805791ffcde2a1fadcf6c3d4d773bf">00392</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__sched__info.html#acc805791ffcde2a1fadcf6c3d4d773bf">ibs_cpt</a>;        <span class="comment">/* CPT id */</span>
<a name="l00393"></a>00393 };
<a name="l00394"></a>00394 
<a name="l00395"></a><a class="code" href="structkib__data__t.html">00395</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00396"></a>00396 {
<a name="l00397"></a><a class="code" href="structkib__data__t.html#a1fd9e3ec22401eca5c163d70db9aeca8">00397</a>         <span class="keywordtype">int</span>                     kib_init;       <span class="comment">/* initialisation state */</span>
<a name="l00398"></a><a class="code" href="structkib__data__t.html#a44e5c368bc17bf00aa07e06b3de8fd4b">00398</a>         <span class="keywordtype">int</span>                     kib_shutdown;   <span class="comment">/* shut down? */</span>
<a name="l00399"></a><a class="code" href="structkib__data__t.html#a3f075be93982f6db7ebe5de2f4ec433f">00399</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_devs;       <span class="comment">/* IB devices extant */</span>
<a name="l00400"></a>00400         <span class="comment">/* list head of failed devices */</span>
<a name="l00401"></a><a class="code" href="structkib__data__t.html#aa9b1c936628c1c38c76a06559b5e5d52">00401</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_failed_devs;
<a name="l00402"></a>00402         <span class="comment">/* schedulers sleep here */</span>
<a name="l00403"></a><a class="code" href="structkib__data__t.html#a823f66cd6f73c86b690a2da5cee568d2">00403</a>         wait_queue_head_t       kib_failover_waitq;
<a name="l00404"></a><a class="code" href="structkib__data__t.html#a060796d709a3a426309749e9bad237f9">00404</a>         atomic_t                kib_nthreads;   <span class="comment">/* # live threads */</span>
<a name="l00405"></a>00405         <span class="comment">/* stabilize net/dev/peer/conn ops */</span>
<a name="l00406"></a><a class="code" href="structkib__data__t.html#ac8174b7515d196b0eb6542baa4089923">00406</a>         rwlock_t                kib_global_lock;
<a name="l00407"></a>00407         <span class="comment">/* hash table of all my known peers */</span>
<a name="l00408"></a><a class="code" href="structkib__data__t.html#ab0fa27b076c0091375d8b95a7ecd1e8f">00408</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        *kib_peers;
<a name="l00409"></a>00409         <span class="comment">/* size of kib_peers */</span>
<a name="l00410"></a><a class="code" href="structkib__data__t.html#afbba71a651a9efb339c788da05df23e1">00410</a>         <span class="keywordtype">int</span>                     kib_peer_hash_size;
<a name="l00411"></a>00411         <span class="comment">/* the connd task (serialisation assertions) */</span>
<a name="l00412"></a><a class="code" href="structkib__data__t.html#acbaaaf31ac0392f5396cb107e141aefb">00412</a>         <span class="keywordtype">void</span>                    *kib_connd;
<a name="l00413"></a>00413         <span class="comment">/* connections to setup/teardown */</span>
<a name="l00414"></a><a class="code" href="structkib__data__t.html#a4693cd3249c405a0033e056978d84875">00414</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_connd_conns;
<a name="l00415"></a>00415         <span class="comment">/* connections with zero refcount */</span>
<a name="l00416"></a><a class="code" href="structkib__data__t.html#a3cbaa1b4240adede85540a26e3c25871">00416</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_connd_zombies;
<a name="l00417"></a>00417         <span class="comment">/* connections to reconnect */</span>
<a name="l00418"></a><a class="code" href="structkib__data__t.html#ae7b1c1edabc22248992514687008b513">00418</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_reconn_list;
<a name="l00419"></a>00419         <span class="comment">/* peers wait for reconnection */</span>
<a name="l00420"></a><a class="code" href="structkib__data__t.html#a1e36ccd4a3ddeb09c73d73aa525b6fce">00420</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        kib_reconn_wait;
<a name="l00421"></a>00421         <span class="comment">/*</span>
<a name="l00422"></a>00422 <span class="comment">         * The second that peers are pulled out from \a kib_reconn_wait</span>
<a name="l00423"></a>00423 <span class="comment">         * for reconnection.</span>
<a name="l00424"></a>00424 <span class="comment">         */</span>
<a name="l00425"></a><a class="code" href="structkib__data__t.html#aa1fdae7f9b4612567fdcff88e89eba65">00425</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            kib_reconn_sec;
<a name="l00426"></a>00426         <span class="comment">/* connection daemon sleeps here */</span>
<a name="l00427"></a><a class="code" href="structkib__data__t.html#a40cabe8eeec7cf57977626fb6ac84480">00427</a>         wait_queue_head_t       kib_connd_waitq;
<a name="l00428"></a><a class="code" href="structkib__data__t.html#a10f6bb73182c78b521ac45db1c30ae6b">00428</a>         spinlock_t              kib_connd_lock; <span class="comment">/* serialise */</span>
<a name="l00429"></a><a class="code" href="structkib__data__t.html#a03f73d6edaa96d7492babad75f3b76a7">00429</a>         <span class="keyword">struct </span>ib_qp_attr       kib_error_qpa;  <span class="comment">/* QP-&gt;ERROR */</span>
<a name="l00430"></a>00430         <span class="comment">/* percpt data for schedulers */</span>
<a name="l00431"></a><a class="code" href="structkib__data__t.html#a92c0ff4aad4582125ac589d04345b2ba">00431</a>         <span class="keyword">struct </span><a class="code" href="structkib__sched__info.html">kib_sched_info</a>   **kib_scheds;
<a name="l00432"></a>00432 } <a class="code" href="structkib__data__t.html">kib_data_t</a>;
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="o2iblnd_8h.html#aa8394213efa75adb646dcd7467800911">00434</a> <span class="preprocessor">#define IBLND_INIT_NOTHING         0</span>
<a name="l00435"></a><a class="code" href="o2iblnd_8h.html#a10fffe4d43dd14ffef990a0851f9fb9d">00435</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_INIT_DATA            1</span>
<a name="l00436"></a><a class="code" href="o2iblnd_8h.html#a1c3f522ba7a238a49e30cf64b2f67748">00436</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_INIT_ALL             2</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span>
<a name="l00438"></a>00438 <span class="comment">/************************************************************************</span>
<a name="l00439"></a>00439 <span class="comment"> * IB Wire message format.</span>
<a name="l00440"></a>00440 <span class="comment"> * These are sent in sender&apos;s byte order (i.e. receiver flips).</span>
<a name="l00441"></a>00441 <span class="comment"> */</span>
<a name="l00442"></a>00442 
<a name="l00443"></a><a class="code" href="structkib__connparams.html">00443</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__connparams.html">kib_connparams</a>
<a name="l00444"></a>00444 {
<a name="l00445"></a><a class="code" href="structkib__connparams.html#aa4f90ec609f54b78eb6d77cd9cbb2691">00445</a>         __u16             <a class="code" href="structkib__connparams.html#aa4f90ec609f54b78eb6d77cd9cbb2691">ibcp_queue_depth</a>;
<a name="l00446"></a><a class="code" href="structkib__connparams.html#a709b78fc6f3a28ddbd0379c91a3d44f6">00446</a>         __u16             <a class="code" href="structkib__connparams.html#a709b78fc6f3a28ddbd0379c91a3d44f6">ibcp_max_frags</a>;
<a name="l00447"></a><a class="code" href="structkib__connparams.html#abff203ea699c9645c4c26234ff275e4c">00447</a>         __u32             <a class="code" href="structkib__connparams.html#abff203ea699c9645c4c26234ff275e4c">ibcp_max_msg_size</a>;
<a name="l00448"></a>00448 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> <a class="code" href="structkib__connparams.html">kib_connparams_t</a>;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00451"></a>00451 {
<a name="l00452"></a><a class="code" href="structWIRE__ATTR.html#ad893632b17a8f326cd8feb860c812f7f">00452</a>         lnet_hdr_t        ibim_hdr;             <span class="comment">/* portals header */</span>
<a name="l00453"></a><a class="code" href="structWIRE__ATTR.html#a94451a0e1e01fd163d663e7f49f38ead">00453</a>         <span class="keywordtype">char</span>              ibim_payload[0];      <span class="comment">/* piggy-backed payload */</span>
<a name="l00454"></a>00454 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_immediate_msg_t;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00457"></a>00457 {
<a name="l00458"></a><a class="code" href="structWIRE__ATTR.html#a7f0171fd4449fb0261a12cc558881317">00458</a>         __u32             rf_nob;               <span class="comment">/* # bytes this frag */</span>
<a name="l00459"></a><a class="code" href="structWIRE__ATTR.html#aabb02e630ad735679e2a28e6929c2858">00459</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             rf_addr;              <span class="comment">/* CAVEAT EMPTOR: misaligned!! */</span>
<a name="l00460"></a>00460 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_rdma_frag_t;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00463"></a>00463 {
<a name="l00464"></a><a class="code" href="structWIRE__ATTR.html#ac102890487828eb4c3eab7847e2e1d24">00464</a>         __u32             rd_key;               <span class="comment">/* local/remote key */</span>
<a name="l00465"></a><a class="code" href="structWIRE__ATTR.html#a014ae47d2759b662f06214fcea4e690b">00465</a>         __u32             rd_nfrags;            <span class="comment">/* # fragments */</span>
<a name="l00466"></a><a class="code" href="structWIRE__ATTR.html#aa442f0ec97970b5a1df349283023bf59">00466</a>         kib_rdma_frag_t   rd_frags[0];          <span class="comment">/* buffer frags */</span>
<a name="l00467"></a>00467 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_rdma_desc_t;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00470"></a>00470 {
<a name="l00471"></a><a class="code" href="structWIRE__ATTR.html#a4034faf49a1770bc020d7eb63868fcbb">00471</a>         lnet_hdr_t        ibprm_hdr;            <span class="comment">/* portals header */</span>
<a name="l00472"></a><a class="code" href="structWIRE__ATTR.html#a90d5b4d89e7a147ec3c4113268b2f91f">00472</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibprm_cookie;         <span class="comment">/* opaque completion cookie */</span>
<a name="l00473"></a>00473 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_putreq_msg_t;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00476"></a>00476 {
<a name="l00477"></a><a class="code" href="structWIRE__ATTR.html#aef1c706a35ad8bed7ed5bad00dbad17a">00477</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibpam_src_cookie;     <span class="comment">/* reflected completion cookie */</span>
<a name="l00478"></a><a class="code" href="structWIRE__ATTR.html#a20ce337ecd3ccb7ce132166afb2afa94">00478</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibpam_dst_cookie;     <span class="comment">/* opaque completion cookie */</span>
<a name="l00479"></a><a class="code" href="structWIRE__ATTR.html#a2da8fc7598e568b39500ebbefda272b4">00479</a>         kib_rdma_desc_t   ibpam_rd;             <span class="comment">/* sender&apos;s sink buffer */</span>
<a name="l00480"></a>00480 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_putack_msg_t;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00483"></a>00483 {
<a name="l00484"></a><a class="code" href="structWIRE__ATTR.html#a6d40a9b9f9e3a2f2415581169b93d7d5">00484</a>         lnet_hdr_t        ibgm_hdr;             <span class="comment">/* portals header */</span>
<a name="l00485"></a><a class="code" href="structWIRE__ATTR.html#afe75b922e0c2420ab2e0735bfe3e8e8b">00485</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibgm_cookie;          <span class="comment">/* opaque completion cookie */</span>
<a name="l00486"></a><a class="code" href="structWIRE__ATTR.html#a45444334f3c2cfaa911304ba186211d0">00486</a>         kib_rdma_desc_t   ibgm_rd;              <span class="comment">/* rdma descriptor */</span>
<a name="l00487"></a>00487 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_get_msg_t;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00490"></a>00490 {
<a name="l00491"></a><a class="code" href="structWIRE__ATTR.html#a8a277f604d64e5f80f7a21f3c36602d3">00491</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibcm_cookie;          <span class="comment">/* opaque completion cookie */</span>
<a name="l00492"></a><a class="code" href="structWIRE__ATTR.html#ac43377b86428ce0bc7d7d72922af8f2e">00492</a>         __s32             ibcm_status;          <span class="comment">/* &lt; 0 failure: &gt;= 0 length */</span>
<a name="l00493"></a>00493 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_completion_msg_t;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497         <span class="comment">/* First 2 fields fixed FOR ALL TIME */</span>
<a name="l00498"></a><a class="code" href="structWIRE__ATTR.html#ad0ea84d2c049f299f01715c837892810">00498</a>         __u32             ibm_magic;            <span class="comment">/* I&apos;m an ibnal message */</span>
<a name="l00499"></a><a class="code" href="structWIRE__ATTR.html#a7a0697de11c248160632ed4e41ceb8ba">00499</a>         __u16             ibm_version;          <span class="comment">/* this is my version number */</span>
<a name="l00500"></a>00500 
<a name="l00501"></a><a class="code" href="structWIRE__ATTR.html#a87debd5e778aebc9ddd5e4523fb91457">00501</a>         __u8              ibm_type;             <span class="comment">/* msg type */</span>
<a name="l00502"></a><a class="code" href="structWIRE__ATTR.html#a815f2ab57ea72e2ed15caeca18c2afaf">00502</a>         __u8              ibm_credits;          <span class="comment">/* returned credits */</span>
<a name="l00503"></a><a class="code" href="structWIRE__ATTR.html#ab5d3575540a53b4b9848ce87e50b09fb">00503</a>         __u32             ibm_nob;              <span class="comment">/* # bytes in whole message */</span>
<a name="l00504"></a><a class="code" href="structWIRE__ATTR.html#ad7d79c60c4111ca07f0be764b3c1eaba">00504</a>         __u32             ibm_cksum;            <span class="comment">/* checksum (0 == no checksum) */</span>
<a name="l00505"></a><a class="code" href="structWIRE__ATTR.html#a24cbf019446371c6fb5898c9ae1a13f0">00505</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibm_srcnid;           <span class="comment">/* sender&apos;s NID */</span>
<a name="l00506"></a><a class="code" href="structWIRE__ATTR.html#ae665a33fcdaa1e98dddf18c58ac8015a">00506</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibm_srcstamp;         <span class="comment">/* sender&apos;s incarnation */</span>
<a name="l00507"></a><a class="code" href="structWIRE__ATTR.html#a412d4ef5ce9e440ff7bad1a70951eff8">00507</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibm_dstnid;           <span class="comment">/* destination&apos;s NID */</span>
<a name="l00508"></a><a class="code" href="structWIRE__ATTR.html#a3db6b61e85a75672345c8fb7e74a8d4e">00508</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>             ibm_dststamp;         <span class="comment">/* destination&apos;s incarnation */</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="keyword">union </span>{
<a name="l00511"></a><a class="code" href="structWIRE__ATTR.html#a88253ca83c1f0d9723e01d51c921abbc">00511</a>                 kib_connparams_t      connparams;
<a name="l00512"></a><a class="code" href="structWIRE__ATTR.html#ae9751f9fa3d0e6d66a899d3411e42400">00512</a>                 kib_immediate_msg_t   immediate;
<a name="l00513"></a><a class="code" href="structWIRE__ATTR.html#ac996b84964d82f5af293f12da458b4af">00513</a>                 kib_putreq_msg_t      putreq;
<a name="l00514"></a><a class="code" href="structWIRE__ATTR.html#af26ad2944adbe740d7c2e9374d648cd9">00514</a>                 kib_putack_msg_t      putack;
<a name="l00515"></a><a class="code" href="structWIRE__ATTR.html#a34105ea35eb302c1ecd753e24df9c2ca">00515</a>                 kib_get_msg_t         <span class="keyword">get</span>;
<a name="l00516"></a><a class="code" href="structWIRE__ATTR.html#adaabbe3516cc2908eb69e2cf29acbd98">00516</a>                 kib_completion_msg_t  completion;
<a name="l00517"></a>00517         } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> ibm_u;
<a name="l00518"></a>00518 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_msg_t;
<a name="l00519"></a>00519 
<a name="l00520"></a><a class="code" href="o2iblnd_8h.html#a7bfd5990c4d03ed8dfa29e0f717323f6">00520</a> <span class="preprocessor">#define IBLND_MSG_MAGIC LNET_PROTO_IB_MAGIC     </span><span class="comment">/* unique magic */</span>
<a name="l00521"></a>00521 
<a name="l00522"></a><a class="code" href="o2iblnd_8h.html#a60e7e63ad9bfc2b6216435d9e7aab163">00522</a> <span class="preprocessor">#define IBLND_MSG_VERSION_1         0x11</span>
<a name="l00523"></a><a class="code" href="o2iblnd_8h.html#a036f25bfb07e0dadc37569148ce488b5">00523</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_MSG_VERSION_2         0x12</span>
<a name="l00524"></a><a class="code" href="o2iblnd_8h.html#ababf9e8762063768a936efcd3c94ac55">00524</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_MSG_VERSION           IBLND_MSG_VERSION_2</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>
<a name="l00526"></a><a class="code" href="o2iblnd_8h.html#ad864ded42a4fe66ac5dd7f089ba7f6c4">00526</a> <span class="preprocessor">#define IBLND_MSG_CONNREQ           0xc0        </span><span class="comment">/* connection request */</span>
<a name="l00527"></a><a class="code" href="o2iblnd_8h.html#ab3e6c8cf451053e9dbadc13be69ca7f1">00527</a> <span class="preprocessor">#define IBLND_MSG_CONNACK           0xc1        </span><span class="comment">/* connection acknowledge */</span>
<a name="l00528"></a><a class="code" href="o2iblnd_8h.html#a8f196a8f9cfa789fa8beb6dc538b0a5f">00528</a> <span class="preprocessor">#define IBLND_MSG_NOOP              0xd0        </span><span class="comment">/* nothing (just credits) */</span>
<a name="l00529"></a><a class="code" href="o2iblnd_8h.html#a9f7f893a0fadc5f535f68179b297d9ed">00529</a> <span class="preprocessor">#define IBLND_MSG_IMMEDIATE         0xd1        </span><span class="comment">/* immediate */</span>
<a name="l00530"></a><a class="code" href="o2iblnd_8h.html#a400b5d1e61d9f12ac25c16530502ad73">00530</a> <span class="preprocessor">#define IBLND_MSG_PUT_REQ           0xd2        </span><span class="comment">/* putreq (src-&gt;sink) */</span>
<a name="l00531"></a><a class="code" href="o2iblnd_8h.html#aa5f3954b14fb84a92e19817d56ffe9ea">00531</a> <span class="preprocessor">#define IBLND_MSG_PUT_NAK           0xd3        </span><span class="comment">/* completion (sink-&gt;src) */</span>
<a name="l00532"></a><a class="code" href="o2iblnd_8h.html#a78efff95b4dc34c111963944ef5aad05">00532</a> <span class="preprocessor">#define IBLND_MSG_PUT_ACK           0xd4        </span><span class="comment">/* putack (sink-&gt;src) */</span>
<a name="l00533"></a><a class="code" href="o2iblnd_8h.html#a3c4647fb67b988e0c036fa45001d13b9">00533</a> <span class="preprocessor">#define IBLND_MSG_PUT_DONE          0xd5        </span><span class="comment">/* completion (src-&gt;sink) */</span>
<a name="l00534"></a><a class="code" href="o2iblnd_8h.html#a39935bd48aa9a8b7bcc244f0f4aeb6bb">00534</a> <span class="preprocessor">#define IBLND_MSG_GET_REQ           0xd6        </span><span class="comment">/* getreq (sink-&gt;src) */</span>
<a name="l00535"></a><a class="code" href="o2iblnd_8h.html#aaddead42ab748de151fffc8ec48030ed">00535</a> <span class="preprocessor">#define IBLND_MSG_GET_DONE          0xd7        </span><span class="comment">/* completion (src-&gt;sink: all OK) */</span>
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00538"></a><a class="code" href="structWIRE__ATTR.html#a67591376c0d94fd0755db85f636c5a59">00538</a>         __u32            ibr_magic;             <span class="comment">/* sender&apos;s magic */</span>
<a name="l00539"></a><a class="code" href="structWIRE__ATTR.html#a155d52bcbc3085823ea540978ba71130">00539</a>         __u16            ibr_version;           <span class="comment">/* sender&apos;s version */</span>
<a name="l00540"></a><a class="code" href="structWIRE__ATTR.html#a45c6069468f3204194eac7fcef56a928">00540</a>         __u8             ibr_why;               <span class="comment">/* reject reason */</span>
<a name="l00541"></a><a class="code" href="structWIRE__ATTR.html#ab5762dc4f1a3b9b216d7bdb2b7147d38">00541</a>         __u8             ibr_padding;           <span class="comment">/* padding */</span>
<a name="l00542"></a><a class="code" href="structWIRE__ATTR.html#a8df581862b85a0b7ccdc0c11dcfd26f2">00542</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>            ibr_incarnation;       <span class="comment">/* incarnation of peer */</span>
<a name="l00543"></a><a class="code" href="structWIRE__ATTR.html#a107f172ac433b1b48899be72927e869b">00543</a>         kib_connparams_t ibr_cp;                <span class="comment">/* connection parameters */</span>
<a name="l00544"></a>00544 } <a class="code" href="structWIRE__ATTR.html">WIRE_ATTR</a> kib_rej_t;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="comment">/* connection rejection reasons */</span>
<a name="l00547"></a><a class="code" href="o2iblnd_8h.html#aa4583d3c52bfcf9fe6763f94869b1913">00547</a> <span class="preprocessor">#define IBLND_REJECT_CONN_RACE       1          </span><span class="comment">/* You lost connection race */</span>
<a name="l00548"></a><a class="code" href="o2iblnd_8h.html#af45a9c36864ea348519cfa566237bf70">00548</a> <span class="preprocessor">#define IBLND_REJECT_NO_RESOURCES    2          </span><span class="comment">/* Out of memory/conns etc */</span>
<a name="l00549"></a><a class="code" href="o2iblnd_8h.html#a39ed61999f1966f824d5752baeca5f61">00549</a> <span class="preprocessor">#define IBLND_REJECT_FATAL           3          </span><span class="comment">/* Anything else */</span>
<a name="l00550"></a>00550 
<a name="l00551"></a><a class="code" href="o2iblnd_8h.html#a80fff3473b11d3bf18f70934ae00c2f5">00551</a> <span class="preprocessor">#define IBLND_REJECT_CONN_UNCOMPAT   4          </span><span class="comment">/* incompatible version peer */</span>
<a name="l00552"></a><a class="code" href="o2iblnd_8h.html#ab2667611d8f74147f8574e62a1f7641c">00552</a> <span class="preprocessor">#define IBLND_REJECT_CONN_STALE      5          </span><span class="comment">/* stale peer */</span>
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 <span class="comment">/* peer&apos;s rdma frags doesn&apos;t match mine */</span>
<a name="l00555"></a><a class="code" href="o2iblnd_8h.html#aa23c009a009f062f5ac9fe68e8e2a732">00555</a> <span class="preprocessor">#define IBLND_REJECT_RDMA_FRAGS      6</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span><span class="comment">/* peer&apos;s msg queue size doesn&apos;t match mine */</span>
<a name="l00557"></a><a class="code" href="o2iblnd_8h.html#a19b45f5f83a5093255ae35e3beccca3e">00557</a> <span class="preprocessor">#define IBLND_REJECT_MSG_QUEUE_SIZE  7</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span>
<a name="l00559"></a>00559 <span class="comment">/***********************************************************************/</span>
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="structkib__rx.html">00561</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__rx.html">kib_rx</a>                           <span class="comment">/* receive message */</span>
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563         <span class="comment">/* queue for attention */</span>
<a name="l00564"></a><a class="code" href="structkib__rx.html#a12ee60896d9611e5b4f808034f87c59e">00564</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__rx.html#a12ee60896d9611e5b4f808034f87c59e">rx_list</a>;
<a name="l00565"></a>00565         <span class="comment">/* owning conn */</span>
<a name="l00566"></a><a class="code" href="structkib__rx.html#a61ccd15d87f020d3b533221c685b6afd">00566</a>         <span class="keyword">struct </span><a class="code" href="structkib__conn.html">kib_conn</a>        *<a class="code" href="structkib__rx.html#a61ccd15d87f020d3b533221c685b6afd">rx_conn</a>;
<a name="l00567"></a>00567         <span class="comment">/* # bytes received (-1 while posted) */</span>
<a name="l00568"></a><a class="code" href="structkib__rx.html#a23a6b34d20abd4ec0e87d2fe31a1d642">00568</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__rx.html#a23a6b34d20abd4ec0e87d2fe31a1d642">rx_nob</a>;
<a name="l00569"></a>00569         <span class="comment">/* completion status */</span>
<a name="l00570"></a><a class="code" href="structkib__rx.html#ac2105584b3c3c23c483185f98281ee95">00570</a>         <span class="keyword">enum</span> ib_wc_status       <a class="code" href="structkib__rx.html#ac2105584b3c3c23c483185f98281ee95">rx_status</a>;
<a name="l00571"></a>00571         <span class="comment">/* message buffer (host vaddr) */</span>
<a name="l00572"></a><a class="code" href="structkib__rx.html#af8576a1ce49046d2da36630141bc24d2">00572</a>         kib_msg_t              *<a class="code" href="structkib__rx.html#af8576a1ce49046d2da36630141bc24d2">rx_msg</a>;
<a name="l00573"></a>00573         <span class="comment">/* message buffer (I/O addr) */</span>
<a name="l00574"></a><a class="code" href="structkib__rx.html#ad1851eee3d56f9227eb97134bd74579e">00574</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__rx.html#ad1851eee3d56f9227eb97134bd74579e">rx_msgaddr</a>;
<a name="l00575"></a>00575         <span class="comment">/* for dma_unmap_single() */</span>
<a name="l00576"></a>00576         <a class="code" href="structkib__rx.html#a2e88ee80cbb2d2cbefb8cc5a852b8e04">DECLARE_PCI_UNMAP_ADDR</a>(rx_msgunmap);
<a name="l00577"></a>00577         <span class="comment">/* receive work item... */</span>
<a name="l00578"></a><a class="code" href="structkib__rx.html#a72ce5e0add0d5e9a04cdb1b69d22be4c">00578</a>         <span class="keyword">struct </span>ib_recv_wr       <a class="code" href="structkib__rx.html#a72ce5e0add0d5e9a04cdb1b69d22be4c">rx_wrq</a>;
<a name="l00579"></a>00579         <span class="comment">/* ...and its memory */</span>
<a name="l00580"></a><a class="code" href="structkib__rx.html#a16f8c1824d3ad480fcbd07c067984e0f">00580</a>         <span class="keyword">struct </span>ib_sge           <a class="code" href="structkib__rx.html#a16f8c1824d3ad480fcbd07c067984e0f">rx_sge</a>;
<a name="l00581"></a>00581 } <a class="code" href="structkib__rx.html">kib_rx_t</a>;
<a name="l00582"></a>00582 
<a name="l00583"></a><a class="code" href="o2iblnd_8h.html#a4bf4186bc7cd3b489e0ce5c3300e680b">00583</a> <span class="preprocessor">#define IBLND_POSTRX_DONT_POST    0             </span><span class="comment">/* don&apos;t post */</span>
<a name="l00584"></a><a class="code" href="o2iblnd_8h.html#a0584bda9c25513e4b83d1d89d4fc201b">00584</a> <span class="preprocessor">#define IBLND_POSTRX_NO_CREDIT    1             </span><span class="comment">/* post: no credits */</span>
<a name="l00585"></a><a class="code" href="o2iblnd_8h.html#a46e0b89fd9937d3a526bdb5265b24f47">00585</a> <span class="preprocessor">#define IBLND_POSTRX_PEER_CREDIT  2             </span><span class="comment">/* post: give peer back 1 credit */</span>
<a name="l00586"></a><a class="code" href="o2iblnd_8h.html#a29b8420b5341f91741f5a080fa7a659d">00586</a> <span class="preprocessor">#define IBLND_POSTRX_RSRVD_CREDIT 3             </span><span class="comment">/* post: give myself back 1 reserved credit */</span>
<a name="l00587"></a>00587 
<a name="l00588"></a><a class="code" href="structkib__tx.html">00588</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__tx.html">kib_tx</a>                           <span class="comment">/* transmit message */</span>
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590         <span class="comment">/* queue on idle_txs ibc_tx_queue etc. */</span>
<a name="l00591"></a><a class="code" href="structkib__tx.html#afcf07424130dd935d10b059efae95464">00591</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__tx.html#afcf07424130dd935d10b059efae95464">tx_list</a>;
<a name="l00592"></a>00592         <span class="comment">/* pool I&apos;m from */</span>
<a name="l00593"></a><a class="code" href="structkib__tx.html#a68dd1ab7f015e25d7e8c6b140be71f8b">00593</a>         <a class="code" href="structkib__tx__pool__t.html">kib_tx_pool_t</a>           *<a class="code" href="structkib__tx.html#a68dd1ab7f015e25d7e8c6b140be71f8b">tx_pool</a>;
<a name="l00594"></a>00594         <span class="comment">/* owning conn */</span>
<a name="l00595"></a><a class="code" href="structkib__tx.html#ad1a7b60f0f6e3927e16afbe6e2507004">00595</a>         <span class="keyword">struct </span><a class="code" href="structkib__conn.html">kib_conn</a>         *<a class="code" href="structkib__tx.html#ad1a7b60f0f6e3927e16afbe6e2507004">tx_conn</a>;
<a name="l00596"></a>00596         <span class="comment">/* # tx callbacks outstanding */</span>
<a name="l00597"></a><a class="code" href="structkib__tx.html#a0dea8245005d6b5946183afd1b828d21">00597</a>         <span class="keywordtype">short</span>                   <a class="code" href="structkib__tx.html#a0dea8245005d6b5946183afd1b828d21">tx_sending</a>;
<a name="l00598"></a>00598         <span class="comment">/* queued for sending */</span>
<a name="l00599"></a><a class="code" href="structkib__tx.html#a6ad4797b0166061521904a1b1fde239c">00599</a>         <span class="keywordtype">short</span>                   <a class="code" href="structkib__tx.html#a6ad4797b0166061521904a1b1fde239c">tx_queued</a>;
<a name="l00600"></a>00600         <span class="comment">/* waiting for peer */</span>
<a name="l00601"></a><a class="code" href="structkib__tx.html#ab35a8ce81ca0c568b5e8ad10b2bb3cdd">00601</a>         <span class="keywordtype">short</span>                   <a class="code" href="structkib__tx.html#ab35a8ce81ca0c568b5e8ad10b2bb3cdd">tx_waiting</a>;
<a name="l00602"></a>00602         <span class="comment">/* LNET completion status */</span>
<a name="l00603"></a><a class="code" href="structkib__tx.html#a7adbfd9757ab3ee9f98b3c5ad6d46c95">00603</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__tx.html#a7adbfd9757ab3ee9f98b3c5ad6d46c95">tx_status</a>;
<a name="l00604"></a>00604         <span class="comment">/* completion deadline */</span>
<a name="l00605"></a><a class="code" href="structkib__tx.html#ab0dd6427c8285d0c1044964f36a2255d">00605</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           <a class="code" href="structkib__tx.html#ab0dd6427c8285d0c1044964f36a2255d">tx_deadline</a>;
<a name="l00606"></a>00606         <span class="comment">/* completion cookie */</span>
<a name="l00607"></a><a class="code" href="structkib__tx.html#a0bd882c2ee1cf5023d8dc52fba196d19">00607</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__tx.html#a0bd882c2ee1cf5023d8dc52fba196d19">tx_cookie</a>;
<a name="l00608"></a>00608         <span class="comment">/* lnet msgs to finalize on completion */</span>
<a name="l00609"></a><a class="code" href="structkib__tx.html#af636754fe0c45378705cbb9c8137b9a4">00609</a>         <a class="code" href="structlnet__msg.html">lnet_msg_t</a>              *<a class="code" href="structkib__tx.html#af636754fe0c45378705cbb9c8137b9a4">tx_lntmsg</a>[2];
<a name="l00610"></a>00610         <span class="comment">/* message buffer (host vaddr) */</span>
<a name="l00611"></a><a class="code" href="structkib__tx.html#a5549a22facce0e629776d4bbcbc9c0d4">00611</a>         kib_msg_t               *<a class="code" href="structkib__tx.html#a5549a22facce0e629776d4bbcbc9c0d4">tx_msg</a>;
<a name="l00612"></a>00612         <span class="comment">/* message buffer (I/O addr) */</span>
<a name="l00613"></a><a class="code" href="structkib__tx.html#afdaae7c21fdc1ace8827d2488c823b25">00613</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__tx.html#afdaae7c21fdc1ace8827d2488c823b25">tx_msgaddr</a>;
<a name="l00614"></a>00614         <span class="comment">/* for dma_unmap_single() */</span>
<a name="l00615"></a>00615         <a class="code" href="structkib__tx.html#a7d8d82b1bf323f904145604f44967917">DECLARE_PCI_UNMAP_ADDR</a>(tx_msgunmap);
<a name="l00616"></a>00616         <span class="comment">/* # send work items */</span>
<a name="l00617"></a><a class="code" href="structkib__tx.html#a80480ed155472002ee030818c2003e7d">00617</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__tx.html#a80480ed155472002ee030818c2003e7d">tx_nwrq</a>;
<a name="l00618"></a>00618         <span class="comment">/* send work items... */</span>
<a name="l00619"></a><a class="code" href="structkib__tx.html#a5d1c362ee19b1bf3ef753c7f68a4c43e">00619</a>         <span class="keyword">struct </span><a class="code" href="structib__rdma__wr.html">ib_rdma_wr</a>       *<a class="code" href="structkib__tx.html#a5d1c362ee19b1bf3ef753c7f68a4c43e">tx_wrq</a>;
<a name="l00620"></a>00620         <span class="comment">/* ...and their memory */</span>
<a name="l00621"></a><a class="code" href="structkib__tx.html#a3c36c2e0ed581c93eeb2437978081e9e">00621</a>         <span class="keyword">struct </span>ib_sge           *<a class="code" href="structkib__tx.html#a3c36c2e0ed581c93eeb2437978081e9e">tx_sge</a>;
<a name="l00622"></a>00622         <span class="comment">/* rdma descriptor */</span>
<a name="l00623"></a><a class="code" href="structkib__tx.html#a1d9565edae4ca973ab255071436ff9b3">00623</a>         kib_rdma_desc_t         *<a class="code" href="structkib__tx.html#a1d9565edae4ca973ab255071436ff9b3">tx_rd</a>;
<a name="l00624"></a>00624         <span class="comment">/* # entries in... */</span>
<a name="l00625"></a><a class="code" href="structkib__tx.html#ac32b3d23f16264059f7377d09e184006">00625</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__tx.html#ac32b3d23f16264059f7377d09e184006">tx_nfrags</a>;
<a name="l00626"></a>00626         <span class="comment">/* dma_map_sg descriptor */</span>
<a name="l00627"></a><a class="code" href="structkib__tx.html#acaeef3d0e5fb5dad46df318ba0d17004">00627</a>         <span class="keyword">struct </span>scatterlist      *<a class="code" href="structkib__tx.html#acaeef3d0e5fb5dad46df318ba0d17004">tx_frags</a>;
<a name="l00628"></a>00628         <span class="comment">/* rdma phys page addrs */</span>
<a name="l00629"></a><a class="code" href="structkib__tx.html#ac4d456884ccb93d4ea84e7fdbe0444b4">00629</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   *<a class="code" href="structkib__tx.html#ac4d456884ccb93d4ea84e7fdbe0444b4">tx_pages</a>;
<a name="l00630"></a>00630         <span class="comment">/* FMR */</span>
<a name="l00631"></a><a class="code" href="structkib__tx.html#a69e37e1bb55320260feba0e6835fd5cd">00631</a>         <a class="code" href="structkib__fmr__t.html">kib_fmr_t</a>               <a class="code" href="structkib__tx.html#a69e37e1bb55320260feba0e6835fd5cd">fmr</a>;
<a name="l00632"></a>00632                                 <span class="comment">/* dma direction */</span>
<a name="l00633"></a><a class="code" href="structkib__tx.html#ad079b670b85b993a86bc5f99c5dd3cfb">00633</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__tx.html#ad079b670b85b993a86bc5f99c5dd3cfb">tx_dmadir</a>;
<a name="l00634"></a>00634 } <a class="code" href="structkib__tx.html">kib_tx_t</a>;
<a name="l00635"></a>00635 
<a name="l00636"></a><a class="code" href="structkib__connvars.html">00636</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__connvars.html">kib_connvars</a>
<a name="l00637"></a>00637 {
<a name="l00638"></a>00638         <span class="comment">/* connection-in-progress variables */</span>
<a name="l00639"></a><a class="code" href="structkib__connvars.html#ad8ee9d2ddc5819031e612701044f2a93">00639</a>         kib_msg_t                 <a class="code" href="structkib__connvars.html#ad8ee9d2ddc5819031e612701044f2a93">cv_msg</a>;
<a name="l00640"></a>00640 } <a class="code" href="structkib__connvars.html">kib_connvars_t</a>;
<a name="l00641"></a>00641 
<a name="l00642"></a><a class="code" href="structkib__conn.html">00642</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__conn.html">kib_conn</a>
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644         <span class="comment">/* scheduler information */</span>
<a name="l00645"></a><a class="code" href="structkib__conn.html#a77a03e1b13bddc732ef3083d82361223">00645</a>         <span class="keyword">struct </span><a class="code" href="structkib__sched__info.html">kib_sched_info</a>   *<a class="code" href="structkib__conn.html#a77a03e1b13bddc732ef3083d82361223">ibc_sched</a>;
<a name="l00646"></a>00646         <span class="comment">/* owning peer */</span>
<a name="l00647"></a><a class="code" href="structkib__conn.html#adcc0b910e81ffce86217950b7eacd5be">00647</a>         <span class="keyword">struct </span><a class="code" href="structkib__peer.html">kib_peer</a>         *<a class="code" href="structkib__conn.html#adcc0b910e81ffce86217950b7eacd5be">ibc_peer</a>;
<a name="l00648"></a>00648         <span class="comment">/* HCA bound on */</span>
<a name="l00649"></a><a class="code" href="structkib__conn.html#acf9504b5e55ea37f1f075cfe723ef600">00649</a>         <a class="code" href="structkib__hca__dev.html">kib_hca_dev_t</a>           *<a class="code" href="structkib__conn.html#acf9504b5e55ea37f1f075cfe723ef600">ibc_hdev</a>;
<a name="l00650"></a>00650         <span class="comment">/* stash on peer&apos;s conn list */</span>
<a name="l00651"></a><a class="code" href="structkib__conn.html#afc0990e2b7bb834277e90c3c5e461c65">00651</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#afc0990e2b7bb834277e90c3c5e461c65">ibc_list</a>;
<a name="l00652"></a>00652         <span class="comment">/* schedule for attention */</span>
<a name="l00653"></a><a class="code" href="structkib__conn.html#a229ac50426a4b1d12eb5e009e7cfbd13">00653</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#a229ac50426a4b1d12eb5e009e7cfbd13">ibc_sched_list</a>;
<a name="l00654"></a>00654         <span class="comment">/* version of connection */</span>
<a name="l00655"></a><a class="code" href="structkib__conn.html#a2e93cee99f84042eb33820898ee295eb">00655</a>         __u16                   <a class="code" href="structkib__conn.html#a2e93cee99f84042eb33820898ee295eb">ibc_version</a>;
<a name="l00656"></a>00656         <span class="comment">/* reconnect later */</span>
<a name="l00657"></a><a class="code" href="structkib__conn.html#a0f8c856be5cfa08a926c614f1a641cb7">00657</a>         __u16                   <a class="code" href="structkib__conn.html#a0f8c856be5cfa08a926c614f1a641cb7">ibc_reconnect</a>:1;
<a name="l00658"></a>00658         <span class="comment">/* which instance of the peer */</span>
<a name="l00659"></a><a class="code" href="structkib__conn.html#a9f15594934747b123f575b35f0c2a959">00659</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__conn.html#a9f15594934747b123f575b35f0c2a959">ibc_incarnation</a>;
<a name="l00660"></a>00660         <span class="comment">/* # users */</span>
<a name="l00661"></a><a class="code" href="structkib__conn.html#acd832d480b8358837ca58873e646ccfb">00661</a>         atomic_t                <a class="code" href="structkib__conn.html#acd832d480b8358837ca58873e646ccfb">ibc_refcount</a>;
<a name="l00662"></a>00662         <span class="comment">/* what&apos;s happening */</span>
<a name="l00663"></a><a class="code" href="structkib__conn.html#abadb072909c2011fd143fd8b6d3a47b6">00663</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#abadb072909c2011fd143fd8b6d3a47b6">ibc_state</a>;
<a name="l00664"></a>00664         <span class="comment">/* # uncompleted sends */</span>
<a name="l00665"></a><a class="code" href="structkib__conn.html#a9be95e5cdc9058b725fc0a6107baeae7">00665</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#a9be95e5cdc9058b725fc0a6107baeae7">ibc_nsends_posted</a>;
<a name="l00666"></a>00666         <span class="comment">/* # uncompleted NOOPs */</span>
<a name="l00667"></a><a class="code" href="structkib__conn.html#a2339f6f0b274279bded4514634025e74">00667</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#a2339f6f0b274279bded4514634025e74">ibc_noops_posted</a>;
<a name="l00668"></a>00668         <span class="comment">/* # credits I have */</span>
<a name="l00669"></a><a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">00669</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">ibc_credits</a>;
<a name="l00670"></a>00670         <span class="comment">/* # credits to return */</span>
<a name="l00671"></a><a class="code" href="structkib__conn.html#a474438810f85e5502af3f08548371f57">00671</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#a474438810f85e5502af3f08548371f57">ibc_outstanding_credits</a>;
<a name="l00672"></a>00672         <span class="comment">/* # ACK/DONE msg credits */</span>
<a name="l00673"></a><a class="code" href="structkib__conn.html#afec74d1d2af7e795f27f2a823371ac27">00673</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#afec74d1d2af7e795f27f2a823371ac27">ibc_reserved_credits</a>;
<a name="l00674"></a>00674         <span class="comment">/* set on comms error */</span>
<a name="l00675"></a><a class="code" href="structkib__conn.html#ace29ba68f7edcce23a5abef2182032cd">00675</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__conn.html#ace29ba68f7edcce23a5abef2182032cd">ibc_comms_error</a>;
<a name="l00676"></a>00676         <span class="comment">/* connections queue depth */</span>
<a name="l00677"></a><a class="code" href="structkib__conn.html#ad3e7b217c1cc540046f1323c1c2226c0">00677</a>         __u16                   <a class="code" href="structkib__conn.html#ad3e7b217c1cc540046f1323c1c2226c0">ibc_queue_depth</a>;
<a name="l00678"></a>00678         <span class="comment">/* connections max frags */</span>
<a name="l00679"></a><a class="code" href="structkib__conn.html#a8027fe94230ef462e9ec61fea4c11072">00679</a>         __u16                   <a class="code" href="structkib__conn.html#a8027fe94230ef462e9ec61fea4c11072">ibc_max_frags</a>;
<a name="l00680"></a>00680         <span class="comment">/* receive buffers owned */</span>
<a name="l00681"></a><a class="code" href="structkib__conn.html#a25d131daaca660fdf9c15350ac09a3f8">00681</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            <a class="code" href="structkib__conn.html#a25d131daaca660fdf9c15350ac09a3f8">ibc_nrx</a>:16;
<a name="l00682"></a>00682         <span class="comment">/* scheduled for attention */</span>
<a name="l00683"></a><a class="code" href="structkib__conn.html#a8d99864de7d51ef7a318c1e4d16c1f88">00683</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            <a class="code" href="structkib__conn.html#a8d99864de7d51ef7a318c1e4d16c1f88">ibc_scheduled</a>:1;
<a name="l00684"></a>00684         <span class="comment">/* CQ callback fired */</span>
<a name="l00685"></a><a class="code" href="structkib__conn.html#a5857220a5c65696da758956be51b113b">00685</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            <a class="code" href="structkib__conn.html#a5857220a5c65696da758956be51b113b">ibc_ready</a>:1;
<a name="l00686"></a>00686         <span class="comment">/* time of last send */</span>
<a name="l00687"></a><a class="code" href="structkib__conn.html#ab10da72d7604fca52eb5f6ebbd62d722">00687</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           <a class="code" href="structkib__conn.html#ab10da72d7604fca52eb5f6ebbd62d722">ibc_last_send</a>;
<a name="l00689"></a><a class="code" href="structkib__conn.html#afbb52ce10b4f3f6edc66af4e64dad484">00689</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#afbb52ce10b4f3f6edc66af4e64dad484" title="link chain for kiblnd_check_conns only">ibc_connd_list</a>;
<a name="l00691"></a><a class="code" href="structkib__conn.html#ac0ecaeaf7a7a88832002dd12deee1ddd">00691</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#ac0ecaeaf7a7a88832002dd12deee1ddd" title="rxs completed before ESTABLISHED">ibc_early_rxs</a>;
<a name="l00693"></a><a class="code" href="structkib__conn.html#a027aeb52a90ed82eec68a95d1f46b706">00693</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#a027aeb52a90ed82eec68a95d1f46b706" title="IBLND_MSG_NOOPs for IBLND_MSG_VERSION_1.">ibc_tx_noops</a>;
<a name="l00694"></a>00694         <span class="comment">/* sends that need a credit */</span>
<a name="l00695"></a><a class="code" href="structkib__conn.html#a746875caf1b9c14484ddd3f96345aa04">00695</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#a746875caf1b9c14484ddd3f96345aa04">ibc_tx_queue</a>;
<a name="l00696"></a>00696         <span class="comment">/* sends that don&apos;t need a credit */</span>
<a name="l00697"></a><a class="code" href="structkib__conn.html#ac1350cb97ae337590cedb803df61df87">00697</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#ac1350cb97ae337590cedb803df61df87">ibc_tx_queue_nocred</a>;
<a name="l00698"></a>00698         <span class="comment">/* sends that need to reserve an ACK/DONE msg */</span>
<a name="l00699"></a><a class="code" href="structkib__conn.html#a3e0317bff1194d3a555898e2184d0df9">00699</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#a3e0317bff1194d3a555898e2184d0df9">ibc_tx_queue_rsrvd</a>;
<a name="l00700"></a>00700         <span class="comment">/* active tx awaiting completion */</span>
<a name="l00701"></a><a class="code" href="structkib__conn.html#ac614292ebaa215db61f70d3a9258cb02">00701</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__conn.html#ac614292ebaa215db61f70d3a9258cb02">ibc_active_txs</a>;
<a name="l00702"></a>00702         <span class="comment">/* serialise */</span>
<a name="l00703"></a><a class="code" href="structkib__conn.html#a215ba138a32f2ab53ad589b8719d4daf">00703</a>         spinlock_t              <a class="code" href="structkib__conn.html#a215ba138a32f2ab53ad589b8719d4daf">ibc_lock</a>;
<a name="l00704"></a>00704         <span class="comment">/* the rx descs */</span>
<a name="l00705"></a><a class="code" href="structkib__conn.html#ade384289d6bc60d4c4e14ea813c19088">00705</a>         <a class="code" href="structkib__rx.html">kib_rx_t</a>                *<a class="code" href="structkib__conn.html#ade384289d6bc60d4c4e14ea813c19088">ibc_rxs</a>;
<a name="l00706"></a>00706         <span class="comment">/* premapped rx msg pages */</span>
<a name="l00707"></a><a class="code" href="structkib__conn.html#a7a59d69cea6a53ef23e2de17986af6b4">00707</a>         <a class="code" href="structkib__pages__t.html">kib_pages_t</a>             *<a class="code" href="structkib__conn.html#a7a59d69cea6a53ef23e2de17986af6b4">ibc_rx_pages</a>;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709         <span class="comment">/* CM id */</span>
<a name="l00710"></a><a class="code" href="structkib__conn.html#a0f69a737923231ed3e377d57c871fb0a">00710</a>         <span class="keyword">struct </span>rdma_cm_id       *<a class="code" href="structkib__conn.html#a0f69a737923231ed3e377d57c871fb0a">ibc_cmid</a>;
<a name="l00711"></a>00711         <span class="comment">/* completion queue */</span>
<a name="l00712"></a><a class="code" href="structkib__conn.html#a55dff1d00b59b73a2134887d694d17ff">00712</a>         <span class="keyword">struct </span>ib_cq            *<a class="code" href="structkib__conn.html#a55dff1d00b59b73a2134887d694d17ff">ibc_cq</a>;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         <span class="comment">/* in-progress connection state */</span>
<a name="l00715"></a><a class="code" href="structkib__conn.html#a1b61b30316e6b7b966f1ee8e08a6a510">00715</a>         <a class="code" href="structkib__connvars.html">kib_connvars_t</a>          *<a class="code" href="structkib__conn.html#a1b61b30316e6b7b966f1ee8e08a6a510">ibc_connvars</a>;
<a name="l00716"></a>00716 } <a class="code" href="structkib__conn.html">kib_conn_t</a>;
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="o2iblnd_8h.html#af103378d821333cfb6ba520488196008">00718</a> <span class="preprocessor">#define IBLND_CONN_INIT               0         </span><span class="comment">/* being initialised */</span>
<a name="l00719"></a><a class="code" href="o2iblnd_8h.html#a5908a416313f0e294778e46a68f13d72">00719</a> <span class="preprocessor">#define IBLND_CONN_ACTIVE_CONNECT     1         </span><span class="comment">/* active sending req */</span>
<a name="l00720"></a><a class="code" href="o2iblnd_8h.html#a141019300d1220829e9fd874f5cdb1af">00720</a> <span class="preprocessor">#define IBLND_CONN_PASSIVE_WAIT       2         </span><span class="comment">/* passive waiting for rtu */</span>
<a name="l00721"></a><a class="code" href="o2iblnd_8h.html#ae1dddb7820ca524a0e71b36123256eb4">00721</a> <span class="preprocessor">#define IBLND_CONN_ESTABLISHED        3         </span><span class="comment">/* connection established */</span>
<a name="l00722"></a><a class="code" href="o2iblnd_8h.html#a3f7e6fcc840c358b96e590b44658007b">00722</a> <span class="preprocessor">#define IBLND_CONN_CLOSING            4         </span><span class="comment">/* being closed */</span>
<a name="l00723"></a><a class="code" href="o2iblnd_8h.html#aea1af7af3b74ed9b390a2d8e3daa9856">00723</a> <span class="preprocessor">#define IBLND_CONN_DISCONNECTED       5         </span><span class="comment">/* disconnected */</span>
<a name="l00724"></a>00724 
<a name="l00725"></a><a class="code" href="structkib__peer.html">00725</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structkib__peer.html">kib_peer</a>
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727         <span class="comment">/* stash on global peer list */</span>
<a name="l00728"></a><a class="code" href="structkib__peer.html#a0443230e6b92ef57f56b1a3d7347fb40">00728</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__peer.html#a0443230e6b92ef57f56b1a3d7347fb40">ibp_list</a>;
<a name="l00729"></a>00729         <span class="comment">/* who&apos;s on the other end(s) */</span>
<a name="l00730"></a><a class="code" href="structkib__peer.html#a2396b1f5ab900e6701050cf919931cf0">00730</a>         <a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a>              <a class="code" href="structkib__peer.html#a2396b1f5ab900e6701050cf919931cf0">ibp_nid</a>;
<a name="l00731"></a>00731         <span class="comment">/* LNet interface */</span>
<a name="l00732"></a><a class="code" href="structkib__peer.html#a85be999909ad9dd974727502ce3cb723">00732</a>         <a class="code" href="structlnet__ni.html">lnet_ni_t</a>               *<a class="code" href="structkib__peer.html#a85be999909ad9dd974727502ce3cb723">ibp_ni</a>;
<a name="l00733"></a>00733         <span class="comment">/* all active connections */</span>
<a name="l00734"></a><a class="code" href="structkib__peer.html#aa5617f146446108b919448e0830e28c0">00734</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__peer.html#aa5617f146446108b919448e0830e28c0">ibp_conns</a>;
<a name="l00735"></a>00735         <span class="comment">/* msgs waiting for a conn */</span>
<a name="l00736"></a><a class="code" href="structkib__peer.html#aef5f6bfdd690fb47c9412658a18d2cdc">00736</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structkib__peer.html#aef5f6bfdd690fb47c9412658a18d2cdc">ibp_tx_queue</a>;
<a name="l00737"></a>00737         <span class="comment">/* incarnation of peer */</span>
<a name="l00738"></a><a class="code" href="structkib__peer.html#a2aafb9858cb0df3bd2449281f03a1ad7">00738</a>         <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>                   <a class="code" href="structkib__peer.html#a2aafb9858cb0df3bd2449281f03a1ad7">ibp_incarnation</a>;
<a name="l00739"></a>00739         <span class="comment">/* when (in jiffies) I was last alive */</span>
<a name="l00740"></a><a class="code" href="structkib__peer.html#a8043fbe6caf1a195b593fe9574fd311b">00740</a>         <a class="code" href="linux-time_8h.html#a0e81d053bc8d925f6574c760bbea5ac4">cfs_time_t</a>              <a class="code" href="structkib__peer.html#a8043fbe6caf1a195b593fe9574fd311b">ibp_last_alive</a>;
<a name="l00741"></a>00741         <span class="comment">/* # users */</span>
<a name="l00742"></a><a class="code" href="structkib__peer.html#a864e4e6a114df3254a74d56375c3b6a6">00742</a>         atomic_t                <a class="code" href="structkib__peer.html#a864e4e6a114df3254a74d56375c3b6a6">ibp_refcount</a>;
<a name="l00743"></a>00743         <span class="comment">/* version of peer */</span>
<a name="l00744"></a><a class="code" href="structkib__peer.html#a153ca7badf3a911bdf4bc78fc6a4041f">00744</a>         __u16                   <a class="code" href="structkib__peer.html#a153ca7badf3a911bdf4bc78fc6a4041f">ibp_version</a>;
<a name="l00745"></a>00745         <span class="comment">/* current passive connection attempts */</span>
<a name="l00746"></a><a class="code" href="structkib__peer.html#a34ccf58ed6f9c80148eaa1481dd12e1d">00746</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          <a class="code" href="structkib__peer.html#a34ccf58ed6f9c80148eaa1481dd12e1d">ibp_accepting</a>;
<a name="l00747"></a>00747         <span class="comment">/* current active connection attempts */</span>
<a name="l00748"></a><a class="code" href="structkib__peer.html#a2138747d7da5118d89dbd27ca0f83a5d">00748</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          <a class="code" href="structkib__peer.html#a2138747d7da5118d89dbd27ca0f83a5d">ibp_connecting</a>;
<a name="l00749"></a>00749         <span class="comment">/* reconnect this peer later */</span>
<a name="l00750"></a><a class="code" href="structkib__peer.html#ae94b0e681adb67639f53825a8a8e6825">00750</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          <a class="code" href="structkib__peer.html#ae94b0e681adb67639f53825a8a8e6825">ibp_reconnecting</a>:1;
<a name="l00751"></a>00751         <span class="comment">/* # consecutive reconnection attempts to this peer */</span>
<a name="l00752"></a><a class="code" href="structkib__peer.html#a243ee945fc3e922554a73cc7f3ebfd1a">00752</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>            <a class="code" href="structkib__peer.html#a243ee945fc3e922554a73cc7f3ebfd1a">ibp_reconnected</a>;
<a name="l00753"></a>00753         <span class="comment">/* errno on closing this peer */</span>
<a name="l00754"></a><a class="code" href="structkib__peer.html#a84bfb608188a1a50c8bbd0a449c82f32">00754</a>         <span class="keywordtype">int</span>                     <a class="code" href="structkib__peer.html#a84bfb608188a1a50c8bbd0a449c82f32">ibp_error</a>;
<a name="l00755"></a>00755         <span class="comment">/* max map_on_demand */</span>
<a name="l00756"></a><a class="code" href="structkib__peer.html#af1e3d72e3bfaeb683ea266c8d21b075c">00756</a>         __u16                   <a class="code" href="structkib__peer.html#af1e3d72e3bfaeb683ea266c8d21b075c">ibp_max_frags</a>;
<a name="l00757"></a>00757         <span class="comment">/* max_peer_credits */</span>
<a name="l00758"></a><a class="code" href="structkib__peer.html#a94d0c83a617ead6807ae4f9ad3b088cd">00758</a>         __u16                   <a class="code" href="structkib__peer.html#a94d0c83a617ead6807ae4f9ad3b088cd">ibp_queue_depth</a>;
<a name="l00759"></a>00759 } <a class="code" href="structkib__peer.html">kib_peer_t</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="preprocessor">#ifndef HAVE_IB_INC_RKEY</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>
<a name="l00767"></a><a class="code" href="o2iblnd_8h.html#abbffac3088d6ed9d4e33443f5eae55c3">00767</a> <span class="keyword">static</span> <span class="keyword">inline</span> u32 <a class="code" href="o2iblnd_8h.html#abbffac3088d6ed9d4e33443f5eae55c3" title="ib_inc_rkey - increments the key portion of the given rkey.">ib_inc_rkey</a>(u32 rkey)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769         <span class="keyword">const</span> u32 mask = 0x000000ff;
<a name="l00770"></a>00770         <span class="keywordflow">return</span> ((rkey + 1) &amp; mask) | (rkey &amp; ~mask);
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 <span class="preprocessor">#endif</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>
<a name="l00774"></a>00774 <span class="keyword">extern</span> <a class="code" href="structkib__data__t.html">kib_data_t</a>      <a class="code" href="o2iblnd_8c.html#a6f450074ce375544db2686483eee8d5a">kiblnd_data</a>;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#ab3164e0ae9717b81b3929ab842b57825">kiblnd_hdev_destroy</a>(<a class="code" href="structkib__hca__dev.html">kib_hca_dev_t</a> *hdev);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="keywordtype">int</span> <a class="code" href="o2iblnd_8h.html#aab0b8b39344af685140a1ca342e25610">kiblnd_msg_queue_size</a>(<span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>, <span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="comment">/* max # of fragments configured by user */</span>
<a name="l00781"></a>00781 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00782"></a><a class="code" href="o2iblnd_8h.html#a711a90f40eca1d00944bf9ee2f022b85">00782</a> <a class="code" href="o2iblnd_8h.html#a711a90f40eca1d00944bf9ee2f022b85">kiblnd_cfg_rdma_frags</a>(<span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni)
<a name="l00783"></a>00783 {
<a name="l00784"></a>00784         <span class="keyword">struct </span><a class="code" href="structlnet__ioctl__config__o2iblnd__tunables.html">lnet_ioctl_config_o2iblnd_tunables</a> *tunables;
<a name="l00785"></a>00785         <span class="keywordtype">int</span> mod;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         tunables = &amp;ni-&gt;<a class="code" href="structlnet__ni.html#a51f668728b5005d7dca9f645d647f3de">ni_lnd_tunables</a>-&gt;<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#ad76fc2e0062fa5ed6b46948903d994b2">lt_tun_u</a>.<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#a6c90b19f2844097cf833c616a88db71b">lt_o2ib</a>;
<a name="l00788"></a>00788         mod = tunables-&gt;<a class="code" href="structlnet__ioctl__config__o2iblnd__tunables.html#acc6a4c22be3be43f9169c6c3ee0c5fa7">lnd_map_on_demand</a>;
<a name="l00789"></a>00789         <span class="keywordflow">return</span> mod != 0 ? mod : <a class="code" href="o2iblnd_8h.html#aa1d72a0430435e010f8eb84893421d50">IBLND_MAX_RDMA_FRAGS</a>;
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00793"></a><a class="code" href="o2iblnd_8h.html#a824aa2b2a74430f671e2318eb1b0dfb4">00793</a> <a class="code" href="o2iblnd_8h.html#a824aa2b2a74430f671e2318eb1b0dfb4">kiblnd_rdma_frags</a>(<span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>, <span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni)
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795         <span class="keywordflow">return</span> version == <a class="code" href="o2iblnd_8h.html#a60e7e63ad9bfc2b6216435d9e7aab163">IBLND_MSG_VERSION_1</a> ?
<a name="l00796"></a>00796           <a class="code" href="o2iblnd_8h.html#aa1d72a0430435e010f8eb84893421d50">IBLND_MAX_RDMA_FRAGS</a> :
<a name="l00797"></a>00797           <a class="code" href="o2iblnd_8h.html#a711a90f40eca1d00944bf9ee2f022b85">kiblnd_cfg_rdma_frags</a>(ni);
<a name="l00798"></a>00798 }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00801"></a><a class="code" href="o2iblnd_8h.html#a89443820801bce8f5532b70c57908617">00801</a> <a class="code" href="o2iblnd_8h.html#a89443820801bce8f5532b70c57908617">kiblnd_concurrent_sends</a>(<span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>, <span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni)
<a name="l00802"></a>00802 {
<a name="l00803"></a>00803         <span class="keyword">struct </span><a class="code" href="structlnet__ioctl__config__o2iblnd__tunables.html">lnet_ioctl_config_o2iblnd_tunables</a> *tunables;
<a name="l00804"></a>00804         <span class="keywordtype">int</span> <a class="code" href="gnilnd__modparams_8c.html#a01f168819c9acc398a26ca17ae769df8">concurrent_sends</a>;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         tunables = &amp;ni-&gt;<a class="code" href="structlnet__ni.html#a51f668728b5005d7dca9f645d647f3de">ni_lnd_tunables</a>-&gt;<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#ad76fc2e0062fa5ed6b46948903d994b2">lt_tun_u</a>.<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#a6c90b19f2844097cf833c616a88db71b">lt_o2ib</a>;
<a name="l00807"></a>00807         concurrent_sends = tunables-&gt;<a class="code" href="structlnet__ioctl__config__o2iblnd__tunables.html#a4b5b317a602def7e33da0634e912f62d">lnd_concurrent_sends</a>;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         <span class="keywordflow">if</span> (version == <a class="code" href="o2iblnd_8h.html#a60e7e63ad9bfc2b6216435d9e7aab163">IBLND_MSG_VERSION_1</a>) {
<a name="l00810"></a>00810                 <span class="keywordflow">if</span> (concurrent_sends &gt; <a class="code" href="o2iblnd_8h.html#a01bb739a54d77884a2e32265d45ebc93">IBLND_MSG_QUEUE_SIZE_V1</a> * 2)
<a name="l00811"></a>00811                         <span class="keywordflow">return</span> <a class="code" href="o2iblnd_8h.html#a01bb739a54d77884a2e32265d45ebc93">IBLND_MSG_QUEUE_SIZE_V1</a> * 2;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813                 <span class="keywordflow">if</span> (concurrent_sends &lt; <a class="code" href="o2iblnd_8h.html#a01bb739a54d77884a2e32265d45ebc93">IBLND_MSG_QUEUE_SIZE_V1</a> / 2)
<a name="l00814"></a>00814                         <span class="keywordflow">return</span> <a class="code" href="o2iblnd_8h.html#a01bb739a54d77884a2e32265d45ebc93">IBLND_MSG_QUEUE_SIZE_V1</a> / 2;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         <span class="keywordflow">return</span> concurrent_sends;
<a name="l00818"></a>00818 }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00821"></a><a class="code" href="o2iblnd_8h.html#ae3ad61144467b9141cba413153b09dca">00821</a> <a class="code" href="o2iblnd_8h.html#ae3ad61144467b9141cba413153b09dca">kiblnd_hdev_addref_locked</a>(<a class="code" href="structkib__hca__dev.html">kib_hca_dev_t</a> *hdev)
<a name="l00822"></a>00822 {
<a name="l00823"></a>00823         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(atomic_read(&amp;hdev-&gt;<a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">ibh_ref</a>) &gt; 0);
<a name="l00824"></a>00824         atomic_inc(&amp;hdev-&gt;<a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">ibh_ref</a>);
<a name="l00825"></a>00825 }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00828"></a><a class="code" href="o2iblnd_8h.html#aa9a255b08fc9bc990f6a802ecc02a219">00828</a> <a class="code" href="o2iblnd_8h.html#aa9a255b08fc9bc990f6a802ecc02a219">kiblnd_hdev_decref</a>(<a class="code" href="structkib__hca__dev.html">kib_hca_dev_t</a> *hdev)
<a name="l00829"></a>00829 {
<a name="l00830"></a>00830         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(atomic_read(&amp;hdev-&gt;<a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">ibh_ref</a>) &gt; 0);
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (atomic_dec_and_test(&amp;hdev-&gt;<a class="code" href="structkib__hca__dev.html#af18a116df546ad2c8cd1d1ec54faba6a">ibh_ref</a>))
<a name="l00832"></a>00832                 <a class="code" href="o2iblnd_8c.html#ab3164e0ae9717b81b3929ab842b57825">kiblnd_hdev_destroy</a>(hdev);
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00836"></a><a class="code" href="o2iblnd_8h.html#a1c2fcaaecf09aaf68caeab5bd03c74a1">00836</a> <a class="code" href="o2iblnd_8h.html#a1c2fcaaecf09aaf68caeab5bd03c74a1">kiblnd_dev_can_failover</a>(<a class="code" href="structkib__dev__t.html">kib_dev_t</a> *dev)
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838         <span class="keywordflow">if</span> (!<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;dev-&gt;<a class="code" href="structkib__dev__t.html#af846dbd904fc79a5c54d5fb1b3a71f2c">ibd_fail_list</a>)) <span class="comment">/* already scheduled */</span>
<a name="l00839"></a>00839                 <span class="keywordflow">return</span> 0;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         <span class="keywordflow">if</span> (*kiblnd_tunables.<a class="code" href="structkib__tunables__t.html#a28c39d00c8f3c0d40b2b2db8a3b23969">kib_dev_failover</a> == 0) <span class="comment">/* disabled */</span>
<a name="l00842"></a>00842                 <span class="keywordflow">return</span> 0;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844         <span class="keywordflow">if</span> (*kiblnd_tunables.<a class="code" href="structkib__tunables__t.html#a28c39d00c8f3c0d40b2b2db8a3b23969">kib_dev_failover</a> &gt; 1) <span class="comment">/* force failover */</span>
<a name="l00845"></a>00845                 <span class="keywordflow">return</span> 1;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="keywordflow">return</span> dev-&gt;<a class="code" href="structkib__dev__t.html#a3c28e616bf93fe0670b8498173ba8941">ibd_can_failover</a>;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="o2iblnd_8h.html#a5cb7cf74a2ff4cfa061a59b4b30d16f6">00850</a> <span class="preprocessor">#define kiblnd_conn_addref(conn)                                \</span>
<a name="l00851"></a>00851 <span class="preprocessor">do {                                                            \</span>
<a name="l00852"></a>00852 <span class="preprocessor">        CDEBUG(D_NET, &quot;conn[%p] (%d)++\n&quot;,                      \</span>
<a name="l00853"></a>00853 <span class="preprocessor">               (conn), atomic_read(&amp;(conn)-&gt;ibc_refcount)); \</span>
<a name="l00854"></a>00854 <span class="preprocessor">        atomic_inc(&amp;(conn)-&gt;ibc_refcount);                  \</span>
<a name="l00855"></a>00855 <span class="preprocessor">} while (0)</span>
<a name="l00856"></a>00856 <span class="preprocessor"></span>
<a name="l00857"></a><a class="code" href="o2iblnd_8h.html#afe551e26660a934a60521434222c3580">00857</a> <span class="preprocessor">#define kiblnd_conn_decref(conn)                                        \</span>
<a name="l00858"></a>00858 <span class="preprocessor">do {                                                                    \</span>
<a name="l00859"></a>00859 <span class="preprocessor">        unsigned long flags;                                            \</span>
<a name="l00860"></a>00860 <span class="preprocessor">                                                                        \</span>
<a name="l00861"></a>00861 <span class="preprocessor">        CDEBUG(D_NET, &quot;conn[%p] (%d)--\n&quot;,                              \</span>
<a name="l00862"></a>00862 <span class="preprocessor">               (conn), atomic_read(&amp;(conn)-&gt;ibc_refcount));             \</span>
<a name="l00863"></a>00863 <span class="preprocessor">        LASSERT_ATOMIC_POS(&amp;(conn)-&gt;ibc_refcount);                      \</span>
<a name="l00864"></a>00864 <span class="preprocessor">        if (atomic_dec_and_test(&amp;(conn)-&gt;ibc_refcount)) {               \</span>
<a name="l00865"></a>00865 <span class="preprocessor">                spin_lock_irqsave(&amp;kiblnd_data.kib_connd_lock, flags);  \</span>
<a name="l00866"></a>00866 <span class="preprocessor">                list_add_tail(&amp;(conn)-&gt;ibc_list,                        \</span>
<a name="l00867"></a>00867 <span class="preprocessor">                                  &amp;kiblnd_data.kib_connd_zombies);      \</span>
<a name="l00868"></a>00868 <span class="preprocessor">                wake_up(&amp;kiblnd_data.kib_connd_waitq);          \</span>
<a name="l00869"></a>00869 <span class="preprocessor">                spin_unlock_irqrestore(&amp;kiblnd_data.kib_connd_lock, flags);\</span>
<a name="l00870"></a>00870 <span class="preprocessor">        }                                                               \</span>
<a name="l00871"></a>00871 <span class="preprocessor">} while (0)</span>
<a name="l00872"></a>00872 <span class="preprocessor"></span>
<a name="l00873"></a><a class="code" href="o2iblnd_8h.html#a4616d6abb18c97d0045feaeab88b5ece">00873</a> <span class="preprocessor">#define kiblnd_peer_addref(peer)                                \</span>
<a name="l00874"></a>00874 <span class="preprocessor">do {                                                            \</span>
<a name="l00875"></a>00875 <span class="preprocessor">        CDEBUG(D_NET, &quot;peer[%p] -&gt; %s (%d)++\n&quot;,                \</span>
<a name="l00876"></a>00876 <span class="preprocessor">               (peer), libcfs_nid2str((peer)-&gt;ibp_nid),         \</span>
<a name="l00877"></a>00877 <span class="preprocessor">               atomic_read (&amp;(peer)-&gt;ibp_refcount));            \</span>
<a name="l00878"></a>00878 <span class="preprocessor">        atomic_inc(&amp;(peer)-&gt;ibp_refcount);                      \</span>
<a name="l00879"></a>00879 <span class="preprocessor">} while (0)</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span>
<a name="l00881"></a><a class="code" href="o2iblnd_8h.html#ac1e1e177c31951bc3a67a873b7f6f5aa">00881</a> <span class="preprocessor">#define kiblnd_peer_decref(peer)                                \</span>
<a name="l00882"></a>00882 <span class="preprocessor">do {                                                            \</span>
<a name="l00883"></a>00883 <span class="preprocessor">        CDEBUG(D_NET, &quot;peer[%p] -&gt; %s (%d)--\n&quot;,                \</span>
<a name="l00884"></a>00884 <span class="preprocessor">               (peer), libcfs_nid2str((peer)-&gt;ibp_nid),         \</span>
<a name="l00885"></a>00885 <span class="preprocessor">               atomic_read (&amp;(peer)-&gt;ibp_refcount));            \</span>
<a name="l00886"></a>00886 <span class="preprocessor">        LASSERT_ATOMIC_POS(&amp;(peer)-&gt;ibp_refcount);              \</span>
<a name="l00887"></a>00887 <span class="preprocessor">        if (atomic_dec_and_test(&amp;(peer)-&gt;ibp_refcount))         \</span>
<a name="l00888"></a>00888 <span class="preprocessor">                kiblnd_destroy_peer(peer);                      \</span>
<a name="l00889"></a>00889 <span class="preprocessor">} while (0)</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>
<a name="l00891"></a>00891 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span>
<a name="l00892"></a><a class="code" href="o2iblnd_8h.html#a2908e6b43cb820f9f0a1c8aab8c78d2c">00892</a> <a class="code" href="o2iblnd_8h.html#a2908e6b43cb820f9f0a1c8aab8c78d2c">kiblnd_peer_connecting</a>(<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894         <span class="keywordflow">return</span> peer-&gt;<a class="code" href="structkib__peer.html#a2138747d7da5118d89dbd27ca0f83a5d">ibp_connecting</a> != 0 ||
<a name="l00895"></a>00895                peer-&gt;<a class="code" href="structkib__peer.html#ae94b0e681adb67639f53825a8a8e6825">ibp_reconnecting</a> != 0 ||
<a name="l00896"></a>00896                peer-&gt;<a class="code" href="structkib__peer.html#a34ccf58ed6f9c80148eaa1481dd12e1d">ibp_accepting</a> != 0;
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span>
<a name="l00900"></a><a class="code" href="o2iblnd_8h.html#a00af34437530d071e02c81b341518c81">00900</a> <a class="code" href="o2iblnd_8h.html#a00af34437530d071e02c81b341518c81">kiblnd_peer_idle</a>(<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer)
<a name="l00901"></a>00901 {
<a name="l00902"></a>00902         <span class="keywordflow">return</span> !<a class="code" href="o2iblnd_8h.html#a2908e6b43cb820f9f0a1c8aab8c78d2c">kiblnd_peer_connecting</a>(peer) &amp;&amp; <a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;peer-&gt;<a class="code" href="structkib__peer.html#aa5617f146446108b919448e0830e28c0">ibp_conns</a>);
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> *
<a name="l00906"></a><a class="code" href="o2iblnd_8h.html#a5d9fe4fd41679681534d93b3f77b5d8e">00906</a> <a class="code" href="o2iblnd_8h.html#a5d9fe4fd41679681534d93b3f77b5d8e">kiblnd_nid2peerlist</a> (<a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a> nid)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hash =
<a name="l00909"></a>00909                 ((<span class="keywordtype">unsigned</span> int)nid) % kiblnd_data.<a class="code" href="structkib__data__t.html#afbba71a651a9efb339c788da05df23e1">kib_peer_hash_size</a>;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911         <span class="keywordflow">return</span> &amp;kiblnd_data.<a class="code" href="structkib__data__t.html#ab0fa27b076c0091375d8b95a7ecd1e8f">kib_peers</a>[hash];
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00915"></a><a class="code" href="o2iblnd_8h.html#ab00138e8d5e10ada929487438ebb9791">00915</a> <a class="code" href="o2iblnd_8h.html#ab00138e8d5e10ada929487438ebb9791">kiblnd_peer_active</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer)
<a name="l00916"></a>00916 {
<a name="l00917"></a>00917         <span class="comment">/* Am I in the peer hash table? */</span>
<a name="l00918"></a>00918         <span class="keywordflow">return</span> !<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;peer-&gt;<a class="code" href="structkib__peer.html#a0443230e6b92ef57f56b1a3d7347fb40">ibp_list</a>);
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structkib__conn.html">kib_conn_t</a> *
<a name="l00922"></a><a class="code" href="o2iblnd_8h.html#a0b0909661e930d2d4aaea6eed53a0df3">00922</a> <a class="code" href="o2iblnd_8h.html#a0b0909661e930d2d4aaea6eed53a0df3">kiblnd_get_conn_locked</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(!<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;peer-&gt;<a class="code" href="structkib__peer.html#aa5617f146446108b919448e0830e28c0">ibp_conns</a>));
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         <span class="comment">/* just return the first connection */</span>
<a name="l00927"></a>00927         <span class="keywordflow">return</span> <a class="code" href="list_8h.html#a26c976b7f654e70df318c1843e5094de" title="Get the container of a list.">list_entry</a>(peer-&gt;<a class="code" href="structkib__peer.html#aa5617f146446108b919448e0830e28c0">ibp_conns</a>.<a class="code" href="structlist__head.html#ac3b0ff0dfb978a0cfbdad6b9d19cdcfe">next</a>, <a class="code" href="structkib__conn.html">kib_conn_t</a>, ibc_list);
<a name="l00928"></a>00928 }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00931"></a><a class="code" href="o2iblnd_8h.html#a365f4169a66492aeef74de2d1ec75c36">00931</a> <a class="code" href="o2iblnd_8h.html#a365f4169a66492aeef74de2d1ec75c36">kiblnd_send_keepalive</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn)
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933         <span class="keywordflow">return</span> (*kiblnd_tunables.<a class="code" href="structkib__tunables__t.html#ace391c9a4d5b90594bb4fba5cf7119ae">kib_keepalive</a> &gt; 0) &amp;&amp;
<a name="l00934"></a>00934                 <a class="code" href="libcfs__time_8h.html#a0360532d9634e175156c6ee7287a45a5">cfs_time_after</a>(jiffies, conn-&gt;<a class="code" href="structkib__conn.html#ab10da72d7604fca52eb5f6ebbd62d722">ibc_last_send</a> +
<a name="l00935"></a>00935                                msecs_to_jiffies(*kiblnd_tunables.<a class="code" href="structkib__tunables__t.html#ace391c9a4d5b90594bb4fba5cf7119ae">kib_keepalive</a> *
<a name="l00936"></a>00936                                                 MSEC_PER_SEC));
<a name="l00937"></a>00937 }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00940"></a><a class="code" href="o2iblnd_8h.html#a191d5c5fad93dd1ee2b9a9c0b6efa06c">00940</a> <a class="code" href="o2iblnd_8h.html#a191d5c5fad93dd1ee2b9a9c0b6efa06c">kiblnd_need_noop</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn)
<a name="l00941"></a>00941 {
<a name="l00942"></a>00942         <a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni = conn-&gt;<a class="code" href="structkib__conn.html#adcc0b910e81ffce86217950b7eacd5be">ibc_peer</a>-&gt;<a class="code" href="structkib__peer.html#a85be999909ad9dd974727502ce3cb723">ibp_ni</a>;
<a name="l00943"></a>00943         <span class="keyword">struct </span><a class="code" href="structlnet__ioctl__config__o2iblnd__tunables.html">lnet_ioctl_config_o2iblnd_tunables</a> *tunables;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a>(conn-&gt;<a class="code" href="structkib__conn.html#abadb072909c2011fd143fd8b6d3a47b6">ibc_state</a> &gt;= <a class="code" href="o2iblnd_8h.html#ae1dddb7820ca524a0e71b36123256eb4">IBLND_CONN_ESTABLISHED</a>);
<a name="l00946"></a>00946         tunables = &amp;ni-&gt;<a class="code" href="structlnet__ni.html#a51f668728b5005d7dca9f645d647f3de">ni_lnd_tunables</a>-&gt;<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#ad76fc2e0062fa5ed6b46948903d994b2">lt_tun_u</a>.<a class="code" href="structlnet__ioctl__config__lnd__tunables.html#a6c90b19f2844097cf833c616a88db71b">lt_o2ib</a>;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structkib__conn.html#a474438810f85e5502af3f08548371f57">ibc_outstanding_credits</a> &lt;
<a name="l00949"></a>00949             <a class="code" href="o2iblnd_8h.html#a857dd81441a17520c5670f5df068364b">IBLND_CREDITS_HIGHWATER</a>(tunables, conn-&gt;<a class="code" href="structkib__conn.html#a2e93cee99f84042eb33820898ee295eb">ibc_version</a>) &amp;&amp;
<a name="l00950"></a>00950             !<a class="code" href="o2iblnd_8h.html#a365f4169a66492aeef74de2d1ec75c36">kiblnd_send_keepalive</a>(conn))
<a name="l00951"></a>00951                 <span class="keywordflow">return</span> 0; <span class="comment">/* No need to send NOOP */</span>
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (<a class="code" href="o2iblnd_8h.html#a92e29daa81985bba27cddd0f20939132">IBLND_OOB_CAPABLE</a>(conn-&gt;<a class="code" href="structkib__conn.html#a2e93cee99f84042eb33820898ee295eb">ibc_version</a>)) {
<a name="l00954"></a>00954                 <span class="keywordflow">if</span> (!<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;conn-&gt;<a class="code" href="structkib__conn.html#ac1350cb97ae337590cedb803df61df87">ibc_tx_queue_nocred</a>))
<a name="l00955"></a>00955                         <span class="keywordflow">return</span> 0; <span class="comment">/* NOOP can be piggybacked */</span>
<a name="l00956"></a>00956 
<a name="l00957"></a>00957                 <span class="comment">/* No tx to piggyback NOOP onto or no credit to send a tx */</span>
<a name="l00958"></a>00958                 <span class="keywordflow">return</span> (<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;conn-&gt;<a class="code" href="structkib__conn.html#a746875caf1b9c14484ddd3f96345aa04">ibc_tx_queue</a>) ||
<a name="l00959"></a>00959                         conn-&gt;<a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">ibc_credits</a> == 0);
<a name="l00960"></a>00960         }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         <span class="keywordflow">if</span> (!<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;conn-&gt;<a class="code" href="structkib__conn.html#a027aeb52a90ed82eec68a95d1f46b706" title="IBLND_MSG_NOOPs for IBLND_MSG_VERSION_1.">ibc_tx_noops</a>) || <span class="comment">/* NOOP already queued */</span>
<a name="l00963"></a>00963             !<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;conn-&gt;<a class="code" href="structkib__conn.html#ac1350cb97ae337590cedb803df61df87">ibc_tx_queue_nocred</a>) || <span class="comment">/* piggyback NOOP */</span>
<a name="l00964"></a>00964             conn-&gt;<a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">ibc_credits</a> == 0)                    <span class="comment">/* no credit */</span>
<a name="l00965"></a>00965                 <span class="keywordflow">return</span> 0;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967         <span class="keywordflow">if</span> (conn-&gt;<a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">ibc_credits</a> == 1 &amp;&amp;      <span class="comment">/* last credit reserved for */</span>
<a name="l00968"></a>00968             conn-&gt;<a class="code" href="structkib__conn.html#a474438810f85e5502af3f08548371f57">ibc_outstanding_credits</a> == 0) <span class="comment">/* giving back credits */</span>
<a name="l00969"></a>00969                 <span class="keywordflow">return</span> 0;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         <span class="comment">/* No tx to piggyback NOOP onto or no credit to send a tx */</span>
<a name="l00972"></a>00972         <span class="keywordflow">return</span> (<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;conn-&gt;<a class="code" href="structkib__conn.html#a746875caf1b9c14484ddd3f96345aa04">ibc_tx_queue</a>) || conn-&gt;<a class="code" href="structkib__conn.html#a1ff9a025ec965ad264bea523abe4af6c">ibc_credits</a> == 1);
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00976"></a><a class="code" href="o2iblnd_8h.html#a7f90d3dbc0e4b718063af47b4e4d54c5">00976</a> <a class="code" href="o2iblnd_8h.html#a7f90d3dbc0e4b718063af47b4e4d54c5">kiblnd_abort_receives</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn)
<a name="l00977"></a>00977 {
<a name="l00978"></a>00978         ib_modify_qp(conn-&gt;<a class="code" href="structkib__conn.html#a0f69a737923231ed3e377d57c871fb0a">ibc_cmid</a>-&gt;qp,
<a name="l00979"></a>00979                      &amp;kiblnd_data.<a class="code" href="structkib__data__t.html#a03f73d6edaa96d7492babad75f3b76a7">kib_error_qpa</a>, IB_QP_STATE);
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00983"></a><a class="code" href="o2iblnd_8h.html#aeeba858e74d288ca0132c72889df78e8">00983</a> <a class="code" href="o2iblnd_8h.html#aeeba858e74d288ca0132c72889df78e8">kiblnd_queue2str</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn, <span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *q)
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985         <span class="keywordflow">if</span> (q == &amp;conn-&gt;<a class="code" href="structkib__conn.html#a746875caf1b9c14484ddd3f96345aa04">ibc_tx_queue</a>)
<a name="l00986"></a>00986                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;tx_queue&quot;</span>;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="keywordflow">if</span> (q == &amp;conn-&gt;<a class="code" href="structkib__conn.html#a3e0317bff1194d3a555898e2184d0df9">ibc_tx_queue_rsrvd</a>)
<a name="l00989"></a>00989                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;tx_queue_rsrvd&quot;</span>;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (q == &amp;conn-&gt;<a class="code" href="structkib__conn.html#ac1350cb97ae337590cedb803df61df87">ibc_tx_queue_nocred</a>)
<a name="l00992"></a>00992                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;tx_queue_nocred&quot;</span>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         <span class="keywordflow">if</span> (q == &amp;conn-&gt;<a class="code" href="structkib__conn.html#ac614292ebaa215db61f70d3a9258cb02">ibc_active_txs</a>)
<a name="l00995"></a>00995                 <span class="keywordflow">return</span> <span class="stringliteral">&quot;active_txs&quot;</span>;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <a class="code" href="libcfs__private_8h.html#a08eceadb65d1adcf8c198cff27081d5f">LBUG</a>();
<a name="l00998"></a>00998         <span class="keywordflow">return</span> NULL;
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="comment">/* CAVEAT EMPTOR: We rely on descriptor alignment to allow us to use the</span>
<a name="l01002"></a>01002 <span class="comment"> * lowest bits of the work request id to stash the work item type. */</span>
<a name="l01003"></a>01003 
<a name="l01004"></a><a class="code" href="o2iblnd_8h.html#aa08d4c49541a25aa5d753ce1d68fd90a">01004</a> <span class="preprocessor">#define IBLND_WID_INVAL 0</span>
<a name="l01005"></a><a class="code" href="o2iblnd_8h.html#a11e0fba5773634724070ab67461eeb56">01005</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_WID_TX    1</span>
<a name="l01006"></a><a class="code" href="o2iblnd_8h.html#a60477e2ec04fa7bc6c91f2b29bd4b950">01006</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_WID_RX    2</span>
<a name="l01007"></a><a class="code" href="o2iblnd_8h.html#a18922ef2b7e43c664bd71a55cf95fc62">01007</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_WID_RDMA  3</span>
<a name="l01008"></a><a class="code" href="o2iblnd_8h.html#aa002f1c42c3302cf12b719ff59120e80">01008</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_WID_MR    4</span>
<a name="l01009"></a><a class="code" href="o2iblnd_8h.html#a117d0f3b69ca6bcd3aa3a56cd439e9a7">01009</a> <span class="preprocessor"></span><span class="preprocessor">#define IBLND_WID_MASK  7UL</span>
<a name="l01010"></a>01010 <span class="preprocessor"></span>
<a name="l01011"></a>01011 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>
<a name="l01012"></a><a class="code" href="o2iblnd_8h.html#a47c5e375c622de04c0afbaa93ec0ab28">01012</a> <a class="code" href="o2iblnd_8h.html#a47c5e375c622de04c0afbaa93ec0ab28">kiblnd_ptr2wreqid</a> (<span class="keywordtype">void</span> *ptr, <span class="keywordtype">int</span> type)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lptr = (<span class="keywordtype">unsigned</span> long)ptr;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a> ((lptr &amp; <a class="code" href="o2iblnd_8h.html#a117d0f3b69ca6bcd3aa3a56cd439e9a7">IBLND_WID_MASK</a>) == 0);
<a name="l01017"></a>01017         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a> ((type &amp; ~IBLND_WID_MASK) == 0);
<a name="l01018"></a>01018         <span class="keywordflow">return</span> (<a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>)(lptr | type);
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> *
<a name="l01022"></a><a class="code" href="o2iblnd_8h.html#ad4c1b391bab5f3ccee4a78e1b961f5ec">01022</a> <a class="code" href="o2iblnd_8h.html#ad4c1b391bab5f3ccee4a78e1b961f5ec">kiblnd_wreqid2ptr</a> (<a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> wreqid)
<a name="l01023"></a>01023 {
<a name="l01024"></a>01024         <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)(((<span class="keywordtype">unsigned</span> long)wreqid) &amp; ~<a class="code" href="o2iblnd_8h.html#a117d0f3b69ca6bcd3aa3a56cd439e9a7">IBLND_WID_MASK</a>);
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01028"></a><a class="code" href="o2iblnd_8h.html#a8b105adba7f8724ad66c2cb3871e2b4d">01028</a> <a class="code" href="o2iblnd_8h.html#a8b105adba7f8724ad66c2cb3871e2b4d">kiblnd_wreqid2type</a> (<a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> wreqid)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030         <span class="keywordflow">return</span> (wreqid &amp; <a class="code" href="o2iblnd_8h.html#a117d0f3b69ca6bcd3aa3a56cd439e9a7">IBLND_WID_MASK</a>);
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01034"></a><a class="code" href="o2iblnd_8h.html#a4497efbb95515878455fd9b2f262968f">01034</a> <a class="code" href="o2iblnd_8h.html#a4497efbb95515878455fd9b2f262968f">kiblnd_set_conn_state</a> (<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn, <span class="keywordtype">int</span> <a class="code" href="fsx_8c.html#a5797ba50831ee71f60588abd75d2992e">state</a>)
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036         conn-&gt;<a class="code" href="structkib__conn.html#abadb072909c2011fd143fd8b6d3a47b6">ibc_state</a> = state;
<a name="l01037"></a>01037         smp_mb();
<a name="l01038"></a>01038 }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01041"></a><a class="code" href="o2iblnd_8h.html#a9078920112d143437776ad5a9184a981">01041</a> <a class="code" href="o2iblnd_8h.html#a9078920112d143437776ad5a9184a981">kiblnd_init_msg</a> (kib_msg_t *<a class="code" href="multiop_8c.html#afbbc03d010d4a43d0dcc0ef3c41de5ec">msg</a>, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> body_nob)
<a name="l01042"></a>01042 {
<a name="l01043"></a>01043         msg-&gt;ibm_type = type;
<a name="l01044"></a>01044         msg-&gt;ibm_nob  = <a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(kib_msg_t, ibm_u) + body_nob;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01048"></a><a class="code" href="o2iblnd_8h.html#a81e82e8a1d66620f17211cfa6d67acbc">01048</a> <a class="code" href="o2iblnd_8h.html#a81e82e8a1d66620f17211cfa6d67acbc">kiblnd_rd_size</a> (kib_rdma_desc_t *rd)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050         <span class="keywordtype">int</span>   i;
<a name="l01051"></a>01051         <span class="keywordtype">int</span>   <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="keywordflow">for</span> (i = size = 0; i &lt; rd-&gt;rd_nfrags; i++)
<a name="l01054"></a>01054                 size += rd-&gt;rd_frags[i].rf_nob;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="keywordflow">return</span> size;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>
<a name="l01060"></a><a class="code" href="o2iblnd_8h.html#aa591641503aeb131606f817ae3850ca7">01060</a> <a class="code" href="o2iblnd_8h.html#aa591641503aeb131606f817ae3850ca7">kiblnd_rd_frag_addr</a>(kib_rdma_desc_t *rd, <span class="keywordtype">int</span> index)
<a name="l01061"></a>01061 {
<a name="l01062"></a>01062         <span class="keywordflow">return</span> rd-&gt;rd_frags[index].rf_addr;
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 <span class="keyword">static</span> <span class="keyword">inline</span> __u32
<a name="l01066"></a><a class="code" href="o2iblnd_8h.html#a721bce55315608cf025a2c2a4cdb074d">01066</a> <a class="code" href="o2iblnd_8h.html#a721bce55315608cf025a2c2a4cdb074d">kiblnd_rd_frag_size</a>(kib_rdma_desc_t *rd, <span class="keywordtype">int</span> index)
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068         <span class="keywordflow">return</span> rd-&gt;rd_frags[index].rf_nob;
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 <span class="keyword">static</span> <span class="keyword">inline</span> __u32
<a name="l01072"></a><a class="code" href="o2iblnd_8h.html#a3600d5a729f5b9b5ae731e128dd130b9">01072</a> <a class="code" href="o2iblnd_8h.html#a3600d5a729f5b9b5ae731e128dd130b9">kiblnd_rd_frag_key</a>(kib_rdma_desc_t *rd, <span class="keywordtype">int</span> index)
<a name="l01073"></a>01073 {
<a name="l01074"></a>01074         <span class="keywordflow">return</span> rd-&gt;rd_key;
<a name="l01075"></a>01075 }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01078"></a><a class="code" href="o2iblnd_8h.html#a25c2565dda7cb82c3794eb8966f1a325">01078</a> <a class="code" href="o2iblnd_8h.html#a25c2565dda7cb82c3794eb8966f1a325">kiblnd_rd_consume_frag</a>(kib_rdma_desc_t *rd, <span class="keywordtype">int</span> index, __u32 nob)
<a name="l01079"></a>01079 {
<a name="l01080"></a>01080         <span class="keywordflow">if</span> (nob &lt; rd-&gt;rd_frags[index].rf_nob) {
<a name="l01081"></a>01081                 rd-&gt;rd_frags[index].rf_addr += nob;
<a name="l01082"></a>01082                 rd-&gt;rd_frags[index].rf_nob  -= nob;
<a name="l01083"></a>01083         } <span class="keywordflow">else</span> {
<a name="l01084"></a>01084                 index ++;
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087         <span class="keywordflow">return</span> index;
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01091"></a><a class="code" href="o2iblnd_8h.html#a8232df414c285f38caf9d5cf9dc781e6">01091</a> <a class="code" href="o2iblnd_8h.html#a8232df414c285f38caf9d5cf9dc781e6">kiblnd_rd_msg_size</a>(kib_rdma_desc_t *rd, <span class="keywordtype">int</span> msgtype, <span class="keywordtype">int</span> n)
<a name="l01092"></a>01092 {
<a name="l01093"></a>01093         <a class="code" href="utils_2wirehdr_8c.html#a40eabc293a68a6404ce1de507c99c4b5">LASSERT</a> (msgtype == <a class="code" href="packet-lnet_8c.html#a39935bd48aa9a8b7bcc244f0f4aeb6bb">IBLND_MSG_GET_REQ</a> ||
<a name="l01094"></a>01094                  msgtype == <a class="code" href="packet-lnet_8c.html#a78efff95b4dc34c111963944ef5aad05">IBLND_MSG_PUT_ACK</a>);
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         <span class="keywordflow">return</span> msgtype == <a class="code" href="packet-lnet_8c.html#a39935bd48aa9a8b7bcc244f0f4aeb6bb">IBLND_MSG_GET_REQ</a> ?
<a name="l01097"></a>01097                <a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(kib_get_msg_t, ibgm_rd.<a class="code" href="structWIRE__ATTR.html#aa442f0ec97970b5a1df349283023bf59">rd_frags</a>[n]) :
<a name="l01098"></a>01098                <a class="code" href="group__lustreuser.html#gad4a7496cd704df3829c87864e7dbd703">offsetof</a>(kib_putack_msg_t, ibpam_rd.<a class="code" href="structWIRE__ATTR.html#aa442f0ec97970b5a1df349283023bf59">rd_frags</a>[n]);
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>
<a name="l01102"></a><a class="code" href="o2iblnd_8h.html#a2eea316ecfe7149e8529950d04682ad9">01102</a> <a class="code" href="o2iblnd_8h.html#a2eea316ecfe7149e8529950d04682ad9">kiblnd_dma_mapping_error</a>(<span class="keyword">struct</span> ib_device *dev, u64 dma_addr)
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104         <span class="keywordflow">return</span> ib_dma_mapping_error(dev, dma_addr);
<a name="l01105"></a>01105 }
<a name="l01106"></a>01106 
<a name="l01107"></a><a class="code" href="o2iblnd_8h.html#a1034fe0378b3d681dd477d7a3ce8b108">01107</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="o2iblnd_8h.html#a1034fe0378b3d681dd477d7a3ce8b108">kiblnd_dma_map_single</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01108"></a>01108                                           <span class="keywordtype">void</span> *<a class="code" href="multiop_8c.html#afbbc03d010d4a43d0dcc0ef3c41de5ec">msg</a>, <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>,
<a name="l01109"></a>01109                                           <span class="keyword">enum</span> dma_data_direction direction)
<a name="l01110"></a>01110 {
<a name="l01111"></a>01111         <span class="keywordflow">return</span> ib_dma_map_single(dev, msg, size, direction);
<a name="l01112"></a>01112 }
<a name="l01113"></a>01113 
<a name="l01114"></a><a class="code" href="o2iblnd_8h.html#a21e4e10a58acf7be208c4a309835b170">01114</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#a21e4e10a58acf7be208c4a309835b170">kiblnd_dma_unmap_single</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01115"></a>01115                                            <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> addr, <span class="keywordtype">size_t</span> <a class="code" href="lp__utils_8h.html#a439227feff9d7f55384e8780cfc2eb82">size</a>,
<a name="l01116"></a>01116                                           <span class="keyword">enum</span> dma_data_direction direction)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118         ib_dma_unmap_single(dev, addr, size, direction);
<a name="l01119"></a>01119 }
<a name="l01120"></a>01120 
<a name="l01121"></a><a class="code" href="o2iblnd_8h.html#af7e501457f1d93678938a1e658b4b86c">01121</a> <span class="preprocessor">#define KIBLND_UNMAP_ADDR_SET(p, m, a)  do {} while (0)</span>
<a name="l01122"></a><a class="code" href="o2iblnd_8h.html#aa3fc8dcbeb9097c2fbea5f5aba7d22ee">01122</a> <span class="preprocessor"></span><span class="preprocessor">#define KIBLND_UNMAP_ADDR(p, m, a)      (a)</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span>
<a name="l01124"></a><a class="code" href="o2iblnd_8h.html#aa6d515506253b2def3e8ffd06a64387d">01124</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="o2iblnd_8h.html#aa6d515506253b2def3e8ffd06a64387d">kiblnd_dma_map_sg</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01125"></a>01125                                     <span class="keyword">struct</span> scatterlist *sg, <span class="keywordtype">int</span> nents,
<a name="l01126"></a>01126                                     <span class="keyword">enum</span> dma_data_direction direction)
<a name="l01127"></a>01127 {
<a name="l01128"></a>01128         <span class="keywordflow">return</span> ib_dma_map_sg(dev, sg, nents, direction);
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 
<a name="l01131"></a><a class="code" href="o2iblnd_8h.html#aeb38bbd3e3dbd193c29f57adc743f7f0">01131</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#aeb38bbd3e3dbd193c29f57adc743f7f0">kiblnd_dma_unmap_sg</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01132"></a>01132                                        <span class="keyword">struct</span> scatterlist *sg, <span class="keywordtype">int</span> nents,
<a name="l01133"></a>01133                                        <span class="keyword">enum</span> dma_data_direction direction)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135         ib_dma_unmap_sg(dev, sg, nents, direction);
<a name="l01136"></a>01136 }
<a name="l01137"></a>01137 
<a name="l01138"></a><a class="code" href="o2iblnd_8h.html#a5e0f65787a0e408ec6d01bf0edf2a2e4">01138</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> <a class="code" href="o2iblnd_8h.html#a5e0f65787a0e408ec6d01bf0edf2a2e4">kiblnd_sg_dma_address</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01139"></a>01139                                           <span class="keyword">struct</span> scatterlist *sg)
<a name="l01140"></a>01140 {
<a name="l01141"></a>01141         <span class="keywordflow">return</span> ib_sg_dma_address(dev, sg);
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a><a class="code" href="o2iblnd_8h.html#a1991ba025ee2590108f8f79935b74bf1">01144</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="o2iblnd_8h.html#a1991ba025ee2590108f8f79935b74bf1">kiblnd_sg_dma_len</a>(<span class="keyword">struct</span> ib_device *dev,
<a name="l01145"></a>01145                                              <span class="keyword">struct</span> scatterlist *sg)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147         <span class="keywordflow">return</span> ib_sg_dma_len(dev, sg);
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="comment">/* XXX We use KIBLND_CONN_PARAM(e) as writable buffer, it&apos;s not strictly</span>
<a name="l01151"></a>01151 <span class="comment"> * right because OFED1.2 defines it as const, to use it we have to add</span>
<a name="l01152"></a>01152 <span class="comment"> * (void *) cast to overcome &quot;const&quot; */</span>
<a name="l01153"></a>01153 
<a name="l01154"></a><a class="code" href="o2iblnd_8h.html#ae21ae2e1aae8bc86d2b546d24a1915db">01154</a> <span class="preprocessor">#define KIBLND_CONN_PARAM(e)            ((e)-&gt;param.conn.private_data)</span>
<a name="l01155"></a><a class="code" href="o2iblnd_8h.html#a04471c39ee2f361f3c332f671fa7e3d6">01155</a> <span class="preprocessor"></span><span class="preprocessor">#define KIBLND_CONN_PARAM_LEN(e)        ((e)-&gt;param.conn.private_data_len)</span>
<a name="l01156"></a>01156 <span class="preprocessor"></span>
<a name="l01157"></a>01157 <span class="keyword">struct </span>ib_mr *<a class="code" href="o2iblnd_8c.html#a6dcf1f31e11da4f8a7a71d2d1f24d834">kiblnd_find_rd_dma_mr</a>(<span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni, kib_rdma_desc_t *rd,
<a name="l01158"></a>01158                                     <span class="keywordtype">int</span> negotiated_nfrags);
<a name="l01159"></a>01159 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a9b920311e466dcb2bbaa2a5c4cae9094">kiblnd_map_rx_descs</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn);
<a name="l01160"></a>01160 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a6fd3f0b301edfda977be603dda0df775">kiblnd_unmap_rx_descs</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn);
<a name="l01161"></a>01161 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#ae9125e73bafc3f110a5cd217dad800cc">kiblnd_pool_free_node</a>(<a class="code" href="structkib__pool.html">kib_pool_t</a> *pool, <span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *node);
<a name="l01162"></a>01162 <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> *<a class="code" href="o2iblnd_8c.html#a5f708e035f3485a8fff927f468df64ff">kiblnd_pool_alloc_node</a>(<a class="code" href="structkib__poolset.html">kib_poolset_t</a> *ps);
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#a210139808cf692765d86aa8540fc594e">kiblnd_fmr_pool_map</a>(<a class="code" href="structkib__fmr__poolset__t.html">kib_fmr_poolset_t</a> *fps, <a class="code" href="structkib__tx.html">kib_tx_t</a> *tx,
<a name="l01165"></a>01165                          kib_rdma_desc_t *rd, __u32 nob, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> iov,
<a name="l01166"></a>01166                          <a class="code" href="structkib__fmr__t.html">kib_fmr_t</a> *fmr);
<a name="l01167"></a>01167 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a919dd05b1bdc92e42a4fcd2f2f07501d">kiblnd_fmr_pool_unmap</a>(<a class="code" href="structkib__fmr__t.html">kib_fmr_t</a> *fmr, <span class="keywordtype">int</span> <a class="code" href="lustre__rsync_8c.html#a55591f17a60f597b63f070969c54fd6c">status</a>);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a6c68297b6c37678b714404fa1c9e6be0">kiblnd_tunables_setup</a>(<span class="keyword">struct</span> <a class="code" href="structlnet__ni.html">lnet_ni</a> *ni);
<a name="l01170"></a>01170 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a4a9c7530565e8c5db43c8e124b402680">kiblnd_tunables_init</a>(<span class="keywordtype">void</span>);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a48ab12fc7cbba4b880a30ddaa9488d45">kiblnd_connd</a> (<span class="keywordtype">void</span> *arg);
<a name="l01173"></a>01173 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a1ce463280c64084bf1cea50df3d115bd">kiblnd_scheduler</a>(<span class="keywordtype">void</span> *arg);
<a name="l01174"></a>01174 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a841f892de847027fae8b98c08b1ec6bd">kiblnd_thread_start</a>(<span class="keywordtype">int</span> (*fn)(<span class="keywordtype">void</span> *arg), <span class="keywordtype">void</span> *arg, <span class="keywordtype">char</span> *<a class="code" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l01175"></a>01175 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#aa96d5bab1d5833b9ef811971efdf15b2">kiblnd_failover_thread</a> (<span class="keywordtype">void</span> *arg);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#a4d2c210ffb9f2d619fc1c2ca1c40575d">kiblnd_alloc_pages</a>(<a class="code" href="structkib__pages__t.html">kib_pages_t</a> **pp, <span class="keywordtype">int</span> cpt, <span class="keywordtype">int</span> npages);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#ab2ebc607bd30a4ce01c409d2aa4a68ba">kiblnd_cm_callback</a>(<span class="keyword">struct</span> rdma_cm_id *cmid,
<a name="l01180"></a>01180                         <span class="keyword">struct</span> rdma_cm_event *event);
<a name="l01181"></a>01181 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#a75bf42a701838bd367ac0f93757b1efd">kiblnd_translate_mtu</a>(<span class="keywordtype">int</span> value);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#ab61fd07ac03ca67642069ec0f869d86d">kiblnd_dev_failover</a>(<a class="code" href="structkib__dev__t.html">kib_dev_t</a> *dev);
<a name="l01184"></a>01184 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#ae6cfca85766c74a307e877678e9e69b9">kiblnd_create_peer</a>(<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, <a class="code" href="structkib__peer.html">kib_peer_t</a> **peerp, <a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a> nid);
<a name="l01185"></a>01185 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a683bb7611c2364b270ec3c2a1d5db000">kiblnd_destroy_peer</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer);
<a name="l01186"></a>01186 <span class="keywordtype">bool</span> <a class="code" href="o2iblnd_8h.html#a36d5dbd34dec393cdc5d87433f097059">kiblnd_reconnect_peer</a>(<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer);
<a name="l01187"></a>01187 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#ad88ec1dee59b145e2dccb4f6eb6a4d24">kiblnd_destroy_dev</a> (<a class="code" href="structkib__dev__t.html">kib_dev_t</a> *dev);
<a name="l01188"></a>01188 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a7cfff0a7a26c8f7fb53ac42e538132f0">kiblnd_unlink_peer_locked</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer);
<a name="l01189"></a>01189 <a class="code" href="structkib__peer.html">kib_peer_t</a> *<a class="code" href="o2iblnd_8c.html#a61f8c57969e304fda9fd53dd8c282276">kiblnd_find_peer_locked</a> (<a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a> nid);
<a name="l01190"></a>01190 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#aaed2149355a6c87950089986f9b3f368">kiblnd_close_stale_conns_locked</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer,
<a name="l01191"></a>01191                                       <span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> incarnation);
<a name="l01192"></a>01192 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#ae446de6126beb37f244289bd20030504">kiblnd_close_peer_conns_locked</a> (<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer, <span class="keywordtype">int</span> why);
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <a class="code" href="structkib__conn.html">kib_conn_t</a> *<a class="code" href="o2iblnd_8c.html#a5826da5ae95b440eb376afc0eaadd56f">kiblnd_create_conn</a>(<a class="code" href="structkib__peer.html">kib_peer_t</a> *peer, <span class="keyword">struct</span> rdma_cm_id *cmid,
<a name="l01195"></a>01195                                <span class="keywordtype">int</span> <a class="code" href="fsx_8c.html#a5797ba50831ee71f60588abd75d2992e">state</a>, <span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>);
<a name="l01196"></a>01196 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#ae5cd32ec69531143269fd13c0f5d3fb6">kiblnd_destroy_conn</a>(<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn, <span class="keywordtype">bool</span> free_conn);
<a name="l01197"></a>01197 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#ae294c639087bb735a2719f53478791fd">kiblnd_close_conn</a> (<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn, <span class="keywordtype">int</span> <a class="code" href="it__test_8c.html#ae70cde843eddd6d7c493335f157da127">error</a>);
<a name="l01198"></a>01198 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#a197eeae1b8dc0697d0f4c4a51904a22f">kiblnd_close_conn_locked</a> (<a class="code" href="structkib__conn.html">kib_conn_t</a> *conn, <span class="keywordtype">int</span> <a class="code" href="it__test_8c.html#ae70cde843eddd6d7c493335f157da127">error</a>);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#a4c48ff1f0ea3f3c86eb1d32d3fd15a9e">kiblnd_launch_tx</a> (<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, <a class="code" href="structkib__tx.html">kib_tx_t</a> *tx, <a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a> nid);
<a name="l01201"></a>01201 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#affbca897aa11325715e5784416a1fcdd">kiblnd_txlist_done</a>(<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, <span class="keyword">struct</span> <a class="code" href="structlist__head.html">list_head</a> *txlist, <span class="keywordtype">int</span> <a class="code" href="lustre__rsync_8c.html#a55591f17a60f597b63f070969c54fd6c">status</a>);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#af4ed7c358c264e3f1a9d35ef22a06b34">kiblnd_qp_event</a>(<span class="keyword">struct</span> ib_event *event, <span class="keywordtype">void</span> *arg);
<a name="l01204"></a>01204 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#a5f16e2b9af8091d29820db902114d68f">kiblnd_cq_event</a>(<span class="keyword">struct</span> ib_event *event, <span class="keywordtype">void</span> *arg);
<a name="l01205"></a>01205 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8h.html#afe04596de304518afbfc52f8c64050c7">kiblnd_cq_completion</a>(<span class="keyword">struct</span> ib_cq *cq, <span class="keywordtype">void</span> *arg);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207 <span class="keywordtype">void</span> <a class="code" href="o2iblnd_8c.html#a2faaa473d27be7fed1901c3f09557d57">kiblnd_pack_msg</a> (<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, kib_msg_t *<a class="code" href="multiop_8c.html#afbbc03d010d4a43d0dcc0ef3c41de5ec">msg</a>, <span class="keywordtype">int</span> <a class="code" href="packet-lnet_8c.html#a0a5c5891c90b30e72f5cfca80915338e">version</a>,
<a name="l01208"></a>01208                       <span class="keywordtype">int</span> <a class="code" href="gnilnd__modparams_8c.html#aca17d0debc49d011e5c492872fa98b92">credits</a>, <a class="code" href="group__lnet__addr.html#ga0d47ef2c4f1002efbdd050547f80a312" title="Address of an end-point in an LNet network.">lnet_nid_t</a> dstnid, <a class="code" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> dststamp);
<a name="l01209"></a>01209 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8c.html#afec9741762cd406ffe21889478f6880e">kiblnd_unpack_msg</a>(kib_msg_t *<a class="code" href="multiop_8c.html#afbbc03d010d4a43d0dcc0ef3c41de5ec">msg</a>, <span class="keywordtype">int</span> nob);
<a name="l01210"></a>01210 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a3ac5e8e80791bce420aa160dd8154754">kiblnd_post_rx</a> (<a class="code" href="structkib__rx.html">kib_rx_t</a> *rx, <span class="keywordtype">int</span> credit);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#affa89fb0c9efc7384af912f7b2f9fc6e">kiblnd_send</a>(<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, <span class="keywordtype">void</span> *<span class="keyword">private</span>, <a class="code" href="structlnet__msg.html">lnet_msg_t</a> *lntmsg);
<a name="l01213"></a>01213 <span class="keywordtype">int</span>  <a class="code" href="o2iblnd_8h.html#a097d9d2d6f465f4e9e3607b561f3549c">kiblnd_recv</a>(<a class="code" href="structlnet__ni.html">lnet_ni_t</a> *ni, <span class="keywordtype">void</span> *<span class="keyword">private</span>, <a class="code" href="structlnet__msg.html">lnet_msg_t</a> *lntmsg, <span class="keywordtype">int</span> delayed,
<a name="l01214"></a>01214                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> niov, <span class="keyword">struct</span> kvec *iov, <a class="code" href="structlnet__kiov__t.html" title="A page-based fragment of a MD.">lnet_kiov_t</a> *kiov,
<a name="l01215"></a>01215                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mlen, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rlen);
<a name="l01216"></a>01216 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:33 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
