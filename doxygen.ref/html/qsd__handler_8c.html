<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/quota/qsd_handler.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/quota/qsd_handler.c File Reference</h1><code>#include &quot;<a class="el" href="qsd__internal_8h_source.html">qsd_internal.h</a>&quot;</code><br/>

<p><a href="qsd__handler_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_LQUOTA</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a23cd2a61458aa85126972018dc507308">qsd_request_enter</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">helper function bumping lqe_pending_req if there is no quota request in flight for the lquota entry <em>lqe</em>.  <a href="#a23cd2a61458aa85126972018dc507308"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a42686c020731af934654b3a78b48c902">qsd_request_exit</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Companion of <a class="el" href="qsd__handler_8c.html#a23cd2a61458aa85126972018dc507308" title="helper function bumping lqe_pending_req if there is no quota request in flight for...">qsd_request_enter()</a> dropping lqe_pending_req to 0.  <a href="#a42686c020731af934654b3a78b48c902"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a9fa99958800c3dbeb19e55c565602645">qsd_ready</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe, struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether a qsd instance is all set to send quota request to master.  <a href="#a9fa99958800c3dbeb19e55c565602645"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#ad6357119f70a2fd485f9edaa3da6c005">qsd_calc_adjust</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe, struct <a class="el" href="structquota__body.html">quota_body</a> *qbody)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether any quota space adjustment (pre-acquire/release/report) is needed for a given quota ID.  <a href="#ad6357119f70a2fd485f9edaa3da6c005"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#ac769903ad0b21d00f575517bc545c01b">qsd_adjust_needed</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Helper function returning true when quota space need to be adjusted (some unused space should be free or pre-acquire) and false otherwise.  <a href="#ac769903ad0b21d00f575517bc545c01b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a2e8ee6c0c8aeb7b96ff18eea7deb5a02">qsd_req_completion</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *qqi, struct <a class="el" href="structquota__body.html">quota_body</a> *reqbody, struct <a class="el" href="structquota__body.html">quota_body</a> *repbody, struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh, struct <a class="el" href="structlquota__lvb.html">lquota_lvb</a> *lvb, void *arg, int <a class="el" href="utils_2wiretest_8c.html#a6baa346e44f4c2158d2be4f9b77b8203">ret</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Callback function called when an acquire/release request sent to the master is completed.  <a href="#a2e8ee6c0c8aeb7b96ff18eea7deb5a02"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a9f170431bc7cc6e2275133ab4d648ba3">qsd_acquire_local</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe, <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> space)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Try to consume local quota space.  <a href="#a9f170431bc7cc6e2275133ab4d648ba3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a673bee1a018761b8564d77973e22326c">qsd_calc_acquire</a> (struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe, struct <a class="el" href="structquota__body.html">quota_body</a> *qbody)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute how much quota space should be acquire from the master based on how much is currently granted to this slave and pending/waiting operations.  <a href="#a673bee1a018761b8564d77973e22326c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#ad7c3e755dbaefe7d5c46c076bcbf622d">qsd_acquire_remote</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Acquire quota space from master.  <a href="#ad7c3e755dbaefe7d5c46c076bcbf622d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a16446e40cb948173838bdf4dbde89a4d">qsd_acquire</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe, long long space, int *<a class="el" href="utils_2wiretest_8c.html#a6baa346e44f4c2158d2be4f9b77b8203">ret</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Acquire <em>space</em> of quota space in order to complete an operation.  <a href="#a16446e40cb948173838bdf4dbde89a4d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a03d6e8a1cdb1cf4631dc1116d532a07f">qsd_op_begin0</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *qqi, struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *qid, long long space, int *flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Quota enforcement handler.  <a href="#a03d6e8a1cdb1cf4631dc1116d532a07f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a2a54ae44931aa2655918e1ef0e5cf178">qid_equal</a> (struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *q1, struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *q2)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">helper function comparing two <a class="el" href="structlquota__id__info.html">lquota_id_info</a> structures  <a href="#a2a54ae44931aa2655918e1ef0e5cf178"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#ad4a85fbbf42145abac740a886def0281">qsd_op_begin</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *qsd, struct <a class="el" href="structlquota__trans.html">lquota_trans</a> *trans, struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *qi, int *flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enforce quota, it's called in the declaration of each operation.  <a href="#ad4a85fbbf42145abac740a886def0281"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#a7e68214f1cbadcee01e19f5ffd8a85dd">qsd_adjust</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *lqe)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Adjust quota space (by acquiring or releasing) hold by the quota slave.  <a href="#a7e68214f1cbadcee01e19f5ffd8a85dd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#aadc74514d7d85142dd4c0e13096cf746">qsd_op_end0</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *qqi, struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *qid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Post quota operation, pre-acquire/release quota from master.  <a href="#aadc74514d7d85142dd4c0e13096cf746"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#af56b415e81b622b39095c036c4ddfa47">qsd_op_end</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *qsd, struct <a class="el" href="structlquota__trans.html">lquota_trans</a> *trans)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Post quota operation.  <a href="#af56b415e81b622b39095c036c4ddfa47"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsd__handler_8c.html#aa3c8743c0a3529bb917296107795fcb9">qsd_op_adjust</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *qsd, union <a class="el" href="unionlquota__id.html">lquota_id</a> *qid, int qtype)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Trigger pre-acquire/release if necessary.  <a href="#aa3c8743c0a3529bb917296107795fcb9"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="qsd_handler.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_LQUOTA</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00031">31</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a2a54ae44931aa2655918e1ef0e5cf178"></a><!-- doxytag: member="qsd_handler.c::qid_equal" ref="a2a54ae44931aa2655918e1ef0e5cf178" args="(struct lquota_id_info *q1, struct lquota_id_info *q2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool qid_equal </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *&nbsp;</td>
          <td class="paramname"> <em>q1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *&nbsp;</td>
          <td class="paramname"> <em>q2</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>helper function comparing two <a class="el" href="structlquota__id__info.html">lquota_id_info</a> structures </p>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00799">799</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="lustre__quota_8h_source.html#l00191">lquota_id_info::lqi_id</a>, <a class="el" href="lustre__quota_8h_source.html#l00195">lquota_id_info::lqi_type</a>, and <a class="el" href="lustre__idl_8h_source.html#l01850">lquota_id::qid_uid</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00825">qsd_op_begin()</a>.</p>

</div>
</div>
<a class="anchor" id="a16446e40cb948173838bdf4dbde89a4d"></a><!-- doxytag: member="qsd_handler.c::qsd_acquire" ref="a16446e40cb948173838bdf4dbde89a4d" args="(const struct lu_env *env, struct lquota_entry *lqe, long long space, int *ret)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool qsd_acquire </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long long&nbsp;</td>
          <td class="paramname"> <em>space</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>ret</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Acquire <em>space</em> of quota space in order to complete an operation. </p>
<p>Try to consume local quota space first and send acquire request to quota master if required.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the qid entry to be processed </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>space</em>&nbsp;</td><td>- is the amount of quota required for the operation </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ret</em>&nbsp;</td><td>- is the return code (-EDQUOT, -EINPROGRESS, ...)</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>true</em>&nbsp;</td><td>- exit from l_wait_event and real return value in <em>ret</em> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>false</em>&nbsp;</td><td>- continue waiting </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00630">630</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00046">LPD64</a>, <a class="el" href="qsd__internal_8h_source.html#l00209">lqe2qqi()</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="qsd__handler_8c_source.html#l00440">qsd_acquire_local()</a>, <a class="el" href="qsd__handler_8c_source.html#l00530">qsd_acquire_remote()</a>, <a class="el" href="qsd__entry_8c_source.html#l00186">qsd_refresh_usage()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00686">qsd_op_begin0()</a>.</p>

</div>
</div>
<a class="anchor" id="a9f170431bc7cc6e2275133ab4d648ba3"></a><!-- doxytag: member="qsd_handler.c::qsd_acquire_local" ref="a9f170431bc7cc6e2275133ab4d648ba3" args="(struct lquota_entry *lqe, __u64 space)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int qsd_acquire_local </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>&nbsp;</td>
          <td class="paramname"> <em>space</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Try to consume local quota space. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the qid entry to be processed </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>space</em>&nbsp;</td><td>- is the amount of quota space needed to complete the operation</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EDQUOT</em>&nbsp;</td><td>- out of quota </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EAGAIN</em>&nbsp;</td><td>- need to acquire space from master </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00440">440</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="linux-time_8h_source.html#l00248">cfs_time_before_64()</a>, <a class="el" href="linux-time_8h_source.html#l00242">cfs_time_shift_64()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_edquot</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_enforced</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="mmap__cat_8c_source.html#l00045">usage</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00630">qsd_acquire()</a>.</p>

</div>
</div>
<a class="anchor" id="ad7c3e755dbaefe7d5c46c076bcbf622d"></a><!-- doxytag: member="qsd_handler.c::qsd_acquire_remote" ref="ad7c3e755dbaefe7d5c46c076bcbf622d" args="(const struct lu_env *env, struct lquota_entry *lqe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int qsd_acquire_remote </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Acquire quota space from master. </p>
<p>There are at most 1 in-flight dqacq/dqrel.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the qid entry to be processed</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EDQUOT</em>&nbsp;</td><td>- out of quota </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINPROGRESS</em>&nbsp;</td><td>- inform client to retry write/create </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EBUSY</em>&nbsp;</td><td>- already a quota request in flight </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ve</em>&nbsp;</td><td>- other appropriate errors </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00530">530</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="linux-time_8h_source.html#l00248">cfs_time_before_64()</a>, <a class="el" href="linux-time_8h_source.html#l00242">cfs_time_shift_64()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l02881">IT_QUOTA_DQACQ</a>, <a class="el" href="qsd__internal_8h_source.html#l00209">lqe2qqi()</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_enforced</a>, <a class="el" href="lquota__internal_8h_source.html#l00222">lqe_getref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00144">lquota_entry::lqe_id</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l01032">lustre_handle_copy()</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="lustre__idl_8h_source.html#l01879">quota_body::qb_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l01889">quota_body::qb_glb_lockh</a>, <a class="el" href="lustre__idl_8h_source.html#l01882">quota_body::qb_id</a>, <a class="el" href="lustre__idl_8h_source.html#l01888">quota_body::qb_lockh</a>, <a class="el" href="qsd__internal_8h_source.html#l00134">qsd_qtype_info::qqi_fid</a>, <a class="el" href="qsd__internal_8h_source.html#l00141">qsd_qtype_info::qqi_qsd</a>, <a class="el" href="qsd__handler_8c_source.html#l00489">qsd_calc_acquire()</a>, <a class="el" href="qsd__internal_8h_source.html#l00059">qsd_instance::qsd_exp</a>, <a class="el" href="qsd__lock_8c_source.html#l00462">qsd_id_lock_match()</a>, <a class="el" href="qsd__internal_8h_source.html#l00261">qsd_info()</a>, <a class="el" href="qsd__request_8c_source.html#l00205">qsd_intent_lock()</a>, <a class="el" href="qsd__handler_8c_source.html#l00085">qsd_ready()</a>, <a class="el" href="qsd__handler_8c_source.html#l00302">qsd_req_completion()</a>, <a class="el" href="qsd__handler_8c_source.html#l00039">qsd_request_enter()</a>, <a class="el" href="qsd__request_8c_source.html#l00091">qsd_send_dqacq()</a>, <a class="el" href="qsd__internal_8h_source.html#l00252">qsd_thread_info::qti_body</a>, <a class="el" href="qsd__internal_8h_source.html#l00248">qsd_thread_info::qti_lockh</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00630">qsd_acquire()</a>.</p>

</div>
</div>
<a class="anchor" id="a7e68214f1cbadcee01e19f5ffd8a85dd"></a><!-- doxytag: member="qsd_handler.c::qsd_adjust" ref="a7e68214f1cbadcee01e19f5ffd8a85dd" args="(const struct lu_env *env, struct lquota_entry *lqe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qsd_adjust </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Adjust quota space (by acquiring or releasing) hold by the quota slave. </p>
<p>This function is called after each quota request completion and during reintegration in order to report usage or re-acquire quota locks. Space adjustment is aborted if there is already a quota request in flight for this ID.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the qid entry to be processed</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success, appropriate errors on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00902">902</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__idl_8h_source.html#l02881">IT_QUOTA_DQACQ</a>, <a class="el" href="qsd__internal_8h_source.html#l00209">lqe2qqi()</a>, <a class="el" href="lquota__internal_8h_source.html#l00222">lqe_getref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00144">lquota_entry::lqe_id</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l01032">lustre_handle_copy()</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="lustre__idl_8h_source.html#l01885">quota_body::qb_count</a>, <a class="el" href="lustre__idl_8h_source.html#l01879">quota_body::qb_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l01883">quota_body::qb_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l01889">quota_body::qb_glb_lockh</a>, <a class="el" href="lustre__idl_8h_source.html#l01882">quota_body::qb_id</a>, <a class="el" href="lustre__idl_8h_source.html#l01888">quota_body::qb_lockh</a>, <a class="el" href="qsd__internal_8h_source.html#l00134">qsd_qtype_info::qqi_fid</a>, <a class="el" href="qsd__internal_8h_source.html#l00141">qsd_qtype_info::qqi_qsd</a>, <a class="el" href="qsd__writeback_8c_source.html#l00312">qsd_adjust_schedule()</a>, <a class="el" href="qsd__handler_8c_source.html#l00159">qsd_calc_adjust()</a>, <a class="el" href="qsd__internal_8h_source.html#l00059">qsd_instance::qsd_exp</a>, <a class="el" href="qsd__lock_8c_source.html#l00462">qsd_id_lock_match()</a>, <a class="el" href="qsd__internal_8h_source.html#l00261">qsd_info()</a>, <a class="el" href="qsd__request_8c_source.html#l00205">qsd_intent_lock()</a>, <a class="el" href="qsd__handler_8c_source.html#l00085">qsd_ready()</a>, <a class="el" href="qsd__handler_8c_source.html#l00302">qsd_req_completion()</a>, <a class="el" href="qsd__handler_8c_source.html#l00039">qsd_request_enter()</a>, <a class="el" href="qsd__request_8c_source.html#l00091">qsd_send_dqacq()</a>, <a class="el" href="qsd__internal_8h_source.html#l00252">qsd_thread_info::qti_body</a>, <a class="el" href="qsd__internal_8h_source.html#l00248">qsd_thread_info::qti_lockh</a>, <a class="el" href="lustre__idl_8h_source.html#l01903">QUOTA_DQACQ_FL_REPORT</a>, <a class="el" href="lquota__internal_8h_source.html#l00324">req_has_rep</a>, <a class="el" href="lquota__internal_8h_source.html#l00321">req_is_acq</a>, <a class="el" href="lquota__internal_8h_source.html#l00322">req_is_preacq</a>, <a class="el" href="lquota__internal_8h_source.html#l00323">req_is_rel</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="qsd__lock_8c_source.html#l00295">qsd_id_blocking_ast()</a>, <a class="el" href="qsd__handler_8c_source.html#l01119">qsd_op_adjust()</a>, <a class="el" href="qsd__handler_8c_source.html#l01019">qsd_op_end0()</a>, <a class="el" href="qsd__writeback_8c_source.html#l00275">qsd_process_upd()</a>, <a class="el" href="qsd__reint_8c_source.html#l00294">qsd_reconciliation()</a>, and <a class="el" href="qsd__writeback_8c_source.html#l00410">qsd_upd_thread()</a>.</p>

</div>
</div>
<a class="anchor" id="ac769903ad0b21d00f575517bc545c01b"></a><!-- doxytag: member="qsd_handler.c::qsd_adjust_needed" ref="ac769903ad0b21d00f575517bc545c01b" args="(struct lquota_entry *lqe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool qsd_adjust_needed </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Helper function returning true when quota space need to be adjusted (some unused space should be free or pre-acquire) and false otherwise. </p>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00293">293</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="qsd__handler_8c_source.html#l00159">qsd_calc_adjust()</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l01119">qsd_op_adjust()</a>, <a class="el" href="qsd__handler_8c_source.html#l01019">qsd_op_end0()</a>, and <a class="el" href="qsd__handler_8c_source.html#l00302">qsd_req_completion()</a>.</p>

</div>
</div>
<a class="anchor" id="a673bee1a018761b8564d77973e22326c"></a><!-- doxytag: member="qsd_handler.c::qsd_calc_acquire" ref="a673bee1a018761b8564d77973e22326c" args="(struct lquota_entry *lqe, struct quota_body *qbody)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool qsd_calc_acquire </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structquota__body.html">quota_body</a> *&nbsp;</td>
          <td class="paramname"> <em>qbody</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Compute how much quota space should be acquire from the master based on how much is currently granted to this slave and pending/waiting operations. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the lquota entry for which we would like to adjust quota space. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qbody</em>&nbsp;</td><td>- is the quota body of the acquire request to fill</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>true</em>&nbsp;</td><td>- space acquisition is needed and qbody is filled </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>false</em>&nbsp;</td><td>- no space acquisition required </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00489">489</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="lquota__internal_8h_source.html#l00158">lquota_entry::lqe_granted</a>, <a class="el" href="lustre__idl_8h_source.html#l01885">quota_body::qb_count</a>, <a class="el" href="lustre__idl_8h_source.html#l01883">quota_body::qb_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l01886">quota_body::qb_usage</a>, <a class="el" href="lustre__idl_8h_source.html#l01900">QUOTA_DQACQ_FL_ACQ</a>, <a class="el" href="lustre__idl_8h_source.html#l01903">QUOTA_DQACQ_FL_REPORT</a>, and <a class="el" href="mmap__cat_8c_source.html#l00045">usage</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00530">qsd_acquire_remote()</a>.</p>

</div>
</div>
<a class="anchor" id="ad6357119f70a2fd485f9edaa3da6c005"></a><!-- doxytag: member="qsd_handler.c::qsd_calc_adjust" ref="ad6357119f70a2fd485f9edaa3da6c005" args="(struct lquota_entry *lqe, struct quota_body *qbody)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool qsd_calc_adjust </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structquota__body.html">quota_body</a> *&nbsp;</td>
          <td class="paramname"> <em>qbody</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether any quota space adjustment (pre-acquire/release/report) is needed for a given quota ID. </p>
<p>If a non-null <em>qbody</em> is passed, then the <em>qbody</em> structure (qb_count/flags/usage) is filled with appropriate data to be packed in the quota request.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the lquota entry for which we would like to adjust quota space. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qbody</em>&nbsp;</td><td>- is the quota body to fill, if not NULL.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>true</em>&nbsp;</td><td>- space adjustment is required and <em>qbody</em> is filled, if not NULL </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>false</em>&nbsp;</td><td>- no space adjustment required </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00159">159</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_edquot</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_enforced</a>, <a class="el" href="lquota__internal_8h_source.html#l00158">lquota_entry::lqe_granted</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_nopreacq</a>, <a class="el" href="lquota__internal_8h_source.html#l00202">lqe_qtune</a>, <a class="el" href="lquota__internal_8h_source.html#l00159">lquota_entry::lqe_qunit</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l01021">lustre_handle_is_used()</a>, <a class="el" href="lustre__idl_8h_source.html#l01885">quota_body::qb_count</a>, <a class="el" href="lustre__idl_8h_source.html#l01883">quota_body::qb_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l01886">quota_body::qb_usage</a>, <a class="el" href="lustre__idl_8h_source.html#l01900">QUOTA_DQACQ_FL_ACQ</a>, <a class="el" href="lustre__idl_8h_source.html#l01901">QUOTA_DQACQ_FL_PREACQ</a>, <a class="el" href="lustre__idl_8h_source.html#l01902">QUOTA_DQACQ_FL_REL</a>, <a class="el" href="lustre__idl_8h_source.html#l01903">QUOTA_DQACQ_FL_REPORT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="mmap__cat_8c_source.html#l00045">usage</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>, and <a class="el" href="qsd__handler_8c_source.html#l00293">qsd_adjust_needed()</a>.</p>

</div>
</div>
<a class="anchor" id="aa3c8743c0a3529bb917296107795fcb9"></a><!-- doxytag: member="qsd_handler.c::qsd_op_adjust" ref="aa3c8743c0a3529bb917296107795fcb9" args="(const struct lu_env *env, struct qsd_instance *qsd, union lquota_id *qid, int qtype)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void qsd_op_adjust </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>qsd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">union <a class="el" href="unionlquota__id.html">lquota_id</a> *&nbsp;</td>
          <td class="paramname"> <em>qid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>qtype</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Trigger pre-acquire/release if necessary. </p>
<p>It's only used by ldiskfs osd so far. When unlink a file in ldiskfs, the quota accounting isn't updated when the transaction stopped. Instead, it'll be updated on the final iput, so <a class="el" href="lustre__quota_8h.html#a68f46290e7c2fe3d254eea62a91b6fed" title="Trigger pre-acquire/release if necessary.">qsd_op_adjust()</a> will be called then (in <a class="el" href="osd-ldiskfs_2osd__handler_8c.html#ac09ce1e09b94642ed2d9e47b5246158a">osd_object_delete()</a>) to trigger quota release if necessary.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qsd</em>&nbsp;</td><td>- is the qsd instance associated with the device in charge of the operation. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qid</em>&nbsp;</td><td>- is the lquota ID of the user/group for which to trigger quota space adjustment </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qtype</em>&nbsp;</td><td>- is the quota type (USRQUOTA or GRPQUOTA) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l01119">1119</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lquota__entry_8c_source.html#l00313">lqe_locate()</a>, <a class="el" href="lquota__internal_8h_source.html#l00228">lqe_putref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00258">lqe_read_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00266">lqe_read_unlock()</a>, <a class="el" href="lustre__idl_8h_source.html#l01850">lquota_id::qid_uid</a>, <a class="el" href="qsd__internal_8h_source.html#l00147">qsd_qtype_info::qqi_acct_obj</a>, <a class="el" href="qsd__internal_8h_source.html#l00157">qsd_qtype_info::qqi_site</a>, <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>, <a class="el" href="qsd__handler_8c_source.html#l00293">qsd_adjust_needed()</a>, <a class="el" href="qsd__internal_8h_source.html#l00098">qsd_instance::qsd_lock</a>, <a class="el" href="qsd__entry_8c_source.html#l00186">qsd_refresh_usage()</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_started</a>, <a class="el" href="qsd__internal_8h_source.html#l00046">qsd_instance::qsd_svname</a>, <a class="el" href="qsd__internal_8h_source.html#l00073">qsd_instance::qsd_type_array</a>, <a class="el" href="qsd__internal_8h_source.html#l00275">qsd_type_enabled()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osd-ldiskfs_2osd__handler_8c_source.html#l01514">osd_object_delete()</a>.</p>

</div>
</div>
<a class="anchor" id="ad4a85fbbf42145abac740a886def0281"></a><!-- doxytag: member="qsd_handler.c::qsd_op_begin" ref="ad4a85fbbf42145abac740a886def0281" args="(const struct lu_env *env, struct qsd_instance *qsd, struct lquota_trans *trans, struct lquota_id_info *qi, int *flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qsd_op_begin </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>qsd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__trans.html">lquota_trans</a> *&nbsp;</td>
          <td class="paramname"> <em>trans</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Enforce quota, it's called in the declaration of each operation. </p>
<p><a class="el" href="lustre__quota_8h.html#af2c802f3768264de9886361b59e59f4a" title="Post quota operation.">qsd_op_end()</a> will then be called later once all the operations have been completed in order to release/adjust the quota space.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qsd</em>&nbsp;</td><td>- is the qsd instance associated with the device in charge of the operation. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>trans</em>&nbsp;</td><td>- is the quota transaction information </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qi</em>&nbsp;</td><td>- qid &amp; space required by current operation </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flags</em>&nbsp;</td><td>- if the operation is write, return caller no user/group and sync commit flags</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EDQUOT</em>&nbsp;</td><td>- out of quota </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINPROGRESS</em>&nbsp;</td><td>- inform client to retry write </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ve</em>&nbsp;</td><td>- other appropriate errors </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00825">825</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="lustre__quota_8h_source.html#l00191">lquota_id_info::lqi_id</a>, <a class="el" href="lustre__quota_8h_source.html#l00205">lquota_id_info::lqi_is_blk</a>, <a class="el" href="lustre__quota_8h_source.html#l00199">lquota_id_info::lqi_space</a>, <a class="el" href="lustre__quota_8h_source.html#l00195">lquota_id_info::lqi_type</a>, <a class="el" href="lustre__quota_8h_source.html#l00218">lquota_trans::lqt_id_cnt</a>, <a class="el" href="lustre__quota_8h_source.html#l00219">lquota_trans::lqt_ids</a>, <a class="el" href="qsd__handler_8c_source.html#l00799">qid_equal()</a>, <a class="el" href="lustre__idl_8h_source.html#l01850">lquota_id::qid_uid</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_acct_failed</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_is_md</a>, <a class="el" href="qsd__internal_8h_source.html#l00098">qsd_instance::qsd_lock</a>, <a class="el" href="qsd__handler_8c_source.html#l00686">qsd_op_begin0()</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_started</a>, <a class="el" href="qsd__internal_8h_source.html#l00046">qsd_instance::qsd_svname</a>, <a class="el" href="qsd__internal_8h_source.html#l00073">qsd_instance::qsd_type_array</a>, <a class="el" href="qsd__internal_8h_source.html#l00275">qsd_type_enabled()</a>, <a class="el" href="lustre__quota_8h_source.html#l00214">QUOTA_MAX_TRANSIDS</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osd-ldiskfs_2osd__quota_8c_source.html#l00504">osd_declare_qid()</a>, <a class="el" href="osd-zfs_2osd__quota_8c_source.html#l00482">osd_declare_quota()</a>, and <a class="el" href="osd__object_8c_source.html#l00790">qsd_transfer()</a>.</p>

</div>
</div>
<a class="anchor" id="a03d6e8a1cdb1cf4631dc1116d532a07f"></a><!-- doxytag: member="qsd_handler.c::qsd_op_begin0" ref="a03d6e8a1cdb1cf4631dc1116d532a07f" args="(const struct lu_env *env, struct qsd_qtype_info *qqi, struct lquota_id_info *qid, long long space, int *flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int qsd_op_begin0 </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qqi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long long&nbsp;</td>
          <td class="paramname"> <em>space</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Quota enforcement handler. </p>
<p>If local quota can satisfy this operation, return success, otherwise, acquire more quota from master. (for write operation, if master isn't available at this moment, return -EINPROGRESS to inform client to retry the write)</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qsd</em>&nbsp;</td><td>- is the qsd instance associated with the device in charge of the operation. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qid</em>&nbsp;</td><td>- is the qid information attached in the transaction handle </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>space</em>&nbsp;</td><td>- is the space required by the operation </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>flags</em>&nbsp;</td><td>- if the operation is write, return caller no user/group and sync commit flags</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EDQUOT</em>&nbsp;</td><td>- out of quota </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINPROGRESS</em>&nbsp;</td><td>- inform client to retry write </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ve</em>&nbsp;</td><td>- other appropriate errors </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00686">686</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="linux-time_8h_source.html#l00182">cfs_time_seconds()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lustre__lib_8h_source.html#l00329">l_wait_event</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00046">LPD64</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_enforced</a>, <a class="el" href="lquota__internal_8h_source.html#l00158">lquota_entry::lqe_granted</a>, <a class="el" href="lquota__entry_8c_source.html#l00313">lqe_locate()</a>, <a class="el" href="lquota__internal_8h_source.html#l00228">lqe_putref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00258">lqe_read_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00266">lqe_read_unlock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="lustre__quota_8h_source.html#l00191">lquota_id_info::lqi_id</a>, <a class="el" href="lustre__quota_8h_source.html#l00205">lquota_id_info::lqi_is_blk</a>, <a class="el" href="lustre__quota_8h_source.html#l00202">lquota_id_info::lqi_qentry</a>, <a class="el" href="lustre__quota_8h_source.html#l00199">lquota_id_info::lqi_space</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lquota__internal_8h_source.html#l00360">LQUOTA_ERROR</a>, <a class="el" href="lquota__internal_8h_source.html#l00282">LQUOTA_OVER_FL</a>, <a class="el" href="lustre__lib_8h_source.html#l00171">LWI_TIMEOUT</a>, <a class="el" href="qsd__internal_8h_source.html#l00141">qsd_qtype_info::qqi_qsd</a>, <a class="el" href="qsd__internal_8h_source.html#l00131">qsd_qtype_info::qqi_qtype</a>, <a class="el" href="qsd__internal_8h_source.html#l00157">qsd_qtype_info::qqi_site</a>, <a class="el" href="qsd__handler_8c_source.html#l00630">qsd_acquire()</a>, <a class="el" href="qsd__entry_8c_source.html#l00186">qsd_refresh_usage()</a>, <a class="el" href="qsd__internal_8h_source.html#l00103">qsd_instance::qsd_sync_threshold</a>, <a class="el" href="qsd__internal_8h_source.html#l00332">qsd_wait_timeout()</a>, <a class="el" href="lustre__quota_8h_source.html#l00225">QUOTA_FL_SYNC</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00047">ret</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="mmap__cat_8c_source.html#l00045">usage</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00825">qsd_op_begin()</a>.</p>

</div>
</div>
<a class="anchor" id="af56b415e81b622b39095c036c4ddfa47"></a><!-- doxytag: member="qsd_handler.c::qsd_op_end" ref="af56b415e81b622b39095c036c4ddfa47" args="(const struct lu_env *env, struct qsd_instance *qsd, struct lquota_trans *trans)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void qsd_op_end </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__instance.html">qsd_instance</a> *&nbsp;</td>
          <td class="paramname"> <em>qsd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__trans.html">lquota_trans</a> *&nbsp;</td>
          <td class="paramname"> <em>trans</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Post quota operation. </p>
<p>It's called after each operation transaction stopped.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qsd</em>&nbsp;</td><td>- is the qsd instance associated with device which is handling the operation. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qids</em>&nbsp;</td><td>- all qids information attached in the transaction handle </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>count</em>&nbsp;</td><td>- is the number of qid entries in the qids array.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ve</em>&nbsp;</td><td>- failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l01069">1069</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__quota_8h_source.html#l00202">lquota_id_info::lqi_qentry</a>, <a class="el" href="lustre__quota_8h_source.html#l00195">lquota_id_info::lqi_type</a>, <a class="el" href="lustre__quota_8h_source.html#l00218">lquota_trans::lqt_id_cnt</a>, <a class="el" href="lustre__quota_8h_source.html#l00219">lquota_trans::lqt_ids</a>, <a class="el" href="qsd__internal_8h_source.html#l00098">qsd_instance::qsd_lock</a>, <a class="el" href="qsd__handler_8c_source.html#l01019">qsd_op_end0()</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_started</a>, <a class="el" href="qsd__internal_8h_source.html#l00073">qsd_instance::qsd_type_array</a>, <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="osd-zfs_2osd__handler_8c_source.html#l00132">osd_trans_commit_cb()</a>, and <a class="el" href="osd-ldiskfs_2osd__handler_8c_source.html#l01413">osd_trans_stop()</a>.</p>

</div>
</div>
<a class="anchor" id="aadc74514d7d85142dd4c0e13096cf746"></a><!-- doxytag: member="qsd_handler.c::qsd_op_end0" ref="aadc74514d7d85142dd4c0e13096cf746" args="(const struct lu_env *env, struct qsd_qtype_info *qqi, struct lquota_id_info *qid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void qsd_op_end0 </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qqi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__id__info.html">lquota_id_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qid</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Post quota operation, pre-acquire/release quota from master. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>env</em>&nbsp;</td><td>- the environment passed by the caller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qsd</em>&nbsp;</td><td>- is the qsd instance attached to the OSD device which is handling the operation. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qqi</em>&nbsp;</td><td>- is the <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> structure associated with the quota ID subject to the operation </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>qid</em>&nbsp;</td><td>- stores information related to his ID for the operation which has just completed</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>- success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ve</em>&nbsp;</td><td>- failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l01019">1019</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lquota__internal_8h_source.html#l00228">lqe_putref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="lustre__quota_8h_source.html#l00202">lquota_id_info::lqi_qentry</a>, <a class="el" href="lustre__quota_8h_source.html#l00199">lquota_id_info::lqi_space</a>, <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>, <a class="el" href="qsd__handler_8c_source.html#l00293">qsd_adjust_needed()</a>, <a class="el" href="qsd__writeback_8c_source.html#l00312">qsd_adjust_schedule()</a>, <a class="el" href="qsd__entry_8c_source.html#l00186">qsd_refresh_usage()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l01069">qsd_op_end()</a>.</p>

</div>
</div>
<a class="anchor" id="a9fa99958800c3dbeb19e55c565602645"></a><!-- doxytag: member="qsd_handler.c::qsd_ready" ref="a9fa99958800c3dbeb19e55c565602645" args="(struct lquota_entry *lqe, struct lustre_handle *lockh)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int qsd_ready </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>lockh</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether a qsd instance is all set to send quota request to master. </p>
<p>This includes checking whether:</p>
<ul>
<li>the connection to master is set up and usable,</li>
<li>the qsd isn't stopping</li>
<li>reintegration has been successfully completed and all indexes are up-to-date</li>
</ul>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>lqe</em>&nbsp;</td><td>- is the lquota entry for which we would like to send an quota request </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>lockh</em>&nbsp;</td><td>- is the remote handle of the global lock returned on success</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success, appropriate error on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00085">85</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="genops_8c_source.html#l00749">class_exp2cliimp()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__import_8h_source.html#l00277">obd_import::imp_invalid</a>, <a class="el" href="lustre__dlm_8h_source.html#l00766">ldlm_lock::l_remote_handle</a>, <a class="el" href="lustre__dlm_8h_source.html#l01273">ldlm_handle2lock()</a>, <a class="el" href="lustre__dlm_8h_source.html#l01327">LDLM_LOCK_PUT</a>, <a class="el" href="qsd__internal_8h_source.html#l00209">lqe2qqi()</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lustre__idl_8h_source.html#l01032">lustre_handle_copy()</a>, <a class="el" href="lustre__idl_8h_source.html#l01021">lustre_handle_is_used()</a>, <a class="el" href="qsd__internal_8h_source.html#l00172">qsd_qtype_info::qqi_glb_uptodate</a>, <a class="el" href="qsd__internal_8h_source.html#l00144">qsd_qtype_info::qqi_lockh</a>, <a class="el" href="qsd__internal_8h_source.html#l00141">qsd_qtype_info::qqi_qsd</a>, <a class="el" href="qsd__internal_8h_source.html#l00172">qsd_qtype_info::qqi_slv_uptodate</a>, <a class="el" href="qsd__internal_8h_source.html#l00059">qsd_instance::qsd_exp</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_exp_valid</a>, <a class="el" href="qsd__internal_8h_source.html#l00098">qsd_instance::qsd_lock</a>, <a class="el" href="qsd__reint_8c_source.html#l00624">qsd_start_reint_thread()</a>, <a class="el" href="qsd__internal_8h_source.html#l00110">qsd_instance::qsd_stopping</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00530">qsd_acquire_remote()</a>, and <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>.</p>

</div>
</div>
<a class="anchor" id="a2e8ee6c0c8aeb7b96ff18eea7deb5a02"></a><!-- doxytag: member="qsd_handler.c::qsd_req_completion" ref="a2e8ee6c0c8aeb7b96ff18eea7deb5a02" args="(const struct lu_env *env, struct qsd_qtype_info *qqi, struct quota_body *reqbody, struct quota_body *repbody, struct lustre_handle *lockh, struct lquota_lvb *lvb, void *arg, int ret)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void qsd_req_completion </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structqsd__qtype__info.html">qsd_qtype_info</a> *&nbsp;</td>
          <td class="paramname"> <em>qqi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structquota__body.html">quota_body</a> *&nbsp;</td>
          <td class="paramname"> <em>reqbody</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structquota__body.html">quota_body</a> *&nbsp;</td>
          <td class="paramname"> <em>repbody</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>lockh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlquota__lvb.html">lquota_lvb</a> *&nbsp;</td>
          <td class="paramname"> <em>lvb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>arg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ret</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback function called when an acquire/release request sent to the master is completed. </p>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00302">302</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="linux-time_8h_source.html#l00235">cfs_time_current_64</a>, <a class="el" href="lustre__dlm_8h_source.html#l01098">ldlm_enqueue_info::ei_mode</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l00999">LCT_DT_THREAD</a>, <a class="el" href="ldlm__lock_8c_source.html#l00903">ldlm_lock_decref()</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lquota__internal_8h_source.html#l00158">lquota_entry::lqe_granted</a>, <a class="el" href="lquota__internal_8h_source.html#l00144">lquota_entry::lqe_id</a>, <a class="el" href="lquota__internal_8h_source.html#l00166">lquota_entry::lqe_nopreacq</a>, <a class="el" href="lquota__internal_8h_source.html#l00228">lqe_putref()</a>, <a class="el" href="lquota__internal_8h_source.html#l00242">lqe_write_lock()</a>, <a class="el" href="lquota__internal_8h_source.html#l00250">lqe_write_unlock()</a>, <a class="el" href="lustre__quota_8h_source.html#l00058">lquota_rec::lqr_slv_rec</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, <a class="el" href="lquota__internal_8h_source.html#l00360">LQUOTA_ERROR</a>, <a class="el" href="lustre__idl_8h_source.html#l01972">LQUOTA_FL_EDQUOT</a>, <a class="el" href="lu__object_8c_source.html#l01907">lu_env_refill_by_tags()</a>, <a class="el" href="lustre__idl_8h_source.html#l01032">lustre_handle_copy()</a>, <a class="el" href="lustre__idl_8h_source.html#l01026">lustre_handle_equal()</a>, <a class="el" href="lustre__idl_8h_source.html#l01021">lustre_handle_is_used()</a>, <a class="el" href="lustre__idl_8h_source.html#l01976">lquota_lvb::lvb_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l01979">lquota_lvb::lvb_id_qunit</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="lustre__idl_8h_source.html#l01885">quota_body::qb_count</a>, <a class="el" href="lustre__idl_8h_source.html#l01883">quota_body::qb_flags</a>, <a class="el" href="qsd__handler_8c_source.html#l00293">qsd_adjust_needed()</a>, <a class="el" href="qsd__writeback_8c_source.html#l00312">qsd_adjust_schedule()</a>, <a class="el" href="qsd__lock_8c_source.html#l00054">qsd_id_einfo</a>, <a class="el" href="qsd__internal_8h_source.html#l00261">qsd_info()</a>, <a class="el" href="qsd__handler_8c_source.html#l00060">qsd_request_exit()</a>, <a class="el" href="qsd__internal_8h_source.html#l00321">qsd_set_edquot()</a>, <a class="el" href="qsd__internal_8h_source.html#l00292">qsd_set_qunit()</a>, <a class="el" href="qsd__writeback_8c_source.html#l00217">qsd_upd_schedule()</a>, <a class="el" href="lustre__idl_8h_source.html#l01952">lquota_slv_rec::qsr_granted</a>, <a class="el" href="qsd__internal_8h_source.html#l00243">qsd_thread_info::qti_rec</a>, <a class="el" href="lquota__internal_8h_source.html#l00321">req_is_acq</a>, <a class="el" href="lquota__internal_8h_source.html#l00322">req_is_preacq</a>, and <a class="el" href="lquota__internal_8h_source.html#l00323">req_is_rel</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00530">qsd_acquire_remote()</a>, and <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>.</p>

</div>
</div>
<a class="anchor" id="a23cd2a61458aa85126972018dc507308"></a><!-- doxytag: member="qsd_handler.c::qsd_request_enter" ref="a23cd2a61458aa85126972018dc507308" args="(struct lquota_entry *lqe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int qsd_request_enter </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>helper function bumping lqe_pending_req if there is no quota request in flight for the lquota entry <em>lqe</em>. </p>
<p>Otherwise, EBUSY is returned. </p>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00039">39</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lquota__internal_8h_source.html#l00359">LQUOTA_DEBUG</a>, and <a class="el" href="lquota__internal_8h_source.html#l00360">LQUOTA_ERROR</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00530">qsd_acquire_remote()</a>, and <a class="el" href="qsd__handler_8c_source.html#l00902">qsd_adjust()</a>.</p>

</div>
</div>
<a class="anchor" id="a42686c020731af934654b3a78b48c902"></a><!-- doxytag: member="qsd_handler.c::qsd_request_exit" ref="a42686c020731af934654b3a78b48c902" args="(struct lquota_entry *lqe)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void qsd_request_exit </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlquota__entry.html">lquota_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>lqe</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Companion of <a class="el" href="qsd__handler_8c.html#a23cd2a61458aa85126972018dc507308" title="helper function bumping lqe_pending_req if there is no quota request in flight for...">qsd_request_enter()</a> dropping lqe_pending_req to 0. </p>

<p>Definition at line <a class="el" href="qsd__handler_8c_source.html#l00060">60</a> of file <a class="el" href="qsd__handler_8c_source.html">qsd_handler.c</a>.</p>

<p>References <a class="el" href="libcfs__private_8h_source.html#l00281">LBUG</a>, and <a class="el" href="lquota__internal_8h_source.html#l00360">LQUOTA_ERROR</a>.</p>

<p>Referenced by <a class="el" href="qsd__handler_8c_source.html#l00302">qsd_req_completion()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:50 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
