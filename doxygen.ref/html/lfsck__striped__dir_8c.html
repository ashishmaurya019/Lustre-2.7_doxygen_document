<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/lfsck/lfsck_striped_dir.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/lfsck/lfsck_striped_dir.c File Reference</h1><code>#include &lt;<a class="el" href="lustre__idl_8h_source.html">lustre/lustre_idl.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lu__object_8h_source.html">lu_object.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="dt__object_8h_source.html">dt_object.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="md__object_8h_source.html">md_object.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__fid_8h_source.html">lustre_fid.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__lib_8h_source.html">lustre_lib.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__net_8h_source.html">lustre_net.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__lmv_8h_source.html">lustre_lmv.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__user_8h_source.html">lustre/lustre_user.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="lfsck__internal_8h_source.html">lfsck_internal.h</a>&quot;</code><br/>

<p><a href="lfsck__striped__dir_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_LFSCK</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a16bf9373cf85c4c057eade31b469ef09">lfsck_lmv_put</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *llmv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a3a0202c370662cf9ca3faeb986d29208">lfsck_disable_master_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, bool del_lmv)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Mark the specified directory as read-only by set LUSTRE_IMMUTABLE_FL.  <a href="#a3a0202c370662cf9ca3faeb986d29208"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a3c7fd4dbe1365012db866f17597b0d93">lfsck_is_valid_slave_lmv</a> (struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a336643e78703bfe4839729b3b5501dd5">lfsck_remove_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *lnr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove the striped directory's master LMV EA and mark it as read-only.  <a href="#a336643e78703bfe4839729b3b5501dd5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a90e99ac26c2296a1dd4b5e483751ff83">lfsck_remove_dirent</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *<a class="el" href="mdsrate_8c.html#a929b6cee0a8e867ee7380bf26947cef2">dir</a>, const struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid, __u32 index)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove the name entry from the striped directory's master MDT-object.  <a href="#a90e99ac26c2296a1dd4b5e483751ff83"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a86253d7a8a8314c29c6b8182fc4cd941">lfsck_replace_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *<a class="el" href="mdsrate_8c.html#a929b6cee0a8e867ee7380bf26947cef2">dir</a>, struct <a class="el" href="structlfsck__slave__lmv__rec.html">lfsck_slave_lmv_rec</a> *lslr, struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *lnr, struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv, __u32 index, __u32 flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove old shard's name entry and refill the  slot with new shard.  <a href="#a86253d7a8a8314c29c6b8182fc4cd941"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#aae9daf2aa97925c73c3351fc71d30247">lfsck_record_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *<a class="el" href="mdsrate_8c.html#a929b6cee0a8e867ee7380bf26947cef2">dir</a>, struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *lnr, struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv, __u32 shard_idx, __u32 flags, __u32 flags2, __u32 *depth)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Record the slave LMV EA in the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a>.  <a href="#aae9daf2aa97925c73c3351fc71d30247"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a248445b5a863838c6de16febb9ff50b0">lfsck_read_stripe_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a85d16d415e427fa3c8d7aa008453644b">lfsck_shard_name_to_index</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, const char *<a class="el" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, int namelen, __u16 type, const struct <a class="el" href="structlu__fid.html">lu_fid</a> *fid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse the shard's index from the given shard name.  <a href="#a85d16d415e427fa3c8d7aa008453644b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#ae4fe510053a9ba9be1fb937afbe31315">lfsck_is_valid_slave_name_entry</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *llmv, const char *<a class="el" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, int namelen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a7eee69b6a91e0241801bd0911409913e">lfsck_namespace_check_name</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structdt__object.html">dt_object</a> *parent, struct <a class="el" href="structdt__object.html">dt_object</a> *child, const struct <a class="el" href="structlu__name.html">lu_name</a> *cname)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether the given name is a valid entry under the .  <a href="#a7eee69b6a91e0241801bd0911409913e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a12465f080d74c44e795ab94ce3b12f29">lfsck_namespace_update_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv, bool locked)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update the object's LMV EA with the given .  <a href="#a12465f080d74c44e795ab94ce3b12f29"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a908c13488382dcdce76a9f6b4b258392">lfsck_allow_regenerate_master_lmv</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, const struct <a class="el" href="structlu__fid.html">lu_fid</a> *cfid, __u32 cidx)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether allow to re-genereate the lost master LMV EA.  <a href="#a908c13488382dcdce76a9f6b4b258392"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#aad971b1f472400568cb2d4d6bda38f1e">lfsck_namespace_notify_lmv_remote</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, __u32 event, __u32 flags, __u32 index)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Notify remote LFSCK instance that the object's LMV EA has been updated.  <a href="#aad971b1f472400568cb2d4d6bda38f1e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#afb643704151cecb5c2a54a638f15366b">lfsck_namespace_notify_lmv_master_local</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate request for local LFSCK instance to rescan the striped directory.  <a href="#afb643704151cecb5c2a54a638f15366b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#ac05919cafd21a01843ab5464d3b5fcc6">lfsck_namespace_set_lmv_master</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *lmv, const struct <a class="el" href="structlu__fid.html">lu_fid</a> *cfid, __u32 cidx, __u32 flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set master LMV EA for the specified striped directory.  <a href="#ac05919cafd21a01843ab5464d3b5fcc6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#ab795dfd20bcc40d70ccc7e1a3f8b4ea3">lfsck_namespace_repair_bad_name_hash</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *shard, struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *llmv, const char *<a class="el" href="mdt__coordinator_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Repair the bad name hash.  <a href="#ab795dfd20bcc40d70ccc7e1a3f8b4ea3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#abfc4c3f7a5a20c98a99c5bd1b963042e">lfsck_namespace_scan_shard</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *child)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Scan the shard of a striped directory for name hash verification.  <a href="#abfc4c3f7a5a20c98a99c5bd1b963042e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#acc843dd85fecd4c3fdd9a05361412a9f">lfsck_namespace_verify_stripe_slave</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structdt__object.html">dt_object</a> *obj, struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *llmv)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Verify the slave object's (of striped directory) LMV EA.  <a href="#acc843dd85fecd4c3fdd9a05361412a9f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a386b5a0ea946859c7ed3d9f2e7175af5">lfsck_namespace_striped_dir_rescan</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *lnr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Double scan the striped directory or the shard.  <a href="#a386b5a0ea946859c7ed3d9f2e7175af5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lfsck__striped__dir_8c.html#a58127449240233d6dc445e92a938a7cb">lfsck_namespace_handle_striped_master</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *com, struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *lnr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Verify the shard's name entry under the striped directory.  <a href="#a58127449240233d6dc445e92a938a7cb"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="lfsck_striped_dir.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_LFSCK</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00141">141</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a908c13488382dcdce76a9f6b4b258392"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_allow_regenerate_master_lmv" ref="a908c13488382dcdce76a9f6b4b258392" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, const struct lu_fid *cfid, __u32 cidx)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_allow_regenerate_master_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>cfid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>cidx</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether allow to re-genereate the lost master LMV EA. </p>
<p>If the master MDT-object of the striped directory lost its master LMV EA, then before the LFSCK repaired the striped directory, some ones may have created some objects (that are not normal shards of the striped directory) under the master MDT-object. If such case happend, then the LFSCK cannot re-generate the lost master LMV EA to keep those objects to be visible to client.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the master MDT-object to be checked </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cfid</em>&nbsp;</td><td>the shard's FID used for verification </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cidx</em>&nbsp;</td><td>the shard's index used for verification</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if not allow to re-generate LMV EA </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>if allow to re-generate LMV EA </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01089">1089</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="structdt__index__operations.html#a16b19879e71b5cb1aaa459d731d580cb">dt_index_operations::dio_it</a>, <a class="el" href="dt__object_8h_source.html#l01753">dt_object::do_index_ops</a>, <a class="el" href="dt__object_8c_source.html#l00058">dt_key</a>, <a class="el" href="dt__object_8h_source.html#l02654">dt_lookup()</a>, <a class="el" href="dt__object_8c_source.html#l00184">dt_try_as_dir()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="structdt__index__operations_1_1dt__it__ops.html#a74b9db7e1791f6accf99c80a3a0c43e2">dt_index_operations::dt_it_ops::init</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00880">lfsck_shard_name_to_index()</a>, <a class="el" href="lfsck__engine_8c_source.html#l00042">lfsck_unpack_ent()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00713">lfsck_instance::li_args_dir</a>, <a class="el" href="lfsck__internal_8h_source.html#l00864">lfsck_thread_info::lti_fid3</a>, <a class="el" href="lfsck__internal_8h_source.html#l00875">lfsck_thread_info::lti_key</a>, <a class="el" href="lfsck__internal_8h_source.html#l00876">lfsck_thread_info::lti_tmpbuf</a>, <a class="el" href="lustre__idl_8h_source.html#l00801">lu_fid_eq()</a>, <a class="el" href="lustre__idl_8h_source.html#l00888">LUDA_VERIFY</a>, <a class="el" href="lustre__idl_8h_source.html#l00886">LUDA_VERIFY_DRYRUN</a>, <a class="el" href="lfsck__internal_8h_source.html#l01072">name_is_dot_or_dotdot()</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>.</p>

</div>
</div>
<a class="anchor" id="a3a0202c370662cf9ca3faeb986d29208"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_disable_master_lmv" ref="a3a0202c370662cf9ca3faeb986d29208" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, bool del_lmv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_disable_master_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>del_lmv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Mark the specified directory as read-only by set LUSTRE_IMMUTABLE_FL. </p>
<p>The caller has taken the ldlm lock on the  already.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the object to be handled </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>del_lmv</em>&nbsp;</td><td>true if need to drop the LMV EA</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00202">202</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l02225">dt_attr_get()</a>, <a class="el" href="dt__object_8h_source.html#l02253">dt_attr_set()</a>, <a class="el" href="dt__object_8h_source.html#l02238">dt_declare_attr_set()</a>, <a class="el" href="dt__object_8h_source.html#l02514">dt_declare_xattr_del()</a>, <a class="el" href="dt__object_8h_source.html#l02047">dt_trans_create()</a>, <a class="el" href="dt__object_8h_source.html#l02062">dt_trans_start_local()</a>, <a class="el" href="dt__object_8h_source.html#l02070">dt_trans_stop()</a>, <a class="el" href="dt__object_8h_source.html#l02175">dt_write_lock()</a>, <a class="el" href="dt__object_8h_source.html#l02194">dt_write_unlock()</a>, <a class="el" href="dt__object_8h_source.html#l02529">dt_xattr_del()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lu__object_8h_source.html#l00425">lu_attr::la_flags</a>, <a class="el" href="lu__object_8h_source.html#l00453">LA_FLAGS</a>, <a class="el" href="lu__object_8h_source.html#l00439">lu_attr::la_valid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00090">lfsck_bookmark::lb_param</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l00058">LF_INCONSISTENT</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01206">lfsck_is_dead_obj()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01078">lfsck_obj2dev()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00681">lfsck_instance::li_bookmark_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00139">lfsck_namespace::ln_flags</a>, <a class="el" href="lfsck__internal_8h_source.html#l00249">lfsck_namespace::ln_striped_dirs_disabled</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00142">LPF_DRYRUN</a>, <a class="el" href="lfsck__internal_8h_source.html#l00865">lfsck_thread_info::lti_la</a>, <a class="el" href="lustre__idl_8h_source.html#l02118">LUSTRE_IMMUTABLE_FL</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="rename__many_8c_source.html#l00056">stop</a>, <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>, and <a class="el" href="lustre__idl_8h_source.html#l01596">XATTR_NAME_LMV</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l00301">lfsck_remove_lmv()</a>.</p>

</div>
</div>
<a class="anchor" id="a3c7fd4dbe1365012db866f17597b0d93"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_is_valid_slave_lmv" ref="a3c7fd4dbe1365012db866f17597b0d93" args="(struct lmv_mds_md_v1 *lmv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static bool lfsck_is_valid_slave_lmv </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00277">277</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__lmv_8h_source.html#l00173">lmv_is_known_hash_type()</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, and <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l00948">lfsck_namespace_check_name()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01672">lfsck_namespace_verify_stripe_slave()</a>.</p>

</div>
</div>
<a class="anchor" id="ae4fe510053a9ba9be1fb937afbe31315"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_is_valid_slave_name_entry" ref="ae4fe510053a9ba9be1fb937afbe31315" args="(const struct lu_env *env, struct lfsck_lmv *llmv, const char *name, int namelen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool lfsck_is_valid_slave_name_entry </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *&nbsp;</td>
          <td class="paramname"> <em>llmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>namelen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00910">910</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_slave</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_verified</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__lmv_8h_source.html#l00140">lmv_name_to_stripe_index()</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l05012">lfsck_namespace_assistant_handler_p1()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01545">lfsck_namespace_scan_shard()</a>.</p>

</div>
</div>
<a class="anchor" id="a16bf9373cf85c4c057eade31b469ef09"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_lmv_put" ref="a16bf9373cf85c4c057eade31b469ef09" args="(const struct lu_env *env, struct lfsck_lmv *llmv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lfsck_lmv_put </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *&nbsp;</td>
          <td class="paramname"> <em>llmv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00155">155</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00635">lfsck_instance::li_lock</a>, <a class="el" href="list_8h_source.html#l00116">list_del()</a>, <a class="el" href="list_8h_source.html#l00242">list_entry</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_inline</a>, <a class="el" href="lfsck__internal_8h_source.html#l00608">lfsck_lmv::ll_lslr</a>, <a class="el" href="lfsck__internal_8h_source.html#l00594">lfsck_lmv::ll_ref</a>, <a class="el" href="lfsck__internal_8h_source.html#l00595">lfsck_lmv::ll_stripes_allocated</a>, <a class="el" href="lfsck__internal_8h_source.html#l00622">lfsck_lmv_unit::llu_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l00619">lfsck_lmv_unit::llu_link</a>, <a class="el" href="lfsck__internal_8h_source.html#l00621">lfsck_lmv_unit::llu_obj</a>, <a class="el" href="obd__support_8h_source.html#l00783">OBD_FREE_LARGE</a>, and <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>.</p>

<p>Referenced by <a class="el" href="lfsck__engine_8c_source.html#l00297">lfsck_close_dir()</a>, <a class="el" href="lfsck__lib_8c_source.html#l01613">lfsck_instance_cleanup()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00087">lfsck_namespace_assistant_req_fini()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01264">lfsck_namespace_notify_lmv_master_local()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l03647">lfsck_namespace_release_lmv()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01545">lfsck_namespace_scan_shard()</a>.</p>

</div>
</div>
<a class="anchor" id="a7eee69b6a91e0241801bd0911409913e"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_check_name" ref="a7eee69b6a91e0241801bd0911409913e" args="(const struct lu_env *env, struct dt_object *parent, struct dt_object *child, const struct lu_name *cname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_check_name </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>parent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>child</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__name.html">lu_name</a> *&nbsp;</td>
          <td class="paramname"> <em>cname</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether the given name is a valid entry under the . </p>
<p>If the  is a striped directory then the  should one shard of the striped directory, its name should be $FID:$index.</p>
<p>If the  is a shard of a striped directory, then the name hash should match the MDT, otherwise it is invalid.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>parent</em>&nbsp;</td><td>the parent directory </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>child</em>&nbsp;</td><td>the child object to be checked </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cname</em>&nbsp;</td><td>the name for the  in the parent directory</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number for invalid name entry </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>if the name is valid or uncertain </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00948">948</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00277">lfsck_is_valid_slave_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01201">lfsck_object_type()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00880">lfsck_shard_name_to_index()</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02600">LMV_MAGIC_STRIPE</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__lmv_8h_source.html#l00140">lmv_name_to_stripe_index()</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lu__object_8h_source.html#l01297">lu_name::ln_name</a>, <a class="el" href="lu__object_8h_source.html#l01298">lu_name::ln_namelen</a>, <a class="el" href="lfsck__internal_8h_source.html#l00896">lfsck_thread_info::lti_lmv</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l03220">lfsck_namespace_double_scan_one()</a>, and <a class="el" href="lfsck__namespace_8c_source.html#l02328">lfsck_namespace_dsd_single()</a>.</p>

</div>
</div>
<a class="anchor" id="a58127449240233d6dc445e92a938a7cb"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_handle_striped_master" ref="a58127449240233d6dc445e92a938a7cb" args="(const struct lu_env *env, struct lfsck_component *com, struct lfsck_namespace_req *lnr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_handle_striped_master </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *&nbsp;</td>
          <td class="paramname"> <em>lnr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Verify the shard's name entry under the striped directory. </p>
<p>Before all shards of the striped directory scanned, the LFSCK cannot know whether the master LMV EA is valid or not, and also cannot know how to repair an invalid shard exactly. For example, the stripe index stored in the shard's name does not match the stripe index stored in the slave LMV EA, then the LFSCK cannot know which one is correct. If the LFSCK just assumed one is correct, and fixed the other, then as the LFSCK processing, it may find that the former reparation is wrong and have to roll back. Unfortunately, if some applications saw the changes and made further modification based on such changes, then the roll back is almost impossible.</p>
<p>To avoid above trouble, the LFSCK will scan the master object of the striped directory twice, that is NOT the same as normal two-stages scanning, the double scanning the striped directory will happen both during the first-stage scanning:</p>
<p>1) When the striped directory is opened for scanning, the LFSCK will iterate each shard in turn, and records its slave LMV EA in the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a>. In this step, if the 'shard' (may be fake shard) name does not match the shard naming rule, for example, it does not contains the shard's FID, or not contains index, then we can remove the bad name entry directly. But if the name is valid, but the shard has no slave LMV EA or the slave LMV EA does not match its name, then we just record related information in the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a> in RAM.</p>
<p>2) When all the known shards have been scanned, then the engine will generate a dummy request (via lfsck_namespace_close_dir) to tell the assistant thread that all the known shards have been scanned. Since the assistant has got the global knowledge about the index conflict, stripe count, hash type, and so on. Then the assistant thread will scan the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a>, and for every shard in the record, check and repair inconsistency.</p>
<p>Generally, the stripe directory has only several shards, and there will NOT be a lof of striped directory. So double scanning striped directory will not much affect the LFSCK performance.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lnr</em>&nbsp;</td><td>pointer to the namespace request that contains the shard's name, parent object, parent's LMV, and ect.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l02248">2248</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="mmap__sanity_8c_source.html#l00053">dir</a>, <a class="el" href="lfsck__lib_8c_source.html#l00543">dotdot</a>, <a class="el" href="dt__object_8h_source.html#l01790">dt_object_exists()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00757">lfsck_assistant_req::lar_parent</a>, <a class="el" href="lfsck__internal_8h_source.html#l00090">lfsck_bookmark::lb_param</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__lib_8c_source.html#l01982">lfsck_assistant_object_load()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01231">lfsck_dev_idx()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00526">lfsck_find_mdt_idx_by_fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01206">lfsck_is_dead_obj()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01403">lfsck_lad_set_bitmap()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00494">lfsck_ltd2tgt()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00628">lfsck_namespace_check_exist()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l01990">lfsck_namespace_repair_dirent()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00525">lfsck_namespace_trace_update()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01237">lfsck_object_find_by_dev_nowait()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01201">lfsck_object_type()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00485">lfsck_record_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00880">lfsck_shard_name_to_index()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00681">lfsck_instance::li_bookmark_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00670">lfsck_instance::li_bottom</a>, <a class="el" href="lfsck__internal_8h_source.html#l00704">lfsck_instance::li_mdt_descs</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_failed</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_ignore</a>, <a class="el" href="lustre__idl_8h_source.html#l02597">LMV_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00221">lfsck_namespace::ln_bad_type_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00196">lfsck_namespace::ln_dirent_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00172">lfsck_namespace::ln_items_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00128">LNIT_BAD_DIRENT</a>, <a class="el" href="lfsck__internal_8h_source.html#l00127">LNIT_BAD_TYPE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00122">LNIT_NONE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00763">lfsck_namespace_req::lnr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00761">lfsck_namespace_req::lnr_lar</a>, <a class="el" href="lfsck__internal_8h_source.html#l00762">lfsck_namespace_req::lnr_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00769">lfsck_namespace_req::lnr_name</a>, <a class="el" href="lfsck__internal_8h_source.html#l00768">lfsck_namespace_req::lnr_namelen</a>, <a class="el" href="lfsck__internal_8h_source.html#l00767">lfsck_namespace_req::lnr_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00113">LNTF_CHECK_PARENT</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00139">LPF_FAILOUT</a>, <a class="el" href="lfsck__internal_8h_source.html#l00574">LSLF_BAD_INDEX1</a>, <a class="el" href="lfsck__internal_8h_source.html#l00573">LSLF_DANGLING</a>, <a class="el" href="lfsck__internal_8h_source.html#l00572">LSLF_NO_LMVEA</a>, <a class="el" href="lfsck__internal_8h_source.html#l00570">LSLF_NONE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00364">lfsck_assistant_object::lso_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00448">lfsck_tgt_desc::ltd_tgt</a>, <a class="el" href="lfsck__internal_8h_source.html#l00896">lfsck_thread_info::lti_lmv</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l05012">lfsck_namespace_assistant_handler_p1()</a>.</p>

</div>
</div>
<a class="anchor" id="afb643704151cecb5c2a54a638f15366b"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_notify_lmv_master_local" ref="afb643704151cecb5c2a54a638f15366b" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_notify_lmv_master_local </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate request for local LFSCK instance to rescan the striped directory. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the striped directory to be rescanned</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01264">1264</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="lfsck__internal_8h_source.html#l00090">lfsck_bookmark::lb_param</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l00534">lfsck_component::lc_sem</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00565">LFSCK_LMV_DEF_STRIPES</a>, <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00155">lfsck_lmv_put()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01213">lfsck_object_get()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00681">lfsck_instance::li_bookmark_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00655">lfsck_instance::li_list_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00635">lfsck_instance::li_lock</a>, <a class="el" href="list_8h_source.html#l00090">list_add_tail()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00600">lfsck_lmv::ll_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_inline</a>, <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_master</a>, <a class="el" href="lfsck__internal_8h_source.html#l00608">lfsck_lmv::ll_lslr</a>, <a class="el" href="lfsck__internal_8h_source.html#l00594">lfsck_lmv::ll_ref</a>, <a class="el" href="lfsck__internal_8h_source.html#l00595">lfsck_lmv::ll_stripes_allocated</a>, <a class="el" href="lfsck__internal_8h_source.html#l00622">lfsck_lmv_unit::llu_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l00619">lfsck_lmv_unit::llu_link</a>, <a class="el" href="lfsck__internal_8h_source.html#l00620">lfsck_lmv_unit::llu_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00621">lfsck_lmv_unit::llu_obj</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00136">lfsck_namespace::ln_status</a>, <a class="el" href="lfsck__internal_8h_source.html#l00243">lfsck_namespace::ln_striped_dirs_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00253">lfsck_namespace::ln_striped_dirs_skipped</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00142">LPF_DRYRUN</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00073">LS_SCANNING_PHASE1</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00077">LS_SCANNING_PHASE2</a>, <a class="el" href="lfsck__internal_8h_source.html#l00899">lfsck_thread_info::lti_lmv4</a>, <a class="el" href="obd__support_8h_source.html#l00747">OBD_ALLOC_LARGE</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l04473">lfsck_namespace_in_notify()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>.</p>

</div>
</div>
<a class="anchor" id="aad971b1f472400568cb2d4d6bda38f1e"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_notify_lmv_remote" ref="aad971b1f472400568cb2d4d6bda38f1e" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, __u32 event, __u32 flags, __u32 index)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_namespace_notify_lmv_remote </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>event</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>index</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Notify remote LFSCK instance that the object's LMV EA has been updated. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the object on which the LMV EA will be set </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>event</em>&nbsp;</td><td>indicate either master or slave LMV EA has been updated </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>indicate which element(s) in the LMV EA has been updated </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>index</em>&nbsp;</td><td>the MDT index on which the LFSCK instance to be notified</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01197">1197</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="genops_8c_source.html#l00749">class_exp2cliimp()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l01231">lfsck_dev_idx()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lustre__idl_8h_source.html#l02726">LFSCK_NOTIFY</a>, <a class="el" href="lfsck__internal_8h_source.html#l01326">lfsck_tgt_get()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01338">lfsck_tgt_put()</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00171">LFSCK_TYPE_NAMESPACE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00704">lfsck_instance::li_mdt_descs</a>, <a class="el" href="lustre__idl_8h_source.html#l03440">lfsck_request::lr_active</a>, <a class="el" href="lustre__idl_8h_source.html#l03430">lfsck_request::lr_event</a>, <a class="el" href="lustre__idl_8h_source.html#l03444">lfsck_request::lr_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l03432">lfsck_request::lr_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l03431">lfsck_request::lr_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00450">lfsck_tgt_desc::ltd_exp</a>, <a class="el" href="lfsck__internal_8h_source.html#l00878">lfsck_thread_info::lti_lr</a>, <a class="el" href="packet-lustre_8c_source.html#l00076">LUSTRE_OBD_VERSION</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="pack__generic_8c_source.html#l01551">ptlrpc_request_set_replen()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l01209">RMF_LFSCK_REQUEST</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="layout_8c_source.html#l01680">RQF_LFSCK_NOTIFY</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01817">lfsck_namespace_striped_dir_rescan()</a>.</p>

</div>
</div>
<a class="anchor" id="ab795dfd20bcc40d70ccc7e1a3f8b4ea3"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_repair_bad_name_hash" ref="ab795dfd20bcc40d70ccc7e1a3f8b4ea3" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *shard, struct lfsck_lmv *llmv, const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_repair_bad_name_hash </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>shard</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *&nbsp;</td>
          <td class="paramname"> <em>llmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Repair the bad name hash. </p>
<p>If the name hash of some name entry under the striped directory does not match the shard of the striped directory, then the LFSCK will repair the inconsistency. Ideally, the LFSCK should migrate the name entry from the current MDT to the right MDT (another one), but before the async commit finished, the LFSCK will change the striped directory's hash type as LMV_HASH_TYPE_UNKNOWN and mark the lmv flags as LMV_HASH_FLAG_BAD_TYPE.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>shard</em>&nbsp;</td><td>pointer to the shard of the striped directory that contains the bad name entry </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llmv</em>&nbsp;</td><td>pointer to lfsck LMV EA structure </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>name</em>&nbsp;</td><td>the name of the bad name hash</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01473">1473</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="lfsck__lib_8c_source.html#l00543">dotdot</a>, <a class="el" href="dt__object_8c_source.html#l00058">dt_key</a>, <a class="el" href="dt__object_8h_source.html#l02654">dt_lookup()</a>, <a class="el" href="dt__object_8h_source.html#l01790">dt_object_exists()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00793">fid_is_sane()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lustre__idl_8h_source.html#l03478">LEF_SET_LMV_HASH</a>, <a class="el" href="lfsck__internal_8h_source.html#l01231">lfsck_dev_idx()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01283">lfsck_object_find_bottom()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lustre__idl_8h_source.html#l02617">LMV_HASH_FLAG_BAD_TYPE</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00864">lfsck_thread_info::lti_fid3</a>, <a class="el" href="lfsck__internal_8h_source.html#l00897">lfsck_thread_info::lti_lmv2</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l05012">lfsck_namespace_assistant_handler_p1()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01545">lfsck_namespace_scan_shard()</a>.</p>

</div>
</div>
<a class="anchor" id="abfc4c3f7a5a20c98a99c5bd1b963042e"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_scan_shard" ref="abfc4c3f7a5a20c98a99c5bd1b963042e" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *child)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_scan_shard </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>child</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Scan the shard of a striped directory for name hash verification. </p>
<p>During the first-stage scanning, if the LFSCK cannot make sure whether the shard of a stripe directory contains valid slave LMV EA or not, then it will skip the name hash verification for this shard temporarily, and record the shard's FID in the LFSCK tracing file. As the LFSCK processing, the slave LMV EA may has been verified/fixed by LFSCK instance on master. Then in the second-stage scanning, the shard will be re-scanned, and for every name entry under the shard, the name hash will be verified, and for unmatched name entry, the LFSCK will try to fix it.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>child</em>&nbsp;</td><td>pointer to the directory object to be handled</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number for scanning successfully </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for the scanning is paused </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01545">1545</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="libcfs__fail_8h_source.html#l00139">CFS_FAIL_TIMEOUT</a>, <a class="el" href="fail_8c_source.html#l00039">cfs_fail_val</a>, <a class="el" href="structdt__index__operations.html#a16b19879e71b5cb1aaa459d731d580cb">dt_index_operations::dio_it</a>, <a class="el" href="dt__object_8h_source.html#l01753">dt_object::do_index_ops</a>, <a class="el" href="dt__object_8c_source.html#l00184">dt_try_as_dir()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="structdt__index__operations_1_1dt__it__ops.html#a74b9db7e1791f6accf99c80a3a0c43e2">dt_index_operations::dt_it_ops::init</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l00058">LF_INCONSISTENT</a>, <a class="el" href="lfsck__lib_8c_source.html#l01857">lfsck_control_speed()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00910">lfsck_is_valid_slave_name_entry()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00155">lfsck_lmv_put()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01473">lfsck_namespace_repair_bad_name_hash()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lfsck__engine_8c_source.html#l00042">lfsck_unpack_ent()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00713">lfsck_instance::li_args_dir</a>, <a class="el" href="lfsck__internal_8h_source.html#l00681">lfsck_instance::li_bookmark_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00635">lfsck_instance::li_lock</a>, <a class="el" href="lfsck__internal_8h_source.html#l00659">lfsck_instance::li_thread</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02600">LMV_MAGIC_STRIPE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00139">lfsck_namespace::ln_flags</a>, <a class="el" href="lfsck__internal_8h_source.html#l00271">lfsck_namespace::ln_name_hash_repaired</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00139">LPF_FAILOUT</a>, <a class="el" href="lfsck__internal_8h_source.html#l00875">lfsck_thread_info::lti_key</a>, <a class="el" href="lfsck__internal_8h_source.html#l00896">lfsck_thread_info::lti_lmv</a>, <a class="el" href="lustre__idl_8h_source.html#l00888">LUDA_VERIFY</a>, <a class="el" href="lustre__idl_8h_source.html#l00886">LUDA_VERIFY_DRYRUN</a>, <a class="el" href="lfsck__internal_8h_source.html#l01072">name_is_dot_or_dotdot()</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00525">OBD_FAIL_LFSCK_DELAY3</a>, <a class="el" href="obd__support_8h_source.html#l00530">OBD_FAIL_LFSCK_FATAL2</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="lustre__net_8h_source.html#l01495">SVC_STOPPING</a>, <a class="el" href="obd_8c_source.html#l00114">thread</a>, <a class="el" href="lustre__net_8h_source.html#l01557">thread_is_running()</a>, <a class="el" href="lustre__net_8h_source.html#l01577">thread_set_flags()</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l02990">lfsck_namespace_double_scan_dir()</a>.</p>

</div>
</div>
<a class="anchor" id="ac05919cafd21a01843ab5464d3b5fcc6"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_set_lmv_master" ref="ac05919cafd21a01843ab5464d3b5fcc6" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, struct lmv_mds_md_v1 *lmv, const struct lu_fid *cfid, __u32 cidx, __u32 flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_namespace_set_lmv_master </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>cfid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>cidx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Set master LMV EA for the specified striped directory. </p>
<p>First, if the master MDT-object of a striped directory lost its LMV EA, then there may be some users have created some files under the master MDT-object directly. Under such case, the LFSCK cannot re-generate LMV EA for the master MDT-object, because we should keep the existing files to be visible to client. Then the LFSCK will mark the striped directory as read-only and keep it there to be handled by administrator manually.</p>
<p>If nobody has created files under the master MDT-object of the striped directory, then we will set the master LMV EA and generate a new rescan (the striped directory) request that will be handled later by the LFSCK instance on the MDT later.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the object on which the LMV EA will be set </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lmv</em>&nbsp;</td><td>pointer to the buffer holding the new LMV EA </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cfid</em>&nbsp;</td><td>the shard's FID used for verification </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>cidx</em>&nbsp;</td><td>the shard's index used for verification </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>to indicate which element(s) in the LMV EA will be set</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">1359</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l01795">dt_object_remote()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="seq__range_8h_source.html#l00091">fld_range_set_mdt()</a>, <a class="el" href="fld__handler_8c_source.html#l00241">fld_server_lookup()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="packet-lustre_8c_source.html#l00291">LCK_EX</a>, <a class="el" href="lustre__idl_8h_source.html#l03471">LE_SET_LMV_MASTER</a>, <a class="el" href="lustre__idl_8h_source.html#l03479">LEF_SET_LMV_ALL</a>, <a class="el" href="lustre__idl_8h_source.html#l03478">LEF_SET_LMV_HASH</a>, <a class="el" href="lfsck__internal_8h_source.html#l00058">LF_INCONSISTENT</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01089">lfsck_allow_regenerate_master_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01226">lfsck_dev_site()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00202">lfsck_disable_master_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00415">lfsck_ibits_lock()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00436">lfsck_ibits_unlock()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01264">lfsck_namespace_notify_lmv_master_local()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01197">lfsck_namespace_notify_lmv_remote()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00993">lfsck_namespace_update_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lustre__idl_8h_source.html#l02622">LMV_HASH_FLAG_LOST_LMV</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02597">LMV_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00139">lfsck_namespace::ln_flags</a>, <a class="el" href="lustre__idl_8h_source.html#l00156">lu_seq_range::lsr_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00898">lfsck_thread_info::lti_lmv3</a>, <a class="el" href="lfsck__internal_8h_source.html#l00895">lfsck_thread_info::lti_range</a>, <a class="el" href="lustre__idl_8h_source.html#l02079">MDS_INODELOCK_UPDATE</a>, <a class="el" href="lustre__idl_8h_source.html#l02093">MDS_INODELOCK_XATTR</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, and <a class="el" href="lustre__fid_8h_source.html#l00458">seq_server_site::ss_server_fld</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01473">lfsck_namespace_repair_bad_name_hash()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01672">lfsck_namespace_verify_stripe_slave()</a>.</p>

</div>
</div>
<a class="anchor" id="a386b5a0ea946859c7ed3d9f2e7175af5"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_striped_dir_rescan" ref="a386b5a0ea946859c7ed3d9f2e7175af5" args="(const struct lu_env *env, struct lfsck_component *com, struct lfsck_namespace_req *lnr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_striped_dir_rescan </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *&nbsp;</td>
          <td class="paramname"> <em>lnr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Double scan the striped directory or the shard. </p>
<p>All the shards' under the given striped directory or its shard have been scanned, the LFSCK has got the global knownledge about the LMV EA consistency.</p>
<p>If the target is one shard of a striped directory, then only needs to update related tracing file.</p>
<p>If the target is the master MDT-object of a striped directory, then the LFSCK will make the decision about whether the master LMV EA is invalid or not, and repair it if inconsistenct; for every shard of the striped directory, whether the slave LMV EA is invalid or not, and repair it if inconsistent.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lnr</em>&nbsp;</td><td>pointer to the namespace request that contains the striped directory or the shard</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01817">1817</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="mmap__sanity_8c_source.html#l00053">dir</a>, <a class="el" href="dt__object_8h_source.html#l01795">dt_object_remote()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00156">fid_is_zero()</a>, <a class="el" href="seq__range_8h_source.html#l00091">fld_range_set_mdt()</a>, <a class="el" href="fld__handler_8c_source.html#l00241">fld_server_lookup()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00757">lfsck_assistant_req::lar_parent</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="packet-lustre_8c_source.html#l00291">LCK_EX</a>, <a class="el" href="lustre__linkea_8h_source.html#l00040">linkea_data::ld_leh</a>, <a class="el" href="lustre__idl_8h_source.html#l03472">LE_SET_LMV_SLAVE</a>, <a class="el" href="lustre__idl_8h_source.html#l03480">LEF_RECHECK_NAME_HASH</a>, <a class="el" href="lustre__idl_8h_source.html#l03674">link_ea_header::leh_reccount</a>, <a class="el" href="lfsck__lib_8c_source.html#l01982">lfsck_assistant_object_load()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01226">lfsck_dev_site()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00415">lfsck_ibits_lock()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00436">lfsck_ibits_unlock()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01206">lfsck_is_dead_obj()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01423">lfsck_links_read()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lfsck__internal_8h_source.html#l01094">lfsck_name_get_const()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01197">lfsck_namespace_notify_lmv_remote()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l01910">lfsck_namespace_rebuild_linkea()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l04790">lfsck_namespace_repair_dangling()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l01990">lfsck_namespace_repair_dirent()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00525">lfsck_namespace_trace_update()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00993">lfsck_namespace_update_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01296">lfsck_object_find_bottom_nowait()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="linkea_8c_source.html#l00113">linkea_add_buf()</a>, <a class="el" href="linkea_8c_source.html#l00034">linkea_data_new()</a>, <a class="el" href="linkea_8c_source.html#l00171">linkea_links_find()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00597">lfsck_lmv::ll_exit_value</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_failed</a>, <a class="el" href="lfsck__internal_8h_source.html#l00600">lfsck_lmv::ll_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_ignore</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_inline</a>, <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_slave</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_updated</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_verified</a>, <a class="el" href="lfsck__internal_8h_source.html#l00608">lfsck_lmv::ll_lslr</a>, <a class="el" href="lfsck__internal_8h_source.html#l00599">lfsck_lmv::ll_max_filled_off</a>, <a class="el" href="lfsck__internal_8h_source.html#l00598">lfsck_lmv::ll_max_stripe_count</a>, <a class="el" href="lustre__idl_8h_source.html#l02617">LMV_HASH_FLAG_BAD_TYPE</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02606">LMV_HASH_TYPE_MASK</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__lmv_8h_source.html#l00173">lmv_is_known_hash_type()</a>, <a class="el" href="lustre__idl_8h_source.html#l02588">lmv_mds_md_v1::lmv_layout_version</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02600">LMV_MAGIC_STRIPE</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00214">lfsck_namespace::ln_dangling_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00196">lfsck_namespace::ln_dirent_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00199">lfsck_namespace::ln_linkea_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00246">lfsck_namespace::ln_striped_dirs_failed</a>, <a class="el" href="lfsck__internal_8h_source.html#l00243">lfsck_namespace::ln_striped_dirs_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00240">lfsck_namespace::ln_striped_dirs_scanned</a>, <a class="el" href="lfsck__internal_8h_source.html#l00262">lfsck_namespace::ln_striped_shards_failed</a>, <a class="el" href="lfsck__internal_8h_source.html#l00259">lfsck_namespace::ln_striped_shards_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00256">lfsck_namespace::ln_striped_shards_scanned</a>, <a class="el" href="lfsck__internal_8h_source.html#l00763">lfsck_namespace_req::lnr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00761">lfsck_namespace_req::lnr_lar</a>, <a class="el" href="lfsck__internal_8h_source.html#l00762">lfsck_namespace_req::lnr_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00769">lfsck_namespace_req::lnr_name</a>, <a class="el" href="lfsck__internal_8h_source.html#l00767">lfsck_namespace_req::lnr_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00117">LNTF_RECHECK_NAME_HASH</a>, <a class="el" href="lfsck__internal_8h_source.html#l00116">LNTF_UNCERTAIN_LMV</a>, <a class="el" href="lfsck__internal_8h_source.html#l00574">LSLF_BAD_INDEX1</a>, <a class="el" href="lfsck__internal_8h_source.html#l00571">LSLF_BAD_INDEX2</a>, <a class="el" href="lfsck__internal_8h_source.html#l00573">LSLF_DANGLING</a>, <a class="el" href="lfsck__internal_8h_source.html#l00572">LSLF_NO_LMVEA</a>, <a class="el" href="lfsck__internal_8h_source.html#l00570">LSLF_NONE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00585">lfsck_slave_lmv_rec::lslr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00589">lfsck_slave_lmv_rec::lslr_flags</a>, <a class="el" href="lfsck__internal_8h_source.html#l00588">lfsck_slave_lmv_rec::lslr_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00587">lfsck_slave_lmv_rec::lslr_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00586">lfsck_slave_lmv_rec::lslr_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00364">lfsck_assistant_object::lso_fid</a>, <a class="el" href="lustre__idl_8h_source.html#l00156">lu_seq_range::lsr_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00861">lfsck_thread_info::lti_big_buf</a>, <a class="el" href="lfsck__internal_8h_source.html#l00897">lfsck_thread_info::lti_lmv2</a>, <a class="el" href="lfsck__internal_8h_source.html#l00895">lfsck_thread_info::lti_range</a>, <a class="el" href="lfsck__internal_8h_source.html#l00876">lfsck_thread_info::lti_tmpbuf</a>, <a class="el" href="lfsck__internal_8h_source.html#l00877">lfsck_thread_info::lti_tmpbuf2</a>, <a class="el" href="lnet_2utils_2debug_8c_source.html#l00068">max</a>, <a class="el" href="lustre__idl_8h_source.html#l02079">MDS_INODELOCK_UPDATE</a>, <a class="el" href="lustre__idl_8h_source.html#l02093">MDS_INODELOCK_XATTR</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lustre__fid_8h_source.html#l00458">seq_server_site::ss_server_fld</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l05012">lfsck_namespace_assistant_handler_p1()</a>.</p>

</div>
</div>
<a class="anchor" id="a12465f080d74c44e795ab94ce3b12f29"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_update_lmv" ref="a12465f080d74c44e795ab94ce3b12f29" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, struct lmv_mds_md_v1 *lmv, bool locked)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_update_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>locked</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update the object's LMV EA with the given . </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the object which LMV EA will be updated </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lmv</em>&nbsp;</td><td>pointer to buffer holding the new LMV EA </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>locked</em>&nbsp;</td><td>whether the caller has held ldlm lock on the  or not</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number for nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>if updated successfully </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00993">993</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="parallel__grouplock_8c_source.html#l00078">buf</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l02543">dt_declare_xattr_set()</a>, <a class="el" href="dt__object_8h_source.html#l01795">dt_object_remote()</a>, <a class="el" href="dt__object_8h_source.html#l02047">dt_trans_create()</a>, <a class="el" href="dt__object_8h_source.html#l02062">dt_trans_start_local()</a>, <a class="el" href="dt__object_8h_source.html#l02070">dt_trans_stop()</a>, <a class="el" href="dt__object_8h_source.html#l02175">dt_write_lock()</a>, <a class="el" href="dt__object_8h_source.html#l02194">dt_write_unlock()</a>, <a class="el" href="dt__object_8h_source.html#l02559">dt_xattr_set()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lfsck__internal_8h_source.html#l00090">lfsck_bookmark::lb_param</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="packet-lustre_8c_source.html#l00291">LCK_EX</a>, <a class="el" href="lfsck__internal_8h_source.html#l01105">lfsck_buf_init()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00415">lfsck_ibits_lock()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00436">lfsck_ibits_unlock()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01206">lfsck_is_dead_obj()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01468">lfsck_lmv_header_cpu_to_le()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01078">lfsck_obj2dev()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00681">lfsck_instance::li_bookmark_ram</a>, <a class="el" href="lustre__idl_8h_source.html#l02597">LMV_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__lfsck__user_8h_source.html#l00142">LPF_DRYRUN</a>, <a class="el" href="lfsck__internal_8h_source.html#l00858">lfsck_thread_info::lti_buf</a>, <a class="el" href="lfsck__internal_8h_source.html#l00899">lfsck_thread_info::lti_lmv4</a>, <a class="el" href="lustre__idl_8h_source.html#l02079">MDS_INODELOCK_UPDATE</a>, <a class="el" href="lustre__idl_8h_source.html#l02093">MDS_INODELOCK_XATTR</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="rename__many_8c_source.html#l00056">stop</a>, <a class="el" href="dt__object_8h_source.html#l01848">thandle::th_sync</a>, <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>, and <a class="el" href="lustre__idl_8h_source.html#l01596">XATTR_NAME_LMV</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01817">lfsck_namespace_striped_dir_rescan()</a>.</p>

</div>
</div>
<a class="anchor" id="acc843dd85fecd4c3fdd9a05361412a9f"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_namespace_verify_stripe_slave" ref="acc843dd85fecd4c3fdd9a05361412a9f" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, struct lfsck_lmv *llmv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_namespace_verify_stripe_slave </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__lmv.html">lfsck_lmv</a> *&nbsp;</td>
          <td class="paramname"> <em>llmv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Verify the slave object's (of striped directory) LMV EA. </p>
<p>For the slave object of a striped directory, before traversing the shard the LFSCK will verify whether its slave LMV EA matches its parent's master LMV EA or not.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the object which LMV EA will be checked </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>llmv</em>&nbsp;</td><td>pointer to buffer holding the slave LMV EA</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l01672">1672</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="lfsck__lib_8c_source.html#l00543">dotdot</a>, <a class="el" href="dt__object_8c_source.html#l00058">dt_key</a>, <a class="el" href="dt__object_8h_source.html#l02654">dt_lookup()</a>, <a class="el" href="dt__object_8h_source.html#l01790">dt_object_exists()</a>, <a class="el" href="dt__object_8c_source.html#l00184">dt_try_as_dir()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__idl_8h_source.html#l00793">fid_is_sane()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lustre__idl_8h_source.html#l03479">LEF_SET_LMV_ALL</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00277">lfsck_is_valid_slave_lmv()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l06404">lfsck_links_get_first()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00525">lfsck_namespace_trace_update()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01283">lfsck_object_find_bottom()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">lfsck_read_stripe_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_lmv_verified</a>, <a class="el" href="lustre__idl_8h_source.html#l02617">LMV_HASH_FLAG_BAD_TYPE</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02606">LMV_HASH_TYPE_MASK</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__idl_8h_source.html#l02597">LMV_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00116">LNTF_UNCERTAIN_LMV</a>, <a class="el" href="lfsck__internal_8h_source.html#l00864">lfsck_thread_info::lti_fid3</a>, <a class="el" href="lfsck__internal_8h_source.html#l00875">lfsck_thread_info::lti_key</a>, <a class="el" href="lfsck__internal_8h_source.html#l00896">lfsck_thread_info::lti_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00877">lfsck_thread_info::lti_tmpbuf2</a>, <a class="el" href="lustre__idl_8h_source.html#l00801">lu_fid_eq()</a>, <a class="el" href="mdt__coordinator_8c_source.html#l01693">name</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__namespace_8c_source.html#l03837">lfsck_namespace_open_dir()</a>.</p>

</div>
</div>
<a class="anchor" id="a248445b5a863838c6de16febb9ff50b0"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_read_stripe_lmv" ref="a248445b5a863838c6de16febb9ff50b0" args="(const struct lu_env *env, struct dt_object *obj, struct lmv_mds_md_v1 *lmv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_read_stripe_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00841">841</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="dt__object_8h_source.html#l02165">dt_read_lock()</a>, <a class="el" href="dt__object_8h_source.html#l02185">dt_read_unlock()</a>, <a class="el" href="dt__object_8h_source.html#l02588">dt_xattr_get()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01112">lfsck_buf_get()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01458">lfsck_lmv_header_le_to_cpu()</a>, <a class="el" href="lustre__idl_8h_source.html#l02608">LMV_HASH_FLAG_MIGRATION</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__idl_8h_source.html#l02597">LMV_MAGIC</a>, <a class="el" href="lustre__idl_8h_source.html#l02577">lmv_mds_md_v1::lmv_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l02600">LMV_MAGIC_STRIPE</a>, and <a class="el" href="lustre__idl_8h_source.html#l01596">XATTR_NAME_LMV</a>.</p>

<p>Referenced by <a class="el" href="lfsck__engine_8c_source.html#l00225">lfsck_load_stripe_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00948">lfsck_namespace_check_name()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l02328">lfsck_namespace_dsd_single()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l02248">lfsck_namespace_handle_striped_master()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01264">lfsck_namespace_notify_lmv_master_local()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01545">lfsck_namespace_scan_shard()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l01359">lfsck_namespace_set_lmv_master()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l01672">lfsck_namespace_verify_stripe_slave()</a>.</p>

</div>
</div>
<a class="anchor" id="aae9daf2aa97925c73c3351fc71d30247"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_record_lmv" ref="aae9daf2aa97925c73c3351fc71d30247" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *dir, struct lfsck_namespace_req *lnr, struct lmv_mds_md_v1 *lmv, __u32 shard_idx, __u32 flags, __u32 flags2, __u32 *depth)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_record_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *&nbsp;</td>
          <td class="paramname"> <em>lnr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>shard_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>flags2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32 *&nbsp;</td>
          <td class="paramname"> <em>depth</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Record the slave LMV EA in the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a>. </p>
<p>If the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a> slot corresponding to the given  is free, then fill the slot with the given // directly (maybe need to extend the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a> buffer).</p>
<p>If the <a class="el" href="structlfsck__lmv.html#a336362d57069fe85f44c450ad1c52a44">lfsck_lmv::ll_lslr</a> slot corresponding to the given  is taken by other shard, then the LFSCK will try to resolve the conflict by checking the two conflict shards' flags, and try other possible slot (if one of them claims another possible ).</p>
<p>1) If one of the two conflict shards can be recorded in another slot, then it is OK, go ahead. Otherwise,</p>
<p>2) If one of them is dangling name entry, then remove (one of) the dangling name entry (and replace related  slot if needed). Otherwise,</p>
<p>3) If one of them has no slave LMV EA, then check whether the master LMV EA has ever been lost and re-generated (LMV_HASH_FLAG_LOST_LMV in the master LMV EA).</p>
<p>3.1) If yes, then it is possible that such object is not a real shard of the striped directory, instead, it was created by someone after the master LMV EA lost with the name that matches the shard naming rule. Then the LFSCK will remove the master LMV EA and mark the striped directory as read-only to allow those non-shard files to be visible to client.</p>
<p>3.2) If no, then remove (one of) the object what has no slave LMV EA.</p>
<p>4) If all above efforts cannot work, then the LFSCK cannot know how to recover the striped directory. To make the administrator can see the conflicts, the LFSCK will remove the master LMV EA and mark the striped directory as read-only.</p>
<p>This function may be called recursively, to prevent overflow, we define LFSCK_REC_LMV_MAX_DEPTH to restrict the recursive call depth.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>dir</em>&nbsp;</td><td>pointer to the striped directory to be handled </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lnr</em>&nbsp;</td><td>contain the shard's FID to fill the  slot, it also records the known max filled index and the known max stripe count </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lmv</em>&nbsp;</td><td>pointer to the slave LMV EA to be recorded </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>shard_idx</em>&nbsp;</td><td>the shard's index used for locating the  slot, it can be the index stored in the shard's name, it also can be the index stored in the slave LMV EA (for recursive case) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>the shard's flags to be recorded in the  slot to indicate the shard status, such as whether has slave LMV EA, whether dangling name entry, whether the name entry and slave LMV EA unmatched, and ect </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags2</em>&nbsp;</td><td>when be called recursively, the  tells the former conflict shard's flags in the  slot. </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>depth</em>&nbsp;</td><td>To prevent to be called recurisively too deep, we define the max depth can be called recursively (LFSCK_REC_LMV_MAX_DEPTH)</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ERANGE</em>&nbsp;</td><td>for invalid  </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EEXIST</em>&nbsp;</td><td>for the required lslr slot has been occupied by other shard </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>other</em>&nbsp;</td><td>negative error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00485">485</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00157">D_LFSCK</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00156">fid_is_zero()</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l01138">lfsck_dto2fid()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01133">lfsck_lfsck2name()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lfsck__namespace_8c_source.html#l00525">lfsck_namespace_trace_update()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00631">LFSCK_REC_LMV_MAX_DEPTH</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00334">lfsck_remove_dirent()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00301">lfsck_remove_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00385">lfsck_replace_lmv()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00735">lfsck_instance::li_rec_lmv_save</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_failed</a>, <a class="el" href="lfsck__internal_8h_source.html#l00600">lfsck_lmv::ll_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00593">lfsck_lmv::ll_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00608">lfsck_lmv::ll_lslr</a>, <a class="el" href="lfsck__internal_8h_source.html#l00599">lfsck_lmv::ll_max_filled_off</a>, <a class="el" href="lfsck__internal_8h_source.html#l00598">lfsck_lmv::ll_max_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00595">lfsck_lmv::ll_stripes_allocated</a>, <a class="el" href="lfsck__internal_8h_source.html#l00596">lfsck_lmv::ll_stripes_filled</a>, <a class="el" href="lustre__idl_8h_source.html#l02622">LMV_HASH_FLAG_LOST_LMV</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__lmv_8h_source.html#l00173">lmv_is_known_hash_type()</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00763">lfsck_namespace_req::lnr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00762">lfsck_namespace_req::lnr_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00113">LNTF_CHECK_PARENT</a>, <a class="el" href="lfsck__internal_8h_source.html#l00626">lfsck_rec_lmv_save::lrls_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00627">lfsck_rec_lmv_save::lrls_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00574">LSLF_BAD_INDEX1</a>, <a class="el" href="lfsck__internal_8h_source.html#l00571">LSLF_BAD_INDEX2</a>, <a class="el" href="lfsck__internal_8h_source.html#l00573">LSLF_DANGLING</a>, <a class="el" href="lfsck__internal_8h_source.html#l00572">LSLF_NO_LMVEA</a>, <a class="el" href="lfsck__internal_8h_source.html#l00570">LSLF_NONE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00585">lfsck_slave_lmv_rec::lslr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00589">lfsck_slave_lmv_rec::lslr_flags</a>, <a class="el" href="lfsck__internal_8h_source.html#l00588">lfsck_slave_lmv_rec::lslr_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00587">lfsck_slave_lmv_rec::lslr_index</a>, <a class="el" href="lfsck__internal_8h_source.html#l00586">lfsck_slave_lmv_rec::lslr_stripe_count</a>, <a class="el" href="lustre__idl_8h_source.html#l00801">lu_fid_eq()</a>, <a class="el" href="obd__support_8h_source.html#l00747">OBD_ALLOC_LARGE</a>, <a class="el" href="obd__support_8h_source.html#l00783">OBD_FREE_LARGE</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l02248">lfsck_namespace_handle_striped_master()</a>.</p>

</div>
</div>
<a class="anchor" id="a90e99ac26c2296a1dd4b5e483751ff83"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_remove_dirent" ref="a90e99ac26c2296a1dd4b5e483751ff83" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *dir, const struct lu_fid *fid, __u32 index)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_remove_dirent </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>index</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove the name entry from the striped directory's master MDT-object. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>dir</em>&nbsp;</td><td>pointer to the striped directory </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>the shard's FID which name entry will be removed </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>index</em>&nbsp;</td><td>the shard's index which name entry will be removed</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number for repaired successfully </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>if nothing to be repaired </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00334">334</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="lfsck__internal_8h_source.html#l00542">lfsck_component::lc_file_ram</a>, <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l01990">lfsck_namespace_repair_dirent()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01283">lfsck_object_find_bottom()</a>, <a class="el" href="lfsck__internal_8h_source.html#l01219">lfsck_object_put()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00196">lfsck_namespace::ln_dirent_repaired</a>, <a class="el" href="lfsck__internal_8h_source.html#l00877">lfsck_thread_info::lti_tmpbuf2</a>, and <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l00485">lfsck_record_lmv()</a>, and <a class="el" href="lfsck__striped__dir_8c_source.html#l00385">lfsck_replace_lmv()</a>.</p>

</div>
</div>
<a class="anchor" id="a336643e78703bfe4839729b3b5501dd5"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_remove_lmv" ref="a336643e78703bfe4839729b3b5501dd5" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *obj, struct lfsck_namespace_req *lnr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_remove_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *&nbsp;</td>
          <td class="paramname"> <em>lnr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove the striped directory's master LMV EA and mark it as read-only. </p>
<p>Take ldlm lock on the striped directory before calling the <a class="el" href="lfsck__striped__dir_8c.html#a3a0202c370662cf9ca3faeb986d29208" title="Mark the specified directory as read-only by set LUSTRE_IMMUTABLE_FL.">lfsck_disable_master_lmv()</a>.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>obj</em>&nbsp;</td><td>pointer to the striped directory to be handled </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lnr</em>&nbsp;</td><td>pointer to the namespace request that contains the striped directory to be handled and other information</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>positive</em>&nbsp;</td><td>number if nothing to be done </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00301">301</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lfsck__internal_8h_source.html#l00538">lfsck_component::lc_lfsck</a>, <a class="el" href="packet-lustre_8c_source.html#l00291">LCK_EX</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00202">lfsck_disable_master_lmv()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00415">lfsck_ibits_lock()</a>, <a class="el" href="lfsck__lib_8c_source.html#l00436">lfsck_ibits_unlock()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00601">lfsck_lmv::ll_ignore</a>, <a class="el" href="lfsck__internal_8h_source.html#l00762">lfsck_namespace_req::lnr_lmv</a>, <a class="el" href="lustre__idl_8h_source.html#l02079">MDS_INODELOCK_UPDATE</a>, and <a class="el" href="lustre__idl_8h_source.html#l02093">MDS_INODELOCK_XATTR</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l00485">lfsck_record_lmv()</a>.</p>

</div>
</div>
<a class="anchor" id="a86253d7a8a8314c29c6b8182fc4cd941"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_replace_lmv" ref="a86253d7a8a8314c29c6b8182fc4cd941" args="(const struct lu_env *env, struct lfsck_component *com, struct dt_object *dir, struct lfsck_slave_lmv_rec *lslr, struct lfsck_namespace_req *lnr, struct lmv_mds_md_v1 *lmv, __u32 index, __u32 flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lfsck_replace_lmv </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__component.html">lfsck_component</a> *&nbsp;</td>
          <td class="paramname"> <em>com</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__slave__lmv__rec.html">lfsck_slave_lmv_rec</a> *&nbsp;</td>
          <td class="paramname"> <em>lslr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlfsck__namespace__req.html">lfsck_namespace_req</a> *&nbsp;</td>
          <td class="paramname"> <em>lnr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlmv__mds__md__v1.html">lmv_mds_md_v1</a> *&nbsp;</td>
          <td class="paramname"> <em>lmv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove old shard's name entry and refill the  slot with new shard. </p>
<p>Some old shard held the specified  slot, but it is an invalid shard. This function will remove the bad shard's name entry, and refill the  slot with the new shard.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>com</em>&nbsp;</td><td>pointer to the lfsck component </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>dir</em>&nbsp;</td><td>pointer to the striped directory to be handled </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lslr</em>&nbsp;</td><td>pointer to lfsck_disable_master_lmv slot which content will be replaced by the given information </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lnr</em>&nbsp;</td><td>contain the shard's FID to be used to fill the  slot, it also records the known max filled index and the known max stripe count </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lmv</em>&nbsp;</td><td>contain the slave LMV EA to be used to fill the  slot </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>index</em>&nbsp;</td><td>the old shard's index in the striped directory </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>the new shard's flags in the  slot</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>for success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00385">385</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00334">lfsck_remove_dirent()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00600">lfsck_lmv::ll_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00598">lfsck_lmv::ll_max_stripe_count</a>, <a class="el" href="lustre__idl_8h_source.html#l02582">lmv_mds_md_v1::lmv_hash_type</a>, <a class="el" href="lustre__user_8h_source.html#l00447">LMV_HASH_TYPE_UNKNOWN</a>, <a class="el" href="lustre__lmv_8h_source.html#l00173">lmv_is_known_hash_type()</a>, <a class="el" href="lustre__idl_8h_source.html#l02579">lmv_mds_md_v1::lmv_master_mdt_index</a>, <a class="el" href="lustre__idl_8h_source.html#l02578">lmv_mds_md_v1::lmv_stripe_count</a>, <a class="el" href="lfsck__internal_8h_source.html#l00763">lfsck_namespace_req::lnr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00762">lfsck_namespace_req::lnr_lmv</a>, <a class="el" href="lfsck__internal_8h_source.html#l00570">LSLF_NONE</a>, <a class="el" href="lfsck__internal_8h_source.html#l00585">lfsck_slave_lmv_rec::lslr_fid</a>, <a class="el" href="lfsck__internal_8h_source.html#l00589">lfsck_slave_lmv_rec::lslr_flags</a>, <a class="el" href="lfsck__internal_8h_source.html#l00588">lfsck_slave_lmv_rec::lslr_hash_type</a>, <a class="el" href="lfsck__internal_8h_source.html#l00587">lfsck_slave_lmv_rec::lslr_index</a>, and <a class="el" href="lfsck__internal_8h_source.html#l00586">lfsck_slave_lmv_rec::lslr_stripe_count</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l00485">lfsck_record_lmv()</a>.</p>

</div>
</div>
<a class="anchor" id="a85d16d415e427fa3c8d7aa008453644b"></a><!-- doxytag: member="lfsck_striped_dir.c::lfsck_shard_name_to_index" ref="a85d16d415e427fa3c8d7aa008453644b" args="(const struct lu_env *env, const char *name, int namelen, __u16 type, const struct lu_fid *fid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lfsck_shard_name_to_index </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>namelen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u16&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__fid.html">lu_fid</a> *&nbsp;</td>
          <td class="paramname"> <em>fid</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Parse the shard's index from the given shard name. </p>
<p>The valid shard name/type should be: 1) The type must be S_IFDIR 2) The name should be $FID:$index 3) the index should within valid range.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>pointer to the thread context </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>name</em>&nbsp;</td><td>the shard name </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>namelen</em>&nbsp;</td><td>the name length </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>type</em>&nbsp;</td><td>the entry's type </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>fid</em>&nbsp;</td><td>the entry's FID</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>zero</em>&nbsp;</td><td>or positive number for the index from the name </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>error number on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lfsck__striped__dir_8c_source.html#l00880">880</a> of file <a class="el" href="lfsck__striped__dir_8c_source.html">lfsck_striped_dir.c</a>.</p>

<p>References <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lfsck__internal_8h_source.html#l01084">lfsck_env_info()</a>, <a class="el" href="lfsck__internal_8h_source.html#l00564">LFSCK_LMV_MAX_STRIPES</a>, <a class="el" href="lfsck__internal_8h_source.html#l00877">lfsck_thread_info::lti_tmpbuf2</a>, and <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>.</p>

<p>Referenced by <a class="el" href="lfsck__striped__dir_8c_source.html#l01089">lfsck_allow_regenerate_master_lmv()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l00948">lfsck_namespace_check_name()</a>, <a class="el" href="lfsck__namespace_8c_source.html#l02328">lfsck_namespace_dsd_single()</a>, <a class="el" href="lfsck__striped__dir_8c_source.html#l02248">lfsck_namespace_handle_striped_master()</a>, and <a class="el" href="lfsck__namespace_8c_source.html#l04790">lfsck_namespace_repair_dangling()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:47 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
