<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/lod/lod_qos.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/lod/lod_qos.c File Reference</h1><code>#include &lt;asm/div64.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="libcfs_8h_source.html">libcfs/libcfs.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__idl_8h_source.html">lustre/lustre_idl.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="lustre__swab_8h_source.html">lustre_swab.h</a>&gt;</code><br/>
<code>#include &lt;<a class="el" href="obd__class_8h_source.html">obd_class.h</a>&gt;</code><br/>
<code>#include &quot;<a class="el" href="lod__internal_8h_source.html">lod_internal.h</a>&quot;</code><br/>

<p><a href="lod__qos_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_LOV</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a3a88dda8318462d958b290cd9ff9543d">FORCE_QOS_</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a0b0b8d975819c83dc86124e4c939115c">D_QOS</a>&nbsp;&nbsp;&nbsp;D_OTHER</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a4e7972d66a48ea8e1ce8974f04d4f638">QOS_DEBUG</a>(fmt,...)&nbsp;&nbsp;&nbsp;CDEBUG(D_QOS, fmt, ## __VA_ARGS__)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a3934f038261078abfd3f0e90fcd2e12d">QOS_CONSOLE</a>(fmt,...)&nbsp;&nbsp;&nbsp;LCONSOLE(D_QOS, fmt, ## __VA_ARGS__)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#aafbcbd8d00133ce86e63436e165492b2">TGT_BAVAIL</a>(i)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a2fef97610223d3b874eecde9e124348f">LOV_QOS_EMPTY</a>&nbsp;&nbsp;&nbsp;((__u32)-1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a1146ae16b5e7ce24eb82380c7f642d64">LOV_CREATE_RESEED_MULT</a>&nbsp;&nbsp;&nbsp;30</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a99d1ce3b91d52b064cb308116166380c">LOV_CREATE_RESEED_MIN</a>&nbsp;&nbsp;&nbsp;2000</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#ad35586b02932a00478563eaf603af497">qos_add_tgt</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, struct <a class="el" href="structlod__tgt__desc.html">lod_tgt_desc</a> *ost_desc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add a new target to Quality of Service (QoS) target table.  <a href="#ad35586b02932a00478563eaf603af497"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#adb3c522d7fb6194821780684f5b82d76">qos_del_tgt</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, struct <a class="el" href="structlod__tgt__desc.html">lod_tgt_desc</a> *ost_desc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove OST target from QoS table.  <a href="#adb3c522d7fb6194821780684f5b82d76"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a23d6ff412d6cd3d8856aa8862d953739">lod_statfs_and_check</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__device.html">lod_device</a> *d, int index, struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *sfs)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether the target is available for new OST objects.  <a href="#a23d6ff412d6cd3d8856aa8862d953739"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a20186d22e469ddbd8cfc749dcef63d7c">lod_qos_statfs_update</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__device.html">lod_device</a> *lod)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Maintain per-target statfs data.  <a href="#a20186d22e469ddbd8cfc749dcef63d7c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#acc18ff2f0e06a1cd935366f9cb510fea">lod_qos_calc_ppo</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate per-OST and per-OSS penalties.  <a href="#acc18ff2f0e06a1cd935366f9cb510fea"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a8450c3af79a063a426605f608dd6056b">lod_qos_calc_weight</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, int i)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate weight for a given OST target.  <a href="#a8450c3af79a063a426605f608dd6056b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a405d704970506f8898934f5f2f2c7879">lod_qos_used</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, struct <a class="el" href="structost__pool.html">ost_pool</a> *osts, __u32 index, <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *total_wt)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Re-calculate weights.  <a href="#a405d704970506f8898934f5f2f2c7879"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a5fb30590b55854931da51ad522e6014f">lod_qos_rr_init</a> (struct <a class="el" href="structlod__qos__rr.html">lod_qos_rr</a> *lqr)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a589c351cca750871729a317919b74ba5">lod_qos_calc_rr</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, struct <a class="el" href="structost__pool.html">ost_pool</a> *src_pool, struct <a class="el" href="structlod__qos__rr.html">lod_qos_rr</a> *lqr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate optimal round-robin order with regard to OSSes.  <a href="#a589c351cca750871729a317919b74ba5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structdt__object.html">dt_object</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#afb768f4724d670f4a53652bc55caccb8">lod_qos_declare_object_on</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__device.html">lod_device</a> *d, __u32 ost_idx, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Instantiate and declare creation of a new object.  <a href="#afb768f4724d670f4a53652bc55caccb8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a58b385a892107b48477304dfe7067126">min_stripe_count</a> (__u32 stripe_cnt, int flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calculate a minimum acceptable stripe count.  <a href="#a58b385a892107b48477304dfe7067126"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a3664293f79142f2643171939ab78a1d9">lod_qos_dev_is_full</a> (struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *msfs)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check if an OST is full.  <a href="#a3664293f79142f2643171939ab78a1d9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#adb6f000b7fc44e9aa2fb5b5ba5596daa">lod_qos_ost_in_use_clear</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, __u32 <a class="el" href="mdsrate_8c.html#ad772c21043d0158114c40cad5c2f3d4c">stripes</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize temporary OST-in-use array.  <a href="#adb6f000b7fc44e9aa2fb5b5ba5596daa"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a1bfa41dca5ef02d45c5eeecc877abb15">lod_qos_ost_in_use</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, int idx, int ost)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remember a target in the array of used targets.  <a href="#a1bfa41dca5ef02d45c5eeecc877abb15"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a37de9666b442817fc402c4f96c0395c1">lod_qos_is_ost_used</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, int ost, __u32 <a class="el" href="mdsrate_8c.html#ad772c21043d0158114c40cad5c2f3d4c">stripes</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check is OST used in a striping.  <a href="#a37de9666b442817fc402c4f96c0395c1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#af7f08327090f6a3c3e369ec22362fde0">lod_check_and_reserve_ost</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__device.html">lod_device</a> *m, struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *sfs, __u32 ost_idx, __u32 speed, __u32 *s_idx, struct <a class="el" href="structdt__object.html">dt_object</a> **stripe, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#ab925384f4f8df7714509cf360ff549c2">lod_alloc_rr</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, struct <a class="el" href="structdt__object.html">dt_object</a> **stripe, int flags, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate a striping using round-robin algorithm.  <a href="#ab925384f4f8df7714509cf360ff549c2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a157b289daaff8d4ca8283b1ec2f40ee6">lod_alloc_ost_list</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, struct <a class="el" href="structdt__object.html">dt_object</a> **stripe, struct lov_user_md *lum, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate a specific striping layout on a user defined set of OSTs.  <a href="#a157b289daaff8d4ca8283b1ec2f40ee6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#ac4e9f0129da838960f944d8ac2046341">lod_alloc_specific</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, struct <a class="el" href="structdt__object.html">dt_object</a> **stripe, int flags, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate a striping on a predefined set of OSTs.  <a href="#ac4e9f0129da838960f944d8ac2046341"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a26e41dde83f817fb4ac8c544e59bc626">lod_qos_is_usable</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check whether QoS allocation should be used.  <a href="#a26e41dde83f817fb4ac8c544e59bc626"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#ae440e167e4f964f9c63f1a2b14aaa46b">lod_alloc_qos</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, struct <a class="el" href="structdt__object.html">dt_object</a> **stripe, int flags, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate a striping using an algorithm with weights.  <a href="#ae440e167e4f964f9c63f1a2b14aaa46b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static __u16&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#ae3c35ef314ac6a75e79951f0f2125c50">lod_get_stripecnt</a> (struct <a class="el" href="structlod__device.html">lod_device</a> *lod, __u32 magic, __u16 stripe_count)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find largest stripe count the caller can use.  <a href="#ae3c35ef314ac6a75e79951f0f2125c50"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#afa1a950572d092876cb1246413d9342c">lod_use_defined_striping</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *mo, const struct <a class="el" href="structlu__buf.html">lu_buf</a> *<a class="el" href="lnet_2utils_2debug_8c.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create in-core respresentation for a fully-defined striping.  <a href="#afa1a950572d092876cb1246413d9342c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a6b20eb75ce250278dab3d3f2e7cf8dc3">lod_qos_parse_config</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, const struct <a class="el" href="structlu__buf.html">lu_buf</a> *<a class="el" href="lnet_2utils_2debug_8c.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse suggested striping configuration.  <a href="#a6b20eb75ce250278dab3d3f2e7cf8dc3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="lod__qos_8c.html#a8f23abfd59d0b5ed5e6240f02f34a898">lod_qos_prep_create</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structlod__object.html">lod_object</a> *lo, struct <a class="el" href="structlu__attr.html">lu_attr</a> *attr, const struct <a class="el" href="structlu__buf.html">lu_buf</a> *<a class="el" href="lnet_2utils_2debug_8c.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a>, struct <a class="el" href="structthandle.html">thandle</a> *th)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create a striping for an obejct.  <a href="#a8f23abfd59d0b5ed5e6240f02f34a898"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a0b0b8d975819c83dc86124e4c939115c"></a><!-- doxytag: member="lod_qos.c::D_QOS" ref="a0b0b8d975819c83dc86124e4c939115c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define D_QOS&nbsp;&nbsp;&nbsp;D_OTHER</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00053">53</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00074">qos_add_tgt()</a>, and <a class="el" href="lod__qos_8c_source.html#l00145">qos_del_tgt()</a>.</p>

</div>
</div>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="lod_qos.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_LOV</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00038">38</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

</div>
</div>
<a class="anchor" id="a3a88dda8318462d958b290cd9ff9543d"></a><!-- doxytag: member="lod_qos.c::FORCE_QOS_" ref="a3a88dda8318462d958b290cd9ff9543d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FORCE_QOS_</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00051">51</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

</div>
</div>
<a class="anchor" id="a99d1ce3b91d52b064cb308116166380c"></a><!-- doxytag: member="lod_qos.c::LOV_CREATE_RESEED_MIN" ref="a99d1ce3b91d52b064cb308116166380c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOV_CREATE_RESEED_MIN&nbsp;&nbsp;&nbsp;2000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00742">742</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="a1146ae16b5e7ce24eb82380c7f642d64"></a><!-- doxytag: member="lod_qos.c::LOV_CREATE_RESEED_MULT" ref="a1146ae16b5e7ce24eb82380c7f642d64" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOV_CREATE_RESEED_MULT&nbsp;&nbsp;&nbsp;30</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00741">741</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="a2fef97610223d3b874eecde9e124348f"></a><!-- doxytag: member="lod_qos.c::LOV_QOS_EMPTY" ref="a2fef97610223d3b874eecde9e124348f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOV_QOS_EMPTY&nbsp;&nbsp;&nbsp;((__u32)-1)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00541">541</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>, and <a class="el" href="lod__qos_8c_source.html#l00559">lod_qos_calc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="a3934f038261078abfd3f0e90fcd2e12d"></a><!-- doxytag: member="lod_qos.c::QOS_CONSOLE" ref="a3934f038261078abfd3f0e90fcd2e12d" args="(fmt,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define QOS_CONSOLE</td>
          <td>(</td>
          <td class="paramtype">fmt, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"> <em>...</em>&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;LCONSOLE(D_QOS, fmt, ## __VA_ARGS__)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00056">56</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00559">lod_qos_calc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="a4e7972d66a48ea8e1ce8974f04d4f638"></a><!-- doxytag: member="lod_qos.c::QOS_DEBUG" ref="a4e7972d66a48ea8e1ce8974f04d4f638" args="(fmt,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define QOS_DEBUG</td>
          <td>(</td>
          <td class="paramtype">fmt, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"> <em>...</em>&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;CDEBUG(D_QOS, fmt, ## __VA_ARGS__)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00055">55</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>, <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>, and <a class="el" href="lod__qos_8c_source.html#l00457">lod_qos_used()</a>.</p>

</div>
</div>
<a class="anchor" id="aafbcbd8d00133ce86e63436e165492b2"></a><!-- doxytag: member="lod_qos.c::TGT_BAVAIL" ref="aafbcbd8d00133ce86e63436e165492b2" args="(i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TGT_BAVAIL</td>
          <td>(</td>
          <td class="paramtype">i&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Value:</b><div class="fragment"><pre class="fragment">(<a class="code" href="lod__internal_8h.html#a48a72349146d5033ba67b2f2326a3e44">OST_TGT</a>(lod,i)-&gt;ltd_statfs.os_bavail * \
                       <a class="code" href="lod__internal_8h.html#a48a72349146d5033ba67b2f2326a3e44">OST_TGT</a>(lod,i)-&gt;ltd_statfs.os_bsize)
</pre></div>
<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00058">58</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00310">lod_qos_calc_ppo()</a>, <a class="el" href="lod__qos_8c_source.html#l00429">lod_qos_calc_weight()</a>, and <a class="el" href="lod__qos_8c_source.html#l00457">lod_qos_used()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a157b289daaff8d4ca8283b1ec2f40ee6"></a><!-- doxytag: member="lod_qos.c::lod_alloc_ost_list" ref="a157b289daaff8d4ca8283b1ec2f40ee6" args="(const struct lu_env *env, struct lod_object *lo, struct dt_object **stripe, struct lov_user_md *lum, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_alloc_ost_list </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> **&nbsp;</td>
          <td class="paramname"> <em>stripe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct lov_user_md *&nbsp;</td>
          <td class="paramname"> <em>lum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a specific striping layout on a user defined set of OSTs. </p>
<p>Allocates new striping using the OST index range provided by the data from the lmm_obejcts contained in the lov_user_md passed to this method. Full OSTs are not considered. The exact order of OSTs requested by the user is respected as much as possible depending on OST status. The number of stripes needed and stripe offset are taken from the object. If that number can not be met, then the function returns a failure and then it's the caller's responsibility to release the stripes allocated. All the internal structures are protected, but no concurrent allocation is allowed on the same objects.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>stripe</em>&nbsp;</td><td>striping created </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lum</em>&nbsp;</td><td>stripe md to specify list of OSTs </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENODEV</em>&nbsp;</td><td>OST index does not exist on file system </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINVAL</em>&nbsp;</td><td>requested OST index is invalid </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01084">1084</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00380">lov_user_ost_data_v1::l_ost_idx</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lod__internal_8h_source.html#l00269">lod_object::ldo_def_stripe_offset</a>, <a class="el" href="lod__internal_8h_source.html#l00246">lod_object::ldo_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lustre__user_8h_source.html#l00412">lov_user_md_v3::lmm_objects</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="lod__internal_8h_source.html#l00331">lod2obd()</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__qos_8c_source.html#l00674">lod_qos_declare_object_on()</a>, <a class="el" href="lod__qos_8c_source.html#l00828">lod_qos_is_ost_used()</a>, <a class="el" href="lod__qos_8c_source.html#l00805">lod_qos_ost_in_use()</a>, <a class="el" href="lod__qos_8c_source.html#l00780">lod_qos_ost_in_use_clear()</a>, <a class="el" href="lod__qos_8c_source.html#l00190">lod_statfs_and_check()</a>, <a class="el" href="lustre__user_8h_source.html#l00341">LOV_USER_MAGIC_SPECIFIC</a>, <a class="el" href="lod__internal_8h_source.html#l00298">lod_thread_info::lti_osfs</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="pack__generic_8c_source.html#l02114">lustre_print_user_md()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="ae440e167e4f964f9c63f1a2b14aaa46b"></a><!-- doxytag: member="lod_qos.c::lod_alloc_qos" ref="ae440e167e4f964f9c63f1a2b14aaa46b" args="(const struct lu_env *env, struct lod_object *lo, struct dt_object **stripe, int flags, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_alloc_qos </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> **&nbsp;</td>
          <td class="paramname"> <em>stripe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a striping using an algorithm with weights. </p>
<p>The function allocates OST objects to create a striping. The algorithm used is based on weights (currently only using the free space), and it's trying to ensure the space is used evenly by OSTs and OSSs. The striping configuration (# of stripes, offset, pool) is taken from the object and is prepared by the caller.</p>
<p>If LOV_USES_DEFAULT_STRIPE is not passed and prepared configuration can't be met due to too few OSTs, then allocation fails. If the flag is passed fewer than 3/4 of the requested number of stripes can be allocated, then allocation fails.</p>
<p>No concurrent allocation is allowed on the object and this must be ensured by the caller. All the internal structures are protected by the function.</p>
<p>The algorithm has two steps: find available OSTs and calculate their weights, then select the OSTs with their weights used as the probability. An OST with a higher weight is proportionately more likely to be selected than one with a lower weight.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>stripe</em>&nbsp;</td><td>striping created </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>0 or LOV_USES_DEFAULT_STRIPE </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EAGAIN</em>&nbsp;</td><td>not enough OSTs are found for specified stripe count </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINVAL</em>&nbsp;</td><td>requested OST index is invalid </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>errno on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01375">1375</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="prng_8c_source.html#l00078">cfs_rand()</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00283">LCONSOLE_INFO</a>, <a class="el" href="lod__internal_8h_source.html#l00246">lod_object::ldo_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00255">lod_object::ldo_pool</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__pool_8c_source.html#l00909">lod_find_pool()</a>, <a class="el" href="lod__internal_8h_source.html#l00204">lod_device::lod_pool_info</a>, <a class="el" href="lod__pool_8c_source.html#l00095">lod_pool_putref()</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__qos_8c_source.html#l00310">lod_qos_calc_ppo()</a>, <a class="el" href="lod__qos_8c_source.html#l00429">lod_qos_calc_weight()</a>, <a class="el" href="lod__qos_8c_source.html#l00674">lod_qos_declare_object_on()</a>, <a class="el" href="lod__qos_8c_source.html#l00755">lod_qos_dev_is_full()</a>, <a class="el" href="lod__qos_8c_source.html#l00828">lod_qos_is_ost_used()</a>, <a class="el" href="lod__qos_8c_source.html#l01325">lod_qos_is_usable()</a>, <a class="el" href="lod__qos_8c_source.html#l00805">lod_qos_ost_in_use()</a>, <a class="el" href="lod__qos_8c_source.html#l00780">lod_qos_ost_in_use_clear()</a>, <a class="el" href="lod__qos_8c_source.html#l00457">lod_qos_used()</a>, <a class="el" href="lod__qos_8c_source.html#l00190">lod_statfs_and_check()</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_same_space</a>, <a class="el" href="lod__internal_8h_source.html#l00125">lod_tgt_desc::ltd_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00298">lod_thread_info::lti_osfs</a>, <a class="el" href="lod__internal_8h_source.html#l00115">ltd_qos::ltq_usable</a>, <a class="el" href="lod__internal_8h_source.html#l00113">ltd_qos::ltq_weight</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="lu__object_8c_source.html#l00097">lu_object_put()</a>, <a class="el" href="lod__qos_8c_source.html#l00735">min_stripe_count()</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00216">OBD_FAIL_MDS_OSC_PRECREATE</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="lod__internal_8h_source.html#l00070">pool_desc::pool_obds</a>, <a class="el" href="lod__internal_8h_source.html#l00082">pool_tgt_rw_sem</a>, <a class="el" href="lod__qos_8c_source.html#l00055">QOS_DEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="ab925384f4f8df7714509cf360ff549c2"></a><!-- doxytag: member="lod_qos.c::lod_alloc_rr" ref="ab925384f4f8df7714509cf360ff549c2" args="(const struct lu_env *env, struct lod_object *lo, struct dt_object **stripe, int flags, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_alloc_rr </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> **&nbsp;</td>
          <td class="paramname"> <em>stripe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a striping using round-robin algorithm. </p>
<p>Allocates a new striping using round-robin algorithm. The function refreshes all the internal structures (statfs cache, array of available OSTs sorted with regard to OSS, etc). The number of stripes required is taken from the object (must be prepared by the caller), but can change if the flag LOV_USES_DEFAULT_STRIPE is supplied. The caller should ensure nobody else is trying to create a striping on the object in parallel. All the internal structures (like pools, etc) are protected and no additional locking is required. The function succeeds even if a single stripe is allocated. To save time we give priority to targets which already have objects precreated. Full OSTs are skipped (see <a class="el" href="lod__qos_8c.html#a3664293f79142f2643171939ab78a1d9" title="Check if an OST is full.">lod_qos_dev_is_full()</a> for the details).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>stripe</em>&nbsp;</td><td>striping created </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>allocation flags (0 or LOV_USES_DEFAULT_STRIPE) </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOSPC</em>&nbsp;</td><td>if not enough OSTs are found </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno for other failures </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00933">933</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="prng_8c_source.html#l00078">cfs_rand()</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lod__internal_8h_source.html#l00246">lod_object::ldo_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00255">lod_object::ldo_pool</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__pool_8c_source.html#l00909">lod_find_pool()</a>, <a class="el" href="lod__internal_8h_source.html#l00204">lod_device::lod_pool_info</a>, <a class="el" href="lod__pool_8c_source.html#l00095">lod_pool_putref()</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__qos_8c_source.html#l00559">lod_qos_calc_rr()</a>, <a class="el" href="lod__qos_8c_source.html#l00780">lod_qos_ost_in_use_clear()</a>, <a class="el" href="lod__qos_8c_source.html#l00742">LOV_CREATE_RESEED_MIN</a>, <a class="el" href="lod__qos_8c_source.html#l00741">LOV_CREATE_RESEED_MULT</a>, <a class="el" href="lod__qos_8c_source.html#l00541">LOV_QOS_EMPTY</a>, <a class="el" href="lod__internal_8h_source.html#l00090">lod_qos::lq_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="lod__internal_8h_source.html#l00060">lod_qos_rr::lqr_alloc</a>, <a class="el" href="lod__internal_8h_source.html#l00062">lod_qos_rr::lqr_offset_idx</a>, <a class="el" href="lod__internal_8h_source.html#l00064">lod_qos_rr::lqr_pool</a>, <a class="el" href="lod__internal_8h_source.html#l00063">lod_qos_rr::lqr_start_count</a>, <a class="el" href="lod__internal_8h_source.html#l00061">lod_qos_rr::lqr_start_idx</a>, <a class="el" href="lod__internal_8h_source.html#l00298">lod_thread_info::lti_osfs</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="lnet_2utils_2debug_8c_source.html#l00068">max</a>, <a class="el" href="lod__qos_8c_source.html#l00735">min_stripe_count()</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00216">OBD_FAIL_MDS_OSC_PRECREATE</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="lod__internal_8h_source.html#l00070">pool_desc::pool_obds</a>, <a class="el" href="lod__internal_8h_source.html#l00072">pool_desc::pool_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00082">pool_tgt_rw_sem</a>, <a class="el" href="lod__qos_8c_source.html#l00055">QOS_DEBUG</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="ac4e9f0129da838960f944d8ac2046341"></a><!-- doxytag: member="lod_qos.c::lod_alloc_specific" ref="ac4e9f0129da838960f944d8ac2046341" args="(const struct lu_env *env, struct lod_object *lo, struct dt_object **stripe, int flags, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_alloc_specific </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> **&nbsp;</td>
          <td class="paramname"> <em>stripe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate a striping on a predefined set of OSTs. </p>
<p>Allocates new layout starting from OST index in lo-&gt;ldo_def_stripe_offset. Full OSTs are not considered. The exact order of OSTs is not important and varies depending on OST status. The allocation procedure prefers the targets with precreated objects ready. The number of stripes needed and stripe offset are taken from the object. If that number cannot be met, then the function returns an error and then it's the caller's responsibility to release the stripes allocated. All the internal structures are protected, but no concurrent allocation is allowed on the same objects.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>stripe</em>&nbsp;</td><td>striping created </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>not used </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOSPC</em>&nbsp;</td><td>if no OST objects are available at all </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EFBIG</em>&nbsp;</td><td>if not enough OST objects are found </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EINVAL</em>&nbsp;</td><td>requested offset is invalid </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>errno on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01185">1185</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lustre__user_8h_source.html#l00548">DFID</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lod__internal_8h_source.html#l00269">lod_object::ldo_def_stripe_offset</a>, <a class="el" href="lod__internal_8h_source.html#l00246">lod_object::ldo_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00255">lod_object::ldo_pool</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lu__object_8h_source.html#l00472">lu_object::lo_dev</a>, <a class="el" href="lod__internal_8h_source.html#l00348">lod2lu_obj()</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__pool_8c_source.html#l00909">lod_find_pool()</a>, <a class="el" href="lod__internal_8h_source.html#l00204">lod_device::lod_pool_info</a>, <a class="el" href="lod__pool_8c_source.html#l00095">lod_pool_putref()</a>, <a class="el" href="lod__qos_8c_source.html#l00674">lod_qos_declare_object_on()</a>, <a class="el" href="lod__qos_8c_source.html#l00828">lod_qos_is_ost_used()</a>, <a class="el" href="lod__qos_8c_source.html#l00805">lod_qos_ost_in_use()</a>, <a class="el" href="lod__qos_8c_source.html#l00780">lod_qos_ost_in_use_clear()</a>, <a class="el" href="lod__qos_8c_source.html#l00190">lod_statfs_and_check()</a>, <a class="el" href="lod__internal_8h_source.html#l00298">lod_thread_info::lti_osfs</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="lu__object_8h_source.html#l00770">lu_object_fid()</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00216">OBD_FAIL_MDS_OSC_PRECREATE</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="lustre__user_8h_source.html#l00119">obd_statfs::os_fprecreated</a>, <a class="el" href="lustre__user_8h_source.html#l00549">PFID</a>, <a class="el" href="lod__internal_8h_source.html#l00070">pool_desc::pool_obds</a>, <a class="el" href="lod__internal_8h_source.html#l00082">pool_tgt_rw_sem</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="af7f08327090f6a3c3e369ec22362fde0"></a><!-- doxytag: member="lod_qos.c::lod_check_and_reserve_ost" ref="af7f08327090f6a3c3e369ec22362fde0" args="(const struct lu_env *env, struct lod_device *m, struct obd_statfs *sfs, __u32 ost_idx, __u32 speed, __u32 *s_idx, struct dt_object **stripe, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_check_and_reserve_ost </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *&nbsp;</td>
          <td class="paramname"> <em>sfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>ost_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>speed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32 *&nbsp;</td>
          <td class="paramname"> <em>s_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structdt__object.html">dt_object</a> **&nbsp;</td>
          <td class="paramname"> <em>stripe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00841">841</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="lod__qos_8c_source.html#l00674">lod_qos_declare_object_on()</a>, <a class="el" href="lod__qos_8c_source.html#l00755">lod_qos_dev_is_full()</a>, <a class="el" href="lod__qos_8c_source.html#l00828">lod_qos_is_ost_used()</a>, <a class="el" href="lod__qos_8c_source.html#l00805">lod_qos_ost_in_use()</a>, <a class="el" href="lod__qos_8c_source.html#l00190">lod_statfs_and_check()</a>, <a class="el" href="lustre__user_8h_source.html#l00119">obd_statfs::os_fprecreated</a>, <a class="el" href="lustre__user_8h_source.html#l00118">obd_statfs::os_state</a>, <a class="el" href="lustre__user_8h_source.html#l00100">OS_STATE_DEGRADED</a>, and <a class="el" href="lod__qos_8c_source.html#l00055">QOS_DEBUG</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="ae3c35ef314ac6a75e79951f0f2125c50"></a><!-- doxytag: member="lod_qos.c::lod_get_stripecnt" ref="ae3c35ef314ac6a75e79951f0f2125c50" args="(struct lod_device *lod, __u32 magic, __u16 stripe_count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static __u16 lod_get_stripecnt </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>magic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u16&nbsp;</td>
          <td class="paramname"> <em>stripe_count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find largest stripe count the caller can use. </p>
<p>Find the maximal possible stripe count not greater than <em>stripe_count</em>. Sometimes suggested stripecount can't be reached for a number of reasons: lack of enough active OSTs or the backend does not support EAs that large. If the passed one is 0, then the filesystem's default one is used.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>magic</em>&nbsp;</td><td>the format if striping </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>stripe_count</em>&nbsp;</td><td>count the caller would like to use</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>the</em>&nbsp;</td><td>maximum usable stripe count </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01601">1601</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lustre__idl_8h_source.html#l02748">lov_desc::ld_active_tgt_count</a>, <a class="el" href="lustre__idl_8h_source.html#l02749">lov_desc::ld_default_stripe_count</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__internal_8h_source.html#l00195">lod_device::lod_osd_max_easize</a>, <a class="el" href="lustre__user_8h_source.html#l00359">LOV_MAX_STRIPE_COUNT_OLD</a>, and <a class="el" href="lustre__idl_8h_source.html#l01632">lov_mds_md_max_stripe_count()</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="acc18ff2f0e06a1cd935366f9cb510fea"></a><!-- doxytag: member="lod_qos.c::lod_qos_calc_ppo" ref="acc18ff2f0e06a1cd935366f9cb510fea" args="(struct lod_device *lod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_calc_ppo </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Calculate per-OST and per-OSS penalties. </p>
<p>Re-calculate penalties when the configuration changes, active targets change and after statfs refresh (all these are reflected by lq_dirty flag). On every OST and OSS: decay the penalty by half for every 8x the update interval that the device has been idle. That gives lots of time for the statfs information to be updated (which the penalty is only a proxy for), and avoids penalizing OSS/OSTs under light load. See <a class="el" href="lod__qos_8c.html#a8450c3af79a063a426605f608dd6056b" title="Calculate weight for a given OST target.">lod_qos_calc_weight()</a> for how penalties are factored into the weight.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-EAGAIN</em>&nbsp;</td><td>the number of OSTs isn't enough </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00310">310</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="bitmap_8h_source.html#l00116">cfs_foreach_bit</a>, <a class="el" href="linux-time_8h_source.html#l00157">cfs_time_current_sec()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l02748">lov_desc::ld_active_tgt_count</a>, <a class="el" href="lustre__idl_8h_source.html#l02754">lov_desc::ld_qos_maxage</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00087">lod_qos::lq_active_oss_count</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00085">lod_qos::lq_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00088">lod_qos::lq_prio_free</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_reset</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_same_space</a>, <a class="el" href="lod__internal_8h_source.html#l00089">lod_qos::lq_threshold_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00100">lod_qos_oss::lqo_bavail</a>, <a class="el" href="lod__internal_8h_source.html#l00099">lod_qos_oss::lqo_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00105">lod_qos_oss::lqo_ost_count</a>, <a class="el" href="lod__internal_8h_source.html#l00101">lod_qos_oss::lqo_penalty</a>, <a class="el" href="lod__internal_8h_source.html#l00102">lod_qos_oss::lqo_penalty_per_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00104">lod_qos_oss::lqo_used</a>, <a class="el" href="lnet_2utils_2debug_8c_source.html#l00068">max</a>, <a class="el" href="createmany_8c_source.html#l00069">now()</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lod__qos_8c_source.html#l00058">TGT_BAVAIL</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>.</p>

</div>
</div>
<a class="anchor" id="a589c351cca750871729a317919b74ba5"></a><!-- doxytag: member="lod_qos.c::lod_qos_calc_rr" ref="a589c351cca750871729a317919b74ba5" args="(struct lod_device *lod, struct ost_pool *src_pool, struct lod_qos_rr *lqr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_calc_rr </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structost__pool.html">ost_pool</a> *&nbsp;</td>
          <td class="paramname"> <em>src_pool</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__qos__rr.html">lod_qos_rr</a> *&nbsp;</td>
          <td class="paramname"> <em>lqr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Calculate optimal round-robin order with regard to OSSes. </p>
<p>Place all the OSTs from pool <em>src_pool</em> in a special array to be used for round-robin (RR) stripe allocation. The placement algorithm interleaves OSTs from the different OSSs so that RR allocation can balance OSSs evenly. Resorts the targets when the number of active targets changes (because of a new target or activation/deactivation).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>src_pool</em>&nbsp;</td><td>OST pool </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lqr</em>&nbsp;</td><td>round-robin list</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOMEM</em>&nbsp;</td><td>fails to allocate the array </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00559">559</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00139">D_WARNING</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00282">LCONSOLE</a>, <a class="el" href="libcfs__debug_8h_source.html#l00285">LCONSOLE_ERROR_MSG</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="lod__pool_8c_source.html#l00500">lod_ost_pool_extend()</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__qos_8c_source.html#l00541">LOV_QOS_EMPTY</a>, <a class="el" href="lod__internal_8h_source.html#l00085">lod_qos::lq_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="lod__internal_8h_source.html#l00105">lod_qos_oss::lqo_ost_count</a>, <a class="el" href="lod__internal_8h_source.html#l00065">lod_qos_rr::lqr_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00064">lod_qos_rr::lqr_pool</a>, <a class="el" href="lod__internal_8h_source.html#l00125">lod_tgt_desc::ltd_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00109">ltd_qos::ltq_oss</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="obd_8h_source.html#l00352">ost_pool::op_size</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="lod__qos_8c_source.html#l00056">QOS_CONSOLE</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="a8450c3af79a063a426605f608dd6056b"></a><!-- doxytag: member="lod_qos.c::lod_qos_calc_weight" ref="a8450c3af79a063a426605f608dd6056b" args="(struct lod_device *lod, int i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_calc_weight </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>i</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Calculate weight for a given OST target. </p>
<p>The final OST weight is the number of bytes available minus the OST and OSS penalties. See <a class="el" href="lod__qos_8c.html#acc18ff2f0e06a1cd935366f9cb510fea" title="Calculate per-OST and per-OSS penalties.">lod_qos_calc_ppo()</a> for how penalties are calculated.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device, where OST targets are listed </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>i</em>&nbsp;</td><td>OST target index</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00429">429</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, and <a class="el" href="lod__qos_8c_source.html#l00058">TGT_BAVAIL</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, and <a class="el" href="lod__qos_8c_source.html#l00457">lod_qos_used()</a>.</p>

</div>
</div>
<a class="anchor" id="afb768f4724d670f4a53652bc55caccb8"></a><!-- doxytag: member="lod_qos.c::lod_qos_declare_object_on" ref="afb768f4724d670f4a53652bc55caccb8" args="(const struct lu_env *env, struct lod_device *d, __u32 ost_idx, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structdt__object.html">dt_object</a>* lod_qos_declare_object_on </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>ost_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Instantiate and declare creation of a new object. </p>
<p>The function instantiates LU representation for a new object on the specified device. Also it declares an intention to create that object on the storage target.</p>
<p>Note <a class="el" href="group__lu.html#gad6ce21735ba52faf216eb2c67d5421d0" title="allocates object with 0 (non-assiged) fid XXX: temporary solution to be able to assign...">lu_object_anon()</a> is used which is a trick with regard to LU/OSD infrastructure - in the existing precreation framework we can't assign FID at this moment, we do this later once a transaction is started. So the special method instantiates FID-less object in the cache and later it will get a FID and proper placement in LU cache.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ost_idx</em>&nbsp;</td><td>OST target index where the object is being created </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>object</em>&nbsp;</td><td>ptr on success, ERR_PTR() otherwise </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00674">674</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="dt__object_8h_source.html#l01750">dt_object::do_lu</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l00275">lu_device::ld_type</a>, <a class="el" href="lu__object_8h_source.html#l00468">lu_object::lo_header</a>, <a class="el" href="lod__internal_8h_source.html#l00218">lod_osts_size</a>, <a class="el" href="lod__sub__object_8c_source.html#l00129">lod_sub_object_declare_create()</a>, <a class="el" href="lu__object_8c_source.html#l02319">lu_object_anon()</a>, <a class="el" href="lu__object_8c_source.html#l01329">lu_object_locate()</a>, <a class="el" href="lu__object_8c_source.html#l00097">lu_object_put()</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>, and <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>.</p>

</div>
</div>
<a class="anchor" id="a3664293f79142f2643171939ab78a1d9"></a><!-- doxytag: member="lod_qos.c::lod_qos_dev_is_full" ref="a3664293f79142f2643171939ab78a1d9" args="(struct obd_statfs *msfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_dev_is_full </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *&nbsp;</td>
          <td class="paramname"> <em>msfs</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check if an OST is full. </p>
<p>Check whether an OST should be considered full based on the given statfs data.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>msfs</em>&nbsp;</td><td>statfs data</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>false</em>&nbsp;</td><td>not full </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>true</em>&nbsp;</td><td>full </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00755">755</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="osc__internal_8h_source.html#l00177">min_t</a>, <a class="el" href="lustre__user_8h_source.html#l00111">obd_statfs::os_bavail</a>, <a class="el" href="lustre__user_8h_source.html#l00110">obd_statfs::os_bfree</a>, <a class="el" href="lustre__user_8h_source.html#l00109">obd_statfs::os_blocks</a>, and <a class="el" href="lustre__user_8h_source.html#l00115">obd_statfs::os_bsize</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, and <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>.</p>

</div>
</div>
<a class="anchor" id="a37de9666b442817fc402c4f96c0395c1"></a><!-- doxytag: member="lod_qos.c::lod_qos_is_ost_used" ref="a37de9666b442817fc402c4f96c0395c1" args="(const struct lu_env *env, int ost, __u32 stripes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_is_ost_used </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ost</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>stripes</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check is OST used in a striping. </p>
<p>Checks whether OST with the given index is marked as used in the temporary array (see <a class="el" href="lod__qos_8c.html#a1bfa41dca5ef02d45c5eeecc877abb15" title="Remember a target in the array of used targets.">lod_qos_ost_in_use()</a>).</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ost</em>&nbsp;</td><td>OST target index to check </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>stripes</em>&nbsp;</td><td>the number of items used in the array already</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>not used </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>used </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00828">828</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, and <a class="el" href="lod__internal_8h_source.html#l00292">lod_thread_info::lti_ea_store</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>, and <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>.</p>

</div>
</div>
<a class="anchor" id="a26e41dde83f817fb4ac8c544e59bc626"></a><!-- doxytag: member="lod_qos.c::lod_qos_is_usable" ref="a26e41dde83f817fb4ac8c544e59bc626" args="(struct lod_device *lod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_is_usable </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether QoS allocation should be used. </p>
<p>A simple helper to decide when QoS allocation should be used: if it's just a single available target or the used space is evenly distributed among the targets at the moment, then QoS allocation algorithm should not be used.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>should not be used </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>should be used </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01325">1325</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lustre__idl_8h_source.html#l02748">lov_desc::ld_active_tgt_count</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, and <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_same_space</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>.</p>

</div>
</div>
<a class="anchor" id="a1bfa41dca5ef02d45c5eeecc877abb15"></a><!-- doxytag: member="lod_qos.c::lod_qos_ost_in_use" ref="a1bfa41dca5ef02d45c5eeecc877abb15" args="(const struct lu_env *env, int idx, int ost)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lod_qos_ost_in_use </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ost</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remember a target in the array of used targets. </p>
<p>Mark the given target as used for a new striping being created. The status of an OST in a striping can be checked with <a class="el" href="lod__qos_8c.html#a37de9666b442817fc402c4f96c0395c1" title="Check is OST used in a striping.">lod_qos_is_ost_used()</a>.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>idx</em>&nbsp;</td><td>index in the array </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ost</em>&nbsp;</td><td>OST target index to mark as used </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00805">805</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__internal_8h_source.html#l00292">lod_thread_info::lti_ea_store</a>, and <a class="el" href="lod__internal_8h_source.html#l00293">lod_thread_info::lti_ea_store_size</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>, and <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>.</p>

</div>
</div>
<a class="anchor" id="adb6f000b7fc44e9aa2fb5b5ba5596daa"></a><!-- doxytag: member="lod_qos.c::lod_qos_ost_in_use_clear" ref="adb6f000b7fc44e9aa2fb5b5ba5596daa" args="(const struct lu_env *env, __u32 stripes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_ost_in_use_clear </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>stripes</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize temporary OST-in-use array. </p>
<p>Allocate or extend the array used to mark targets already assigned to a new striping so they are not used more than once.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>stripes</em>&nbsp;</td><td>number of items needed in the array</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOMEM</em>&nbsp;</td><td>on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00780">780</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="lod__lov_8c_source.html#l00596">lod_ea_store_resize()</a>, <a class="el" href="lod__internal_8h_source.html#l00372">lod_env_info()</a>, <a class="el" href="lod__internal_8h_source.html#l00292">lod_thread_info::lti_ea_store</a>, and <a class="el" href="lod__internal_8h_source.html#l00293">lod_thread_info::lti_ea_store_size</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>, and <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>.</p>

</div>
</div>
<a class="anchor" id="a6b20eb75ce250278dab3d3f2e7cf8dc3"></a><!-- doxytag: member="lod_qos.c::lod_qos_parse_config" ref="a6b20eb75ce250278dab3d3f2e7cf8dc3" args="(const struct lu_env *env, struct lod_object *lo, const struct lu_buf *buf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_parse_config </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__buf.html">lu_buf</a> *&nbsp;</td>
          <td class="paramname"> <em>buf</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Parse suggested striping configuration. </p>
<p>The caller gets a suggested striping configuration from a number of sources including per-directory default and applications. Then it needs to verify the suggested striping is valid, apply missing bits and store the resulting configuration in the object to be used by the allocator later. Must not be called concurrently against the same object. It's OK to provide a fully-defined striping.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>buf</em>&nbsp;</td><td>buffer containing the striping</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01696">1696</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="byteorder_8h_source.html#l00039">__swab32</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__user_8h_source.html#l00380">lov_user_ost_data_v1::l_ost_idx</a>, <a class="el" href="lu__object_8h_source.html#l01335">lu_buf::lb_buf</a>, <a class="el" href="lu__object_8h_source.html#l01336">lu_buf::lb_len</a>, <a class="el" href="lod__internal_8h_source.html#l00269">lod_object::ldo_def_stripe_offset</a>, <a class="el" href="lod__internal_8h_source.html#l00253">lod_object::ldo_pattern</a>, <a class="el" href="lod__internal_8h_source.html#l00254">lod_object::ldo_released_stripenr</a>, <a class="el" href="lod__internal_8h_source.html#l00252">lod_object::ldo_stripe_size</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lustre__user_8h_source.html#l00400">lov_user_md_v3::lmm_magic</a>, <a class="el" href="lustre__user_8h_source.html#l00385">lov_user_md_v1::lmm_magic</a>, <a class="el" href="lustre__user_8h_source.html#l00412">lov_user_md_v3::lmm_objects</a>, <a class="el" href="lustre__user_8h_source.html#l00386">lov_user_md_v1::lmm_pattern</a>, <a class="el" href="lustre__user_8h_source.html#l00411">lov_user_md_v3::lmm_pool_name</a>, <a class="el" href="lustre__user_8h_source.html#l00389">lov_user_md_v1::lmm_stripe_count</a>, <a class="el" href="lustre__user_8h_source.html#l00404">lov_user_md_v3::lmm_stripe_count</a>, <a class="el" href="lustre__user_8h_source.html#l00391">lov_user_md_v1::lmm_stripe_offset</a>, <a class="el" href="lustre__user_8h_source.html#l00406">lov_user_md_v3::lmm_stripe_offset</a>, <a class="el" href="lustre__user_8h_source.html#l00388">lov_user_md_v1::lmm_stripe_size</a>, <a class="el" href="lod__internal_8h_source.html#l00348">lod2lu_obj()</a>, <a class="el" href="lod__internal_8h_source.html#l00331">lod2obd()</a>, <a class="el" href="lod__pool_8c_source.html#l00876">lod_check_index_in_pool()</a>, <a class="el" href="lod__pool_8c_source.html#l00909">lod_find_pool()</a>, <a class="el" href="lod__object_8c_source.html#l02868">lod_object_set_pool()</a>, <a class="el" href="lod__pool_8c_source.html#l00095">lod_pool_putref()</a>, <a class="el" href="lod__qos_8c_source.html#l01636">lod_use_defined_striping()</a>, <a class="el" href="lustre__idl_8h_source.html#l01489">LOV_MAGIC_V1_DEF</a>, <a class="el" href="lustre__idl_8h_source.html#l01490">LOV_MAGIC_V3_DEF</a>, <a class="el" href="lustre__user_8h_source.html#l00358">LOV_MIN_STRIPE_SIZE</a>, <a class="el" href="lod__internal_8h_source.html#l00057">LOV_OFFSET_DEFAULT</a>, <a class="el" href="lustre__idl_8h_source.html#l01492">lov_pattern</a>, <a class="el" href="lustre__user_8h_source.html#l00352">LOV_PATTERN_F_RELEASED</a>, <a class="el" href="lustre__user_8h_source.html#l00345">LOV_PATTERN_RAID0</a>, <a class="el" href="lustre__user_8h_source.html#l00341">LOV_USER_MAGIC_SPECIFIC</a>, <a class="el" href="lustre__user_8h_source.html#l00336">LOV_USER_MAGIC_V1</a>, <a class="el" href="lustre__user_8h_source.html#l00339">LOV_USER_MAGIC_V3</a>, <a class="el" href="lustre__user_8h_source.html#l00415">lov_user_md_size()</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="pack__generic_8c_source.html#l02114">lustre_print_user_md()</a>, <a class="el" href="pack__generic_8c_source.html#l02198">lustre_swab_lov_user_md_objects()</a>, <a class="el" href="pack__generic_8c_source.html#l02165">lustre_swab_lov_user_md_v1()</a>, <a class="el" href="pack__generic_8c_source.html#l02174">lustre_swab_lov_user_md_v3()</a>, <a class="el" href="lod__internal_8h_source.html#l00080">pool_tgt_count</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="cascading__rw_8c_source.html#l00061">size</a>, and <a class="el" href="libcfs__private_8h_source.html#l00310">unlikely</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="a8f23abfd59d0b5ed5e6240f02f34a898"></a><!-- doxytag: member="lod_qos.c::lod_qos_prep_create" ref="a8f23abfd59d0b5ed5e6240f02f34a898" args="(const struct lu_env *env, struct lod_object *lo, struct lu_attr *attr, const struct lu_buf *buf, struct thandle *th)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lod_qos_prep_create </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>lo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlu__attr.html">lu_attr</a> *&nbsp;</td>
          <td class="paramname"> <em>attr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__buf.html">lu_buf</a> *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structthandle.html">thandle</a> *&nbsp;</td>
          <td class="paramname"> <em>th</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create a striping for an obejct. </p>
<p>The function creates a new striping for the object. A buffer containing configuration hints can be provided optionally. The function tries QoS algorithm first unless free space is distributed evenly among OSTs, but by default RR algorithm is preferred due to internal concurrency (QoS is serialized). The caller must ensure no concurrent calls to the function are made against the same object.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>attr</em>&nbsp;</td><td>attributes OST objects will be declared with </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>buf</em>&nbsp;</td><td>suggested striping configuration or NULL </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>th</em>&nbsp;</td><td>transaction handle</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01848">1848</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00141">D_OTHER</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l01335">lu_buf::lb_buf</a>, <a class="el" href="lustre__idl_8h_source.html#l02747">lov_desc::ld_tgt_count</a>, <a class="el" href="lod__internal_8h_source.html#l00269">lod_object::ldo_def_stripe_offset</a>, <a class="el" href="lod__internal_8h_source.html#l00256">lod_object::ldo_stripe</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="lod__internal_8h_source.html#l00260">lod_object::ldo_stripes_allocated</a>, <a class="el" href="libcfs__private_8h_source.html#l00309">likely</a>, <a class="el" href="lod__internal_8h_source.html#l00348">lod2lu_obj()</a>, <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>, <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__qos_8c_source.html#l01601">lod_get_stripecnt()</a>, <a class="el" href="lod__lov_8c_source.html#l00055">lod_getref()</a>, <a class="el" href="lod__internal_8h_source.html#l00187">lod_device::lod_ost_descs</a>, <a class="el" href="lod__lov_8c_source.html#l00073">lod_putref()</a>, <a class="el" href="lod__qos_8c_source.html#l01696">lod_qos_parse_config()</a>, <a class="el" href="lod__qos_8c_source.html#l00257">lod_qos_statfs_update()</a>, <a class="el" href="lod__sub__object_8c_source.html#l00129">lod_sub_object_declare_create()</a>, <a class="el" href="packet-lustre_8c_source.html#l00086">LOV_MAGIC</a>, <a class="el" href="lod__internal_8h_source.html#l00057">LOV_OFFSET_DEFAULT</a>, <a class="el" href="lustre__user_8h_source.html#l00341">LOV_USER_MAGIC_SPECIFIC</a>, <a class="el" href="lustre__user_8h_source.html#l00383">lov_user_md</a>, <a class="el" href="lod__internal_8h_source.html#l00046">LOV_USES_ASSIGNED_STRIPE</a>, <a class="el" href="lod__internal_8h_source.html#l00320">lu2lod_dev()</a>, <a class="el" href="lu__object_8c_source.html#l00097">lu_object_put()</a>, <a class="el" href="obd__support_8h_source.html#l00708">OBD_ALLOC</a>, <a class="el" href="obd__support_8h_source.html#l00776">OBD_FREE</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__object_8c_source.html#l03337">lod_declare_striped_object()</a>.</p>

</div>
</div>
<a class="anchor" id="a5fb30590b55854931da51ad522e6014f"></a><!-- doxytag: member="lod_qos.c::lod_qos_rr_init" ref="a5fb30590b55854931da51ad522e6014f" args="(struct lod_qos_rr *lqr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lod_qos_rr_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__qos__rr.html">lod_qos_rr</a> *&nbsp;</td>
          <td class="paramname"> <em>lqr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00534">534</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lod__internal_8h_source.html#l00060">lod_qos_rr::lqr_alloc</a>, and <a class="el" href="lod__internal_8h_source.html#l00065">lod_qos_rr::lqr_dirty</a>.</p>

<p>Referenced by <a class="el" href="lod__pool_8c_source.html#l00643">lod_pool_new()</a>, and <a class="el" href="lod__lov_8c_source.html#l01280">lod_pools_init()</a>.</p>

</div>
</div>
<a class="anchor" id="a20186d22e469ddbd8cfc749dcef63d7c"></a><!-- doxytag: member="lod_qos.c::lod_qos_statfs_update" ref="a20186d22e469ddbd8cfc749dcef63d7c" args="(const struct lu_env *env, struct lod_device *lod)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lod_qos_statfs_update </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Maintain per-target statfs data. </p>
<p>The function refreshes statfs data for all the targets every N seconds. The actual N is controlled via procfs and set to LOV_DESC_QOS_MAXAGE_DEFAULT initially.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00257">257</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="linux-time_8h_source.html#l00253">cfs_time_beforeq_64()</a>, <a class="el" href="linux-time_8h_source.html#l00235">cfs_time_current_64</a>, <a class="el" href="linux-time_8h_source.html#l00242">cfs_time_shift_64()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="flock_8c_source.html#l00090">EXIT</a>, <a class="el" href="lustre__idl_8h_source.html#l02754">lov_desc::ld_qos_maxage</a>, <a class="el" href="lod__internal_8h_source.html#l00331">lod2obd()</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__internal_8h_source.html#l00204">lod_device::lod_pool_info</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__qos_8c_source.html#l00190">lod_statfs_and_check()</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="obd_8h_source.html#l00647">obd_device::obd_osfs_age</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00358">RETURN_EXIT</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01848">lod_qos_prep_create()</a>.</p>

</div>
</div>
<a class="anchor" id="a405d704970506f8898934f5f2f2c7879"></a><!-- doxytag: member="lod_qos.c::lod_qos_used" ref="a405d704970506f8898934f5f2f2c7879" args="(struct lod_device *lod, struct ost_pool *osts, __u32 index, __u64 *total_wt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_qos_used </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structost__pool.html">ost_pool</a> *&nbsp;</td>
          <td class="paramname"> <em>osts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> *&nbsp;</td>
          <td class="paramname"> <em>total_wt</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Re-calculate weights. </p>
<p>The function is called when some OST target was used for a new object. In this case we should re-calculate all the weights to keep new allocations balanced well.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>osts</em>&nbsp;</td><td>OST pool where a new object was placed </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>index</em>&nbsp;</td><td>OST target where a new object was placed </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>total_wt</em>&nbsp;</td><td>new total weight for the pool</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00457">457</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="bitmap_8h_source.html#l00087">cfs_bitmap_check()</a>, <a class="el" href="linux-time_8h_source.html#l00157">cfs_time_current_sec()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__qos_8c_source.html#l00429">lod_qos_calc_weight()</a>, <a class="el" href="libcfs_2include_2libcfs_2types_8h_source.html#l00045">LPU64</a>, <a class="el" href="lod__internal_8h_source.html#l00087">lod_qos::lq_active_oss_count</a>, <a class="el" href="lod__internal_8h_source.html#l00085">lod_qos::lq_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00099">lod_qos_oss::lqo_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00101">lod_qos_oss::lqo_penalty</a>, <a class="el" href="lod__internal_8h_source.html#l00102">lod_qos_oss::lqo_penalty_per_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00104">lod_qos_oss::lqo_used</a>, <a class="el" href="lod__internal_8h_source.html#l00125">lod_tgt_desc::ltd_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00109">ltd_qos::ltq_oss</a>, <a class="el" href="lod__internal_8h_source.html#l00110">ltd_qos::ltq_penalty</a>, <a class="el" href="lod__internal_8h_source.html#l00111">ltd_qos::ltq_penalty_per_obj</a>, <a class="el" href="lod__internal_8h_source.html#l00115">ltd_qos::ltq_usable</a>, <a class="el" href="lod__internal_8h_source.html#l00114">ltd_qos::ltq_used</a>, <a class="el" href="lod__internal_8h_source.html#l00113">ltd_qos::ltq_weight</a>, <a class="el" href="obd_8h_source.html#l00349">ost_pool::op_array</a>, <a class="el" href="obd_8h_source.html#l00351">ost_pool::op_count</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, <a class="el" href="lod__qos_8c_source.html#l00055">QOS_DEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, and <a class="el" href="lod__qos_8c_source.html#l00058">TGT_BAVAIL</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>.</p>

</div>
</div>
<a class="anchor" id="a23d6ff412d6cd3d8856aa8862d953739"></a><!-- doxytag: member="lod_qos.c::lod_statfs_and_check" ref="a23d6ff412d6cd3d8856aa8862d953739" args="(const struct lu_env *env, struct lod_device *d, int index, struct obd_statfs *sfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_statfs_and_check </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structobd__statfs.html">obd_statfs</a> *&nbsp;</td>
          <td class="paramname"> <em>sfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check whether the target is available for new OST objects. </p>
<p>Request statfs data from the given target and verify it's active and not read-only. If so, then it can be used to place new OST objects. This function also maintains the number of active/inactive targets and sets dirty flags if those numbers change so others can run re-balance procedures. No external locking is required.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>d</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>index</em>&nbsp;</td><td>index of OST target to check </td></tr>
    <tr><td valign="top"><tt>[out]</tt>&nbsp;</td><td valign="top"><em>sfs</em>&nbsp;</td><td>buffer for statfs data</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>if the target is good </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00190">190</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="libcfs__debug_8h_source.html#l00278">CERROR</a>, <a class="el" href="libcfs__debug_8h_source.html#l00153">D_CONFIG</a>, <a class="el" href="dt__object_8h_source.html#l02437">dt_statfs()</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00045">LASSERTF</a>, <a class="el" href="lustre__idl_8h_source.html#l02748">lov_desc::ld_active_tgt_count</a>, <a class="el" href="lod__internal_8h_source.html#l00331">lod2obd()</a>, <a class="el" href="lod__internal_8h_source.html#l00181">lod_device::lod_desc</a>, <a class="el" href="lod__internal_8h_source.html#l00184">lod_device::lod_desc_lock</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00090">lod_qos::lq_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00065">lod_qos_rr::lqr_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00128">lod_tgt_desc::ltd_active</a>, <a class="el" href="lod__internal_8h_source.html#l00128">lod_tgt_desc::ltd_connecting</a>, <a class="el" href="lod__internal_8h_source.html#l00121">lod_tgt_desc::ltd_exp</a>, <a class="el" href="obd_8h_source.html#l00599">obd_device::obd_name</a>, <a class="el" href="lustre__user_8h_source.html#l00118">obd_statfs::os_state</a>, <a class="el" href="lustre__user_8h_source.html#l00101">OS_STATE_READONLY</a>, <a class="el" href="lod__internal_8h_source.html#l00146">OST_TGT</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01084">lod_alloc_ost_list()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, <a class="el" href="lod__qos_8c_source.html#l01185">lod_alloc_specific()</a>, <a class="el" href="lod__qos_8c_source.html#l00841">lod_check_and_reserve_ost()</a>, and <a class="el" href="lod__qos_8c_source.html#l00257">lod_qos_statfs_update()</a>.</p>

</div>
</div>
<a class="anchor" id="afa1a950572d092876cb1246413d9342c"></a><!-- doxytag: member="lod_qos.c::lod_use_defined_striping" ref="afa1a950572d092876cb1246413d9342c" args="(const struct lu_env *env, struct lod_object *mo, const struct lu_buf *buf)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lod_use_defined_striping </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__object.html">lod_object</a> *&nbsp;</td>
          <td class="paramname"> <em>mo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlu__buf.html">lu_buf</a> *&nbsp;</td>
          <td class="paramname"> <em>buf</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create in-core respresentation for a fully-defined striping. </p>
<p>When the caller passes a fully-defined striping (i.e. everything including OST object FIDs are defined), then we still need to instantiate LU-cache with the objects representing the stripes defined. This function completes that task.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>env</em>&nbsp;</td><td>execution environment for this thread </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>mo</em>&nbsp;</td><td>LOD object </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>buf</em>&nbsp;</td><td>buffer containing the striping</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>negated errno on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l01636">1636</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lu__object_8h_source.html#l01335">lu_buf::lb_buf</a>, <a class="el" href="lu__object_8h_source.html#l01336">lu_buf::lb_len</a>, <a class="el" href="lod__internal_8h_source.html#l00251">lod_object::ldo_layout_gen</a>, <a class="el" href="lod__internal_8h_source.html#l00253">lod_object::ldo_pattern</a>, <a class="el" href="lod__internal_8h_source.html#l00254">lod_object::ldo_released_stripenr</a>, <a class="el" href="lod__internal_8h_source.html#l00252">lod_object::ldo_stripe_size</a>, <a class="el" href="lod__internal_8h_source.html#l00250">lod_object::ldo_stripenr</a>, <a class="el" href="byteorder_8h_source.html#l00054">le16_to_cpu</a>, <a class="el" href="byteorder_8h_source.html#l00056">le32_to_cpu</a>, <a class="el" href="lustre__idl_8h_source.html#l01510">lov_mds_md_v1::lmm_layout_gen</a>, <a class="el" href="lustre__idl_8h_source.html#l01504">lov_mds_md_v1::lmm_magic</a>, <a class="el" href="lustre__idl_8h_source.html#l01618">lov_mds_md_v3::lmm_objects</a>, <a class="el" href="lustre__idl_8h_source.html#l01511">lov_mds_md_v1::lmm_objects</a>, <a class="el" href="lustre__idl_8h_source.html#l01505">lov_mds_md_v1::lmm_pattern</a>, <a class="el" href="lustre__idl_8h_source.html#l01617">lov_mds_md_v3::lmm_pool_name</a>, <a class="el" href="lustre__idl_8h_source.html#l01509">lov_mds_md_v1::lmm_stripe_count</a>, <a class="el" href="lustre__idl_8h_source.html#l01507">lov_mds_md_v1::lmm_stripe_size</a>, <a class="el" href="lod__lov_8c_source.html#l00839">lod_initialize_objects()</a>, <a class="el" href="lod__object_8c_source.html#l02868">lod_object_set_pool()</a>, <a class="el" href="packet-lustre_8c_source.html#l00085">LOV_MAGIC_V1</a>, <a class="el" href="lustre__idl_8h_source.html#l01489">LOV_MAGIC_V1_DEF</a>, <a class="el" href="lustre__idl_8h_source.html#l01471">LOV_MAGIC_V3</a>, <a class="el" href="lustre__idl_8h_source.html#l01490">LOV_MAGIC_V3_DEF</a>, <a class="el" href="lustre__idl_8h_source.html#l01621">lov_mds_md_size()</a>, <a class="el" href="lustre__user_8h_source.html#l00352">LOV_PATTERN_F_RELEASED</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__qos_8c_source.html#l01696">lod_qos_parse_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a58b385a892107b48477304dfe7067126"></a><!-- doxytag: member="lod_qos.c::min_stripe_count" ref="a58b385a892107b48477304dfe7067126" args="(__u32 stripe_cnt, int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int min_stripe_count </td>
          <td>(</td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>stripe_cnt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Calculate a minimum acceptable stripe count. </p>
<p>Return an acceptable stripe count depending on flag LOV_USES_DEFAULT_STRIPE: all stripes or 3/4 of stripes.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>stripe_cnt</em>&nbsp;</td><td>number of stripes requested </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>0 or LOV_USES_DEFAULT_STRIPE</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>acceptable</em>&nbsp;</td><td>stripecount </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00735">735</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lod__internal_8h_source.html#l00047">LOV_USES_DEFAULT_STRIPE</a>.</p>

<p>Referenced by <a class="el" href="ll__dirstripe__verify_8c_source.html#l00094">compare()</a>, <a class="el" href="lod__qos_8c_source.html#l01375">lod_alloc_qos()</a>, and <a class="el" href="lod__qos_8c_source.html#l00933">lod_alloc_rr()</a>.</p>

</div>
</div>
<a class="anchor" id="ad35586b02932a00478563eaf603af497"></a><!-- doxytag: member="lod_qos.c::qos_add_tgt" ref="ad35586b02932a00478563eaf603af497" args="(struct lod_device *lod, struct lod_tgt_desc *ost_desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qos_add_tgt </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__tgt__desc.html">lod_tgt_desc</a> *&nbsp;</td>
          <td class="paramname"> <em>ost_desc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add a new target to Quality of Service (QoS) target table. </p>
<p>Add a new OST target to the structure representing an OSS. Resort the list of known OSSs by the number of OSTs attached to each OSS. The OSS list is protected internally and no external locking is required.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ost_desc</em>&nbsp;</td><td>OST description</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOMEM</em>&nbsp;</td><td>on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00074">74</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="lustre__net_8h_source.html#l00523">ptlrpc_connection::c_remote_uuid</a>, <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="lod__qos_8c_source.html#l00053">D_QOS</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00217">obd_export::exp_connection</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="lnetctl_8c_source.html#l00969">list</a>, <a class="el" href="list_8h_source.html#l00090">list_add_tail()</a>, <a class="el" href="list_8h_source.html#l00116">list_del()</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00085">lod_qos::lq_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00090">lod_qos::lq_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="lod__internal_8h_source.html#l00099">lod_qos_oss::lqo_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00105">lod_qos_oss::lqo_ost_count</a>, <a class="el" href="lod__internal_8h_source.html#l00098">lod_qos_oss::lqo_uuid</a>, <a class="el" href="lod__internal_8h_source.html#l00065">lod_qos_rr::lqr_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00121">lod_tgt_desc::ltd_exp</a>, <a class="el" href="lod__internal_8h_source.html#l00125">lod_tgt_desc::ltd_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00122">lod_tgt_desc::ltd_uuid</a>, <a class="el" href="lod__internal_8h_source.html#l00109">ltd_qos::ltq_oss</a>, <a class="el" href="obd__support_8h_source.html#l00710">OBD_ALLOC_PTR</a>, <a class="el" href="lustre__user_8h_source.html#l00513">obd_uuid2str()</a>, <a class="el" href="lustre__user_8h_source.html#l00495">obd_uuid_equals()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__lov_8c_source.html#l00207">lod_add_device()</a>.</p>

</div>
</div>
<a class="anchor" id="adb3c522d7fb6194821780684f5b82d76"></a><!-- doxytag: member="lod_qos.c::qos_del_tgt" ref="adb3c522d7fb6194821780684f5b82d76" args="(struct lod_device *lod, struct lod_tgt_desc *ost_desc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qos_del_tgt </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlod__device.html">lod_device</a> *&nbsp;</td>
          <td class="paramname"> <em>lod</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlod__tgt__desc.html">lod_tgt_desc</a> *&nbsp;</td>
          <td class="paramname"> <em>ost_desc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove OST target from QoS table. </p>
<p>Removes given OST target from QoS table and releases related OSS structure if no OSTs remain on the OSS.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>lod</em>&nbsp;</td><td>LOD device </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ost_desc</em>&nbsp;</td><td>OST description</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-ENOENT</em>&nbsp;</td><td>if no OSS was found </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lod__qos_8c_source.html#l00145">145</a> of file <a class="el" href="lod__qos_8c_source.html">lod_qos.c</a>.</p>

<p>References <a class="el" href="libcfs__debug_8h_source.html#l00259">CDEBUG</a>, <a class="el" href="lod__qos_8c_source.html#l00053">D_QOS</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="small__write_8c_source.html#l00044">GOTO</a>, <a class="el" href="list_8h_source.html#l00116">list_del()</a>, <a class="el" href="lod__internal_8h_source.html#l00201">lod_device::lod_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00091">lod_qos::lq_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00090">lod_qos::lq_rr</a>, <a class="el" href="lod__internal_8h_source.html#l00086">lod_qos::lq_rw_sem</a>, <a class="el" href="lod__internal_8h_source.html#l00099">lod_qos_oss::lqo_oss_list</a>, <a class="el" href="lod__internal_8h_source.html#l00105">lod_qos_oss::lqo_ost_count</a>, <a class="el" href="lod__internal_8h_source.html#l00098">lod_qos_oss::lqo_uuid</a>, <a class="el" href="lod__internal_8h_source.html#l00065">lod_qos_rr::lqr_dirty</a>, <a class="el" href="lod__internal_8h_source.html#l00125">lod_tgt_desc::ltd_qos</a>, <a class="el" href="lod__internal_8h_source.html#l00109">ltd_qos::ltq_oss</a>, <a class="el" href="obd__support_8h_source.html#l00830">OBD_FREE_PTR</a>, <a class="el" href="lustre__user_8h_source.html#l00513">obd_uuid2str()</a>, and <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>.</p>

<p>Referenced by <a class="el" href="lod__lov_8c_source.html#l00073">lod_putref()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:48 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
