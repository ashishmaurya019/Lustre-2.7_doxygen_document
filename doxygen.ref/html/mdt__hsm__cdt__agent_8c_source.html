<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/mdt/mdt_hsm_cdt_agent.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/mdt/mdt_hsm_cdt_agent.c</h1><a href="mdt__hsm__cdt__agent_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment"> * GNU General Public License version 2 for more details.  A copy is</span>
<a name="l00014"></a>00014 <span class="comment"> * included in the COPYING file that accompanied this code.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00018"></a>00018 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * GPL HEADER END</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 <span class="comment">/*</span>
<a name="l00023"></a>00023 <span class="comment"> * (C) Copyright 2012 Commissariat a l&apos;energie atomique et aux energies</span>
<a name="l00024"></a>00024 <span class="comment"> *     alternatives</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 <span class="comment">/*</span>
<a name="l00028"></a>00028 <span class="comment"> * lustre/mdt/mdt_hsm_cdt_agent.c</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Lustre HSM Coordinator</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * Author: Jacques-Charles Lafoucriere &lt;jacques-charles.lafoucriere@cea.fr&gt;</span>
<a name="l00033"></a>00033 <span class="comment"> * Author: Aurelien Degremont &lt;aurelien.degremont@cea.fr&gt;</span>
<a name="l00034"></a>00034 <span class="comment"> */</span>
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">00036</a> <span class="preprocessor">#define DEBUG_SUBSYSTEM S_MDS</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="obd_8h.html">obd.h</a>&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="obd__support_8h.html">obd_support.h</a>&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="lustre__export_8h.html">lustre_export.h</a>&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="lustre__user_8h.html">lustre/lustre_user.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="lprocfs__status_8h.html">lprocfs_status.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="lustre__kernelcomm_8h.html">lustre_kernelcomm.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="mdt__internal_8h.html">mdt_internal.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">/*</span>
<a name="l00047"></a>00047 <span class="comment"> * Agent external API</span>
<a name="l00048"></a>00048 <span class="comment"> */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">/*</span>
<a name="l00051"></a>00051 <span class="comment"> * find a hsm_agent by uuid</span>
<a name="l00052"></a>00052 <span class="comment"> * lock cdt_agent_lock needs to be held by caller</span>
<a name="l00053"></a>00053 <span class="comment"> * \param cdt [IN] coordinator</span>
<a name="l00054"></a>00054 <span class="comment"> * \param uuid [IN] agent UUID</span>
<a name="l00055"></a>00055 <span class="comment"> * \retval hsm_agent pointer or NULL if not found</span>
<a name="l00056"></a>00056 <span class="comment"> */</span>
<a name="l00057"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#a2f014a0032e35f4934b97c3184cc16a7">00057</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a> *<a class="code" href="mdt__hsm__cdt__agent_8c.html#a2f014a0032e35f4934b97c3184cc16a7">mdt_hsm_agent_lookup</a>(<span class="keyword">struct</span> <a class="code" href="structcoordinator.html">coordinator</a> *cdt,
<a name="l00058"></a>00058                                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>)
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(ha, &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>, <a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>) {
<a name="l00063"></a>00063                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>, uuid))
<a name="l00064"></a>00064                         <span class="keywordflow">return</span> ha;
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066         <span class="keywordflow">return</span> NULL;
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00078"></a><a class="code" href="mdt__internal_8h.html#a20bcec359b4b9d1c529f6b2b3388c30f">00078</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#a1f30a82ebc6efe0acb9122c3fbd79f53" title="register a copy tool">mdt_hsm_agent_register</a>(<span class="keyword">struct</span> <a class="code" href="structmdt__thread__info.html">mdt_thread_info</a> *mti,
<a name="l00079"></a>00079                            <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>,
<a name="l00080"></a>00080                            <span class="keywordtype">int</span> nr_archives, __u32 *archive_id)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mti-&gt;<a class="code" href="structmdt__thread__info.html#ab68a6a94c432f5816d5746c14c0d228f">mti_mdt</a>-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00083"></a>00083         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha, *tmp;
<a name="l00084"></a>00084         <span class="keywordtype">int</span>                      rc;
<a name="l00085"></a>00085         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087         <span class="comment">/* no coordinator started, so we cannot serve requests */</span>
<a name="l00088"></a>00088         <span class="keywordflow">if</span> (cdt-&gt;<a class="code" href="structcoordinator.html#aead52bd34625fe34f754b7107d6eef01" title="state">cdt_state</a> == <a class="code" href="mdt__internal_8h.html#a596daf8acb5cd4e00e66b9adec6470b8aa9bfd061bad551c4bf3c0a7ee0df2d43">CDT_STOPPED</a>) {
<a name="l00089"></a>00089                 <a class="code" href="libcfs__debug_8h.html#ac961fee8081e28c070b075fd57cd5a81">LCONSOLE_WARN</a>(<span class="stringliteral">&quot;HSM coordinator thread is not running - &quot;</span>
<a name="l00090"></a>00090                               <span class="stringliteral">&quot;denying agent registration.\n&quot;</span>);
<a name="l00091"></a>00091                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENXIO);
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <a class="code" href="obd__support_8h.html#ab5ccc29ab0a6625457a863652381c45c">OBD_ALLOC_PTR</a>(ha);
<a name="l00095"></a>00095         <span class="keywordflow">if</span> (ha == NULL)
<a name="l00096"></a>00096                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOMEM);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a> = *uuid;
<a name="l00099"></a>00099         ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> = nr_archives;
<a name="l00100"></a>00100         <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> != 0) {
<a name="l00101"></a>00101                 <span class="keywordtype">int</span> sz;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103                 sz = ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> * <span class="keyword">sizeof</span>(*ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>);
<a name="l00104"></a>00104                 <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>, sz);
<a name="l00105"></a>00105                 <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a> == NULL)
<a name="l00106"></a>00106                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_free, rc = -ENOMEM);
<a name="l00107"></a>00107                 memcpy(ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>, archive_id, sz);
<a name="l00108"></a>00108         }
<a name="l00109"></a>00109         atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>, 0);
<a name="l00110"></a>00110         atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a0ff46122c6b3e278ed3c3e5e2af68a1f" title="number of successful actions">ha_success</a>, 0);
<a name="l00111"></a>00111         atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a11df8f57788dedee3cf7cb7e61391a27" title="number of failed actions">ha_failure</a>, 0);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         down_write(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00114"></a>00114         tmp = <a class="code" href="mdt__hsm__cdt__agent_8c.html#a2f014a0032e35f4934b97c3184cc16a7">mdt_hsm_agent_lookup</a>(cdt, uuid);
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (tmp != NULL) {
<a name="l00116"></a>00116                 <a class="code" href="libcfs__debug_8h.html#ac961fee8081e28c070b075fd57cd5a81">LCONSOLE_WARN</a>(<span class="stringliteral">&quot;HSM agent %s already registered\n&quot;</span>,
<a name="l00117"></a>00117                               <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(uuid));
<a name="l00118"></a>00118                 up_write(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00119"></a>00119                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_free, rc = -EEXIST);
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <a class="code" href="list_8h.html#a588bec046f1e9797b33a5c5ab250f447" title="Insert an entry at the end of a list.">list_add_tail</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>, &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> == 0)
<a name="l00125"></a>00125                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a8eaa55c473f7adc7b3248445af4b3417">D_HSM</a>, <span class="stringliteral">&quot;agent %s registered for all archives\n&quot;</span>,
<a name="l00126"></a>00126                        <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>));
<a name="l00127"></a>00127         <span class="keywordflow">else</span>
<a name="l00128"></a>00128                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a8eaa55c473f7adc7b3248445af4b3417">D_HSM</a>, <span class="stringliteral">&quot;agent %s registered for %d archives\n&quot;</span>,
<a name="l00129"></a>00129                        <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>), ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         up_write(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00132"></a>00132         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = 0);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 out_free:
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="keywordflow">if</span> (ha != NULL &amp;&amp; ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a> != NULL)
<a name="l00137"></a>00137                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>,
<a name="l00138"></a>00138                          ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> * <span class="keyword">sizeof</span>(*ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>));
<a name="l00139"></a>00139         <span class="keywordflow">if</span> (ha != NULL)
<a name="l00140"></a>00140                 <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ha);
<a name="l00141"></a>00141 out:
<a name="l00142"></a>00142         <span class="keywordflow">return</span> rc;
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00153"></a><a class="code" href="mdt__internal_8h.html#aeedcafd0c9362f67d68b4a6ccf0450e9">00153</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#afb6538e4bec19875acab9085115bb81f" title="register a copy tool">mdt_hsm_agent_register_mask</a>(<span class="keyword">struct</span> <a class="code" href="structmdt__thread__info.html">mdt_thread_info</a> *mti,
<a name="l00154"></a>00154                                 <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>, __u32 archive_mask)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         <span class="keywordtype">int</span>              rc, i, nr_archives = 0;
<a name="l00157"></a>00157         __u32           *archive_id = NULL;
<a name="l00158"></a>00158         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         nr_archives = hweight32(archive_mask);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (nr_archives != 0) {
<a name="l00163"></a>00163                 <a class="code" href="obd__support_8h.html#a884069f9eb0bef22c424688b5f3fafba">OBD_ALLOC</a>(archive_id, nr_archives * <span class="keyword">sizeof</span>(*archive_id));
<a name="l00164"></a>00164                 <span class="keywordflow">if</span> (!archive_id)
<a name="l00165"></a>00165                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENOMEM);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167                 nr_archives = 0;
<a name="l00168"></a>00168                 <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(archive_mask) * 8; i++) {
<a name="l00169"></a>00169                         <span class="keywordflow">if</span> ((1 &lt;&lt; i) &amp; archive_mask) {
<a name="l00170"></a>00170                                 archive_id[nr_archives] = i + 1;
<a name="l00171"></a>00171                                 nr_archives++;
<a name="l00172"></a>00172                         }
<a name="l00173"></a>00173                 }
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         rc = <a class="code" href="mdt__hsm__cdt__agent_8c.html#a1f30a82ebc6efe0acb9122c3fbd79f53" title="register a copy tool">mdt_hsm_agent_register</a>(mti, uuid, nr_archives, archive_id);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="keywordflow">if</span> (archive_id != NULL)
<a name="l00179"></a>00179                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(archive_id, nr_archives * <span class="keyword">sizeof</span>(*archive_id));
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00191"></a><a class="code" href="mdt__internal_8h.html#a809a32bc4503b86a8e45b9393de5c241">00191</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#acc2e72d9f7fffc387ddbf1e06352d95e" title="unregister a copy tool">mdt_hsm_agent_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structmdt__thread__info.html">mdt_thread_info</a> *mti,
<a name="l00192"></a>00192                              <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>)
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mti-&gt;<a class="code" href="structmdt__thread__info.html#ab68a6a94c432f5816d5746c14c0d228f">mti_mdt</a>-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00195"></a>00195         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha;
<a name="l00196"></a>00196         <span class="keywordtype">int</span>                      rc;
<a name="l00197"></a>00197         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <span class="comment">/* no coordinator started, so we cannot serve requests */</span>
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (cdt-&gt;<a class="code" href="structcoordinator.html#aead52bd34625fe34f754b7107d6eef01" title="state">cdt_state</a> == <a class="code" href="mdt__internal_8h.html#a596daf8acb5cd4e00e66b9adec6470b8aa9bfd061bad551c4bf3c0a7ee0df2d43">CDT_STOPPED</a>)
<a name="l00201"></a>00201                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(-ENXIO);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         down_write(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         ha = <a class="code" href="mdt__hsm__cdt__agent_8c.html#a2f014a0032e35f4934b97c3184cc16a7">mdt_hsm_agent_lookup</a>(cdt, uuid);
<a name="l00206"></a>00206         <span class="keywordflow">if</span> (ha != NULL)
<a name="l00207"></a>00207                 <a class="code" href="list_8h.html#ae1cde0f50b85945cfff23be4fc1586f4" title="Remove an entry from the list it is currently in and reinitialize it.">list_del_init</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         up_write(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="keywordflow">if</span> (ha == NULL)
<a name="l00212"></a>00212                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = -ENOENT);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> != 0)
<a name="l00215"></a>00215                 <a class="code" href="obd__support_8h.html#a9bf49373d607ed467488261f133e5e49">OBD_FREE</a>(ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>,
<a name="l00216"></a>00216                          ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> * <span class="keyword">sizeof</span>(*ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>));
<a name="l00217"></a>00217         <a class="code" href="obd__support_8h.html#a56214d823e92375ad47cd06a7daeae7a">OBD_FREE_PTR</a>(ha);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = 0);
<a name="l00220"></a>00220 out:
<a name="l00221"></a>00221         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a8eaa55c473f7adc7b3248445af4b3417">D_HSM</a>, <span class="stringliteral">&quot;agent %s unregistration: %d\n&quot;</span>, <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(uuid), rc);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <span class="keywordflow">return</span> rc;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00237"></a><a class="code" href="mdt__internal_8h.html#a2590cfa39d2821765fd81a8e2cddd35f">00237</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#a2590cfa39d2821765fd81a8e2cddd35f" title="update agent statistics">mdt_hsm_agent_update_statistics</a>(<span class="keyword">struct</span> <a class="code" href="structcoordinator.html">coordinator</a> *cdt,
<a name="l00238"></a>00238                                     <span class="keywordtype">int</span> succ_rq, <span class="keywordtype">int</span> fail_rq, <span class="keywordtype">int</span> new_rq,
<a name="l00239"></a>00239                                     <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha;
<a name="l00242"></a>00242         <span class="keywordtype">int</span>                      rc;
<a name="l00243"></a>00243         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         down_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00246"></a>00246         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(ha, &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>, <a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>) {
<a name="l00247"></a>00247                 <span class="keywordflow">if</span> (<a class="code" href="group__lustreuser.html#gaf5bd7cc2aabbc92d65fc26d506f1a02e">obd_uuid_equals</a>(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>, uuid)) {
<a name="l00248"></a>00248                         <span class="keywordflow">if</span> (succ_rq == 0 &amp;&amp; fail_rq == 0 &amp;&amp; new_rq == 0) {
<a name="l00249"></a>00249                                 atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a0ff46122c6b3e278ed3c3e5e2af68a1f" title="number of successful actions">ha_success</a>, 0);
<a name="l00250"></a>00250                                 atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a11df8f57788dedee3cf7cb7e61391a27" title="number of failed actions">ha_failure</a>, 0);
<a name="l00251"></a>00251                                 atomic_set(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>, 0);
<a name="l00252"></a>00252                         } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253                                 atomic_add(succ_rq, &amp;ha-&gt;<a class="code" href="structhsm__agent.html#a0ff46122c6b3e278ed3c3e5e2af68a1f" title="number of successful actions">ha_success</a>);
<a name="l00254"></a>00254                                 atomic_add(fail_rq, &amp;ha-&gt;<a class="code" href="structhsm__agent.html#a11df8f57788dedee3cf7cb7e61391a27" title="number of failed actions">ha_failure</a>);
<a name="l00255"></a>00255                                 atomic_add(new_rq, &amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>);
<a name="l00256"></a>00256                                 atomic_sub(succ_rq, &amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>);
<a name="l00257"></a>00257                                 atomic_sub(fail_rq, &amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>);
<a name="l00258"></a>00258                         }
<a name="l00259"></a>00259                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc = 0);
<a name="l00260"></a>00260                 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263         rc = -ENOENT;
<a name="l00264"></a>00264 out:
<a name="l00265"></a>00265         up_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00266"></a>00266         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00277"></a><a class="code" href="mdt__internal_8h.html#a9d13dc794fa8f8885ee9c3b098675dd1">00277</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#a9d13dc794fa8f8885ee9c3b098675dd1" title="find the best agent">mdt_hsm_find_best_agent</a>(<span class="keyword">struct</span> <a class="code" href="structcoordinator.html">coordinator</a> *cdt, __u32 archive,
<a name="l00278"></a>00278                             <span class="keyword">struct</span> <a class="code" href="structobd__uuid.html">obd_uuid</a> *<a class="code" href="llog__test_8c.html#aaa83f069991aa91e0383af81ef30f13f">uuid</a>)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280         <span class="keywordtype">int</span>                      rc = -EAGAIN, i, load = -1;
<a name="l00281"></a>00281         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha;
<a name="l00282"></a>00282         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="comment">/* Choose an export to send a copytool req to */</span>
<a name="l00285"></a>00285         down_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00286"></a>00286         <a class="code" href="list_8h.html#a9b782fefb5ab71ce9762182e45a615e1" title="Iterate over a list of given type.">list_for_each_entry</a>(ha, &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>, <a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>) {
<a name="l00287"></a>00287                 <span class="keywordflow">for</span> (i = 0; (i &lt; ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a>) &amp;&amp;
<a name="l00288"></a>00288                               (ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>[i] != archive); i++) {
<a name="l00289"></a>00289                         <span class="comment">/* nothing to do, just skip unmatching records */</span>
<a name="l00290"></a>00290                 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292                 <span class="comment">/* archive count == 0 means copy tool serves any backend */</span>
<a name="l00293"></a>00293                 <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> != 0 &amp;&amp; i == ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a>)
<a name="l00294"></a>00294                         <span class="keywordflow">continue</span>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                 <span class="keywordflow">if</span> (load == -1 || load &gt; atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>)) {
<a name="l00297"></a>00297                         load = atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>);
<a name="l00298"></a>00298                         *uuid = ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>;
<a name="l00299"></a>00299                         rc = 0;
<a name="l00300"></a>00300                 }
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> (atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>) == 0)
<a name="l00302"></a>00302                         <span class="keywordflow">break</span>;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304         up_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00322"></a><a class="code" href="mdt__internal_8h.html#ab0c3f5ec4cb4656ab69af45c1484b6ee">00322</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#ab0c3f5ec4cb4656ab69af45c1484b6ee" title="send a compound request to the agent">mdt_hsm_agent_send</a>(<span class="keyword">struct</span> <a class="code" href="structmdt__thread__info.html">mdt_thread_info</a> *mti,
<a name="l00323"></a>00323                        <span class="keyword">struct</span> <a class="code" href="structhsm__action__list.html">hsm_action_list</a> *hal, <span class="keywordtype">bool</span> purge)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>       *exp;
<a name="l00326"></a>00326         <span class="keyword">struct </span><a class="code" href="structmdt__device.html">mdt_device</a>       *mdt = mti-&gt;<a class="code" href="structmdt__thread__info.html#ab68a6a94c432f5816d5746c14c0d228f">mti_mdt</a>;
<a name="l00327"></a>00327         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mti-&gt;<a class="code" href="structmdt__thread__info.html#ab68a6a94c432f5816d5746c14c0d228f">mti_mdt</a>-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00328"></a>00328         <span class="keyword">struct </span><a class="code" href="structhsm__action__list.html">hsm_action_list</a>  *<a class="code" href="parallel__grouplock_8c.html#a30581aaaef7980b9fc6df8f98406097c">buf</a> = NULL;
<a name="l00329"></a>00329         <span class="keyword">struct </span><a class="code" href="structhsm__action__item.html">hsm_action_item</a>  *hai;
<a name="l00330"></a>00330         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>          uuid;
<a name="l00331"></a>00331         <span class="keywordtype">int</span>                      len, i, rc = 0;
<a name="l00332"></a>00332         <span class="keywordtype">bool</span>                     fail_request;
<a name="l00333"></a>00333         <span class="keywordtype">bool</span>                     is_registered = <span class="keyword">false</span>;
<a name="l00334"></a>00334         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         rc = <a class="code" href="mdt__hsm__cdt__agent_8c.html#a9d13dc794fa8f8885ee9c3b098675dd1" title="find the best agent">mdt_hsm_find_best_agent</a>(cdt, hal-&gt;<a class="code" href="structhsm__action__list.html#aa888658c786c01db6fe07267b8880f3e">hal_archive_id</a>, &amp;uuid);
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (rc) {
<a name="l00338"></a>00338                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: Cannot find agent for archive %d: rc = %d\n&quot;</span>,
<a name="l00339"></a>00339                        <a class="code" href="mdt__internal_8h.html#a1fd47bb7bf1cf0f84a8c5397f0e32663">mdt_obd_name</a>(mdt), hal-&gt;<a class="code" href="structhsm__action__list.html#aa888658c786c01db6fe07267b8880f3e">hal_archive_id</a>, rc);
<a name="l00340"></a>00340                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a8eaa55c473f7adc7b3248445af4b3417">D_HSM</a>, <span class="stringliteral">&quot;Agent %s selected for archive %d\n&quot;</span>, <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;uuid),
<a name="l00344"></a>00344                hal-&gt;<a class="code" href="structhsm__action__list.html#aa888658c786c01db6fe07267b8880f3e">hal_archive_id</a>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346         len = <a class="code" href="group__lustreuser.html#ga6d4160e96d16b42f15a6e73141c4fd66">hal_size</a>(hal);
<a name="l00347"></a>00347         buf = <a class="code" href="obd__class_8h.html#ab8d4e025f4b99f8f0b59a1513a302c17">kuc_alloc</a>(len, <a class="code" href="uapi__kernelcomm_8h.html#a4949b01757baf5182f77376bf68989a8a324a971fa1d2fc9cbed901188e1fef46">KUC_TRANSPORT_HSM</a>, <a class="code" href="group__lustreuser.html#gga4a5211f314f78452584a6352eb97b2a3a2420579bf34fca71d6d6c9fdb61b0414">HMT_ACTION_LIST</a>);
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (IS_ERR(buf))
<a name="l00349"></a>00349                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(PTR_ERR(buf));
<a name="l00350"></a>00350         memcpy(buf, hal, len);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">/* Check if request is still valid (cf file hsm flags) */</span>
<a name="l00353"></a>00353         fail_request = <span class="keyword">false</span>;
<a name="l00354"></a>00354         hai = <a class="code" href="group__lustreuser.html#ga6d926d9c843ddf7e3447935258d11816">hai_first</a>(hal);
<a name="l00355"></a>00355         <span class="keywordflow">for</span> (i = 0; i &lt; hal-&gt;<a class="code" href="structhsm__action__list.html#a807d1dcfd7be62c4b1d20902a057e4f3">hal_count</a>; i++, hai = <a class="code" href="group__lustreuser.html#gac3954160b6cc61d14799ff62f3da1d70">hai_next</a>(hai)) {
<a name="l00356"></a>00356                 <span class="keywordflow">if</span> (hai-&gt;hai_action != <a class="code" href="group__lustreuser.html#gga8f11bf6f2778549a17dc5999701f3c0ca5d18cacedca1a4ccefc312b5522923ae">HSMA_CANCEL</a>) {
<a name="l00357"></a>00357                         <span class="keyword">struct </span><a class="code" href="structmdt__object.html">mdt_object</a> *obj;
<a name="l00358"></a>00358                         <span class="keyword">struct </span><a class="code" href="structmd__hsm.html">md_hsm</a> hsm;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360                         obj = <a class="code" href="mdt__coordinator_8c.html#a6f4b191a27ceae23833d720870e40a2d" title="get obj and HSM attributes on a fid">mdt_hsm_get_md_hsm</a>(mti, &amp;hai-&gt;hai_fid, &amp;hsm);
<a name="l00361"></a>00361                         <span class="keywordflow">if</span> (!IS_ERR(obj) &amp;&amp; obj != NULL) {
<a name="l00362"></a>00362                                 <a class="code" href="mdt__internal_8h.html#aeff83b3a74cb894165753ad356445fba">mdt_object_put</a>(mti-&gt;<a class="code" href="structmdt__thread__info.html#a3c876046a2f8e3fb65dc0aa8e5d5d43e">mti_env</a>, obj);
<a name="l00363"></a>00363                         } <span class="keywordflow">else</span> {
<a name="l00364"></a>00364                                 <span class="keywordflow">if</span> (hai-&gt;hai_action == <a class="code" href="group__lustreuser.html#gga8f11bf6f2778549a17dc5999701f3c0cab5f41867b413736ba8aa8f0169daf13c">HSMA_REMOVE</a>)
<a name="l00365"></a>00365                                         <span class="keywordflow">continue</span>;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367                                 <span class="keywordflow">if</span> (obj == NULL) {
<a name="l00368"></a>00368                                         fail_request = <span class="keyword">true</span>;
<a name="l00369"></a>00369                                         rc = <a class="code" href="mdt__hsm__cdt__actions_8c.html#a980845ce8e872b6946d082f8af260a71" title="update an entry in agent llog">mdt_agent_record_update</a>(
<a name="l00370"></a>00370                                                              mti-&gt;<a class="code" href="structmdt__thread__info.html#a3c876046a2f8e3fb65dc0aa8e5d5d43e">mti_env</a>, mdt,
<a name="l00371"></a>00371                                                              &amp;hai-&gt;hai_cookie,
<a name="l00372"></a>00372                                                              1, <a class="code" href="group__lustreidl.html#ggac36f21688fb1f296388242abb174a86eab57f83ff5d9daf09dffb0e9206bffd59">ARS_FAILED</a>);
<a name="l00373"></a>00373                                         <span class="keywordflow">if</span> (rc) {
<a name="l00374"></a>00374                                                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(
<a name="l00375"></a>00375                                               <span class="stringliteral">&quot;%s: mdt_agent_record_update() &quot;</span>
<a name="l00376"></a>00376                                               <span class="stringliteral">&quot;failed, cannot update &quot;</span>
<a name="l00377"></a>00377                                               <span class="stringliteral">&quot;status to %s for cookie &quot;</span>
<a name="l00378"></a>00378                                               <a class="code" href="libcfs_2include_2libcfs_2types_8h.html#abd4b7b7675c19f574aa3c3cd3a7f770f">LPX64</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>,
<a name="l00379"></a>00379                                               <a class="code" href="mdt__internal_8h.html#a1fd47bb7bf1cf0f84a8c5397f0e32663">mdt_obd_name</a>(mdt),
<a name="l00380"></a>00380                                               <a class="code" href="group__lustreidl.html#gaa586db56e4e870c6cbc46a0fac29bde9">agent_req_status2name</a>(<a class="code" href="group__lustreidl.html#ggac36f21688fb1f296388242abb174a86eab57f83ff5d9daf09dffb0e9206bffd59">ARS_FAILED</a>),
<a name="l00381"></a>00381                                               hai-&gt;hai_cookie, rc);
<a name="l00382"></a>00382                                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_buf, rc);
<a name="l00383"></a>00383                                         }
<a name="l00384"></a>00384                                         <span class="keywordflow">continue</span>;
<a name="l00385"></a>00385                                 }
<a name="l00386"></a>00386                                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_buf, rc = PTR_ERR(obj));
<a name="l00387"></a>00387                         }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389                         <span class="keywordflow">if</span> (!<a class="code" href="mdt__coordinator_8c.html#a79b7325228a5903643769041fc64bf56" title="check if a request is compatible with file status">mdt_hsm_is_action_compat</a>(hai, hal-&gt;<a class="code" href="structhsm__action__list.html#aa888658c786c01db6fe07267b8880f3e">hal_archive_id</a>,
<a name="l00390"></a>00390                                                       hal-&gt;<a class="code" href="structhsm__action__list.html#a1f6f580e1673472d2f1bdd1845b572e6">hal_flags</a>, &amp;hsm)) {
<a name="l00391"></a>00391                                 <span class="comment">/* incompatible request, we abort the request */</span>
<a name="l00392"></a>00392                                 <span class="comment">/* next time coordinator will wake up, it will</span>
<a name="l00393"></a>00393 <span class="comment">                                 * make the same compound with valid only</span>
<a name="l00394"></a>00394 <span class="comment">                                 * records */</span>
<a name="l00395"></a>00395                                 fail_request = <span class="keyword">true</span>;
<a name="l00396"></a>00396                                 rc = <a class="code" href="mdt__hsm__cdt__actions_8c.html#a980845ce8e872b6946d082f8af260a71" title="update an entry in agent llog">mdt_agent_record_update</a>(mti-&gt;<a class="code" href="structmdt__thread__info.html#a3c876046a2f8e3fb65dc0aa8e5d5d43e">mti_env</a>, mdt,
<a name="l00397"></a>00397                                                              &amp;hai-&gt;hai_cookie,
<a name="l00398"></a>00398                                                              1, <a class="code" href="group__lustreidl.html#ggac36f21688fb1f296388242abb174a86eab57f83ff5d9daf09dffb0e9206bffd59">ARS_FAILED</a>);
<a name="l00399"></a>00399                                 <span class="keywordflow">if</span> (rc) {
<a name="l00400"></a>00400                                         <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: mdt_agent_record_update() &quot;</span>
<a name="l00401"></a>00401                                               <span class="stringliteral">&quot;failed, cannot update &quot;</span>
<a name="l00402"></a>00402                                               <span class="stringliteral">&quot;status to %s for cookie &quot;</span>
<a name="l00403"></a>00403                                               <a class="code" href="libcfs_2include_2libcfs_2types_8h.html#abd4b7b7675c19f574aa3c3cd3a7f770f">LPX64</a><span class="stringliteral">&quot;: rc = %d\n&quot;</span>,
<a name="l00404"></a>00404                                               <a class="code" href="mdt__internal_8h.html#a1fd47bb7bf1cf0f84a8c5397f0e32663">mdt_obd_name</a>(mdt),
<a name="l00405"></a>00405                                               <a class="code" href="group__lustreidl.html#gaa586db56e4e870c6cbc46a0fac29bde9">agent_req_status2name</a>(<a class="code" href="group__lustreidl.html#ggac36f21688fb1f296388242abb174a86eab57f83ff5d9daf09dffb0e9206bffd59">ARS_FAILED</a>),
<a name="l00406"></a>00406                                               hai-&gt;hai_cookie, rc);
<a name="l00407"></a>00407                                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_buf, rc);
<a name="l00408"></a>00408                                 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410                                 <span class="comment">/* if restore and record status updated, give</span>
<a name="l00411"></a>00411 <span class="comment">                                 * back granted layout lock */</span>
<a name="l00412"></a>00412                                 <span class="keywordflow">if</span> (hai-&gt;hai_action == <a class="code" href="group__lustreuser.html#gga8f11bf6f2778549a17dc5999701f3c0caa39ed66c50c133f00ab1a4f0515c034c">HSMA_RESTORE</a>) {
<a name="l00413"></a>00413                                         <span class="keyword">struct </span><a class="code" href="structcdt__restore__handle.html">cdt_restore_handle</a> *crh = NULL;
<a name="l00414"></a>00414                                         <span class="keyword">struct </span><a class="code" href="structmdt__object.html">mdt_object</a> *obj = NULL;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                                         mutex_lock(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa39d357c48c500bd48aac931232b7ae7" title="protect restore list">cdt_restore_lock</a>);
<a name="l00417"></a>00417                                         crh = <a class="code" href="mdt__coordinator_8c.html#ac5a880beb355228713092f559ba46a1c" title="lookup a restore handle by FID caller needs to hold cdt_restore_lock">mdt_hsm_restore_hdl_find</a>(cdt,
<a name="l00418"></a>00418                                                                 &amp;hai-&gt;hai_fid);
<a name="l00419"></a>00419                                         <span class="keywordflow">if</span> (crh != NULL)
<a name="l00420"></a>00420                                                 <a class="code" href="list_8h.html#ab1708206f0f7e0a56550b35372203ba5" title="Remove an entry from the list it is currently in.">list_del</a>(&amp;crh-&gt;<a class="code" href="structcdt__restore__handle.html#acc2b7fc33d3edd1f9231ce3b0fd307ec" title="to chain the handle">crh_list</a>);
<a name="l00421"></a>00421                                         mutex_unlock(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa39d357c48c500bd48aac931232b7ae7" title="protect restore list">cdt_restore_lock</a>);
<a name="l00422"></a>00422                                         obj = <a class="code" href="mdt__handler_8c.html#adb49d144aef996ae26399713b415adc9">mdt_object_find</a>(mti-&gt;<a class="code" href="structmdt__thread__info.html#a3c876046a2f8e3fb65dc0aa8e5d5d43e">mti_env</a>,
<a name="l00423"></a>00423                                                               mti-&gt;<a class="code" href="structmdt__thread__info.html#ab68a6a94c432f5816d5746c14c0d228f">mti_mdt</a>,
<a name="l00424"></a>00424                                                               &amp;hai-&gt;hai_fid);
<a name="l00425"></a>00425                                         <span class="keywordflow">if</span> (!IS_ERR(obj) &amp;&amp; crh != NULL)
<a name="l00426"></a>00426                                                 <a class="code" href="mdt__handler_8c.html#a6b11524585025201c5d2ba6d8c2b7d9a" title="Unlock mdt object.">mdt_object_unlock</a>(mti, obj,
<a name="l00427"></a>00427                                                                   &amp;crh-&gt;<a class="code" href="structcdt__restore__handle.html#a0e807a461dc6fd5969226cfe100a0fa3" title="lock handle">crh_lh</a>,
<a name="l00428"></a>00428                                                                   1);
<a name="l00429"></a>00429                                         <span class="keywordflow">if</span> (crh != NULL)
<a name="l00430"></a>00430                                                 <a class="code" href="obd__support_8h.html#a8790e4c5dc3134282343de016fff8e2a">OBD_SLAB_FREE_PTR</a>(crh,
<a name="l00431"></a>00431                                                         <a class="code" href="mdt__handler_8c.html#a9586a76ec8e763abdcaca0585df25515">mdt_hsm_cdt_kmem</a>);
<a name="l00432"></a>00432                                         <span class="keywordflow">if</span> (!IS_ERR(obj))
<a name="l00433"></a>00433                                                 <a class="code" href="mdt__internal_8h.html#aeff83b3a74cb894165753ad356445fba">mdt_object_put</a>(mti-&gt;<a class="code" href="structmdt__thread__info.html#a3c876046a2f8e3fb65dc0aa8e5d5d43e">mti_env</a>,
<a name="l00434"></a>00434                                                                obj);
<a name="l00435"></a>00435                                 }
<a name="l00436"></a>00436                         }
<a name="l00437"></a>00437                 }
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440         <span class="comment">/* we found incompatible requests, so the compound cannot be send</span>
<a name="l00441"></a>00441 <span class="comment">         * as is. Bad records have been invalidated in llog.</span>
<a name="l00442"></a>00442 <span class="comment">         * Valid one will be reschedule next time coordinator will wake up</span>
<a name="l00443"></a>00443 <span class="comment">         * So no need the rebuild a full valid compound request now</span>
<a name="l00444"></a>00444 <span class="comment">         */</span>
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (fail_request)
<a name="l00446"></a>00446                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_buf, rc = 0);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="comment">/* Cancel memory registration is useless for purge</span>
<a name="l00449"></a>00449 <span class="comment">         * non registration avoid a deadlock :</span>
<a name="l00450"></a>00450 <span class="comment">         * in case of failure we have to take the write lock</span>
<a name="l00451"></a>00451 <span class="comment">         * to remove entry which conflict with the read loack needed</span>
<a name="l00452"></a>00452 <span class="comment">         * by purge</span>
<a name="l00453"></a>00453 <span class="comment">         */</span>
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (!purge) {
<a name="l00455"></a>00455                 <span class="comment">/* set is_registered even if failure because we may have</span>
<a name="l00456"></a>00456 <span class="comment">                 * partial work done */</span>
<a name="l00457"></a>00457                 is_registered = <span class="keyword">true</span>;
<a name="l00458"></a>00458                 rc = <a class="code" href="mdt__coordinator_8c.html#ac23fca3bab32403469666065055076a9" title="register all requests from an hal in the memory list">mdt_hsm_add_hal</a>(mti, hal, &amp;uuid);
<a name="l00459"></a>00459                 <span class="keywordflow">if</span> (rc)
<a name="l00460"></a>00460                         <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out_buf, rc);
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="comment">/* Uses the ldlm reverse import; this rpc will be seen by</span>
<a name="l00464"></a>00464 <span class="comment">         *  the ldlm_callback_handler. Note this sends a request RPC</span>
<a name="l00465"></a>00465 <span class="comment">         * from a server (MDT) to a client (MDC), backwards of normal comms.</span>
<a name="l00466"></a>00466 <span class="comment">         */</span>
<a name="l00467"></a>00467         exp = <a class="code" href="libcfs__hash_8h.html#a8e2a5b89d520bf4a2d61a615d2b4db59" title="Lookup an item using  in the libcfs hash  and return it.">cfs_hash_lookup</a>(<a class="code" href="mdt__internal_8h.html#a2d72305535279222efbb87f5483ad240">mdt2obd_dev</a>(mdt)-&gt;obd_uuid_hash, &amp;uuid);
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (exp == NULL || exp-&gt;<a class="code" href="structobd__export.html#a6dced674d19d58ce0868336c044e1587">exp_disconnected</a>) {
<a name="l00469"></a>00469                 <span class="comment">/* This should clean up agents on evicted exports */</span>
<a name="l00470"></a>00470                 rc = -ENOENT;
<a name="l00471"></a>00471                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: agent uuid (%s) not found, unregistering:&quot;</span>
<a name="l00472"></a>00472                        <span class="stringliteral">&quot; rc = %d\n&quot;</span>,
<a name="l00473"></a>00473                        <a class="code" href="mdt__internal_8h.html#a1fd47bb7bf1cf0f84a8c5397f0e32663">mdt_obd_name</a>(mdt), <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;uuid), rc);
<a name="l00474"></a>00474                 <a class="code" href="mdt__hsm__cdt__agent_8c.html#acc2e72d9f7fffc387ddbf1e06352d95e" title="unregister a copy tool">mdt_hsm_agent_unregister</a>(mti, &amp;uuid);
<a name="l00475"></a>00475                 <a class="code" href="small__write_8c.html#ad2ce2f6a9a52e27a453236173fb2cb12">GOTO</a>(out, rc);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         <span class="comment">/* send request to agent */</span>
<a name="l00479"></a>00479         rc = <a class="code" href="group__lib.html#gafc5cf9a5b2924b90734e720301742315" title="Send a remote set_info_async.">do_set_info_async</a>(exp-&gt;<a class="code" href="structobd__export.html#a2dce74f596d31fe639a35fae13a75214" title="&amp;quot;reverse&amp;quot; import to send requests (e.g.">exp_imp_reverse</a>, <a class="code" href="group__lustreidl.html#gga8c7ec74b59dd44ef0a3962fdc078fd45acf15d0840d9b59fc2e9482a5b93295a8">LDLM_SET_INFO</a>,
<a name="l00480"></a>00480                                <a class="code" href="packet-lustre_8c.html#a9884139930c6d7f650a56cde56a33881">LUSTRE_OBD_VERSION</a>,
<a name="l00481"></a>00481                                <span class="keyword">sizeof</span>(<a class="code" href="obd_8h.html#a0d364b47f244c25a159b7f7fc0cdfdb7">KEY_HSM_COPYTOOL_SEND</a>),
<a name="l00482"></a>00482                                <a class="code" href="obd_8h.html#a0d364b47f244c25a159b7f7fc0cdfdb7">KEY_HSM_COPYTOOL_SEND</a>,
<a name="l00483"></a>00483                                <a class="code" href="obd__class_8h.html#a72ae2ac935a53ff449f5c4da2cbc6828">kuc_len</a>(len), <a class="code" href="obd__class_8h.html#a99510ff1d09b1e9c63559ccaba7e071e">kuc_ptr</a>(buf), NULL);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         <span class="keywordflow">if</span> (rc)
<a name="l00486"></a>00486                 <a class="code" href="libcfs__debug_8h.html#ad06acc43c8c74fb94f76adde491a72ac">CERROR</a>(<span class="stringliteral">&quot;%s: cannot send request to agent &apos;%s&apos;: rc = %d\n&quot;</span>,
<a name="l00487"></a>00487                        <a class="code" href="mdt__internal_8h.html#a1fd47bb7bf1cf0f84a8c5397f0e32663">mdt_obd_name</a>(mdt), <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;uuid), rc);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <a class="code" href="obd__class_8h.html#a60de37a3a43d309602be633a0f1125f9">class_export_put</a>(exp);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (rc == -EPIPE) {
<a name="l00492"></a>00492                 <a class="code" href="libcfs__debug_8h.html#a9253e2ada2b31c570a7c99d1bd6a6355">CDEBUG</a>(<a class="code" href="libcfs__debug_8h.html#a8eaa55c473f7adc7b3248445af4b3417">D_HSM</a>, <span class="stringliteral">&quot;Lost connection to agent &apos;%s&apos;, unregistering\n&quot;</span>,
<a name="l00493"></a>00493                        <a class="code" href="group__lustreuser.html#gaac3ce4277dee1a5b85ff0cf4b2760997">obd_uuid2str</a>(&amp;uuid));
<a name="l00494"></a>00494                 <a class="code" href="mdt__hsm__cdt__agent_8c.html#acc2e72d9f7fffc387ddbf1e06352d95e" title="unregister a copy tool">mdt_hsm_agent_unregister</a>(mti, &amp;uuid);
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 out:
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (rc != 0 &amp;&amp; is_registered) {
<a name="l00499"></a>00499                 <span class="comment">/* in case of error, we have to unregister requests */</span>
<a name="l00500"></a>00500                 hai = <a class="code" href="group__lustreuser.html#ga6d926d9c843ddf7e3447935258d11816">hai_first</a>(hal);
<a name="l00501"></a>00501                 <span class="keywordflow">for</span> (i = 0; i &lt; hal-&gt;<a class="code" href="structhsm__action__list.html#a807d1dcfd7be62c4b1d20902a057e4f3">hal_count</a>; i++, hai = <a class="code" href="group__lustreuser.html#gac3954160b6cc61d14799ff62f3da1d70">hai_next</a>(hai)) {
<a name="l00502"></a>00502                         <span class="keywordflow">if</span> (hai-&gt;hai_action == <a class="code" href="group__lustreuser.html#gga8f11bf6f2778549a17dc5999701f3c0ca5d18cacedca1a4ccefc312b5522923ae">HSMA_CANCEL</a>)
<a name="l00503"></a>00503                                 <span class="keywordflow">continue</span>;
<a name="l00504"></a>00504                         <a class="code" href="mdt__hsm__cdt__requests_8c.html#a55c303cdfbd0965d0228593f6a61ae35" title="remove request from the list">mdt_cdt_remove_request</a>(cdt, hai-&gt;hai_cookie);
<a name="l00505"></a>00505                 }
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 out_buf:
<a name="l00509"></a>00509         <a class="code" href="obd__class_8h.html#aa2e0aa24d537c1c87d233be8faa22581">kuc_free</a>(buf, len);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00512"></a>00512 }
<a name="l00513"></a>00513 
<a name="l00521"></a><a class="code" href="mdt__internal_8h.html#adc10087711d7d674734d277d9e3decc4">00521</a> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#adc10087711d7d674734d277d9e3decc4" title="update status of a request">mdt_hsm_coordinator_update</a>(<span class="keyword">struct</span> <a class="code" href="structmdt__thread__info.html">mdt_thread_info</a> *mti,
<a name="l00522"></a>00522                                <span class="keyword">struct</span> <a class="code" href="structhsm__progress__kernel.html" title="On the wire version of hsm_progress structure.">hsm_progress_kernel</a> *pgs)
<a name="l00523"></a>00523 {
<a name="l00524"></a>00524         <span class="keywordtype">int</span>      rc;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00527"></a>00527         <span class="comment">/* ask to coordinator to update request state and</span>
<a name="l00528"></a>00528 <span class="comment">         * to record on disk the result */</span>
<a name="l00529"></a>00529         rc = <a class="code" href="mdt__coordinator_8c.html#a3b8427c08750b3ff8dac7dd04a04a683" title="update status of a request">mdt_hsm_update_request_state</a>(mti, pgs, 1);
<a name="l00530"></a>00530         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 
<a name="l00536"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#aad7995d67480a67941839b04f76271e6">00536</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="mdt__hsm__cdt__agent_8c.html#aad7995d67480a67941839b04f76271e6" title="seq_file method called to start access to /proc file">mdt_hsm_agent_proc_start</a>(<span class="keyword">struct</span> seq_file *s, loff_t *off)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538         <span class="keyword">struct </span><a class="code" href="structmdt__device.html">mdt_device</a>       *mdt = s-&gt;private;
<a name="l00539"></a>00539         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mdt-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00540"></a>00540         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        *pos;
<a name="l00541"></a>00541         loff_t                   i;
<a name="l00542"></a>00542         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         down_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (<a class="code" href="list_8h.html#a0fce12be81e8f2677b3a272fee1652ac" title="Test whether a list is empty.">list_empty</a>(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>))
<a name="l00547"></a>00547                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(NULL);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (*off == 0)
<a name="l00550"></a>00550                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(SEQ_START_TOKEN);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         i = 0;
<a name="l00553"></a>00553         <a class="code" href="list_8h.html#ab8b24e6660ab3760c923e4b4db3fa502" title="Iterate over a list.">list_for_each</a>(pos, &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>) {
<a name="l00554"></a>00554                 i++;
<a name="l00555"></a>00555                 <span class="keywordflow">if</span> (i &gt;= *off)
<a name="l00556"></a>00556                         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(pos);
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(NULL);
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00566"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#ab2b3831f25d086041670cebf659fdfa2">00566</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="mdt__hsm__cdt__agent_8c.html#ab2b3831f25d086041670cebf659fdfa2" title="seq_file method called to get next item just returns NULL at eof">mdt_hsm_agent_proc_next</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v, loff_t *p)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568         <span class="keyword">struct </span><a class="code" href="structmdt__device.html">mdt_device</a>       *mdt = s-&gt;private;
<a name="l00569"></a>00569         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mdt-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00570"></a>00570         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        *pos = v;
<a name="l00571"></a>00571         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (pos == SEQ_START_TOKEN)
<a name="l00574"></a>00574                 pos = cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>.<a class="code" href="structlist__head.html#ac3b0ff0dfb978a0cfbdad6b9d19cdcfe">next</a>;
<a name="l00575"></a>00575         <span class="keywordflow">else</span>
<a name="l00576"></a>00576                 pos = pos-&gt;<a class="code" href="structlist__head.html#ac3b0ff0dfb978a0cfbdad6b9d19cdcfe">next</a>;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         (*p)++;
<a name="l00579"></a>00579         <span class="keywordflow">if</span> (pos != &amp;cdt-&gt;<a class="code" href="structcoordinator.html#a2ce947dc53ac9ec32929853f52c92f4c" title="list of register agents">cdt_agents</a>)
<a name="l00580"></a>00580                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(pos);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(NULL);
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00587"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#a109b89d2949765d02de188431ef079bf">00587</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#a109b89d2949765d02de188431ef079bf">mdt_hsm_agent_proc_show</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        *pos = v;
<a name="l00590"></a>00590         <span class="keyword">struct </span><a class="code" href="structhsm__agent.html">hsm_agent</a>        *ha;
<a name="l00591"></a>00591         <span class="keywordtype">int</span>                      i;
<a name="l00592"></a>00592         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (pos == SEQ_START_TOKEN)
<a name="l00595"></a>00595                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         ha = <a class="code" href="list_8h.html#a26c976b7f654e70df318c1843e5094de" title="Get the container of a list.">list_entry</a>(pos, <span class="keyword">struct</span> <a class="code" href="structhsm__agent.html">hsm_agent</a>, <a class="code" href="structhsm__agent.html#a6c59548a0d45dd790461953ee0c0e241" title="to chain the agents">ha_list</a>);
<a name="l00598"></a>00598         seq_printf(s, <span class="stringliteral">&quot;uuid=%s archive_id=&quot;</span>, ha-&gt;<a class="code" href="structhsm__agent.html#ad97e991f67a2482bf6618dd5fc49251b" title="agent uuid">ha_uuid</a>.<a class="code" href="structobd__uuid.html#aa6cced3e76a3656e5152bb9ed249e7a1">uuid</a>);
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a> == 0) {
<a name="l00600"></a>00600                 seq_printf(s, <span class="stringliteral">&quot;ANY&quot;</span>);
<a name="l00601"></a>00601         } <span class="keywordflow">else</span> {
<a name="l00602"></a>00602                 seq_printf(s, <span class="stringliteral">&quot;%d&quot;</span>, ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>[0]);
<a name="l00603"></a>00603                 <span class="keywordflow">for</span> (i = 1; i &lt; ha-&gt;<a class="code" href="structhsm__agent.html#a54a2d480bb57149f0cf8d72b1b6386a6" title="number of archive entries 0 means any archive">ha_archive_cnt</a>; i++)
<a name="l00604"></a>00604                         seq_printf(s, <span class="stringliteral">&quot;,%d&quot;</span>, ha-&gt;<a class="code" href="structhsm__agent.html#a0af1daffc45c2d7002f9ba1bd47ec072" title="archive id">ha_archive_id</a>[i]);
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         seq_printf(s, <span class="stringliteral">&quot; requests=[current:%d ok:%d errors:%d]\n&quot;</span>,
<a name="l00608"></a>00608                    atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#aafb253e899be6ef249d51f26a0dc54b6" title="current request count">ha_requests</a>),
<a name="l00609"></a>00609                    atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a0ff46122c6b3e278ed3c3e5e2af68a1f" title="number of successful actions">ha_success</a>),
<a name="l00610"></a>00610                    atomic_read(&amp;ha-&gt;<a class="code" href="structhsm__agent.html#a11df8f57788dedee3cf7cb7e61391a27" title="number of failed actions">ha_failure</a>));
<a name="l00611"></a>00611         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(0);
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00617"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#aca40e9ef3e1cc6e450395a2729f13982">00617</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#aca40e9ef3e1cc6e450395a2729f13982" title="seq_file method called to stop access to /proc file">mdt_hsm_agent_proc_stop</a>(<span class="keyword">struct</span> seq_file *s, <span class="keywordtype">void</span> *v)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619         <span class="keyword">struct </span><a class="code" href="structmdt__device.html">mdt_device</a>       *mdt = s-&gt;private;
<a name="l00620"></a>00620         <span class="keyword">struct </span><a class="code" href="structcoordinator.html">coordinator</a>      *cdt = &amp;mdt-&gt;<a class="code" href="structmdt__device.html#a2edda46980827b0864072b7a17719380">mdt_coordinator</a>;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         up_read(&amp;cdt-&gt;<a class="code" href="structcoordinator.html#aa864b03f7d8b66fa578d6252a2a91da3" title="protect agent list">cdt_agent_lock</a>);
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="comment">/* hsm agent list proc functions */</span>
<a name="l00626"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#a5df11d67c20db5fe7316c6821d4fd752">00626</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>seq_operations <a class="code" href="mdt__hsm__cdt__agent_8c.html#a5df11d67c20db5fe7316c6821d4fd752">mdt_hsm_agent_proc_ops</a> = {
<a name="l00627"></a>00627         .start  = <a class="code" href="mdt__hsm__cdt__agent_8c.html#aad7995d67480a67941839b04f76271e6" title="seq_file method called to start access to /proc file">mdt_hsm_agent_proc_start</a>,
<a name="l00628"></a>00628         .next   = <a class="code" href="mdt__hsm__cdt__agent_8c.html#ab2b3831f25d086041670cebf659fdfa2" title="seq_file method called to get next item just returns NULL at eof">mdt_hsm_agent_proc_next</a>,
<a name="l00629"></a>00629         .show   = <a class="code" href="mdt__hsm__cdt__agent_8c.html#a109b89d2949765d02de188431ef079bf">mdt_hsm_agent_proc_show</a>,
<a name="l00630"></a>00630         .stop   = <a class="code" href="mdt__hsm__cdt__agent_8c.html#aca40e9ef3e1cc6e450395a2729f13982" title="seq_file method called to stop access to /proc file">mdt_hsm_agent_proc_stop</a>,
<a name="l00631"></a>00631 };
<a name="l00632"></a>00632 
<a name="l00637"></a><a class="code" href="mdt__hsm__cdt__agent_8c.html#abb8bf9a4bccc60d3b8a3976c47d22307">00637</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="mdt__hsm__cdt__agent_8c.html#abb8bf9a4bccc60d3b8a3976c47d22307" title="public function called at open of /proc file to get list of agents">lprocfs_open_hsm_agent</a>(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639         <span class="keyword">struct </span>seq_file *s;
<a name="l00640"></a>00640         <span class="keywordtype">int</span>              rc;
<a name="l00641"></a>00641         <a class="code" href="flock_8c.html#affebc0cf7e41098a8c78a8c2c4586d72">ENTRY</a>;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         rc = seq_open(file, &amp;<a class="code" href="mdt__hsm__cdt__agent_8c.html#a5df11d67c20db5fe7316c6821d4fd752">mdt_hsm_agent_proc_ops</a>);
<a name="l00644"></a>00644         <span class="keywordflow">if</span> (rc)
<a name="l00645"></a>00645                 <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         s = file-&gt;private_data;
<a name="l00648"></a>00648         s-&gt;private = PDE_DATA(inode);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <a class="code" href="libcfs__debug_8h.html#a787d0616756df8ab4dceb42a0b73e6d6">RETURN</a>(rc);
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="comment">/* methods to access hsm agent list */</span>
<a name="l00654"></a><a class="code" href="mdt__internal_8h.html#ae27f872199c9effc47a6630d21ff2509">00654</a> <span class="keyword">const</span> <span class="keyword">struct </span>file_operations <a class="code" href="mdt__hsm__cdt__agent_8c.html#ae27f872199c9effc47a6630d21ff2509">mdt_hsm_agent_fops</a> = {
<a name="l00655"></a>00655         .owner          = THIS_MODULE,
<a name="l00656"></a>00656         .open           = <a class="code" href="mdt__hsm__cdt__agent_8c.html#abb8bf9a4bccc60d3b8a3976c47d22307" title="public function called at open of /proc file to get list of agents">lprocfs_open_hsm_agent</a>,
<a name="l00657"></a>00657         .read           = seq_read,
<a name="l00658"></a>00658         .llseek         = seq_lseek,
<a name="l00659"></a>00659         .release        = lprocfs_seq_release,
<a name="l00660"></a>00660 };
<a name="l00661"></a>00661 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:38 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
