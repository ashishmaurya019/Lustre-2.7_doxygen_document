<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/ofd/ofd_dlm.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lustre/ofd/ofd_dlm.c File Reference</h1><code>#include &quot;<a class="el" href="ofd__internal_8h_source.html">ofd_internal.h</a>&quot;</code><br/>

<p><a href="ofd__dlm_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structofd__intent__args.html">ofd_intent_args</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__dlm_8c.html#abda60744d497fcfe370cfd6b2d65c7ed">DEBUG_SUBSYSTEM</a>&nbsp;&nbsp;&nbsp;S_FILTER</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="interval__tree_8h.html#afed43ecf13ee5bd9e84e3cd11f5cfe63">interval_iter</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__dlm_8c.html#af010653269e611234496bc55d79c1f77">ofd_intent_cb</a> (struct <a class="el" href="structinterval__node.html">interval_node</a> *n, void *args)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">OFD interval callback.  <a href="#af010653269e611234496bc55d79c1f77"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ofd__dlm_8c.html#abe0aad5ebcdfc374de558116d45cbff1">ofd_intent_policy</a> (struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *ns, struct <a class="el" href="structldlm__lock.html">ldlm_lock</a> **lockp, void *req_cookie, enum <a class="el" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a> <a class="el" href="mdsrate_8c.html#a000e34997df38c2005a83d63e67d9282">mode</a>, <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a> flags, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">OFD lock intent policy.  <a href="#abe0aad5ebcdfc374de558116d45cbff1"></a><br/></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="abda60744d497fcfe370cfd6b2d65c7ed"></a><!-- doxytag: member="ofd_dlm.c::DEBUG_SUBSYSTEM" ref="abda60744d497fcfe370cfd6b2d65c7ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_SUBSYSTEM&nbsp;&nbsp;&nbsp;S_FILTER</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ofd__dlm_8c_source.html#l00043">43</a> of file <a class="el" href="ofd__dlm_8c_source.html">ofd_dlm.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="af010653269e611234496bc55d79c1f77"></a><!-- doxytag: member="ofd_dlm.c::ofd_intent_cb" ref="af010653269e611234496bc55d79c1f77" args="(struct interval_node *n, void *args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="interval__tree_8h.html#afed43ecf13ee5bd9e84e3cd11f5cfe63">interval_iter</a> ofd_intent_cb </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structinterval__node.html">interval_node</a> *&nbsp;</td>
          <td class="paramname"> <em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>args</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>OFD interval callback. </p>
<p>The interval_callback_t is part of <a class="el" href="interval__tree_8h.html#ac3a69dd3c8791aba12b8d69a753e3709">interval_iterate_reverse()</a> and is called for each interval in tree. The OFD interval callback searches for locks covering extents beyond the given args-&gt;size. This is used to decide if LVB data is outdated.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>n</em>&nbsp;</td><td>interval node </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>args</em>&nbsp;</td><td>intent arguments</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>INTERVAL_ITER_STOP</em>&nbsp;</td><td>if the interval is lower than file size, caller stops execution </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>INTERVAL_ITER_CONT</em>&nbsp;</td><td>if callback finished successfully and caller may continue execution </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__dlm_8c_source.html#l00069">69</a> of file <a class="el" href="ofd__dlm_8c_source.html">ofd_dlm.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="lustre__export_8h_source.html#l00245">obd_export::exp_libclient</a>, <a class="el" href="interval__tree_8h_source.html#l00075">interval_high()</a>, <a class="el" href="interval__tree_8h_source.html#l00061">INTERVAL_ITER_CONT</a>, <a class="el" href="interval__tree_8h_source.html#l00062">INTERVAL_ITER_STOP</a>, <a class="el" href="lustre__dlm_8h_source.html#l00754">ldlm_lock::l_export</a>, <a class="el" href="lustre__dlm_8h_source.html#l00633">ldlm_policy_data::l_extent</a>, <a class="el" href="lustre__dlm_8h_source.html#l00772">ldlm_lock::l_policy_data</a>, <a class="el" href="lustre__dlm_8h_source.html#l00882">ldlm_lock::l_sl_policy</a>, <a class="el" href="lustre__dlm_8h_source.html#l01344">LDLM_LOCK_GET</a>, <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>, <a class="el" href="lustre__dlm_8h_source.html#l00593">ldlm_interval::li_group</a>, <a class="el" href="ofd__dlm_8c_source.html#l00050">ofd_intent_args::liblustre</a>, <a class="el" href="list_8h_source.html#l00459">list_for_each_entry</a>, <a class="el" href="ofd__dlm_8c_source.html#l00049">ofd_intent_args::size</a>, <a class="el" href="cascading__rw_8c_source.html#l00061">size</a>, <a class="el" href="lustre__idl_8h_source.html#l02822">ldlm_extent::start</a>, and <a class="el" href="ofd__dlm_8c_source.html#l00048">ofd_intent_args::victim</a>.</p>

<p>Referenced by <a class="el" href="ofd__dlm_8c_source.html#l00129">ofd_intent_policy()</a>.</p>

</div>
</div>
<a class="anchor" id="abe0aad5ebcdfc374de558116d45cbff1"></a><!-- doxytag: member="ofd_dlm.c::ofd_intent_policy" ref="abe0aad5ebcdfc374de558116d45cbff1" args="(struct ldlm_namespace *ns, struct ldlm_lock **lockp, void *req_cookie, enum ldlm_mode mode, __u64 flags, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ofd_intent_policy </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *&nbsp;</td>
          <td class="paramname"> <em>ns</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structldlm__lock.html">ldlm_lock</a> **&nbsp;</td>
          <td class="paramname"> <em>lockp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>req_cookie</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__lustreidl.html#ga78e7c1d7ad283002413a597e75aa7441">ldlm_mode</a>&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>OFD lock intent policy. </p>
<p>This defines <a class="el" href="structldlm__namespace.html#a926bc3bad4997f595bdde4644119dac2" title="&quot;policy&quot; function that does actual lock conflict determination">ldlm_namespace::ns_policy</a> interface for OFD. Intent policy is called when lock has an intent, for OFD that means glimpse lock and policy fills Lock Value Block (LVB).</p>
<p>If already granted lock is found it will be placed in <em>lockp</em> and returned back to caller function.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>ns</em>&nbsp;</td><td>namespace </td></tr>
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>lockp</em>&nbsp;</td><td>pointer to the lock </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>req_cookie</em>&nbsp;</td><td>incoming request </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>mode</em>&nbsp;</td><td>LDLM mode </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>flags</em>&nbsp;</td><td>LDLM flags </td></tr>
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>data</em>&nbsp;</td><td>opaque data, not used in OFD policy</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ELDLM_LOCK_REPLACED</em>&nbsp;</td><td>if already granted lock was found and placed in <em>lockp</em> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ELDLM_LOCK_ABORTED</em>&nbsp;</td><td>in other cases except error </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>negative</em>&nbsp;</td><td>value on error </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="ofd__dlm_8c_source.html#l00129">129</a> of file <a class="el" href="ofd__dlm_8c_source.html">ofd_dlm.c</a>.</p>

<p>References <a class="el" href="uapi__kernelcomm_8h.html#adc2adfee3162ec44eb82da5f869a806c">__u64</a>, <a class="el" href="lustre__dlm_8h_source.html#l01556">check_res_locked()</a>, <a class="el" href="lustre__idl_8h_source.html#l01140">DLM_LOCKREPLY_OFF</a>, <a class="el" href="lustre__idl_8h_source.html#l01141">DLM_REPLY_REC_OFF</a>, <a class="el" href="lustre__dlm_8h_source.html#l00078">ELDLM_LOCK_ABORTED</a>, <a class="el" href="lustre__dlm_8h_source.html#l00079">ELDLM_LOCK_REPLACED</a>, <a class="el" href="flock_8c_source.html#l00061">ENTRY</a>, <a class="el" href="lustre__export_8h_source.html#l00245">obd_export::exp_libclient</a>, <a class="el" href="lustre__dlm_8h_source.html#l00583">ldlm_glimpse_work::gl_desc</a>, <a class="el" href="lustre__dlm_8h_source.html#l00582">ldlm_glimpse_work::gl_flags</a>, <a class="el" href="lustre__dlm_8h_source.html#l00581">ldlm_glimpse_work::gl_list</a>, <a class="el" href="lustre__dlm_8h_source.html#l00580">ldlm_glimpse_work::gl_lock</a>, <a class="el" href="list_8h_source.html#l00048">INIT_LIST_HEAD</a>, <a class="el" href="interval__tree_8c_source.html#l00207">interval_iterate_reverse()</a>, <a class="el" href="lustre__dlm_8h_source.html#l00754">ldlm_lock::l_export</a>, <a class="el" href="lustre__dlm_8h_source.html#l00812">ldlm_lock::l_lvb_type</a>, <a class="el" href="lustre__dlm_8h_source.html#l00694">ldlm_lock::l_resource</a>, <a class="el" href="utils_2wirehdr_8c_source.html#l00044">LASSERT</a>, <a class="el" href="lustre__idl_8h_source.html#l02809">LCK_MODE_NUM</a>, <a class="el" href="packet-lustre_8c_source.html#l00293">LCK_PR</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00108">LDLM_FL_BLOCK_NOWAIT</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00355">LDLM_FL_RESENT</a>, <a class="el" href="lustre__dlm_8h_source.html#l00588">LDLM_GL_WORK_NOFREE</a>, <a class="el" href="lustre__dlm_8h_source.html#l01180">LDLM_ITER_CONTINUE</a>, <a class="el" href="lustre__dlm_8h_source.html#l01344">LDLM_LOCK_GET</a>, <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>, <a class="el" href="lustre__dlm_8h_source.html#l01296">ldlm_res_lvbo_update()</a>, <a class="el" href="lustre__dlm_8h_source.html#l01000">ldlm_res_to_ns()</a>, <a class="el" href="ldlm__resource_8c_source.html#l01366">ldlm_resource_unlink_lock()</a>, <a class="el" href="ofd__dlm_8c_source.html#l00050">ofd_intent_args::liblustre</a>, <a class="el" href="list_8h_source.html#l00090">list_add_tail()</a>, <a class="el" href="list_8h_source.html#l00161">list_empty()</a>, <a class="el" href="lustre__dlm_8h_source.html#l00607">ldlm_interval_tree::lit_mode</a>, <a class="el" href="lustre__dlm_8h_source.html#l00608">ldlm_interval_tree::lit_root</a>, <a class="el" href="lustre__idl_8h_source.html#l02929">ldlm_reply::lock_policy_res1</a>, <a class="el" href="lustre__dlm_8h_source.html#l01537">lock_res()</a>, <a class="el" href="lustre__dlm_8h_source.html#l00956">ldlm_resource::lr_itree</a>, <a class="el" href="lustre__dlm_8h_source.html#l00979">ldlm_resource::lr_lvb_data</a>, <a class="el" href="pack__generic_8c_source.html#l00436">lustre_msg_buf()</a>, <a class="el" href="pack__generic_8c_source.html#l00401">lustre_pack_reply()</a>, <a class="el" href="lustre__idl_8h_source.html#l01816">ost_lvb::lvb_size</a>, <a class="el" href="lustre__dlm_8h_source.html#l00647">LVB_T_OST</a>, <a class="el" href="lustre__idl_8h_source.html#l01125">MSG_PTLRPC_BODY_OFF</a>, <a class="el" href="obd__support_8h_source.html#l00619">OBD_FAIL_CHECK</a>, <a class="el" href="obd__support_8h_source.html#l00354">OBD_FAIL_LDLM_AGL_DELAY</a>, <a class="el" href="obd__support_8h_source.html#l00355">OBD_FAIL_LDLM_AGL_NOLOCK</a>, <a class="el" href="obd__support_8h_source.html#l00343">OBD_FAIL_LDLM_GLIMPSE</a>, <a class="el" href="obd__support_8h_source.html#l00624">OBD_FAIL_TIMEOUT</a>, <a class="el" href="ofd__dlm_8c_source.html#l00069">ofd_intent_cb()</a>, <a class="el" href="lustre__idl_8h_source.html#l01092">ptlrpc_body</a>, <a class="el" href="lustre__net_8h_source.html#l02395">ptlrpc_status_hton()</a>, <a class="el" href="libcfs__debug_8h_source.html#l00352">RETURN</a>, <a class="el" href="lustre__net_8h_source.html#l01032">ptlrpc_request::rq_repmsg</a>, <a class="el" href="lustre__net_8h_source.html#l00957">ptlrpc_request::rq_status</a>, <a class="el" href="ofd__dlm_8c_source.html#l00049">ofd_intent_args::size</a>, <a class="el" href="lustre__dlm_8h_source.html#l01550">unlock_res()</a>, and <a class="el" href="ofd__dlm_8c_source.html#l00048">ofd_intent_args::victim</a>.</p>

<p>Referenced by <a class="el" href="ofd__dev_8c_source.html#l02814">ofd_init0()</a>.</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:54:49 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
