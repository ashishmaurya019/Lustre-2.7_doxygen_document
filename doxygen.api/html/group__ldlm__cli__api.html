<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: API to operate on locks from actual LDLM users.</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>API to operate on locks from actual LDLM users.<br/>
<small>
[<a class="el" href="group__LDLM.html">Lustre Distributed Lock Manager</a>]</small>
</h1>
<p>These are typically used by client and server (*_local versions) to obtain and release locks.  
<a href="#_details">More...</a></p>

<p><div class="dynheader">
Collaboration diagram for API to operate on locks from actual LDLM users.:</div>
<div class="dynsection">
<center><table><tr><td><img src="group__ldlm__cli__api.png" border="0" alt="" usemap="#group____ldlm____cli____api_map"/>
<map name="group____ldlm____cli____api_map" id="group____ldlm____cli____api">
<area shape="rect" id="node1" href="group__LDLM.html" title="Lustre DLM is based on VAX DLM." alt="" coords="5,5,248,35"/></map></td></tr></table></center>
</div>
</p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#gac3edcad1b11e283d6ef8455a2b598b07">ldlm_cli_enqueue</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> **reqp, struct <a class="el" href="structldlm__enqueue__info.html">ldlm_enqueue_info</a> *einfo, const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *res_id, union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> const *policy, __u64 *flags, void *lvb, __u32 lvb_len, enum lvb_type lvb_type, struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh, int async)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Client-side lock enqueue.  <a href="#gac3edcad1b11e283d6ef8455a2b598b07"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga9fe4c63a5cd0fe654e29fd11aea415cc"></a><!-- doxytag: member="ldlm_cli_api::ldlm_prep_enqueue_req" ref="ga9fe4c63a5cd0fe654e29fd11aea415cc" args="(struct obd_export *exp, struct ptlrpc_request *req, struct list_head *cancels, int count)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><b>ldlm_prep_enqueue_req</b> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, struct <a class="el" href="structlist__head.html">list_head</a> *cancels, int count)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#gabae59a7ebeed8c6fd60b22f03cf88e1f">ldlm_prep_elc_req</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, int version, int opc, int canceloff, struct <a class="el" href="structlist__head.html">list_head</a> *cancels, int count)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cancel LRU locks and pack them into the enqueue request.  <a href="#gabae59a7ebeed8c6fd60b22f03cf88e1f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga4bde4e4e32bab2c971297a5f065dec66"></a><!-- doxytag: member="ldlm_cli_api::ldlm_enqueue_pack" ref="ga4bde4e4e32bab2c971297a5f065dec66" args="(struct obd_export *exp, int lvb_len)" -->
struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><b>ldlm_enqueue_pack</b> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, int lvb_len)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gab2f8268913fc19a29b9d39248d3cbf0d"></a><!-- doxytag: member="ldlm_cli_api::ldlm_handle_enqueue0" ref="gab2f8268913fc19a29b9d39248d3cbf0d" args="(struct ldlm_namespace *ns, struct ptlrpc_request *req, const struct ldlm_request *dlm_req, const struct ldlm_callback_suite *cbs)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><b>ldlm_handle_enqueue0</b> (struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *ns, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, const struct <a class="el" href="structldlm__request.html">ldlm_request</a> *dlm_req, const struct <a class="el" href="structldlm__callback__suite.html">ldlm_callback_suite</a> *cbs)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#gac421005283912bb5186b035013aa58c0">ldlm_cli_enqueue_fini</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, enum ldlm_type type, __u8 with_policy, enum ldlm_mode mode, __u64 *flags, void *lvb, __u32 lvb_len, const struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh, int rc)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Finishing portion of client lock enqueue code.  <a href="#gac421005283912bb5186b035013aa58c0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga1fc673f7fb2c06baaa796f09afc33487"></a><!-- doxytag: member="ldlm_cli_api::ldlm_cli_enqueue_local" ref="ga1fc673f7fb2c06baaa796f09afc33487" args="(struct ldlm_namespace *ns, const struct ldlm_res_id *res_id, enum ldlm_type type, union ldlm_policy_data *policy, enum ldlm_mode mode, __u64 *flags, ldlm_blocking_callback blocking, ldlm_completion_callback completion, ldlm_glimpse_callback glimpse, void *data, __u32 lvb_len, enum lvb_type lvb_type, const __u64 *client_cookie, struct lustre_handle *lockh)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga1fc673f7fb2c06baaa796f09afc33487">ldlm_cli_enqueue_local</a> (struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *ns, const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *res_id, enum ldlm_type type, union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy, enum ldlm_mode mode, __u64 *flags, <a class="el" href="group__LDLM.html#gac111233b56bdf7a4767dcd7a2f15b378">ldlm_blocking_callback</a> blocking, <a class="el" href="group__LDLM.html#gac03b996dc38f767ddd9b2f5ae779b257">ldlm_completion_callback</a> completion, <a class="el" href="group__LDLM.html#ga6e5c291246d5e6fb302d99a6111cb03d">ldlm_glimpse_callback</a> glimpse, void *data, __u32 lvb_len, enum lvb_type lvb_type, const __u64 *client_cookie, struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Enqueue a local lock (typically on a server). <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga2a5622167fd1e1543cef0addb8634f09"></a><!-- doxytag: member="ldlm_cli_api::ldlm_cli_convert" ref="ga2a5622167fd1e1543cef0addb8634f09" args="(const struct lustre_handle *lockh, int new_mode, __u32 *flags)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><b>ldlm_cli_convert</b> (const struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh, int new_mode, __u32 *flags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga83cbdc7f471f1c21e1200fb94d5be170"></a><!-- doxytag: member="ldlm_cli_api::ldlm_cli_update_pool" ref="ga83cbdc7f471f1c21e1200fb94d5be170" args="(struct ptlrpc_request *req)" -->
int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga83cbdc7f471f1c21e1200fb94d5be170">ldlm_cli_update_pool</a> (struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update client's OBD pool related fields with new SLV and Limit from <em>req</em>. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga0237477d402999ab81f2b2447fceebc9">ldlm_cli_cancel</a> (const struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *lockh, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> cancel_flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Client side lock cancel.  <a href="#ga0237477d402999ab81f2b2447fceebc9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a">ldlm_cli_cancel_unused</a> (struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *, const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> flags, void *opaque)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers.  <a href="#ga8067f82d5a14a84d1c103d2de469501a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66">ldlm_cli_cancel_unused_resource</a> (struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *ns, const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *res_id, union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy, enum ldlm_mode mode, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> flags, void *opaque)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cancel all locks on a resource that have 0 readers/writers.  <a href="#ga56914f0205e9d377eeceb78f8db71f66"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70">ldlm_cli_cancel_req</a> (struct <a class="el" href="structobd__export.html">obd_export</a> *exp, struct <a class="el" href="structlist__head.html">list_head</a> *head, int count, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepare and send a batched cancel RPC.  <a href="#ga677e9f9ff5fbe2174b139fe8c2b77b70"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253">ldlm_cancel_resource_local</a> (struct <a class="el" href="structldlm__resource.html">ldlm_resource</a> *res, struct <a class="el" href="structlist__head.html">list_head</a> *cancels, union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> *policy, enum ldlm_mode mode, __u64 lock_flags, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> cancel_flags, void *opaque)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find and cancel locally unused locks found on resource, matched to the given policy, mode.  <a href="#ga2fab73fddf169b2202e11527226f7253"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149">ldlm_cli_cancel_list_local</a> (struct <a class="el" href="structlist__head.html">list_head</a> *cancels, int count, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Locally cancel up to <em>count</em> locks in list <em>cancels</em>.  <a href="#gac7dcd18ff549bf7b777a067e1c374149"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872">ldlm_cli_cancel_list</a> (struct <a class="el" href="structlist__head.html">list_head</a> *head, int count, struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *req, enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a> flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cancel client-side locks from a list and send/prepare cancel RPCs to the server.  <a href="#ga96adcececc3c547888075de942fa1872"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>These are typically used by client and server (*_local versions) to obtain and release locks. </p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ga2fab73fddf169b2202e11527226f7253"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cancel_resource_local" ref="ga2fab73fddf169b2202e11527226f7253" args="(struct ldlm_resource *res, struct list_head *cancels, union ldlm_policy_data *policy, enum ldlm_mode mode, __u64 lock_flags, enum ldlm_cancel_flags cancel_flags, void *opaque)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cancel_resource_local </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structldlm__resource.html">ldlm_resource</a> *&nbsp;</td>
          <td class="paramname"> <em>res</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlist__head.html">list_head</a> *&nbsp;</td>
          <td class="paramname"> <em>cancels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> *&nbsp;</td>
          <td class="paramname"> <em>policy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum ldlm_mode&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u64&nbsp;</td>
          <td class="paramname"> <em>lock_flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>cancel_flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>opaque</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find and cancel locally unused locks found on resource, matched to the given policy, mode. </p>
<p>GET the found locks and add them into the <em>cancels</em> list. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01854">1854</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__dlm_8h_source.html#l00822">ldlm_lock::l_ast_data</a>, <a class="el" href="lustre__dlm_8h_source.html#l00865">ldlm_lock::l_bl_ast</a>, <a class="el" href="lustre__dlm_8h_source.html#l00778">ldlm_lock::l_flags</a>, <a class="el" href="lustre__dlm_8h_source.html#l00728">ldlm_lock::l_granted_mode</a>, <a class="el" href="lustre__dlm_8h_source.html#l00772">ldlm_lock::l_policy_data</a>, <a class="el" href="lustre__dlm_8h_source.html#l00784">ldlm_lock::l_readers</a>, <a class="el" href="lustre__dlm_8h_source.html#l00705">ldlm_lock::l_res_link</a>, <a class="el" href="lustre__dlm_8h_source.html#l00694">ldlm_lock::l_resource</a>, <a class="el" href="ldlm__request_8c_source.html#l01407">ldlm_cli_cancel_list_local()</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00203">LDLM_FL_CANCELING</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00173">LDLM_FL_CBPENDING</a>, <a class="el" href="lustre__dlm_8h_source.html#l00941">ldlm_resource::lr_granted</a>, and <a class="el" href="lustre__dlm_8h_source.html#l00970">ldlm_resource::lr_type</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l01971">ldlm_cli_cancel_unused_resource()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01860"></a>01860 {
<a name="l01861"></a>01861         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a> *lock;
<a name="l01862"></a>01862         <span class="keywordtype">int</span> count = 0;
<a name="l01863"></a>01863         ENTRY;
<a name="l01864"></a>01864 
<a name="l01865"></a>01865         lock_res(res);
<a name="l01866"></a>01866         list_for_each_entry(lock, &amp;res-&gt;<a class="code" href="structldlm__resource.html#aeb092453fc0c7d4db2ae7cd3dddd593a" title="protected by lr_lock">lr_granted</a>, <a class="code" href="structldlm__lock.html#a64ad5a636aec3f0825f1eea9df1a5734" title="Linkage to resource&amp;#39;s lock queues according to current lock state.">l_res_link</a>) {
<a name="l01867"></a>01867                 <span class="keywordflow">if</span> (opaque != NULL &amp;&amp; lock-&gt;<a class="code" href="structldlm__lock.html#acb54919a43db8f99a336c67e0988fdb8" title="Private storage for lock user.">l_ast_data</a> != opaque) {
<a name="l01868"></a>01868                         LDLM_ERROR(lock, <span class="stringliteral">&quot;data %p doesn&apos;t match opaque %p&quot;</span>,
<a name="l01869"></a>01869                                    lock-&gt;<a class="code" href="structldlm__lock.html#acb54919a43db8f99a336c67e0988fdb8" title="Private storage for lock user.">l_ast_data</a>, opaque);
<a name="l01870"></a>01870                         <span class="comment">//LBUG();</span>
<a name="l01871"></a>01871                         <span class="keywordflow">continue</span>;
<a name="l01872"></a>01872                 }
<a name="l01873"></a>01873 
<a name="l01874"></a>01874                 <span class="keywordflow">if</span> (lock-&gt;<a class="code" href="structldlm__lock.html#abb8a2696003a5ba2a21c2365ecc2d275" title="Lock r/w usage counters.">l_readers</a> || lock-&gt;l_writers)
<a name="l01875"></a>01875                         <span class="keywordflow">continue</span>;
<a name="l01876"></a>01876 
<a name="l01877"></a>01877                 <span class="comment">/* If somebody is already doing CANCEL, or blocking AST came,</span>
<a name="l01878"></a>01878 <span class="comment">                 * skip this lock. */</span>
<a name="l01879"></a>01879                 <span class="keywordflow">if</span> (ldlm_is_bl_ast(lock) || ldlm_is_canceling(lock))
<a name="l01880"></a>01880                         <span class="keywordflow">continue</span>;
<a name="l01881"></a>01881 
<a name="l01882"></a>01882                 <span class="keywordflow">if</span> (lockmode_compat(lock-&gt;<a class="code" href="structldlm__lock.html#a714ebd7977f069a111bf98aa7b202167" title="Granted mode, also protected by lr_lock.">l_granted_mode</a>, mode))
<a name="l01883"></a>01883                         <span class="keywordflow">continue</span>;
<a name="l01884"></a>01884 
<a name="l01885"></a>01885                 <span class="comment">/* If policy is given and this is IBITS lock, add to list only</span>
<a name="l01886"></a>01886 <span class="comment">                 * those locks that match by policy. */</span>
<a name="l01887"></a>01887                 <span class="keywordflow">if</span> (policy &amp;&amp; (lock-&gt;<a class="code" href="structldlm__lock.html#a41f4592eb59ed0c94d85e9fa67acfa6f" title="Pointer to actual resource this lock is in.">l_resource</a>-&gt;<a class="code" href="structldlm__resource.html#a49b3d8776d2a7ff57e963c988d1de5cf" title="Type of locks this resource can hold.">lr_type</a> == LDLM_IBITS) &amp;&amp;
<a name="l01888"></a>01888                     !(lock-&gt;<a class="code" href="structldlm__lock.html#a30dc0349b0b525d72e9a3a92ad19ff79" title="Representation of private data specific for a lock type.">l_policy_data</a>.l_inodebits.bits &amp;
<a name="l01889"></a>01889                       policy-&gt;l_inodebits.bits))
<a name="l01890"></a>01890                         <span class="keywordflow">continue</span>;
<a name="l01891"></a>01891 
<a name="l01892"></a>01892                 <span class="comment">/* See CBPENDING comment in ldlm_cancel_lru */</span>
<a name="l01893"></a>01893                 lock-&gt;<a class="code" href="structldlm__lock.html#a52cb4e433ee43b7326bfbb652c3d0598" title="Lock state flags.">l_flags</a> |= <a class="code" href="group__LDLM.html#ga3845b64e7040a6d03323e5289bd71adc" title="this lock is being destroyed">LDLM_FL_CBPENDING</a> | <a class="code" href="group__LDLM.html#ga2dfca50053d3cc6f54e5a980c4c76082" title="lock cancel has already been sent">LDLM_FL_CANCELING</a> |
<a name="l01894"></a>01894                                  lock_flags;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896                 LASSERT(list_empty(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>));
<a name="l01897"></a>01897                 list_add(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>, cancels);
<a name="l01898"></a>01898                 LDLM_LOCK_GET(lock);
<a name="l01899"></a>01899                 count++;
<a name="l01900"></a>01900         }
<a name="l01901"></a>01901         unlock_res(res);
<a name="l01902"></a>01902 
<a name="l01903"></a>01903         RETURN(<a class="code" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels.">ldlm_cli_cancel_list_local</a>(cancels, count, cancel_flags));
<a name="l01904"></a>01904 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_cgraph_map" id="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels." alt="" coords="257,411,441,440"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="492,337,639,367"/><area shape="rect" id="node82" href="group__LDLM.html#gadec8a773eb3b13c995cf35a4d013393b" title="Attempts to cancel LDLM lock lock that has no reader/writer references." alt="" coords="499,484,632,513"/><area shape="rect" id="node7" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="693,268,843,297"/><area shape="rect" id="node9" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="897,112,1100,141"/><area shape="rect" id="node11" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="925,241,1072,271"/><area shape="rect" id="node21" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1865,97,2012,127"/><area shape="rect" id="node61" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="920,295,1077,324"/><area shape="rect" id="node63" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="921,348,1076,377"/><area shape="rect" id="node65" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="920,401,1077,431"/><area shape="rect" id="node76" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="935,455,1063,484"/><area shape="rect" id="node78" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="908,5,1089,35"/><area shape="rect" id="node80" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="916,59,1081,88"/><area shape="rect" id="node13" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="1161,255,1289,284"/><area shape="rect" id="node15" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1853,569,2024,599"/><area shape="rect" id="node17" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="1151,361,1300,391"/><area shape="rect" id="node19" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1373,204,1523,233"/><area shape="rect" id="node23" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="1163,308,1288,337"/><area shape="rect" id="node25" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1379,308,1517,337"/><area shape="rect" id="node27" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1633,307,1740,336"/><area shape="rect" id="node42" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1853,463,2024,492"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1596,411,1777,440"/><area shape="rect" id="node29" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="2117,241,2243,271"/><area shape="rect" id="node31" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="2119,319,2241,348"/><area shape="rect" id="node33" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="2123,176,2237,205"/><area shape="rect" id="node35" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1861,201,2016,231"/><area shape="rect" id="node44" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1851,255,2027,284"/><area shape="rect" id="node46" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1845,409,2032,439"/><area shape="rect" id="node48" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="2100,409,2260,439"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1827,516,2051,545"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="2101,489,2259,519"/><area shape="rect" id="node58" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="2101,543,2259,572"/><area shape="rect" id="node67" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="1152,541,1299,571"/><area shape="rect" id="node69" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1376,568,1520,597"/><area shape="rect" id="node71" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1349,515,1547,544"/><area shape="rect" id="node73" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1604,567,1769,596"/><area shape="rect" id="node84" href="group__LDLM.html#ga0a466989372b56e3cde1edae472be066" title="Helper function to call blocking AST for LDLM lock lock in a &quot;cancelling&quot;..." alt="" coords="688,509,848,539"/><area shape="rect" id="node86" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="929,561,1068,591"/><area shape="rect" id="node88" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="921,508,1076,537"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_icgraph.png" border="0" usemap="#group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_icgraph_map" id="group__ldlm__cli__api_ga2fab73fddf169b2202e11527226f7253_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers." alt="" coords="256,5,499,35"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a" title="Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers..." alt="" coords="547,5,723,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga0237477d402999ab81f2b2447fceebc9"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel" ref="ga0237477d402999ab81f2b2447fceebc9" args="(const struct lustre_handle *lockh, enum ldlm_cancel_flags cancel_flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>lockh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>cancel_flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Client side lock cancel. </p>
<p>Lock must not have any readers or writers by this time. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01345">1345</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__dlm_8h_source.html#l00865">ldlm_lock::l_bl_ast</a>, <a class="el" href="lustre__dlm_8h_source.html#l00759">ldlm_lock::l_conn_export</a>, <a class="el" href="ldlm__request_8c_source.html#l01917">ldlm_cli_cancel_list()</a>, <a class="el" href="lustre__dlm_8h_source.html#l01122">LDLM_DEBUG_NOLOCK</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00191">LDLM_FL_LOCAL_ONLY</a>, <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>, <a class="el" href="l__lock_8c_source.html#l00051">lock_res_and_lock()</a>, and <a class="el" href="l__lock_8c_source.html#l00067">unlock_res_and_lock()</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l00315">ldlm_blocking_ast_nocheck()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01347"></a>01347 {
<a name="l01348"></a>01348         <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *exp;
<a name="l01349"></a>01349         <span class="keyword">enum</span> ldlm_lru_flags lru_flags;
<a name="l01350"></a>01350         <span class="keywordtype">int</span> avail, count = 1;
<a name="l01351"></a>01351         __u64 rc = 0;
<a name="l01352"></a>01352         <span class="keyword">struct </span><a class="code" href="structldlm__namespace.html" title="LDLM Namespace.">ldlm_namespace</a> *ns;
<a name="l01353"></a>01353         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a> *lock;
<a name="l01354"></a>01354         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> cancels = LIST_HEAD_INIT(cancels);
<a name="l01355"></a>01355         ENTRY;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357         lock = ldlm_handle2lock_long(lockh, 0);
<a name="l01358"></a>01358         <span class="keywordflow">if</span> (lock == NULL) {
<a name="l01359"></a>01359                 <a class="code" href="group__LDLM.html#gae27210c0d51e6f38e3b5f2ff08793f97" title="Just a fancy CDEBUG call with log level preset to LDLM_DEBUG.">LDLM_DEBUG_NOLOCK</a>(<span class="stringliteral">&quot;lock is already being destroyed&quot;</span>);
<a name="l01360"></a>01360                 RETURN(0);
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363         <a class="code" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource.">lock_res_and_lock</a>(lock);
<a name="l01364"></a>01364         <span class="comment">/* Lock is being canceled and the caller doesn&apos;t want to wait */</span>
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (ldlm_is_canceling(lock) &amp;&amp; (cancel_flags &amp; LCF_ASYNC)) {
<a name="l01366"></a>01366                 <a class="code" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock.">unlock_res_and_lock</a>(lock);
<a name="l01367"></a>01367                 <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l01368"></a>01368                 RETURN(0);
<a name="l01369"></a>01369         }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371         ldlm_set_canceling(lock);
<a name="l01372"></a>01372         <a class="code" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock.">unlock_res_and_lock</a>(lock);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         rc = ldlm_cli_cancel_local(lock);
<a name="l01375"></a>01375         <span class="keywordflow">if</span> (rc == <a class="code" href="group__LDLM.html#gaa938e2a5e2f72e996711b5c4ba8dd9fc" title="whatever it might mean -- never transmitted?">LDLM_FL_LOCAL_ONLY</a> || cancel_flags &amp; LCF_LOCAL) {
<a name="l01376"></a>01376                 <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l01377"></a>01377                 RETURN(0);
<a name="l01378"></a>01378         }
<a name="l01379"></a>01379         <span class="comment">/* Even if the lock is marked as LDLM_FL_BL_AST, this is a LDLM_CANCEL</span>
<a name="l01380"></a>01380 <span class="comment">         * RPC which goes to canceld portal, so we can cancel other LRU locks</span>
<a name="l01381"></a>01381 <span class="comment">         * here and send them all as one LDLM_CANCEL RPC. */</span>
<a name="l01382"></a>01382         LASSERT(list_empty(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>));
<a name="l01383"></a>01383         list_add(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>, &amp;cancels);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         exp = lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>;
<a name="l01386"></a>01386         <span class="keywordflow">if</span> (exp_connect_cancelset(exp)) {
<a name="l01387"></a>01387                 avail = ldlm_format_handles_avail(class_exp2cliimp(exp),
<a name="l01388"></a>01388                                                   &amp;RQF_LDLM_CANCEL,
<a name="l01389"></a>01389                                                   RCL_CLIENT, 0);
<a name="l01390"></a>01390                 LASSERT(avail &gt; 0);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392                 ns = ldlm_lock_to_ns(lock);
<a name="l01393"></a>01393                 lru_flags = ns_connect_lru_resize(ns) ?
<a name="l01394"></a>01394                         LDLM_LRU_FLAG_LRUR : LDLM_LRU_FLAG_AGED;
<a name="l01395"></a>01395                 count += ldlm_cancel_lru_local(ns, &amp;cancels, 0, avail - 1,
<a name="l01396"></a>01396                                                LCF_BL_AST, lru_flags);
<a name="l01397"></a>01397         }
<a name="l01398"></a>01398         <a class="code" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client-side locks from a list and send/prepare cancel RPCs to the server.">ldlm_cli_cancel_list</a>(&amp;cancels, count, NULL, cancel_flags);
<a name="l01399"></a>01399         RETURN(0);
<a name="l01400"></a>01400 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_cgraph_map" id="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="181,295,328,324"/><area shape="rect" id="node80" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="185,348,324,377"/><area shape="rect" id="node82" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="177,401,332,431"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="383,295,532,324"/><area shape="rect" id="node7" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="583,5,785,35"/><area shape="rect" id="node9" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="611,188,757,217"/><area shape="rect" id="node19" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1551,5,1697,35"/><area shape="rect" id="node59" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="605,241,763,271"/><area shape="rect" id="node61" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="607,295,761,324"/><area shape="rect" id="node63" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="605,348,763,377"/><area shape="rect" id="node74" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="620,401,748,431"/><area shape="rect" id="node76" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="593,455,775,484"/><area shape="rect" id="node78" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="601,508,767,537"/><area shape="rect" id="node11" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="847,161,975,191"/><area shape="rect" id="node13" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1539,477,1709,507"/><area shape="rect" id="node15" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="836,268,985,297"/><area shape="rect" id="node17" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1059,109,1208,139"/><area shape="rect" id="node21" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="848,215,973,244"/><area shape="rect" id="node23" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1064,215,1203,244"/><area shape="rect" id="node25" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1319,213,1425,243"/><area shape="rect" id="node40" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1539,371,1709,400"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1281,317,1463,347"/><area shape="rect" id="node27" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1803,227,1928,256"/><area shape="rect" id="node29" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1804,71,1927,100"/><area shape="rect" id="node31" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1808,149,1923,179"/><area shape="rect" id="node33" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1547,109,1701,139"/><area shape="rect" id="node42" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1536,213,1712,243"/><area shape="rect" id="node44" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1531,317,1717,347"/><area shape="rect" id="node46" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1785,317,1945,347"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1512,424,1736,453"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1787,397,1944,427"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1787,451,1944,480"/><area shape="rect" id="node65" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="837,448,984,477"/><area shape="rect" id="node67" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1061,421,1205,451"/><area shape="rect" id="node69" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1035,525,1232,555"/><area shape="rect" id="node71" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1289,499,1455,528"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_icgraph.png" border="0" usemap="#group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_icgraph_map" id="group__ldlm__cli__api_ga0237477d402999ab81f2b2447fceebc9_icgraph">
<area shape="rect" id="node3" href="group__ldlm__local__ast.html#ga9962ac0cc2bd7e279cf0b977d822feb3" title="A helper to build a blocking AST function." alt="" coords="177,29,377,59"/><area shape="rect" id="node5" href="group__ldlm__local__ast.html#gacc93548bb07532aa1d816dee71bd2ecb" title="Server blocking AST." alt="" coords="427,29,565,59"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga96adcececc3c547888075de942fa1872"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel_list" ref="ga96adcececc3c547888075de942fa1872" args="(struct list_head *head, int count, struct ptlrpc_request *req, enum ldlm_cancel_flags flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel_list </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlist__head.html">list_head</a> *&nbsp;</td>
          <td class="paramname"> <em>cancels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cancel client-side locks from a list and send/prepare cancel RPCs to the server. </p>
<p>If <em>req</em> is NULL, send CANCEL request to server with handles of locks in the <em>cancels</em>. If EARLY_CANCEL is not supported, send CANCEL requests separately per lock. If <em>req</em> is not NULL, put handles of locks in <em>cancels</em> into the request buffer at the offset <em>off</em>. Destroy <em>cancels</em> at the end. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01917">1917</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__dlm_8h_source.html#l00865">ldlm_lock::l_bl_ast</a>, <a class="el" href="lustre__dlm_8h_source.html#l00759">ldlm_lock::l_conn_export</a>, and <a class="el" href="ldlm__request_8c_source.html#l01185">ldlm_cli_cancel_req()</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l01345">ldlm_cli_cancel()</a>, <a class="el" href="ldlm__request_8c_source.html#l01407">ldlm_cli_cancel_list_local()</a>, <a class="el" href="ldlm__request_8c_source.html#l01971">ldlm_cli_cancel_unused_resource()</a>, and <a class="el" href="ldlm__request_8c_source.html#l00762">ldlm_prep_elc_req()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01920"></a>01920 {
<a name="l01921"></a>01921         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a> *lock;
<a name="l01922"></a>01922         <span class="keywordtype">int</span> res = 0;
<a name="l01923"></a>01923         ENTRY;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925         <span class="keywordflow">if</span> (list_empty(cancels) || count == 0)
<a name="l01926"></a>01926                 RETURN(0);
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         <span class="comment">/* XXX: requests (both batched and not) could be sent in parallel.</span>
<a name="l01929"></a>01929 <span class="comment">         * Usually it is enough to have just 1 RPC, but it is possible that</span>
<a name="l01930"></a>01930 <span class="comment">         * there are too many locks to be cancelled in LRU or on a resource.</span>
<a name="l01931"></a>01931 <span class="comment">         * It would also speed up the case when the server does not support</span>
<a name="l01932"></a>01932 <span class="comment">         * the feature. */</span>
<a name="l01933"></a>01933         <span class="keywordflow">while</span> (count &gt; 0) {
<a name="l01934"></a>01934                 LASSERT(!list_empty(cancels));
<a name="l01935"></a>01935                 lock = list_entry(cancels-&gt;next, <span class="keyword">struct</span> <a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a>,
<a name="l01936"></a>01936                                       <a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>);
<a name="l01937"></a>01937                 LASSERT(lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>);
<a name="l01938"></a>01938 
<a name="l01939"></a>01939                 <span class="keywordflow">if</span> (exp_connect_cancelset(lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>)) {
<a name="l01940"></a>01940                         res = count;
<a name="l01941"></a>01941                         <span class="keywordflow">if</span> (req)
<a name="l01942"></a>01942                                 ldlm_cancel_pack(req, cancels, count);
<a name="l01943"></a>01943                         <span class="keywordflow">else</span>
<a name="l01944"></a>01944                                 res = <a class="code" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC.">ldlm_cli_cancel_req</a>(lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>,
<a name="l01945"></a>01945                                                           cancels, count,
<a name="l01946"></a>01946                                                           flags);
<a name="l01947"></a>01947                 } <span class="keywordflow">else</span> {
<a name="l01948"></a>01948                         res = <a class="code" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC.">ldlm_cli_cancel_req</a>(lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>,
<a name="l01949"></a>01949                                                   cancels, 1, flags);
<a name="l01950"></a>01950                 }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952                 <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01953"></a>01953                         CDEBUG_LIMIT(res == -ESHUTDOWN ? D_DLMTRACE : D_ERROR,
<a name="l01954"></a>01954                                      <span class="stringliteral">&quot;ldlm_cli_cancel_list: %d\n&quot;</span>, res);
<a name="l01955"></a>01955                         res = count;
<a name="l01956"></a>01956                 }
<a name="l01957"></a>01957 
<a name="l01958"></a>01958                 count -= res;
<a name="l01959"></a>01959                 ldlm_lock_list_put(cancels, <a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>, res);
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961         LASSERT(count == 0);
<a name="l01962"></a>01962         RETURN(0);
<a name="l01963"></a>01963 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_cgraph_map" id="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="204,295,353,324"/><area shape="rect" id="node5" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="404,5,607,35"/><area shape="rect" id="node7" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="432,188,579,217"/><area shape="rect" id="node17" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1372,5,1519,35"/><area shape="rect" id="node57" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="427,241,584,271"/><area shape="rect" id="node59" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="428,295,583,324"/><area shape="rect" id="node61" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="427,348,584,377"/><area shape="rect" id="node72" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="441,401,569,431"/><area shape="rect" id="node74" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="415,455,596,484"/><area shape="rect" id="node76" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="423,508,588,537"/><area shape="rect" id="node9" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="668,161,796,191"/><area shape="rect" id="node11" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1360,477,1531,507"/><area shape="rect" id="node13" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="657,268,807,297"/><area shape="rect" id="node15" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="880,109,1029,139"/><area shape="rect" id="node19" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="669,215,795,244"/><area shape="rect" id="node21" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="885,215,1024,244"/><area shape="rect" id="node23" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1140,213,1247,243"/><area shape="rect" id="node38" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1360,371,1531,400"/><area shape="rect" id="node48" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1103,317,1284,347"/><area shape="rect" id="node25" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1624,227,1749,256"/><area shape="rect" id="node27" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1625,71,1748,100"/><area shape="rect" id="node29" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1629,149,1744,179"/><area shape="rect" id="node31" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1368,109,1523,139"/><area shape="rect" id="node40" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1357,213,1533,243"/><area shape="rect" id="node42" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1352,317,1539,347"/><area shape="rect" id="node44" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1607,317,1767,347"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1333,424,1557,453"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1608,397,1765,427"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1608,451,1765,480"/><area shape="rect" id="node63" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="659,448,805,477"/><area shape="rect" id="node65" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="883,421,1027,451"/><area shape="rect" id="node67" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="856,525,1053,555"/><area shape="rect" id="node69" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1111,499,1276,528"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_icgraph.png" border="0" usemap="#group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_icgraph_map" id="group__ldlm__cli__api_ga96adcececc3c547888075de942fa1872_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga0237477d402999ab81f2b2447fceebc9" title="Client side lock cancel." alt="" coords="236,29,356,59"/><area shape="rect" id="node10" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels." alt="" coords="204,83,388,112"/><area shape="rect" id="node14" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers." alt="" coords="688,108,931,137"/><area shape="rect" id="node19" href="group__ldlm__cli__api.html#gabae59a7ebeed8c6fd60b22f03cf88e1f" title="Cancel LRU locks and pack them into the enqueue request." alt="" coords="225,187,367,216"/><area shape="rect" id="node5" href="group__ldlm__local__ast.html#ga9962ac0cc2bd7e279cf0b977d822feb3" title="A helper to build a blocking AST function." alt="" coords="439,29,639,59"/><area shape="rect" id="node7" href="group__ldlm__local__ast.html#gacc93548bb07532aa1d816dee71bd2ecb" title="Server blocking AST." alt="" coords="740,29,879,59"/><area shape="rect" id="node12" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy..." alt="" coords="437,83,640,112"/><area shape="rect" id="node16" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a" title="Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers..." alt="" coords="979,108,1155,137"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="gac7dcd18ff549bf7b777a067e1c374149"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel_list_local" ref="gac7dcd18ff549bf7b777a067e1c374149" args="(struct list_head *cancels, int count, enum ldlm_cancel_flags flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel_list_local </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structlist__head.html">list_head</a> *&nbsp;</td>
          <td class="paramname"> <em>cancels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>cancel_flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Locally cancel up to <em>count</em> locks in list <em>cancels</em>. </p>
<p>Return the number of cancelled locks. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01407">1407</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__dlm_8h_source.html#l00865">ldlm_lock::l_bl_ast</a>, <a class="el" href="ldlm__request_8c_source.html#l01917">ldlm_cli_cancel_list()</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00270">LDLM_FL_BL_AST</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00191">LDLM_FL_LOCAL_ONLY</a>, <a class="el" href="ldlm__lock_8c_source.html#l02249">ldlm_lock_cancel()</a>, and <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l01854">ldlm_cancel_resource_local()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01409"></a>01409 {
<a name="l01410"></a>01410         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> head = LIST_HEAD_INIT(head);
<a name="l01411"></a>01411         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a> *lock, *next;
<a name="l01412"></a>01412         <span class="keywordtype">int</span> left = 0, bl_ast = 0;
<a name="l01413"></a>01413         __u64 rc;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415         left = count;
<a name="l01416"></a>01416         list_for_each_entry_safe(lock, next, cancels, <a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>) {
<a name="l01417"></a>01417                 <span class="keywordflow">if</span> (left-- == 0)
<a name="l01418"></a>01418                         <span class="keywordflow">break</span>;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420                 <span class="keywordflow">if</span> (cancel_flags &amp; LCF_LOCAL) {
<a name="l01421"></a>01421                         rc = <a class="code" href="group__LDLM.html#gaa938e2a5e2f72e996711b5c4ba8dd9fc" title="whatever it might mean -- never transmitted?">LDLM_FL_LOCAL_ONLY</a>;
<a name="l01422"></a>01422                         <a class="code" href="group__LDLM.html#gadec8a773eb3b13c995cf35a4d013393b" title="Attempts to cancel LDLM lock lock that has no reader/writer references.">ldlm_lock_cancel</a>(lock);
<a name="l01423"></a>01423                 } <span class="keywordflow">else</span> {
<a name="l01424"></a>01424                         rc = ldlm_cli_cancel_local(lock);
<a name="l01425"></a>01425                 }
<a name="l01426"></a>01426                 <span class="comment">/* Until we have compound requests and can send LDLM_CANCEL</span>
<a name="l01427"></a>01427 <span class="comment">                 * requests batched with generic RPCs, we need to send cancels</span>
<a name="l01428"></a>01428 <span class="comment">                 * with the LDLM_FL_BL_AST flag in a separate RPC from</span>
<a name="l01429"></a>01429 <span class="comment">                 * the one being generated now. */</span>
<a name="l01430"></a>01430                 <span class="keywordflow">if</span> (!(cancel_flags &amp; LCF_BL_AST) &amp;&amp; (rc == <a class="code" href="group__LDLM.html#ga043b49bb5e4be85bb6a3937bb241aab1" title="It may happen that a client initiates two operations, e.g.">LDLM_FL_BL_AST</a>)) {
<a name="l01431"></a>01431                         LDLM_DEBUG(lock, <span class="stringliteral">&quot;Cancel lock separately&quot;</span>);
<a name="l01432"></a>01432                         list_del_init(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>);
<a name="l01433"></a>01433                         list_add(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>, &amp;head);
<a name="l01434"></a>01434                         bl_ast++;
<a name="l01435"></a>01435                         <span class="keywordflow">continue</span>;
<a name="l01436"></a>01436                 }
<a name="l01437"></a>01437                 <span class="keywordflow">if</span> (rc == <a class="code" href="group__LDLM.html#gaa938e2a5e2f72e996711b5c4ba8dd9fc" title="whatever it might mean -- never transmitted?">LDLM_FL_LOCAL_ONLY</a>) {
<a name="l01438"></a>01438                         <span class="comment">/* CANCEL RPC should not be sent to server. */</span>
<a name="l01439"></a>01439                         list_del_init(&amp;lock-&gt;<a class="code" href="structldlm__lock.html#a21d60a379e0f50f97d14bde7dada4fb2" title="List item ldlm_add_ast_work_item() for case of blocking ASTs.">l_bl_ast</a>);
<a name="l01440"></a>01440                         <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l01441"></a>01441                         count--;
<a name="l01442"></a>01442                 }
<a name="l01443"></a>01443         }
<a name="l01444"></a>01444         <span class="keywordflow">if</span> (bl_ast &gt; 0) {
<a name="l01445"></a>01445                 count -= bl_ast;
<a name="l01446"></a>01446                 <a class="code" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client-side locks from a list and send/prepare cancel RPCs to the server.">ldlm_cli_cancel_list</a>(&amp;head, bl_ast, NULL, 0);
<a name="l01447"></a>01447         }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449         RETURN(count);
<a name="l01450"></a>01450 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_cgraph.png" border="0" usemap="#group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_cgraph_map" id="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="241,337,388,367"/><area shape="rect" id="node80" href="group__LDLM.html#gadec8a773eb3b13c995cf35a4d013393b" title="Attempts to cancel LDLM lock lock that has no reader/writer references." alt="" coords="248,484,381,513"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="443,268,592,297"/><area shape="rect" id="node7" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="647,112,849,141"/><area shape="rect" id="node9" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="675,241,821,271"/><area shape="rect" id="node19" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1615,97,1761,127"/><area shape="rect" id="node59" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="669,295,827,324"/><area shape="rect" id="node61" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="671,348,825,377"/><area shape="rect" id="node63" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="669,401,827,431"/><area shape="rect" id="node74" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="684,455,812,484"/><area shape="rect" id="node76" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="657,5,839,35"/><area shape="rect" id="node78" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="665,59,831,88"/><area shape="rect" id="node11" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="911,255,1039,284"/><area shape="rect" id="node13" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1603,569,1773,599"/><area shape="rect" id="node15" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="900,361,1049,391"/><area shape="rect" id="node17" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1123,204,1272,233"/><area shape="rect" id="node21" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="912,308,1037,337"/><area shape="rect" id="node23" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1128,308,1267,337"/><area shape="rect" id="node25" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1383,307,1489,336"/><area shape="rect" id="node40" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1603,463,1773,492"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1345,411,1527,440"/><area shape="rect" id="node27" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1867,241,1992,271"/><area shape="rect" id="node29" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1868,319,1991,348"/><area shape="rect" id="node31" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1872,176,1987,205"/><area shape="rect" id="node33" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1611,201,1765,231"/><area shape="rect" id="node42" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1600,255,1776,284"/><area shape="rect" id="node44" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1595,409,1781,439"/><area shape="rect" id="node46" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1849,409,2009,439"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1576,516,1800,545"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1851,489,2008,519"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1851,543,2008,572"/><area shape="rect" id="node65" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="901,541,1048,571"/><area shape="rect" id="node67" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1125,568,1269,597"/><area shape="rect" id="node69" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1099,515,1296,544"/><area shape="rect" id="node71" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1353,567,1519,596"/><area shape="rect" id="node82" href="group__LDLM.html#ga0a466989372b56e3cde1edae472be066" title="Helper function to call blocking AST for LDLM lock lock in a &quot;cancelling&quot;..." alt="" coords="437,509,597,539"/><area shape="rect" id="node84" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="679,561,817,591"/><area shape="rect" id="node86" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="671,508,825,537"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_icgraph.png" border="0" usemap="#group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_icgraph_map" id="group__ldlm__cli__api_gac7dcd18ff549bf7b777a067e1c374149_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy..." alt="" coords="240,5,443,35"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers." alt="" coords="491,5,733,35"/><area shape="rect" id="node7" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a" title="Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers..." alt="" coords="781,5,957,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga677e9f9ff5fbe2174b139fe8c2b77b70"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel_req" ref="ga677e9f9ff5fbe2174b139fe8c2b77b70" args="(struct obd_export *exp, struct list_head *head, int count, enum ldlm_cancel_flags flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel_req </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlist__head.html">list_head</a> *&nbsp;</td>
          <td class="paramname"> <em>cancels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>count</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Prepare and send a batched cancel RPC. </p>
<p>It will include <em>count</em> lock handles of locks given in <em>cancels</em> list. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01185">1185</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__import_8h_source.html#l00237">obd_import::imp_generation</a>, <a class="el" href="lu__object_8h_source.html#l00287">lu_device::ld_obd</a>, <a class="el" href="lu__object_8h_source.html#l00283">lu_device::ld_site</a>, <a class="el" href="lu__object_8h_source.html#l00619">lu_site::ls_top_dev</a>, <a class="el" href="client_8c_source.html#l00293">ptlrpc_at_set_req_timeout()</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00852">ptlrpc_request_alloc()</a>, <a class="el" href="client_8c_source.html#l00875">ptlrpc_request_free()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="ptlrpcd_8c_source.html#l00268">ptlrpcd_add_req()</a>, <a class="el" href="layout_8c_source.html#l01833">req_capsule_filled_sizes()</a>, <a class="el" href="layout_8c_source.html#l02226">req_capsule_set_size()</a>, <a class="el" href="lustre__net_8h_source.html#l01104">ptlrpc_request::rq_import</a>, and <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l01917">ldlm_cli_cancel_list()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01187"></a>01187 {
<a name="l01188"></a>01188         <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req = NULL;
<a name="l01189"></a>01189         <span class="keyword">struct </span><a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> *imp;
<a name="l01190"></a>01190         <span class="keywordtype">int</span> free, sent = 0;
<a name="l01191"></a>01191         <span class="keywordtype">int</span> rc = 0;
<a name="l01192"></a>01192         ENTRY;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         LASSERT(exp != NULL);
<a name="l01195"></a>01195         LASSERT(count &gt; 0);
<a name="l01196"></a>01196 
<a name="l01197"></a>01197         CFS_FAIL_TIMEOUT(OBD_FAIL_LDLM_PAUSE_CANCEL, cfs_fail_val);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199         <span class="keywordflow">if</span> (CFS_FAIL_CHECK(OBD_FAIL_LDLM_CANCEL_RACE))
<a name="l01200"></a>01200                 RETURN(count);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202         free = ldlm_format_handles_avail(class_exp2cliimp(exp),
<a name="l01203"></a>01203                                          &amp;RQF_LDLM_CANCEL, RCL_CLIENT, 0);
<a name="l01204"></a>01204         <span class="keywordflow">if</span> (count &gt; free)
<a name="l01205"></a>01205                 count = free;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207         <span class="keywordflow">while</span> (1) {
<a name="l01208"></a>01208                 imp = class_exp2cliimp(exp);
<a name="l01209"></a>01209                 <span class="keywordflow">if</span> (imp == NULL || imp-&gt;imp_invalid) {
<a name="l01210"></a>01210                         CDEBUG(D_DLMTRACE,
<a name="l01211"></a>01211                                <span class="stringliteral">&quot;skipping cancel on invalid import %p\n&quot;</span>, imp);
<a name="l01212"></a>01212                         RETURN(count);
<a name="l01213"></a>01213                 }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215                 req = <a class="code" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure...">ptlrpc_request_alloc</a>(imp, &amp;RQF_LDLM_CANCEL);
<a name="l01216"></a>01216                 <span class="keywordflow">if</span> (req == NULL)
<a name="l01217"></a>01217                         GOTO(out, rc = -ENOMEM);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219                 <a class="code" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&amp;#39;t been filled in yet.">req_capsule_filled_sizes</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, RCL_CLIENT);
<a name="l01220"></a>01220                 <a class="code" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the...">req_capsule_set_size</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_REQ, RCL_CLIENT,
<a name="l01221"></a>01221                                      ldlm_request_bufsize(count, LDLM_CANCEL));
<a name="l01222"></a>01222 
<a name="l01223"></a>01223                 rc = <a class="code" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps...">ptlrpc_request_pack</a>(req, LUSTRE_DLM_VERSION, LDLM_CANCEL);
<a name="l01224"></a>01224                 <span class="keywordflow">if</span> (rc) {
<a name="l01225"></a>01225                         <a class="code" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure.">ptlrpc_request_free</a>(req);
<a name="l01226"></a>01226                         GOTO(out, rc);
<a name="l01227"></a>01227                 }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 <span class="comment">/* If OSP want cancel cross-MDT lock, let&apos;s not block it in</span>
<a name="l01230"></a>01230 <span class="comment">                 * in recovery, otherwise the lock will not released, if</span>
<a name="l01231"></a>01231 <span class="comment">                 * the remote target is also in recovery, and it also need</span>
<a name="l01232"></a>01232 <span class="comment">                 * this lock, it might cause deadlock. */</span>
<a name="l01233"></a>01233                 <span class="keywordflow">if</span> (exp_connect_flags(exp) &amp; OBD_CONNECT_MDS_MDS &amp;&amp;
<a name="l01234"></a>01234                     exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_lu_dev != NULL &amp;&amp;
<a name="l01235"></a>01235                     exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_lu_dev-&gt;<a class="code" href="structlu__device.html#aaa1ef1e1a330f307a9baf6e59fc9c39b" title="Stack this device belongs to.">ld_site</a> != NULL) {
<a name="l01236"></a>01236                         <span class="keyword">struct </span><a class="code" href="structlu__device.html" title="Device: a layer in the server side abstraction stacking.">lu_device</a> *top_dev;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238                         top_dev = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_lu_dev-&gt;<a class="code" href="structlu__device.html#aaa1ef1e1a330f307a9baf6e59fc9c39b" title="Stack this device belongs to.">ld_site</a>-&gt;<a class="code" href="structlu__site.html#a371ff1de170feccd1c80e3d7a0202965" title="Top-level device for this stack.">ls_top_dev</a>;
<a name="l01239"></a>01239                         <span class="keywordflow">if</span> (top_dev != NULL &amp;&amp;
<a name="l01240"></a>01240                             top_dev-&gt;<a class="code" href="structlu__device.html#af35351bd6a533fa48c8a0f0eda83172a">ld_obd</a>-&gt;obd_recovering)
<a name="l01241"></a>01241                                 req-&gt;rq_allow_replay = 1;
<a name="l01242"></a>01242                 }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244                 req-&gt;rq_request_portal = LDLM_CANCEL_REQUEST_PORTAL;
<a name="l01245"></a>01245                 req-&gt;rq_reply_portal = LDLM_CANCEL_REPLY_PORTAL;
<a name="l01246"></a>01246                 <a class="code" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e.">ptlrpc_at_set_req_timeout</a>(req);
<a name="l01247"></a>01247 
<a name="l01248"></a>01248                 ldlm_cancel_pack(req, cancels, count);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250                 ptlrpc_request_set_replen(req);
<a name="l01251"></a>01251                 <span class="keywordflow">if</span> (flags &amp; LCF_ASYNC) {
<a name="l01252"></a>01252                         <a class="code" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check-&amp;gt;ptlrpc_check_set()...">ptlrpcd_add_req</a>(req);
<a name="l01253"></a>01253                         sent = count;
<a name="l01254"></a>01254                         GOTO(out, 0);
<a name="l01255"></a>01255                 }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257                 rc = <a class="code" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes.">ptlrpc_queue_wait</a>(req);
<a name="l01258"></a>01258                 <span class="keywordflow">if</span> (rc == LUSTRE_ESTALE) {
<a name="l01259"></a>01259                         CDEBUG(D_DLMTRACE, <span class="stringliteral">&quot;client/server (nid %s) &quot;</span>
<a name="l01260"></a>01260                                <span class="stringliteral">&quot;out of sync -- not fatal\n&quot;</span>,
<a name="l01261"></a>01261                                libcfs_nid2str(req-&gt;<a class="code" href="structptlrpc__request.html#abce7bb8e7fff373286d1f69a0175dba8" title="import where request is being sent">rq_import</a>-&gt;
<a name="l01262"></a>01262                                               imp_connection-&gt;c_peer.nid));
<a name="l01263"></a>01263                         rc = 0;
<a name="l01264"></a>01264                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == -ETIMEDOUT &amp;&amp; <span class="comment">/* check there was no reconnect*/</span>
<a name="l01265"></a>01265                            req-&gt;rq_import_generation == imp-&gt;<a class="code" href="structobd__import.html#a37ffba6837dd8612475a9ea4d5bb939c" title="Current import generation.">imp_generation</a>) {
<a name="l01266"></a>01266                         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(req);
<a name="l01267"></a>01267                         <span class="keywordflow">continue</span>;
<a name="l01268"></a>01268                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != ELDLM_OK) {
<a name="l01269"></a>01269                         <span class="comment">/* -ESHUTDOWN is common on umount */</span>
<a name="l01270"></a>01270                         CDEBUG_LIMIT(rc == -ESHUTDOWN ? D_DLMTRACE : D_ERROR,
<a name="l01271"></a>01271                                      <span class="stringliteral">&quot;Got rc %d from cancel RPC: &quot;</span>
<a name="l01272"></a>01272                                      <span class="stringliteral">&quot;canceling anyway\n&quot;</span>, rc);
<a name="l01273"></a>01273                         <span class="keywordflow">break</span>;
<a name="l01274"></a>01274                 }
<a name="l01275"></a>01275                 sent = count;
<a name="l01276"></a>01276                 <span class="keywordflow">break</span>;
<a name="l01277"></a>01277         }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279         <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(req);
<a name="l01280"></a>01280         EXIT;
<a name="l01281"></a>01281 out:
<a name="l01282"></a>01282         <span class="keywordflow">return</span> sent ? sent : rc;
<a name="l01283"></a>01283 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_cgraph_map" id="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_cgraph">
<area shape="rect" id="node3" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="207,5,409,35"/><area shape="rect" id="node5" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="235,188,381,217"/><area shape="rect" id="node15" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1175,5,1321,35"/><area shape="rect" id="node55" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="229,241,387,271"/><area shape="rect" id="node57" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="231,295,385,324"/><area shape="rect" id="node59" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="229,348,387,377"/><area shape="rect" id="node70" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="244,401,372,431"/><area shape="rect" id="node72" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="217,455,399,484"/><area shape="rect" id="node74" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="225,508,391,537"/><area shape="rect" id="node7" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="471,161,599,191"/><area shape="rect" id="node9" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1163,477,1333,507"/><area shape="rect" id="node11" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="460,268,609,297"/><area shape="rect" id="node13" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="683,109,832,139"/><area shape="rect" id="node17" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="472,215,597,244"/><area shape="rect" id="node19" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="688,215,827,244"/><area shape="rect" id="node21" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="943,213,1049,243"/><area shape="rect" id="node36" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1163,371,1333,400"/><area shape="rect" id="node46" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="905,317,1087,347"/><area shape="rect" id="node23" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1427,227,1552,256"/><area shape="rect" id="node25" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1428,71,1551,100"/><area shape="rect" id="node27" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1432,149,1547,179"/><area shape="rect" id="node29" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1171,109,1325,139"/><area shape="rect" id="node38" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1160,213,1336,243"/><area shape="rect" id="node40" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1155,317,1341,347"/><area shape="rect" id="node42" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1409,317,1569,347"/><area shape="rect" id="node48" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1136,424,1360,453"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1411,397,1568,427"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1411,451,1568,480"/><area shape="rect" id="node61" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="461,448,608,477"/><area shape="rect" id="node63" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="685,421,829,451"/><area shape="rect" id="node65" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="659,525,856,555"/><area shape="rect" id="node67" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="913,499,1079,528"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_icgraph.png" border="0" usemap="#group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_icgraph_map" id="group__ldlm__cli__api_ga677e9f9ff5fbe2174b139fe8c2b77b70_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="207,109,353,139"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga0237477d402999ab81f2b2447fceebc9" title="Client side lock cancel." alt="" coords="436,29,556,59"/><area shape="rect" id="node12" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels." alt="" coords="404,83,588,112"/><area shape="rect" id="node16" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers." alt="" coords="888,108,1131,137"/><area shape="rect" id="node21" href="group__ldlm__cli__api.html#gabae59a7ebeed8c6fd60b22f03cf88e1f" title="Cancel LRU locks and pack them into the enqueue request." alt="" coords="425,187,567,216"/><area shape="rect" id="node7" href="group__ldlm__local__ast.html#ga9962ac0cc2bd7e279cf0b977d822feb3" title="A helper to build a blocking AST function." alt="" coords="639,29,839,59"/><area shape="rect" id="node9" href="group__ldlm__local__ast.html#gacc93548bb07532aa1d816dee71bd2ecb" title="Server blocking AST." alt="" coords="940,29,1079,59"/><area shape="rect" id="node14" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy..." alt="" coords="637,83,840,112"/><area shape="rect" id="node18" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a" title="Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers..." alt="" coords="1179,108,1355,137"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga8067f82d5a14a84d1c103d2de469501a"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel_unused" ref="ga8067f82d5a14a84d1c103d2de469501a" args="(struct ldlm_namespace *, const struct ldlm_res_id *, enum ldlm_cancel_flags flags, void *opaque)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel_unused </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *&nbsp;</td>
          <td class="paramname"> <em>ns</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *&nbsp;</td>
          <td class="paramname"> <em>res_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>opaque</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers. </p>
<p>If flags &amp; LCF_LOCAL, throw the locks away without trying to notify the server. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l02029">2029</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="ldlm__request_8c_source.html#l01971">ldlm_cli_cancel_unused_resource()</a>, and <a class="el" href="lustre__dlm_8h_source.html#l00377">ldlm_namespace::ns_rs_hash</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02032"></a>02032 {
<a name="l02033"></a>02033         <span class="keyword">struct </span>ldlm_cli_cancel_arg arg = {
<a name="l02034"></a>02034                 .lc_flags       = flags,
<a name="l02035"></a>02035                 .lc_opaque      = opaque,
<a name="l02036"></a>02036         };
<a name="l02037"></a>02037 
<a name="l02038"></a>02038         ENTRY;
<a name="l02039"></a>02039 
<a name="l02040"></a>02040         <span class="keywordflow">if</span> (ns == NULL)
<a name="l02041"></a>02041                 RETURN(ELDLM_OK);
<a name="l02042"></a>02042 
<a name="l02043"></a>02043         <span class="keywordflow">if</span> (res_id != NULL) {
<a name="l02044"></a>02044                 RETURN(<a class="code" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers.">ldlm_cli_cancel_unused_resource</a>(ns, res_id, NULL,
<a name="l02045"></a>02045                                                        LCK_MINMODE, flags,
<a name="l02046"></a>02046                                                        opaque));
<a name="l02047"></a>02047         } <span class="keywordflow">else</span> {
<a name="l02048"></a>02048                 cfs_hash_for_each_nolock(ns-&gt;<a class="code" href="structldlm__namespace.html#ab98b19e574d298fcacdc25f5badb919d" title="Resource hash table for namespace.">ns_rs_hash</a>,
<a name="l02049"></a>02049                                          ldlm_cli_hash_cancel_unused, &amp;arg, 0);
<a name="l02050"></a>02050                 RETURN(ELDLM_OK);
<a name="l02051"></a>02051         }
<a name="l02052"></a>02052 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga8067f82d5a14a84d1c103d2de469501a_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga8067f82d5a14a84d1c103d2de469501a_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga8067f82d5a14a84d1c103d2de469501a_cgraph_map" id="group__ldlm__cli__api_ga8067f82d5a14a84d1c103d2de469501a_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga56914f0205e9d377eeceb78f8db71f66" title="Cancel all locks on a resource that have 0 readers/writers." alt="" coords="229,229,472,259"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy..." alt="" coords="520,177,723,207"/><area shape="rect" id="node9" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="1007,229,1153,259"/><area shape="rect" id="node97" href="group__LDLM.html#ga083fb1ea92619c4b2e526633c3a486fb" title="Return a reference to resource with given name, creating it if necessary." alt="" coords="548,281,695,311"/><area shape="rect" id="node7" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels." alt="" coords="772,177,956,207"/><area shape="rect" id="node86" href="group__LDLM.html#gadec8a773eb3b13c995cf35a4d013393b" title="Attempts to cancel LDLM lock lock that has no reader/writer references." alt="" coords="1013,84,1147,113"/><area shape="rect" id="node11" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="1208,297,1357,327"/><area shape="rect" id="node13" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="1412,219,1615,248"/><area shape="rect" id="node15" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="1440,323,1587,352"/><area shape="rect" id="node25" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="2380,293,2527,323"/><area shape="rect" id="node65" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="1435,376,1592,405"/><area shape="rect" id="node67" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="1436,429,1591,459"/><area shape="rect" id="node69" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="1435,483,1592,512"/><area shape="rect" id="node80" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="1449,536,1577,565"/><area shape="rect" id="node82" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="1423,112,1604,141"/><area shape="rect" id="node84" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="1431,165,1596,195"/><area shape="rect" id="node17" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="1676,452,1804,481"/><area shape="rect" id="node19" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="2368,347,2539,376"/><area shape="rect" id="node21" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="1665,348,1815,377"/><area shape="rect" id="node23" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1888,297,2037,327"/><area shape="rect" id="node27" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="1677,505,1803,535"/><area shape="rect" id="node29" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1893,505,2032,535"/><area shape="rect" id="node31" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="2148,504,2255,533"/><area shape="rect" id="node46" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="2368,712,2539,741"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="2111,608,2292,637"/><area shape="rect" id="node33" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="2632,465,2757,495"/><area shape="rect" id="node35" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="2633,541,2756,571"/><area shape="rect" id="node37" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="2637,601,2752,631"/><area shape="rect" id="node39" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="2376,504,2531,533"/><area shape="rect" id="node48" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="2365,659,2541,688"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="2360,400,2547,429"/><area shape="rect" id="node52" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="2615,400,2775,429"/><area shape="rect" id="node58" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="2341,765,2565,795"/><area shape="rect" id="node60" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="2616,739,2773,768"/><area shape="rect" id="node62" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="2616,792,2773,821"/><area shape="rect" id="node71" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="1667,636,1813,665"/><area shape="rect" id="node73" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1891,713,2035,743"/><area shape="rect" id="node75" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1864,609,2061,639"/><area shape="rect" id="node77" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="2119,661,2284,691"/><area shape="rect" id="node88" href="group__LDLM.html#ga0a466989372b56e3cde1edae472be066" title="Helper function to call blocking AST for LDLM lock lock in a &quot;cancelling&quot;..." alt="" coords="1203,57,1363,87"/><area shape="rect" id="node90" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="1444,5,1583,35"/><area shape="rect" id="node92" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="1436,59,1591,88"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga56914f0205e9d377eeceb78f8db71f66"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_cancel_unused_resource" ref="ga56914f0205e9d377eeceb78f8db71f66" args="(struct ldlm_namespace *ns, const struct ldlm_res_id *res_id, union ldlm_policy_data *policy, enum ldlm_mode mode, enum ldlm_cancel_flags flags, void *opaque)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_cancel_unused_resource </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structldlm__namespace.html">ldlm_namespace</a> *&nbsp;</td>
          <td class="paramname"> <em>ns</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *&nbsp;</td>
          <td class="paramname"> <em>res_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> *&nbsp;</td>
          <td class="paramname"> <em>policy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum ldlm_mode&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="group__LDLM.html#ga0b718c2d27bc15f43205e50e4da16ec9">ldlm_cancel_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>opaque</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cancel all locks on a resource that have 0 readers/writers. </p>
<p>If flags &amp; LDLM_FL_LOCAL_ONLY, throw the locks away without trying to notify the server. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l01971">1971</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="ldlm__request_8c_source.html#l01854">ldlm_cancel_resource_local()</a>, <a class="el" href="ldlm__request_8c_source.html#l01917">ldlm_cli_cancel_list()</a>, and <a class="el" href="ldlm__resource_8c_source.html#l01179">ldlm_resource_get()</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l02029">ldlm_cli_cancel_unused()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01976"></a>01976 {
<a name="l01977"></a>01977         <span class="keyword">struct </span><a class="code" href="structldlm__resource.html" title="LDLM resource description.">ldlm_resource</a> *res;
<a name="l01978"></a>01978         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> cancels = LIST_HEAD_INIT(cancels);
<a name="l01979"></a>01979         <span class="keywordtype">int</span> count;
<a name="l01980"></a>01980         <span class="keywordtype">int</span> rc;
<a name="l01981"></a>01981         ENTRY;
<a name="l01982"></a>01982 
<a name="l01983"></a>01983         res = <a class="code" href="group__LDLM.html#ga083fb1ea92619c4b2e526633c3a486fb" title="Return a reference to resource with given name, creating it if necessary.">ldlm_resource_get</a>(ns, NULL, res_id, 0, 0);
<a name="l01984"></a>01984         <span class="keywordflow">if</span> (IS_ERR(res)) {
<a name="l01985"></a>01985                 <span class="comment">/* This is not a problem. */</span>
<a name="l01986"></a>01986                 CDEBUG(D_INFO, <span class="stringliteral">&quot;No resource &quot;</span>LPU64<span class="stringliteral">&quot;\n&quot;</span>, res_id-&gt;name[0]);
<a name="l01987"></a>01987                 RETURN(0);
<a name="l01988"></a>01988         }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990         LDLM_RESOURCE_ADDREF(res);
<a name="l01991"></a>01991         count = <a class="code" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy...">ldlm_cancel_resource_local</a>(res, &amp;cancels, policy, mode,
<a name="l01992"></a>01992                                            0, flags | LCF_BL_AST, opaque);
<a name="l01993"></a>01993         rc = <a class="code" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client-side locks from a list and send/prepare cancel RPCs to the server.">ldlm_cli_cancel_list</a>(&amp;cancels, count, NULL, flags);
<a name="l01994"></a>01994         <span class="keywordflow">if</span> (rc != ELDLM_OK)
<a name="l01995"></a>01995                 CERROR(<span class="stringliteral">&quot;canceling unused lock &quot;</span>DLDLMRES<span class="stringliteral">&quot;: rc = %d\n&quot;</span>,
<a name="l01996"></a>01996                        PLDLMRES(res), rc);
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         LDLM_RESOURCE_DELREF(res);
<a name="l01999"></a>01999         ldlm_resource_putref(res);
<a name="l02000"></a>02000         RETURN(0);
<a name="l02001"></a>02001 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_cgraph.png" border="0" usemap="#group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_cgraph_map" id="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga2fab73fddf169b2202e11527226f7253" title="Find and cancel locally unused locks found on resource, matched to the given policy..." alt="" coords="296,177,499,207"/><area shape="rect" id="node7" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="783,229,929,259"/><area shape="rect" id="node95" href="group__LDLM.html#ga083fb1ea92619c4b2e526633c3a486fb" title="Return a reference to resource with given name, creating it if necessary." alt="" coords="324,281,471,311"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#gac7dcd18ff549bf7b777a067e1c374149" title="Locally cancel up to count locks in list cancels." alt="" coords="548,177,732,207"/><area shape="rect" id="node84" href="group__LDLM.html#gadec8a773eb3b13c995cf35a4d013393b" title="Attempts to cancel LDLM lock lock that has no reader/writer references." alt="" coords="789,84,923,113"/><area shape="rect" id="node9" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="984,297,1133,327"/><area shape="rect" id="node11" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="1188,219,1391,248"/><area shape="rect" id="node13" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="1216,323,1363,352"/><area shape="rect" id="node23" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="2156,293,2303,323"/><area shape="rect" id="node63" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="1211,376,1368,405"/><area shape="rect" id="node65" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="1212,429,1367,459"/><area shape="rect" id="node67" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="1211,483,1368,512"/><area shape="rect" id="node78" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="1225,536,1353,565"/><area shape="rect" id="node80" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="1199,112,1380,141"/><area shape="rect" id="node82" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="1207,165,1372,195"/><area shape="rect" id="node15" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="1452,452,1580,481"/><area shape="rect" id="node17" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="2144,347,2315,376"/><area shape="rect" id="node19" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="1441,348,1591,377"/><area shape="rect" id="node21" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1664,297,1813,327"/><area shape="rect" id="node25" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="1453,505,1579,535"/><area shape="rect" id="node27" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1669,505,1808,535"/><area shape="rect" id="node29" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1924,504,2031,533"/><area shape="rect" id="node44" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="2144,712,2315,741"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1887,608,2068,637"/><area shape="rect" id="node31" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="2408,465,2533,495"/><area shape="rect" id="node33" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="2409,541,2532,571"/><area shape="rect" id="node35" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="2413,601,2528,631"/><area shape="rect" id="node37" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="2152,504,2307,533"/><area shape="rect" id="node46" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="2141,659,2317,688"/><area shape="rect" id="node48" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="2136,400,2323,429"/><area shape="rect" id="node50" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="2391,400,2551,429"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="2117,765,2341,795"/><area shape="rect" id="node58" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="2392,739,2549,768"/><area shape="rect" id="node60" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="2392,792,2549,821"/><area shape="rect" id="node69" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="1443,636,1589,665"/><area shape="rect" id="node71" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1667,713,1811,743"/><area shape="rect" id="node73" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1640,609,1837,639"/><area shape="rect" id="node75" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1895,661,2060,691"/><area shape="rect" id="node86" href="group__LDLM.html#ga0a466989372b56e3cde1edae472be066" title="Helper function to call blocking AST for LDLM lock lock in a &quot;cancelling&quot;..." alt="" coords="979,57,1139,87"/><area shape="rect" id="node88" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="1220,5,1359,35"/><area shape="rect" id="node90" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="1212,59,1367,88"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_icgraph.png" border="0" usemap="#group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_icgraph_map" id="group__ldlm__cli__api_ga56914f0205e9d377eeceb78f8db71f66_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga8067f82d5a14a84d1c103d2de469501a" title="Cancel all locks on a namespace (or a specific resource, if given) that have 0 readers/writers..." alt="" coords="296,5,472,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="gac3edcad1b11e283d6ef8455a2b598b07"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_enqueue" ref="gac3edcad1b11e283d6ef8455a2b598b07" args="(struct obd_export *exp, struct ptlrpc_request **reqp, struct ldlm_enqueue_info *einfo, const struct ldlm_res_id *res_id, union ldlm_policy_data const *policy, __u64 *flags, void *lvb, __u32 lvb_len, enum lvb_type lvb_type, struct lustre_handle *lockh, int async)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_enqueue </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> **&nbsp;</td>
          <td class="paramname"> <em>reqp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structldlm__enqueue__info.html">ldlm_enqueue_info</a> *&nbsp;</td>
          <td class="paramname"> <em>einfo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structldlm__res__id.html">ldlm_res_id</a> *&nbsp;</td>
          <td class="paramname"> <em>res_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">union <a class="el" href="unionldlm__policy__data.html">ldlm_policy_data</a> const *&nbsp;</td>
          <td class="paramname"> <em>policy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u64 *&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>lvb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>lvb_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum lvb_type lvb_type&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>lockh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>async</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Client-side lock enqueue. </p>
<p>If a request has some specific initialisation it is passed in <em>reqp</em>, otherwise it is created in ldlm_cli_enqueue.</p>
<p>Supports sync and async requests, pass <em>async</em> flag accordingly. If a request was created in ldlm_cli_enqueue and it is the async request, pass it to the caller in <em>reqp</em>. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l00869">869</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__dlm_8h_source.html#l01099">ldlm_enqueue_info::ei_cb_bl</a>, <a class="el" href="lustre__dlm_8h_source.html#l01101">ldlm_enqueue_info::ei_cb_cp</a>, <a class="el" href="lustre__dlm_8h_source.html#l01102">ldlm_enqueue_info::ei_cb_gl</a>, <a class="el" href="lustre__dlm_8h_source.html#l01103">ldlm_enqueue_info::ei_cbdata</a>, <a class="el" href="lustre__dlm_8h_source.html#l01098">ldlm_enqueue_info::ei_mode</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__dlm_8h_source.html#l00741">ldlm_lock::l_blocking_ast</a>, <a class="el" href="lustre__dlm_8h_source.html#l00759">ldlm_lock::l_conn_export</a>, <a class="el" href="lustre__dlm_8h_source.html#l00754">ldlm_lock::l_export</a>, <a class="el" href="lustre__dlm_8h_source.html#l00778">ldlm_lock::l_flags</a>, <a class="el" href="lustre__dlm_8h_source.html#l00797">ldlm_lock::l_last_activity</a>, <a class="el" href="lustre__dlm_8h_source.html#l00772">ldlm_lock::l_policy_data</a>, <a class="el" href="lustre__dlm_8h_source.html#l00806">ldlm_lock::l_req_extent</a>, <a class="el" href="ldlm__request_8c_source.html#l00541">ldlm_cli_enqueue_fini()</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00349">LDLM_FL_EXCL</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00289">LDLM_FL_NO_LRU</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00070">LDLM_FL_REPLAY</a>, <a class="el" href="ldlm__lock_8c_source.html#l00646">ldlm_lock2desc()</a>, <a class="el" href="ldlm__lock_8c_source.html#l00582">ldlm_lock2handle()</a>, <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>, <a class="el" href="client_8c_source.html#l02829">ptlrpc_queue_wait()</a>, <a class="el" href="client_8c_source.html#l02490">ptlrpc_req_finished()</a>, <a class="el" href="client_8c_source.html#l00891">ptlrpc_request_alloc_pack()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l02339">req_capsule_extend()</a>, <a class="el" href="layout_8c_source.html#l02263">req_capsule_get_size()</a>, <a class="el" href="layout_8c_source.html#l02226">req_capsule_set_size()</a>, and <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00875"></a>00875 {
<a name="l00876"></a>00876         <span class="keyword">struct </span><a class="code" href="structldlm__namespace.html" title="LDLM Namespace.">ldlm_namespace</a> *ns;
<a name="l00877"></a>00877         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a>      *lock;
<a name="l00878"></a>00878         <span class="keyword">struct </span><a class="code" href="structldlm__request.html">ldlm_request</a>   *body;
<a name="l00879"></a>00879         <span class="keywordtype">int</span>                    is_replay = *flags &amp; <a class="code" href="group__LDLM.html#ga4210c27164df8fc68b15a5c6f88d3063" title="Lock is being replayed.">LDLM_FL_REPLAY</a>;
<a name="l00880"></a>00880         <span class="keywordtype">int</span>                    req_passed_in = 1;
<a name="l00881"></a>00881         <span class="keywordtype">int</span>                    rc, err;
<a name="l00882"></a>00882         <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req;
<a name="l00883"></a>00883         ENTRY;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885         LASSERT(exp != NULL);
<a name="l00886"></a>00886 
<a name="l00887"></a>00887         ns = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_namespace;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889         <span class="comment">/* If we&apos;re replaying this lock, just check some invariants.</span>
<a name="l00890"></a>00890 <span class="comment">         * If we&apos;re creating a new lock, get everything all setup nice. */</span>
<a name="l00891"></a>00891         <span class="keywordflow">if</span> (is_replay) {
<a name="l00892"></a>00892                 lock = ldlm_handle2lock_long(lockh, 0);
<a name="l00893"></a>00893                 LASSERT(lock != NULL);
<a name="l00894"></a>00894                 LDLM_DEBUG(lock, <span class="stringliteral">&quot;client-side enqueue START&quot;</span>);
<a name="l00895"></a>00895                 LASSERT(exp == lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a>);
<a name="l00896"></a>00896         } <span class="keywordflow">else</span> {
<a name="l00897"></a>00897                 <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structldlm__callback__suite.html">ldlm_callback_suite</a> cbs = {
<a name="l00898"></a>00898                         .lcs_completion = einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#a08e843216d2e582b026fb5379fac9814" title="blocking local lock callback">ei_cb_cp</a>,
<a name="l00899"></a>00899                         .lcs_blocking   = einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#abf96eb0f7a2c82dc89872dedfe64b223" title="Mode of the lock being enqueued.">ei_cb_bl</a>,
<a name="l00900"></a>00900                         .lcs_glimpse    = einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#a486fcd5061cb4cb937812c7979d568b3" title="lock completion callback">ei_cb_gl</a>
<a name="l00901"></a>00901                 };
<a name="l00902"></a>00902                 lock = ldlm_lock_create(ns, res_id, einfo-&gt;ei_type,
<a name="l00903"></a>00903                                         einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#af97991a29b4940204cb0bef4bafeb678" title="Type of the lock being enqueued.">ei_mode</a>, &amp;cbs, einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#af0ba62d8b646a2164ec979fb9bca48d4" title="lock glimpse callback">ei_cbdata</a>,
<a name="l00904"></a>00904                                         lvb_len, lvb_type);
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> (IS_ERR(lock))
<a name="l00906"></a>00906                         RETURN(PTR_ERR(lock));
<a name="l00907"></a>00907                 <span class="comment">/* for the local lock, add the reference */</span>
<a name="l00908"></a>00908                 ldlm_lock_addref_internal(lock, einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#af97991a29b4940204cb0bef4bafeb678" title="Type of the lock being enqueued.">ei_mode</a>);
<a name="l00909"></a>00909                 <a class="code" href="group__LDLM.html#ga35362f3605ec8dec52464f153c932c85" title="Fills in handle for LDLM lock lock into supplied lockh Does not take any references...">ldlm_lock2handle</a>(lock, lockh);
<a name="l00910"></a>00910                 <span class="keywordflow">if</span> (policy != NULL)
<a name="l00911"></a>00911                         lock-&gt;<a class="code" href="structldlm__lock.html#a30dc0349b0b525d72e9a3a92ad19ff79" title="Representation of private data specific for a lock type.">l_policy_data</a> = *policy;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                 <span class="keywordflow">if</span> (einfo-&gt;ei_type == LDLM_EXTENT) {
<a name="l00914"></a>00914                         <span class="comment">/* extent lock without policy is a bug */</span>
<a name="l00915"></a>00915                         <span class="keywordflow">if</span> (policy == NULL)
<a name="l00916"></a>00916                                 LBUG();
<a name="l00917"></a>00917 
<a name="l00918"></a>00918                         lock-&gt;<a class="code" href="structldlm__lock.html#af103e96dfac8d06fe14a472577c0f7f6" title="Originally requested extent for the extent lock.">l_req_extent</a> = policy-&gt;l_extent;
<a name="l00919"></a>00919                 }
<a name="l00920"></a>00920                 LDLM_DEBUG(lock, <span class="stringliteral">&quot;client-side enqueue START, flags &quot;</span>LPX64,
<a name="l00921"></a>00921                            *flags);
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924         lock-&gt;<a class="code" href="structldlm__lock.html#ae11dfeaaf68f7217bc5defa97b58b1b1" title="Lock connection export.">l_conn_export</a> = exp;
<a name="l00925"></a>00925         lock-&gt;<a class="code" href="structldlm__lock.html#a60b23d06e26065065d0bac47ace905b0" title="Lock export.">l_export</a> = NULL;
<a name="l00926"></a>00926         lock-&gt;<a class="code" href="structldlm__lock.html#ac1baaa1cb6f8c57cd0e574dff1dcdfd8" title="Lock blocking AST handler pointer.">l_blocking_ast</a> = einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#abf96eb0f7a2c82dc89872dedfe64b223" title="Mode of the lock being enqueued.">ei_cb_bl</a>;
<a name="l00927"></a>00927         lock-&gt;<a class="code" href="structldlm__lock.html#a52cb4e433ee43b7326bfbb652c3d0598" title="Lock state flags.">l_flags</a> |= (*flags &amp; (<a class="code" href="group__LDLM.html#ga628bde1454443ba6f69043120c61acb9" title="Don&amp;#39;t put lock into the LRU list, so that it is not canceled due to aging.">LDLM_FL_NO_LRU</a> | <a class="code" href="group__LDLM.html#ga353cf18a1a7c41ccaf72d5c8bf71a129" title="Flag whether this lock can be reused.">LDLM_FL_EXCL</a>));
<a name="l00928"></a>00928         lock-&gt;<a class="code" href="structldlm__lock.html#af1f00870111fa501c0fb07a97c642fb1" title="Seconds.">l_last_activity</a> = cfs_time_current_sec();
<a name="l00929"></a>00929 
<a name="l00930"></a>00930         <span class="comment">/* lock not sent to server yet */</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (reqp == NULL || *reqp == NULL) {
<a name="l00933"></a>00933                 req = <a class="code" href="group__net.html#gac578ffdc47c9c2141c34c4798a55cce4" title="Allocate new request for operatione opcode and immediatelly pack it for network transfer...">ptlrpc_request_alloc_pack</a>(class_exp2cliimp(exp),
<a name="l00934"></a>00934                                                 &amp;RQF_LDLM_ENQUEUE,
<a name="l00935"></a>00935                                                 LUSTRE_DLM_VERSION,
<a name="l00936"></a>00936                                                 LDLM_ENQUEUE);
<a name="l00937"></a>00937                 <span class="keywordflow">if</span> (req == NULL) {
<a name="l00938"></a>00938                         failed_lock_cleanup(ns, lock, einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#af97991a29b4940204cb0bef4bafeb678" title="Type of the lock being enqueued.">ei_mode</a>);
<a name="l00939"></a>00939                         <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l00940"></a>00940                         RETURN(-ENOMEM);
<a name="l00941"></a>00941                 }
<a name="l00942"></a>00942                 req_passed_in = 0;
<a name="l00943"></a>00943                 <span class="keywordflow">if</span> (reqp)
<a name="l00944"></a>00944                         *reqp = req;
<a name="l00945"></a>00945         } <span class="keywordflow">else</span> {
<a name="l00946"></a>00946                 <span class="keywordtype">int</span> len;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948                 req = *reqp;
<a name="l00949"></a>00949                 len = <a class="code" href="group__req__layout.html#ga102a4e6bb0a627ead289f4684971fc28" title="Return the actual PTLRPC buffer length of a request or reply (loc) for the given...">req_capsule_get_size</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_REQ,
<a name="l00950"></a>00950                                            RCL_CLIENT);
<a name="l00951"></a>00951                 LASSERTF(len &gt;= <span class="keyword">sizeof</span>(*body), <span class="stringliteral">&quot;buflen[%d] = %d, not %d\n&quot;</span>,
<a name="l00952"></a>00952                          DLM_LOCKREQ_OFF, len, (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(*body));
<a name="l00953"></a>00953         }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         <span class="comment">/* Dump lock data into the request buffer */</span>
<a name="l00956"></a>00956         body = <a class="code" href="group__req__layout.html#ga0ecb097da2dfa5ac12ec0ef1f33d3e88" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC request buffer...">req_capsule_client_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_REQ);
<a name="l00957"></a>00957         <a class="code" href="group__LDLM.html#ga7b4cfac056355ba992b1b7d9bfbaa25b" title="Fill in &amp;quot;on the wire&amp;quot; representation for given LDLM lock into supplied...">ldlm_lock2desc</a>(lock, &amp;body-&gt;lock_desc);
<a name="l00958"></a>00958         body-&gt;lock_flags = ldlm_flags_to_wire(*flags);
<a name="l00959"></a>00959         body-&gt;lock_handle[0] = *lockh;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="comment">/* Continue as normal. */</span>
<a name="l00962"></a>00962         <span class="keywordflow">if</span> (!req_passed_in) {
<a name="l00963"></a>00963                 <span class="keywordflow">if</span> (lvb_len &gt; 0)
<a name="l00964"></a>00964                         <a class="code" href="group__req__layout.html#gad16c26c15f59593e2e005e4afbeb8034" title="Changes the format of an RPC.">req_capsule_extend</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>,
<a name="l00965"></a>00965                                            &amp;RQF_LDLM_ENQUEUE_LVB);
<a name="l00966"></a>00966                 <a class="code" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the...">req_capsule_set_size</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_LVB, RCL_SERVER,
<a name="l00967"></a>00967                                      lvb_len);
<a name="l00968"></a>00968                 ptlrpc_request_set_replen(req);
<a name="l00969"></a>00969         }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         <span class="keywordflow">if</span> (async) {
<a name="l00972"></a>00972                 LASSERT(reqp != NULL);
<a name="l00973"></a>00973                 RETURN(0);
<a name="l00974"></a>00974         }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         LDLM_DEBUG(lock, <span class="stringliteral">&quot;sending request&quot;</span>);
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         rc = <a class="code" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes.">ptlrpc_queue_wait</a>(req);
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         err = <a class="code" href="group__ldlm__cli__api.html#gac421005283912bb5186b035013aa58c0" title="Finishing portion of client lock enqueue code.">ldlm_cli_enqueue_fini</a>(exp, req, einfo-&gt;ei_type, policy ? 1 : 0,
<a name="l00981"></a>00981                                     einfo-&gt;<a class="code" href="structldlm__enqueue__info.html#af97991a29b4940204cb0bef4bafeb678" title="Type of the lock being enqueued.">ei_mode</a>, flags, lvb, lvb_len,
<a name="l00982"></a>00982                                     lockh, rc);
<a name="l00983"></a>00983 
<a name="l00984"></a>00984         <span class="comment">/* If ldlm_cli_enqueue_fini did not find the lock, we need to free</span>
<a name="l00985"></a>00985 <span class="comment">         * one reference that we took */</span>
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (err == -ENOLCK)
<a name="l00987"></a>00987                 <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l00988"></a>00988         <span class="keywordflow">else</span>
<a name="l00989"></a>00989                 rc = err;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (!req_passed_in &amp;&amp; req != NULL) {
<a name="l00992"></a>00992                 <a class="code" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request.">ptlrpc_req_finished</a>(req);
<a name="l00993"></a>00993                 <span class="keywordflow">if</span> (reqp)
<a name="l00994"></a>00994                         *reqp = NULL;
<a name="l00995"></a>00995         }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         RETURN(rc);
<a name="l00998"></a>00998 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gac3edcad1b11e283d6ef8455a2b598b07_cgraph.png" border="0" usemap="#group__ldlm__cli__api_gac3edcad1b11e283d6ef8455a2b598b07_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gac3edcad1b11e283d6ef8455a2b598b07_cgraph_map" id="group__ldlm__cli__api_gac3edcad1b11e283d6ef8455a2b598b07_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#gac421005283912bb5186b035013aa58c0" title="Finishing portion of client lock enqueue code." alt="" coords="207,144,369,173"/><area shape="rect" id="node16" href="group__req__layout.html#ga102a4e6bb0a627ead289f4684971fc28" title="Return the actual PTLRPC buffer length of a request or reply (loc) for the given..." alt="" coords="459,248,624,277"/><area shape="rect" id="node23" href="group__LDLM.html#ga7b4cfac056355ba992b1b7d9bfbaa25b" title="Fill in &quot;on the wire&quot; representation for given LDLM lock into supplied..." alt="" coords="227,486,349,516"/><area shape="rect" id="node27" href="group__LDLM.html#ga35362f3605ec8dec52464f153c932c85" title="Fills in handle for LDLM lock lock into supplied lockh Does not take any references..." alt="" coords="221,565,355,594"/><area shape="rect" id="node29" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="215,618,361,648"/><area shape="rect" id="node39" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1185,825,1332,854"/><area shape="rect" id="node79" href="group__net.html#gac578ffdc47c9c2141c34c4798a55cce4" title="Allocate new request for operatione opcode and immediatelly pack it for network transfer..." alt="" coords="191,381,385,410"/><area shape="rect" id="node95" href="group__req__layout.html#ga0ecb097da2dfa5ac12ec0ef1f33d3e88" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC request buffer..." alt="" coords="199,798,377,828"/><area shape="rect" id="node97" href="group__req__layout.html#gad16c26c15f59593e2e005e4afbeb8034" title="Changes the format of an RPC." alt="" coords="209,852,367,881"/><area shape="rect" id="node100" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="205,905,371,934"/><area shape="rect" id="node5" href="group__LDLM.html#ga0f272b273065dc0d916fcb5c6b61d656" title="Converts lock policy from on the wire lock_desc format to local format." alt="" coords="435,90,648,120"/><area shape="rect" id="node7" href="group__LDLM.html#gafd6a07a826f7d2789696e472dd81adc2" title="Moves LDLM lock lock to another resource." alt="" coords="440,144,643,173"/><area shape="rect" id="node11" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="705,196,844,225"/><area shape="rect" id="node13" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="697,37,852,66"/><area shape="rect" id="node20" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer..." alt="" coords="451,37,632,66"/><area shape="rect" id="node9" href="group__LDLM.html#ga083fb1ea92619c4b2e526633c3a486fb" title="Return a reference to resource with given name, creating it if necessary." alt="" coords="701,142,848,172"/><area shape="rect" id="node18" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="928,248,1072,277"/><area shape="rect" id="node25" href="group__LDLM.html#ga82466f1300e6e9395e768b7336c0ac46" title="Converts lock policy from local format to on the wire lock_desc format." alt="" coords="436,461,647,490"/><area shape="rect" id="node31" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="477,618,605,648"/><area shape="rect" id="node33" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1173,353,1344,382"/><area shape="rect" id="node35" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="467,565,616,594"/><area shape="rect" id="node37" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="925,773,1075,802"/><area shape="rect" id="node41" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="479,672,604,701"/><area shape="rect" id="node43" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="705,670,844,700"/><area shape="rect" id="node45" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="947,618,1053,648"/><area shape="rect" id="node60" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1173,772,1344,801"/><area shape="rect" id="node70" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="909,565,1091,594"/><area shape="rect" id="node47" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1437,649,1563,678"/><area shape="rect" id="node49" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1439,714,1561,744"/><area shape="rect" id="node51" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1443,572,1557,601"/><area shape="rect" id="node53" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1181,617,1336,646"/><area shape="rect" id="node62" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1171,513,1347,542"/><area shape="rect" id="node64" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1165,460,1352,489"/><area shape="rect" id="node66" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1420,460,1580,489"/><area shape="rect" id="node72" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1147,406,1371,436"/><area shape="rect" id="node74" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1421,353,1579,382"/><area shape="rect" id="node76" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1421,406,1579,436"/><area shape="rect" id="node81" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="463,301,620,330"/><area shape="rect" id="node83" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="464,354,619,384"/><area shape="rect" id="node85" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="463,408,620,437"/><area shape="rect" id="node87" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="701,326,848,356"/><area shape="rect" id="node90" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="901,352,1099,381"/><area shape="rect" id="node92" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1176,300,1341,329"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="gac421005283912bb5186b035013aa58c0"></a><!-- doxytag: member="lustre_dlm.h::ldlm_cli_enqueue_fini" ref="gac421005283912bb5186b035013aa58c0" args="(struct obd_export *exp, struct ptlrpc_request *req, enum ldlm_type type, __u8 with_policy, enum ldlm_mode mode, __u64 *flags, void *lvb, __u32 lvb_len, const struct lustre_handle *lockh, int rc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_cli_enqueue_fini </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum ldlm_type&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u8&nbsp;</td>
          <td class="paramname"> <em>with_policy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum ldlm_mode&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u64 *&nbsp;</td>
          <td class="paramname"> <em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>lvb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">__u32&nbsp;</td>
          <td class="paramname"> <em>lvb_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structlustre__handle.html">lustre_handle</a> *&nbsp;</td>
          <td class="paramname"> <em>lockh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Finishing portion of client lock enqueue code. </p>
<p>Called after receiving reply from server. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l00541">541</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__export_8h_source.html#l00221">obd_export::exp_lock_hash</a>, <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="lustre__dlm_8h_source.html#l00730">ldlm_lock::l_completion_ast</a>, <a class="el" href="lustre__dlm_8h_source.html#l00714">ldlm_lock::l_exp_hash</a>, <a class="el" href="lustre__dlm_8h_source.html#l00778">ldlm_lock::l_flags</a>, <a class="el" href="lustre__dlm_8h_source.html#l00728">ldlm_lock::l_granted_mode</a>, <a class="el" href="lustre__dlm_8h_source.html#l00818">ldlm_lock::l_lvb_len</a>, <a class="el" href="lustre__dlm_8h_source.html#l00772">ldlm_lock::l_policy_data</a>, <a class="el" href="lustre__dlm_8h_source.html#l00766">ldlm_lock::l_remote_handle</a>, <a class="el" href="lustre__dlm_8h_source.html#l00724">ldlm_lock::l_req_mode</a>, <a class="el" href="lustre__dlm_8h_source.html#l00694">ldlm_lock::l_resource</a>, <a class="el" href="ldlm__lock_8c_source.html#l00103">ldlm_convert_policy_to_local()</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00062">LDLM_FL_AST_SENT</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00270">LDLM_FL_BL_AST</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00173">LDLM_FL_CBPENDING</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00382">LDLM_FL_INHERIT_MASK</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00032">LDLM_FL_LOCK_CHANGED</a>, <a class="el" href="lustre__dlm__flags_8h_source.html#l00070">LDLM_FL_REPLAY</a>, <a class="el" href="ldlm__lock_8c_source.html#l00514">ldlm_lock_change_resource()</a>, <a class="el" href="lustre__dlm_8h_source.html#l01327">LDLM_LOCK_PUT</a>, <a class="el" href="lustre__dlm_8h_source.html#l01338">LDLM_LOCK_RELEASE</a>, <a class="el" href="l__lock_8c_source.html#l00051">lock_res_and_lock()</a>, <a class="el" href="lustre__dlm_8h_source.html#l00951">ldlm_resource::lr_name</a>, <a class="el" href="lustre__dlm_8h_source.html#l00970">ldlm_resource::lr_type</a>, <a class="el" href="layout_8c_source.html#l02263">req_capsule_get_size()</a>, <a class="el" href="layout_8c_source.html#l02158">req_capsule_server_get()</a>, <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>, and <a class="el" href="l__lock_8c_source.html#l00067">unlock_res_and_lock()</a>.</p>

<p>Referenced by <a class="el" href="ldlm__request_8c_source.html#l00869">ldlm_cli_enqueue()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00546"></a>00546 {
<a name="l00547"></a>00547         <span class="keyword">struct </span><a class="code" href="structldlm__namespace.html" title="LDLM Namespace.">ldlm_namespace</a> *ns = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_namespace;
<a name="l00548"></a>00548         <span class="keywordtype">int</span> is_replay = *flags &amp; <a class="code" href="group__LDLM.html#ga4210c27164df8fc68b15a5c6f88d3063" title="Lock is being replayed.">LDLM_FL_REPLAY</a>;
<a name="l00549"></a>00549         <span class="keyword">struct </span><a class="code" href="structldlm__lock.html" title="LDLM lock structure.">ldlm_lock</a> *lock;
<a name="l00550"></a>00550         <span class="keyword">struct </span><a class="code" href="structldlm__reply.html">ldlm_reply</a> *reply;
<a name="l00551"></a>00551         <span class="keywordtype">int</span> cleanup_phase = 1;
<a name="l00552"></a>00552         ENTRY;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         lock = ldlm_handle2lock(lockh);
<a name="l00555"></a>00555         <span class="comment">/* ldlm_cli_enqueue is holding a reference on this lock. */</span>
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (!lock) {
<a name="l00557"></a>00557                 LASSERT(type == LDLM_FLOCK);
<a name="l00558"></a>00558                 RETURN(-ENOLCK);
<a name="l00559"></a>00559         }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         LASSERTF(ergo(lvb_len != 0, lvb_len == lock-&gt;<a class="code" href="structldlm__lock.html#af9af59e08968100a683ab5f5d595a495" title="Temporary storage for a LVB received during an enqueue operation.">l_lvb_len</a>),
<a name="l00562"></a>00562                  <span class="stringliteral">&quot;lvb_len = %d, l_lvb_len = %d\n&quot;</span>, lvb_len, lock-&gt;<a class="code" href="structldlm__lock.html#af9af59e08968100a683ab5f5d595a495" title="Temporary storage for a LVB received during an enqueue operation.">l_lvb_len</a>);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         <span class="keywordflow">if</span> (rc != ELDLM_OK) {
<a name="l00565"></a>00565                 LASSERT(!is_replay);
<a name="l00566"></a>00566                 LDLM_DEBUG(lock, <span class="stringliteral">&quot;client-side enqueue END (%s)&quot;</span>,
<a name="l00567"></a>00567                            rc == ELDLM_LOCK_ABORTED ? <span class="stringliteral">&quot;ABORTED&quot;</span> : <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569                 <span class="keywordflow">if</span> (rc != ELDLM_LOCK_ABORTED)
<a name="l00570"></a>00570                         GOTO(cleanup, rc);
<a name="l00571"></a>00571         }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <span class="comment">/* Before we return, swab the reply */</span>
<a name="l00574"></a>00574         reply = <a class="code" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer...">req_capsule_server_get</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_REP);
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (reply == NULL)
<a name="l00576"></a>00576                 GOTO(cleanup, rc = -EPROTO);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (lvb_len &gt; 0) {
<a name="l00579"></a>00579                 <span class="keywordtype">int</span> size = 0;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                 size = <a class="code" href="group__req__layout.html#ga102a4e6bb0a627ead289f4684971fc28" title="Return the actual PTLRPC buffer length of a request or reply (loc) for the given...">req_capsule_get_size</a>(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, &amp;RMF_DLM_LVB,
<a name="l00582"></a>00582                                             RCL_SERVER);
<a name="l00583"></a>00583                 <span class="keywordflow">if</span> (size &lt; 0) {
<a name="l00584"></a>00584                         LDLM_ERROR(lock, <span class="stringliteral">&quot;Fail to get lvb_len, rc = %d&quot;</span>, size);
<a name="l00585"></a>00585                         GOTO(cleanup, rc = size);
<a name="l00586"></a>00586                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (unlikely(size &gt; lvb_len)) {
<a name="l00587"></a>00587                         LDLM_ERROR(lock, <span class="stringliteral">&quot;Replied LVB is larger than &quot;</span>
<a name="l00588"></a>00588                                    <span class="stringliteral">&quot;expectation, expected = %d, replied = %d&quot;</span>,
<a name="l00589"></a>00589                                    lvb_len, size);
<a name="l00590"></a>00590                         GOTO(cleanup, rc = -EINVAL);
<a name="l00591"></a>00591                 }
<a name="l00592"></a>00592                 lvb_len = size;
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         <span class="keywordflow">if</span> (rc == ELDLM_LOCK_ABORTED) {
<a name="l00596"></a>00596                 <span class="keywordflow">if</span> (lvb_len &gt; 0 &amp;&amp; lvb != NULL)
<a name="l00597"></a>00597                         rc = ldlm_fill_lvb(lock, &amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, RCL_SERVER,
<a name="l00598"></a>00598                                            lvb, lvb_len);
<a name="l00599"></a>00599                 GOTO(cleanup, rc = rc ? : ELDLM_LOCK_ABORTED);
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="comment">/* lock enqueued on the server */</span>
<a name="l00603"></a>00603         cleanup_phase = 0;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         <a class="code" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource.">lock_res_and_lock</a>(lock);
<a name="l00606"></a>00606         <span class="comment">/* Key change rehash lock in per-export hash with new key */</span>
<a name="l00607"></a>00607         <span class="keywordflow">if</span> (exp-&gt;<a class="code" href="structobd__export.html#a266acfd1e7fdf346515f2e5d55008562" title="Hash list of all ldlm locks granted on this export.">exp_lock_hash</a>) {
<a name="l00608"></a>00608                 <span class="comment">/* In the function below, .hs_keycmp resolves to</span>
<a name="l00609"></a>00609 <span class="comment">                 * ldlm_export_lock_keycmp() */</span>
<a name="l00610"></a>00610                 <span class="comment">/* coverity[overrun-buffer-val] */</span>
<a name="l00611"></a>00611                 cfs_hash_rehash_key(exp-&gt;<a class="code" href="structobd__export.html#a266acfd1e7fdf346515f2e5d55008562" title="Hash list of all ldlm locks granted on this export.">exp_lock_hash</a>,
<a name="l00612"></a>00612                                     &amp;lock-&gt;<a class="code" href="structldlm__lock.html#a2c6e6f83512b652ba6563740a3d3487e" title="Remote lock handle.">l_remote_handle</a>,
<a name="l00613"></a>00613                                     &amp;reply-&gt;lock_handle,
<a name="l00614"></a>00614                                     &amp;lock-&gt;<a class="code" href="structldlm__lock.html#aa9c7b6de27615654aab63f1b924df9a6" title="Per export hash of locks.">l_exp_hash</a>);
<a name="l00615"></a>00615         } <span class="keywordflow">else</span> {
<a name="l00616"></a>00616                 lock-&gt;<a class="code" href="structldlm__lock.html#a2c6e6f83512b652ba6563740a3d3487e" title="Remote lock handle.">l_remote_handle</a> = reply-&gt;lock_handle;
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         *flags = ldlm_flags_from_wire(reply-&gt;lock_flags);
<a name="l00620"></a>00620         lock-&gt;<a class="code" href="structldlm__lock.html#a52cb4e433ee43b7326bfbb652c3d0598" title="Lock state flags.">l_flags</a> |= ldlm_flags_from_wire(reply-&gt;lock_flags &amp;
<a name="l00621"></a>00621                                               <a class="code" href="group__LDLM.html#ga1a53232f696448d6586b6d66e973b9c6" title="l_flags bits marked as &amp;quot;inherit&amp;quot; bits">LDLM_FL_INHERIT_MASK</a>);
<a name="l00622"></a>00622         <a class="code" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock.">unlock_res_and_lock</a>(lock);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         CDEBUG(D_INFO, <span class="stringliteral">&quot;local: %p, remote cookie: &quot;</span>LPX64<span class="stringliteral">&quot;, flags: &quot;</span>LPX64<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00625"></a>00625                lock, reply-&gt;lock_handle.cookie, *flags);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="comment">/* If enqueue returned a blocked lock but the completion handler has</span>
<a name="l00628"></a>00628 <span class="comment">         * already run, then it fixed up the resource and we don&apos;t need to do it</span>
<a name="l00629"></a>00629 <span class="comment">         * again. */</span>
<a name="l00630"></a>00630         <span class="keywordflow">if</span> ((*flags) &amp; <a class="code" href="group__LDLM.html#ga79f84ccf0096f82e1153bb5646c4a4d6" title="extent, mode, or resource changed">LDLM_FL_LOCK_CHANGED</a>) {
<a name="l00631"></a>00631                 <span class="keywordtype">int</span> newmode = reply-&gt;lock_desc.l_req_mode;
<a name="l00632"></a>00632                 LASSERT(!is_replay);
<a name="l00633"></a>00633                 <span class="keywordflow">if</span> (newmode &amp;&amp; newmode != lock-&gt;<a class="code" href="structldlm__lock.html#a4c3ab4e1a3ec7f022d954251e6eafa67" title="Requested mode.">l_req_mode</a>) {
<a name="l00634"></a>00634                         LDLM_DEBUG(lock, <span class="stringliteral">&quot;server returned different mode %s&quot;</span>,
<a name="l00635"></a>00635                                    ldlm_lockname[newmode]);
<a name="l00636"></a>00636                         lock-&gt;<a class="code" href="structldlm__lock.html#a4c3ab4e1a3ec7f022d954251e6eafa67" title="Requested mode.">l_req_mode</a> = newmode;
<a name="l00637"></a>00637                 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639                 <span class="keywordflow">if</span> (!ldlm_res_eq(&amp;reply-&gt;lock_desc.l_resource.lr_name,
<a name="l00640"></a>00640                                  &amp;lock-&gt;<a class="code" href="structldlm__lock.html#a41f4592eb59ed0c94d85e9fa67acfa6f" title="Pointer to actual resource this lock is in.">l_resource</a>-&gt;<a class="code" href="structldlm__resource.html#aa749561d4248b6066c028d44def461dc" title="Resource name.">lr_name</a>)) {
<a name="l00641"></a>00641                         CDEBUG(D_INFO, <span class="stringliteral">&quot;remote intent success, locking &quot;</span>DLDLMRES
<a name="l00642"></a>00642                                        <span class="stringliteral">&quot; instead of &quot;</span>DLDLMRES<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00643"></a>00643                                PLDLMRES(&amp;reply-&gt;lock_desc.l_resource),
<a name="l00644"></a>00644                                PLDLMRES(lock-&gt;<a class="code" href="structldlm__lock.html#a41f4592eb59ed0c94d85e9fa67acfa6f" title="Pointer to actual resource this lock is in.">l_resource</a>));
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                         rc = <a class="code" href="group__LDLM.html#gafd6a07a826f7d2789696e472dd81adc2" title="Moves LDLM lock lock to another resource.">ldlm_lock_change_resource</a>(ns, lock,
<a name="l00647"></a>00647                                         &amp;reply-&gt;lock_desc.l_resource.lr_name);
<a name="l00648"></a>00648                         <span class="keywordflow">if</span> (rc || lock-&gt;<a class="code" href="structldlm__lock.html#a41f4592eb59ed0c94d85e9fa67acfa6f" title="Pointer to actual resource this lock is in.">l_resource</a> == NULL)
<a name="l00649"></a>00649                                 GOTO(cleanup, rc = -ENOMEM);
<a name="l00650"></a>00650                         LDLM_DEBUG(lock, <span class="stringliteral">&quot;client-side enqueue, new resource&quot;</span>);
<a name="l00651"></a>00651                 }
<a name="l00652"></a>00652                 <span class="keywordflow">if</span> (with_policy)
<a name="l00653"></a>00653                         <span class="keywordflow">if</span> (!(type == LDLM_IBITS &amp;&amp;
<a name="l00654"></a>00654                               !(exp_connect_flags(exp) &amp; OBD_CONNECT_IBITS)))
<a name="l00655"></a>00655                                 <span class="comment">/* We assume lock type cannot change on server*/</span>
<a name="l00656"></a>00656                                 <a class="code" href="group__LDLM.html#ga0f272b273065dc0d916fcb5c6b61d656" title="Converts lock policy from on the wire lock_desc format to local format.">ldlm_convert_policy_to_local</a>(exp,
<a name="l00657"></a>00657                                                 lock-&gt;<a class="code" href="structldlm__lock.html#a41f4592eb59ed0c94d85e9fa67acfa6f" title="Pointer to actual resource this lock is in.">l_resource</a>-&gt;<a class="code" href="structldlm__resource.html#a49b3d8776d2a7ff57e963c988d1de5cf" title="Type of locks this resource can hold.">lr_type</a>,
<a name="l00658"></a>00658                                                 &amp;reply-&gt;lock_desc.l_policy_data,
<a name="l00659"></a>00659                                                 &amp;lock-&gt;<a class="code" href="structldlm__lock.html#a30dc0349b0b525d72e9a3a92ad19ff79" title="Representation of private data specific for a lock type.">l_policy_data</a>);
<a name="l00660"></a>00660                 <span class="keywordflow">if</span> (type != LDLM_PLAIN)
<a name="l00661"></a>00661                         LDLM_DEBUG(lock,<span class="stringliteral">&quot;client-side enqueue, new policy data&quot;</span>);
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         <span class="keywordflow">if</span> ((*flags) &amp; <a class="code" href="group__LDLM.html#ga3fb0e46d8dcf09f83494412e8cb5d588" title="blocking or cancel packet was queued for sending.">LDLM_FL_AST_SENT</a>) {
<a name="l00665"></a>00665                 <a class="code" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource.">lock_res_and_lock</a>(lock);
<a name="l00666"></a>00666                 lock-&gt;<a class="code" href="structldlm__lock.html#a52cb4e433ee43b7326bfbb652c3d0598" title="Lock state flags.">l_flags</a> |= <a class="code" href="group__LDLM.html#ga3845b64e7040a6d03323e5289bd71adc" title="this lock is being destroyed">LDLM_FL_CBPENDING</a> | <a class="code" href="group__LDLM.html#ga043b49bb5e4be85bb6a3937bb241aab1" title="It may happen that a client initiates two operations, e.g.">LDLM_FL_BL_AST</a>;
<a name="l00667"></a>00667                 <a class="code" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock.">unlock_res_and_lock</a>(lock);
<a name="l00668"></a>00668                 LDLM_DEBUG(lock, <span class="stringliteral">&quot;enqueue reply includes blocking AST&quot;</span>);
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="comment">/* If the lock has already been granted by a completion AST, don&apos;t</span>
<a name="l00672"></a>00672 <span class="comment">         * clobber the LVB with an older one. */</span>
<a name="l00673"></a>00673         <span class="keywordflow">if</span> (lvb_len &gt; 0) {
<a name="l00674"></a>00674                 <span class="comment">/* We must lock or a racing completion might update lvb without</span>
<a name="l00675"></a>00675 <span class="comment">                 * letting us know and we&apos;ll clobber the correct value.</span>
<a name="l00676"></a>00676 <span class="comment">                 * Cannot unlock after the check either, a that still leaves</span>
<a name="l00677"></a>00677 <span class="comment">                 * a tiny window for completion to get in */</span>
<a name="l00678"></a>00678                 <a class="code" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource.">lock_res_and_lock</a>(lock);
<a name="l00679"></a>00679                 <span class="keywordflow">if</span> (lock-&gt;<a class="code" href="structldlm__lock.html#a4c3ab4e1a3ec7f022d954251e6eafa67" title="Requested mode.">l_req_mode</a> != lock-&gt;<a class="code" href="structldlm__lock.html#a714ebd7977f069a111bf98aa7b202167" title="Granted mode, also protected by lr_lock.">l_granted_mode</a>)
<a name="l00680"></a>00680                         rc = ldlm_fill_lvb(lock, &amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>, RCL_SERVER,
<a name="l00681"></a>00681                                            lock-&gt;l_lvb_data, lvb_len);
<a name="l00682"></a>00682                 <a class="code" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock.">unlock_res_and_lock</a>(lock);
<a name="l00683"></a>00683                 <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00684"></a>00684                         cleanup_phase = 1;
<a name="l00685"></a>00685                         GOTO(cleanup, rc);
<a name="l00686"></a>00686                 }
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         <span class="keywordflow">if</span> (!is_replay) {
<a name="l00690"></a>00690                 rc = ldlm_lock_enqueue(ns, &amp;lock, NULL, flags);
<a name="l00691"></a>00691                 <span class="keywordflow">if</span> (lock-&gt;<a class="code" href="structldlm__lock.html#aa8070acdaa6bb825842083d710f8a935" title="Lock completion handler pointer.">l_completion_ast</a> != NULL) {
<a name="l00692"></a>00692                         <span class="keywordtype">int</span> err = lock-&gt;<a class="code" href="structldlm__lock.html#aa8070acdaa6bb825842083d710f8a935" title="Lock completion handler pointer.">l_completion_ast</a>(lock, *flags, NULL);
<a name="l00693"></a>00693                         <span class="keywordflow">if</span> (!rc)
<a name="l00694"></a>00694                                 rc = err;
<a name="l00695"></a>00695                         <span class="keywordflow">if</span> (rc)
<a name="l00696"></a>00696                                 cleanup_phase = 1;
<a name="l00697"></a>00697                 }
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keywordflow">if</span> (lvb_len &gt; 0 &amp;&amp; lvb != NULL) {
<a name="l00701"></a>00701                 <span class="comment">/* Copy the LVB here, and not earlier, because the completion</span>
<a name="l00702"></a>00702 <span class="comment">                 * AST (if any) can override what we got in the reply */</span>
<a name="l00703"></a>00703                 memcpy(lvb, lock-&gt;l_lvb_data, lvb_len);
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         LDLM_DEBUG(lock, <span class="stringliteral">&quot;client-side enqueue END&quot;</span>);
<a name="l00707"></a>00707         EXIT;
<a name="l00708"></a>00708 cleanup:
<a name="l00709"></a>00709         <span class="keywordflow">if</span> (cleanup_phase == 1 &amp;&amp; rc)
<a name="l00710"></a>00710                 failed_lock_cleanup(ns, lock, mode);
<a name="l00711"></a>00711         <span class="comment">/* Put lock 2 times, the second reference is held by ldlm_cli_enqueue */</span>
<a name="l00712"></a>00712         <a class="code" href="group__LDLM.html#ga5945b4d89a157c2e0fb6d955b3bf0c3f" title="Release a temporary lock reference obtained by ldlm_handle2lock() or __ldlm_handle2lock()...">LDLM_LOCK_PUT</a>(lock);
<a name="l00713"></a>00713         <a class="code" href="group__LDLM.html#gaf3357d35be5378aa299677e298c5a625" title="Release a lock reference obtained by some other means (see LDLM_LOCK_PUT()).">LDLM_LOCK_RELEASE</a>(lock);
<a name="l00714"></a>00714         <span class="keywordflow">return</span> rc;
<a name="l00715"></a>00715 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_cgraph.png" border="0" usemap="#group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_cgraph_map" id="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_cgraph">
<area shape="rect" id="node3" href="group__LDLM.html#ga0f272b273065dc0d916fcb5c6b61d656" title="Converts lock policy from on the wire lock_desc format to local format." alt="" coords="216,5,429,35"/><area shape="rect" id="node5" href="group__LDLM.html#gafd6a07a826f7d2789696e472dd81adc2" title="Moves LDLM lock lock to another resource." alt="" coords="221,109,424,139"/><area shape="rect" id="node9" href="group__LDLM.html#ga7ea7aa073d254d8500c07d2664cbecf9" title="Lock a lock and its resource." alt="" coords="487,56,625,85"/><area shape="rect" id="node11" href="group__LDLM.html#gaf9b19facd1a8bb3cdfcac5047159f15e" title="Unlock a lock and its resource previously locked with lock_res_and_lock." alt="" coords="479,163,633,192"/><area shape="rect" id="node14" href="group__req__layout.html#ga102a4e6bb0a627ead289f4684971fc28" title="Return the actual PTLRPC buffer length of a request or reply (loc) for the given..." alt="" coords="240,213,405,243"/><area shape="rect" id="node18" href="group__req__layout.html#ga0d1ad53a1914c35470f3916e4bb4b8fe" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC reply buffer..." alt="" coords="232,267,413,296"/><area shape="rect" id="node7" href="group__LDLM.html#ga083fb1ea92619c4b2e526633c3a486fb" title="Return a reference to resource with given name, creating it if necessary." alt="" coords="483,109,629,139"/><area shape="rect" id="node16" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="484,216,628,245"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_icgraph.png" border="0" usemap="#group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_icgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_icgraph_map" id="group__ldlm__cli__api_gac421005283912bb5186b035013aa58c0_icgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#gac3edcad1b11e283d6ef8455a2b598b07" title="Client&#45;side lock enqueue." alt="" coords="216,5,352,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="gabae59a7ebeed8c6fd60b22f03cf88e1f"></a><!-- doxytag: member="lustre_dlm.h::ldlm_prep_elc_req" ref="gabae59a7ebeed8c6fd60b22f03cf88e1f" args="(struct obd_export *exp, struct ptlrpc_request *req, int version, int opc, int canceloff, struct list_head *cancels, int count)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ldlm_prep_elc_req </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structobd__export.html">obd_export</a> *&nbsp;</td>
          <td class="paramname"> <em>exp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structptlrpc__request.html">ptlrpc_request</a> *&nbsp;</td>
          <td class="paramname"> <em>req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>version</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>opc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>canceloff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structlist__head.html">list_head</a> *&nbsp;</td>
          <td class="paramname"> <em>cancels</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>count</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Cancel LRU locks and pack them into the enqueue request. </p>
<p>Pack there the given <em>count</em> locks in <em>cancels</em>.</p>
<p>This is to be called by functions preparing their own requests that might contain lists of locks to cancel in addition to actual operation that needs to be performed. </p>

<p>Definition at line <a class="el" href="ldlm__request_8c_source.html#l00762">762</a> of file <a class="el" href="ldlm__request_8c_source.html">ldlm_request.c</a>.</p>

<p>References <a class="el" href="lustre__export_8h_source.html#l00209">obd_export::exp_obd</a>, <a class="el" href="ldlm__request_8c_source.html#l01917">ldlm_cli_cancel_list()</a>, <a class="el" href="client_8c_source.html#l00762">ptlrpc_request_pack()</a>, <a class="el" href="layout_8c_source.html#l02117">req_capsule_client_get()</a>, <a class="el" href="layout_8c_source.html#l01833">req_capsule_filled_sizes()</a>, <a class="el" href="layout_8c_source.html#l02226">req_capsule_set_size()</a>, and <a class="el" href="lustre__net_8h_source.html#l01121">ptlrpc_request::rq_pill</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00765"></a>00765         {
<a name="l00766"></a>00766         <span class="keyword">struct </span><a class="code" href="structldlm__namespace.html" title="LDLM Namespace.">ldlm_namespace</a>   *ns = exp-&gt;<a class="code" href="structobd__export.html#ab0e9778c418ab982cb6befb298b38368" title="Obd device of this export.">exp_obd</a>-&gt;obd_namespace;
<a name="l00767"></a>00767         <span class="keyword">struct </span><a class="code" href="structreq__capsule.html">req_capsule</a>      *pill = &amp;req-&gt;<a class="code" href="structptlrpc__request.html#ab7324f88fb8682a894baf36052f78da5" title="request format description">rq_pill</a>;
<a name="l00768"></a>00768         <span class="keyword">struct </span><a class="code" href="structldlm__request.html">ldlm_request</a>     *dlm = NULL;
<a name="l00769"></a>00769         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        head = LIST_HEAD_INIT(head);
<a name="l00770"></a>00770         <span class="keyword">enum</span> ldlm_lru_flags lru_flags;
<a name="l00771"></a>00771         <span class="keywordtype">int</span> avail, to_free, pack = 0;
<a name="l00772"></a>00772         <span class="keywordtype">int</span> rc;
<a name="l00773"></a>00773         ENTRY;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (cancels == NULL)
<a name="l00776"></a>00776                 cancels = &amp;head;
<a name="l00777"></a>00777         <span class="keywordflow">if</span> (ns_connect_cancelset(ns)) {
<a name="l00778"></a>00778                 <span class="comment">/* Estimate the amount of available space in the request. */</span>
<a name="l00779"></a>00779                 <a class="code" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&amp;#39;t been filled in yet.">req_capsule_filled_sizes</a>(pill, RCL_CLIENT);
<a name="l00780"></a>00780                 avail = ldlm_capsule_handles_avail(pill, RCL_CLIENT, canceloff);
<a name="l00781"></a>00781 
<a name="l00782"></a>00782                 lru_flags = ns_connect_lru_resize(ns) ?
<a name="l00783"></a>00783                         LDLM_LRU_FLAG_LRUR_NO_WAIT : LDLM_LRU_FLAG_AGED;
<a name="l00784"></a>00784                 to_free = !ns_connect_lru_resize(ns) &amp;&amp;
<a name="l00785"></a>00785                         opc == LDLM_ENQUEUE ? 1 : 0;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787                 <span class="comment">/* Cancel LRU locks here _only_ if the server supports</span>
<a name="l00788"></a>00788 <span class="comment">                 * EARLY_CANCEL. Otherwise we have to send extra CANCEL</span>
<a name="l00789"></a>00789 <span class="comment">                 * RPC, which will make us slower. */</span>
<a name="l00790"></a>00790                 <span class="keywordflow">if</span> (avail &gt; count)
<a name="l00791"></a>00791                         count += ldlm_cancel_lru_local(ns, cancels, to_free,
<a name="l00792"></a>00792                                                        avail - count, 0,
<a name="l00793"></a>00793                                                        lru_flags);
<a name="l00794"></a>00794                 <span class="keywordflow">if</span> (avail &gt; count)
<a name="l00795"></a>00795                         pack = count;
<a name="l00796"></a>00796                 <span class="keywordflow">else</span>
<a name="l00797"></a>00797                         pack = avail;
<a name="l00798"></a>00798                 <a class="code" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the...">req_capsule_set_size</a>(pill, &amp;RMF_DLM_REQ, RCL_CLIENT,
<a name="l00799"></a>00799                                      ldlm_request_bufsize(pack, opc));
<a name="l00800"></a>00800         }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802         rc = <a class="code" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps...">ptlrpc_request_pack</a>(req, version, opc);
<a name="l00803"></a>00803         <span class="keywordflow">if</span> (rc) {
<a name="l00804"></a>00804                 ldlm_lock_list_put(cancels, l_bl_ast, count);
<a name="l00805"></a>00805                 RETURN(rc);
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (ns_connect_cancelset(ns)) {
<a name="l00809"></a>00809                 <span class="keywordflow">if</span> (canceloff) {
<a name="l00810"></a>00810                         dlm = <a class="code" href="group__req__layout.html#ga0ecb097da2dfa5ac12ec0ef1f33d3e88" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC request buffer...">req_capsule_client_get</a>(pill, &amp;RMF_DLM_REQ);
<a name="l00811"></a>00811                         LASSERT(dlm);
<a name="l00812"></a>00812                         <span class="comment">/* Skip first lock handler in ldlm_request_pack(),</span>
<a name="l00813"></a>00813 <span class="comment">                         * this method will increment @lock_count according</span>
<a name="l00814"></a>00814 <span class="comment">                         * to the lock handle amount actually written to</span>
<a name="l00815"></a>00815 <span class="comment">                         * the buffer. */</span>
<a name="l00816"></a>00816                         dlm-&gt;lock_count = canceloff;
<a name="l00817"></a>00817                 }
<a name="l00818"></a>00818                 <span class="comment">/* Pack into the request @pack lock handles. */</span>
<a name="l00819"></a>00819                 <a class="code" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client-side locks from a list and send/prepare cancel RPCs to the server.">ldlm_cli_cancel_list</a>(cancels, pack, req, 0);
<a name="l00820"></a>00820                 <span class="comment">/* Prepare and send separate cancel RPC for others. */</span>
<a name="l00821"></a>00821                 <a class="code" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client-side locks from a list and send/prepare cancel RPCs to the server.">ldlm_cli_cancel_list</a>(cancels, count - pack, NULL, 0);
<a name="l00822"></a>00822         } <span class="keywordflow">else</span> {
<a name="l00823"></a>00823                 ldlm_lock_list_put(cancels, l_bl_ast, count);
<a name="l00824"></a>00824         }
<a name="l00825"></a>00825         RETURN(0);
<a name="l00826"></a>00826 }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__ldlm__cli__api_gabae59a7ebeed8c6fd60b22f03cf88e1f_cgraph.png" border="0" usemap="#group__ldlm__cli__api_gabae59a7ebeed8c6fd60b22f03cf88e1f_cgraph_map" alt=""></div>
<map name="group__ldlm__cli__api_gabae59a7ebeed8c6fd60b22f03cf88e1f_cgraph_map" id="group__ldlm__cli__api_gabae59a7ebeed8c6fd60b22f03cf88e1f_cgraph">
<area shape="rect" id="node3" href="group__ldlm__cli__api.html#ga96adcececc3c547888075de942fa1872" title="Cancel client&#45;side locks from a list and send/prepare cancel RPCs to the server." alt="" coords="213,245,360,275"/><area shape="rect" id="node63" href="group__net.html#gaa1d6f5834629cf755c8f1f0b1a4349de" title="Pack request buffers for network transfer, performing necessary encryption steps..." alt="" coords="648,323,805,352"/><area shape="rect" id="node76" href="group__req__layout.html#gab0f7a8e2a51867454ce8f87bb48b0f77" title="Fills in any parts of the rc_area of a pill that haven&#39;t been filled in yet." alt="" coords="636,376,817,405"/><area shape="rect" id="node78" href="group__req__layout.html#ga6d0a3a11367bcd9fe40dc723243e7b0d" title="Set the size of the PTLRPC request/reply (loc) buffer for the given field of the..." alt="" coords="644,429,809,459"/><area shape="rect" id="node81" href="group__req__layout.html#ga0ecb097da2dfa5ac12ec0ef1f33d3e88" title="Trivial wrapper around __req_capsule_get(), that returns the PTLRPC request buffer..." alt="" coords="197,479,376,508"/><area shape="rect" id="node5" href="group__ldlm__cli__api.html#ga677e9f9ff5fbe2174b139fe8c2b77b70" title="Prepare and send a batched cancel RPC." alt="" coords="425,244,575,273"/><area shape="rect" id="node7" href="group__net.html#ga476170376a6f1bb9bb7f85ade4c774f7" title="Set server timelimit for this req, i.e." alt="" coords="625,165,828,195"/><area shape="rect" id="node9" href="group__net.html#ga003cd2f0c09fd578821500e8084f8c48" title="Send request and wait until it completes." alt="" coords="653,269,800,299"/><area shape="rect" id="node19" href="group__net.html#gaf16bb640b9f0c667d79b7254ac965288" title="Drops one reference count for a request." alt="" coords="1593,139,1740,168"/><area shape="rect" id="node59" href="group__net.html#ga2bf080a905f488f676248838514e264a" title="Allocate new request structure for import imp and initialize its buffer structure..." alt="" coords="648,5,805,35"/><area shape="rect" id="node61" href="group__net.html#ga35e91945e5dfe7314c1b31519907929f" title="For requests not from pool, free memory of the request structure." alt="" coords="649,59,804,88"/><area shape="rect" id="node74" href="group__net.html#gad8a1fd19f62cb6e52ee2b145c63f5dd1" title="Requests that are added to the ptlrpcd queue are sent via ptlrpcd_check&#45;&gt;ptlrpc_check_set()..." alt="" coords="663,112,791,141"/><area shape="rect" id="node11" href="group__net.html#ga7e29af1c85aba7368cea369f091d09b4" title="Allocate and initialize new request set structure on the current CPT." alt="" coords="889,295,1017,324"/><area shape="rect" id="node13" href="group__net.html#ga60499b3efd5caf2e7bc59c308332aff3" title="Grab additional reference on a request req." alt="" coords="1581,611,1752,640"/><area shape="rect" id="node15" href="group__net.html#ga5da56461932d974b4c2487f179d8e6d8" title="Add a new request to the general purpose request set." alt="" coords="879,401,1028,431"/><area shape="rect" id="node17" href="group__net.html#ga862d0349489e1b216f7b1be96ac3baf8" title="Wind down and free request set structure previously allocated with ptlrpc_prep_set..." alt="" coords="1101,244,1251,273"/><area shape="rect" id="node21" href="group__net.html#gac072432ff0e3366be99c8456895e28d1" title="Send all unset request from the set and then wait untill all requests in the set..." alt="" coords="891,348,1016,377"/><area shape="rect" id="node23" href="group__net.html#ga63613680c8953223c8efc4331656b11a" title="this sends any unsent RPCs in set and returns 1 if all are sent and no more replies..." alt="" coords="1107,348,1245,377"/><area shape="rect" id="node25" href="group__net.html#ga52f0aef010b62759e4c2f9e6ef6aea3d" title="Send request request." alt="" coords="1361,347,1468,376"/><area shape="rect" id="node40" href="group__net.html#gaea9a5e62d5d55ace491db905c9a474f7" title="Disconnect a bulk desc from the network." alt="" coords="1581,504,1752,533"/><area shape="rect" id="node50" href="group__sptlrpc.html#ga94cbed545313e8c7bc6a682a438c89b0" title="To refresh the context of , if it&#39;s not up&#45;to&#45;date." alt="" coords="1324,451,1505,480"/><area shape="rect" id="node27" href="group__lnet__md.html#ga958972d35fc04d0716f4f6b71cd804fc" title="Create a memory descriptor and attach it to a ME." alt="" coords="1845,360,1971,389"/><area shape="rect" id="node29" href="group__lnet__me.html#ga581025ed43fdf21741691e82253b1b50" title="Create and attach a match entry to the match list of portal." alt="" coords="1847,204,1969,233"/><area shape="rect" id="node31" href="group__lnet__me.html#gad38e0c2462a6e9a1735783c853345422" title="Unlink a match entry from its match list." alt="" coords="1851,283,1965,312"/><area shape="rect" id="node33" href="group__net.html#gaa1cf14602e33836d92101141c3a0d67d" title="Actual interfacing with LNet to put/get/register/unregister stuff." alt="" coords="1589,243,1744,272"/><area shape="rect" id="node42" href="group__sptlrpc.html#ga2059ff503d15d0b06699e153845bc66f" title="Used by ptlrpc client to allocate reply buffer of req." alt="" coords="1579,347,1755,376"/><area shape="rect" id="node44" href="group__sptlrpc.html#ga2b508842c18d6c0a32c9678445565ce2" title="Used by ptlrpc client, to perform the pre&#45;defined security transformation upon the..." alt="" coords="1573,451,1760,480"/><area shape="rect" id="node46" href="group__sptlrpc.html#gae9ac9239c38fc5eb10c0951976a38512" title="Perform transformation upon bulk data pointed by desc." alt="" coords="1828,451,1988,480"/><area shape="rect" id="node52" href="group__sptlrpc.html#ga7254cf32b0cefed6242f298d3326e8dd" title="If current context of req is dead somehow, e.g." alt="" coords="1555,557,1779,587"/><area shape="rect" id="node54" href="group__sptlrpc.html#ga5aafb085a9167ed0295a28d4bddb5847" title="Given a req, find or allocate an appropriate context for it." alt="" coords="1829,531,1987,560"/><area shape="rect" id="node56" href="group__sptlrpc.html#ga9c506dfa976b8fa42f6d351f1a67098c" title="Drop the context for req." alt="" coords="1829,584,1987,613"/><area shape="rect" id="node65" href="group__req__layout.html#gaf42efe506903884592711902e9276e99" title="This function shrinks the size of the _buffer_ of the pill&#39;s PTLRPC request or..." alt="" coords="880,581,1027,611"/><area shape="rect" id="node67" href="group__net.html#ga8ddfe4bfdb34b2159b8281fb3c6e09a4" title="lustre_msg_buflen &#45; return the length of buffer n in message m " alt="" coords="1104,555,1248,584"/><area shape="rect" id="node69" href="group__req__layout.html#gad281812fde0bdb0aaaed8a022e0008f2" title="Returns a non&#45;zero value if the given field is present in the given pill&#39;s PTLRPC..." alt="" coords="1077,659,1275,688"/><area shape="rect" id="node71" href="group__req__layout.html#ga35302dbfc2517d692579948a9742d3ba" title="This function returns a non&#45;zero value if the given field is present in the format..." alt="" coords="1332,632,1497,661"/></map>
</div>
</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:55:43 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
