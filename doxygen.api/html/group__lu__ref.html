<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lu_ref</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>lu_ref</h1>
<p>An interface to track references between objects.  
<a href="#_details">More...</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlu__ref.html">lu_ref</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlu__ref__link.html">lu_ref_link</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>An interface to track references between objects. </p>
<p>Mostly for debugging.</p>
<p>Suppose there is a reference counted data-structure struct foo. To track who acquired references to instance of struct foo, add <a class="el" href="structlu__ref.html">lu_ref</a> field to it:</p>
<div class="fragment"><pre class="fragment">         <span class="keyword">struct </span>foo {
                 atomic_t      foo_refcount;
                 <span class="keyword">struct </span><a class="code" href="structlu__ref.html">lu_ref</a> foo_reference;
                 ...
         };
</pre></div><p>foo::foo_reference has to be initialized by calling lu_ref_init(). Typically there will be functions or macros to increment and decrement foo::foo_refcount, let's say they are foo_get(struct foo *foo) and foo_put(struct foo *foo), respectively.</p>
<p>Whenever foo_get() is called to acquire a reference on a foo, lu_ref_add() has to be called to insert into foo::foo_reference a record, describing acquired reference. Dually, lu_ref_del() removes matching record. Typical usages are:</p>
<div class="fragment"><pre class="fragment">        <span class="keyword">struct </span>bar *bar;

        <span class="comment">// bar owns a reference to foo.</span>
        bar-&gt;bar_foo = foo_get(foo);
        lu_ref_add(&amp;foo-&gt;foo_reference, <span class="stringliteral">&quot;bar&quot;</span>, bar);

        ...

        <span class="comment">// reference from bar to foo is released.</span>
        lu_ref_del(&amp;foo-&gt;foo_reference, <span class="stringliteral">&quot;bar&quot;</span>, bar);
        foo_put(bar-&gt;bar_foo);


        <span class="comment">// current thread acquired a temporary reference to foo.</span>
        foo_get(foo);
        lu_ref_add(&amp;foo-&gt;reference, __FUNCTION__, current);

        ...

        <span class="comment">// temporary reference is released.</span>
        lu_ref_del(&amp;foo-&gt;reference, __FUNCTION__, current);
        foo_put(foo);
</pre></div><p><em>Et</em> <em>cetera</em>. Often it makes sense to include lu_ref_add() and lu_ref_del() calls into foo_get() and foo_put(). When an instance of struct foo is destroyed, lu_ref_fini() has to be called that checks that no pending references remain. lu_ref_print() can be used to dump a list of pending references, while hunting down a leak.</p>
<p>For objects to which a large number of references can be acquired, lu_ref_del() can become cpu consuming, as it has to scan the list of references. To work around this, remember result of lu_ref_add() (usually in the same place where pointer to struct foo is stored), and use lu_ref_del_at():</p>
<div class="fragment"><pre class="fragment">        <span class="comment">// There is a large number of bar&apos;s for a single foo.</span>
        bar-&gt;bar_foo     = foo_get(foo);
        bar-&gt;bar_foo_ref = lu_ref_add(&amp;foo-&gt;foo_reference, <span class="stringliteral">&quot;bar&quot;</span>, bar);

        ...

        <span class="comment">// reference from bar to foo is released.</span>
        lu_ref_del_at(&amp;foo-&gt;foo_reference, bar-&gt;bar_foo_ref, <span class="stringliteral">&quot;bar&quot;</span>, bar);
        foo_put(bar-&gt;bar_foo);
</pre></div><p><a class="el" href="structlu__ref.html">lu_ref</a> interface degrades gracefully in case of memory shortages. </p>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:55:39 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
