<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/include/lustre_import.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/include/lustre_import.h</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00011"></a>00011 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00013"></a>00013 <span class="comment"> * General Public License version 2 for more details (a copy is included</span>
<a name="l00014"></a>00014 <span class="comment"> * in the LICENSE file that accompanied this code).</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * version 2 along with this program; If not, see</span>
<a name="l00018"></a>00018 <span class="comment"> * http://www.sun.com/software/products/lustre/docs/GPLv2.pdf</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,</span>
<a name="l00021"></a>00021 <span class="comment"> * CA 95054 USA or visit www.sun.com if you need additional information or</span>
<a name="l00022"></a>00022 <span class="comment"> * have any questions.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * GPL HEADER END</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 <span class="comment">/*</span>
<a name="l00027"></a>00027 <span class="comment"> * Copyright (c) 2002, 2010, Oracle and/or its affiliates. All rights reserved.</span>
<a name="l00028"></a>00028 <span class="comment"> * Use is subject to license terms.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Copyright (c) 2011, 2014, Intel Corporation.</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * This file is part of Lustre, http://www.lustre.org/</span>
<a name="l00034"></a>00034 <span class="comment"> * Lustre is a trademark of Sun Microsystems, Inc.</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#ifndef __IMPORT_H</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#define __IMPORT_H</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;lustre_handles.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;lustre/lustre_idl.h&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00059"></a><a class="code" href="group__export.html#ga1e9af31f1c737a82f0c1fb7dac29a322">00059</a> <span class="preprocessor">#define D_ADAPTTO D_OTHER</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#define AT_BINS 4                  </span><span class="comment">/* &quot;bin&quot; means &quot;N seconds of history&quot; */</span>
<a name="l00061"></a>00061 <span class="preprocessor">#define AT_FLG_NOHIST 0x1          </span><span class="comment">/* use last reported value only */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="structadaptive__timeout.html">00063</a> <span class="keyword">struct </span><a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> {
<a name="l00064"></a>00064         time_t          at_binstart;         <span class="comment">/* bin start time */</span>
<a name="l00065"></a>00065         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    at_hist[AT_BINS];    <span class="comment">/* timeout history bins */</span>
<a name="l00066"></a>00066         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    at_flags;
<a name="l00067"></a>00067         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    at_current;          <span class="comment">/* current timeout value */</span>
<a name="l00068"></a>00068         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    at_worst_ever;       <span class="comment">/* worst-ever timeout value */</span>
<a name="l00069"></a>00069         time_t          at_worst_time;       <span class="comment">/* worst-ever timeout timestamp */</span>
<a name="l00070"></a>00070         spinlock_t      at_lock;
<a name="l00071"></a>00071 };
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="keyword">enum</span> lustre_at_flags {
<a name="l00074"></a>00074         LATF_SKIP       = 0x0,
<a name="l00075"></a>00075         LATF_STATS      = 0x1,
<a name="l00076"></a>00076 };
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="structptlrpc__at__array.html">00078</a> <span class="keyword">struct </span><a class="code" href="structptlrpc__at__array.html">ptlrpc_at_array</a> {
<a name="l00079"></a>00079         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a> *paa_reqs_array; 
<a name="l00080"></a><a class="code" href="structptlrpc__at__array.html#a4dd5aef596a563237a418ca153585cb4">00080</a>         __u32             <a class="code" href="structptlrpc__at__array.html#a4dd5aef596a563237a418ca153585cb4" title="array to hold requests">paa_size</a>;       
<a name="l00081"></a><a class="code" href="structptlrpc__at__array.html#aa2bee8a89fa940c5c5e62575c22eac19">00081</a>         __u32             <a class="code" href="structptlrpc__at__array.html#aa2bee8a89fa940c5c5e62575c22eac19" title="the size of array">paa_count</a>;      
<a name="l00082"></a><a class="code" href="structptlrpc__at__array.html#ad19d85164de63497bcd5fb2c6b1cec7e">00082</a>         time_t            <a class="code" href="structptlrpc__at__array.html#ad19d85164de63497bcd5fb2c6b1cec7e" title="the total count of reqs">paa_deadline</a>;   
<a name="l00083"></a><a class="code" href="structptlrpc__at__array.html#a6ecae0960a0175e315894e5c36e91a59">00083</a>         __u32            *<a class="code" href="structptlrpc__at__array.html#a6ecae0960a0175e315894e5c36e91a59" title="the earliest deadline of reqs">paa_reqs_count</a>; 
<a name="l00084"></a>00084 };
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="preprocessor">#define IMP_AT_MAX_PORTALS 8</span>
<a name="l00087"></a><a class="code" href="structimp__at.html">00087</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structimp__at.html">imp_at</a> {
<a name="l00088"></a>00088         <span class="keywordtype">int</span>                     iat_portal[IMP_AT_MAX_PORTALS];
<a name="l00089"></a>00089         <span class="keyword">struct </span><a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> iat_net_latency;
<a name="l00090"></a>00090         <span class="keyword">struct </span><a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> iat_service_estimate[IMP_AT_MAX_PORTALS];
<a name="l00091"></a>00091 };
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 
<a name="l00097"></a><a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0">00097</a> <span class="keyword">enum</span> <a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0" title="Possible import states.">lustre_imp_state</a> {
<a name="l00098"></a>00098         LUSTRE_IMP_CLOSED     = 1,
<a name="l00099"></a>00099         LUSTRE_IMP_NEW        = 2,
<a name="l00100"></a>00100         LUSTRE_IMP_DISCON     = 3,
<a name="l00101"></a>00101         LUSTRE_IMP_CONNECTING = 4,
<a name="l00102"></a>00102         LUSTRE_IMP_REPLAY     = 5,
<a name="l00103"></a>00103         LUSTRE_IMP_REPLAY_LOCKS = 6,
<a name="l00104"></a>00104         LUSTRE_IMP_REPLAY_WAIT  = 7,
<a name="l00105"></a>00105         LUSTRE_IMP_RECOVER    = 8,
<a name="l00106"></a>00106         LUSTRE_IMP_FULL       = 9,
<a name="l00107"></a>00107         LUSTRE_IMP_EVICTED    = 10,
<a name="l00108"></a>00108 };
<a name="l00109"></a>00109 
<a name="l00111"></a>00111 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">char</span> * ptlrpc_import_state_name(<span class="keyword">enum</span> <a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0" title="Possible import states.">lustre_imp_state</a> state)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113         <span class="keyword">static</span> <span class="keywordtype">char</span>* import_state_names[] = {
<a name="l00114"></a>00114                 <span class="stringliteral">&quot;&lt;UNKNOWN&gt;&quot;</span>, <span class="stringliteral">&quot;CLOSED&quot;</span>,  <span class="stringliteral">&quot;NEW&quot;</span>, <span class="stringliteral">&quot;DISCONN&quot;</span>,
<a name="l00115"></a>00115                 <span class="stringliteral">&quot;CONNECTING&quot;</span>, <span class="stringliteral">&quot;REPLAY&quot;</span>, <span class="stringliteral">&quot;REPLAY_LOCKS&quot;</span>, <span class="stringliteral">&quot;REPLAY_WAIT&quot;</span>,
<a name="l00116"></a>00116                 <span class="stringliteral">&quot;RECOVER&quot;</span>, <span class="stringliteral">&quot;FULL&quot;</span>, <span class="stringliteral">&quot;EVICTED&quot;</span>,
<a name="l00117"></a>00117         };
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         LASSERT (state &lt;= LUSTRE_IMP_EVICTED);
<a name="l00120"></a>00120         <span class="keywordflow">return</span> import_state_names[state];
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00126"></a><a class="code" href="group__export.html#ga25e24f2ae3efcc8caa89c9e6c4c47d31">00126</a> <span class="keyword">enum</span> <a class="code" href="group__export.html#ga25e24f2ae3efcc8caa89c9e6c4c47d31" title="List of import event types.">obd_import_event</a> {
<a name="l00127"></a>00127         IMP_EVENT_DISCON     = 0x808001,
<a name="l00128"></a>00128         IMP_EVENT_INACTIVE   = 0x808002,
<a name="l00129"></a>00129         IMP_EVENT_INVALIDATE = 0x808003,
<a name="l00130"></a>00130         IMP_EVENT_ACTIVE     = 0x808004,
<a name="l00131"></a>00131         IMP_EVENT_OCD        = 0x808005,
<a name="l00132"></a>00132         IMP_EVENT_DEACTIVATE = 0x808006,
<a name="l00133"></a>00133         IMP_EVENT_ACTIVATE   = 0x808007,
<a name="l00134"></a>00134 };
<a name="l00135"></a>00135 
<a name="l00139"></a><a class="code" href="structobd__import__conn.html">00139</a> <span class="keyword">struct </span><a class="code" href="structobd__import__conn.html" title="Definition of import connection structure.">obd_import_conn</a> {
<a name="l00141"></a><a class="code" href="structobd__import__conn.html#af3d6c3ee5b8330992011e80166139852">00141</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>          <a class="code" href="structobd__import__conn.html#af3d6c3ee5b8330992011e80166139852" title="Item for linking connections together.">oic_item</a>;
<a name="l00143"></a><a class="code" href="structobd__import__conn.html#a73f74384e80a76791a76e9c19ac38f55">00143</a>         <span class="keyword">struct </span><a class="code" href="structptlrpc__connection.html" title="Structure to single define portal connection.">ptlrpc_connection</a> *<a class="code" href="structobd__import__conn.html#a73f74384e80a76791a76e9c19ac38f55" title="Pointer to actual PortalRPC connection.">oic_conn</a>;
<a name="l00145"></a><a class="code" href="structobd__import__conn.html#ab1781dad90184103cfefe6aa82221d63">00145</a>         <span class="keyword">struct </span><a class="code" href="structobd__uuid.html">obd_uuid</a>           <a class="code" href="structobd__import__conn.html#ab1781dad90184103cfefe6aa82221d63" title="uuid of remote side">oic_uuid</a>;
<a name="l00149"></a><a class="code" href="structobd__import__conn.html#a58e364a0d9839cd6ee3300e0d98dfaf8">00149</a>         __u64                     <a class="code" href="structobd__import__conn.html#a58e364a0d9839cd6ee3300e0d98dfaf8" title="Time (64 bit jiffies) of last connection attempt on this connection.">oic_last_attempt</a>;
<a name="l00150"></a>00150 };
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="comment">/* state history */</span>
<a name="l00153"></a>00153 <span class="preprocessor">#define IMP_STATE_HIST_LEN 16</span>
<a name="l00154"></a><a class="code" href="structimport__state__hist.html">00154</a> <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="structimport__state__hist.html">import_state_hist</a> {
<a name="l00155"></a>00155         <span class="keyword">enum</span> <a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0" title="Possible import states.">lustre_imp_state</a> ish_state;
<a name="l00156"></a>00156         time_t                ish_time;
<a name="l00157"></a>00157 };
<a name="l00158"></a>00158 
<a name="l00163"></a><a class="code" href="structobd__import.html">00163</a> <span class="keyword">struct </span><a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> {
<a name="l00165"></a><a class="code" href="structobd__import.html#ad00990644d0c89409927e2cc4d831fe8">00165</a>         <span class="keyword">struct </span><a class="code" href="structportals__handle.html">portals_handle</a>     <a class="code" href="structobd__import.html#ad00990644d0c89409927e2cc4d831fe8" title="Local handle (== id) for this import.">imp_handle</a>;
<a name="l00167"></a><a class="code" href="structobd__import.html#acae73076e69bf46621fa9b6dd0603a48">00167</a>         atomic_t                  <a class="code" href="structobd__import.html#acae73076e69bf46621fa9b6dd0603a48" title="Reference counter.">imp_refcount</a>;
<a name="l00168"></a>00168         <span class="keyword">struct </span><a class="code" href="structlustre__handle.html">lustre_handle</a>      imp_dlm_handle; <span class="comment">/* client&apos;s ldlm export */</span>
<a name="l00170"></a><a class="code" href="structobd__import.html#af8d2d08c0e13cf532ff05d8fddccb16e">00170</a>         <span class="keyword">struct </span><a class="code" href="structptlrpc__connection.html" title="Structure to single define portal connection.">ptlrpc_connection</a> *<a class="code" href="structobd__import.html#af8d2d08c0e13cf532ff05d8fddccb16e" title="Currently active connection.">imp_connection</a>;
<a name="l00172"></a><a class="code" href="structobd__import.html#af77cd16d5a2cce0fc30b9950937ee940">00172</a>         <span class="keyword">struct </span><a class="code" href="structptlrpc__client.html" title="Client definition for PortalRPC.">ptlrpc_client</a>     *<a class="code" href="structobd__import.html#af77cd16d5a2cce0fc30b9950937ee940" title="PortalRPC client structure for this import.">imp_client</a>;
<a name="l00174"></a><a class="code" href="structobd__import.html#a9e1557add25b640fe9a8c193d799ac0c">00174</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>          <a class="code" href="structobd__import.html#a9e1557add25b640fe9a8c193d799ac0c" title="List element for linking into pinger chain.">imp_pinger_chain</a>;
<a name="l00176"></a><a class="code" href="structobd__import.html#a2c7d2711792f8c3a958b76afc77fb993">00176</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>          <a class="code" href="structobd__import.html#a2c7d2711792f8c3a958b76afc77fb993" title="List element for linking into chain for destruction.">imp_zombie_chain</a>;
<a name="l00177"></a>00177 
<a name="l00183"></a><a class="code" href="structobd__import.html#ae3f32574c5a9b068001d451c8506ef7b">00183</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structobd__import.html#ae3f32574c5a9b068001d451c8506ef7b" title="Lists of requests that are retained for replay, waiting for a reply, or waiting for...">imp_replay_list</a>;
<a name="l00184"></a>00184         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        imp_sending_list;
<a name="l00185"></a>00185         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        imp_delayed_list;
<a name="l00195"></a><a class="code" href="structobd__import.html#a05271cb9def4ce64191d4d7089fa831c">00195</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structobd__import.html#a05271cb9def4ce64191d4d7089fa831c" title="List of requests that are retained for committed open replay.">imp_committed_list</a>;
<a name="l00196"></a>00196         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        *imp_replay_cursor;
<a name="l00200"></a><a class="code" href="structobd__import.html#a0ff3d0b8eb357f7d3904ec7732fbd416">00200</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structobd__import.html#a0ff3d0b8eb357f7d3904ec7732fbd416" title="List of not replied requests.">imp_unreplied_list</a>;
<a name="l00202"></a><a class="code" href="structobd__import.html#a3581a8b4f15a6d9ba6daad54873cd0eb">00202</a>         __u64                   <a class="code" href="structobd__import.html#a3581a8b4f15a6d9ba6daad54873cd0eb" title="Known maximal replied XID.">imp_known_replied_xid</a>;
<a name="l00203"></a>00203 
<a name="l00205"></a><a class="code" href="structobd__import.html#a8f00f6e006a7f308a71654b3e067a4af">00205</a>         <span class="keyword">struct </span><a class="code" href="structobd__device.html">obd_device</a>       *<a class="code" href="structobd__import.html#a8f00f6e006a7f308a71654b3e067a4af" title="obd device for this import">imp_obd</a>;
<a name="l00206"></a>00206 
<a name="l00211"></a><a class="code" href="structobd__import.html#aafb0b9080ca250979c2f31495eaf40be">00211</a>         <span class="keyword">struct </span><a class="code" href="structptlrpc__sec.html" title="The ptlrpc_sec represents the client side ptlrpc security facilities, each obd_import...">ptlrpc_sec</a>        *<a class="code" href="structobd__import.html#aafb0b9080ca250979c2f31495eaf40be" title="some seciruty-related fields">imp_sec</a>;
<a name="l00212"></a>00212         <span class="keyword">struct </span>mutex              imp_sec_mutex;
<a name="l00213"></a>00213         cfs_time_t                imp_sec_expire;
<a name="l00217"></a><a class="code" href="structobd__import.html#a43b896a006360181311cd5c246bd7c8b">00217</a>         wait_queue_head_t         <a class="code" href="structobd__import.html#a43b896a006360181311cd5c246bd7c8b" title="Wait queue for those who need to wait for recovery completion.">imp_recovery_waitq</a>;
<a name="l00218"></a>00218 
<a name="l00220"></a><a class="code" href="structobd__import.html#aece380c78562b6b0ddbfb1b5460fcbb2">00220</a>         atomic_t                  <a class="code" href="structobd__import.html#aece380c78562b6b0ddbfb1b5460fcbb2" title="Number of requests currently in-flight.">imp_inflight</a>;
<a name="l00222"></a><a class="code" href="structobd__import.html#a7486b4c70db32e592a5f7310a0f9539b">00222</a>         atomic_t                  <a class="code" href="structobd__import.html#a7486b4c70db32e592a5f7310a0f9539b" title="Number of requests currently unregistering.">imp_unregistering</a>;
<a name="l00224"></a><a class="code" href="structobd__import.html#a128f8537a5590b089f0b0155f80674ab">00224</a>         atomic_t                  <a class="code" href="structobd__import.html#a128f8537a5590b089f0b0155f80674ab" title="Number of replay requests inflight.">imp_replay_inflight</a>;
<a name="l00226"></a><a class="code" href="structobd__import.html#a46e3ad7c714327418fb7dc74ae1b84ae">00226</a>         atomic_t                  <a class="code" href="structobd__import.html#a46e3ad7c714327418fb7dc74ae1b84ae" title="Number of currently happening import invalidations.">imp_inval_count</a>;
<a name="l00228"></a><a class="code" href="structobd__import.html#ac85d638b38be23357799a2fc444eb585">00228</a>         atomic_t                  <a class="code" href="structobd__import.html#ac85d638b38be23357799a2fc444eb585" title="Numbner of request timeouts.">imp_timeouts</a>;
<a name="l00230"></a><a class="code" href="structobd__import.html#affb65aaaf26d991850c45fda2049f2a5">00230</a>         <span class="keyword">enum</span> <a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0" title="Possible import states.">lustre_imp_state</a>     <a class="code" href="structobd__import.html#affb65aaaf26d991850c45fda2049f2a5" title="Current import state.">imp_state</a>;
<a name="l00232"></a><a class="code" href="structobd__import.html#af1687234e8885545186fdf0061d7da6b">00232</a>         <span class="keyword">enum</span> <a class="code" href="group__export.html#ga342f8de0ae2ad4b6cb54d4072d7a97a0" title="Possible import states.">lustre_imp_state</a>     <a class="code" href="structobd__import.html#af1687234e8885545186fdf0061d7da6b" title="Last replay state.">imp_replay_state</a>;
<a name="l00234"></a><a class="code" href="structobd__import.html#a90518f381f6bbf29942515adada4ef68">00234</a>         <span class="keyword">struct </span><a class="code" href="structimport__state__hist.html">import_state_hist</a>  <a class="code" href="structobd__import.html#a90518f381f6bbf29942515adada4ef68" title="History of import states.">imp_state_hist</a>[IMP_STATE_HIST_LEN];
<a name="l00235"></a>00235         <span class="keywordtype">int</span>                       imp_state_hist_idx;
<a name="l00237"></a><a class="code" href="structobd__import.html#a37ffba6837dd8612475a9ea4d5bb939c">00237</a>         <span class="keywordtype">int</span>                       <a class="code" href="structobd__import.html#a37ffba6837dd8612475a9ea4d5bb939c" title="Current import generation.">imp_generation</a>;
<a name="l00239"></a><a class="code" href="structobd__import.html#ac3b8409237b9f6fc17e80bdfed39a1d5">00239</a>         __u32                     <a class="code" href="structobd__import.html#ac3b8409237b9f6fc17e80bdfed39a1d5" title="Incremented every time we send reconnection request.">imp_conn_cnt</a>;
<a name="l00244"></a><a class="code" href="structobd__import.html#a53945e09c13c835d35ac9c6a4e4c8b5a">00244</a>         <span class="keywordtype">int</span>                       <a class="code" href="structobd__import.html#a53945e09c13c835d35ac9c6a4e4c8b5a">imp_last_generation_checked</a>;
<a name="l00246"></a><a class="code" href="structobd__import.html#acd37763bff74f567dfdf875f87b52f13">00246</a>         __u64                     <a class="code" href="structobd__import.html#acd37763bff74f567dfdf875f87b52f13" title="Last tranno we replayed.">imp_last_replay_transno</a>;
<a name="l00248"></a><a class="code" href="structobd__import.html#a386b654673fa0ed7ef5a1ea90bd0a0cb">00248</a>         __u64                     <a class="code" href="structobd__import.html#a386b654673fa0ed7ef5a1ea90bd0a0cb" title="Last transno committed on remote side.">imp_peer_committed_transno</a>;
<a name="l00255"></a><a class="code" href="structobd__import.html#a3211da741142c7d7c6997a88825ab6da">00255</a>         __u64                     <a class="code" href="structobd__import.html#a3211da741142c7d7c6997a88825ab6da">imp_last_transno_checked</a>;
<a name="l00260"></a><a class="code" href="structobd__import.html#a0b8bb1da93c9c21f85044d87a7104a4e">00260</a>         <span class="keyword">struct </span><a class="code" href="structlustre__handle.html">lustre_handle</a>      <a class="code" href="structobd__import.html#a0b8bb1da93c9c21f85044d87a7104a4e" title="Remote export handle.">imp_remote_handle</a>;
<a name="l00262"></a><a class="code" href="structobd__import.html#a1fea11d0ec02c60eb95f325f76d7f9b2">00262</a>         cfs_time_t                <a class="code" href="structobd__import.html#a1fea11d0ec02c60eb95f325f76d7f9b2" title="When to perform next ping.">imp_next_ping</a>;
<a name="l00264"></a><a class="code" href="structobd__import.html#a21e32055b6dfcbb081f539ee0f645976">00264</a>         __u64                     <a class="code" href="structobd__import.html#a21e32055b6dfcbb081f539ee0f645976" title="When we last successfully connected.">imp_last_success_conn</a>;
<a name="l00265"></a>00265 
<a name="l00267"></a><a class="code" href="structobd__import.html#a6a268202c5cd1a1e69b92f10355c81e5">00267</a>         <span class="keyword">struct </span><a class="code" href="structlist__head.html">list_head</a>        <a class="code" href="structobd__import.html#a6a268202c5cd1a1e69b92f10355c81e5" title="List of all possible connection for import.">imp_conn_list</a>;
<a name="l00271"></a><a class="code" href="structobd__import.html#a336e5e8efc128fa81803a61404bb8548">00271</a>         <span class="keyword">struct </span><a class="code" href="structobd__import__conn.html" title="Definition of import connection structure.">obd_import_conn</a>   *<a class="code" href="structobd__import.html#a336e5e8efc128fa81803a61404bb8548" title="Current connection.">imp_conn_current</a>;
<a name="l00272"></a>00272 
<a name="l00274"></a><a class="code" href="structobd__import.html#a09a565a2b8f619c888dd51cd673fdffb">00274</a>         spinlock_t                <a class="code" href="structobd__import.html#a09a565a2b8f619c888dd51cd673fdffb" title="Protects flags, level, generation, conn_cnt, *_list.">imp_lock</a>;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="comment">/* flags */</span>
<a name="l00277"></a>00277         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>             imp_no_timeout:1, <span class="comment">/* timeouts are disabled */</span>
<a name="l00278"></a>00278                                   imp_invalid:1,    <span class="comment">/* evicted */</span>
<a name="l00279"></a>00279                                   <span class="comment">/* administratively disabled */</span>
<a name="l00280"></a>00280                                   imp_deactive:1,
<a name="l00281"></a>00281                                   <span class="comment">/* try to recover the import */</span>
<a name="l00282"></a>00282                                   imp_replayable:1,
<a name="l00283"></a>00283                                   <span class="comment">/* don&apos;t run recovery (timeout instead) */</span>
<a name="l00284"></a>00284                                   imp_dlm_fake:1,
<a name="l00285"></a>00285                                   <span class="comment">/* use 1/2 timeout on MDS&apos; OSCs */</span>
<a name="l00286"></a>00286                                   imp_server_timeout:1,
<a name="l00287"></a>00287                                   <span class="comment">/* VBR: imp in delayed recovery */</span>
<a name="l00288"></a>00288                                   imp_delayed_recovery:1,
<a name="l00289"></a>00289                                   <span class="comment">/* VBR: if gap was found then no lock replays</span>
<a name="l00290"></a>00290 <span class="comment">                                   */</span>
<a name="l00291"></a>00291                                   imp_no_lock_replay:1,
<a name="l00292"></a>00292                                   <span class="comment">/* recovery by versions was failed */</span>
<a name="l00293"></a>00293                                   imp_vbr_failed:1,
<a name="l00294"></a>00294                                   <span class="comment">/* force an immidiate ping */</span>
<a name="l00295"></a>00295                                   imp_force_verify:1,
<a name="l00296"></a>00296                                   <span class="comment">/* force a scheduled ping */</span>
<a name="l00297"></a>00297                                   imp_force_next_verify:1,
<a name="l00298"></a>00298                                   <span class="comment">/* pingable */</span>
<a name="l00299"></a>00299                                   imp_pingable:1,
<a name="l00300"></a>00300                                   <span class="comment">/* resend for replay */</span>
<a name="l00301"></a>00301                                   imp_resend_replay:1,
<a name="l00302"></a>00302                                   <span class="comment">/* disable normal recovery, for test only. */</span>
<a name="l00303"></a>00303                                   imp_no_pinger_recover:1,
<a name="l00304"></a>00304 <span class="preprocessor">#if LUSTRE_VERSION_CODE &lt; OBD_OCD_VERSION(3, 0, 53, 0)</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>                                  <span class="comment">/* need IR MNE swab */</span>
<a name="l00306"></a>00306                                   imp_need_mne_swab:1,
<a name="l00307"></a>00307 <span class="preprocessor">#endif</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>                                  <span class="comment">/* import must be reconnected instead of</span>
<a name="l00309"></a>00309 <span class="comment">                                   * chouse new connection */</span>
<a name="l00310"></a>00310                                   imp_force_reconnect:1,
<a name="l00311"></a>00311                                   <span class="comment">/* import has tried to connect with server */</span>
<a name="l00312"></a>00312                                   imp_connect_tried:1,
<a name="l00313"></a>00313                                   <span class="comment">/* connected but not FULL yet */</span>
<a name="l00314"></a>00314                                   imp_connected:1;
<a name="l00315"></a>00315         __u32                     imp_connect_op;
<a name="l00316"></a>00316         <span class="keyword">struct </span><a class="code" href="structobd__connect__data.html">obd_connect_data</a>   imp_connect_data;
<a name="l00317"></a>00317         __u64                     imp_connect_flags_orig;
<a name="l00318"></a>00318         <span class="keywordtype">int</span>                       imp_connect_error;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         __u32                     imp_msg_magic;
<a name="l00321"></a>00321         __u32                     imp_msghdr_flags;       <span class="comment">/* adjusted based on server capability */</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="keyword">struct </span><a class="code" href="structimp__at.html">imp_at</a>             <a class="code" href="structimp__at.html">imp_at</a>;                 <span class="comment">/* adaptive timeout data */</span>
<a name="l00324"></a>00324         time_t                    imp_last_reply_time;    <span class="comment">/* for health check */</span>
<a name="l00325"></a>00325 };
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="comment">/* import.c */</span>
<a name="l00328"></a>00328 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> at_est2timeout(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330         <span class="comment">/* add an arbitrary minimum: 125% +5 sec */</span>
<a name="l00331"></a>00331         <span class="keywordflow">return</span> (val + (val &gt;&gt; 2) + 5);
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> at_timeout2est(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336         <span class="comment">/* restore estimate value from timeout: e=4/5(t-5) */</span>
<a name="l00337"></a>00337         LASSERT(val);
<a name="l00338"></a>00338         <span class="keywordflow">return</span> (max((val &lt;&lt; 2) / 5, 5U) - 4);
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> at_reset_nolock(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at, <span class="keywordtype">int</span> val)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343         at-&gt;at_current = val;
<a name="l00344"></a>00344         at-&gt;at_worst_ever = val;
<a name="l00345"></a>00345         at-&gt;at_worst_time = cfs_time_current_sec();
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> at_reset(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at, <span class="keywordtype">int</span> val)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350         spin_lock(&amp;at-&gt;at_lock);
<a name="l00351"></a>00351         at_reset_nolock(at, val);
<a name="l00352"></a>00352         spin_unlock(&amp;at-&gt;at_lock);
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> at_init(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at, <span class="keywordtype">int</span> val, <span class="keywordtype">int</span> flags) {
<a name="l00356"></a>00356         memset(at, 0, <span class="keyword">sizeof</span>(*at));
<a name="l00357"></a>00357         spin_lock_init(&amp;at-&gt;at_lock);
<a name="l00358"></a>00358         at-&gt;at_flags = flags;
<a name="l00359"></a>00359         at_reset(at, val);
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> at_reinit(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at, <span class="keywordtype">int</span> val, <span class="keywordtype">int</span> flags)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364         spin_lock(&amp;at-&gt;at_lock);
<a name="l00365"></a>00365         at-&gt;at_binstart = 0;
<a name="l00366"></a>00366         memset(at-&gt;at_hist, 0, <span class="keyword">sizeof</span>(at-&gt;at_hist));
<a name="l00367"></a>00367         at-&gt;at_flags = flags;
<a name="l00368"></a>00368         at_reset_nolock(at, val);
<a name="l00369"></a>00369         spin_unlock(&amp;at-&gt;at_lock);
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> at_min;
<a name="l00373"></a>00373 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> at_get(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at) {
<a name="l00374"></a>00374         <span class="keywordflow">return</span> (at-&gt;at_current &gt; at_min) ? at-&gt;at_current : at_min;
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 <span class="keywordtype">int</span> at_measured(<span class="keyword">struct</span> <a class="code" href="structadaptive__timeout.html">adaptive_timeout</a> *at, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val);
<a name="l00377"></a>00377 <span class="keywordtype">int</span> import_at_get_index(<span class="keyword">struct</span> <a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> *imp, <span class="keywordtype">int</span> portal);
<a name="l00378"></a>00378 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> at_max;
<a name="l00379"></a>00379 <span class="preprocessor">#define AT_OFF (at_max == 0)</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span>
<a name="l00381"></a>00381 <span class="comment">/* genops.c */</span>
<a name="l00382"></a>00382 <span class="keyword">struct </span><a class="code" href="structobd__export.html" title="Export structure.">obd_export</a>;
<a name="l00383"></a>00383 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> *class_exp2cliimp(<span class="keyword">struct</span> <a class="code" href="structobd__export.html" title="Export structure.">obd_export</a> *);
<a name="l00384"></a>00384 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structobd__import.html" title="Defintion of PortalRPC import structure.">obd_import</a> *class_conn2cliimp(<span class="keyword">struct</span> <a class="code" href="structlustre__handle.html">lustre_handle</a> *);
<a name="l00385"></a>00385 
<a name="l00388"></a>00388 <span class="preprocessor">#endif </span><span class="comment">/* __IMPORT_H */</span>
<a name="l00389"></a>00389 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:55:13 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
