<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: cl_sync_io</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>cl_sync_io<br/>
<small>
[<a class="el" href="group__clio.html">clio</a>]</small>
</h1>
<p><div class="dynheader">
Collaboration diagram for cl_sync_io:</div>
<div class="dynsection">
<center><table><tr><td><img src="group__cl__sync__io.png" border="0" alt="" usemap="#group____cl____sync____io_map"/>
<map name="group____cl____sync____io_map" id="group____cl____sync____io">
<area shape="rect" id="node1" href="group__clio.html" title="Client objects implement io operations and cache pages." alt="" coords="7,5,49,35"/></map></td></tr></table></center>
</div>
</p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structcl__sync__io.html">cl_sync_io</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Anchor for synchronous transfer.  <a href="structcl__sync__io.html#_details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga9e4705c43e9207a09c6cd8c9fac1c3e5"></a><!-- doxytag: member="cl_sync_io::cl_sync_io_init" ref="ga9e4705c43e9207a09c6cd8c9fac1c3e5" args="(struct cl_sync_io *anchor, int nr, void(*end)(const struct lu_env *, struct cl_sync_io *))" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__cl__sync__io.html#ga9e4705c43e9207a09c6cd8c9fac1c3e5">cl_sync_io_init</a> (struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *anchor, int nr, void(*end)(const struct <a class="el" href="structlu__env.html">lu_env</a> *, struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *))</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize synchronous io wait anchor. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__cl__sync__io.html#ga92057d29f315080be03e18c0262a1871">cl_sync_io_wait</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *anchor, long timeout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Wait until all IO completes.  <a href="#ga92057d29f315080be03e18c0262a1871"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="gadb134aa2c1fb3f510bb8fe2a6da02bb9"></a><!-- doxytag: member="cl_sync_io::cl_sync_io_note" ref="gadb134aa2c1fb3f510bb8fe2a6da02bb9" args="(const struct lu_env *env, struct cl_sync_io *anchor, int ioret)" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__cl__sync__io.html#gadb134aa2c1fb3f510bb8fe2a6da02bb9">cl_sync_io_note</a> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *anchor, int ioret)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Indicate that transfer of a single page completed. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ga068e3a27f8967f8656fe3407c898d1d6"></a><!-- doxytag: member="cl_sync_io::cl_sync_io_end" ref="ga068e3a27f8967f8656fe3407c898d1d6" args="(const struct lu_env *env, struct cl_sync_io *anchor)" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><b>cl_sync_io_end</b> (const struct <a class="el" href="structlu__env.html">lu_env</a> *env, struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *anchor)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ga92057d29f315080be03e18c0262a1871"></a><!-- doxytag: member="cl_object.h::cl_sync_io_wait" ref="ga92057d29f315080be03e18c0262a1871" args="(const struct lu_env *env, struct cl_sync_io *anchor, long timeout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int cl_sync_io_wait </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structlu__env.html">lu_env</a> *&nbsp;</td>
          <td class="paramname"> <em>env</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structcl__sync__io.html">cl_sync_io</a> *&nbsp;</td>
          <td class="paramname"> <em>anchor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>timeout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Wait until all IO completes. </p>
<p>Transfer completion routine has to call <a class="el" href="group__cl__sync__io.html#gadb134aa2c1fb3f510bb8fe2a6da02bb9" title="Indicate that transfer of a single page completed.">cl_sync_io_note()</a> for every entity. </p>

<p>Definition at line <a class="el" href="cl__io_8c_source.html#l01221">1221</a> of file <a class="el" href="cl__io_8c_source.html">cl_io.c</a>.</p>

<p>References <a class="el" href="cl__object_8h_source.html#l02406">csi_barrier</a>, <a class="el" href="cl__object_8h_source.html#l02402">csi_sync_nr</a>, <a class="el" href="cl__object_8h_source.html#l02404">csi_sync_rc</a>, and <a class="el" href="cl__object_8h_source.html#l02408">csi_waitq</a>.</p>

<p>Referenced by <a class="el" href="cl__io_8c_source.html#l00702">cl_io_submit_sync()</a>, and <a class="el" href="cl__lock_8c_source.html#l00195">cl_lock_request()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01223"></a>01223 {
<a name="l01224"></a>01224         <span class="keyword">struct </span><a class="code" href="structl__wait__info.html">l_wait_info</a> lwi = LWI_TIMEOUT_INTR(cfs_time_seconds(timeout),
<a name="l01225"></a>01225                                                   NULL, NULL, NULL);
<a name="l01226"></a>01226         <span class="keywordtype">int</span> rc;
<a name="l01227"></a>01227         ENTRY;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229         LASSERT(timeout &gt;= 0);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         rc = l_wait_event(anchor-&gt;<a class="code" href="structcl__sync__io.html#a591752c0080fbe74e3766b250bb226ef" title="completion to be signaled when transfer is complete.">csi_waitq</a>,
<a name="l01232"></a>01232                           atomic_read(&amp;anchor-&gt;<a class="code" href="structcl__sync__io.html#aaf7f7fe203e365e9074f83bb8d5e2298" title="number of pages yet to be transferred.">csi_sync_nr</a>) == 0,
<a name="l01233"></a>01233                           &amp;lwi);
<a name="l01234"></a>01234         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01235"></a>01235                 CERROR(<span class="stringliteral">&quot;IO failed: %d, still wait for %d remaining entries\n&quot;</span>,
<a name="l01236"></a>01236                        rc, atomic_read(&amp;anchor-&gt;<a class="code" href="structcl__sync__io.html#aaf7f7fe203e365e9074f83bb8d5e2298" title="number of pages yet to be transferred.">csi_sync_nr</a>));
<a name="l01237"></a>01237 
<a name="l01238"></a>01238                 lwi = (<span class="keyword">struct </span><a class="code" href="structl__wait__info.html">l_wait_info</a>) { 0 };
<a name="l01239"></a>01239                 (void)l_wait_event(anchor-&gt;<a class="code" href="structcl__sync__io.html#a591752c0080fbe74e3766b250bb226ef" title="completion to be signaled when transfer is complete.">csi_waitq</a>,
<a name="l01240"></a>01240                                    atomic_read(&amp;anchor-&gt;<a class="code" href="structcl__sync__io.html#aaf7f7fe203e365e9074f83bb8d5e2298" title="number of pages yet to be transferred.">csi_sync_nr</a>) == 0,
<a name="l01241"></a>01241                                    &amp;lwi);
<a name="l01242"></a>01242         } <span class="keywordflow">else</span> {
<a name="l01243"></a>01243                 rc = anchor-&gt;<a class="code" href="structcl__sync__io.html#ae23f621796520d3fa33f577b790cbca6" title="error code.">csi_sync_rc</a>;
<a name="l01244"></a>01244         }
<a name="l01245"></a>01245         LASSERT(atomic_read(&amp;anchor-&gt;<a class="code" href="structcl__sync__io.html#aaf7f7fe203e365e9074f83bb8d5e2298" title="number of pages yet to be transferred.">csi_sync_nr</a>) == 0);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247         <span class="comment">/* wait until cl_sync_io_note() has done wakeup */</span>
<a name="l01248"></a>01248         <span class="keywordflow">while</span> (unlikely(atomic_read(&amp;anchor-&gt;<a class="code" href="structcl__sync__io.html#a12cc89b6e0da8764344db9b5d50ec3b3" title="barrier of destroy this structure">csi_barrier</a>) != 0)) {
<a name="l01249"></a>01249                 cpu_relax();
<a name="l01250"></a>01250         }
<a name="l01251"></a>01251         RETURN(rc);
<a name="l01252"></a>01252 }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="group__cl__sync__io_ga92057d29f315080be03e18c0262a1871_icgraph.png" border="0" usemap="#group__cl__sync__io_ga92057d29f315080be03e18c0262a1871_icgraph_map" alt=""></div>
<map name="group__cl__sync__io_ga92057d29f315080be03e18c0262a1871_icgraph_map" id="group__cl__sync__io_ga92057d29f315080be03e18c0262a1871_icgraph">
<area shape="rect" id="node3" href="group__cl__io.html#ga575a43e2ec65ba4aa6c926cf5e49fe70" title="Submit a sync_io and wait for the IO to be finished, or error happens." alt="" coords="180,5,321,35"/><area shape="rect" id="node5" href="group__cl__lock.html#ga4afe671873f4a7343d9c50c574557fd6" title="Main high&#45;level entry point of cl_lock interface that finds existing or enqueues..." alt="" coords="188,59,313,88"/></map>
</div>
</p>

</div>
</div>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:55:38 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
