<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Lustre: lustre/ptlrpc/nrs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body fgcolor="#202020">
<img src="http://wiki.lustre.org/apidoc/header.jpg">
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lustre/ptlrpc/nrs.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * GPL HEADER START</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License version 2 only,</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation.</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment"> * GNU General Public License version 2 for more details.  A copy is</span>
<a name="l00014"></a>00014 <span class="comment"> * included in the COPYING file that accompanied this code.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00018"></a>00018 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * GPL HEADER END</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 <span class="comment">/*</span>
<a name="l00023"></a>00023 <span class="comment"> * Copyright (c) 2011, 2014, Intel Corporation.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * Copyright 2012 Xyratex Technology Limited</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 <span class="comment">/*</span>
<a name="l00028"></a>00028 <span class="comment"> * lustre/ptlrpc/nrs.c</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Network Request Scheduler (NRS)</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * Allows to reorder the handling of RPCs at servers.</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> * Author: Liang Zhen &lt;liang@whamcloud.com&gt;</span>
<a name="l00035"></a>00035 <span class="comment"> * Author: Nikitas Angelinas &lt;nikitas_angelinas@xyratex.com&gt;</span>
<a name="l00036"></a>00036 <span class="comment"> */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#define DEBUG_SUBSYSTEM S_RPC</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;obd_support.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;obd_class.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;lustre_net.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;lprocfs_status.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;libcfs/libcfs.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;ptlrpc_internal.h&quot;</span>
<a name="l00049"></a>00049 
<a name="l00053"></a>00053 <span class="keyword">struct </span><a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a> <a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_init(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057         <span class="keywordflow">return</span> policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a569dc08f6db72425acb3af23817016b5" title="Called during policy registration; this operation is optional.">op_policy_init</a> != NULL ?
<a name="l00058"></a>00058                policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a569dc08f6db72425acb3af23817016b5" title="Called during policy registration; this operation is optional.">op_policy_init</a>(policy) : 0;
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_policy_fini(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> == 0);
<a name="l00064"></a>00064         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> == 0);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a19f8bfc734d211149596592a8381e336" title="Called during policy unregistration; this operation is optional.">op_policy_fini</a> != NULL)
<a name="l00067"></a>00067                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a19f8bfc734d211149596592a8381e336" title="Called during policy unregistration; this operation is optional.">op_policy_fini</a>(policy);
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_ctl_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy,
<a name="l00071"></a>00071                                  <span class="keyword">enum</span> <a class="code" href="group__nrs.html#gaa3db631148675f8074864fa452691540" title="NRS control operations.">ptlrpc_nrs_ctl</a> opc, <span class="keywordtype">void</span> *arg)
<a name="l00072"></a>00072 {
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>)
<a name="l00080"></a>00080                 RETURN(-ENODEV);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         RETURN(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad5e959465f0b9fd65ae096036df926d3" title="Used for policy-specific operations; i.e.">op_policy_ctl</a> != NULL ?
<a name="l00083"></a>00083                policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad5e959465f0b9fd65ae096036df926d3" title="Used for policy-specific operations; i.e.">op_policy_ctl</a>(policy, opc, arg) :
<a name="l00084"></a>00084                -ENOSYS);
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_policy_stop0(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089         ENTRY;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a858a315f60b599de84db2cadfb9d6784" title="Called when deactivating a policy via lprocfs; policies deallocate their resources...">op_policy_stop</a> != NULL)
<a name="l00092"></a>00092                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a858a315f60b599de84db2cadfb9d6784" title="Called when deactivating a policy via lprocfs; policies deallocate their resources...">op_policy_stop</a>(policy);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         LASSERT(list_empty(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>));
<a name="l00095"></a>00095         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> == 0 &amp;&amp;
<a name="l00096"></a>00096                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#af5766f2083b67b59ab394473c0d4702e" title="# RPCs started for dispatch by the policy">pol_req_started</a> == 0);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a65f5afb21e9da75ae93e9b0b64887272" title="Private policy data; varies by policy type.">pol_private</a> = NULL;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="keywordflow">if</span> (atomic_dec_and_test(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a74a94ee35dc2e2bf50b4a85e8c0bf291" title="# of references on this descriptor">pd_refs</a>))
<a name="l00103"></a>00103                 module_put(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#ae12d56d85fa4f85a79e9ad185ecd2bd1" title="Owner module for this policy descriptor.">pd_owner</a>);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         EXIT;
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_stop_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>;
<a name="l00111"></a>00111         ENTRY;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="keywordflow">if</span> (nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> == policy &amp;&amp; !nrs-&gt;<a class="code" href="structptlrpc__nrs.html#a9340ae118782160c94e4cbb9ef8f6a2a" title="In progress of shutting down the whole NRS head; used during unregistration.">nrs_stopping</a>)
<a name="l00114"></a>00114                 RETURN(-EPERM);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a6198482c4c72e590f9009efb54f424ec" title="Policy is in progress of starting.">NRS_POL_STATE_STARTING</a>)
<a name="l00117"></a>00117                 RETURN(-EAGAIN);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         <span class="comment">/* In progress or already stopped */</span>
<a name="l00120"></a>00120         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> != <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a8da4904dfb7ba56810332673912a76cb" title="A policy is in this state in two cases:it is the fallback policy, which is always...">NRS_POL_STATE_STARTED</a>)
<a name="l00121"></a>00121                 RETURN(0);
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a3e737ea7aa14781899e40eb0343c9a39" title="Policy is progress of stopping.">NRS_POL_STATE_STOPPING</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         <span class="comment">/* Immediately make it invisible */</span>
<a name="l00126"></a>00126         <span class="keywordflow">if</span> (nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a> == policy) {
<a name="l00127"></a>00127                 nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a> = NULL;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         } <span class="keywordflow">else</span> {
<a name="l00130"></a>00130                 LASSERT(nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> == policy);
<a name="l00131"></a>00131                 nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> = NULL;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         <span class="comment">/* I have the only refcount */</span>
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> == 1)
<a name="l00136"></a>00136                 nrs_policy_stop0(policy);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         RETURN(0);
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00148"></a>00148 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_policy_stop_primary(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *tmp = nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a>;
<a name="l00151"></a>00151         ENTRY;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l00159"></a>00159                 EXIT;
<a name="l00160"></a>00160                 <span class="keywordflow">return</span>;
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a> = NULL;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         LASSERT(tmp-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a8da4904dfb7ba56810332673912a76cb" title="A policy is in this state in two cases:it is the fallback policy, which is always...">NRS_POL_STATE_STARTED</a>);
<a name="l00166"></a>00166         tmp-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a3e737ea7aa14781899e40eb0343c9a39" title="Policy is progress of stopping.">NRS_POL_STATE_STOPPING</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> == 0)
<a name="l00169"></a>00169                 nrs_policy_stop0(tmp);
<a name="l00170"></a>00170         EXIT;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00192"></a>00192 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_start_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy, <span class="keywordtype">char</span> *arg)
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>      *nrs = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>;
<a name="l00195"></a>00195         <span class="keywordtype">int</span>                     rc = 0;
<a name="l00196"></a>00196         ENTRY;
<a name="l00197"></a>00197 
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ab066b4e96742200fb1872733214cd89d" title="This NRS head is in progress of starting a policy.">nrs_policy_starting</a>)
<a name="l00203"></a>00203                 RETURN(-EAGAIN);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> != <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a6198482c4c72e590f9009efb54f424ec" title="Policy is in progress of starting.">NRS_POL_STATE_STARTING</a>);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a3e737ea7aa14781899e40eb0343c9a39" title="Policy is progress of stopping.">NRS_POL_STATE_STOPPING</a>)
<a name="l00208"></a>00208                 RETURN(-EAGAIN);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a309370c6cddb4343be478c8762613c37" title="Bitmask of nrs_policy_flags.">pol_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8ad327b4b9e26d26b5620cfdb682ca0b4c" title="Fallback policy, use this flag only on a single supported policy per service.">PTLRPC_NRS_FL_FALLBACK</a>) {
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> (policy == nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a>) {
<a name="l00218"></a>00218                         nrs_policy_stop_primary(nrs);
<a name="l00219"></a>00219                         RETURN(0);
<a name="l00220"></a>00220                 }
<a name="l00221"></a>00221 
<a name="l00228"></a>00228                 LASSERT(nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> == NULL);
<a name="l00229"></a>00229         } <span class="keywordflow">else</span> {
<a name="l00233"></a>00233                 <span class="keywordflow">if</span> (nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> == NULL)
<a name="l00234"></a>00234                         RETURN(-EPERM);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                 <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a8da4904dfb7ba56810332673912a76cb" title="A policy is in this state in two cases:it is the fallback policy, which is always...">NRS_POL_STATE_STARTED</a>) {
<a name="l00242"></a>00242                         <span class="keywordflow">if</span> ((arg != NULL) &amp;&amp; (strlen(arg) &gt;= NRS_POL_ARG_MAX))
<a name="l00243"></a>00243                                 <span class="keywordflow">return</span> -EINVAL;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245                         <span class="keywordflow">if</span> ((arg == NULL &amp;&amp; strlen(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a9a58b70d3179d9ad20eca6f1c494ff91" title="Human-readable policy argument.">pol_arg</a>) == 0) ||
<a name="l00246"></a>00246                             (arg != NULL &amp;&amp; strcmp(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a9a58b70d3179d9ad20eca6f1c494ff91" title="Human-readable policy argument.">pol_arg</a>, arg) == 0))
<a name="l00247"></a>00247                                 RETURN(0);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                         rc = nrs_policy_stop_locked(policy);
<a name="l00250"></a>00250                         <span class="keywordflow">if</span> (rc)
<a name="l00251"></a>00251                                 RETURN(-EAGAIN);
<a name="l00252"></a>00252                 }
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254 
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (atomic_inc_return(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a74a94ee35dc2e2bf50b4a85e8c0bf291" title="# of references on this descriptor">pd_refs</a>) == 1 &amp;&amp;
<a name="l00260"></a>00260             !try_module_get(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#ae12d56d85fa4f85a79e9ad185ecd2bd1" title="Owner module for this policy descriptor.">pd_owner</a>)) {
<a name="l00261"></a>00261                 atomic_dec(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a74a94ee35dc2e2bf50b4a85e8c0bf291" title="# of references on this descriptor">pd_refs</a>);
<a name="l00262"></a>00262                 CERROR(<span class="stringliteral">&quot;NRS: cannot get module for policy %s; is it alive?\n&quot;</span>,
<a name="l00263"></a>00263                        policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>);
<a name="l00264"></a>00264                 RETURN(-ENODEV);
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         <span class="keywordflow">if</span> (arg != NULL) {
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> (strlen(arg) + 1 &gt; <span class="keyword">sizeof</span>(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a9a58b70d3179d9ad20eca6f1c494ff91" title="Human-readable policy argument.">pol_arg</a>)) {
<a name="l00269"></a>00269                         CERROR(<span class="stringliteral">&quot;NRS: arg &apos;%s&apos; is too long\n&quot;</span>, arg);
<a name="l00270"></a>00270                         GOTO(out, rc = -E2BIG);
<a name="l00271"></a>00271                 }
<a name="l00272"></a>00272                 strncpy(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a9a58b70d3179d9ad20eca6f1c494ff91" title="Human-readable policy argument.">pol_arg</a>, arg, <span class="keyword">sizeof</span>(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a9a58b70d3179d9ad20eca6f1c494ff91" title="Human-readable policy argument.">pol_arg</a>));
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 
<a name="l00278"></a>00278         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ab066b4e96742200fb1872733214cd89d" title="This NRS head is in progress of starting a policy.">nrs_policy_starting</a> = 1;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a6198482c4c72e590f9009efb54f424ec" title="Policy is in progress of starting.">NRS_POL_STATE_STARTING</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a04b4479f93de2fbd7380f10ffaf5f35c" title="Called when activating a policy via lprocfs; policies allocate and initialize their...">op_policy_start</a>) {
<a name="l00283"></a>00283                 spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285                 rc = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a04b4479f93de2fbd7380f10ffaf5f35c" title="Called when activating a policy via lprocfs; policies allocate and initialize their...">op_policy_start</a>(policy, arg);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00288"></a>00288                 <span class="keywordflow">if</span> (rc != 0) {
<a name="l00289"></a>00289                         <span class="keywordflow">if</span> (atomic_dec_and_test(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a74a94ee35dc2e2bf50b4a85e8c0bf291" title="# of references on this descriptor">pd_refs</a>))
<a name="l00290"></a>00290                                 module_put(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#ae12d56d85fa4f85a79e9ad185ecd2bd1" title="Owner module for this policy descriptor.">pd_owner</a>);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292                         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>;
<a name="l00293"></a>00293                         GOTO(out, rc);
<a name="l00294"></a>00294                 }
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a8da4904dfb7ba56810332673912a76cb" title="A policy is in this state in two cases:it is the fallback policy, which is always...">NRS_POL_STATE_STARTED</a>;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a309370c6cddb4343be478c8762613c37" title="Bitmask of nrs_policy_flags.">pol_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8ad327b4b9e26d26b5620cfdb682ca0b4c" title="Fallback policy, use this flag only on a single supported policy per service.">PTLRPC_NRS_FL_FALLBACK</a>) {
<a name="l00303"></a>00303                 nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a> = policy;
<a name="l00304"></a>00304         } <span class="keywordflow">else</span> {
<a name="l00305"></a>00305                 <span class="comment">/*</span>
<a name="l00306"></a>00306 <span class="comment">                 * Try to stop the current primary policy if there is one.</span>
<a name="l00307"></a>00307 <span class="comment">                 */</span>
<a name="l00308"></a>00308                 nrs_policy_stop_primary(nrs);
<a name="l00309"></a>00309 
<a name="l00313"></a>00313                 nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a> = policy;
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 out:
<a name="l00317"></a>00317         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ab066b4e96742200fb1872733214cd89d" title="This NRS head is in progress of starting a policy.">nrs_policy_starting</a> = 0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319         RETURN(rc);
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00325"></a>00325 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> nrs_policy_get_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a>++;
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00336"></a>00336 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_policy_put_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> &gt; 0);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a>--;
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (unlikely(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> == 0 &amp;&amp;
<a name="l00342"></a>00342             policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a3e737ea7aa14781899e40eb0343c9a39" title="Policy is progress of stopping.">NRS_POL_STATE_STOPPING</a>))
<a name="l00343"></a>00343                 nrs_policy_stop0(policy);
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_policy_put(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348         spin_lock(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;nrs_lock);
<a name="l00349"></a>00349         nrs_policy_put_locked(policy);
<a name="l00350"></a>00350         spin_unlock(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;nrs_lock);
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00356"></a>00356 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> * nrs_policy_find_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs,
<a name="l00357"></a>00357                                                          <span class="keywordtype">char</span> *name)
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *tmp;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         list_for_each_entry(tmp, &amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ae7e450db9f1413b9da0e4bbdd33cfb22" title="XXX Possibly replace svcpt-&amp;gt;scp_req_lock with another lock here.">nrs_policy_list</a>, <a class="code" href="structptlrpc__nrs__policy.html#aa644d14229b1b7bfce579970fe0d362a" title="Linkage into the NRS head&amp;#39;s list of policies, ptlrpc_nrs:nrs_policy_list.">pol_list</a>) {
<a name="l00362"></a>00362                 <span class="keywordflow">if</span> (strncmp(tmp-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, name,
<a name="l00363"></a>00363                             NRS_POL_NAME_MAX) == 0) {
<a name="l00364"></a>00364                         nrs_policy_get_locked(tmp);
<a name="l00365"></a>00365                         <span class="keywordflow">return</span> tmp;
<a name="l00366"></a>00366                 }
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368         <span class="keywordflow">return</span> NULL;
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00375"></a>00375 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_resource_put(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> *res)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy = res-&gt;<a class="code" href="structptlrpc__nrs__resource.html#aa5af26dd315bfb4faa7548c369dd35ee" title="The policy associated with this resource.">res_policy</a>;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a1fc1f744ceed9307e93dc3ad6f9f882b" title="Called when releasing references taken for resources in the resource hierarchy for...">op_res_put</a> != NULL) {
<a name="l00380"></a>00380                 <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> *parent;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                 <span class="keywordflow">for</span> (; res != NULL; res = parent) {
<a name="l00383"></a>00383                         parent = res-&gt;<a class="code" href="structptlrpc__nrs__resource.html#ad0e4dbe1fe93c3751bf54b78c6d81abd" title="This NRS resource&amp;#39;s parent; is NULL for resources embedded in NRS policy instances;...">res_parent</a>;
<a name="l00384"></a>00384                         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a1fc1f744ceed9307e93dc3ad6f9f882b" title="Called when releasing references taken for resources in the resource hierarchy for...">op_res_put</a>(policy, res);
<a name="l00385"></a>00385                 }
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00405"></a>00405 <span class="keyword">static</span>
<a name="l00406"></a>00406 <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> * nrs_resource_get(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy,
<a name="l00407"></a>00407                                               <span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq,
<a name="l00408"></a>00408                                               <span class="keywordtype">bool</span> moving_req)
<a name="l00409"></a>00409 {
<a name="l00413"></a>00413         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> *res = NULL;
<a name="l00414"></a>00414         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> *tmp = NULL;
<a name="l00415"></a>00415         <span class="keywordtype">int</span>                         rc;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <span class="keywordflow">while</span> (1) {
<a name="l00418"></a>00418                 rc = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#affec8ac80f98364807dfe58e82fe4afe" title="Called when obtaining references to the resources of the resource hierarchy for a...">op_res_get</a>(policy, nrq, res,
<a name="l00419"></a>00419                                                           &amp;tmp, moving_req);
<a name="l00420"></a>00420                 <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00421"></a>00421                         <span class="keywordflow">if</span> (res != NULL)
<a name="l00422"></a>00422                                 nrs_resource_put(res);
<a name="l00423"></a>00423                         <span class="keywordflow">return</span> NULL;
<a name="l00424"></a>00424                 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                 LASSERT(tmp != NULL);
<a name="l00427"></a>00427                 tmp-&gt;<a class="code" href="structptlrpc__nrs__resource.html#ad0e4dbe1fe93c3751bf54b78c6d81abd" title="This NRS resource&amp;#39;s parent; is NULL for resources embedded in NRS policy instances;...">res_parent</a> = res;
<a name="l00428"></a>00428                 tmp-&gt;<a class="code" href="structptlrpc__nrs__resource.html#aa5af26dd315bfb4faa7548c369dd35ee" title="The policy associated with this resource.">res_policy</a> = policy;
<a name="l00429"></a>00429                 res = tmp;
<a name="l00430"></a>00430                 tmp = NULL;
<a name="l00435"></a>00435                 <span class="keywordflow">if</span> (rc &gt; 0)
<a name="l00436"></a>00436                         <span class="keywordflow">return</span> res;
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00457"></a>00457 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_resource_get_safe(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs,
<a name="l00458"></a>00458                                   <span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq,
<a name="l00459"></a>00459                                   <span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> **resp,
<a name="l00460"></a>00460                                   <span class="keywordtype">bool</span> moving_req)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>   *primary = NULL;
<a name="l00463"></a>00463         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>   *fallback = NULL;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         memset(resp, 0, <span class="keyword">sizeof</span>(resp[0]) * NRS_RES_MAX);
<a name="l00466"></a>00466 
<a name="l00470"></a>00470         spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         fallback = nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aefca80244819b99a84108e9010686738" title="Fallback policy, which is the backup policy for handling RPCs.">nrs_policy_fallback</a>;
<a name="l00473"></a>00473         nrs_policy_get_locked(fallback);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         primary = nrs-&gt;<a class="code" href="structptlrpc__nrs.html#adb24110f68fc0c64da5e1ef0aa4733b6" title="Primary policy, which is the preferred policy for handling RPCs.">nrs_policy_primary</a>;
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (primary != NULL)
<a name="l00477"></a>00477                 nrs_policy_get_locked(primary);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00480"></a>00480 
<a name="l00484"></a>00484         resp[NRS_RES_FALLBACK] = nrs_resource_get(fallback, nrq, moving_req);
<a name="l00485"></a>00485         LASSERT(resp[NRS_RES_FALLBACK] != NULL);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (primary != NULL) {
<a name="l00488"></a>00488                 resp[NRS_RES_PRIMARY] = nrs_resource_get(primary, nrq,
<a name="l00489"></a>00489                                                          moving_req);
<a name="l00496"></a>00496                 <span class="keywordflow">if</span> (resp[NRS_RES_PRIMARY] == NULL)
<a name="l00497"></a>00497                         nrs_policy_put(primary);
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499 }
<a name="l00500"></a>00500 
<a name="l00511"></a>00511 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_resource_put_safe(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a> **resp)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *pols[NRS_RES_MAX];
<a name="l00514"></a>00514         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>        *nrs = NULL;
<a name="l00515"></a>00515         <span class="keywordtype">int</span>                       i;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517         <span class="keywordflow">for</span> (i = 0; i &lt; NRS_RES_MAX; i++) {
<a name="l00518"></a>00518                 <span class="keywordflow">if</span> (resp[i] != NULL) {
<a name="l00519"></a>00519                         pols[i] = resp[i]-&gt;<a class="code" href="structptlrpc__nrs__resource.html#aa5af26dd315bfb4faa7548c369dd35ee" title="The policy associated with this resource.">res_policy</a>;
<a name="l00520"></a>00520                         nrs_resource_put(resp[i]);
<a name="l00521"></a>00521                         resp[i] = NULL;
<a name="l00522"></a>00522                 } <span class="keywordflow">else</span> {
<a name="l00523"></a>00523                         pols[i] = NULL;
<a name="l00524"></a>00524                 }
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">for</span> (i = 0; i &lt; NRS_RES_MAX; i++) {
<a name="l00528"></a>00528                 <span class="keywordflow">if</span> (pols[i] == NULL)
<a name="l00529"></a>00529                         <span class="keywordflow">continue</span>;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531                 <span class="keywordflow">if</span> (nrs == NULL) {
<a name="l00532"></a>00532                         nrs = pols[i]-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>;
<a name="l00533"></a>00533                         spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00534"></a>00534                 }
<a name="l00535"></a>00535                 nrs_policy_put_locked(pols[i]);
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (nrs != NULL)
<a name="l00539"></a>00539                 spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00558"></a>00558 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00559"></a>00559 <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> * nrs_request_get(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy,
<a name="l00560"></a>00560                                             <span class="keywordtype">bool</span> peek, <span class="keywordtype">bool</span> force)
<a name="l00561"></a>00561 {
<a name="l00562"></a>00562         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> &gt; 0);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         nrq = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad7f082871c0f527c8d6b1c27c40a88e6" title="Obtains a request for handling from the policy, and optionally removes the request...">op_req_get</a>(policy, peek, force);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         LASSERT(ergo(nrq != NULL, nrs_request_policy(nrq) == policy));
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <span class="keywordflow">return</span> nrq;
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00583"></a>00583 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> nrs_request_enqueue(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy;
<a name="l00586"></a>00586         <span class="keywordtype">int</span>                       rc;
<a name="l00587"></a>00587         <span class="keywordtype">int</span>                       i;
<a name="l00588"></a>00588 
<a name="l00593"></a>00593         <span class="keywordflow">for</span> (i = NRS_RES_MAX - 1; i &gt;= 0; i--) {
<a name="l00594"></a>00594                 <span class="keywordflow">if</span> (nrq-&gt;<a class="code" href="structptlrpc__nrs__request.html#aff495a9624df874a4d9bf643ad1b4d20" title="The request&amp;#39;s resource hierarchy.">nr_res_ptrs</a>[i] == NULL)
<a name="l00595"></a>00595                         <span class="keywordflow">continue</span>;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597                 nrq-&gt;<a class="code" href="structptlrpc__nrs__request.html#ac61b0e631870da811a03cff16f013b46" title="Index into ptlrpc_nrs_request::nr_res_ptrs of the resource of the policy that was...">nr_res_idx</a> = i;
<a name="l00598"></a>00598                 policy = nrq-&gt;<a class="code" href="structptlrpc__nrs__request.html#aff495a9624df874a4d9bf643ad1b4d20" title="The request&amp;#39;s resource hierarchy.">nr_res_ptrs</a>[i]-&gt;<a class="code" href="structptlrpc__nrs__resource.html#aa5af26dd315bfb4faa7548c369dd35ee" title="The policy associated with this resource.">res_policy</a>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600                 rc = policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ae4c73dc673c0175574a7eee691f846a2" title="Called when attempting to add a request to a policy for later handling; this operation...">op_req_enqueue</a>(policy, nrq);
<a name="l00601"></a>00601                 <span class="keywordflow">if</span> (rc == 0) {
<a name="l00602"></a>00602                         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a>++;
<a name="l00603"></a>00603                         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a>++;
<a name="l00604"></a>00604                         <span class="keywordflow">return</span>;
<a name="l00605"></a>00605                 }
<a name="l00606"></a>00606         }
<a name="l00612"></a>00612         LBUG();
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00623"></a>00623 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> nrs_request_stop(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy = nrs_request_policy(nrq);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#afda655439032cd5103c48bfdafa6d98a" title="Called after the request being carried out.">op_req_stop</a>)
<a name="l00628"></a>00628                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#afda655439032cd5103c48bfdafa6d98a" title="Called after the request being carried out.">op_req_stop</a>(policy, nrq);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#ac28bda31fdafdd8b57f08e7233da607e" title="# scheduled requests from all policies in this NRS head">nrs_req_started</a> &gt; 0);
<a name="l00631"></a>00631         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#af5766f2083b67b59ab394473c0d4702e" title="# RPCs started for dispatch by the policy">pol_req_started</a> &gt; 0);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#ac28bda31fdafdd8b57f08e7233da607e" title="# scheduled requests from all policies in this NRS head">nrs_req_started</a>--;
<a name="l00634"></a>00634         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#af5766f2083b67b59ab394473c0d4702e" title="# RPCs started for dispatch by the policy">pol_req_started</a>--;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00655"></a>00655 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_ctl(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs, <span class="keywordtype">char</span> *name,
<a name="l00656"></a>00656                           <span class="keyword">enum</span> <a class="code" href="group__nrs.html#gaa3db631148675f8074864fa452691540" title="NRS control operations.">ptlrpc_nrs_ctl</a> opc, <span class="keywordtype">void</span> *arg)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *policy;
<a name="l00659"></a>00659         <span class="keywordtype">int</span>                             rc = 0;
<a name="l00660"></a>00660         ENTRY;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         policy = nrs_policy_find_locked(nrs, name);
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (policy == NULL)
<a name="l00666"></a>00666                 GOTO(out, rc = -ENOENT);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> != <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a8da4904dfb7ba56810332673912a76cb" title="A policy is in this state in two cases:it is the fallback policy, which is always...">NRS_POL_STATE_STARTED</a> &amp;&amp;
<a name="l00669"></a>00669             policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> != <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>)
<a name="l00670"></a>00670                 GOTO(out, rc = -EAGAIN);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="keywordflow">switch</span> (opc) {
<a name="l00677"></a>00677         <span class="keywordflow">default</span>:
<a name="l00678"></a>00678                 rc = nrs_policy_ctl_locked(policy, opc, arg);
<a name="l00679"></a>00679                 <span class="keywordflow">break</span>;
<a name="l00680"></a>00680 
<a name="l00684"></a>00684         <span class="keywordflow">case</span> <a class="code" href="group__nrs.html#ggaa3db631148675f8074864fa452691540acd5d2cd7790ab425869163314eae0e70" title="Activate the policy.">PTLRPC_NRS_CTL_START</a>:
<a name="l00685"></a>00685                 rc = nrs_policy_start_locked(policy, arg);
<a name="l00686"></a>00686                 <span class="keywordflow">break</span>;
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688 out:
<a name="l00689"></a>00689         <span class="keywordflow">if</span> (policy != NULL)
<a name="l00690"></a>00690                 nrs_policy_put_locked(policy);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692         spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         RETURN(rc);
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00707"></a>00707 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_unregister(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs, <span class="keywordtype">char</span> *name)
<a name="l00708"></a>00708 {
<a name="l00709"></a>00709         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy = NULL;
<a name="l00710"></a>00710         ENTRY;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712         spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         policy = nrs_policy_find_locked(nrs, name);
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (policy == NULL) {
<a name="l00716"></a>00716                 spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718                 CERROR(<span class="stringliteral">&quot;Can&apos;t find NRS policy %s\n&quot;</span>, name);
<a name="l00719"></a>00719                 RETURN(-ENOENT);
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a> &gt; 1) {
<a name="l00723"></a>00723                 CERROR(<span class="stringliteral">&quot;Policy %s is busy with %d references\n&quot;</span>, name,
<a name="l00724"></a>00724                        (<span class="keywordtype">int</span>)policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae409f7994a7339ef3f3854c74399cd52" title="Usage Reference count taken on the policy instance.">pol_ref</a>);
<a name="l00725"></a>00725                 nrs_policy_put_locked(policy);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727                 spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00728"></a>00728                 RETURN(-EBUSY);
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> == 0);
<a name="l00732"></a>00732         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#af5766f2083b67b59ab394473c0d4702e" title="# RPCs started for dispatch by the policy">pol_req_started</a> == 0);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> != <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>) {
<a name="l00735"></a>00735                 nrs_policy_stop_locked(policy);
<a name="l00736"></a>00736                 LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a> == <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>);
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         list_del(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#aa644d14229b1b7bfce579970fe0d362a" title="Linkage into the NRS head&amp;#39;s list of policies, ptlrpc_nrs:nrs_policy_list.">pol_list</a>);
<a name="l00740"></a>00740         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#a54bc17e6b4be4d73684ed821c0897bea" title="# policies on this NRS">nrs_num_pols</a>--;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         nrs_policy_put_locked(policy);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         nrs_policy_fini(policy);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a65f5afb21e9da75ae93e9b0b64887272" title="Private policy data; varies by policy type.">pol_private</a> == NULL);
<a name="l00749"></a>00749         OBD_FREE_PTR(policy);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         RETURN(0);
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00764"></a>00764 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_register(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs,
<a name="l00765"></a>00765                                <span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *desc)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *policy;
<a name="l00768"></a>00768         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *tmp;
<a name="l00769"></a>00769         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>     *svcpt = nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abf2a529023ae89332f4b185930f1a537" title="Service partition for this NRS head.">nrs_svcpt</a>;
<a name="l00770"></a>00770         <span class="keywordtype">int</span>                             rc;
<a name="l00771"></a>00771         ENTRY;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773         LASSERT(svcpt != NULL);
<a name="l00774"></a>00774         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a> != NULL);
<a name="l00775"></a>00775         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#affec8ac80f98364807dfe58e82fe4afe" title="Called when obtaining references to the resources of the resource hierarchy for a...">op_res_get</a> != NULL);
<a name="l00776"></a>00776         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad7f082871c0f527c8d6b1c27c40a88e6" title="Obtains a request for handling from the policy, and optionally removes the request...">op_req_get</a> != NULL);
<a name="l00777"></a>00777         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ae4c73dc673c0175574a7eee691f846a2" title="Called when attempting to add a request to a policy for later handling; this operation...">op_req_enqueue</a> != NULL);
<a name="l00778"></a>00778         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a1eb83c9a1da21c4090e85c6711dbf6d6" title="Removes a request from the policy&amp;#39;s set of pending requests.">op_req_dequeue</a> != NULL);
<a name="l00779"></a>00779         LASSERT(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a7c57c75713e6367abb8433ab580d1db4" title="Service compatibility predicate.">pd_compat</a> != NULL);
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         OBD_CPT_ALLOC_GFP(policy, svcpt-&gt;scp_service-&gt;srv_cptable,
<a name="l00782"></a>00782                           svcpt-&gt;scp_cpt, <span class="keyword">sizeof</span>(*policy), GFP_NOFS);
<a name="l00783"></a>00783         <span class="keywordflow">if</span> (policy == NULL)
<a name="l00784"></a>00784                 RETURN(-ENOMEM);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>     = nrs;
<a name="l00787"></a>00787         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>    = desc;
<a name="l00788"></a>00788         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ab2efc2b87dcc1b1e152a63836135fa14" title="Current state of this policy.">pol_state</a>   = <a class="code" href="group__nrs.html#gga843285b91fa9672fdf0fcc93b4387971a60ca6b44260cb20198b1d5d4747a6257" title="Policies are at this state either at the start of their life, or transition here...">NRS_POL_STATE_STOPPED</a>;
<a name="l00789"></a>00789         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a309370c6cddb4343be478c8762613c37" title="Bitmask of nrs_policy_flags.">pol_flags</a>   = desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aef6e239311b38cd4cd3bb5265ef9e3a4" title="Bitmask of nrs_policy_flags.">pd_flags</a>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         INIT_LIST_HEAD(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#aa644d14229b1b7bfce579970fe0d362a" title="Linkage into the NRS head&amp;#39;s list of policies, ptlrpc_nrs:nrs_policy_list.">pol_list</a>);
<a name="l00792"></a>00792         INIT_LIST_HEAD(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         rc = nrs_policy_init(policy);
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (rc != 0) {
<a name="l00796"></a>00796                 OBD_FREE_PTR(policy);
<a name="l00797"></a>00797                 RETURN(rc);
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         spin_lock(&amp;nrs-&gt;nrs_lock);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802         tmp = nrs_policy_find_locked(nrs, policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>);
<a name="l00803"></a>00803         <span class="keywordflow">if</span> (tmp != NULL) {
<a name="l00804"></a>00804                 CERROR(<span class="stringliteral">&quot;NRS policy %s has been registered, can&apos;t register it &quot;</span>
<a name="l00805"></a>00805                        <span class="stringliteral">&quot;for %s\n&quot;</span>, policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>,
<a name="l00806"></a>00806                        svcpt-&gt;scp_service-&gt;srv_name);
<a name="l00807"></a>00807                 nrs_policy_put_locked(tmp);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809                 spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00810"></a>00810                 nrs_policy_fini(policy);
<a name="l00811"></a>00811                 OBD_FREE_PTR(policy);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813                 RETURN(-EEXIST);
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816         list_add_tail(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#aa644d14229b1b7bfce579970fe0d362a" title="Linkage into the NRS head&amp;#39;s list of policies, ptlrpc_nrs:nrs_policy_list.">pol_list</a>, &amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ae7e450db9f1413b9da0e4bbdd33cfb22" title="XXX Possibly replace svcpt-&amp;gt;scp_req_lock with another lock here.">nrs_policy_list</a>);
<a name="l00817"></a>00817         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#a54bc17e6b4be4d73684ed821c0897bea" title="# policies on this NRS">nrs_num_pols</a>++;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a309370c6cddb4343be478c8762613c37" title="Bitmask of nrs_policy_flags.">pol_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a274b96449b8debe8a3aadf811d78b8aa" title="Start policy immediately after registering.">PTLRPC_NRS_FL_REG_START</a>)
<a name="l00820"></a>00820                 rc = nrs_policy_start_locked(policy, NULL);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         spin_unlock(&amp;nrs-&gt;nrs_lock);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (rc != 0)
<a name="l00825"></a>00825                 (void) nrs_policy_unregister(nrs, policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827         RETURN(rc);
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00836"></a>00836 <span class="keyword">static</span> <span class="keywordtype">void</span> ptlrpc_nrs_req_add_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *policy;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840         LASSERT(req-&gt;rq_nrq.nr_initialized);
<a name="l00841"></a>00841         LASSERT(!req-&gt;rq_nrq.nr_enqueued);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         nrs_request_enqueue(&amp;req-&gt;rq_nrq);
<a name="l00844"></a>00844         req-&gt;rq_nrq.nr_enqueued = 1;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         policy = nrs_request_policy(&amp;req-&gt;rq_nrq);
<a name="l00851"></a>00851         <span class="keywordflow">if</span> (unlikely(list_empty(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>)))
<a name="l00852"></a>00852                 list_add_tail(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>,
<a name="l00853"></a>00853                                   &amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#abba957e518558f35d3e0dd9f2f7f7eb3" title="List of policies with queued requests.">nrs_policy_queued</a>);
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00861"></a>00861 <span class="keyword">static</span> <span class="keywordtype">void</span> ptlrpc_nrs_hpreq_add_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863         <span class="keywordtype">int</span>     opc = lustre_msg_get_opc(req-&gt;<a class="code" href="structptlrpc__request.html#a98c2879f06b955c80000e8c1776373f7" title="Request message - what client sent.">rq_reqmsg</a>);
<a name="l00864"></a>00864         ENTRY;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         spin_lock(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#afb9723e194dc3b27d3721e45e5428d62" title="Lock to protect request flags and some other important bits, like rq_list.">rq_lock</a>);
<a name="l00867"></a>00867         req-&gt;<a class="code" href="structptlrpc__request.html#a97e5341e8ef49e047ef82b2cfa138ec8" title="server-side flags">rq_hp</a> = 1;
<a name="l00868"></a>00868         ptlrpc_nrs_req_add_nolock(req);
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (opc != OBD_PING)
<a name="l00870"></a>00870                 <a class="code" href="group__net.html#ga2d5d1c7075b9387118d9356833e9abdf" title="This is the debug print function you need to use to print request sturucture content...">DEBUG_REQ</a>(D_NET, req, <span class="stringliteral">&quot;high priority req&quot;</span>);
<a name="l00871"></a>00871         spin_unlock(&amp;req-&gt;<a class="code" href="structptlrpc__request.html#afb9723e194dc3b27d3721e45e5428d62" title="Lock to protect request flags and some other important bits, like rq_list.">rq_lock</a>);
<a name="l00872"></a>00872         EXIT;
<a name="l00873"></a>00873 }
<a name="l00874"></a>00874 
<a name="l00885"></a>00885 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> nrs_policy_compatible(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a> *svc,
<a name="l00886"></a>00886                                          <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *desc)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888         <span class="keywordflow">return</span> desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a7c57c75713e6367abb8433ab580d1db4" title="Service compatibility predicate.">pd_compat</a>(svc, desc);
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00904"></a>00904 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_register_policies_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs)
<a name="l00905"></a>00905 {
<a name="l00906"></a>00906         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *desc;
<a name="l00907"></a>00907         <span class="comment">/* for convenience */</span>
<a name="l00908"></a>00908         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>       *svcpt = nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abf2a529023ae89332f4b185930f1a537" title="Service partition for this NRS head.">nrs_svcpt</a>;
<a name="l00909"></a>00909         <span class="keyword">struct </span><a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a>            *svc = svcpt-&gt;scp_service;
<a name="l00910"></a>00910         <span class="keywordtype">int</span>                               rc = -EINVAL;
<a name="l00911"></a>00911         ENTRY;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913         LASSERT(mutex_is_locked(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex));
<a name="l00914"></a>00914 
<a name="l00915"></a>00915         list_for_each_entry(desc, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies, pd_list) {
<a name="l00916"></a>00916                 <span class="keywordflow">if</span> (nrs_policy_compatible(svc, desc)) {
<a name="l00917"></a>00917                         rc = nrs_policy_register(nrs, desc);
<a name="l00918"></a>00918                         <span class="keywordflow">if</span> (rc != 0) {
<a name="l00919"></a>00919                                 CERROR(<span class="stringliteral">&quot;Failed to register NRS policy %s for &quot;</span>
<a name="l00920"></a>00920                                        <span class="stringliteral">&quot;partition %d of service %s: %d\n&quot;</span>,
<a name="l00921"></a>00921                                        desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, svcpt-&gt;scp_cpt,
<a name="l00922"></a>00922                                        svc-&gt;<a class="code" href="structptlrpc__service.html#aae4c3cd5c6362b9586c16f671076bb55" title="only statically allocated strings here; we don&amp;#39;t clean them">srv_name</a>, rc);
<a name="l00927"></a>00927                                 <span class="keywordflow">break</span>;
<a name="l00928"></a>00928                         }
<a name="l00929"></a>00929                 }
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932         RETURN(rc);
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00947"></a>00947 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_svcpt_setup_locked0(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs,
<a name="l00948"></a>00948                                    <span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt)
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950         <span class="keywordtype">int</span>                             rc;
<a name="l00951"></a>00951         <span class="keyword">enum</span> <a class="code" href="group__nrs.html#ga79e63c48a144326744316f397c52a883" title="NRS queue type.">ptlrpc_nrs_queue_type</a>      queue;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953         LASSERT(mutex_is_locked(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex));
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (nrs == &amp;svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#aaf079ff0824776d6cbf221ce0a736d4e" title="NRS head for regular requests.">scp_nrs_reg</a>)
<a name="l00956"></a>00956                 queue = PTLRPC_NRS_QUEUE_REG;
<a name="l00957"></a>00957         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nrs == svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#a2daee35dee137743332c42d1ba3eaea1" title="NRS head for HP requests; this is only valid for services that can handle HP requests...">scp_nrs_hp</a>)
<a name="l00958"></a>00958                 queue = PTLRPC_NRS_QUEUE_HP;
<a name="l00959"></a>00959         <span class="keywordflow">else</span>
<a name="l00960"></a>00960                 LBUG();
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abf2a529023ae89332f4b185930f1a537" title="Service partition for this NRS head.">nrs_svcpt</a> = svcpt;
<a name="l00963"></a>00963         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#a5bb6a1b3602c1dd56d01a820e0e14228" title="This NRS head handles either HP or regular requests.">nrs_queue_type</a> = queue;
<a name="l00964"></a>00964         spin_lock_init(&amp;nrs-&gt;nrs_lock);
<a name="l00965"></a>00965         INIT_LIST_HEAD(&amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ae7e450db9f1413b9da0e4bbdd33cfb22" title="XXX Possibly replace svcpt-&amp;gt;scp_req_lock with another lock here.">nrs_policy_list</a>);
<a name="l00966"></a>00966         INIT_LIST_HEAD(&amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abba957e518558f35d3e0dd9f2f7f7eb3" title="List of policies with queued requests.">nrs_policy_queued</a>);
<a name="l00967"></a>00967         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#afb5e26c392efc34938dd705797a35f50" title="NRS policy is throttling reqeust.">nrs_throttling</a> = 0;
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         rc = nrs_register_policies_locked(nrs);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         RETURN(rc);
<a name="l00972"></a>00972 }
<a name="l00973"></a>00973 
<a name="l00983"></a>00983 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_svcpt_setup_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt)
<a name="l00984"></a>00984 {
<a name="l00985"></a>00985         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>              *nrs;
<a name="l00986"></a>00986         <span class="keywordtype">int</span>                             rc;
<a name="l00987"></a>00987         ENTRY;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989         LASSERT(mutex_is_locked(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex));
<a name="l00990"></a>00990 
<a name="l00994"></a>00994         nrs = nrs_svcpt2nrs(svcpt, <span class="keyword">false</span>);
<a name="l00995"></a>00995         rc = nrs_svcpt_setup_locked0(nrs, svcpt);
<a name="l00996"></a>00996         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00997"></a>00997                 GOTO(out, rc);
<a name="l00998"></a>00998 
<a name="l01002"></a>01002         <span class="keywordflow">if</span> (svcpt-&gt;scp_service-&gt;srv_ops.so_hpreq_handler == NULL)
<a name="l01003"></a>01003                 GOTO(out, rc);
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         OBD_CPT_ALLOC_PTR(svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#a2daee35dee137743332c42d1ba3eaea1" title="NRS head for HP requests; this is only valid for services that can handle HP requests...">scp_nrs_hp</a>,
<a name="l01006"></a>01006                           svcpt-&gt;scp_service-&gt;srv_cptable,
<a name="l01007"></a>01007                           svcpt-&gt;scp_cpt);
<a name="l01008"></a>01008         <span class="keywordflow">if</span> (svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#a2daee35dee137743332c42d1ba3eaea1" title="NRS head for HP requests; this is only valid for services that can handle HP requests...">scp_nrs_hp</a> == NULL)
<a name="l01009"></a>01009                 GOTO(out, rc = -ENOMEM);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011         nrs = nrs_svcpt2nrs(svcpt, <span class="keyword">true</span>);
<a name="l01012"></a>01012         rc = nrs_svcpt_setup_locked0(nrs, svcpt);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014 out:
<a name="l01015"></a>01015         RETURN(rc);
<a name="l01016"></a>01016 }
<a name="l01017"></a>01017 
<a name="l01026"></a>01026 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_svcpt_cleanup_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt)
<a name="l01027"></a>01027 {
<a name="l01028"></a>01028         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>              *nrs;
<a name="l01029"></a>01029         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *policy;
<a name="l01030"></a>01030         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>       *tmp;
<a name="l01031"></a>01031         <span class="keywordtype">int</span>                             rc;
<a name="l01032"></a>01032         <span class="keywordtype">bool</span>                            hp = <span class="keyword">false</span>;
<a name="l01033"></a>01033         ENTRY;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035         LASSERT(mutex_is_locked(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex));
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 again:
<a name="l01038"></a>01038         <span class="comment">/* scp_nrs_hp could be NULL due to short of memory. */</span>
<a name="l01039"></a>01039         nrs = hp ? svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#a2daee35dee137743332c42d1ba3eaea1" title="NRS head for HP requests; this is only valid for services that can handle HP requests...">scp_nrs_hp</a> : &amp;svcpt-&gt;<a class="code" href="structptlrpc__service__part.html#aaf079ff0824776d6cbf221ce0a736d4e" title="NRS head for regular requests.">scp_nrs_reg</a>;
<a name="l01040"></a>01040         <span class="comment">/* check the nrs_svcpt to see if nrs is initialized. */</span>
<a name="l01041"></a>01041         <span class="keywordflow">if</span> (!nrs || !nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abf2a529023ae89332f4b185930f1a537" title="Service partition for this NRS head.">nrs_svcpt</a>) {
<a name="l01042"></a>01042                 EXIT;
<a name="l01043"></a>01043                 <span class="keywordflow">return</span>;
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045         nrs-&gt;<a class="code" href="structptlrpc__nrs.html#a9340ae118782160c94e4cbb9ef8f6a2a" title="In progress of shutting down the whole NRS head; used during unregistration.">nrs_stopping</a> = 1;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         list_for_each_entry_safe(policy, tmp, &amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#ae7e450db9f1413b9da0e4bbdd33cfb22" title="XXX Possibly replace svcpt-&amp;gt;scp_req_lock with another lock here.">nrs_policy_list</a>,
<a name="l01048"></a>01048                                      <a class="code" href="structptlrpc__nrs__policy.html#aa644d14229b1b7bfce579970fe0d362a" title="Linkage into the NRS head&amp;#39;s list of policies, ptlrpc_nrs:nrs_policy_list.">pol_list</a>) {
<a name="l01049"></a>01049                 rc = nrs_policy_unregister(nrs, policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>);
<a name="l01050"></a>01050                 LASSERT(rc == 0);
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052 
<a name="l01056"></a>01056         <span class="keywordflow">if</span> (!hp &amp;&amp; nrs_svcpt_has_hp(svcpt)) {
<a name="l01057"></a>01057                 hp = <span class="keyword">true</span>;
<a name="l01058"></a>01058                 <span class="keywordflow">goto</span> again;
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (hp)
<a name="l01062"></a>01062                 OBD_FREE_PTR(nrs);
<a name="l01063"></a>01063 
<a name="l01064"></a>01064         EXIT;
<a name="l01065"></a>01065 }
<a name="l01066"></a>01066 
<a name="l01075"></a>01075 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *nrs_policy_find_desc_locked(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l01076"></a>01076 {
<a name="l01077"></a>01077         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a>     *tmp;
<a name="l01078"></a>01078         ENTRY;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080         list_for_each_entry(tmp, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies, <a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>) {
<a name="l01081"></a>01081                 <span class="keywordflow">if</span> (strncmp(tmp-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, name, NRS_POL_NAME_MAX) == 0)
<a name="l01082"></a>01082                         RETURN(tmp);
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084         RETURN(NULL);
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01099"></a>01099 <span class="keyword">static</span> <span class="keywordtype">int</span> nrs_policy_unregister_locked(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *desc)
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>              *nrs;
<a name="l01102"></a>01102         <span class="keyword">struct </span><a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a>          *svc;
<a name="l01103"></a>01103         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>     *svcpt;
<a name="l01104"></a>01104         <span class="keywordtype">int</span>                             i;
<a name="l01105"></a>01105         <span class="keywordtype">int</span>                             rc = 0;
<a name="l01106"></a>01106         ENTRY;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         LASSERT(mutex_is_locked(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex));
<a name="l01109"></a>01109         LASSERT(mutex_is_locked(&amp;ptlrpc_all_services_mutex));
<a name="l01110"></a>01110 
<a name="l01111"></a>01111         list_for_each_entry(svc, &amp;ptlrpc_all_services, srv_list) {
<a name="l01112"></a>01112 
<a name="l01113"></a>01113                 <span class="keywordflow">if</span> (!nrs_policy_compatible(svc, desc) ||
<a name="l01114"></a>01114                     unlikely(svc-&gt;<a class="code" href="structptlrpc__service.html#a356fa84033571129333ab81646a283df" title="under unregister_service">srv_is_stopping</a>))
<a name="l01115"></a>01115                         <span class="keywordflow">continue</span>;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117                 ptlrpc_service_for_each_part(svcpt, i, svc) {
<a name="l01118"></a>01118                         <span class="keywordtype">bool</span> hp = <span class="keyword">false</span>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 again:
<a name="l01121"></a>01121                         nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01122"></a>01122                         rc = nrs_policy_unregister(nrs, desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>);
<a name="l01127"></a>01127                         <span class="keywordflow">if</span> (rc == -ENOENT) {
<a name="l01128"></a>01128                                 rc = 0;
<a name="l01129"></a>01129                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc != 0) {
<a name="l01130"></a>01130                                 CERROR(<span class="stringliteral">&quot;Failed to unregister NRS policy %s for &quot;</span>
<a name="l01131"></a>01131                                        <span class="stringliteral">&quot;partition %d of service %s: %d\n&quot;</span>,
<a name="l01132"></a>01132                                        desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, svcpt-&gt;scp_cpt,
<a name="l01133"></a>01133                                        svcpt-&gt;scp_service-&gt;srv_name, rc);
<a name="l01134"></a>01134                                 RETURN(rc);
<a name="l01135"></a>01135                         }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137                         <span class="keywordflow">if</span> (!hp &amp;&amp; nrs_svc_has_hp(svc)) {
<a name="l01138"></a>01138                                 hp = <span class="keyword">true</span>;
<a name="l01139"></a>01139                                 <span class="keywordflow">goto</span> again;
<a name="l01140"></a>01140                         }
<a name="l01141"></a>01141                 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143                 <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a4278270d8cf6849261467dd6a69bd19a" title="Unegisters the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_fini</a> != NULL)
<a name="l01144"></a>01144                         desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a4278270d8cf6849261467dd6a69bd19a" title="Unegisters the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_fini</a>(svc);
<a name="l01145"></a>01145         }
<a name="l01146"></a>01146 
<a name="l01147"></a>01147         RETURN(rc);
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01165"></a><a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851">01165</a> <span class="keywordtype">int</span> <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__pol__conf.html">ptlrpc_nrs_pol_conf</a> *conf)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167         <span class="keyword">struct </span><a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a>          *svc;
<a name="l01168"></a>01168         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a>     *desc;
<a name="l01169"></a>01169         <span class="keywordtype">int</span>                             rc = 0;
<a name="l01170"></a>01170         ENTRY;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172         LASSERT(conf != NULL);
<a name="l01173"></a>01173         LASSERT(conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a136951aaf0b0881f052bba941bd8150b" title="NRS operations for this policy.">nc_ops</a> != NULL);
<a name="l01174"></a>01174         LASSERT(conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a4fa85169be78022f3f010e5b0ddfeec9" title="Service compatibility predicate.">nc_compat</a> != NULL);
<a name="l01175"></a>01175         LASSERT(ergo(conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a4fa85169be78022f3f010e5b0ddfeec9" title="Service compatibility predicate.">nc_compat</a> == nrs_policy_compat_one,
<a name="l01176"></a>01176                 conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a3e2c40464d2a870a742fc9c534f4aea4" title="Set for policies that support a single ptlrpc service, i.e.">nc_compat_svc_name</a> != NULL));
<a name="l01177"></a>01177         LASSERT(ergo((conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a35947833fd282bc0e5a01eb24fc3791a" title="This is a policy registering from a module different to the one NRS core ships in...">PTLRPC_NRS_FL_REG_EXTERN</a>) != 0,
<a name="l01178"></a>01178                      conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#ac29223e1e21fbf8c1eeb857b3bb39a87" title="Owner module for this policy descriptor; policies registering from a different module...">nc_owner</a> != NULL));
<a name="l01179"></a>01179 
<a name="l01180"></a>01180         conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>[NRS_POL_NAME_MAX - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01181"></a>01181 
<a name="l01191"></a>01191         <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a35947833fd282bc0e5a01eb24fc3791a" title="This is a policy registering from a module different to the one NRS core ships in...">PTLRPC_NRS_FL_REG_EXTERN</a>) &amp;&amp;
<a name="l01192"></a>01192             (conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; (<a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8ad327b4b9e26d26b5620cfdb682ca0b4c" title="Fallback policy, use this flag only on a single supported policy per service.">PTLRPC_NRS_FL_FALLBACK</a> |
<a name="l01193"></a>01193                                <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a274b96449b8debe8a3aadf811d78b8aa" title="Start policy immediately after registering.">PTLRPC_NRS_FL_REG_START</a>))) {
<a name="l01194"></a>01194                 CERROR(<span class="stringliteral">&quot;NRS: failing to register policy %s. Please check &quot;</span>
<a name="l01195"></a>01195                        <span class="stringliteral">&quot;policy flags; external policies cannot act as fallback &quot;</span>
<a name="l01196"></a>01196                        <span class="stringliteral">&quot;policies, or be started immediately upon registration &quot;</span>
<a name="l01197"></a>01197                        <span class="stringliteral">&quot;without interaction with lprocfs\n&quot;</span>, conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01198"></a>01198                 RETURN(-EINVAL);
<a name="l01199"></a>01199         }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201         mutex_lock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         <span class="keywordflow">if</span> (nrs_policy_find_desc_locked(conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>) != NULL) {
<a name="l01204"></a>01204                 CERROR(<span class="stringliteral">&quot;NRS: failing to register policy %s which has already &quot;</span>
<a name="l01205"></a>01205                        <span class="stringliteral">&quot;been registered with NRS core!\n&quot;</span>,
<a name="l01206"></a>01206                        conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01207"></a>01207                 GOTO(fail, rc = -EEXIST);
<a name="l01208"></a>01208         }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210         OBD_ALLOC_PTR(desc);
<a name="l01211"></a>01211         <span class="keywordflow">if</span> (desc == NULL)
<a name="l01212"></a>01212                 GOTO(fail, rc = -ENOMEM);
<a name="l01213"></a>01213 
<a name="l01214"></a>01214         <span class="keywordflow">if</span> (strlcpy(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>, <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>)) &gt;=
<a name="l01215"></a>01215             <span class="keyword">sizeof</span>(desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>)) {
<a name="l01216"></a>01216                 OBD_FREE_PTR(desc);
<a name="l01217"></a>01217                 GOTO(fail, rc = -E2BIG);
<a name="l01218"></a>01218         }
<a name="l01219"></a>01219         desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>             = conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a136951aaf0b0881f052bba941bd8150b" title="NRS operations for this policy.">nc_ops</a>;
<a name="l01220"></a>01220         desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a7c57c75713e6367abb8433ab580d1db4" title="Service compatibility predicate.">pd_compat</a>          = conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a4fa85169be78022f3f010e5b0ddfeec9" title="Service compatibility predicate.">nc_compat</a>;
<a name="l01221"></a>01221         desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aa6f674582366294297bfed84b1b14581" title="Set for policies that are compatible with only one PTLRPC service.">pd_compat_svc_name</a> = conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a3e2c40464d2a870a742fc9c534f4aea4" title="Set for policies that support a single ptlrpc service, i.e.">nc_compat_svc_name</a>;
<a name="l01222"></a>01222         <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a35947833fd282bc0e5a01eb24fc3791a" title="This is a policy registering from a module different to the one NRS core ships in...">PTLRPC_NRS_FL_REG_EXTERN</a>) != 0)
<a name="l01223"></a>01223                 desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#ae12d56d85fa4f85a79e9ad185ecd2bd1" title="Owner module for this policy descriptor.">pd_owner</a>   = conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#ac29223e1e21fbf8c1eeb857b3bb39a87" title="Owner module for this policy descriptor; policies registering from a different module...">nc_owner</a>;
<a name="l01224"></a>01224         desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aef6e239311b38cd4cd3bb5265ef9e3a4" title="Bitmask of nrs_policy_flags.">pd_flags</a>           = conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a>;
<a name="l01225"></a>01225         atomic_set(&amp;desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a74a94ee35dc2e2bf50b4a85e8c0bf291" title="# of references on this descriptor">pd_refs</a>, 0);
<a name="l01226"></a>01226 
<a name="l01235"></a>01235         <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8a35947833fd282bc0e5a01eb24fc3791a" title="This is a policy registering from a module different to the one NRS core ships in...">PTLRPC_NRS_FL_REG_EXTERN</a>) == 0)
<a name="l01236"></a>01236                 <span class="keywordflow">goto</span> <span class="keyword">internal</span>;
<a name="l01237"></a>01237 
<a name="l01241"></a>01241         mutex_lock(&amp;ptlrpc_all_services_mutex);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243         list_for_each_entry(svc, &amp;ptlrpc_all_services, srv_list) {
<a name="l01244"></a>01244                 <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>     *svcpt;
<a name="l01245"></a>01245                 <span class="keywordtype">int</span>                             i;
<a name="l01246"></a>01246                 <span class="keywordtype">int</span>                             rc2;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248                 <span class="keywordflow">if</span> (!nrs_policy_compatible(svc, desc) ||
<a name="l01249"></a>01249                     unlikely(svc-&gt;<a class="code" href="structptlrpc__service.html#a356fa84033571129333ab81646a283df" title="under unregister_service">srv_is_stopping</a>))
<a name="l01250"></a>01250                         <span class="keywordflow">continue</span>;
<a name="l01251"></a>01251 
<a name="l01252"></a>01252                 ptlrpc_service_for_each_part(svcpt, i, svc) {
<a name="l01253"></a>01253                         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>      *nrs;
<a name="l01254"></a>01254                         <span class="keywordtype">bool</span>                    hp = <span class="keyword">false</span>;
<a name="l01255"></a>01255 again:
<a name="l01256"></a>01256                         nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01257"></a>01257                         rc = nrs_policy_register(nrs, desc);
<a name="l01258"></a>01258                         <span class="keywordflow">if</span> (rc != 0) {
<a name="l01259"></a>01259                                 CERROR(<span class="stringliteral">&quot;Failed to register NRS policy %s for &quot;</span>
<a name="l01260"></a>01260                                        <span class="stringliteral">&quot;partition %d of service %s: %d\n&quot;</span>,
<a name="l01261"></a>01261                                        desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a0a92ae21dc1071c65c7e7d2efa67a976" title="Human-readable policy name.">pd_name</a>, svcpt-&gt;scp_cpt,
<a name="l01262"></a>01262                                        svcpt-&gt;scp_service-&gt;srv_name, rc);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264                                 rc2 = nrs_policy_unregister_locked(desc);
<a name="l01268"></a>01268                                 LASSERT(rc2 == 0);
<a name="l01269"></a>01269                                 mutex_unlock(&amp;ptlrpc_all_services_mutex);
<a name="l01270"></a>01270                                 OBD_FREE_PTR(desc);
<a name="l01271"></a>01271                                 GOTO(fail, rc);
<a name="l01272"></a>01272                         }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274                         <span class="keywordflow">if</span> (!hp &amp;&amp; nrs_svc_has_hp(svc)) {
<a name="l01275"></a>01275                                 hp = <span class="keyword">true</span>;
<a name="l01276"></a>01276                                 <span class="keywordflow">goto</span> again;
<a name="l01277"></a>01277                         }
<a name="l01278"></a>01278                 }
<a name="l01279"></a>01279 
<a name="l01284"></a>01284                 <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad81393abaf1277b8fdebc3f67903c55a" title="Registers the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_init</a> != NULL) {
<a name="l01285"></a>01285                         rc = desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad81393abaf1277b8fdebc3f67903c55a" title="Registers the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_init</a>(svc);
<a name="l01286"></a>01286                         <span class="keywordflow">if</span> (rc != 0) {
<a name="l01287"></a>01287                                 rc2 = nrs_policy_unregister_locked(desc);
<a name="l01291"></a>01291                                 LASSERT(rc2 == 0);
<a name="l01292"></a>01292                                 mutex_unlock(&amp;ptlrpc_all_services_mutex);
<a name="l01293"></a>01293                                 OBD_FREE_PTR(desc);
<a name="l01294"></a>01294                                 GOTO(fail, rc);
<a name="l01295"></a>01295                         }
<a name="l01296"></a>01296                 }
<a name="l01297"></a>01297         }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299         mutex_unlock(&amp;ptlrpc_all_services_mutex);
<a name="l01300"></a>01300 <span class="keyword">internal</span>:
<a name="l01301"></a>01301         list_add_tail(&amp;desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies);
<a name="l01302"></a>01302 fail:
<a name="l01303"></a>01303         mutex_unlock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01304"></a>01304 
<a name="l01305"></a>01305         RETURN(rc);
<a name="l01306"></a>01306 }
<a name="l01307"></a>01307 EXPORT_SYMBOL(<a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>);
<a name="l01308"></a>01308 
<a name="l01323"></a><a class="code" href="group__nrs.html#gafa9c71a2f34f3e56750abaeba0d358f8">01323</a> <span class="keywordtype">int</span> <a class="code" href="group__nrs.html#gafa9c71a2f34f3e56750abaeba0d358f8" title="Unregisters a previously registered policy with NRS core.">ptlrpc_nrs_policy_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__pol__conf.html">ptlrpc_nrs_pol_conf</a> *conf)
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a>      *desc;
<a name="l01326"></a>01326         <span class="keywordtype">int</span>                              rc;
<a name="l01327"></a>01327         ENTRY;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         LASSERT(conf != NULL);
<a name="l01330"></a>01330 
<a name="l01331"></a>01331         <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#a69b1cdbbca3e5ed5089636bf424ca94c" title="Policy registration flags; a bitmast of nrs_policy_flags.">nc_flags</a> &amp; <a class="code" href="group__nrs.html#gga6ea16220314a76d72e40776a753ad5e8ad327b4b9e26d26b5620cfdb682ca0b4c" title="Fallback policy, use this flag only on a single supported policy per service.">PTLRPC_NRS_FL_FALLBACK</a>) {
<a name="l01332"></a>01332                 CERROR(<span class="stringliteral">&quot;Unable to unregister a fallback policy, unless the &quot;</span>
<a name="l01333"></a>01333                        <span class="stringliteral">&quot;PTLRPC service is stopping.\n&quot;</span>);
<a name="l01334"></a>01334                 RETURN(-EPERM);
<a name="l01335"></a>01335         }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337         conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>[NRS_POL_NAME_MAX - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339         mutex_lock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341         desc = nrs_policy_find_desc_locked(conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (desc == NULL) {
<a name="l01343"></a>01343                 CERROR(<span class="stringliteral">&quot;Failing to unregister NRS policy %s which has &quot;</span>
<a name="l01344"></a>01344                        <span class="stringliteral">&quot;not been registered with NRS core!\n&quot;</span>,
<a name="l01345"></a>01345                        conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01346"></a>01346                 GOTO(not_exist, rc = -ENOENT);
<a name="l01347"></a>01347         }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349         mutex_lock(&amp;ptlrpc_all_services_mutex);
<a name="l01350"></a>01350 
<a name="l01351"></a>01351         rc = nrs_policy_unregister_locked(desc);
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01353"></a>01353                 <span class="keywordflow">if</span> (rc == -EBUSY)
<a name="l01354"></a>01354                         CERROR(<span class="stringliteral">&quot;Please first stop policy %s on all service &quot;</span>
<a name="l01355"></a>01355                                <span class="stringliteral">&quot;partitions and then retry to unregister the &quot;</span>
<a name="l01356"></a>01356                                <span class="stringliteral">&quot;policy.\n&quot;</span>, conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01357"></a>01357                 GOTO(fail, rc);
<a name="l01358"></a>01358         }
<a name="l01359"></a>01359 
<a name="l01360"></a>01360         CDEBUG(D_INFO, <span class="stringliteral">&quot;Unregistering policy %s from NRS core.\n&quot;</span>,
<a name="l01361"></a>01361                conf-&gt;<a class="code" href="structptlrpc__nrs__pol__conf.html#adfa0b0c120aa315b1becf8ad47bfa497" title="Human-readable policy name.">nc_name</a>);
<a name="l01362"></a>01362 
<a name="l01363"></a>01363         list_del(&amp;desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>);
<a name="l01364"></a>01364         OBD_FREE_PTR(desc);
<a name="l01365"></a>01365 
<a name="l01366"></a>01366 fail:
<a name="l01367"></a>01367         mutex_unlock(&amp;ptlrpc_all_services_mutex);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 not_exist:
<a name="l01370"></a>01370         mutex_unlock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372         RETURN(rc);
<a name="l01373"></a>01373 }
<a name="l01374"></a>01374 EXPORT_SYMBOL(<a class="code" href="group__nrs.html#gafa9c71a2f34f3e56750abaeba0d358f8" title="Unregisters a previously registered policy with NRS core.">ptlrpc_nrs_policy_unregister</a>);
<a name="l01375"></a>01375 
<a name="l01390"></a>01390 <span class="keywordtype">int</span> ptlrpc_service_nrs_setup(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a> *svc)
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>             *svcpt;
<a name="l01393"></a>01393         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a>       *desc;
<a name="l01394"></a>01394         <span class="keywordtype">int</span>                                     i;
<a name="l01395"></a>01395         <span class="keywordtype">int</span>                                     rc = 0;
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         mutex_lock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01398"></a>01398 
<a name="l01402"></a>01402         ptlrpc_service_for_each_part(svcpt, i, svc) {
<a name="l01403"></a>01403                 rc = nrs_svcpt_setup_locked(svcpt);
<a name="l01404"></a>01404                 <span class="keywordflow">if</span> (rc != 0)
<a name="l01405"></a>01405                         GOTO(failed, rc);
<a name="l01406"></a>01406         }
<a name="l01407"></a>01407 
<a name="l01412"></a>01412         list_for_each_entry(desc, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies, <a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>) {
<a name="l01413"></a>01413                 <span class="keywordflow">if</span> (!nrs_policy_compatible(svc, desc))
<a name="l01414"></a>01414                         <span class="keywordflow">continue</span>;
<a name="l01415"></a>01415 
<a name="l01416"></a>01416                 <span class="keywordflow">if</span> (desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad81393abaf1277b8fdebc3f67903c55a" title="Registers the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_init</a> != NULL) {
<a name="l01417"></a>01417                         rc = desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#ad81393abaf1277b8fdebc3f67903c55a" title="Registers the policy&amp;#39;s lprocfs interface with a PTLRPC service.">op_lprocfs_init</a>(svc);
<a name="l01418"></a>01418                         <span class="keywordflow">if</span> (rc != 0)
<a name="l01419"></a>01419                                 GOTO(failed, rc);
<a name="l01420"></a>01420                 }
<a name="l01421"></a>01421         }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 failed:
<a name="l01424"></a>01424 
<a name="l01425"></a>01425         mutex_unlock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427         RETURN(rc);
<a name="l01428"></a>01428 }
<a name="l01429"></a>01429 
<a name="l01435"></a>01435 <span class="keywordtype">void</span> ptlrpc_service_nrs_cleanup(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a> *svc)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>           *svcpt;
<a name="l01438"></a>01438         <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a>     *desc;
<a name="l01439"></a>01439         <span class="keywordtype">int</span>                                   i;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441         mutex_lock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01442"></a>01442 
<a name="l01446"></a>01446         ptlrpc_service_for_each_part(svcpt, i, svc)
<a name="l01447"></a>01447                 nrs_svcpt_cleanup_locked(svcpt);
<a name="l01448"></a>01448 
<a name="l01453"></a>01453         list_for_each_entry(desc, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies, <a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>) {
<a name="l01454"></a>01454                 <span class="keywordflow">if</span> (!nrs_policy_compatible(svc, desc))
<a name="l01455"></a>01455                         <span class="keywordflow">continue</span>;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457                 <span class="keywordflow">if</span> (desc-&gt;pd_ops-&gt;op_lprocfs_fini != NULL)
<a name="l01458"></a>01458                         desc-&gt;pd_ops-&gt;op_lprocfs_fini(svc);
<a name="l01459"></a>01459         }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461         mutex_unlock(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01475"></a>01475 <span class="keywordtype">void</span> ptlrpc_nrs_req_initialize(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt,
<a name="l01476"></a>01476                                <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req, <span class="keywordtype">bool</span> hp)
<a name="l01477"></a>01477 {
<a name="l01478"></a>01478         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>       *nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01479"></a>01479 
<a name="l01480"></a>01480         memset(&amp;req-&gt;rq_nrq, 0, <span class="keyword">sizeof</span>(req-&gt;rq_nrq));
<a name="l01481"></a>01481         nrs_resource_get_safe(nrs, &amp;req-&gt;rq_nrq, req-&gt;rq_nrq.nr_res_ptrs,
<a name="l01482"></a>01482                               <span class="keyword">false</span>);
<a name="l01483"></a>01483 
<a name="l01488"></a>01488         req-&gt;rq_nrq.nr_initialized = 1;
<a name="l01489"></a>01489 }
<a name="l01490"></a>01490 
<a name="l01499"></a>01499 <span class="keywordtype">void</span> ptlrpc_nrs_req_finalize(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l01500"></a>01500 {
<a name="l01501"></a>01501         <span class="keywordflow">if</span> (req-&gt;rq_nrq.nr_initialized) {
<a name="l01502"></a>01502                 nrs_resource_put_safe(req-&gt;rq_nrq.nr_res_ptrs);
<a name="l01503"></a>01503                 <span class="comment">/* no protection on bit nr_initialized because no</span>
<a name="l01504"></a>01504 <span class="comment">                 * contention at this late stage */</span>
<a name="l01505"></a>01505                 req-&gt;rq_nrq.nr_finalized = 1;
<a name="l01506"></a>01506         }
<a name="l01507"></a>01507 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509 <span class="keywordtype">void</span> ptlrpc_nrs_req_stop_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l01510"></a>01510 {
<a name="l01511"></a>01511         <span class="keywordflow">if</span> (req-&gt;rq_nrq.nr_started)
<a name="l01512"></a>01512                 nrs_request_stop(&amp;req-&gt;rq_nrq);
<a name="l01513"></a>01513 }
<a name="l01514"></a>01514 
<a name="l01524"></a>01524 <span class="keywordtype">void</span> ptlrpc_nrs_req_add(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt,
<a name="l01525"></a>01525                         <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req, <span class="keywordtype">bool</span> hp)
<a name="l01526"></a>01526 {
<a name="l01527"></a>01527         spin_lock(&amp;svcpt-&gt;scp_req_lock);
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         <span class="keywordflow">if</span> (hp)
<a name="l01530"></a>01530                 ptlrpc_nrs_hpreq_add_nolock(req);
<a name="l01531"></a>01531         <span class="keywordflow">else</span>
<a name="l01532"></a>01532                 ptlrpc_nrs_req_add_nolock(req);
<a name="l01533"></a>01533 
<a name="l01534"></a>01534         spin_unlock(&amp;svcpt-&gt;scp_req_lock);
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537 <span class="keyword">static</span> <span class="keywordtype">void</span> nrs_request_removed(<span class="keyword">struct</span> <a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy)
<a name="l01538"></a>01538 {
<a name="l01539"></a>01539         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a> &gt; 0);
<a name="l01540"></a>01540         LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> &gt; 0);
<a name="l01541"></a>01541 
<a name="l01542"></a>01542         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a>--;
<a name="l01543"></a>01543         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a>--;
<a name="l01544"></a>01544 
<a name="l01549"></a>01549         <span class="keywordflow">if</span> (unlikely(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> == 0)) {
<a name="l01550"></a>01550                 list_del_init(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>);
<a name="l01551"></a>01551 
<a name="l01557"></a>01557         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> != policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a>) {
<a name="l01558"></a>01558                 LASSERT(policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ae7f1743aeb85ce0cf7b83258bd8b2d5b" title="# RPCs enqueued for later dispatching by the policy">pol_req_queued</a> &lt;
<a name="l01559"></a>01559                         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a>);
<a name="l01560"></a>01560 
<a name="l01561"></a>01561                 list_move_tail(&amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#ac7e16ffc3ed0d0d1d4c6e34eea91a579" title="Linkage into the NRS head&amp;#39;s list of policies with enqueued requests ptlrpc_nrs:nrs_policy_queued...">pol_list_queued</a>,
<a name="l01562"></a>01562                                    &amp;policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#abba957e518558f35d3e0dd9f2f7f7eb3" title="List of policies with queued requests.">nrs_policy_queued</a>);
<a name="l01563"></a>01563         }
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01582"></a>01582 <span class="keyword">struct </span><a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *
<a name="l01583"></a>01583 ptlrpc_nrs_req_get_nolock0(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt, <span class="keywordtype">bool</span> hp,
<a name="l01584"></a>01584                            <span class="keywordtype">bool</span> peek, <span class="keywordtype">bool</span> force)
<a name="l01585"></a>01585 {
<a name="l01586"></a>01586         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a>         *nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01587"></a>01587         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a>  *policy;
<a name="l01588"></a>01588         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a> *nrq;
<a name="l01589"></a>01589 
<a name="l01594"></a>01594         list_for_each_entry(policy, &amp;nrs-&gt;<a class="code" href="structptlrpc__nrs.html#abba957e518558f35d3e0dd9f2f7f7eb3" title="List of policies with queued requests.">nrs_policy_queued</a>,
<a name="l01595"></a>01595                                 pol_list_queued) {
<a name="l01596"></a>01596                 nrq = nrs_request_get(policy, peek, force);
<a name="l01597"></a>01597                 <span class="keywordflow">if</span> (nrq != NULL) {
<a name="l01598"></a>01598                         <span class="keywordflow">if</span> (likely(!peek)) {
<a name="l01599"></a>01599                                 nrq-&gt;nr_started = 1;
<a name="l01600"></a>01600 
<a name="l01601"></a>01601                                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#af5766f2083b67b59ab394473c0d4702e" title="# RPCs started for dispatch by the policy">pol_req_started</a>++;
<a name="l01602"></a>01602                                 policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a7975af6770c4e7082ed4d14a1b9b44d2" title="The NRS head this policy has been created at.">pol_nrs</a>-&gt;<a class="code" href="structptlrpc__nrs.html#ac28bda31fdafdd8b57f08e7233da607e" title="# scheduled requests from all policies in this NRS head">nrs_req_started</a>++;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604                                 nrs_request_removed(policy);
<a name="l01605"></a>01605                         }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607                         <span class="keywordflow">return</span> container_of(nrq, <span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a>, rq_nrq);
<a name="l01608"></a>01608                 }
<a name="l01609"></a>01609         }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611         <span class="keywordflow">return</span> NULL;
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01619"></a>01619 <span class="keywordtype">void</span> ptlrpc_nrs_req_del_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l01620"></a>01620 {
<a name="l01621"></a>01621         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__policy.html" title="NRS policy.">ptlrpc_nrs_policy</a> *policy = nrs_request_policy(&amp;req-&gt;rq_nrq);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623         policy-&gt;<a class="code" href="structptlrpc__nrs__policy.html#a966ade252ef1fc27ced667269a199a95" title="Policy descriptor for this policy instance.">pol_desc</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#aba233e96277bf84fded13e672d63322e" title="NRS operations for this policy.">pd_ops</a>-&gt;<a class="code" href="structptlrpc__nrs__pol__ops.html#a1eb83c9a1da21c4090e85c6711dbf6d6" title="Removes a request from the policy&amp;#39;s set of pending requests.">op_req_dequeue</a>(policy, &amp;req-&gt;rq_nrq);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625         req-&gt;rq_nrq.nr_enqueued = 0;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627         nrs_request_removed(policy);
<a name="l01628"></a>01628 }
<a name="l01629"></a>01629 
<a name="l01643"></a>01643 <span class="keywordtype">bool</span> ptlrpc_nrs_req_pending_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt, <span class="keywordtype">bool</span> hp)
<a name="l01644"></a>01644 {
<a name="l01645"></a>01645         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647         <span class="keywordflow">return</span> nrs-&gt;<a class="code" href="structptlrpc__nrs.html#aa05e58ff4d5a998e0b24edb92a8f3ceb" title="# queued requests from all policies in this NRS head">nrs_req_queued</a> &gt; 0;
<a name="l01648"></a>01648 };
<a name="l01649"></a>01649 
<a name="l01660"></a>01660 <span class="keywordtype">bool</span> ptlrpc_nrs_req_throttling_nolock(<span class="keyword">struct</span> <a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a> *svcpt,
<a name="l01661"></a>01661                                       <span class="keywordtype">bool</span> hp)
<a name="l01662"></a>01662 {
<a name="l01663"></a>01663         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs.html" title="NRS head.">ptlrpc_nrs</a> *nrs = nrs_svcpt2nrs(svcpt, hp);
<a name="l01664"></a>01664 
<a name="l01665"></a>01665         <span class="keywordflow">return</span> !!nrs-&gt;<a class="code" href="structptlrpc__nrs.html#afb5e26c392efc34938dd705797a35f50" title="NRS policy is throttling reqeust.">nrs_throttling</a>;
<a name="l01666"></a>01666 };
<a name="l01667"></a>01667 
<a name="l01673"></a><a class="code" href="group__nrs.html#gae517dc74ee0bcadf3b53f6ed4c57e6de">01673</a> <span class="keywordtype">void</span> <a class="code" href="group__nrs.html#gae517dc74ee0bcadf3b53f6ed4c57e6de" title="Moves request req from the regular to the high-priority NRS head.">ptlrpc_nrs_req_hp_move</a>(<span class="keyword">struct</span> <a class="code" href="structptlrpc__request.html" title="Represents remote procedure call.">ptlrpc_request</a> *req)
<a name="l01674"></a>01674 {
<a name="l01675"></a>01675         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>      *svcpt = req-&gt;rq_rqbd-&gt;rqbd_svcpt;
<a name="l01676"></a>01676         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__request.html" title="NRS request.">ptlrpc_nrs_request</a>       *nrq = &amp;req-&gt;rq_nrq;
<a name="l01677"></a>01677         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a>      *res1[NRS_RES_MAX];
<a name="l01678"></a>01678         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__resource.html" title="NRS resource.">ptlrpc_nrs_resource</a>      *res2[NRS_RES_MAX];
<a name="l01679"></a>01679         ENTRY;
<a name="l01680"></a>01680 
<a name="l01684"></a>01684         nrs_resource_get_safe(nrs_svcpt2nrs(svcpt, <span class="keyword">true</span>), nrq, res1, <span class="keyword">true</span>);
<a name="l01685"></a>01685 
<a name="l01686"></a>01686         spin_lock(&amp;svcpt-&gt;scp_req_lock);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688         <span class="keywordflow">if</span> (!ptlrpc_nrs_req_can_move(req))
<a name="l01689"></a>01689                 <span class="keywordflow">goto</span> out;
<a name="l01690"></a>01690 
<a name="l01691"></a>01691         ptlrpc_nrs_req_del_nolock(req);
<a name="l01692"></a>01692 
<a name="l01693"></a>01693         memcpy(res2, nrq-&gt;<a class="code" href="structptlrpc__nrs__request.html#aff495a9624df874a4d9bf643ad1b4d20" title="The request&amp;#39;s resource hierarchy.">nr_res_ptrs</a>, NRS_RES_MAX * <span class="keyword">sizeof</span>(res2[0]));
<a name="l01694"></a>01694         memcpy(nrq-&gt;<a class="code" href="structptlrpc__nrs__request.html#aff495a9624df874a4d9bf643ad1b4d20" title="The request&amp;#39;s resource hierarchy.">nr_res_ptrs</a>, res1, NRS_RES_MAX * <span class="keyword">sizeof</span>(res1[0]));
<a name="l01695"></a>01695 
<a name="l01696"></a>01696         ptlrpc_nrs_hpreq_add_nolock(req);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698         memcpy(res1, res2, NRS_RES_MAX * <span class="keyword">sizeof</span>(res1[0]));
<a name="l01699"></a>01699 out:
<a name="l01700"></a>01700         spin_unlock(&amp;svcpt-&gt;scp_req_lock);
<a name="l01701"></a>01701 
<a name="l01708"></a>01708         nrs_resource_put_safe(res1);
<a name="l01709"></a>01709         EXIT;
<a name="l01710"></a>01710 }
<a name="l01711"></a>01711 
<a name="l01738"></a>01738 <span class="keywordtype">int</span> ptlrpc_nrs_policy_control(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structptlrpc__service.html" title="Definition of PortalRPC service.">ptlrpc_service</a> *svc,
<a name="l01739"></a>01739                               <span class="keyword">enum</span> <a class="code" href="group__nrs.html#ga79e63c48a144326744316f397c52a883" title="NRS queue type.">ptlrpc_nrs_queue_type</a> queue, <span class="keywordtype">char</span> *name,
<a name="l01740"></a>01740                               <span class="keyword">enum</span> <a class="code" href="group__nrs.html#gaa3db631148675f8074864fa452691540" title="NRS control operations.">ptlrpc_nrs_ctl</a> opc, <span class="keywordtype">bool</span> single, <span class="keywordtype">void</span> *arg)
<a name="l01741"></a>01741 {
<a name="l01742"></a>01742         <span class="keyword">struct </span><a class="code" href="structptlrpc__service__part.html" title="Definition of PortalRPC service partition data.">ptlrpc_service_part</a>     *svcpt;
<a name="l01743"></a>01743         <span class="keywordtype">int</span>                             i;
<a name="l01744"></a>01744         <span class="keywordtype">int</span>                             rc = 0;
<a name="l01745"></a>01745         ENTRY;
<a name="l01746"></a>01746 
<a name="l01747"></a>01747         LASSERT(opc != <a class="code" href="group__nrs.html#ggaa3db631148675f8074864fa452691540a321baf9361db3da24cdfa83280bad032" title="Not a valid opcode.">PTLRPC_NRS_CTL_INVALID</a>);
<a name="l01748"></a>01748 
<a name="l01749"></a>01749         <span class="keywordflow">if</span> ((queue &amp; PTLRPC_NRS_QUEUE_BOTH) == 0)
<a name="l01750"></a>01750                 <span class="keywordflow">return</span> -EINVAL;
<a name="l01751"></a>01751 
<a name="l01752"></a>01752         ptlrpc_service_for_each_part(svcpt, i, svc) {
<a name="l01753"></a>01753                 <span class="keywordflow">if</span> ((queue &amp; PTLRPC_NRS_QUEUE_REG) != 0) {
<a name="l01754"></a>01754                         rc = nrs_policy_ctl(nrs_svcpt2nrs(svcpt, <span class="keyword">false</span>), name,
<a name="l01755"></a>01755                                             opc, arg);
<a name="l01756"></a>01756                         <span class="keywordflow">if</span> (rc != 0 || (queue == PTLRPC_NRS_QUEUE_REG &amp;&amp;
<a name="l01757"></a>01757                                         single))
<a name="l01758"></a>01758                                 GOTO(out, rc);
<a name="l01759"></a>01759                 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761                 <span class="keywordflow">if</span> ((queue &amp; PTLRPC_NRS_QUEUE_HP) != 0) {
<a name="l01770"></a>01770                         rc = nrs_policy_ctl(nrs_svcpt2nrs(svcpt, <span class="keyword">true</span>), name,
<a name="l01771"></a>01771                                             opc, arg);
<a name="l01772"></a>01772                         <span class="keywordflow">if</span> (rc != 0 || single)
<a name="l01773"></a>01773                                 GOTO(out, rc);
<a name="l01774"></a>01774                 }
<a name="l01775"></a>01775         }
<a name="l01776"></a>01776 out:
<a name="l01777"></a>01777         RETURN(rc);
<a name="l01778"></a>01778 }
<a name="l01779"></a>01779 
<a name="l01787"></a>01787 <span class="keywordtype">int</span> ptlrpc_nrs_init(<span class="keywordtype">void</span>)
<a name="l01788"></a>01788 {
<a name="l01789"></a>01789         <span class="keywordtype">int</span>     rc;
<a name="l01790"></a>01790         ENTRY;
<a name="l01791"></a>01791 
<a name="l01792"></a>01792         mutex_init(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_mutex);
<a name="l01793"></a>01793         INIT_LIST_HEAD(&amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies);
<a name="l01794"></a>01794 
<a name="l01795"></a>01795         rc = <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(&amp;nrs_conf_fifo);
<a name="l01796"></a>01796         <span class="keywordflow">if</span> (rc != 0)
<a name="l01797"></a>01797                 GOTO(fail, rc);
<a name="l01798"></a>01798 
<a name="l01799"></a>01799 <span class="preprocessor">#ifdef HAVE_SERVER_SUPPORT</span>
<a name="l01800"></a>01800 <span class="preprocessor"></span>        rc = <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(&amp;nrs_conf_crrn);
<a name="l01801"></a>01801         <span class="keywordflow">if</span> (rc != 0)
<a name="l01802"></a>01802                 GOTO(fail, rc);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804         rc = <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(&amp;nrs_conf_orr);
<a name="l01805"></a>01805         <span class="keywordflow">if</span> (rc != 0)
<a name="l01806"></a>01806                 GOTO(fail, rc);
<a name="l01807"></a>01807 
<a name="l01808"></a>01808         rc = <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(&amp;nrs_conf_trr);
<a name="l01809"></a>01809         <span class="keywordflow">if</span> (rc != 0)
<a name="l01810"></a>01810                 GOTO(fail, rc);
<a name="l01811"></a>01811         rc = <a class="code" href="group__nrs.html#ga5de7e78460dcd401c48a46cf67ac9851" title="Registers a new policy with NRS core.">ptlrpc_nrs_policy_register</a>(&amp;nrs_conf_tbf);
<a name="l01812"></a>01812         <span class="keywordflow">if</span> (rc != 0)
<a name="l01813"></a>01813                 GOTO(fail, rc);
<a name="l01814"></a>01814 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_SERVER_SUPPORT */</span>
<a name="l01815"></a>01815 
<a name="l01816"></a>01816         RETURN(rc);
<a name="l01817"></a>01817 fail:
<a name="l01822"></a>01822         ptlrpc_nrs_fini();
<a name="l01823"></a>01823 
<a name="l01824"></a>01824         RETURN(rc);
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01836"></a>01836 <span class="keywordtype">void</span> ptlrpc_nrs_fini(<span class="keywordtype">void</span>)
<a name="l01837"></a>01837 {
<a name="l01838"></a>01838         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *desc;
<a name="l01839"></a>01839         <span class="keyword">struct </span><a class="code" href="structptlrpc__nrs__pol__desc.html" title="NRS policy registering descriptor.">ptlrpc_nrs_pol_desc</a> *tmp;
<a name="l01840"></a>01840 
<a name="l01841"></a>01841         list_for_each_entry_safe(desc, tmp, &amp;<a class="code" href="structnrs__core.html" title="NRS core object.">nrs_core</a>.nrs_policies,
<a name="l01842"></a>01842                                      pd_list) {
<a name="l01843"></a>01843                 list_del_init(&amp;desc-&gt;<a class="code" href="structptlrpc__nrs__pol__desc.html#a94e6539f58dfde2244c2c957d624433d" title="Link into nrs_core::nrs_policies.">pd_list</a>);
<a name="l01844"></a>01844                 OBD_FREE_PTR(desc);
<a name="l01845"></a>01845         }
<a name="l01846"></a>01846 }
<a name="l01847"></a>01847 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Jun 5 20:55:21 2016 for Lustre by&nbsp;<a href="http://www.doxygen.org/index.html">doxygen</a> 1.6.1</small></address><br>
<small><a href="http://www.sun.com/contact">Contact</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/index.html">About Sun</a>&nbsp;|&nbsp;<a href="http://www.sun.com/aboutsun/media/index.html">News</a>&nbsp;|&nbsp;<a href="http://www.sun.com/corp_emp/">Employment</a>&nbsp;|&nbsp;<a href="http://www.sun.com/privacy/">Privacy</a>&nbsp;|&nbsp;<a href="http://www.sun.com/share/text/termsofuse.html">Terms of Use</a>&nbsp;|&nbsp;<a href="http://www.sun.com/suntrademarks/">Trademarks</a>&nbsp;|&nbsp;(C) 2008 Sun Microsystems, Inc.</small>
</body>
</html>
